<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•ä¸€è‡´æ€§é—®é¢˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .data-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” é”™é¢˜æœ¬ä¸é”™é¢˜è¯¦æƒ…ä¸€è‡´æ€§è°ƒè¯•</h1>
    
    <div class="result info">
        <h3>é—®é¢˜æè¿°</h3>
        <p>ç”¨æˆ·åé¦ˆï¼šerror-book.html çš„ç¬¬ä¸€æ¡æ•°æ®æ˜¯æ•°å­¦ï¼Œè€Œ error-detail.html?id=1 æ˜¾ç¤ºçš„å­¦ç§‘æ˜¯è¯­æ–‡</p>
        <p>éœ€è¦éªŒè¯å¹¶ä¿®å¤è¿™ä¸ªä¸ä¸€è‡´é—®é¢˜</p>
    </div>

    <button onclick="debugConsistency()">ğŸš€ å¼€å§‹è°ƒè¯•</button>
    <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function debugConsistency() {
            clearResults();
            addResult('ğŸ”„ å¼€å§‹è°ƒè¯•ä¸€è‡´æ€§é—®é¢˜...', 'info');

            try {
                // 1. è·å–é”™é¢˜æœ¬æ•°æ®
                addResult('ğŸ“– æ­¥éª¤1ï¼šè·å–é”™é¢˜æœ¬APIæ•°æ®...', 'info');
                const errorBookResponse = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!errorBookResponse.ok) {
                    throw new Error(`é”™é¢˜æœ¬APIå¤±è´¥: ${errorBookResponse.status}`);
                }

                const errorBookData = await errorBookResponse.json();
                const firstError = errorBookData.recent_errors[0];

                addResult(`
                    <h4>ğŸ“– é”™é¢˜æœ¬ç¬¬ä¸€æ¡æ•°æ®ï¼š</h4>
                    <pre>${JSON.stringify(firstError, null, 2)}</pre>
                `, 'success');

                // 2. è·å–é”™é¢˜è¯¦æƒ…APIæ•°æ®
                addResult('ğŸ“„ æ­¥éª¤2ï¼šè·å–é”™é¢˜è¯¦æƒ…APIæ•°æ®...', 'info');
                const errorDetailResponse = await fetch(`${API_BASE}/student/error-book/1`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!errorDetailResponse.ok) {
                    throw new Error(`é”™é¢˜è¯¦æƒ…APIå¤±è´¥: ${errorDetailResponse.status}`);
                }

                const errorDetailData = await errorDetailResponse.json();

                addResult(`
                    <h4>ğŸ“„ é”™é¢˜è¯¦æƒ…APIè¿”å›çš„ID=1æ•°æ®ï¼š</h4>
                    <pre>${JSON.stringify(errorDetailData, null, 2)}</pre>
                `, 'success');

                // 3. å¯¹æ¯”åˆ†æ
                addResult('ğŸ” æ­¥éª¤3ï¼šæ•°æ®å¯¹æ¯”åˆ†æ...', 'info');

                const comparison = `
                    <div class="comparison">
                        <div class="data-card">
                            <h4>ğŸ  é”™é¢˜æœ¬ç¬¬ä¸€æ¡</h4>
                            <p><strong>ID:</strong> ${firstError.id}</p>
                            <p><strong>å­¦ç§‘:</strong> <span style="color: blue; font-weight: bold;">${firstError.subject}</span></p>
                            <p><strong>é¢˜ç›®:</strong> ${firstError.question_text.substring(0, 60)}...</p>
                            <p><strong>éš¾åº¦:</strong> ${firstError.difficulty_level}</p>
                        </div>
                        <div class="data-card">
                            <h4>ğŸ“„ é”™é¢˜è¯¦æƒ…ID=1</h4>
                            <p><strong>ID:</strong> ${errorDetailData.id}</p>
                            <p><strong>å­¦ç§‘:</strong> <span style="color: red; font-weight: bold;">${errorDetailData.subject}</span></p>
                            <p><strong>é¢˜ç›®:</strong> ${errorDetailData.question_text.substring(0, 60)}...</p>
                            <p><strong>éš¾åº¦:</strong> ${errorDetailData.difficulty}</p>
                        </div>
                    </div>
                `;

                const isConsistent = firstError.id == errorDetailData.id && 
                                   firstError.subject === errorDetailData.subject && 
                                   firstError.question_text === errorDetailData.question_text;

                addResult(comparison, isConsistent ? 'success' : 'error');

                if (!isConsistent) {
                    addResult(`
                        <h4>âŒ ç¡®è®¤é—®é¢˜å­˜åœ¨ï¼š</h4>
                        <ul>
                            <li><strong>é”™é¢˜æœ¬ç¬¬ä¸€æ¡ï¼š</strong> ID=${firstError.id}, å­¦ç§‘="${firstError.subject}"</li>
                            <li><strong>é”™é¢˜è¯¦æƒ…ID=1ï¼š</strong> ID=${errorDetailData.id}, å­¦ç§‘="${errorDetailData.subject}"</li>
                            <li><strong>ç»“è®ºï¼š</strong> ä¸¤ä¸ªAPIè¿”å›çš„ID=1å¯¹åº”å®Œå…¨ä¸åŒçš„é”™é¢˜ï¼</li>
                        </ul>
                    `, 'error');
                } else {
                    addResult('âœ… æ•°æ®ä¸€è‡´ï¼Œæ— é—®é¢˜', 'success');
                }

                // 4. æ£€æŸ¥é”™é¢˜è¯¦æƒ…é¡µé¢å®é™…ä¼šä½¿ç”¨å“ªä¸ªæ•°æ®
                addResult('ğŸ”§ æ­¥éª¤4ï¼šæ£€æŸ¥é”™é¢˜è¯¦æƒ…é¡µé¢ä¼šä½¿ç”¨å“ªä¸ªæ•°æ®æº...', 'info');

                // æ¨¡æ‹Ÿé”™é¢˜è¯¦æƒ…é¡µé¢çš„é€»è¾‘
                const errorId = '1';
                
                // æ£€æŸ¥localStorage
                localStorage.removeItem('currentErrorDetail'); // ç¡®ä¿æµ‹è¯•ç¯å¢ƒå¹²å‡€
                const storedErrorDetail = localStorage.getItem('currentErrorDetail');
                
                addResult(`
                    <h4>ğŸ”§ é”™é¢˜è¯¦æƒ…é¡µé¢é€»è¾‘åˆ†æï¼š</h4>
                    <p><strong>å½“å‰errorId:</strong> "${errorId}"</p>
                    <p><strong>localStorageä¸­çš„æ•°æ®:</strong> ${storedErrorDetail ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}</p>
                    <p><strong>ä¼šä½¿ç”¨çš„æ•°æ®æº:</strong> ${storedErrorDetail ? 'localStorage' : 'é”™é¢˜æœ¬API'}</p>
                `, 'info');

                // 5. æ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘
                const foundInErrorBook = errorBookData.recent_errors.find(error => error.id == errorId);
                
                if (foundInErrorBook) {
                    addResult(`
                        <h4>âœ… ä¿®å¤åçš„ç»“æœï¼š</h4>
                        <div class="data-card">
                            <p><strong>é”™é¢˜è¯¦æƒ…é¡µé¢å°†æ˜¾ç¤ºï¼š</strong></p>
                            <p><strong>ID:</strong> ${foundInErrorBook.id}</p>
                            <p><strong>å­¦ç§‘:</strong> <span style="color: green; font-weight: bold;">${foundInErrorBook.subject}</span></p>
                            <p><strong>é¢˜ç›®:</strong> ${foundInErrorBook.question_text.substring(0, 60)}...</p>
                            <p><strong>ä¸é”™é¢˜æœ¬ä¸€è‡´ï¼š</strong> âœ… æ˜¯</p>
                        </div>
                    `, 'success');
                } else {
                    addResult(`
                        <h4>âš ï¸ è­¦å‘Šï¼šåœ¨é”™é¢˜æœ¬ä¸­æ‰¾ä¸åˆ°ID=${errorId}çš„é”™é¢˜</h4>
                        <p>è¿™å¯èƒ½æ˜¯åˆ†é¡µæˆ–æ•°æ®åŒæ­¥é—®é¢˜</p>
                    `, 'warning');
                }

                // 6. æä¾›è§£å†³æ–¹æ¡ˆ
                addResult(`
                    <h4>ğŸ› ï¸ è§£å†³æ–¹æ¡ˆï¼š</h4>
                    <p>é”™é¢˜è¯¦æƒ…é¡µé¢å·²ä¿®æ”¹ä¸ºè°ƒç”¨é”™é¢˜æœ¬APIï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§</p>
                    <p><strong>ç°åœ¨æµ‹è¯•ï¼š</strong></p>
                    <p>1. è®¿é—® <a href="http://localhost:8080/frontend/error-book.html" target="_blank">é”™é¢˜æœ¬é¡µé¢</a></p>
                    <p>2. è®¿é—® <a href="http://localhost:8080/frontend/error-detail.html?id=1" target="_blank">é”™é¢˜è¯¦æƒ…é¡µé¢</a></p>
                    <p>3. å¯¹æ¯”ä¸¤ä¸ªé¡µé¢çš„å­¦ç§‘æ˜¾ç¤ºæ˜¯å¦ä¸€è‡´</p>
                `, 'success');

            } catch (error) {
                addResult(`âŒ è°ƒè¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è°ƒè¯•å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®token
        localStorage.setItem('token', TOKEN);
    </script>
</body>
</html>