<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试一致性问题</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .data-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 错题本与错题详情一致性调试</h1>
    
    <div class="result info">
        <h3>问题描述</h3>
        <p>用户反馈：error-book.html 的第一条数据是数学，而 error-detail.html?id=1 显示的学科是语文</p>
        <p>需要验证并修复这个不一致问题</p>
    </div>

    <button onclick="debugConsistency()">🚀 开始调试</button>
    <button onclick="clearResults()">🧹 清除结果</button>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function debugConsistency() {
            clearResults();
            addResult('🔄 开始调试一致性问题...', 'info');

            try {
                // 1. 获取错题本数据
                addResult('📖 步骤1：获取错题本API数据...', 'info');
                const errorBookResponse = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!errorBookResponse.ok) {
                    throw new Error(`错题本API失败: ${errorBookResponse.status}`);
                }

                const errorBookData = await errorBookResponse.json();
                const firstError = errorBookData.recent_errors[0];

                addResult(`
                    <h4>📖 错题本第一条数据：</h4>
                    <pre>${JSON.stringify(firstError, null, 2)}</pre>
                `, 'success');

                // 2. 获取错题详情API数据
                addResult('📄 步骤2：获取错题详情API数据...', 'info');
                const errorDetailResponse = await fetch(`${API_BASE}/student/error-book/1`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!errorDetailResponse.ok) {
                    throw new Error(`错题详情API失败: ${errorDetailResponse.status}`);
                }

                const errorDetailData = await errorDetailResponse.json();

                addResult(`
                    <h4>📄 错题详情API返回的ID=1数据：</h4>
                    <pre>${JSON.stringify(errorDetailData, null, 2)}</pre>
                `, 'success');

                // 3. 对比分析
                addResult('🔍 步骤3：数据对比分析...', 'info');

                const comparison = `
                    <div class="comparison">
                        <div class="data-card">
                            <h4>🏠 错题本第一条</h4>
                            <p><strong>ID:</strong> ${firstError.id}</p>
                            <p><strong>学科:</strong> <span style="color: blue; font-weight: bold;">${firstError.subject}</span></p>
                            <p><strong>题目:</strong> ${firstError.question_text.substring(0, 60)}...</p>
                            <p><strong>难度:</strong> ${firstError.difficulty_level}</p>
                        </div>
                        <div class="data-card">
                            <h4>📄 错题详情ID=1</h4>
                            <p><strong>ID:</strong> ${errorDetailData.id}</p>
                            <p><strong>学科:</strong> <span style="color: red; font-weight: bold;">${errorDetailData.subject}</span></p>
                            <p><strong>题目:</strong> ${errorDetailData.question_text.substring(0, 60)}...</p>
                            <p><strong>难度:</strong> ${errorDetailData.difficulty}</p>
                        </div>
                    </div>
                `;

                const isConsistent = firstError.id == errorDetailData.id && 
                                   firstError.subject === errorDetailData.subject && 
                                   firstError.question_text === errorDetailData.question_text;

                addResult(comparison, isConsistent ? 'success' : 'error');

                if (!isConsistent) {
                    addResult(`
                        <h4>❌ 确认问题存在：</h4>
                        <ul>
                            <li><strong>错题本第一条：</strong> ID=${firstError.id}, 学科="${firstError.subject}"</li>
                            <li><strong>错题详情ID=1：</strong> ID=${errorDetailData.id}, 学科="${errorDetailData.subject}"</li>
                            <li><strong>结论：</strong> 两个API返回的ID=1对应完全不同的错题！</li>
                        </ul>
                    `, 'error');
                } else {
                    addResult('✅ 数据一致，无问题', 'success');
                }

                // 4. 检查错题详情页面实际会使用哪个数据
                addResult('🔧 步骤4：检查错题详情页面会使用哪个数据源...', 'info');

                // 模拟错题详情页面的逻辑
                const errorId = '1';
                
                // 检查localStorage
                localStorage.removeItem('currentErrorDetail'); // 确保测试环境干净
                const storedErrorDetail = localStorage.getItem('currentErrorDetail');
                
                addResult(`
                    <h4>🔧 错题详情页面逻辑分析：</h4>
                    <p><strong>当前errorId:</strong> "${errorId}"</p>
                    <p><strong>localStorage中的数据:</strong> ${storedErrorDetail ? '有数据' : '无数据'}</p>
                    <p><strong>会使用的数据源:</strong> ${storedErrorDetail ? 'localStorage' : '错题本API'}</p>
                `, 'info');

                // 5. 模拟修复后的逻辑
                const foundInErrorBook = errorBookData.recent_errors.find(error => error.id == errorId);
                
                if (foundInErrorBook) {
                    addResult(`
                        <h4>✅ 修复后的结果：</h4>
                        <div class="data-card">
                            <p><strong>错题详情页面将显示：</strong></p>
                            <p><strong>ID:</strong> ${foundInErrorBook.id}</p>
                            <p><strong>学科:</strong> <span style="color: green; font-weight: bold;">${foundInErrorBook.subject}</span></p>
                            <p><strong>题目:</strong> ${foundInErrorBook.question_text.substring(0, 60)}...</p>
                            <p><strong>与错题本一致：</strong> ✅ 是</p>
                        </div>
                    `, 'success');
                } else {
                    addResult(`
                        <h4>⚠️ 警告：在错题本中找不到ID=${errorId}的错题</h4>
                        <p>这可能是分页或数据同步问题</p>
                    `, 'warning');
                }

                // 6. 提供解决方案
                addResult(`
                    <h4>🛠️ 解决方案：</h4>
                    <p>错题详情页面已修改为调用错题本API，确保数据一致性</p>
                    <p><strong>现在测试：</strong></p>
                    <p>1. 访问 <a href="http://localhost:8080/frontend/error-book.html" target="_blank">错题本页面</a></p>
                    <p>2. 访问 <a href="http://localhost:8080/frontend/error-detail.html?id=1" target="_blank">错题详情页面</a></p>
                    <p>3. 对比两个页面的学科显示是否一致</p>
                `, 'success');

            } catch (error) {
                addResult(`❌ 调试失败: ${error.message}`, 'error');
                console.error('调试失败:', error);
            }
        }

        // 页面加载时设置token
        localStorage.setItem('token', TOKEN);
    </script>
</body>
</html>