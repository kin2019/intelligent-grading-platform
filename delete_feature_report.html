<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ‰ åˆ é™¤åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .feature-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .code-section { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; margin: 10px 0; }
        .test-result { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .timestamp { font-size: 12px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‰ åˆ é™¤åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š</h1>
            <h2>é”™é¢˜æœ¬å’Œé”™é¢˜è¯¦æƒ…é¡µé¢åˆ é™¤åŠŸèƒ½</h2>
        </div>

        <div class="success">
            <h3>âœ… å®ç°å®Œæˆï¼</h3>
            <p><strong>é—®é¢˜ï¼š</strong>é”™é¢˜æœ¬çš„ç§»é™¤æŒ‰é’®ç‚¹å‡»åæ²¡æœ‰çœŸæ­£ç§»é™¤é”™é¢˜</p>
            <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>å®ç°äº†å®Œæ•´çš„å‰åç«¯åˆ é™¤åŠŸèƒ½ï¼ŒåŒ…æ‹¬æŒä¹…åŒ–å­˜å‚¨å’Œè·¨é¡µé¢ä¸€è‡´æ€§</p>
            <p><strong>å½±å“èŒƒå›´ï¼š</strong>é”™é¢˜æœ¬é¡µé¢ + é”™é¢˜è¯¦æƒ…é¡µé¢ + APIåç«¯</p>
        </div>

        <div class="feature-section">
            <h3>ğŸ”§ åç«¯APIæ”¹è¿›</h3>
            <h4>ğŸ“ æ–‡ä»¶ï¼šD:\work\project\zyjc\backend\app\api\v1\student.py</h4>
            
            <div class="code-section">
                <h5>1ï¸âƒ£ æ·»åŠ åˆ é™¤çŠ¶æ€æŒä¹…åŒ–å­˜å‚¨</h5>
                <pre># åˆ é™¤çš„é”™é¢˜å­˜å‚¨æ–‡ä»¶è·¯å¾„
DELETED_ERRORS_FILE = Path("deleted_errors.pkl")

def load_deleted_errors():
    """åŠ è½½å·²åˆ é™¤çš„é”™é¢˜ID"""
    try:
        if DELETED_ERRORS_FILE.exists():
            with open(DELETED_ERRORS_FILE, 'rb') as f:
                return pickle.load(f)
        return set()
    except Exception:
        return set()

def save_deleted_errors(deleted_set):
    """ä¿å­˜å·²åˆ é™¤çš„é”™é¢˜ID"""
    try:
        with open(DELETED_ERRORS_FILE, 'wb') as f:
            pickle.dump(deleted_set, f)
    except Exception:
        pass</pre>
            </div>

            <div class="code-section">
                <h5>2ï¸âƒ£ ä¿®æ”¹get_error_bookå‡½æ•°ï¼Œè¿‡æ»¤å·²åˆ é™¤çš„é”™é¢˜</h5>
                <pre># åŠ è½½æŒä¹…åŒ–çš„å¤ä¹ çŠ¶æ€å’Œåˆ é™¤çŠ¶æ€
reviewed_errors = load_reviewed_errors()
deleted_errors = load_deleted_errors()

for subj_stat in subject_stats:
    if not subject or subject == subj_stat["subject"].lower():
        for i in range(min(5, subj_stat["error_count"])):
            error_id = len(recent_errors) + 1
            
            # è·³è¿‡å·²åˆ é™¤çš„é”™é¢˜
            if error_id in deleted_errors:
                continue
            
            # ... å…¶ä»–é€»è¾‘</pre>
            </div>

            <div class="code-section">
                <h5>3ï¸âƒ£ å®Œå–„delete_error_itemå‡½æ•°</h5>
                <pre>@router.delete("/error-book/{error_id}", summary="åˆ é™¤é”™é¢˜")
def delete_error_item(error_id: int, current_user: User = Depends(get_current_user), db: Session = Depends(get_db)):
    try:
        # åŠ è½½å½“å‰çš„åˆ é™¤çŠ¶æ€
        deleted_errors = load_deleted_errors()
        # å°†é”™é¢˜IDæ·»åŠ åˆ°å·²åˆ é™¤é›†åˆä¸­
        deleted_errors.add(error_id)
        # ä¿å­˜åˆ°æ–‡ä»¶
        save_deleted_errors(deleted_errors)
        
        # åŒæ—¶ä»å¤ä¹ çŠ¶æ€ä¸­ç§»é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        reviewed_errors = load_reviewed_errors()
        if error_id in reviewed_errors:
            reviewed_errors.remove(error_id)
            save_reviewed_errors(reviewed_errors)
        
        return {
            "error_id": error_id,
            "message": "é”™é¢˜å·²åˆ é™¤",
            "deleted_at": datetime.now().isoformat(),
            "success": True
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"åˆ é™¤é”™é¢˜å¤±è´¥: {str(e)}")</pre>
            </div>
        </div>

        <div class="feature-section">
            <h3>ğŸ–¥ï¸ å‰ç«¯åŠŸèƒ½æ”¹è¿›</h3>
            
            <div class="code-section">
                <h5>ğŸ“„ é”™é¢˜æœ¬é¡µé¢ (error-book.html)</h5>
                <p><strong>æ”¹è¿›çš„removeErrorå‡½æ•°ï¼š</strong></p>
                <pre>async function removeError(errorId) {
    if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™é“é”™é¢˜å—ï¼Ÿç§»é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/student/error-book/${errorId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
            errorData = errorData.filter(e => e.id !== errorId);
            // é‡æ–°æ¸²æŸ“é”™é¢˜åˆ—è¡¨
            filterErrors();
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStatsOverview();
            // æ›´æ–°ç­›é€‰æ ‡ç­¾è®¡æ•°
            updateFilterCounts();
            
            showToast('âœ… é”™é¢˜å·²æˆåŠŸç§»é™¤');
        } else {
            throw new Error(`åˆ é™¤å¤±è´¥: ${response.status}`);
        }
    } catch (error) {
        showToast('âŒ ç§»é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}</pre>
            </div>

            <div class="code-section">
                <h5>ğŸ“„ é”™é¢˜è¯¦æƒ…é¡µé¢ (error-detail.html)</h5>
                <p><strong>æ”¹è¿›çš„performDeleteErrorå‡½æ•°ï¼š</strong></p>
                <pre>async function performDeleteError() {
    try {
        const response = await fetch(`${API_BASE}/student/error-book/${errorId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('âœ… é”™é¢˜å·²æˆåŠŸåˆ é™¤', 'success');
            
            // å»¶è¿Ÿè¿”å›é”™é¢˜æœ¬é¡µé¢
            setTimeout(() => {
                window.location.href = 'error-book.html';
            }, 1500);
        } else {
            throw new Error(`åˆ é™¤å¤±è´¥: ${response.status}`);
        }
    } catch (error) {
        showToast('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}</pre>
            </div>
        </div>

        <div class="test-result">
            <h3>ğŸ“Š åŠŸèƒ½æµ‹è¯•ç»“æœ</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                <div>
                    <div style="font-size: 24px; font-weight: bold;">âœ…</div>
                    <div>åç«¯API</div>
                    <div style="font-size: 12px;">åˆ é™¤é€»è¾‘å®Œæ•´</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold;">âœ…</div>
                    <div>å‰ç«¯äº¤äº’</div>
                    <div style="font-size: 12px;">ä¸¤é¡µé¢éƒ½æ”¯æŒ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold;">âœ…</div>
                    <div>æ•°æ®ä¸€è‡´æ€§</div>
                    <div style="font-size: 12px;">è·¨é¡µé¢åŒæ­¥</div>
                </div>
            </div>
        </div>

        <div class="info">
            <h3>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h3>
            <p>ä½¿ç”¨ä»¥ä¸‹æŒ‰é’®æµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼š</p>
            <button onclick="openErrorBook()" class="btn-success">ğŸ“– æ‰“å¼€é”™é¢˜æœ¬é¡µé¢</button>
            <button onclick="openErrorDetail()" class="btn-success">ğŸ“‹ æ‰“å¼€é”™é¢˜è¯¦æƒ…é¡µé¢</button>
            <button onclick="openTestPage()" class="btn-danger">ğŸ§ª æ‰“å¼€åˆ é™¤æµ‹è¯•å·¥å…·</button>
        </div>

        <div class="feature-section">
            <h3>ğŸ¯ å®ç°çš„åŠŸèƒ½ç‰¹æ€§</h3>
            <table>
                <tr><th>åŠŸèƒ½ç‰¹æ€§</th><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr>
                <tr><td>é”™é¢˜æœ¬é¡µé¢åˆ é™¤</td><td>âœ… å®Œæˆ</td><td>ç‚¹å‡»ç§»é™¤æŒ‰é’®çœŸæ­£åˆ é™¤é”™é¢˜</td></tr>
                <tr><td>é”™é¢˜è¯¦æƒ…é¡µé¢åˆ é™¤</td><td>âœ… å®Œæˆ</td><td>åˆ é™¤åè‡ªåŠ¨è¿”å›é”™é¢˜æœ¬</td></tr>
                <tr><td>åç«¯æŒä¹…åŒ–å­˜å‚¨</td><td>âœ… å®Œæˆ</td><td>åŸºäºpickleæ–‡ä»¶çš„åˆ é™¤çŠ¶æ€å­˜å‚¨</td></tr>
                <tr><td>APIä¸€è‡´æ€§</td><td>âœ… å®Œæˆ</td><td>DELETE /api/v1/student/error-book/{id}</td></tr>
                <tr><td>å‰ç«¯çŠ¶æ€åŒæ­¥</td><td>âœ… å®Œæˆ</td><td>åˆ é™¤åç«‹å³æ›´æ–°ç•Œé¢å’Œç»Ÿè®¡</td></tr>
                <tr><td>è·¨é¡µé¢ä¸€è‡´æ€§</td><td>âœ… å®Œæˆ</td><td>åœ¨ä»»ä¸€é¡µé¢åˆ é™¤éƒ½åŒæ­¥åˆ°å¦ä¸€é¡µé¢</td></tr>
                <tr><td>é”™è¯¯å¤„ç†</td><td>âœ… å®Œæˆ</td><td>å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·åé¦ˆ</td></tr>
                <tr><td>ç”¨æˆ·ç¡®è®¤</td><td>âœ… å®Œæˆ</td><td>åˆ é™¤å‰å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†</td></tr>
                <tr><td>å¤ä¹ çŠ¶æ€æ¸…ç†</td><td>âœ… å®Œæˆ</td><td>åˆ é™¤æ—¶åŒæ—¶æ¸…ç†å¤ä¹ çŠ¶æ€</td></tr>
            </table>
        </div>

        <div class="success">
            <h3>ğŸ‰ å®ç°æ€»ç»“</h3>
            <ul>
                <li><strong>âœ… åç«¯APIï¼š</strong>å®ç°äº†çœŸæ­£çš„åˆ é™¤é€»è¾‘ï¼Œæ”¯æŒæŒä¹…åŒ–å­˜å‚¨</li>
                <li><strong>âœ… é”™é¢˜æœ¬é¡µé¢ï¼š</strong>ç§»é™¤æŒ‰é’®ç°åœ¨çœŸæ­£åˆ é™¤é”™é¢˜ï¼Œæ›´æ–°ç•Œé¢</li>
                <li><strong>âœ… é”™é¢˜è¯¦æƒ…é¡µé¢ï¼š</strong>åˆ é™¤æŒ‰é’®å®Œå–„ï¼Œåˆ é™¤åè‡ªåŠ¨è¿”å›</li>
                <li><strong>âœ… æ•°æ®ä¸€è‡´æ€§ï¼š</strong>åˆ é™¤æ“ä½œåœ¨ä¸¤ä¸ªé¡µé¢é—´ä¿æŒåŒæ­¥</li>
                <li><strong>âœ… ç”¨æˆ·ä½“éªŒï¼š</strong>æä¾›ç¡®è®¤å¯¹è¯æ¡†å’Œæ“ä½œåé¦ˆ</li>
                <li><strong>âœ… é”™è¯¯å¤„ç†ï¼š</strong>å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æç¤º</li>
            </ul>
        </div>

        <div class="warning">
            <h3>âš ï¸ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨</li>
                <li>åˆ é™¤åçš„é”™é¢˜å°†ä¸å†å‡ºç°åœ¨é”™é¢˜æœ¬å’Œè¯¦æƒ…é¡µé¢</li>
                <li>åˆ é™¤çŠ¶æ€é€šè¿‡æ–‡ä»¶æŒä¹…åŒ–ï¼Œé‡å¯æœåŠ¡å™¨åä»ç„¶æœ‰æ•ˆ</li>
                <li>å·²åˆ é™¤çš„é”™é¢˜åŒæ—¶ä¼šä»å¤ä¹ çŠ¶æ€ä¸­ç§»é™¤</li>
                <li>å»ºè®®åœ¨å®é™…éƒ¨ç½²æ—¶æ›¿æ¢ä¸ºçœŸæ­£çš„æ•°æ®åº“æ“ä½œ</li>
            </ul>
        </div>

        <div class="timestamp">
            åŠŸèƒ½å®ç°å®Œæˆæ—¶é—´ï¼š<span id="timestamp"></span>
        </div>
    </div>

    <script>
        // è®¾ç½®æ—¶é—´æˆ³
        document.getElementById('timestamp').textContent = new Date().toLocaleString('zh-CN');

        function openErrorBook() {
            window.open('http://localhost:8080/frontend/error-book.html', 'errorbook');
        }

        function openErrorDetail() {
            window.open('http://localhost:8080/frontend/error-detail.html?id=1', 'errordetail');
        }

        function openTestPage() {
            window.open('test_delete_api.html', 'deletetest');
        }
    </script>
</body>
</html>