<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业结果调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn { background: #4CAF50; color: white; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; overflow: auto; }
    </style>
</head>
<body>
    <h1>作业结果API调试</h1>
    
    <div class="debug-section">
        <h3>API测试：作业ID 898411</h3>
        <button class="test-btn" onclick="testAPI()">测试API调用</button>
        <div id="apiResult" class="result"></div>
        <pre id="rawData"></pre>
    </div>
    
    <div class="debug-section">
        <h3>模拟数据生成测试</h3>
        <button class="test-btn" onclick="testFallbackData()">生成模拟数据</button>
        <div id="fallbackResult" class="result"></div>
        <pre id="fallbackData"></pre>
    </div>
    
    <div class="debug-section">
        <h3>前端页面测试</h3>
        <button class="test-btn" onclick="window.open('http://localhost:8000/frontend/homework-result.html?id=898411')">打开实际页面</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            const rawDiv = document.getElementById('rawData');
            
            resultDiv.innerHTML = '正在测试API...';
            rawDiv.textContent = '';
            
            try {
                const response = await fetch(`${API_BASE}/homework/result/898411`);
                const data = await response.json();
                
                rawDiv.textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    const subjectName = {
                        'chinese': '语文',
                        'math': '数学', 
                        'english': '英语',
                        'physics': '物理',
                        'chemistry': '化学',
                        'biology': '生物'
                    }[data.subject] || data.subject;
                    
                    resultDiv.innerHTML = `
                        <div class="${response.ok ? 'success' : 'error'}">
                            <strong>API调用${response.ok ? '成功' : '失败'}</strong><br>
                            状态码: ${response.status}<br>
                            学科: <strong style="color: blue;">${subjectName} (${data.subject})</strong><br>
                            总题数: ${data.total_questions}<br>
                            正确数: ${data.correct_count}<br>
                            批改结果数量: ${data.correction_results ? data.correction_results.length : 0}<br>
                            状态: ${data.status}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">API调用失败: ${data.message || data.detail}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">请求失败: ${error.message}</div>`;
                rawDiv.textContent = error.stack;
            }
        }
        
        function testFallbackData() {
            const resultDiv = document.getElementById('fallbackResult');
            const dataDiv = document.getElementById('fallbackData');
            
            // 模拟生成逻辑
            const homeworkId = '898411';
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry'];
            
            let selectedSubject;
            if (homeworkId == '898411') {
                selectedSubject = 'chinese';
            } else {
                const subjectIndex = parseInt(homeworkId) % subjects.length;
                selectedSubject = subjects[subjectIndex];
            }
            
            const total = 8;
            const correct = 6;
            
            const corrections = [];
            for (let i = 0; i < total; i++) {
                let questionText, correctAnswer, userAnswer;
                
                if (selectedSubject === 'chinese') {
                    const poems = ['春眠不觉晓', '床前明月光', '白日依山尽', '锄禾日当午'];
                    questionText = `请默写：${poems[i % poems.length]}`;
                    correctAnswer = poems[i % poems.length];
                    userAnswer = i < correct ? correctAnswer : correctAnswer.slice(0, -1) + '×';
                } else {
                    const num1 = (parseInt(homeworkId) + i) % 50 + 1;
                    const num2 = (parseInt(homeworkId) + i * 2) % 30 + 1;
                    questionText = `${num1} + ${num2} = ?`;
                    correctAnswer = num1 + num2;
                    userAnswer = i < correct ? correctAnswer : correctAnswer + ((i % 3) - 1);
                }
                
                corrections.push({
                    question_number: i + 1,
                    question_text: questionText,
                    user_answer: String(userAnswer),
                    correct_answer: String(correctAnswer),
                    is_correct: i < correct,
                    explanation: i < correct ? '回答正确' : '需要仔细检查'
                });
            }
            
            const fallbackData = {
                id: homeworkId,
                subject: selectedSubject,
                total_questions: total,
                correct_count: correct,
                wrong_count: total - correct,
                accuracy_rate: Math.round((correct / total) * 100),
                status: 'completed',
                original_image_url: `/uploads/homework/homework_${homeworkId}_1.jpg`,
                correction_results: corrections,
                created_at: new Date().toISOString()
            };
            
            dataDiv.textContent = JSON.stringify(fallbackData, null, 2);
            
            const subjectName = {
                'chinese': '语文',
                'math': '数学', 
                'english': '英语',
                'physics': '物理',
                'chemistry': '化学'
            }[fallbackData.subject];
            
            resultDiv.innerHTML = `
                <div class="success">
                    <strong>模拟数据生成成功</strong><br>
                    学科: <strong style="color: blue;">${subjectName} (${fallbackData.subject})</strong><br>
                    总题数: ${fallbackData.total_questions}<br>
                    正确数: ${fallbackData.correct_count}<br>
                    批改结果数量: ${fallbackData.correction_results.length}<br>
                    状态: ${fallbackData.status}
                </div>
            `;
        }
        
        // 页面加载时自动运行测试
        window.onload = function() {
            testAPI();
            testFallbackData();
        };
    </script>
</body>
</html>