#!/usr/bin/env python3
"""
ä½¿ç”¨åŒä¸€ä¸ªç”¨æˆ·æµ‹è¯•dashboard APIå’Œhomework APIçš„æ•°æ®ä¸€è‡´æ€§
"""

import requests

def test_same_user_consistency():
    print("=== æµ‹è¯•åŒä¸€ç”¨æˆ·çš„APIæ•°æ®ä¸€è‡´æ€§ ===")
    
    # ç™»å½•ç”¨æˆ·18
    login_data = {"code": "test_user_18", "role": "student"}
    response = requests.post("http://localhost:8000/api/v1/auth/wechat/login", json=login_data)
    if response.status_code != 200:
        print(f"ç™»å½•å¤±è´¥: {response.status_code}")
        return
    
    token = response.json()["access_token"]
    user_id = response.json()["user"]["id"]
    print(f"ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID: {user_id}")
    
    headers = {"Authorization": f"Bearer {token}"}
    
    # 1. è·å–é¦–é¡µdashboardæ•°æ®
    print("\n1. è·å–é¦–é¡µdashboardæ•°æ®...")
    response = requests.get("http://localhost:8000/api/v1/student/dashboard", headers=headers)
    if response.status_code != 200:
        print(f"è·å–dashboardæ•°æ®å¤±è´¥: {response.status_code}")
        return
    
    dashboard_data = response.json()
    homework_list = dashboard_data["recent_homework"]
    
    if homework_list:
        first_homework = homework_list[0]
        homework_id = first_homework["id"]
        print(f"é¦–é¡µç¬¬ä¸€ä¸ªä½œä¸š: ID={homework_id}, æ€»é¢˜æ•°={first_homework['total_questions']}, é”™é¢˜={first_homework['error_count']}")
        
        # 2. è·å–ç›¸åŒIDçš„ä½œä¸šè¯¦æƒ…
        print(f"\n2. è·å–ä½œä¸šè¯¦æƒ…: ID={homework_id}")
        response = requests.get(f"http://localhost:8000/api/v1/homework/result/{homework_id}", headers=headers)
        if response.status_code != 200:
            print(f"è·å–ä½œä¸šè¯¦æƒ…å¤±è´¥: {response.status_code}")
            return
        
        detail_data = response.json()
        print(f"è¯¦æƒ…é¡µæ•°æ®: ID={detail_data['id']}, æ€»é¢˜æ•°={detail_data['total_questions']}, é”™é¢˜={detail_data['wrong_count']}")
        
        # 3. æ¯”è¾ƒæ•°æ®
        print(f"\n3. æ•°æ®æ¯”è¾ƒ:")
        print(f"  æ€»é¢˜æ•°: é¦–é¡µ={first_homework['total_questions']}, è¯¦æƒ…={detail_data['total_questions']}, ä¸€è‡´={first_homework['total_questions'] == detail_data['total_questions']}")
        print(f"  é”™é¢˜æ•°: é¦–é¡µ={first_homework['error_count']}, è¯¦æƒ…={detail_data['wrong_count']}, ä¸€è‡´={first_homework['error_count'] == detail_data['wrong_count']}")
        
        if first_homework['total_questions'] == detail_data['total_questions'] and first_homework['error_count'] == detail_data['wrong_count']:
            print("  ğŸ‰ æ•°æ®å®Œå…¨ä¸€è‡´ï¼")
        else:
            print("  âŒ æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®å¤")

if __name__ == "__main__":
    test_same_user_consistency()