<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJC智能批改平台 - 功能完整性测试</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-primary);
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            padding: 20px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 10px;
        }
        
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: var(--radius-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-item .info {
            flex: 1;
        }
        
        .test-item .status {
            margin-left: 15px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.pending { background: #ffeaa7; color: #2d3436; }
        .status.testing { background: #74b9ff; color: white; }
        .status.success { background: var(--success-color); color: white; }
        .status.error { background: var(--error-color); color: white; }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: var(--radius-small);
            background: var(--bg-tertiary);
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius-large);
        }
        
        .overview-card h4 {
            margin: 0 0 10px 0;
            font-size: var(--font-lg);
        }
        
        .overview-card .number {
            font-size: var(--font-3xl);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .control-panel {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .control-panel button {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; margin-bottom: 30px;">ZYJC智能批改平台 - 功能完整性测试</h1>
        
        <!-- 总览统计 -->
        <div class="overview">
            <div class="overview-card">
                <h4>总测试项目</h4>
                <div class="number" id="total-tests">0</div>
                <div>个功能</div>
            </div>
            <div class="overview-card">
                <h4>通过测试</h4>
                <div class="number" id="passed-tests">0</div>
                <div>个功能</div>
            </div>
            <div class="overview-card">
                <h4>测试通过率</h4>
                <div class="number" id="pass-rate">0%</div>
                <div>成功率</div>
            </div>
            <div class="overview-card">
                <h4>测试状态</h4>
                <div class="number" id="test-status">待开始</div>
                <div>当前状态</div>
            </div>
        </div>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <button class="btn btn-primary" onclick="startAllTests()">开始全部测试</button>
            <button class="btn btn-secondary" onclick="clearResults()">清除结果</button>
            <button class="btn btn-success" onclick="exportReport()">导出报告</button>
        </div>
        
        <!-- 用户认证测试 -->
        <div class="test-section">
            <h3>🔐 用户认证模块</h3>
            
            <div class="test-item" data-test="login">
                <div class="info">
                    <strong>微信登录 - 学生端</strong>
                    <div>测试学生角色登录功能</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testLogin('student')">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="login-parent">
                <div class="info">
                    <strong>微信登录 - 家长端</strong>
                    <div>测试家长角色登录功能</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testLogin('parent')">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="user-info">
                <div class="info">
                    <strong>用户信息获取</strong>
                    <div>获取当前登录用户的详细信息</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testUserInfo()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
        
        <!-- 学生功能测试 -->
        <div class="test-section">
            <h3>📚 学生端功能模块</h3>
            
            <div class="test-item" data-test="dashboard">
                <div class="info">
                    <strong>学生仪表盘</strong>
                    <div>获取学习数据统计和最近作业</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testDashboard()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="error-book">
                <div class="info">
                    <strong>错题本管理</strong>
                    <div>错题统计、分类和管理功能</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testErrorBook()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="study-plan">
                <div class="info">
                    <strong>学习计划</strong>
                    <div>AI生成的个性化学习建议</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testStudyPlan()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
        
        <!-- 作业批改测试 -->
        <div class="test-section">
            <h3>✏️ 作业批改模块</h3>
            
            <div class="test-item" data-test="homework-list">
                <div class="info">
                    <strong>作业历史列表</strong>
                    <div>获取用户的作业批改历史记录</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testHomeworkList()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="homework-detail">
                <div class="info">
                    <strong>作业详情查看</strong>
                    <div>查看具体作业的批改结果</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testHomeworkDetail()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="subjects">
                <div class="info">
                    <strong>支持学科列表</strong>
                    <div>获取平台支持的所有学科</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testSubjects()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
        
        <!-- 图像处理测试 -->
        <div class="test-section">
            <h3>🖼️ 图像处理模块</h3>
            
            <div class="test-item" data-test="ocr-validation">
                <div class="info">
                    <strong>OCR文件验证</strong>
                    <div>测试OCR接口的文件类型验证</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testOCRValidation()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="image-history">
                <div class="info">
                    <strong>图片处理历史</strong>
                    <div>获取用户的图片处理记录</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testImageHistory()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
        
        <!-- VIP和支付测试 -->
        <div class="test-section">
            <h3>💎 VIP和支付模块</h3>
            
            <div class="test-item" data-test="vip-status">
                <div class="info">
                    <strong>VIP状态查询</strong>
                    <div>获取用户的VIP状态和权益</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testVIPStatus()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="vip-plans">
                <div class="info">
                    <strong>VIP套餐列表</strong>
                    <div>获取所有可购买的VIP套餐</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testVIPPlans()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="create-order">
                <div class="info">
                    <strong>创建支付订单</strong>
                    <div>测试VIP套餐购买流程</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testCreateOrder()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
        
        <!-- 用户管理测试 -->
        <div class="test-section">
            <h3>👤 用户管理模块</h3>
            
            <div class="test-item" data-test="user-profile">
                <div class="info">
                    <strong>用户资料</strong>
                    <div>获取用户详细资料信息</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testUserProfile()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="user-settings">
                <div class="info">
                    <strong>用户设置</strong>
                    <div>获取用户的个性化设置</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testUserSettings()">测试</button>
                <div class="status pending">待测试</div>
            </div>
            
            <div class="test-item" data-test="user-achievements">
                <div class="info">
                    <strong>用户成就</strong>
                    <div>获取用户的学习成就和徽章</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="testUserAchievements()">测试</button>
                <div class="status pending">待测试</div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let authToken = '';
        let testResults = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });

        // 获取认证令牌
        async function ensureAuth() {
            if (!authToken) {
                try {
                    const response = await fetch(`${API_BASE}/auth/wechat/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({code: 'test_123', role: 'student'})
                    });
                    const data = await response.json();
                    authToken = data.access_token;
                } catch (error) {
                    console.error('获取认证令牌失败:', error);
                    throw error;
                }
            }
            return authToken;
        }

        // 测试状态管理
        function setTestStatus(testName, status, result = null) {
            testResults[testName] = {status, result, timestamp: new Date()};
            
            const testItem = document.querySelector(`[data-test="${testName}"]`);
            if (testItem) {
                const statusElement = testItem.querySelector('.status');
                statusElement.className = `status ${status}`;
                
                const statusText = {
                    pending: '待测试',
                    testing: '测试中...',
                    success: '通过',
                    error: '失败'
                };
                statusElement.textContent = statusText[status];
                
                // 显示测试结果
                let resultElement = testItem.querySelector('.test-result');
                if (!resultElement) {
                    resultElement = document.createElement('div');
                    resultElement.className = 'test-result';
                    testItem.appendChild(resultElement);
                }
                
                if (result) {
                    resultElement.textContent = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
                    resultElement.style.display = 'block';
                } else {
                    resultElement.style.display = 'none';
                }
            }
            
            updateStats();
        }

        // 更新统计数据
        function updateStats() {
            const totalTests = document.querySelectorAll('.test-item').length;
            const passedTests = Object.values(testResults).filter(r => r.status === 'success').length;
            const failedTests = Object.values(testResults).filter(r => r.status === 'error').length;
            const testingTests = Object.values(testResults).filter(r => r.status === 'testing').length;
            const passRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('pass-rate').textContent = passRate + '%';
            
            let statusText = '待开始';
            if (testingTests > 0) statusText = '测试中';
            else if (passedTests + failedTests === totalTests) statusText = '已完成';
            else if (passedTests + failedTests > 0) statusText = '进行中';
            
            document.getElementById('test-status').textContent = statusText;
        }

        // 通用API测试函数
        async function testAPI(testName, url, options = {}) {
            setTestStatus(testName, 'testing');
            
            try {
                await ensureAuth();
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    setTestStatus(testName, 'success', `状态码: ${response.status}, 数据: ${JSON.stringify(data).substring(0, 200)}...`);
                } else {
                    setTestStatus(testName, 'error', `状态码: ${response.status}, 错误: ${data.message || data.detail || '未知错误'}`);
                }
            } catch (error) {
                setTestStatus(testName, 'error', `网络错误: ${error.message}`);
            }
        }

        // 具体测试函数
        async function testLogin(role) {
            const testName = role === 'student' ? 'login' : 'login-parent';
            setTestStatus(testName, 'testing');
            
            try {
                const response = await fetch(`${API_BASE}/auth/wechat/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: `${role}_test_123`, role: role})
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    authToken = data.access_token;
                    setTestStatus(testName, 'success', `登录成功，获得令牌: ${data.access_token.substring(0, 50)}...`);
                } else {
                    setTestStatus(testName, 'error', `登录失败: ${data.message || data.detail || '未知错误'}`);
                }
            } catch (error) {
                setTestStatus(testName, 'error', `网络错误: ${error.message}`);
            }
        }

        async function testUserInfo() {
            await testAPI('user-info', `${API_BASE}/auth/me`);
        }

        async function testDashboard() {
            await testAPI('dashboard', `${API_BASE}/student/dashboard`);
        }

        async function testErrorBook() {
            await testAPI('error-book', `${API_BASE}/student/error-book`);
        }

        async function testStudyPlan() {
            await testAPI('study-plan', `${API_BASE}/student/study-plan`);
        }

        async function testHomeworkList() {
            await testAPI('homework-list', `${API_BASE}/homework/list`);
        }

        async function testHomeworkDetail() {
            await testAPI('homework-detail', `${API_BASE}/homework/1234`);
        }

        async function testSubjects() {
            await testAPI('subjects', `${API_BASE}/homework/subjects`);
        }

        async function testOCRValidation() {
            setTestStatus('ocr-validation', 'testing');
            
            try {
                await ensureAuth();
                
                // 创建一个测试文件
                const testFile = new File(['test content'], 'test.txt', {type: 'text/plain'});
                const formData = new FormData();
                formData.append('file', testFile);
                
                const response = await fetch(`${API_BASE}/image/ocr`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${authToken}`},
                    body: formData
                });
                
                const data = await response.json();
                
                // 期望返回400错误，因为不是图片文件
                if (response.status === 400 && data.message && data.message.includes('图片')) {
                    setTestStatus('ocr-validation', 'success', '文件类型验证正常工作，正确拒绝了非图片文件');
                } else {
                    setTestStatus('ocr-validation', 'error', `预期400错误，实际状态: ${response.status}`);
                }
            } catch (error) {
                setTestStatus('ocr-validation', 'error', `网络错误: ${error.message}`);
            }
        }

        async function testImageHistory() {
            await testAPI('image-history', `${API_BASE}/image/history`);
        }

        async function testVIPStatus() {
            await testAPI('vip-status', `${API_BASE}/user/vip-status`);
        }

        async function testVIPPlans() {
            await testAPI('vip-plans', `${API_BASE}/payment/plans`);
        }

        async function testCreateOrder() {
            setTestStatus('create-order', 'testing');
            
            try {
                await ensureAuth();
                const formData = new FormData();
                formData.append('plan_id', 'monthly');
                formData.append('payment_method', 'wechat');
                
                const response = await fetch(`${API_BASE}/payment/create-order`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${authToken}`},
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.order_id) {
                    setTestStatus('create-order', 'success', `订单创建成功: ${data.order_id}, 金额: ${data.amount}元`);
                } else {
                    setTestStatus('create-order', 'error', `创建订单失败: ${data.message || data.detail || '未知错误'}`);
                }
            } catch (error) {
                setTestStatus('create-order', 'error', `网络错误: ${error.message}`);
            }
        }

        async function testUserProfile() {
            await testAPI('user-profile', `${API_BASE}/user/profile`);
        }

        async function testUserSettings() {
            await testAPI('user-settings', `${API_BASE}/user/settings`);
        }

        async function testUserAchievements() {
            await testAPI('user-achievements', `${API_BASE}/user/achievements`);
        }

        // 开始全部测试
        async function startAllTests() {
            const testFunctions = [
                () => testLogin('student'),
                () => testLogin('parent'),
                testUserInfo,
                testDashboard,
                testErrorBook,
                testStudyPlan,
                testHomeworkList,
                testHomeworkDetail,
                testSubjects,
                testOCRValidation,
                testImageHistory,
                testVIPStatus,
                testVIPPlans,
                testCreateOrder,
                testUserProfile,
                testUserSettings,
                testUserAchievements
            ];

            document.getElementById('test-status').textContent = '正在测试';
            
            for (const testFunc of testFunctions) {
                await testFunc();
                await new Promise(resolve => setTimeout(resolve, 500)); // 间隔500ms
            }
            
            showToast('所有测试已完成！', 'success');
        }

        // 清除结果
        function clearResults() {
            testResults = {};
            document.querySelectorAll('.test-item').forEach(item => {
                const statusElement = item.querySelector('.status');
                statusElement.className = 'status pending';
                statusElement.textContent = '待测试';
                
                const resultElement = item.querySelector('.test-result');
                if (resultElement) {
                    resultElement.style.display = 'none';
                }
            });
            updateStats();
            showToast('测试结果已清除', 'info');
        }

        // 导出报告
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: Object.keys(testResults).length,
                    passed: Object.values(testResults).filter(r => r.status === 'success').length,
                    failed: Object.values(testResults).filter(r => r.status === 'error').length,
                    passRate: Object.keys(testResults).length > 0 ? 
                        Math.round((Object.values(testResults).filter(r => r.status === 'success').length / Object.keys(testResults).length) * 100) : 0
                },
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zyjc-test-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('测试报告已导出', 'success');
        }
    </script>
</body>
</html>