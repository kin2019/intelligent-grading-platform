<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        .test-area { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-btn { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007AFF; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0056CC;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #result { 
            margin-top: 20px; 
            padding: 16px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        
        .sample-questions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .question-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #007AFF;
        }
    </style>
</head>
<body>
    <div class="test-area">
        <h2>ğŸ“„ PDFå¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h2>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•PDFç”Ÿæˆå’Œä¸‹è½½åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <div>
            <button class="test-btn" onclick="testJsPDFLoading()" id="loadTestBtn">ğŸ” æµ‹è¯•jsPDFåº“åŠ è½½</button>
            <button class="test-btn" onclick="testBasicPDF()" id="basicTestBtn">ğŸ“ æµ‹è¯•åŸºç¡€PDFç”Ÿæˆ</button>
            <button class="test-btn" onclick="testChinesePDF()" id="chineseTestBtn">ğŸ‡¨ğŸ‡³ æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆ</button>
            <button class="test-btn" onclick="testComplexPDF()" id="complexTestBtn">ğŸ“š æµ‹è¯•ç»ƒä¹ é¢˜PDF</button>
        </div>
        
        <div class="sample-questions">
            <h4>æµ‹è¯•æ•°æ®é¢„è§ˆï¼š</h4>
            <div class="question-item">
                <strong>é¢˜ç›®1ï¼š</strong>è®¡ç®—ï¼š125 Ã— 8 = ?<br>
                <strong>ç­”æ¡ˆï¼š</strong>1000<br>
                <strong>è§£æï¼š</strong>è¿™æ˜¯ä¸€é“åŸºæœ¬çš„ä¹˜æ³•è¿ç®—é¢˜ç›®
            </div>
            <div class="question-item">
                <strong>é¢˜ç›®2ï¼š</strong>ä¸‹åˆ—è¯è¯­ä¸­ï¼Œæ²¡æœ‰é”™åˆ«å­—çš„ä¸€ç»„æ˜¯ï¼Ÿ<br>
                <strong>ç­”æ¡ˆï¼š</strong>Bé€‰é¡¹<br>
                <strong>è§£æï¼š</strong>æ³¨æ„åŒºåˆ†å½¢è¿‘å­—å’ŒéŸ³è¿‘å­—
            </div>
        </div>
        
        <div id="result">
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•PDFåŠŸèƒ½...</p>
        </div>
    </div>
    
    <div class="test-area">
        <h3>ğŸ”— è¿”å›ä¸»é¡µé¢</h3>
        <a href="error-book.html" class="test-btn" style="text-decoration: none;">è¿”å›é”™é¢˜æœ¬é¡µé¢</a>
    </div>

    <script>
        function updateResult(content, className = '') {
            const result = document.getElementById('result');
            if (className) {
                result.className = className;
            }
            result.innerHTML = content;
        }

        async function testJsPDFLoading() {
            const btn = document.getElementById('loadTestBtn');
            btn.disabled = true;
            btn.textContent = 'åŠ è½½ä¸­...';
            
            updateResult('æ­£åœ¨æµ‹è¯•jsPDFåº“åŠ è½½...');
            
            try {
                await loadJsPDFLibrary();
                updateResult(`
                    <span class="status-ok">âœ… jsPDFåº“åŠ è½½æˆåŠŸï¼</span><br>
                    <strong>ç‰ˆæœ¬ä¿¡æ¯:</strong> ${window.jsPDF ? 'jsPDFå·²å¯ç”¨' : 'æœªçŸ¥'}<br>
                    <strong>åŠ è½½æ—¶é—´:</strong> ${new Date().toLocaleTimeString()}
                `, 'status-ok');
            } catch (error) {
                updateResult(`
                    <span class="status-error">âŒ jsPDFåº“åŠ è½½å¤±è´¥</span><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}<br>
                    <strong>å»ºè®®:</strong> æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–å°è¯•åˆ·æ–°é¡µé¢
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ” æµ‹è¯•jsPDFåº“åŠ è½½';
            }
        }

        async function testBasicPDF() {
            const btn = document.getElementById('basicTestBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            
            updateResult('æ­£åœ¨æµ‹è¯•åŸºç¡€PDFç”Ÿæˆ...');
            
            try {
                if (typeof window.jsPDF === 'undefined') {
                    await loadJsPDFLibrary();
                }
                
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                doc.text('Hello World!', 10, 10);
                doc.text('PDF Test - Basic Function', 10, 20);
                doc.text('Generated at: ' + new Date().toLocaleString(), 10, 30);
                
                doc.save('basic-test.pdf');
                
                updateResult(`
                    <span class="status-ok">âœ… åŸºç¡€PDFç”ŸæˆæˆåŠŸï¼</span><br>
                    <strong>æ–‡ä»¶å:</strong> basic-test.pdf<br>
                    <strong>å†…å®¹:</strong> åŒ…å«åŸºæœ¬æ–‡æœ¬å’Œæ—¶é—´æˆ³<br>
                    <strong>çŠ¶æ€:</strong> æ–‡ä»¶åº”è¯¥å·²è‡ªåŠ¨ä¸‹è½½
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">âŒ åŸºç¡€PDFç”Ÿæˆå¤±è´¥</span><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“ æµ‹è¯•åŸºç¡€PDFç”Ÿæˆ';
            }
        }

        async function testChinesePDF() {
            const btn = document.getElementById('chineseTestBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            
            updateResult('æ­£åœ¨æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆ...');
            
            try {
                if (typeof window.jsPDF === 'undefined') {
                    await loadJsPDFLibrary();
                }
                
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                doc.setFont('helvetica');
                doc.text('Chinese Text Test:', 10, 10);
                doc.text('æ•°å­¦é¢˜ç›®ï¼š2 + 2 = ?', 10, 20);
                doc.text('ç­”æ¡ˆï¼š4', 10, 30);
                doc.text('è§£æï¼šè¿™æ˜¯åŸºæœ¬çš„åŠ æ³•è¿ç®—', 10, 40);
                doc.text('Generated: ' + new Date().toLocaleString(), 10, 50);
                
                doc.save('chinese-test.pdf');
                
                updateResult(`
                    <span class="status-ok">âœ… ä¸­æ–‡PDFç”ŸæˆæˆåŠŸï¼</span><br>
                    <strong>æ–‡ä»¶å:</strong> chinese-test.pdf<br>
                    <strong>å†…å®¹:</strong> åŒ…å«ä¸­æ–‡å­—ç¬¦çš„é¢˜ç›®å’Œè§£æ<br>
                    <strong>çŠ¶æ€:</strong> æ–‡ä»¶åº”è¯¥å·²è‡ªåŠ¨ä¸‹è½½
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">âŒ ä¸­æ–‡PDFç”Ÿæˆå¤±è´¥</span><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ‡¨ğŸ‡³ æµ‹è¯•ä¸­æ–‡PDFç”Ÿæˆ';
            }
        }

        async function testComplexPDF() {
            const btn = document.getElementById('complexTestBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            
            updateResult('æ­£åœ¨æµ‹è¯•å¤æ‚ç»ƒä¹ é¢˜PDFç”Ÿæˆ...');
            
            try {
                const mockQuestions = [
                    {
                        number: 1,
                        difficulty: 'same',
                        content: 'è®¡ç®—ï¼š125 Ã— 8 = ?',
                        answer: '1000',
                        analysis: 'è¿™æ˜¯ä¸€é“åŸºæœ¬çš„ä¹˜æ³•è¿ç®—é¢˜ç›®ï¼Œéœ€è¦æ³¨æ„è¿›ä½'
                    },
                    {
                        number: 2,
                        difficulty: 'easier',
                        content: 'ä¸‹åˆ—è¯è¯­ä¸­ï¼Œæ²¡æœ‰é”™åˆ«å­—çš„ä¸€ç»„æ˜¯ï¼ˆï¼‰',
                        answer: 'B',
                        analysis: 'æ³¨æ„åŒºåˆ†å½¢è¿‘å­—å’ŒéŸ³è¿‘å­—çš„å†™æ³•å·®å¼‚'
                    },
                    {
                        number: 3,
                        difficulty: 'harder',
                        content: 'Choose the correct answer: I ____ to school every day.',
                        answer: 'go',
                        analysis: 'ä¸€èˆ¬ç°åœ¨æ—¶ï¼Œç¬¬ä¸€äººç§°å•æ•°ç”¨åŠ¨è¯åŸå½¢'
                    }
                ];
                
                await exportToPDFTest(mockQuestions);
                
                updateResult(`
                    <span class="status-ok">âœ… ç»ƒä¹ é¢˜PDFç”ŸæˆæˆåŠŸï¼</span><br>
                    <strong>æ–‡ä»¶å:</strong> Practice-Questions-[æ—¥æœŸ].pdf<br>
                    <strong>å†…å®¹:</strong> åŒ…å«${mockQuestions.length}é“ç»ƒä¹ é¢˜<br>
                    <strong>åŠŸèƒ½:</strong> å®Œæ•´çš„é¢˜ç›®ã€ç­”æ¡ˆã€è§£ææ ¼å¼<br>
                    <strong>çŠ¶æ€:</strong> æ–‡ä»¶åº”è¯¥å·²è‡ªåŠ¨ä¸‹è½½
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">âŒ ç»ƒä¹ é¢˜PDFç”Ÿæˆå¤±è´¥</span><br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}<br>
                    <strong>å¯èƒ½åŸå› :</strong> jsPDFåº“æœªåŠ è½½æˆ–å­—ç¬¦ç¼–ç é—®é¢˜
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“š æµ‹è¯•ç»ƒä¹ é¢˜PDF';
            }
        }

        // ä»é”™é¢˜æœ¬é¡µé¢å¤åˆ¶çš„å‡½æ•°
        async function loadJsPDFLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof window.jsPDF !== 'undefined') {
                    console.log('jsPDFåº“å·²ç»åŠ è½½');
                    resolve();
                    return;
                }
                
                console.log('å¼€å§‹åŠ è½½jsPDFåº“...');
                
                const cdnUrls = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js', 
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.bootcdn.net/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'
                ];
                
                let currentIndex = 0;
                let timeoutId;
                
                function tryLoadScript() {
                    if (currentIndex >= cdnUrls.length) {
                        reject(new Error('æ‰€æœ‰jsPDF CDNå‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[currentIndex];
                    script.type = 'text/javascript';
                    
                    timeoutId = setTimeout(() => {
                        script.onerror = null;
                        script.onload = null;
                        console.log(`CDN ${currentIndex + 1} åŠ è½½è¶…æ—¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
                        currentIndex++;
                        tryLoadScript();
                    }, 10000);
                    
                    script.onload = () => {
                        clearTimeout(timeoutId);
                        console.log(`CDN ${currentIndex + 1} åŠ è½½æˆåŠŸ`);
                        
                        setTimeout(() => {
                            if (typeof window.jsPDF !== 'undefined') {
                                console.log('jsPDFåº“åŠ è½½å®Œæˆå¹¶å¯ç”¨');
                                resolve();
                            } else {
                                console.log(`CDN ${currentIndex + 1} æ–‡ä»¶åŠ è½½ä½†jsPDFä¸å¯ç”¨ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
                                currentIndex++;
                                tryLoadScript();
                            }
                        }, 100);
                    };
                    
                    script.onerror = (e) => {
                        clearTimeout(timeoutId);
                        console.log(`CDN ${currentIndex + 1} åŠ è½½å¤±è´¥:`, e);
                        currentIndex++;
                        tryLoadScript();
                    };
                    
                    console.log(`æ­£åœ¨å°è¯•CDN ${currentIndex + 1}: ${cdnUrls[currentIndex]}`);
                    document.head.appendChild(script);
                }
                
                tryLoadScript();
            });
        }

        function convertToSafeText(text) {
            if (!text) return '';
            return text
                .replace(/[^\u0000-\u007F\u4e00-\u9fff]/g, '')
                .replace(/[""]/g, '"')
                .replace(/['']/g, "'")
                .replace(/â€¦/g, '...')
                .replace(/â€”/g, '-')
                .replace(/Â·/g, '.')
                .trim();
        }

        function getDifficultyText(difficulty) {
            const texts = {
                'easier': 'ç®€å•',
                'same': 'ç›¸åŒéš¾åº¦',
                'harder': 'å›°éš¾'
            };
            return texts[difficulty] || 'ç›¸åŒéš¾åº¦';
        }

        async function exportToPDFTest(questions) {
            if (typeof window.jsPDF === 'undefined') {
                await loadJsPDFLibrary();
            }
            
            const { jsPDF } = window;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            doc.setFont('helvetica');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            let yPosition = 30;
            
            // æ ‡é¢˜
            doc.setFontSize(20);
            doc.setTextColor(0, 122, 255);
            doc.text('Practice Questions Collection', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // ä¿¡æ¯
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, pageWidth / 2, yPosition, { align: 'center' });
            doc.text(`Total Questions: ${questions.length}`, pageWidth / 2, yPosition + 5, { align: 'center' });
            yPosition += 20;
            
            // åˆ†éš”çº¿
            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 122, 255);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 15;
            
            // é¢˜ç›®
            questions.forEach((question, index) => {
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                // é¢˜ç›®æ ‡é¢˜
                doc.setFontSize(14);
                doc.setTextColor(0, 122, 255);
                const difficultyText = getDifficultyText(question.difficulty);
                const titleText = `Question ${question.number} [${difficultyText}]`;
                doc.text(titleText, margin, yPosition);
                yPosition += 8;
                
                // é¢˜ç›®å†…å®¹
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                const safeContent = convertToSafeText(question.content);
                const contentLines = doc.splitTextToSize(safeContent, maxWidth);
                doc.text(contentLines, margin, yPosition);
                yPosition += Math.max(contentLines.length * 6, 12) + 5;
                
                // ç­”æ¡ˆ
                if (question.answer) {
                    doc.setFontSize(11);
                    doc.setTextColor(46, 125, 50);
                    const safeAnswer = convertToSafeText(question.answer);
                    const answerText = `Answer: ${safeAnswer}`;
                    const answerLines = doc.splitTextToSize(answerText, maxWidth - 10);
                    doc.text(answerLines, margin + 5, yPosition);
                    yPosition += Math.max(answerLines.length * 5, 8) + 3;
                }
                
                // è§£æ
                if (question.analysis) {
                    doc.setFontSize(10);
                    doc.setTextColor(133, 100, 4);
                    const safeAnalysis = convertToSafeText(question.analysis);
                    const analysisText = `Analysis: ${safeAnalysis}`;
                    const analysisLines = doc.splitTextToSize(analysisText, maxWidth - 10);
                    doc.text(analysisLines, margin + 5, yPosition);
                    yPosition += Math.max(analysisLines.length * 4, 6) + 3;
                }
                
                yPosition += 8;
                
                // åˆ†éš”çº¿
                if (index < questions.length - 1) {
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    yPosition += 5;
                }
            });
            
            // é¡µè„š
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text('Generated by ZYJC System', pageWidth - margin, pageHeight - 10, { align: 'right' });
            }
            
            // ä¿å­˜
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `Practice-Questions-${timestamp}.pdf`;
            doc.save(fileName);
            
            console.log(`PDFæ–‡ä»¶ç”ŸæˆæˆåŠŸ: ${fileName}`);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•åº“åŠ è½½
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateResult('é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•PDFåŠŸèƒ½ã€‚å»ºè®®å…ˆç‚¹å‡»"æµ‹è¯•jsPDFåº“åŠ è½½"ã€‚');
            }, 500);
        });
    </script>
</body>
</html>