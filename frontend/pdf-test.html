<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF导出功能测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        .test-area { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-btn { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007AFF; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0056CC;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #result { 
            margin-top: 20px; 
            padding: 16px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        
        .sample-questions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .question-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #007AFF;
        }
    </style>
</head>
<body>
    <div class="test-area">
        <h2>📄 PDF导出功能测试</h2>
        <p>此页面用于测试PDF生成和下载功能是否正常工作</p>
        
        <div>
            <button class="test-btn" onclick="testJsPDFLoading()" id="loadTestBtn">🔍 测试jsPDF库加载</button>
            <button class="test-btn" onclick="testBasicPDF()" id="basicTestBtn">📝 测试基础PDF生成</button>
            <button class="test-btn" onclick="testChinesePDF()" id="chineseTestBtn">🇨🇳 测试中文PDF生成</button>
            <button class="test-btn" onclick="testComplexPDF()" id="complexTestBtn">📚 测试练习题PDF</button>
        </div>
        
        <div class="sample-questions">
            <h4>测试数据预览：</h4>
            <div class="question-item">
                <strong>题目1：</strong>计算：125 × 8 = ?<br>
                <strong>答案：</strong>1000<br>
                <strong>解析：</strong>这是一道基本的乘法运算题目
            </div>
            <div class="question-item">
                <strong>题目2：</strong>下列词语中，没有错别字的一组是？<br>
                <strong>答案：</strong>B选项<br>
                <strong>解析：</strong>注意区分形近字和音近字
            </div>
        </div>
        
        <div id="result">
            <p>点击上方按钮开始测试PDF功能...</p>
        </div>
    </div>
    
    <div class="test-area">
        <h3>🔗 返回主页面</h3>
        <a href="error-book.html" class="test-btn" style="text-decoration: none;">返回错题本页面</a>
    </div>

    <script>
        function updateResult(content, className = '') {
            const result = document.getElementById('result');
            if (className) {
                result.className = className;
            }
            result.innerHTML = content;
        }

        async function testJsPDFLoading() {
            const btn = document.getElementById('loadTestBtn');
            btn.disabled = true;
            btn.textContent = '加载中...';
            
            updateResult('正在测试jsPDF库加载...');
            
            try {
                await loadJsPDFLibrary();
                updateResult(`
                    <span class="status-ok">✅ jsPDF库加载成功！</span><br>
                    <strong>版本信息:</strong> ${window.jsPDF ? 'jsPDF已可用' : '未知'}<br>
                    <strong>加载时间:</strong> ${new Date().toLocaleTimeString()}
                `, 'status-ok');
            } catch (error) {
                updateResult(`
                    <span class="status-error">❌ jsPDF库加载失败</span><br>
                    <strong>错误信息:</strong> ${error.message}<br>
                    <strong>建议:</strong> 检查网络连接，或尝试刷新页面
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = '🔍 测试jsPDF库加载';
            }
        }

        async function testBasicPDF() {
            const btn = document.getElementById('basicTestBtn');
            btn.disabled = true;
            btn.textContent = '生成中...';
            
            updateResult('正在测试基础PDF生成...');
            
            try {
                if (typeof window.jsPDF === 'undefined') {
                    await loadJsPDFLibrary();
                }
                
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                doc.text('Hello World!', 10, 10);
                doc.text('PDF Test - Basic Function', 10, 20);
                doc.text('Generated at: ' + new Date().toLocaleString(), 10, 30);
                
                doc.save('basic-test.pdf');
                
                updateResult(`
                    <span class="status-ok">✅ 基础PDF生成成功！</span><br>
                    <strong>文件名:</strong> basic-test.pdf<br>
                    <strong>内容:</strong> 包含基本文本和时间戳<br>
                    <strong>状态:</strong> 文件应该已自动下载
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">❌ 基础PDF生成失败</span><br>
                    <strong>错误信息:</strong> ${error.message}
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = '📝 测试基础PDF生成';
            }
        }

        async function testChinesePDF() {
            const btn = document.getElementById('chineseTestBtn');
            btn.disabled = true;
            btn.textContent = '生成中...';
            
            updateResult('正在测试中文PDF生成...');
            
            try {
                if (typeof window.jsPDF === 'undefined') {
                    await loadJsPDFLibrary();
                }
                
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                doc.setFont('helvetica');
                doc.text('Chinese Text Test:', 10, 10);
                doc.text('数学题目：2 + 2 = ?', 10, 20);
                doc.text('答案：4', 10, 30);
                doc.text('解析：这是基本的加法运算', 10, 40);
                doc.text('Generated: ' + new Date().toLocaleString(), 10, 50);
                
                doc.save('chinese-test.pdf');
                
                updateResult(`
                    <span class="status-ok">✅ 中文PDF生成成功！</span><br>
                    <strong>文件名:</strong> chinese-test.pdf<br>
                    <strong>内容:</strong> 包含中文字符的题目和解析<br>
                    <strong>状态:</strong> 文件应该已自动下载
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">❌ 中文PDF生成失败</span><br>
                    <strong>错误信息:</strong> ${error.message}
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = '🇨🇳 测试中文PDF生成';
            }
        }

        async function testComplexPDF() {
            const btn = document.getElementById('complexTestBtn');
            btn.disabled = true;
            btn.textContent = '生成中...';
            
            updateResult('正在测试复杂练习题PDF生成...');
            
            try {
                const mockQuestions = [
                    {
                        number: 1,
                        difficulty: 'same',
                        content: '计算：125 × 8 = ?',
                        answer: '1000',
                        analysis: '这是一道基本的乘法运算题目，需要注意进位'
                    },
                    {
                        number: 2,
                        difficulty: 'easier',
                        content: '下列词语中，没有错别字的一组是（）',
                        answer: 'B',
                        analysis: '注意区分形近字和音近字的写法差异'
                    },
                    {
                        number: 3,
                        difficulty: 'harder',
                        content: 'Choose the correct answer: I ____ to school every day.',
                        answer: 'go',
                        analysis: '一般现在时，第一人称单数用动词原形'
                    }
                ];
                
                await exportToPDFTest(mockQuestions);
                
                updateResult(`
                    <span class="status-ok">✅ 练习题PDF生成成功！</span><br>
                    <strong>文件名:</strong> Practice-Questions-[日期].pdf<br>
                    <strong>内容:</strong> 包含${mockQuestions.length}道练习题<br>
                    <strong>功能:</strong> 完整的题目、答案、解析格式<br>
                    <strong>状态:</strong> 文件应该已自动下载
                `, 'status-ok');
                
            } catch (error) {
                updateResult(`
                    <span class="status-error">❌ 练习题PDF生成失败</span><br>
                    <strong>错误信息:</strong> ${error.message}<br>
                    <strong>可能原因:</strong> jsPDF库未加载或字符编码问题
                `, 'status-error');
            } finally {
                btn.disabled = false;
                btn.textContent = '📚 测试练习题PDF';
            }
        }

        // 从错题本页面复制的函数
        async function loadJsPDFLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof window.jsPDF !== 'undefined') {
                    console.log('jsPDF库已经加载');
                    resolve();
                    return;
                }
                
                console.log('开始加载jsPDF库...');
                
                const cdnUrls = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js', 
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.bootcdn.net/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'
                ];
                
                let currentIndex = 0;
                let timeoutId;
                
                function tryLoadScript() {
                    if (currentIndex >= cdnUrls.length) {
                        reject(new Error('所有jsPDF CDN均加载失败，请检查网络连接'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[currentIndex];
                    script.type = 'text/javascript';
                    
                    timeoutId = setTimeout(() => {
                        script.onerror = null;
                        script.onload = null;
                        console.log(`CDN ${currentIndex + 1} 加载超时，尝试下一个...`);
                        currentIndex++;
                        tryLoadScript();
                    }, 10000);
                    
                    script.onload = () => {
                        clearTimeout(timeoutId);
                        console.log(`CDN ${currentIndex + 1} 加载成功`);
                        
                        setTimeout(() => {
                            if (typeof window.jsPDF !== 'undefined') {
                                console.log('jsPDF库加载完成并可用');
                                resolve();
                            } else {
                                console.log(`CDN ${currentIndex + 1} 文件加载但jsPDF不可用，尝试下一个...`);
                                currentIndex++;
                                tryLoadScript();
                            }
                        }, 100);
                    };
                    
                    script.onerror = (e) => {
                        clearTimeout(timeoutId);
                        console.log(`CDN ${currentIndex + 1} 加载失败:`, e);
                        currentIndex++;
                        tryLoadScript();
                    };
                    
                    console.log(`正在尝试CDN ${currentIndex + 1}: ${cdnUrls[currentIndex]}`);
                    document.head.appendChild(script);
                }
                
                tryLoadScript();
            });
        }

        function convertToSafeText(text) {
            if (!text) return '';
            return text
                .replace(/[^\u0000-\u007F\u4e00-\u9fff]/g, '')
                .replace(/[""]/g, '"')
                .replace(/['']/g, "'")
                .replace(/…/g, '...')
                .replace(/—/g, '-')
                .replace(/·/g, '.')
                .trim();
        }

        function getDifficultyText(difficulty) {
            const texts = {
                'easier': '简单',
                'same': '相同难度',
                'harder': '困难'
            };
            return texts[difficulty] || '相同难度';
        }

        async function exportToPDFTest(questions) {
            if (typeof window.jsPDF === 'undefined') {
                await loadJsPDFLibrary();
            }
            
            const { jsPDF } = window;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            doc.setFont('helvetica');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            let yPosition = 30;
            
            // 标题
            doc.setFontSize(20);
            doc.setTextColor(0, 122, 255);
            doc.text('Practice Questions Collection', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // 信息
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, pageWidth / 2, yPosition, { align: 'center' });
            doc.text(`Total Questions: ${questions.length}`, pageWidth / 2, yPosition + 5, { align: 'center' });
            yPosition += 20;
            
            // 分隔线
            doc.setLineWidth(0.5);
            doc.setDrawColor(0, 122, 255);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 15;
            
            // 题目
            questions.forEach((question, index) => {
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                // 题目标题
                doc.setFontSize(14);
                doc.setTextColor(0, 122, 255);
                const difficultyText = getDifficultyText(question.difficulty);
                const titleText = `Question ${question.number} [${difficultyText}]`;
                doc.text(titleText, margin, yPosition);
                yPosition += 8;
                
                // 题目内容
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                const safeContent = convertToSafeText(question.content);
                const contentLines = doc.splitTextToSize(safeContent, maxWidth);
                doc.text(contentLines, margin, yPosition);
                yPosition += Math.max(contentLines.length * 6, 12) + 5;
                
                // 答案
                if (question.answer) {
                    doc.setFontSize(11);
                    doc.setTextColor(46, 125, 50);
                    const safeAnswer = convertToSafeText(question.answer);
                    const answerText = `Answer: ${safeAnswer}`;
                    const answerLines = doc.splitTextToSize(answerText, maxWidth - 10);
                    doc.text(answerLines, margin + 5, yPosition);
                    yPosition += Math.max(answerLines.length * 5, 8) + 3;
                }
                
                // 解析
                if (question.analysis) {
                    doc.setFontSize(10);
                    doc.setTextColor(133, 100, 4);
                    const safeAnalysis = convertToSafeText(question.analysis);
                    const analysisText = `Analysis: ${safeAnalysis}`;
                    const analysisLines = doc.splitTextToSize(analysisText, maxWidth - 10);
                    doc.text(analysisLines, margin + 5, yPosition);
                    yPosition += Math.max(analysisLines.length * 4, 6) + 3;
                }
                
                yPosition += 8;
                
                // 分隔线
                if (index < questions.length - 1) {
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    yPosition += 5;
                }
            });
            
            // 页脚
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text('Generated by ZYJC System', pageWidth - margin, pageHeight - 10, { align: 'right' });
            }
            
            // 保存
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `Practice-Questions-${timestamp}.pdf`;
            doc.save(fileName);
            
            console.log(`PDF文件生成成功: ${fileName}`);
        }

        // 页面加载时自动测试库加载
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateResult('页面已加载，可以开始测试PDF功能。建议先点击"测试jsPDF库加载"。');
            }, 500);
        });
    </script>
</body>
</html>