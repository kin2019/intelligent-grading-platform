<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è®¡åˆ’ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-panel { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .loading { color: #666; }
        pre { background: #f9f9f9; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .step-title { font-weight: bold; margin-bottom: 5px; }
        .comparison { display: flex; gap: 20px; }
        .comparison > div { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å­¦ä¹ è®¡åˆ’æ˜¾ç¤ºä¸€è‡´æ€§æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºè¯Šæ–­å­¦ä¹ è®¡åˆ’åˆ›å»ºåä¸æ˜¾ç¤ºçš„é—®é¢˜</p>
        
        <div class="test-panel">
            <h2>ğŸ“‹ æµ‹è¯•æµç¨‹</h2>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
            <div id="testProgress"></div>
        </div>
        
        <div class="test-panel">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="testResults"></div>
        </div>
        
        <div class="test-panel">
            <h2>ğŸ”§ é—®é¢˜è¯Šæ–­</h2>
            <div id="diagnosis"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxMDAwMjMsInN1YiI6IjEifQ.R_dHdA1lUTRzyBIGxCPk6UrO7kiucBwSl3R_PHieRn8';
        
        let testResults = {};
        
        async function runFullTest() {
            const progressDiv = document.getElementById('testProgress');
            const resultsDiv = document.getElementById('testResults');
            
            progressDiv.innerHTML = '<div class="loading">æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...</div>';
            resultsDiv.innerHTML = '';
            testResults = {};
            
            try {
                // æ­¥éª¤1ï¼šè·å–å½“å‰å­¦ä¹ è®¡åˆ’
                await testStep1();
                await testStep2();
                await testStep3();
                await testStep4();
                await testStep5();
                
                progressDiv.innerHTML = '<div style="color: green;">âœ… æµ‹è¯•å®Œæˆ</div>';
                showDiagnosis();
                
            } catch (error) {
                progressDiv.innerHTML = `<div style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function testStep1() {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = '<div class="step-title">æ­¥éª¤1ï¼šè·å–å½“å‰å­¦ä¹ è®¡åˆ’</div><div class="loading">æµ‹è¯•ä¸­...</div>';
            document.getElementById('testResults').appendChild(step);
            
            try {
                const response = await fetch(`${API_BASE}/student/study-plan`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                testResults.currentPlan = {
                    success: response.ok,
                    data: data,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step success';
                step.innerHTML = `
                    <div class="step-title">âœ… æ­¥éª¤1ï¼šè·å–å½“å‰å­¦ä¹ è®¡åˆ’ - æˆåŠŸ</div>
                    <p><strong>è®¡åˆ’ID:</strong> ${data.plan_id}</p>
                    <p><strong>æ ‡é¢˜:</strong> ${data.title}</p>
                    <p><strong>æ€»ä»»åŠ¡:</strong> ${data.total_tasks}</p>
                    <p><strong>å·²å®Œæˆ:</strong> ${data.completed_tasks}</p>
                    <details>
                        <summary>æŸ¥çœ‹APIå“åº”</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                testResults.currentPlan = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step error';
                step.innerHTML = `
                    <div class="step-title">âŒ æ­¥éª¤1ï¼šè·å–å½“å‰å­¦ä¹ è®¡åˆ’ - å¤±è´¥</div>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                throw error;
            }
        }
        
        async function testStep2() {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = '<div class="step-title">æ­¥éª¤2ï¼šåˆ›å»ºæ–°çš„å­¦ä¹ è®¡åˆ’</div><div class="loading">æµ‹è¯•ä¸­...</div>';
            document.getElementById('testResults').appendChild(step);
            
            try {
                const planData = {
                    title: `ä¸€è‡´æ€§æµ‹è¯•è®¡åˆ’ ${new Date().toLocaleTimeString()}`,
                    description: "ç”¨äºæµ‹è¯•é¡µé¢æ˜¾ç¤ºä¸€è‡´æ€§",
                    subjects: ["math", "chinese"],
                    priority: "medium",
                    duration_days: 3,
                    daily_time: 30,
                    tasks: [
                        { title: "æµ‹è¯•ä»»åŠ¡A", subject: "math", estimatedTime: 15 },
                        { title: "æµ‹è¯•ä»»åŠ¡B", subject: "chinese", estimatedTime: 15 }
                    ],
                    estimated_time: 30
                };
                
                const response = await fetch(`${API_BASE}/student/study-plan-create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                const data = await response.json();
                testResults.createPlan = {
                    success: response.ok,
                    data: data,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step success';
                step.innerHTML = `
                    <div class="step-title">âœ… æ­¥éª¤2ï¼šåˆ›å»ºæ–°çš„å­¦ä¹ è®¡åˆ’ - æˆåŠŸ</div>
                    <p><strong>æ–°è®¡åˆ’ID:</strong> ${data.plan_id}</p>
                    <p><strong>æ ‡é¢˜:</strong> ${data.title}</p>
                    <p><strong>ä»»åŠ¡æ•°:</strong> ${data.total_tasks}</p>
                    <details>
                        <summary>æŸ¥çœ‹åˆ›å»ºå“åº”</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                testResults.createPlan = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step error';
                step.innerHTML = `
                    <div class="step-title">âŒ æ­¥éª¤2ï¼šåˆ›å»ºæ–°çš„å­¦ä¹ è®¡åˆ’ - å¤±è´¥</div>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                throw error;
            }
        }
        
        async function testStep3() {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = '<div class="step-title">æ­¥éª¤3ï¼šé‡æ–°è·å–å­¦ä¹ è®¡åˆ’ï¼ˆéªŒè¯åˆ›å»ºæ˜¯å¦æˆåŠŸï¼‰</div><div class="loading">æµ‹è¯•ä¸­...</div>';
            document.getElementById('testResults').appendChild(step);
            
            // ç­‰å¾…1ç§’ç¡®ä¿æ•°æ®åº“æ“ä½œå®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            try {
                const response = await fetch(`${API_BASE}/student/study-plan`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                testResults.verifyPlan = {
                    success: response.ok,
                    data: data,
                    timestamp: new Date().toISOString()
                };
                
                // æ¯”è¾ƒåˆ›å»ºå‰åçš„è®¡åˆ’ID
                const oldPlanId = testResults.currentPlan.data.plan_id;
                const newPlanId = data.plan_id;
                const isUpdated = newPlanId !== oldPlanId;
                
                step.className = isUpdated ? 'step success' : 'step warning';
                step.innerHTML = `
                    <div class="step-title">${isUpdated ? 'âœ…' : 'âš ï¸'} æ­¥éª¤3ï¼šé‡æ–°è·å–å­¦ä¹ è®¡åˆ’ - ${isUpdated ? 'æˆåŠŸ' : 'æœªæ›´æ–°'}</div>
                    <p><strong>åŸè®¡åˆ’ID:</strong> ${oldPlanId}</p>
                    <p><strong>å½“å‰è®¡åˆ’ID:</strong> ${newPlanId}</p>
                    <p><strong>æ ‡é¢˜:</strong> ${data.title}</p>
                    <p><strong>æ˜¯å¦ä¸ºæ–°è®¡åˆ’:</strong> ${isUpdated ? 'æ˜¯' : 'å¦'}</p>
                    <details>
                        <summary>æŸ¥çœ‹éªŒè¯å“åº”</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                testResults.verifyPlan = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step error';
                step.innerHTML = `
                    <div class="step-title">âŒ æ­¥éª¤3ï¼šé‡æ–°è·å–å­¦ä¹ è®¡åˆ’ - å¤±è´¥</div>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                throw error;
            }
        }
        
        async function testStep4() {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = '<div class="step-title">æ­¥éª¤4ï¼šæ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºé€»è¾‘</div><div class="loading">æµ‹è¯•ä¸­...</div>';
            document.getElementById('testResults').appendChild(step);
            
            try {
                const data = testResults.verifyPlan.data;
                
                // æ¨¡æ‹Ÿå‰ç«¯updateCurrentPlanå‡½æ•°çš„é€»è¾‘
                const totalTasks = data.total_tasks || 0;
                const completedTasks = data.completed_tasks || 0;
                const estimatedTime = data.estimated_time || 0;
                
                const progress = totalTasks > 0 ? (completedTasks / totalTasks * 100).toFixed(1) : '0.0';
                const estimatedHours = Math.floor(estimatedTime / 60);
                const estimatedMinutes = estimatedTime % 60;
                
                const isCompleted = completedTasks >= totalTasks && totalTasks > 0;
                const statusText = isCompleted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
                
                testResults.frontendLogic = {
                    success: true,
                    calculations: {
                        totalTasks, completedTasks, estimatedTime,
                        progress, estimatedHours, estimatedMinutes,
                        isCompleted, statusText
                    },
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step success';
                step.innerHTML = `
                    <div class="step-title">âœ… æ­¥éª¤4ï¼šæ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºé€»è¾‘ - æˆåŠŸ</div>
                    <p><strong>æ€»ä»»åŠ¡:</strong> ${totalTasks}</p>
                    <p><strong>å·²å®Œæˆ:</strong> ${completedTasks}</p>
                    <p><strong>è¿›åº¦:</strong> ${progress}%</p>
                    <p><strong>çŠ¶æ€:</strong> ${statusText}</p>
                    <p><strong>é¢„è®¡æ—¶é—´:</strong> ${estimatedHours}h${estimatedMinutes > 0 ? estimatedMinutes + 'm' : ''}</p>
                    <details>
                        <summary>æŸ¥çœ‹è®¡ç®—ç»“æœ</summary>
                        <pre>${JSON.stringify(testResults.frontendLogic.calculations, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                testResults.frontendLogic = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step error';
                step.innerHTML = `
                    <div class="step-title">âŒ æ­¥éª¤4ï¼šæ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºé€»è¾‘ - å¤±è´¥</div>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
            }
        }
        
        async function testStep5() {
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = '<div class="step-title">æ­¥éª¤5ï¼šæµ‹è¯•å®é™…çš„å­¦ä¹ è®¡åˆ’é¡µé¢</div><div class="loading">æµ‹è¯•ä¸­...</div>';
            document.getElementById('testResults').appendChild(step);
            
            try {
                // å°è¯•åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢
                const planPageUrl = 'http://localhost:8080/frontend/study-plan.html';
                
                testResults.pageTest = {
                    success: true,
                    pageUrl: planPageUrl,
                    instructions: [
                        '1. ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢',
                        '2. æ£€æŸ¥é¡µé¢æ˜¯å¦æ˜¾ç¤ºæœ€æ–°çš„å­¦ä¹ è®¡åˆ’',
                        '3. æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Consoleæ˜¯å¦æœ‰é”™è¯¯',
                        '4. æ£€æŸ¥Networkæ ‡ç­¾é¡µçš„APIè¯·æ±‚æ˜¯å¦æˆåŠŸ'
                    ],
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step success';
                step.innerHTML = `
                    <div class="step-title">âœ… æ­¥éª¤5ï¼šæµ‹è¯•å®é™…çš„å­¦ä¹ è®¡åˆ’é¡µé¢</div>
                    <p><strong>é¡µé¢é“¾æ¥:</strong> <a href="${planPageUrl}" target="_blank">${planPageUrl}</a></p>
                    <p><strong>é¢„æœŸæ˜¾ç¤ºçš„è®¡åˆ’:</strong></p>
                    <ul>
                        <li>è®¡åˆ’ID: ${testResults.verifyPlan.data.plan_id}</li>
                        <li>æ ‡é¢˜: ${testResults.verifyPlan.data.title}</li>
                        <li>ä»»åŠ¡æ•°: ${testResults.verifyPlan.data.total_tasks}</li>
                    </ul>
                    <p><strong>æ‰‹åŠ¨éªŒè¯æ­¥éª¤:</strong></p>
                    <ol>
                        <li>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢</li>
                        <li>æ£€æŸ¥é¡µé¢æ˜¯å¦æ˜¾ç¤ºæœ€æ–°çš„å­¦ä¹ è®¡åˆ’</li>
                        <li>æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹Consoleæ˜¯å¦æœ‰é”™è¯¯</li>
                        <li>æŸ¥çœ‹Networkæ ‡ç­¾é¡µçš„APIè¯·æ±‚æ˜¯å¦æˆåŠŸ</li>
                    </ol>
                `;
                
            } catch (error) {
                testResults.pageTest = {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                step.className = 'step error';
                step.innerHTML = `
                    <div class="step-title">âŒ æ­¥éª¤5ï¼šæµ‹è¯•å®é™…çš„å­¦ä¹ è®¡åˆ’é¡µé¢ - å¤±è´¥</div>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
            }
        }
        
        function showDiagnosis() {
            const diagnosisDiv = document.getElementById('diagnosis');
            let diagnosis = [];
            
            // æ£€æŸ¥APIæ˜¯å¦æ­£å¸¸
            if (testResults.currentPlan?.success && testResults.createPlan?.success && testResults.verifyPlan?.success) {
                diagnosis.push('âœ… åç«¯APIå®Œå…¨æ­£å¸¸ï¼Œå¯ä»¥æ­£ç¡®åˆ›å»ºå’Œè¿”å›å­¦ä¹ è®¡åˆ’');
            } else {
                diagnosis.push('âŒ åç«¯APIå­˜åœ¨é—®é¢˜');
            }
            
            // æ£€æŸ¥è®¡åˆ’æ˜¯å¦æˆåŠŸæ›´æ–°
            if (testResults.currentPlan?.data?.plan_id !== testResults.verifyPlan?.data?.plan_id) {
                diagnosis.push('âœ… æ–°å»ºå­¦ä¹ è®¡åˆ’æˆåŠŸæ›¿æ¢äº†æ—§è®¡åˆ’');
            } else {
                diagnosis.push('âš ï¸ æ–°å»ºå­¦ä¹ è®¡åˆ’å¯èƒ½æ²¡æœ‰æ­£ç¡®æ›¿æ¢æ—§è®¡åˆ’');
            }
            
            // æ£€æŸ¥å‰ç«¯é€»è¾‘æ˜¯å¦æ­£å¸¸
            if (testResults.frontendLogic?.success) {
                diagnosis.push('âœ… å‰ç«¯æ˜¾ç¤ºé€»è¾‘è®¡ç®—æ­£å¸¸');
            } else {
                diagnosis.push('âŒ å‰ç«¯æ˜¾ç¤ºé€»è¾‘å­˜åœ¨é—®é¢˜');
            }
            
            // ç»™å‡ºå»ºè®®
            diagnosis.push('');
            diagnosis.push('<strong>å»ºè®®å’Œä¸‹ä¸€æ­¥ï¼š</strong>');
            diagnosis.push('1. å¦‚æœä»¥ä¸Šæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œé—®é¢˜å¯èƒ½æ˜¯ï¼š');
            diagnosis.push('   - æµè§ˆå™¨ç¼“å­˜é—®é¢˜ï¼šæŒ‰Ctrl+F5å¼ºåˆ¶åˆ·æ–°é¡µé¢');
            diagnosis.push('   - ç”¨æˆ·æŸ¥çœ‹çš„é¡µé¢ç‰ˆæœ¬ä¸æ­£ç¡®');
            diagnosis.push('   - JavaScriptæ‰§è¡Œæ—¶æœºé—®é¢˜');
            diagnosis.push('2. è¯·æ‰‹åŠ¨ç‚¹å‡»ä¸Šæ–¹é“¾æ¥éªŒè¯å®é™…é¡µé¢æ˜¾ç¤º');
            diagnosis.push('3. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„Consoleå’ŒNetwork');
            
            diagnosisDiv.innerHTML = `
                <div class="test-panel success">
                    <h3>ğŸ” é—®é¢˜è¯Šæ–­ç»“æœ</h3>
                    ${diagnosis.map(item => `<p>${item}</p>`).join('')}
                </div>
                
                <div class="comparison">
                    <div>
                        <h4>åˆ›å»ºå‰çš„è®¡åˆ’</h4>
                        <pre>${JSON.stringify(testResults.currentPlan?.data, null, 2)}</pre>
                    </div>
                    <div>
                        <h4>åˆ›å»ºåçš„è®¡åˆ’</h4>
                        <pre>${JSON.stringify(testResults.verifyPlan?.data, null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        function clearResults() {
            document.getElementById('testProgress').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('diagnosis').innerHTML = '';
            testResults = {};
        }
    </script>
</body>
</html>