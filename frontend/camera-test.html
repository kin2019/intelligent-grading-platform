<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸æœºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        .test-area { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-btn { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007AFF; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0056CC;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #result { 
            margin-top: 20px; 
            padding: 16px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        
        .test-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 8px;
            background: #000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-area">
        <h2>ğŸ“· ç›¸æœºåŠŸèƒ½æ£€æµ‹</h2>
        <p>æ­¤é¡µé¢ç”¨äºæ£€æµ‹æ‚¨çš„è®¾å¤‡å’Œæµè§ˆå™¨æ˜¯å¦æ”¯æŒç›¸æœºåŠŸèƒ½</p>
        
        <div>
            <button class="test-btn" onclick="checkEnvironment()">ğŸ” æ£€æŸ¥ç¯å¢ƒ</button>
            <button class="test-btn" onclick="checkPermissions()">ğŸ” æ£€æŸ¥æƒé™</button>
            <button class="test-btn" onclick="testCamera()" id="testCameraBtn">ğŸ“· æµ‹è¯•ç›¸æœº</button>
            <button class="test-btn" onclick="listDevices()">ğŸ“± è®¾å¤‡åˆ—è¡¨</button>
        </div>
        
        <video id="testVideo" class="test-video" autoplay playsinline></video>
        
        <div id="result">
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ£€æµ‹...</p>
        </div>
    </div>
    
    <div class="test-area">
        <h3>ğŸ”— è¿”å›ä¸»é¡µé¢</h3>
        <a href="homework-submit.html" class="test-btn" style="text-decoration: none;">è¿”å›æ‹ç…§æ‰¹æ”¹é¡µé¢</a>
    </div>

    <script>
        let currentStream = null;

        function updateResult(content, className = '') {
            const result = document.getElementById('result');
            if (className) {
                result.className = className;
            }
            result.innerHTML = content;
        }

        function checkEnvironment() {
            updateResult('æ­£åœ¨æ£€æŸ¥ç¯å¢ƒ...');
            
            let results = [];
            
            // æ£€æŸ¥åè®®
            if (location.protocol === 'https:') {
                results.push('<span class="status-ok">âœ… HTTPSåè®® - æ”¯æŒç›¸æœºåŠŸèƒ½</span>');
            } else if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                results.push('<span class="status-ok">âœ… æœ¬åœ°ç¯å¢ƒ - æ”¯æŒç›¸æœºåŠŸèƒ½</span>');
            } else {
                results.push('<span class="status-error">âŒ HTTPåè®® - ä¸æ”¯æŒç›¸æœºåŠŸèƒ½ï¼Œéœ€è¦HTTPS</span>');
            }
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                results.push('<span class="status-ok">âœ… æµè§ˆå™¨æ”¯æŒ getUserMedia API</span>');
            } else {
                results.push('<span class="status-error">âŒ æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia API</span>');
            }
            
            // æ£€æŸ¥è®¾å¤‡ç±»å‹
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                results.push('<span class="status-ok">ğŸ“± ç§»åŠ¨è®¾å¤‡ - å»ºè®®ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç›¸æœº</span>');
            } else {
                results.push('<span class="status-ok">ğŸ’» æ¡Œé¢è®¾å¤‡ - é€‚åˆä½¿ç”¨ç½‘é¡µç›¸æœº</span>');
            }
            
            // æ£€æŸ¥ç”¨æˆ·ä»£ç†
            results.push(`<br><strong>æµè§ˆå™¨ä¿¡æ¯:</strong> ${navigator.userAgent}`);
            
            updateResult(results.join('<br>'));
        }

        async function checkPermissions() {
            updateResult('æ­£åœ¨æ£€æŸ¥æƒé™...');
            
            try {
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({ name: 'camera' });
                    let status = '';
                    
                    switch (permission.state) {
                        case 'granted':
                            status = '<span class="status-ok">âœ… ç›¸æœºæƒé™å·²æˆäºˆ</span>';
                            break;
                        case 'denied':
                            status = '<span class="status-error">âŒ ç›¸æœºæƒé™è¢«æ‹’ç»</span>';
                            break;
                        case 'prompt':
                            status = '<span class="status-warning">âš ï¸ ç›¸æœºæƒé™éœ€è¦ç”¨æˆ·æˆæƒ</span>';
                            break;
                        default:
                            status = `<span class="status-warning">âš ï¸ æƒé™çŠ¶æ€: ${permission.state}</span>`;
                    }
                    
                    updateResult(status);
                } else {
                    updateResult('<span class="status-warning">âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢API</span>');
                }
            } catch (error) {
                updateResult(`<span class="status-error">âŒ æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}</span>`);
            }
        }

        async function testCamera() {
            const btn = document.getElementById('testCameraBtn');
            const video = document.getElementById('testVideo');
            
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            updateResult('æ­£åœ¨æµ‹è¯•ç›¸æœº...');
            
            try {
                // åœæ­¢ä¹‹å‰çš„æµ
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // è¯·æ±‚ç›¸æœºæƒé™å’Œæµ
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // æ˜¾ç¤ºè§†é¢‘
                video.srcObject = stream;
                video.style.display = 'block';
                currentStream = stream;
                
                // è·å–è§†é¢‘è½¨é“ä¿¡æ¯
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();
                
                updateResult(`
                    <span class="status-ok">âœ… ç›¸æœºæµ‹è¯•æˆåŠŸï¼</span><br>
                    <strong>è§†é¢‘è®¾å¤‡:</strong> ${videoTrack.label || 'æœªçŸ¥è®¾å¤‡'}<br>
                    <strong>åˆ†è¾¨ç‡:</strong> ${settings.width}x${settings.height}<br>
                    <strong>å¸§ç‡:</strong> ${settings.frameRate}fps<br>
                    <strong>æœå‘:</strong> ${settings.facingMode || 'æœªçŸ¥'}<br>
                    <br>
                    <button class="test-btn" onclick="stopCamera()">ğŸ›‘ åœæ­¢ç›¸æœº</button>
                    <button class="test-btn" onclick="captureTest()">ğŸ“¸ æ‹ç…§æµ‹è¯•</button>
                `);
                
            } catch (error) {
                let errorMsg = '';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'ç›¸æœºæƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸ç›¸æœºè®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'æœªæ‰¾åˆ°ç›¸æœºè®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = 'ç›¸æœºè¢«å…¶ä»–ç¨‹åºå ç”¨';
                } else {
                    errorMsg = error.message;
                }
                
                updateResult(`<span class="status-error">âŒ ç›¸æœºæµ‹è¯•å¤±è´¥: ${errorMsg}</span>`);
                video.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“· æµ‹è¯•ç›¸æœº';
            }
        }

        function stopCamera() {
            const video = document.getElementById('testVideo');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            video.srcObject = null;
            video.style.display = 'none';
            
            updateResult('<span class="status-ok">âœ… ç›¸æœºå·²åœæ­¢</span>');
        }

        function captureTest() {
            const video = document.getElementById('testVideo');
            
            if (!video.videoWidth || !video.videoHeight) {
                updateResult('<span class="status-error">âŒ è§†é¢‘å°šæœªå°±ç»ª</span>');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob((blob) => {
                if (blob) {
                    const size = (blob.size / 1024).toFixed(1);
                    updateResult(`
                        <span class="status-ok">âœ… æ‹ç…§æµ‹è¯•æˆåŠŸï¼</span><br>
                        <strong>å›¾ç‰‡å¤§å°:</strong> ${size} KB<br>
                        <strong>åˆ†è¾¨ç‡:</strong> ${canvas.width}x${canvas.height}<br>
                        <img src="${canvas.toDataURL()}" style="max-width: 200px; border-radius: 8px; margin-top: 10px;">
                    `);
                } else {
                    updateResult('<span class="status-error">âŒ æ‹ç…§å¤±è´¥</span>');
                }
            }, 'image/jpeg', 0.9);
        }

        async function listDevices() {
            updateResult('æ­£åœ¨è·å–è®¾å¤‡åˆ—è¡¨...');
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                let result = `<strong>å‘ç° ${videoDevices.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡:</strong><br>`;
                
                if (videoDevices.length > 0) {
                    videoDevices.forEach((device, index) => {
                        result += `${index + 1}. ${device.label || `æ‘„åƒå¤´ ${index + 1}`} (ID: ${device.deviceId.substring(0, 8)}...)<br>`;
                    });
                } else {
                    result += 'âŒ æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡<br>';
                }
                
                result += `<br><strong>å‘ç° ${audioDevices.length} ä¸ªéŸ³é¢‘è¾“å…¥è®¾å¤‡</strong>`;
                
                updateResult(result);
            } catch (error) {
                updateResult(`<span class="status-error">âŒ æ— æ³•è·å–è®¾å¤‡åˆ—è¡¨: ${error.message}</span>`);
            }
        }

        // é¡µé¢å¸è½½æ—¶åœæ­¢ç›¸æœº
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        // è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.addEventListener('load', () => {
            setTimeout(checkEnvironment, 500);
        });
    </script>
</body>
</html>