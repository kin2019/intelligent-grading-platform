<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>ZYJCÊô∫ËÉΩÊâπÊîπ - Â≠¶ÁîüÈ¶ñÈ°µ</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .navbar {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        
        .navbar-content {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* È°µÈù¢ÂÜÖÂÆπ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 80px);
            margin-bottom: 80px;
        }
        
        /* ÈÄöÁî®Âç°ÁâáÊ†∑Âºè */
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        /* Áî®Êà∑‰ø°ÊÅØÂç°Áâá */
        .user-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 25px;
            object-fit: cover;
        }
        
        .info .name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .info .role {
            font-size: 12px;
            color: #666;
        }
        
        .quota-info {
            text-align: right;
        }
        
        .quota-info .quota-text {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .quota-info .quota-count {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
        }
        
        /* ÂäüËÉΩÁΩëÊ†º */
        .function-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        /* Êô∫ËÉΩÂá∫È¢òÂäüËÉΩÂç°ÁâáÁâπÊÆäÊ†∑Âºè */
        .function-item.ai-exercise {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%);
            border: 2px solid rgba(76, 175, 80, 0.2);
        }
        
        .function-item.ai-exercise:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.2) 100%);
            border-color: rgba(76, 175, 80, 0.4);
            box-shadow: 0 16px 48px rgba(76, 175, 80, 0.3);
        }
        
        .function-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .function-item:hover {
            background: #e9ecef;
        }
        
        .function-icon {
            font-size: 36px;
            margin-bottom: 16px;
            display: block;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .function-text {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            position: relative;
            z-index: 1;
            letter-spacing: 0.3px;
        }
        
        /* Êï∞ÊçÆÁªüËÆ° */
        .stats-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .stat-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* ÊúÄËøë‰Ωú‰∏ö */
        .homework-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .homework-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .homework-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f5f7ff 100%);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .homework-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 2px 2px 0;
        }
        
        .homework-item:hover {
            background: linear-gradient(135deg, #f0f2ff 0%, #e8ecff 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .homework-item:active {
            transform: translateY(0);
        }
        
        .homework-info {
            flex: 1;
            margin-left: 8px;
        }
        
        .homework-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .homework-title::before {
            content: 'üìÑ';
            margin-right: 8px;
            font-size: 16px;
        }
        
        .homework-meta {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .homework-subject {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .homework-stats {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .homework-score {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            min-width: 50px;
            text-align: center;
        }
        
        .homework-accuracy {
            font-size: 12px;
            color: #666;
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .homework-status {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .homework-status.completed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        
        .homework-status.pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }
        
        /* Á©∫Áä∂ÊÄÅÁæéÂåñ */
        .homework-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .homework-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .homework-empty-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Âä†ËΩΩÁä∂ÊÄÅÁæéÂåñ */
        .homework-loading {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
        }
        
        .homework-loading-icon {
            font-size: 24px;
            margin-bottom: 12px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ÈîôËØØÁä∂ÊÄÅ */
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .retry-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }
        
        
        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 20px 16px 100px;
                margin-top: -12px;
                border-radius: 20px 20px 0 0;
            }
            
            .user-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .navbar-title {
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .stats-section,
            .homework-section {
                padding: 20px;
                margin-bottom: 24px;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .function-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            }
            
            .function-item {
                padding: 24px 16px;
                border-radius: 18px;
            }
            
            .function-icon {
                font-size: 32px;
                margin-bottom: 12px;
            }
            
            .function-text {
                font-size: 14px;
            }
            
            .stat-number {
                font-size: 24px;
            }
            
            .stat-item {
                padding: 12px 8px;
            }
            
            /* ‰Ωú‰∏öÊ®°ÂùóÁßªÂä®Á´ØÈÄÇÈÖç */
            .homework-item {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                border-radius: 14px;
            }
            
            .homework-info {
                margin-left: 4px;
                width: 100%;
            }
            
            .homework-title {
                font-size: 14px;
            }
            
            .homework-meta {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .homework-stats {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
            }
            
            .homework-score {
                font-size: 14px;
                padding: 4px 8px;
                min-width: 40px;
            }
            
            .homework-accuracy {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .homework-status {
                font-size: 9px;
                padding: 3px 8px;
            }
            
        }
        
        /* ‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏ÄÂ≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂ÔºåÊó†ÈúÄÈ¢ùÂ§ñÊ†∑ÂºèÂÆö‰πâ */
    </style>
    
    <!-- Â≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂ -->
    <link rel="stylesheet" href="/frontend/css/student-bottom-nav.css">
    <script src="/frontend/js/student-bottom-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
        <div class="navbar">
            <div class="navbar-content">
                <div style="flex: 1;"></div>
                <div class="navbar-title" style="flex: 1; text-align: center;">Êô∫ËÉΩÊâπÊîπ</div>
                <div style="flex: 1; display: flex; justify-content: flex-end;">
                    <div class="user-avatar" onclick="goToProfile()">üë§</div>
                </div>
            </div>
        </div>
        
        <!-- È°µÈù¢ÂÜÖÂÆπ -->
        <div class="page-content">
            <!-- Áî®Êà∑‰ø°ÊÅØÂç°Áâá -->
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="mainAvatar">üéì</div>
                    <div class="info">
                        <div class="name" id="userName">Ê≠£Âú®Âä†ËΩΩ...</div>
                        <div class="role">Â≠¶Áîü</div>
                    </div>
                </div>
                <div class="quota-info">
                    <div class="quota-text">‰ªäÊó•È¢ùÂ∫¶</div>
                    <div class="quota-count" id="quotaCount">-/-</div>
                </div>
            </div>
            
            <!-- ÂäüËÉΩÂÖ•Âè£ -->
            <div class="card">
                <div class="section-title">Â≠¶‰π†Â∑•ÂÖ∑</div>
                <div class="function-grid">
                    <div class="function-item" onclick="goToHomeworkSubmit()">
                        <div class="function-icon">üì∑</div>
                        <div class="function-text">ÊãçÁÖßÊâπÊîπ</div>
                    </div>
                    
                    <div class="function-item" onclick="goToErrorBook()">
                        <div class="function-icon">üìö</div>
                        <div class="function-text">ÈîôÈ¢òÊú¨</div>
                    </div>
                    
                    <div class="function-item" onclick="goToStudyPlan()">
                        <div class="function-icon">üìã</div>
                        <div class="function-text">Â≠¶‰π†ËÆ°Âàí</div>
                    </div>
                    
                    <div class="function-item ai-exercise" onclick="goToExerciseConfig()">
                        <div class="function-icon">‚ú®</div>
                        <div class="function-text">Êô∫ËÉΩÂá∫È¢ò</div>
                    </div>
                    
                    <div class="function-item" onclick="goToBatchExercise()">
                        <div class="function-icon">üì¶</div>
                        <div class="function-text">ÊâπÈáèÂá∫È¢ò</div>
                    </div>
                    
                    <div class="function-item" onclick="goToRecommendations()">
                        <div class="function-icon">üéØ</div>
                        <div class="function-text">‰∏™ÊÄßÊé®Ëçê</div>
                    </div>
                </div>
            </div>
            
            <!-- Â≠¶‰π†Êï∞ÊçÆÁªüËÆ° -->
            <div class="stats-section" id="statsSection">
                <div class="section-title">‰ªäÊó•Â≠¶‰π†</div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</div>
                </div>
            </div>
            
            <!-- ÊúÄËøë‰Ωú‰∏ö -->
            <div class="homework-section" id="homeworkSection">
                <div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ê≠£Âú®Âä†ËΩΩ‰Ωú‰∏ö...</div>
                </div>
            </div>
        </div>

    <!-- ÂÖ®Â±ÄÂ∫ïÈÉ®ÂØºËà™ -->
    <!-- Â∫ïÈÉ®ÂØºËà™Â∞ÜÈÄöËøáÁªü‰∏ÄÁªÑ‰ª∂Ëá™Âä®ÁîüÊàê -->
    </div>

    <script src="/frontend/js/auth-utils.js"></script>
    <script>
        let API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        
        // ÂàùÂßãÂåñËÆ§ËØÅ‰ø°ÊÅØ
        function initAuth() {
            console.log('=== student-home.html ÂàùÂßãÂåñËÆ§ËØÅ‰ø°ÊÅØ ===');
            
            // Á°Æ‰øùÁî®Êà∑ËßíËâ≤Ê≠£Á°ÆËÆæÁΩÆ
            let role = AuthUtils.getCurrentUserRole();
            if (!role || role !== 'student') {
                console.log('ËÆæÁΩÆÂ≠¶ÁîüËßíËâ≤');
                AuthUtils.setUserRole('student');
                role = 'student';
            }
            
            // Ëé∑ÂèñtokenÂíåAPIË∑ØÂæÑ
            token = AuthUtils.getCurrentToken();
            API_BASE = AuthUtils.getAPIBase();
            
            console.log('ÂΩìÂâçËßíËâ≤:', role);
            console.log('Token:', token ? token.substring(0, 20) + '...' : 'None');
            console.log('API Base:', API_BASE);
            
            return { role, token, API_BASE };
        }

        // ÂêåÊ≠•È°µÈù¢ÂàùÂßãÂåñ - ÂÖàÊòæÁ§∫ÂÜÖÂÆπÔºåÂÜçÂä†ËΩΩÊï∞ÊçÆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ È°µÈù¢ÂºÄÂßãÂä†ËΩΩ');
            initPageSync();
        });
        
        function initPageSync() {
            console.log('üìã ÂêåÊ≠•ÂàùÂßãÂåñÈ°µÈù¢');
            
            // ËÆæÁΩÆËÆ§ËØÅ‰ø°ÊÅØ
            AuthUtils.setUserRole('student');
            token = AuthUtils.getCurrentToken();
            API_BASE = 'http://localhost:8000/api/v1';
            
            console.log('Token:', token ? 'OK' : 'NONE');
            
            // Á´ãÂç≥ÂàùÂßãÂåñÂ≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂
            initStudentBottomNavigation();
            
            // Á´ãÂç≥ÊòæÁ§∫ÈªòËÆ§ÂÜÖÂÆπ
            showDefaultContent();
            
            if (!token) {
                console.log('Ê≤°ÊúâTokenÔºåÊòæÁ§∫ÁôªÂΩïÊèêÁ§∫');
                setTimeout(() => {
                    window.location.href = '/frontend/login.html';
                }, 3000);
                return;
            }
            
            // ÂºÇÊ≠•Âä†ËΩΩÁúüÂÆûÊï∞ÊçÆÔºà‰∏çÈòªÂ°ûÈ°µÈù¢ÊòæÁ§∫Ôºâ
            setTimeout(loadAllDataAsync, 100);
        }
        
        function showDefaultContent() {
            console.log('üìÑ ÊòæÁ§∫ÈªòËÆ§ÂÜÖÂÆπ');
            
            // ËÆæÁΩÆÈªòËÆ§Áî®Êà∑‰ø°ÊÅØ
            document.getElementById('userName').textContent = 'Â≠¶ÁîüÁî®Êà∑';
            document.getElementById('quotaCount').textContent = '0/5';
            
            // ËÆæÁΩÆÈªòËÆ§ÁªüËÆ°Êï∞ÊçÆ
            const statsSection = document.getElementById('statsSection');
            statsSection.innerHTML = `
                <div class="section-title">‰ªäÊó•Â≠¶‰π†</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Â∑≤ÊâπÊîπ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">ÈîôÈ¢òÊï∞</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0%</div>
                        <div class="stat-label">Ê≠£Á°ÆÁéá</div>
                    </div>
                </div>
            `;
            
            // ËÆæÁΩÆÈªòËÆ§‰Ωú‰∏öÂàóË°®
            const homeworkSection = document.getElementById('homeworkSection');
            homeworkSection.innerHTML = `
                <div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div>
                <div class="homework-loading">
                    <div class="homework-loading-icon">üìö</div>
                    <div>Ê≠£Âú®Âä†ËΩΩ‰Ωú‰∏öÊï∞ÊçÆ...</div>
                </div>
            `;
        }
        
        function loadAllDataAsync() {
            console.log('üìä ÂºÇÊ≠•Âä†ËΩΩÊï∞ÊçÆ');
            
            // Áõ¥Êé•Ë∞ÉÁî®Ôºå‰∏çÈúÄË¶ÅcatchÔºåÂõ†‰∏∫ÊØè‰∏™ÂáΩÊï∞ÂÜÖÈÉ®Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÈîôËØØ
            loadUserInfo();
            loadQuotaInfo();
            loadDashboardInfo();
        }
        
        function loadUserInfo() {
            console.log('üë§ Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ');
            fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Áî®Êà∑‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•');
            }).then(userData => {
                console.log('‚úÖ Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩÊàêÂäü');
                updateUserInfo(userData);
            }).catch(error => {
                console.warn('‚ö†Ô∏è Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•:', error);
            });
        }
        
        function loadQuotaInfo() {
            console.log('üí∞ Âä†ËΩΩÈÖçÈ¢ù‰ø°ÊÅØ');
            fetch(`${API_BASE}/auth/quota`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('ÈÖçÈ¢ù‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•');
            }).then(quotaData => {
                console.log('‚úÖ ÈÖçÈ¢ù‰ø°ÊÅØÂä†ËΩΩÊàêÂäü');
                document.getElementById('quotaCount').textContent = 
                    `${quotaData.daily_used || 0}/${quotaData.daily_quota || 5}`;
            }).catch(error => {
                console.warn('‚ö†Ô∏è ÈÖçÈ¢ù‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•:', error);
            });
        }
        
        function loadDashboardInfo() {
            console.log('üìä Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆ');
            fetch(`${API_BASE}/student/dashboard`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('‰ª™Ë°®ÊùøÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
            }).then(dashData => {
                console.log('‚úÖ ‰ª™Ë°®ÊùøÊï∞ÊçÆÂä†ËΩΩÊàêÂäü');
                updateDashboard(dashData);
            }).catch(error => {
                console.warn('‚ö†Ô∏è ‰ª™Ë°®ÊùøÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫Ôºå‰∏çÂÅö‰ªª‰ΩïÊõ¥Êîπ
            });
        }
        
        function showDefaultDashboard() {
            // ÊòæÁ§∫ÈªòËÆ§ÁªüËÆ°Êï∞ÊçÆ
            const statsSection = document.getElementById('statsSection');
            statsSection.innerHTML = `
                <div class="section-title">‰ªäÊó•Â≠¶‰π†</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Â∑≤ÊâπÊîπ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">ÈîôÈ¢òÊï∞</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0%</div>
                        <div class="stat-label">Ê≠£Á°ÆÁéá</div>
                    </div>
                </div>
            `;
            
            // ÊòæÁ§∫ÈªòËÆ§‰Ωú‰∏öÂàóË°®
            const homeworkSection = document.getElementById('homeworkSection');
            homeworkSection.innerHTML = `
                <div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div>
                <div class="homework-empty">
                    <div class="homework-empty-icon">üìù</div>
                    <div class="homework-empty-text">
                        ËøòÊ≤°Êúâ‰Ωú‰∏öËÆ∞ÂΩï<br>
                        Âø´ÂéªÊèê‰∫§‰Ω†ÁöÑÁ¨¨‰∏Ä‰ªΩ‰Ωú‰∏öÂêßÔºÅ
                    </div>
                </div>
            `;
        }
        
        function updateDashboardSimple(data) {
            console.log('üìà Êõ¥Êñ∞‰ª™Ë°®ÊùøÊòæÁ§∫...');
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            const statsSection = document.getElementById('statsSection');
            if (statsSection && data.daily_stats) {
                const stats = data.daily_stats;
                statsSection.innerHTML = `
                    <div class="section-title">‰ªäÊó•Â≠¶‰π†</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_corrections || 0}</div>
                            <div class="stat-label">Â∑≤ÊâπÊîπ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_errors || 0}</div>
                            <div class="stat-label">ÈîôÈ¢òÊï∞</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Math.round(stats.accuracy_rate || 0)}%</div>
                            <div class="stat-label">Ê≠£Á°ÆÁéá</div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ ÁªüËÆ°Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞');
            }
            
            // Êõ¥Êñ∞‰Ωú‰∏öÂàóË°®
            const homeworkSection = document.getElementById('homeworkSection');
            if (homeworkSection && data.recent_homework) {
                let homeworkHtml = '<div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div>';
                
                if (data.recent_homework.length > 0) {
                    data.recent_homework.slice(0, 5).forEach(hw => {
                        homeworkHtml += `
                            <div class="homework-item">
                                <div class="homework-info">
                                    <div class="homework-title">${hw.title}</div>
                                    <div class="homework-meta">${hw.subject} ¬∑ Ê≠£Á°ÆÁéá ${Math.round(hw.accuracy_rate)}%</div>
                                </div>
                                <div class="homework-score">${hw.correct_count}/${hw.total_questions}</div>
                            </div>
                        `;
                    });
                } else {
                    homeworkHtml += '<div class="empty-state">ÊöÇÊó†‰Ωú‰∏öËÆ∞ÂΩï</div>';
                }
                
                homeworkSection.innerHTML = homeworkHtml;
                console.log('‚úÖ ‰Ωú‰∏öÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞');
            }
        }

        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Ê£ÄÊü•Áî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('È°µÈù¢Âèò‰∏∫ÂèØËßÅ');
                setTimeout(onPageFocus, 200); // Âª∂Êó∂200msÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®ÊøÄÊ¥ª
            }
        });

        // È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπÊó∂Ê£ÄÊü•Áî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞
        window.addEventListener('focus', function() {
            console.log('È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπ');
            setTimeout(onPageFocus, 200); // Âª∂Êó∂200msÁ°Æ‰øùÁÑ¶ÁÇπÂÆåÂÖ®Ëé∑Âæó
        });

        // ÁõëÂê¨localStorageÂèòÂåñ
        window.addEventListener('storage', function(event) {
            if (event.key === 'user' && event.newValue) {
                console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠user‰ø°ÊÅØÂèòÂåñ');
                const newUserInfo = JSON.parse(event.newValue);
                userInfo = newUserInfo;
                updateUserInfo(newUserInfo);
            }
        });

        // ÁõëÂê¨Áî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞‰∫ã‰ª∂
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('Ê£ÄÊµãÂà∞Áî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞‰∫ã‰ª∂');
            userInfo = event.detail;
            updateUserInfo(event.detail);
        });

        // Ê£ÄÊü•localStorage‰∏≠ÁöÑÁî®Êà∑‰ø°ÊÅØÊòØÂê¶Êõ¥Êñ∞
        function checkStoredUserInfo() {
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    const newUserInfo = JSON.parse(storedUser);
                    // Ê£ÄÊü•Â§¥ÂÉèÊòØÂê¶ÂèëÁîüÂèòÂåñ
                    if (!userInfo || 
                        userInfo.avatar_url !== newUserInfo.avatar_url ||
                        userInfo.nickname !== newUserInfo.nickname) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÁî®Êà∑‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞ÔºåÂêåÊ≠•Âà∞ÂΩìÂâçÈ°µÈù¢');
                        console.log('ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ:', userInfo);
                        console.log('ÊúÄÊñ∞Áî®Êà∑‰ø°ÊÅØ:', newUserInfo);
                        userInfo = newUserInfo;
                        updateUserInfo(newUserInfo);
                        return true;
                    }
                } catch (error) {
                    console.error('Ëß£ÊûêlocalStorageÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
            }
            return false;
        }

        // È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπÊó∂ÂÖàÊ£ÄÊü•localStorageÔºåÂ¶ÇÊûúÊ≤°ÊúâÂèòÂåñÂÜçË∞ÉÁî®API
        function onPageFocus() {
            console.log('È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπÔºåÊ£ÄÊü•Áî®Êà∑‰ø°ÊÅØ');
            const hasLocalChanges = checkStoredUserInfo();
            if (!hasLocalChanges) {
                console.log('localStorageÊó†ÂèòÂåñÔºåÈáçÊñ∞‰ªéAPIËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ');
                setTimeout(() => {
                    loadUserInfo();
                }, 200);
            }
        }


        

        function updateUserInfo(user) {
            document.getElementById('userName').textContent = user.nickname || 'Â≠¶ÁîüÁî®Êà∑';
            
            // Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫ - ÂêåÊó∂Êõ¥Êñ∞ÂØºËà™Ê†èÂíå‰∏ªÂÜÖÂÆπÂå∫ÁöÑÂ§¥ÂÉè
            const userAvatar = document.querySelector('.user-avatar');
            const mainAvatar = document.getElementById('mainAvatar');
            
            function updateAvatarDisplay(avatarElement, user) {
                if (!avatarElement) return;
                
                if (user.avatar_url) {
                    if (user.avatar_url.startsWith('emoji:')) {
                        // Ë°®ÊÉÖÂ§¥ÂÉè
                        const emoji = user.avatar_url.replace('emoji:', '');
                        avatarElement.innerHTML = emoji;
                    } else if (user.avatar_url.startsWith('http') || user.avatar_url.startsWith('/uploads/')) {
                        // ÂõæÁâáÂ§¥ÂÉè (ÊîØÊåÅÁªùÂØπURLÂíåÁõ∏ÂØπË∑ØÂæÑ)
                        let imageUrl = user.avatar_url;
                        if (user.avatar_url.startsWith('/')) {
                            // Áõ∏ÂØπË∑ØÂæÑÔºåÈúÄË¶ÅÂä†‰∏äAPIÊúçÂä°Âô®Âú∞ÂùÄ
                            imageUrl = `http://localhost:8000${user.avatar_url}`;
                        }
                        // Ê∑ªÂä†Êó∂Èó¥Êà≥Âº∫Âà∂Âà∑Êñ∞ÂõæÁâáÁºìÂ≠ò
                        const separator = imageUrl.includes('?') ? '&' : '?';
                        const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                        avatarElement.innerHTML = `<img src="${timestampUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Áî®Êà∑Â§¥ÂÉè" onerror="this.parentElement.innerHTML='üë§'">`;
                    } else {
                        // ÈªòËÆ§Â§¥ÂÉè
                        avatarElement.innerHTML = 'üë§';
                    }
                } else {
                    // Ê≤°ÊúâÂ§¥ÂÉèÊó∂ÊòæÁ§∫ÈªòËÆ§Â§¥ÂÉè
                    avatarElement.innerHTML = 'üë§';
                }
            }
            
            // Êõ¥Êñ∞‰∏§‰∏™Â§¥ÂÉèÂÖÉÁ¥†
            updateAvatarDisplay(userAvatar, user);
            updateAvatarDisplay(mainAvatar, user);
        }

        function updateQuotaInfo(quota) {
            const quotaCount = document.getElementById('quotaCount');
            quotaCount.textContent = `${quota.daily_used || 0}/${quota.daily_quota || 5}`;
        }

        function updateDashboard(data) {
            console.log('üìà Êõ¥Êñ∞‰ª™Ë°®Êùø');
            
            // Êõ¥Êñ∞Â≠¶‰π†ÁªüËÆ°
            const statsSection = document.getElementById('statsSection');
            if (data.daily_stats) {
                const stats = data.daily_stats;
                statsSection.innerHTML = `
                    <div class="section-title">‰ªäÊó•Â≠¶‰π†</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_corrections || 0}</div>
                            <div class="stat-label">Â∑≤ÊâπÊîπ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_errors || 0}</div>
                            <div class="stat-label">ÈîôÈ¢òÊï∞</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Math.round(stats.accuracy_rate || 0)}%</div>
                            <div class="stat-label">Ê≠£Á°ÆÁéá</div>
                        </div>
                    </div>
                `;
            }
            
            // Êõ¥Êñ∞‰Ωú‰∏öÂàóË°®
            const homeworkSection = document.getElementById('homeworkSection');
            if (data.recent_homework && data.recent_homework.length > 0) {
                let homeworkHtml = '<div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div><div class="homework-list">';
                data.recent_homework.slice(0, 3).forEach(hw => {
                    const accuracy = Math.round(hw.accuracy_rate || 0);
                    const subject = hw.subject || 'Êú™Áü•ÁßëÁõÆ';
                    homeworkHtml += `
                        <div class="homework-item">
                            <div class="homework-info">
                                <div class="homework-title">${hw.title || 'Êï∞Â≠¶‰Ωú‰∏ö'}</div>
                                <div class="homework-meta">
                                    <span class="homework-subject">${subject}</span>
                                    <span>¬∑</span>
                                    <span>${hw.total_questions || 0}È¢ò</span>
                                </div>
                            </div>
                            <div class="homework-stats">
                                <div class="homework-score">${hw.correct_count || 0}/${hw.total_questions || 0}</div>
                                <div class="homework-accuracy">Ê≠£Á°ÆÁéá ${accuracy}%</div>
                                <div class="homework-status completed">Â∑≤ÂÆåÊàê</div>
                            </div>
                        </div>
                    `;
                });
                homeworkHtml += '</div>';
                homeworkSection.innerHTML = homeworkHtml;
            } else {
                homeworkSection.innerHTML = `
                    <div class="section-title">ÊúÄËøë‰Ωú‰∏ö</div>
                    <div class="homework-empty">
                        <div class="homework-empty-icon">üìù</div>
                        <div class="homework-empty-text">
                            ËøòÊ≤°Êúâ‰Ωú‰∏öËÆ∞ÂΩï<br>
                            Âø´ÂéªÊèê‰∫§‰Ω†ÁöÑÁ¨¨‰∏Ä‰ªΩ‰Ωú‰∏öÂêßÔºÅ
                        </div>
                    </div>
                `;
            }
        }

        function showError(sectionId, message, retryCallback) {
            const section = document.getElementById(sectionId);
            section.innerHTML = `
                <div class="error">
                    <div class="error-icon">üòû</div>
                    <div>${message}</div>
                    <button class="retry-btn" onclick="retryCallback()">ÈáçËØï</button>
                </div>
            `;
        }

        // ÂØºËà™ÂáΩÊï∞
        function goToProfile() {
            window.location.href = '/frontend/profile.html';
        }

        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function goToExerciseConfig() {
            // Ë∑≥ËΩ¨Âà∞Êô∫ËÉΩÂá∫È¢òÈÖçÁΩÆÈ°µÈù¢
            window.location.href = '/frontend/exercise-config.html';
        }

        function goToBatchExercise() {
            // Ë∑≥ËΩ¨Âà∞ÊâπÈáèÂá∫È¢òÈÖçÁΩÆÈ°µÈù¢
            window.location.href = '/frontend/batch-exercise-config.html';
        }

        function goToRecommendations() {
            // Ë∑≥ËΩ¨Âà∞‰∏™ÊÄßÂåñÊé®ËçêÈ°µÈù¢
            window.location.href = '/frontend/personalized-recommendations.html';
        }

        function goToHomeworkDetail(id) {
            window.location.href = `/frontend/homework-result.html?id=${id}`;
        }

        function showToast(message) {
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }

        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
        function checkConnection() {
            return navigator.onLine;
        }

        // Â§ÑÁêÜÁΩëÁªúÈîôËØØ
        window.addEventListener('offline', function() {
            showToast('ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄ');
        });

        window.addEventListener('online', function() {
            showToast('ÁΩëÁªúËøûÊé•Â∑≤ÊÅ¢Â§ç');
            loadAllDataAsync();
        });

        // ÂàùÂßãÂåñÂ≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂
        function initStudentBottomNavigation() {
            console.log('ÂàùÂßãÂåñÂ≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂...');
            
            // ‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏ÄÂ≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂
            const success = StudentBottomNav.init({
                currentPage: 'home',  // student-home.htmlÂØπÂ∫îÁöÑÊòØhomeÈ°µÈù¢ID
                debug: false
            });
            
            if (success) {
                console.log('‚úÖ Â≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂ÂàùÂßãÂåñÊàêÂäü');
            } else {
                console.error('‚ùå Â≠¶ÁîüÂ∫ïÈÉ®ÂØºËà™ÁªÑ‰ª∂ÂàùÂßãÂåñÂ§±Ë¥•');
            }
        }
        
        // Â∫ïÈÉ®ÂØºËà™Â∑≤Âú®initPageSync‰∏≠Ë∞ÉÁî®ÔºåÊó†ÈúÄÂçïÁã¨ÁõëÂê¨Âô®
        
        // È°µÈù¢ÂàùÂßãÂåñÔºàÂ∑≤Âú®‰∏äÈù¢ÂÆö‰πâÔºåËøôÈáå‰∏çÈáçÂ§çÔºâ
    </script>
</body>
</html>