<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - å­¦ç”Ÿé¦–é¡µ</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        
        .navbar-content {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 80px);
            margin-bottom: 80px;
        }
        
        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 25px;
            object-fit: cover;
        }
        
        .info .name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .info .role {
            font-size: 12px;
            color: #666;
        }
        
        .quota-info {
            text-align: right;
        }
        
        .quota-info .quota-text {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .quota-info .quota-count {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
        }
        
        /* åŠŸèƒ½ç½‘æ ¼ */
        .function-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        /* æ™ºèƒ½å‡ºé¢˜åŠŸèƒ½å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .function-item.ai-exercise {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%);
            border: 2px solid rgba(76, 175, 80, 0.2);
        }
        
        .function-item.ai-exercise:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.2) 100%);
            border-color: rgba(76, 175, 80, 0.4);
            box-shadow: 0 16px 48px rgba(76, 175, 80, 0.3);
        }
        
        .function-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .function-item:hover {
            background: #e9ecef;
        }
        
        .function-icon {
            font-size: 36px;
            margin-bottom: 16px;
            display: block;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .function-text {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            position: relative;
            z-index: 1;
            letter-spacing: 0.3px;
        }
        
        /* æ•°æ®ç»Ÿè®¡ */
        .stats-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .stat-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* æœ€è¿‘ä½œä¸š */
        .homework-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .homework-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .homework-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f5f7ff 100%);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .homework-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 2px 2px 0;
        }
        
        .homework-item:hover {
            background: linear-gradient(135deg, #f0f2ff 0%, #e8ecff 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .homework-item:active {
            transform: translateY(0);
        }
        
        .homework-info {
            flex: 1;
            margin-left: 8px;
        }
        
        .homework-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .homework-title::before {
            content: 'ğŸ“„';
            margin-right: 8px;
            font-size: 16px;
        }
        
        .homework-meta {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .homework-subject {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .homework-stats {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .homework-score {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            min-width: 50px;
            text-align: center;
        }
        
        .homework-accuracy {
            font-size: 12px;
            color: #666;
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .homework-status {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .homework-status.completed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        
        .homework-status.pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }
        
        /* ç©ºçŠ¶æ€ç¾åŒ– */
        .homework-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .homework-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .homework-empty-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* åŠ è½½çŠ¶æ€ç¾åŒ– */
        .homework-loading {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
        }
        
        .homework-loading-icon {
            font-size: 24px;
            margin-bottom: 12px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯çŠ¶æ€ */
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .retry-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }
        
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 20px 16px 100px;
                margin-top: -12px;
                border-radius: 20px 20px 0 0;
            }
            
            .user-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .navbar-title {
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .stats-section,
            .homework-section {
                padding: 20px;
                margin-bottom: 24px;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .function-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            }
            
            .function-item {
                padding: 24px 16px;
                border-radius: 18px;
            }
            
            .function-icon {
                font-size: 32px;
                margin-bottom: 12px;
            }
            
            .function-text {
                font-size: 14px;
            }
            
            .stat-number {
                font-size: 24px;
            }
            
            .stat-item {
                padding: 12px 8px;
            }
            
            /* ä½œä¸šæ¨¡å—ç§»åŠ¨ç«¯é€‚é… */
            .homework-item {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                border-radius: 14px;
            }
            
            .homework-info {
                margin-left: 4px;
                width: 100%;
            }
            
            .homework-title {
                font-size: 14px;
            }
            
            .homework-meta {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .homework-stats {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
            }
            
            .homework-score {
                font-size: 14px;
                padding: 4px 8px;
                min-width: 40px;
            }
            
            .homework-accuracy {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .homework-status {
                font-size: 9px;
                padding: 3px 8px;
            }
            
        }
        
        /* ä½¿ç”¨æ–°çš„ç»Ÿä¸€å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶ï¼Œæ— éœ€é¢å¤–æ ·å¼å®šä¹‰ */
    </style>
    
    <!-- å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶ -->
    <link rel="stylesheet" href="/frontend/css/student-bottom-nav.css">
    <script src="/frontend/js/student-bottom-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div style="flex: 1;"></div>
                <div class="navbar-title" style="flex: 1; text-align: center;">æ™ºèƒ½æ‰¹æ”¹</div>
                <div style="flex: 1; display: flex; justify-content: flex-end;">
                    <div class="user-avatar" onclick="goToProfile()">ğŸ‘¤</div>
                </div>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="mainAvatar">ğŸ“</div>
                    <div class="info">
                        <div class="name" id="userName">æ­£åœ¨åŠ è½½...</div>
                        <div class="role">å­¦ç”Ÿ</div>
                    </div>
                </div>
                <div class="quota-info">
                    <div class="quota-text">ä»Šæ—¥é¢åº¦</div>
                    <div class="quota-count" id="quotaCount">-/-</div>
                </div>
            </div>
            
            <!-- åŠŸèƒ½å…¥å£ -->
            <div class="card">
                <div class="section-title">å­¦ä¹ å·¥å…·</div>
                <div class="function-grid">
                    <div class="function-item" onclick="goToHomeworkSubmit()">
                        <div class="function-icon">ğŸ“·</div>
                        <div class="function-text">æ‹ç…§æ‰¹æ”¹</div>
                    </div>
                    
                    <div class="function-item" onclick="goToErrorBook()">
                        <div class="function-icon">ğŸ“š</div>
                        <div class="function-text">é”™é¢˜æœ¬</div>
                    </div>
                    
                    <div class="function-item" onclick="goToStudyPlan()">
                        <div class="function-icon">ğŸ“‹</div>
                        <div class="function-text">å­¦ä¹ è®¡åˆ’</div>
                    </div>
                    
                    <div class="function-item ai-exercise" onclick="goToExerciseConfig()">
                        <div class="function-icon">âœ¨</div>
                        <div class="function-text">æ™ºèƒ½å‡ºé¢˜</div>
                    </div>
                    
                    <div class="function-item" onclick="goToBatchExercise()">
                        <div class="function-icon">ğŸ“¦</div>
                        <div class="function-text">æ‰¹é‡å‡ºé¢˜</div>
                    </div>
                    
                    <div class="function-item" onclick="goToRecommendations()">
                        <div class="function-icon">ğŸ¯</div>
                        <div class="function-text">ä¸ªæ€§æ¨è</div>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ä¹ æ•°æ®ç»Ÿè®¡ -->
            <div class="stats-section" id="statsSection">
                <div class="section-title">ä»Šæ—¥å­¦ä¹ </div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
                </div>
            </div>
            
            <!-- æœ€è¿‘ä½œä¸š -->
            <div class="homework-section" id="homeworkSection">
                <div class="section-title">æœ€è¿‘ä½œä¸š</div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŠ è½½ä½œä¸š...</div>
                </div>
            </div>
        </div>

    <!-- å…¨å±€åº•éƒ¨å¯¼èˆª -->
    <!-- åº•éƒ¨å¯¼èˆªå°†é€šè¿‡ç»Ÿä¸€ç»„ä»¶è‡ªåŠ¨ç”Ÿæˆ -->
    </div>

    <script src="/frontend/js/auth-utils.js"></script>
    <script>
        let API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        
        // åˆå§‹åŒ–è®¤è¯ä¿¡æ¯
        function initAuth() {
            console.log('=== student-home.html åˆå§‹åŒ–è®¤è¯ä¿¡æ¯ ===');
            
            // ç¡®ä¿ç”¨æˆ·è§’è‰²æ­£ç¡®è®¾ç½®
            let role = AuthUtils.getCurrentUserRole();
            if (!role || role !== 'student') {
                console.log('è®¾ç½®å­¦ç”Ÿè§’è‰²');
                AuthUtils.setUserRole('student');
                role = 'student';
            }
            
            // è·å–tokenå’ŒAPIè·¯å¾„
            token = AuthUtils.getCurrentToken();
            API_BASE = AuthUtils.getAPIBase();
            
            console.log('å½“å‰è§’è‰²:', role);
            console.log('Token:', token ? token.substring(0, 20) + '...' : 'None');
            console.log('API Base:', API_BASE);
            
            return { role, token, API_BASE };
        }

        // åŒæ­¥é¡µé¢åˆå§‹åŒ– - å…ˆæ˜¾ç¤ºå†…å®¹ï¼Œå†åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢å¼€å§‹åŠ è½½');
            initPageSync();
        });
        
        function initPageSync() {
            console.log('ğŸ“‹ åŒæ­¥åˆå§‹åŒ–é¡µé¢');
            
            // è®¾ç½®è®¤è¯ä¿¡æ¯
            AuthUtils.setUserRole('student');
            token = AuthUtils.getCurrentToken();
            API_BASE = 'http://localhost:8000/api/v1';
            
            console.log('Token:', token ? 'OK' : 'NONE');
            
            // ç«‹å³åˆå§‹åŒ–å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶
            initStudentBottomNavigation();
            
            // ç«‹å³æ˜¾ç¤ºé»˜è®¤å†…å®¹
            showDefaultContent();
            
            if (!token) {
                console.log('æ²¡æœ‰Tokenï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                setTimeout(() => {
                    window.location.href = '/frontend/login.html';
                }, 3000);
                return;
            }
            
            // å¼‚æ­¥åŠ è½½çœŸå®æ•°æ®ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
            setTimeout(loadAllDataAsync, 100);
        }
        
        function showDefaultContent() {
            console.log('ğŸ“„ æ˜¾ç¤ºé»˜è®¤å†…å®¹');
            
            // è®¾ç½®é»˜è®¤ç”¨æˆ·ä¿¡æ¯
            document.getElementById('userName').textContent = 'å­¦ç”Ÿç”¨æˆ·';
            document.getElementById('quotaCount').textContent = '0/5';
            
            // è®¾ç½®é»˜è®¤ç»Ÿè®¡æ•°æ®
            const statsSection = document.getElementById('statsSection');
            statsSection.innerHTML = `
                <div class="section-title">ä»Šæ—¥å­¦ä¹ </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">å·²æ‰¹æ”¹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">é”™é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0%</div>
                        <div class="stat-label">æ­£ç¡®ç‡</div>
                    </div>
                </div>
            `;
            
            // è®¾ç½®é»˜è®¤ä½œä¸šåˆ—è¡¨
            const homeworkSection = document.getElementById('homeworkSection');
            homeworkSection.innerHTML = `
                <div class="section-title">æœ€è¿‘ä½œä¸š</div>
                <div class="homework-loading">
                    <div class="homework-loading-icon">ğŸ“š</div>
                    <div>æ­£åœ¨åŠ è½½ä½œä¸šæ•°æ®...</div>
                </div>
            `;
        }
        
        function loadAllDataAsync() {
            console.log('ğŸ“Š å¼‚æ­¥åŠ è½½æ•°æ®');
            
            // ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦catchï¼Œå› ä¸ºæ¯ä¸ªå‡½æ•°å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯
            loadUserInfo();
            loadQuotaInfo();
            loadDashboardInfo();
        }
        
        function loadUserInfo() {
            console.log('ğŸ‘¤ åŠ è½½ç”¨æˆ·ä¿¡æ¯');
            fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥');
            }).then(userData => {
                console.log('âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ');
                updateUserInfo(userData);
            }).catch(error => {
                console.warn('âš ï¸ ç”¨æˆ·ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
            });
        }
        
        function loadQuotaInfo() {
            console.log('ğŸ’° åŠ è½½é…é¢ä¿¡æ¯');
            fetch(`${API_BASE}/auth/quota`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('é…é¢ä¿¡æ¯è·å–å¤±è´¥');
            }).then(quotaData => {
                console.log('âœ… é…é¢ä¿¡æ¯åŠ è½½æˆåŠŸ');
                document.getElementById('quotaCount').textContent = 
                    `${quotaData.daily_used || 0}/${quotaData.daily_quota || 5}`;
            }).catch(error => {
                console.warn('âš ï¸ é…é¢ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
            });
        }
        
        function loadDashboardInfo() {
            console.log('ğŸ“Š åŠ è½½ä»ªè¡¨æ¿æ•°æ®');
            fetch(`${API_BASE}/student/dashboard`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('ä»ªè¡¨æ¿æ•°æ®è·å–å¤±è´¥');
            }).then(dashData => {
                console.log('âœ… ä»ªè¡¨æ¿æ•°æ®åŠ è½½æˆåŠŸ');
                updateDashboard(dashData);
            }).catch(error => {
                console.warn('âš ï¸ ä»ªè¡¨æ¿æ•°æ®åŠ è½½å¤±è´¥:', error);
                // ä¿æŒé»˜è®¤æ˜¾ç¤ºï¼Œä¸åšä»»ä½•æ›´æ”¹
            });
        }
        
        function showDefaultDashboard() {
            // æ˜¾ç¤ºé»˜è®¤ç»Ÿè®¡æ•°æ®
            const statsSection = document.getElementById('statsSection');
            statsSection.innerHTML = `
                <div class="section-title">ä»Šæ—¥å­¦ä¹ </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">å·²æ‰¹æ”¹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0</div>
                        <div class="stat-label">é”™é¢˜æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">0%</div>
                        <div class="stat-label">æ­£ç¡®ç‡</div>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºé»˜è®¤ä½œä¸šåˆ—è¡¨
            const homeworkSection = document.getElementById('homeworkSection');
            homeworkSection.innerHTML = `
                <div class="section-title">æœ€è¿‘ä½œä¸š</div>
                <div class="homework-empty">
                    <div class="homework-empty-icon">ğŸ“</div>
                    <div class="homework-empty-text">
                        è¿˜æ²¡æœ‰ä½œä¸šè®°å½•<br>
                        å¿«å»æäº¤ä½ çš„ç¬¬ä¸€ä»½ä½œä¸šå§ï¼
                    </div>
                </div>
            `;
        }
        
        function updateDashboardSimple(data) {
            console.log('ğŸ“ˆ æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤º...');
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const statsSection = document.getElementById('statsSection');
            if (statsSection && data.daily_stats) {
                const stats = data.daily_stats;
                statsSection.innerHTML = `
                    <div class="section-title">ä»Šæ—¥å­¦ä¹ </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_corrections || 0}</div>
                            <div class="stat-label">å·²æ‰¹æ”¹</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_errors || 0}</div>
                            <div class="stat-label">é”™é¢˜æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Math.round(stats.accuracy_rate || 0)}%</div>
                            <div class="stat-label">æ­£ç¡®ç‡</div>
                        </div>
                    </div>
                `;
                console.log('âœ… ç»Ÿè®¡æ•°æ®å·²æ›´æ–°');
            }
            
            // æ›´æ–°ä½œä¸šåˆ—è¡¨
            const homeworkSection = document.getElementById('homeworkSection');
            if (homeworkSection && data.recent_homework) {
                let homeworkHtml = '<div class="section-title">æœ€è¿‘ä½œä¸š</div>';
                
                if (data.recent_homework.length > 0) {
                    data.recent_homework.slice(0, 5).forEach(hw => {
                        homeworkHtml += `
                            <div class="homework-item">
                                <div class="homework-info">
                                    <div class="homework-title">${hw.title}</div>
                                    <div class="homework-meta">${hw.subject} Â· æ­£ç¡®ç‡ ${Math.round(hw.accuracy_rate)}%</div>
                                </div>
                                <div class="homework-score">${hw.correct_count}/${hw.total_questions}</div>
                            </div>
                        `;
                    });
                } else {
                    homeworkHtml += '<div class="empty-state">æš‚æ— ä½œä¸šè®°å½•</div>';
                }
                
                homeworkSection.innerHTML = homeworkHtml;
                console.log('âœ… ä½œä¸šæ•°æ®å·²æ›´æ–°');
            }
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ›´æ–°
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('é¡µé¢å˜ä¸ºå¯è§');
                setTimeout(onPageFocus, 200); // å»¶æ—¶200msç¡®ä¿é¡µé¢å®Œå…¨æ¿€æ´»
            }
        });

        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ›´æ–°
        window.addEventListener('focus', function() {
            console.log('é¡µé¢è·å¾—ç„¦ç‚¹');
            setTimeout(onPageFocus, 200); // å»¶æ—¶200msç¡®ä¿ç„¦ç‚¹å®Œå…¨è·å¾—
        });

        // ç›‘å¬localStorageå˜åŒ–
        window.addEventListener('storage', function(event) {
            if (event.key === 'user' && event.newValue) {
                console.log('æ£€æµ‹åˆ°localStorageä¸­userä¿¡æ¯å˜åŒ–');
                const newUserInfo = JSON.parse(event.newValue);
                userInfo = newUserInfo;
                updateUserInfo(newUserInfo);
            }
        });

        // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('æ£€æµ‹åˆ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶');
            userInfo = event.detail;
            updateUserInfo(event.detail);
        });

        // æ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ›´æ–°
        function checkStoredUserInfo() {
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    const newUserInfo = JSON.parse(storedUser);
                    // æ£€æŸ¥å¤´åƒæ˜¯å¦å‘ç”Ÿå˜åŒ–
                    if (!userInfo || 
                        userInfo.avatar_url !== newUserInfo.avatar_url ||
                        userInfo.nickname !== newUserInfo.nickname) {
                        console.log('æ£€æµ‹åˆ°localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼ŒåŒæ­¥åˆ°å½“å‰é¡µé¢');
                        console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', userInfo);
                        console.log('æœ€æ–°ç”¨æˆ·ä¿¡æ¯:', newUserInfo);
                        userInfo = newUserInfo;
                        updateUserInfo(newUserInfo);
                        return true;
                    }
                } catch (error) {
                    console.error('è§£ælocalStorageç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
            }
            return false;
        }

        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶å…ˆæ£€æŸ¥localStorageï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–å†è°ƒç”¨API
        function onPageFocus() {
            console.log('é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯');
            const hasLocalChanges = checkStoredUserInfo();
            if (!hasLocalChanges) {
                console.log('localStorageæ— å˜åŒ–ï¼Œé‡æ–°ä»APIè·å–ç”¨æˆ·ä¿¡æ¯');
                setTimeout(() => {
                    loadUserInfo();
                }, 200);
            }
        }


        

        function updateUserInfo(user) {
            document.getElementById('userName').textContent = user.nickname || 'å­¦ç”Ÿç”¨æˆ·';
            
            // æ›´æ–°å¤´åƒæ˜¾ç¤º - åŒæ—¶æ›´æ–°å¯¼èˆªæ å’Œä¸»å†…å®¹åŒºçš„å¤´åƒ
            const userAvatar = document.querySelector('.user-avatar');
            const mainAvatar = document.getElementById('mainAvatar');
            
            function updateAvatarDisplay(avatarElement, user) {
                if (!avatarElement) return;
                
                if (user.avatar_url) {
                    if (user.avatar_url.startsWith('emoji:')) {
                        // è¡¨æƒ…å¤´åƒ
                        const emoji = user.avatar_url.replace('emoji:', '');
                        avatarElement.innerHTML = emoji;
                    } else if (user.avatar_url.startsWith('http') || user.avatar_url.startsWith('/uploads/')) {
                        // å›¾ç‰‡å¤´åƒ (æ”¯æŒç»å¯¹URLå’Œç›¸å¯¹è·¯å¾„)
                        let imageUrl = user.avatar_url;
                        if (user.avatar_url.startsWith('/')) {
                            // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠAPIæœåŠ¡å™¨åœ°å€
                            imageUrl = `http://localhost:8000${user.avatar_url}`;
                        }
                        // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°å›¾ç‰‡ç¼“å­˜
                        const separator = imageUrl.includes('?') ? '&' : '?';
                        const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                        avatarElement.innerHTML = `<img src="${timestampUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="ç”¨æˆ·å¤´åƒ" onerror="this.parentElement.innerHTML='ğŸ‘¤'">`;
                    } else {
                        // é»˜è®¤å¤´åƒ
                        avatarElement.innerHTML = 'ğŸ‘¤';
                    }
                } else {
                    // æ²¡æœ‰å¤´åƒæ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
                    avatarElement.innerHTML = 'ğŸ‘¤';
                }
            }
            
            // æ›´æ–°ä¸¤ä¸ªå¤´åƒå…ƒç´ 
            updateAvatarDisplay(userAvatar, user);
            updateAvatarDisplay(mainAvatar, user);
        }

        function updateQuotaInfo(quota) {
            const quotaCount = document.getElementById('quotaCount');
            quotaCount.textContent = `${quota.daily_used || 0}/${quota.daily_quota || 5}`;
        }

        function updateDashboard(data) {
            console.log('ğŸ“ˆ æ›´æ–°ä»ªè¡¨æ¿');
            
            // æ›´æ–°å­¦ä¹ ç»Ÿè®¡
            const statsSection = document.getElementById('statsSection');
            if (data.daily_stats) {
                const stats = data.daily_stats;
                statsSection.innerHTML = `
                    <div class="section-title">ä»Šæ—¥å­¦ä¹ </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_corrections || 0}</div>
                            <div class="stat-label">å·²æ‰¹æ”¹</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.today_errors || 0}</div>
                            <div class="stat-label">é”™é¢˜æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${Math.round(stats.accuracy_rate || 0)}%</div>
                            <div class="stat-label">æ­£ç¡®ç‡</div>
                        </div>
                    </div>
                `;
            }
            
            // æ›´æ–°ä½œä¸šåˆ—è¡¨
            const homeworkSection = document.getElementById('homeworkSection');
            if (data.recent_homework && data.recent_homework.length > 0) {
                let homeworkHtml = '<div class="section-title">æœ€è¿‘ä½œä¸š</div><div class="homework-list">';
                data.recent_homework.slice(0, 3).forEach(hw => {
                    const accuracy = Math.round(hw.accuracy_rate || 0);
                    const subject = hw.subject || 'æœªçŸ¥ç§‘ç›®';
                    homeworkHtml += `
                        <div class="homework-item">
                            <div class="homework-info">
                                <div class="homework-title">${hw.title || 'æ•°å­¦ä½œä¸š'}</div>
                                <div class="homework-meta">
                                    <span class="homework-subject">${subject}</span>
                                    <span>Â·</span>
                                    <span>${hw.total_questions || 0}é¢˜</span>
                                </div>
                            </div>
                            <div class="homework-stats">
                                <div class="homework-score">${hw.correct_count || 0}/${hw.total_questions || 0}</div>
                                <div class="homework-accuracy">æ­£ç¡®ç‡ ${accuracy}%</div>
                                <div class="homework-status completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    `;
                });
                homeworkHtml += '</div>';
                homeworkSection.innerHTML = homeworkHtml;
            } else {
                homeworkSection.innerHTML = `
                    <div class="section-title">æœ€è¿‘ä½œä¸š</div>
                    <div class="homework-empty">
                        <div class="homework-empty-icon">ğŸ“</div>
                        <div class="homework-empty-text">
                            è¿˜æ²¡æœ‰ä½œä¸šè®°å½•<br>
                            å¿«å»æäº¤ä½ çš„ç¬¬ä¸€ä»½ä½œä¸šå§ï¼
                        </div>
                    </div>
                `;
            }
        }

        function showError(sectionId, message, retryCallback) {
            const section = document.getElementById(sectionId);
            section.innerHTML = `
                <div class="error">
                    <div class="error-icon">ğŸ˜</div>
                    <div>${message}</div>
                    <button class="retry-btn" onclick="retryCallback()">é‡è¯•</button>
                </div>
            `;
        }

        // å¯¼èˆªå‡½æ•°
        function goToProfile() {
            window.location.href = '/frontend/profile.html';
        }

        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function goToExerciseConfig() {
            // è·³è½¬åˆ°æ™ºèƒ½å‡ºé¢˜é…ç½®é¡µé¢
            window.location.href = '/frontend/exercise-config.html';
        }

        function goToBatchExercise() {
            // è·³è½¬åˆ°æ‰¹é‡å‡ºé¢˜é…ç½®é¡µé¢
            window.location.href = '/frontend/batch-exercise-config.html';
        }

        function goToRecommendations() {
            // è·³è½¬åˆ°ä¸ªæ€§åŒ–æ¨èé¡µé¢
            window.location.href = '/frontend/personalized-recommendations.html';
        }

        function goToHomeworkDetail(id) {
            window.location.href = `/frontend/homework-result.html?id=${id}`;
        }

        function showToast(message) {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }

        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        function checkConnection() {
            return navigator.onLine;
        }

        // å¤„ç†ç½‘ç»œé”™è¯¯
        window.addEventListener('offline', function() {
            showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€');
        });

        window.addEventListener('online', function() {
            showToast('ç½‘ç»œè¿æ¥å·²æ¢å¤');
            loadAllDataAsync();
        });

        // åˆå§‹åŒ–å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶
        function initStudentBottomNavigation() {
            console.log('åˆå§‹åŒ–å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶...');
            
            // ä½¿ç”¨æ–°çš„ç»Ÿä¸€å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶
            const success = StudentBottomNav.init({
                currentPage: 'home',  // student-home.htmlå¯¹åº”çš„æ˜¯homeé¡µé¢ID
                debug: false
            });
            
            if (success) {
                console.log('âœ… å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('âŒ å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–å¤±è´¥');
            }
        }
        
        // åº•éƒ¨å¯¼èˆªå·²åœ¨initPageSyncä¸­è°ƒç”¨ï¼Œæ— éœ€å•ç‹¬ç›‘å¬å™¨
        
        // é¡µé¢åˆå§‹åŒ–ï¼ˆå·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œè¿™é‡Œä¸é‡å¤ï¼‰
    </script>
</body>
</html>