<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - é”™é¢˜æœ¬</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
        }
        
        /* ç»Ÿè®¡æ¦‚è§ˆ */
        .stats-overview {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .progress-section {
            border-top: 1px solid #f0f0f0;
            padding-top: 16px;
        }
        
        .progress-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 12px;
        }
        
        .subject-progress {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subject-name {
            width: 50px;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }
        
        .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-percent {
            font-size: 12px;
            color: #666;
            min-width: 35px;
        }
        
        /* ç­›é€‰æ ‡ç­¾ */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 0 4px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .filter-tab:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .filter-tab.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }
        
        /* é”™é¢˜åˆ—è¡¨ */
        .error-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 80px;
        }
        
        .error-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .error-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .error-item.reviewed {
            border-left: 4px solid #4CAF50;
        }
        
        .error-item.unreviewed {
            border-left: 4px solid #ff6b6b;
        }
        
        .error-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .error-subject {
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .error-date {
            font-size: 12px;
            color: #999;
        }
        
        .error-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-reviewed {
            background: #4CAF50;
        }
        
        .status-unreviewed {
            background: #ff6b6b;
        }
        
        .question-preview {
            margin-bottom: 12px;
        }
        
        .question-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .answer-comparison {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }
        
        .answer-item {
            flex: 1;
        }
        
        .answer-label {
            color: #666;
            margin-bottom: 2px;
        }
        
        .user-answer {
            color: #ff6b6b;
            font-weight: 500;
        }
        
        .correct-answer {
            color: #4CAF50;
            font-weight: 500;
        }
        
        .error-tags {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .error-tag {
            padding: 2px 8px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 11px;
            color: #1976D2;
        }
        
        .review-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-review {
            background: #e3f2fd;
            color: #1976D2;
        }
        
        .btn-review:hover {
            background: #bbdefb;
        }
        
        .btn-practice {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .btn-practice:hover {
            background: #e1bee7;
        }
        
        .btn-remove {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-remove:hover {
            background: #ffcdd2;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #ffffff;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .empty-hint {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .empty-action {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px 20px;
            background: #ffffff;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 14px;
            color: #666;
        }
        
        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: #ffffff;
            border-top: 1px solid #eee;
            display: flex;
            padding: 8px 0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .nav-item.active {
            color: #ff6b6b;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-text {
            font-size: 10px;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            
            .answer-comparison {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
    <script src="/frontend/js/global-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">é”™é¢˜æœ¬</div>
                </div>
                <button class="filter-btn" onclick="toggleFilter()">ç­›é€‰</button>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="stats-overview" id="statsOverview">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</div>
                </div>
            </div>
            
            <!-- ç­›é€‰æ ‡ç­¾ -->
            <div class="filter-tabs" id="filterTabs" style="display: none;">
                <div class="filter-tab active" data-filter="all">å…¨éƒ¨</div>
                <div class="filter-tab" data-filter="unreviewed">æœªå¤ä¹ </div>
                <div class="filter-tab" data-filter="reviewed">å·²å¤ä¹ </div>
                <div class="filter-tab" data-filter="chinese">è¯­æ–‡</div>
                <div class="filter-tab" data-filter="math">æ•°å­¦</div>
                <div class="filter-tab" data-filter="english">è‹±è¯­</div>
                <div class="filter-tab" data-filter="physics">ç‰©ç†</div>
                <div class="filter-tab" data-filter="chemistry">åŒ–å­¦</div>
            </div>
            
            <!-- é”™é¢˜åˆ—è¡¨ -->
            <div id="errorList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½é”™é¢˜æ•°æ®...</div>
                </div>
            </div>
        </div>
        
        <!-- å…¨å±€åº•éƒ¨å¯¼èˆª -->
        <div class="global-bottom-nav">
            <div class="global-nav-item" onclick="window.location.href='/frontend/student-home.html'">
                <div class="global-nav-icon">ğŸ </div>
                <div class="global-nav-text">é¦–é¡µ</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/homework-submit.html'">
                <div class="global-nav-icon">ğŸ“·</div>
                <div class="global-nav-text">æ‹ç…§æ‰¹æ”¹</div>
            </div>
            <div class="global-nav-item active" onclick="window.location.href='/frontend/error-book.html'">
                <div class="global-nav-icon">ğŸ“š</div>
                <div class="global-nav-text">é”™é¢˜æœ¬</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/study-plan.html'">
                <div class="global-nav-icon">ğŸ“‹</div>
                <div class="global-nav-text">å­¦ä¹ è®¡åˆ’</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/profile.html'">
                <div class="global-nav-icon">ğŸ‘¤</div>
                <div class="global-nav-text">æˆ‘çš„</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let errorData = [];
        let filteredData = [];
        let currentFilter = 'all';

        // åŒå‘å­¦ç§‘æ˜ å°„ - ä¸é”™é¢˜è¯¦æƒ…é¡µé¢ä¿æŒä¸€è‡´
        const subjectMapping = {
            // è‹±æ–‡åˆ°ä¸­æ–‡
            'math': 'æ•°å­¦',
            'chinese': 'è¯­æ–‡', 
            'english': 'è‹±è¯­',
            'physics': 'ç‰©ç†',
            'chemistry': 'åŒ–å­¦',
            'biology': 'ç”Ÿç‰©',
            // ä¸­æ–‡åˆ°è‹±æ–‡
            'æ•°å­¦': 'math',
            'è¯­æ–‡': 'chinese',
            'è‹±è¯­': 'english',
            'ç‰©ç†': 'physics',
            'åŒ–å­¦': 'chemistry',
            'ç”Ÿç‰©': 'biology'
        };

        // è·å–ç»Ÿä¸€çš„å­¦ç§‘æ˜¾ç¤ºåç§°ï¼ˆä¸­æ–‡ï¼‰
        function getSubjectDisplayName(rawSubject) {
            if (!rawSubject) return 'æœªçŸ¥ç§‘ç›®';
            
            // å¦‚æœæ˜¯ä¸­æ–‡å­¦ç§‘åï¼Œç›´æ¥è¿”å›
            if (['æ•°å­¦', 'è¯­æ–‡', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©'].includes(rawSubject)) {
                return rawSubject;
            }
            
            // å¦‚æœæ˜¯è‹±æ–‡ä»£ç ï¼Œè½¬æ¢ä¸ºä¸­æ–‡
            return subjectMapping[rawSubject] || rawSubject;
        }

        // æ£€æŸ¥é”™é¢˜æ˜¯å¦åŒ¹é…æŒ‡å®šå­¦ç§‘ï¼ˆæ”¯æŒä¸­è‹±æ–‡åŒ¹é…ï¼‰
        function isSubjectMatch(errorSubject, targetSubject) {
            if (!errorSubject || !targetSubject) return false;
            
            // ç›´æ¥åŒ¹é…
            if (errorSubject === targetSubject) return true;
            
            // è½¬æ¢ååŒ¹é…
            const errorSubjectCN = getSubjectDisplayName(errorSubject);
            const targetSubjectCN = getSubjectDisplayName(targetSubject);
            
            return errorSubjectCN === targetSubjectCN;
        }
        
        // åˆ‡æ¢ç­›é€‰æ ‡ç­¾æ˜¾ç¤º/éšè—
        function toggleFilter() {
            const filterTabs = document.getElementById('filterTabs');
            if (filterTabs.style.display === 'none' || filterTabs.style.display === '') {
                filterTabs.style.display = 'flex';
            } else {
                filterTabs.style.display = 'none';
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });

        // é¡µé¢å¯è§æ€§ç›‘å¬ - å½“ç”¨æˆ·ä»å…¶ä»–é¡µé¢è¿”å›æ—¶é‡æ–°åŠ è½½æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°åŠ è½½æ•°æ®');
                loadErrorBookData();
            }
        });

        // é¡µé¢èšç„¦ç›‘å¬ - å½“çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶é‡æ–°åŠ è½½æ•°æ®
        window.addEventListener('focus', function() {
            console.log('çª—å£é‡æ–°èšç„¦ï¼Œé‡æ–°åŠ è½½æ•°æ®');
            loadErrorBookData();
        });

        function initPage() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            token = localStorage.getItem('token');
            if (!token) {
                showToast('è¯·å…ˆç™»å½•');
                setTimeout(() => {
                    window.location.href = '/frontend/login.html';
                }, 2000);
                return;
            }
            
            // ç»‘å®šç­›é€‰æ ‡ç­¾äº‹ä»¶
            bindFilterTabs();
            
            // åŠ è½½æ•°æ®
            loadErrorBookData();
        }

        function bindFilterTabs() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    
                    // ç­›é€‰æ•°æ®
                    filterErrors();
                });
            });
            
            // æ›´æ–°æ ‡ç­¾æ•°é‡
            updateFilterTabCounts();
        }
        
        function updateFilterTabCounts() {
            if (!errorData || errorData.length === 0) return;
            
            const counts = {
                all: errorData.length,
                reviewed: errorData.filter(e => e.is_reviewed).length,
                unreviewed: errorData.filter(e => !e.is_reviewed).length,
                chinese: errorData.filter(e => isSubjectMatch(e.subject, 'è¯­æ–‡')).length,
                math: errorData.filter(e => isSubjectMatch(e.subject, 'æ•°å­¦')).length,
                english: errorData.filter(e => isSubjectMatch(e.subject, 'è‹±è¯­')).length,
                physics: errorData.filter(e => isSubjectMatch(e.subject, 'ç‰©ç†')).length,
                chemistry: errorData.filter(e => isSubjectMatch(e.subject, 'åŒ–å­¦')).length
            };
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                const filter = tab.dataset.filter;
                const count = counts[filter] || 0;
                const originalText = tab.textContent.split('(')[0].trim(); // ç§»é™¤å·²æœ‰çš„æ•°å­—
                
                if (count > 0 && filter !== 'all') {
                    tab.textContent = `${originalText} (${count})`;
                } else {
                    tab.textContent = originalText;
                }
                
                // éšè—æ²¡æœ‰æ•°æ®çš„æ ‡ç­¾
                if (count === 0 && filter !== 'all') {
                    tab.style.display = 'none';
                } else {
                    tab.style.display = 'inline-block';
                }
            });
        }
        
        function clearFilter() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-filter="all"]').classList.add('active');
            currentFilter = 'all';
            filterErrors();
        }

        async function loadErrorBookData() {
            try {
                // åŠ è½½é”™é¢˜ç»Ÿè®¡ - å¿…é¡»ä»APIè·å–ï¼ŒåŒ…å«æ­£ç¡®çš„å¤ä¹ çŠ¶æ€
                const statsResponse = await fetch(`${API_BASE}/student/error-book`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    errorData = data.recent_errors || [];
                    
                    console.log('ä»APIåŠ è½½çš„é”™é¢˜æ•°æ®:', errorData);
                    
                    filteredData = [...errorData];
                    // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„æ•°æ®ï¼ŒåŒ…å«å‡†ç¡®çš„is_reviewedçŠ¶æ€
                    updateStatsOverview({ 
                        recent_errors: errorData,
                        total_errors: errorData.length,
                        subject_stats: data.subject_stats || []
                    });
                    
                    // æ›´æ–°ç­›é€‰æ ‡ç­¾æ•°é‡
                    updateFilterTabCounts();
                    
                    updateErrorList();
                } else {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${statsResponse.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½é”™é¢˜æ•°æ®å¤±è´¥:', error);
                showErrorMessage('æ•°æ®åŠ è½½å¤±è´¥', `æ— æ³•ä»æœåŠ¡å™¨è·å–é”™é¢˜æ•°æ®: ${error.message}`);
            }
        }

        function showErrorMessage(title, message) {
            const errorList = document.getElementById('errorList');
            const statsOverview = document.getElementById('statsOverview');
            
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            statsOverview.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                    <button class="retry-btn" onclick="loadErrorBookData()">é‡æ–°åŠ è½½</button>
                </div>
            `;
            
            errorList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”Œ</div>
                    <div class="empty-text">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</div>
                    <div class="empty-hint">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•</div>
                    <button class="empty-action" onclick="loadErrorBookData()">é‡è¯•</button>
                </div>
            `;
            
            // æ·»åŠ é”™è¯¯çŠ¶æ€æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .error-state {
                    text-align: center;
                    padding: 40px 20px;
                    color: #d32f2f;
                }
                .error-icon {
                    font-size: 48px;
                    margin-bottom: 16px;
                }
                .error-title {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 8px;
                }
                .error-message {
                    font-size: 14px;
                    margin-bottom: 20px;
                    line-height: 1.4;
                }
                .retry-btn {
                    background: #ff6b6b;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                }
            `;
            document.head.appendChild(style);
        }

        function calculateRealStats() {
            if (!errorData || errorData.length === 0) {
                return {
                    totalErrors: 0,
                    unreviewed: 0,
                    reviewed: 0,
                    subjectStats: []
                };
            }
            
            // åŸºäºçœŸå®é”™é¢˜æ•°æ®è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const totalErrors = errorData.length;
            const unreviewed = errorData.filter(error => !error.is_reviewed).length;
            const reviewed = errorData.filter(error => error.is_reviewed).length;
            
            // æŒ‰ç§‘ç›®åˆ†ç»„ç»Ÿè®¡
            const subjectMap = {};
            errorData.forEach(error => {
                if (!error.subject) return;
                
                if (!subjectMap[error.subject]) {
                    subjectMap[error.subject] = {
                        subject: error.subject,
                        total: 0,
                        reviewed: 0,
                        unreviewed: 0
                    };
                }
                
                subjectMap[error.subject].total++;
                if (error.is_reviewed) {
                    subjectMap[error.subject].reviewed++;
                } else {
                    subjectMap[error.subject].unreviewed++;
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰é¢˜ç›®æ•°é‡æ’åº
            const subjectStats = Object.values(subjectMap).sort((a, b) => b.total - a.total);
            
            return {
                totalErrors,
                unreviewed,
                reviewed,
                subjectStats
            };
        }
        
        function updateStatsOverview(data) {
            const statsOverview = document.getElementById('statsOverview');
            
            // ä½¿ç”¨çœŸå®æ•°æ®è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const realStats = calculateRealStats();
            
            // å¦‚æœæœ‰çœŸå®é”™é¢˜æ•°æ®ï¼Œä½¿ç”¨çœŸå®ç»Ÿè®¡ï¼›å¦åˆ™ä½¿ç”¨ä¼ å…¥çš„æ•°æ®
            const totalErrors = realStats.totalErrors;
            const unreviewed = realStats.unreviewed;
            const reviewed = realStats.reviewed;
            const subjectStats = realStats.subjectStats;
            
            if (totalErrors === 0) {
                statsOverview.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æ€»é”™é¢˜</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">æœªå¤ä¹ </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">å·²å¤ä¹ </div>
                        </div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-title">å­¦ç§‘é”™é¢˜åˆ†å¸ƒ</div>
                        <div class="subject-progress">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                æš‚æ— é”™é¢˜æ•°æ®
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            statsOverview.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${totalErrors}</div>
                        <div class="stat-label">æ€»é”™é¢˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${unreviewed}</div>
                        <div class="stat-label">æœªå¤ä¹ </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${reviewed}</div>
                        <div class="stat-label">å·²å¤ä¹ </div>
                    </div>
                </div>
                <div class="progress-section">
                    <div class="progress-title">å­¦ç§‘é”™é¢˜åˆ†å¸ƒ</div>
                    <div class="subject-progress">
                        ${subjectStats.map(stat => {
                            const percentage = (stat.total / totalErrors * 100).toFixed(1);
                            return `
                                <div class="progress-item">
                                    <div class="subject-name">${stat.subject}</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="progress-percent">${stat.total}é¢˜ (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function filterErrors() {
            console.log('å¼€å§‹ç­›é€‰ï¼Œå½“å‰ç­›é€‰æ¡ä»¶:', currentFilter);
            
            if (currentFilter === 'all') {
                filteredData = [...errorData];
            } else if (currentFilter === 'reviewed') {
                filteredData = errorData.filter(error => error.is_reviewed);
            } else if (currentFilter === 'unreviewed') {
                filteredData = errorData.filter(error => !error.is_reviewed);
            } else {
                // æŒ‰ç§‘ç›®ç­›é€‰
                const subjectMap = {
                    'chinese': 'è¯­æ–‡',
                    'math': 'æ•°å­¦',
                    'english': 'è‹±è¯­',
                    'physics': 'ç‰©ç†',
                    'chemistry': 'åŒ–å­¦'
                };
                const subject = subjectMap[currentFilter];
                if (subject) {
                    filteredData = errorData.filter(error => isSubjectMatch(error.subject, subject));
                }
            }
            
            console.log('ç­›é€‰ç»“æœ:', filteredData.length, 'æ¡é”™é¢˜');
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœæç¤º
            showFilterResult();
            
            updateErrorList();
        }

        function showFilterResult() {
            const filterName = getFilterName(currentFilter);
            const count = filteredData.length;
            
            if (currentFilter !== 'all') {
                showToast(`${filterName}ï¼šæ‰¾åˆ°${count}æ¡é”™é¢˜`);
            }
        }

        function getFilterName(filter) {
            const filterNames = {
                'all': 'å…¨éƒ¨',
                'reviewed': 'å·²å¤ä¹ ',
                'unreviewed': 'æœªå¤ä¹ ',
                'chinese': 'è¯­æ–‡',
                'math': 'æ•°å­¦',
                'english': 'è‹±è¯­',
                'physics': 'ç‰©ç†',
                'chemistry': 'åŒ–å­¦',
                'error_type': 'æŒ‰é”™è¯¯ç±»å‹',
                'date_today': 'ä»Šå¤©',
                'date_week': 'æœ¬å‘¨',
                'date_month': 'æœ¬æœˆ'
            };
            return filterNames[filter] || 'è‡ªå®šä¹‰ç­›é€‰';
        }

        function updateErrorList() {
            const errorList = document.getElementById('errorList');
            
            if (filteredData.length === 0) {
                const filterName = getFilterName(currentFilter);
                const isEmpty = errorData.length === 0;
                
                if (isEmpty) {
                    // å®Œå…¨æ²¡æœ‰é”™é¢˜æ•°æ®
                    errorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“š</div>
                            <div class="empty-text">æš‚æ— é”™é¢˜</div>
                            <div class="empty-hint">å®Œæˆä½œä¸šæ‰¹æ”¹åï¼Œé”™é¢˜ä¼šè‡ªåŠ¨æ”¶å½•åˆ°è¿™é‡Œ</div>
                            <button class="empty-action" onclick="submitHomework()">å»æ‰¹æ”¹ä½œä¸š</button>
                        </div>
                    `;
                } else {
                    // æœ‰é”™é¢˜æ•°æ®ï¼Œä½†ç­›é€‰åæ²¡æœ‰ç»“æœ
                    errorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ”</div>
                            <div class="empty-text">æ²¡æœ‰æ‰¾åˆ°ã€${filterName}ã€‘çš„é”™é¢˜</div>
                            <div class="empty-hint">å¯ä»¥å°è¯•åˆ‡æ¢å…¶ä»–ç­›é€‰æ¡ä»¶ï¼Œæˆ–æŸ¥çœ‹å…¨éƒ¨é”™é¢˜</div>
                            <button class="empty-action" onclick="clearFilter()">æŸ¥çœ‹å…¨éƒ¨é”™é¢˜</button>
                        </div>
                    `;
                }
                return;
            }
            
            const errorItems = filteredData.map(error => `
                <div class="error-item ${error.is_reviewed ? 'reviewed' : 'unreviewed'}" onclick="viewErrorDetail(${error.id})">
                    <div class="error-status ${error.is_reviewed ? 'status-reviewed' : 'status-unreviewed'}"></div>
                    <div class="error-header">
                        <div class="error-subject">${error.subject || 'æœªçŸ¥å­¦ç§‘'}</div>
                        <div class="error-date">${formatDate(error.created_at)}</div>
                    </div>
                    <div class="question-preview">
                        <div class="question-text">${error.question_text || error.question || 'é¢˜ç›®å†…å®¹'}</div>
                        <div class="answer-comparison">
                            <div class="answer-item">
                                <div class="answer-label">ä½ çš„ç­”æ¡ˆ</div>
                                <div class="user-answer">${error.user_answer || error.userAnswer || 'æ— ç­”æ¡ˆ'}</div>
                            </div>
                            <div class="answer-item">
                                <div class="answer-label">æ­£ç¡®ç­”æ¡ˆ</div>
                                <div class="correct-answer">${error.correct_answer || error.correctAnswer || 'æ— æ­£ç¡®ç­”æ¡ˆ'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="error-tags">
                        ${error.error_type ? `<div class="error-tag">${error.error_type || error.errorType}</div>` : ''}
                        ${error.knowledge_points?.map(point => `<div class="error-tag">${point}</div>`).join('') || ''}
                    </div>
                    <div class="review-actions" onclick="event.stopPropagation()">
                        ${!error.is_reviewed ? `
                            <button class="action-btn btn-review" onclick="markAsReviewed(${error.id})">
                                âœ“ æ ‡è®°å·²å¤ä¹ 
                            </button>
                        ` : ''}
                        <button class="action-btn btn-practice" onclick="practiceError(${error.id})">
                            ğŸ“ ç›¸ä¼¼ç»ƒä¹ 
                        </button>
                        <button class="action-btn btn-remove" onclick="removeError(${error.id})">
                            ğŸ—‘ï¸ ç§»é™¤
                        </button>
                    </div>
                </div>
            `).join('');
            
            errorList.innerHTML = errorItems;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return 'ä»Šå¤©';
            } else if (days === 1) {
                return 'æ˜¨å¤©';
            } else if (days < 7) {
                return `${days}å¤©å‰`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function showFilterOptions() {
            // æ˜¾ç¤ºæ›´å®ç”¨çš„ç­›é€‰èœå•
            showFilterModal();
        }
        
        function getAvailableSubjects() {
            if (!errorData || errorData.length === 0) return [];
            
            const subjects = [...new Set(errorData.map(error => error.subject))].filter(Boolean);
            return subjects.sort();
        }
        
        function getAvailableErrorTypes() {
            if (!errorData || errorData.length === 0) return [];
            
            const errorTypes = [...new Set(errorData.map(error => error.error_type))].filter(Boolean);
            return errorTypes.sort();
        }
        
        function generateSubjectOptions() {
            const subjects = getAvailableSubjects();
            let options = '<option value="">ä¸é™</option>';
            
            subjects.forEach(subject => {
                const count = errorData.filter(e => isSubjectMatch(e.subject, subject)).length;
                options += `<option value="${subject}">${subject} (${count}é¢˜)</option>`;
            });
            
            return options;
        }
        
        function generateErrorTypeOptions() {
            const errorTypes = getAvailableErrorTypes();
            let options = '<option value="">ä¸é™</option>';
            
            errorTypes.forEach(errorType => {
                const count = errorData.filter(e => e.error_type === errorType).length;
                options += `<option value="${errorType}">${errorType} (${count}é¢˜)</option>`;
            });
            
            return options;
        }
        
        function generateSubjectButtons() {
            const subjects = getAvailableSubjects();
            const subjectIcons = {
                'æ•°å­¦': 'ğŸ”¢',
                'è¯­æ–‡': 'ğŸ“–', 
                'è‹±è¯­': 'ğŸ”¤',
                'ç‰©ç†': 'âš¡',
                'åŒ–å­¦': 'âš—ï¸',
                'ç”Ÿç‰©': 'ğŸ§¬',
                'å†å²': 'ğŸ“œ',
                'åœ°ç†': 'ğŸŒ',
                'æ”¿æ²»': 'âš–ï¸'
            };
            
            const subjectFilters = {
                'æ•°å­¦': 'math',
                'è¯­æ–‡': 'chinese',
                'è‹±è¯­': 'english', 
                'ç‰©ç†': 'physics',
                'åŒ–å­¦': 'chemistry',
                'ç”Ÿç‰©': 'biology',
                'å†å²': 'history',
                'åœ°ç†': 'geography',
                'æ”¿æ²»': 'politics'
            };
            
            let buttons = '';
            subjects.forEach(subject => {
                const count = errorData.filter(e => isSubjectMatch(e.subject, subject)).length;
                const icon = subjectIcons[subject] || 'ğŸ“š';
                const filterKey = subjectFilters[subject] || `subject_${subject}`;
                
                if (count > 0) {
                    buttons += `
                        <button class="filter-quick-btn" onclick="filterBySubject('${subject}')">
                            ${icon} ${subject} (${count})
                        </button>
                    `;
                }
            });
            
            return buttons;
        }
        
        function generateErrorTypeButtons() {
            const errorTypes = getAvailableErrorTypes();
            const errorTypeIcons = {
                'è®¡ç®—é”™è¯¯': 'â•',
                'è¯­æ³•é”™è¯¯': 'ğŸ“',
                'çŸ¥è¯†é”™è¯¯': 'ğŸ’¡',
                'è¿ç®—é”™è¯¯': 'ğŸ”£',
                'åŸºç¡€æ¦‚å¿µ': 'ğŸ“',
                'è¯æ±‡é”™è¯¯': 'ğŸ“–',
                'ç¿»è¯‘é”™è¯¯': 'ğŸŒ',
                'æ–‡å­¦å¸¸è¯†': 'ğŸ“š',
                'å‡ ä½•æ¦‚å¿µ': 'ğŸ“',
                'ä»£æ•°è¿ç®—': 'ğŸ”¢'
            };
            
            let buttons = '';
            errorTypes.forEach(errorType => {
                const count = errorData.filter(e => e.error_type === errorType).length;
                const icon = errorTypeIcons[errorType] || 'â“';
                
                if (count > 0) {
                    buttons += `
                        <button class="filter-quick-btn" onclick="filterByErrorType('${errorType}')">
                            ${icon} ${errorType} (${count})
                        </button>
                    `;
                }
            });
            
            return buttons;
        }
        
        function showFilterModal() {
            const totalCount = errorData.length;
            const currentCount = filteredData.length;
            const filterName = getFilterName(currentFilter);
            
            // åˆ›å»ºç­›é€‰å¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'filterModal';
            modal.innerHTML = `
                <div class="filter-modal-overlay" onclick="closeFilterModal()">
                    <div class="filter-modal-content" onclick="event.stopPropagation()">
                        <div class="filter-modal-header">
                            <h3>ç­›é€‰é”™é¢˜</h3>
                            <button onclick="closeFilterModal()" class="close-modal-btn">Ã—</button>
                        </div>
                        
                        <div class="filter-modal-body">
                            <div class="filter-section">
                                <div class="filter-section-title">å½“å‰çŠ¶æ€</div>
                                <div class="filter-current">
                                    æ­£åœ¨æ˜¾ç¤ºã€${filterName}ã€‘- ${currentCount} / ${totalCount} æ¡é”™é¢˜
                                </div>
                                <div class="filter-stats">
                                    å·²å¤ä¹ : ${filteredData.filter(e => e.is_reviewed).length} | 
                                    æœªå¤ä¹ : ${filteredData.filter(e => !e.is_reviewed).length}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æŒ‰çŠ¶æ€ç­›é€‰</div>
                                <div class="filter-quick-buttons">
                                    <button class="filter-quick-btn" onclick="quickFilter('unreviewed')">
                                        ğŸ“š æœªå¤ä¹ é”™é¢˜ (${errorData.filter(e => !e.is_reviewed).length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="quickFilter('reviewed')">
                                        âœ… å·²å¤ä¹ é”™é¢˜ (${errorData.filter(e => e.is_reviewed).length})
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æŒ‰ç§‘ç›®ç­›é€‰</div>
                                <div class="filter-quick-buttons">
                                    ${generateSubjectButtons()}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æŒ‰é”™è¯¯ç±»å‹ç­›é€‰</div>
                                <div class="filter-quick-buttons">
                                    ${generateErrorTypeButtons()}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æŒ‰æ—¶é—´ç­›é€‰</div>
                                <div class="filter-quick-buttons">
                                    <button class="filter-quick-btn" onclick="filterByDate('today')">
                                        ğŸ“… ä»Šå¤©çš„é”™é¢˜ (${getErrorsByDate('today').length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="filterByDate('week')">
                                        ğŸ“† æœ¬å‘¨é”™é¢˜ (${getErrorsByDate('week').length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="filterByDate('month')">
                                        ğŸ—“ï¸ æœ¬æœˆé”™é¢˜ (${getErrorsByDate('month').length})
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æœç´¢åŠŸèƒ½</div>
                                <div class="search-box">
                                    <input type="text" id="searchInput" placeholder="æœç´¢é¢˜ç›®å†…å®¹..." />
                                    <button class="search-btn" onclick="searchErrors()">ğŸ”</button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">é«˜çº§ç­›é€‰</div>
                                <div class="advanced-filter">
                                    <div class="filter-row">
                                        <label>ç§‘ç›®:</label>
                                        <select id="advancedSubject">
                                            ${generateSubjectOptions()}
                                        </select>
                                    </div>
                                    <div class="filter-row">
                                        <label>çŠ¶æ€:</label>
                                        <select id="advancedStatus">
                                            <option value="">ä¸é™</option>
                                            <option value="reviewed">å·²å¤ä¹ </option>
                                            <option value="unreviewed">æœªå¤ä¹ </option>
                                        </select>
                                    </div>
                                    <div class="filter-row">
                                        <label>é”™è¯¯ç±»å‹:</label>
                                        <select id="advancedErrorType">
                                            ${generateErrorTypeOptions()}
                                        </select>
                                    </div>
                                    <button class="filter-action-btn advanced-apply" onclick="applyAdvancedFilter()">
                                        ğŸ” åº”ç”¨é«˜çº§ç­›é€‰
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">æ’åºå’Œé‡ç½®</div>
                                <div class="filter-actions">
                                    <button class="filter-action-btn" onclick="quickFilter('all')">
                                        ğŸ” æ˜¾ç¤ºå…¨éƒ¨é”™é¢˜
                                    </button>
                                    <button class="filter-action-btn" onclick="sortByDate()">
                                        ğŸ“… æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°ä¼˜å…ˆï¼‰
                                    </button>
                                    <button class="filter-action-btn" onclick="sortBySubject()">
                                        ğŸ“š æŒ‰ç§‘ç›®æ’åº
                                    </button>
                                    <button class="filter-action-btn" onclick="sortByDifficulty()">
                                        â­ æŒ‰éš¾åº¦æ’åº
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .filter-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .filter-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .filter-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 20px 16px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .filter-modal-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-modal-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    color: #666;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .close-modal-btn:hover {
                    background: #f0f0f0;
                }
                
                .filter-modal-body {
                    padding: 20px;
                }
                
                .filter-section {
                    margin-bottom: 24px;
                }
                
                .filter-section:last-child {
                    margin-bottom: 0;
                }
                
                .filter-section-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 12px;
                }
                
                .filter-current {
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 8px;
                    font-size: 14px;
                    color: #666;
                    border-left: 4px solid #ff6b6b;
                }
                
                .filter-stats {
                    margin-top: 8px;
                    padding: 8px 12px;
                    background: #e3f2fd;
                    border-radius: 6px;
                    font-size: 12px;
                    color: #1976D2;
                    text-align: center;
                }
                
                .filter-quick-buttons, .filter-actions {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .filter-quick-btn, .filter-action-btn {
                    width: 100%;
                    padding: 12px 16px;
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    font-size: 14px;
                    color: #333;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: left;
                }
                
                .filter-quick-btn:hover, .filter-action-btn:hover {
                    background: #e9ecef;
                    border-color: #dee2e6;
                }
                
                .filter-quick-btn:active, .filter-action-btn:active {
                    background: #dee2e6;
                }
                
                .advanced-filter {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 16px;
                }
                
                .filter-row {
                    display: flex;
                    align-items: center;
                    margin-bottom: 12px;
                }
                
                .filter-row:last-child {
                    margin-bottom: 0;
                }
                
                .filter-row label {
                    min-width: 80px;
                    font-size: 13px;
                    color: #666;
                    margin-right: 12px;
                }
                
                .filter-row select {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 13px;
                    background: white;
                }
                
                .advanced-apply {
                    margin-top: 12px;
                    background: #007AFF !important;
                    color: white !important;
                }
                
                .advanced-apply:hover {
                    background: #0056CC !important;
                }
                
                .quantity-input {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .quantity-input input[type="number"] {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                    width: 80px;
                }
                
                .quantity-input .unit {
                    color: #666;
                    font-size: 14px;
                }
                
                .search-box {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .search-box input {
                    flex: 1;
                    padding: 10px 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                    background: white;
                }
                
                .search-box input:focus {
                    outline: none;
                    border-color: #007AFF;
                    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
                }
                
                .search-btn {
                    padding: 10px 16px;
                    background: #007AFF;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                }
                
                .search-btn:hover {
                    background: #0056CC;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        function closeFilterModal() {
            const modal = document.getElementById('filterModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function filterBySubject(subject) {
            currentFilter = `subject_${subject}`;
            filteredData = errorData.filter(error => isSubjectMatch(error.subject, subject));
            updateErrorList();
            closeFilterModal();
            showToast(`ç­›é€‰ã€${subject}ã€‘ï¼šæ‰¾åˆ°${filteredData.length}æ¡é”™é¢˜`);
        }
        
        function quickFilter(filterType) {
            // æ›´æ–°ç­›é€‰æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
            
            // åº”ç”¨ç­›é€‰
            currentFilter = filterType;
            filterErrors();
            
            // å…³é—­å¼¹çª—
            closeFilterModal();
        }
        
        function sortByDate() {
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            updateErrorList();
            closeFilterModal();
            showToast('å·²æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°ä¼˜å…ˆï¼‰');
        }
        
        function sortBySubject() {
            // æŒ‰ç§‘ç›®æ’åº
            const subjectOrder = ['æ•°å­¦', 'è¯­æ–‡', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦'];
            filteredData.sort((a, b) => {
                const indexA = subjectOrder.indexOf(a.subject);
                const indexB = subjectOrder.indexOf(b.subject);
                return indexA - indexB;
            });
            updateErrorList();
            closeFilterModal();
            showToast('å·²æŒ‰ç§‘ç›®æ’åº');
        }
        
        function sortByDifficulty() {
            // æŒ‰éš¾åº¦æ’åºï¼ˆè¿™é‡Œç®€å•æŒ‰é”™è¯¯ç±»å‹åˆ†ç±»ï¼‰
            const difficultyOrder = ['è®¡ç®—é”™è¯¯', 'è¿ç®—é”™è¯¯', 'è¯­æ³•é”™è¯¯', 'çŸ¥è¯†é”™è¯¯', 'åŸºç¡€æ¦‚å¿µ'];
            filteredData.sort((a, b) => {
                const indexA = difficultyOrder.indexOf(a.error_type);
                const indexB = difficultyOrder.indexOf(b.error_type);
                return indexA - indexB;
            });
            updateErrorList();
            closeFilterModal();
            showToast('å·²æŒ‰éš¾åº¦æ’åº');
        }
        
        function filterByErrorType(errorType) {
            currentFilter = 'error_type';
            filteredData = errorData.filter(error => error.error_type === errorType);
            updateErrorList();
            closeFilterModal();
            showToast(`ç­›é€‰ã€${errorType}ã€‘ï¼šæ‰¾åˆ°${filteredData.length}æ¡é”™é¢˜`);
        }
        
        function filterByDate(period) {
            const now = new Date();
            let startDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
            }
            
            currentFilter = `date_${period}`;
            filteredData = errorData.filter(error => new Date(error.created_at) >= startDate);
            updateErrorList();
            closeFilterModal();
            
            const periodNames = {
                'today': 'ä»Šå¤©',
                'week': 'æœ¬å‘¨', 
                'month': 'æœ¬æœˆ'
            };
            showToast(`ç­›é€‰ã€${periodNames[period]}ã€‘ï¼šæ‰¾åˆ°${filteredData.length}æ¡é”™é¢˜`);
        }
        
        function getErrorsByDate(period) {
            if (!errorData || errorData.length === 0) return [];
            
            const now = new Date();
            let startDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                default:
                    return [];
            }
            
            return errorData.filter(error => new Date(error.created_at) >= startDate);
        }
        
        function applyAdvancedFilter() {
            const subject = document.getElementById('advancedSubject').value;
            const status = document.getElementById('advancedStatus').value;
            const errorType = document.getElementById('advancedErrorType').value;
            
            currentFilter = 'advanced';
            filteredData = [...errorData];
            
            // åº”ç”¨ç§‘ç›®ç­›é€‰
            if (subject) {
                filteredData = filteredData.filter(error => isSubjectMatch(error.subject, subject));
            }
            
            // åº”ç”¨çŠ¶æ€ç­›é€‰
            if (status === 'reviewed') {
                filteredData = filteredData.filter(error => error.is_reviewed);
            } else if (status === 'unreviewed') {
                filteredData = filteredData.filter(error => !error.is_reviewed);
            }
            
            // åº”ç”¨é”™è¯¯ç±»å‹ç­›é€‰
            if (errorType) {
                filteredData = filteredData.filter(error => error.error_type === errorType);
            }
            
            updateErrorList();
            closeFilterModal();
            
            // ç”Ÿæˆç­›é€‰ç»“æœæè¿°
            const conditions = [];
            if (subject) conditions.push(`ç§‘ç›®:${subject}`);
            if (status === 'reviewed') conditions.push('çŠ¶æ€:å·²å¤ä¹ ');
            if (status === 'unreviewed') conditions.push('çŠ¶æ€:æœªå¤ä¹ ');
            if (errorType) conditions.push(`ç±»å‹:${errorType}`);
            
            const conditionText = conditions.length > 0 ? conditions.join('ï¼Œ') : 'æ— æ¡ä»¶';
            showToast(`é«˜çº§ç­›é€‰ã€${conditionText}ã€‘ï¼šæ‰¾åˆ°${filteredData.length}æ¡é”™é¢˜`);
        }
        
        function searchErrors() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                showToast('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            currentFilter = 'search';
            filteredData = errorData.filter(error => 
                error.question_text.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.user_answer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.correct_answer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.error_type.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (error.knowledge_points && error.knowledge_points.some(point => 
                    point.toLowerCase().includes(searchTerm.toLowerCase())))
            );
            
            updateErrorList();
            closeFilterModal();
            showToast(`æœç´¢"${searchTerm}"ï¼šæ‰¾åˆ°${filteredData.length}æ¡ç›¸å…³é”™é¢˜`);
        }
        
        // ç›‘å¬æœç´¢æ¡†å›è½¦é”®
        document.addEventListener('DOMContentLoaded', function() {
            // å°†åŸæœ‰çš„åˆå§‹åŒ–ä»£ç åŒ…è£…
            const originalInitPage = initPage;
            initPage = function() {
                originalInitPage();
                
                // æ·»åŠ æœç´¢æ¡†å›è½¦ç›‘å¬
                document.addEventListener('keydown', function(e) {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput && e.target === searchInput && e.key === 'Enter') {
                        searchErrors();
                    }
                });
            };
        });

        function viewErrorDetail(errorId) {
            // æ‰¾åˆ°å¯¹åº”çš„é”™é¢˜æ•°æ®
            const errorDetail = errorData.find(error => error.id == errorId);
            
            if (errorDetail) {
                // å°†é”™é¢˜æ•°æ®å­˜å‚¨åˆ°localStorageï¼Œç¡®ä¿è¯¦æƒ…é¡µé¢æ˜¾ç¤ºä¸€è‡´çš„æ•°æ®
                localStorage.setItem('currentErrorDetail', JSON.stringify(errorDetail));
                console.log('å­˜å‚¨é”™é¢˜æ•°æ®åˆ°localStorage:', errorDetail);
            }
            
            // è·³è½¬åˆ°é”™é¢˜è¯¦æƒ…é¡µé¢
            window.location.href = `/frontend/error-detail.html?id=${errorId}`;
        }

        async function markAsReviewed(errorId) {
            try {
                const response = await fetch(`${API_BASE}/student/error-book/${errorId}/review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®çŠ¶æ€
                    const error = errorData.find(e => e.id === errorId);
                    if (error) {
                        error.is_reviewed = true;
                    }
                    
                    // é‡æ–°æ¸²æŸ“åˆ—è¡¨å’Œç»Ÿè®¡
                    filterErrors();
                    updateStatsOverview();
                    showToast('å·²æ ‡è®°ä¸ºå·²å¤ä¹ ');
                } else {
                    throw new Error('æ ‡è®°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ ‡è®°å¤ä¹ å¤±è´¥:', error);
                showToast('æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ³¨æ„ï¼šç§»é™¤äº†localStorageç›¸å…³çš„å¤ä¹ çŠ¶æ€ç®¡ç†
        // ç°åœ¨å®Œå…¨ä¾é æ•°æ®åº“å’ŒAPIè¿”å›çš„is_reviewedå­—æ®µ

        function practiceError(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('æ‰¾ä¸åˆ°è¯¥é”™é¢˜ä¿¡æ¯');
                return;
            }
            
            showPracticeModal(error);
        }
        
        function showPracticeModal(error) {
            // åˆ›å»ºç»ƒä¹ æ¨¡æ€æ¡†
            const practiceModal = document.createElement('div');
            practiceModal.id = 'practiceModal';
            practiceModal.innerHTML = `
                <div class="practice-modal-overlay" onclick="closePracticeModal()">
                    <div class="practice-modal-content" onclick="event.stopPropagation()">
                        <div class="practice-modal-header">
                            <h3>ğŸ“ ç”Ÿæˆç›¸ä¼¼ç»ƒä¹ </h3>
                            <button onclick="closePracticeModal()" class="close-practice-btn">Ã—</button>
                        </div>
                        
                        <div class="practice-modal-body">
                            <!-- åŸé¢˜å±•ç¤º -->
                            <div class="original-question">
                                <div class="section-title">ğŸ“š åŸé¢˜ä¿¡æ¯</div>
                                <div class="question-info">
                                    <div class="info-row">
                                        <span class="label">ç§‘ç›®ï¼š</span>
                                        <span class="value">${getSubjectDisplayName(error.subject)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">é¢˜ç›®ï¼š</span>
                                        <span class="value">${error.question_text}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">é”™è¯¯ç±»å‹ï¼š</span>
                                        <span class="value">${error.error_type}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">çŸ¥è¯†ç‚¹ï¼š</span>
                                        <span class="value">${error.knowledge_points ? error.knowledge_points.join('ã€') : 'æ— '}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç”Ÿæˆè®¾ç½® -->
                            <div class="practice-settings">
                                <div class="section-title">âš™ï¸ ç”Ÿæˆè®¾ç½®</div>
                                
                                <div class="setting-row">
                                    <label>é¢˜ç›®æ•°é‡ï¼š</label>
                                    <div class="quantity-input">
                                        <input type="number" id="questionCount" min="1" max="50" value="5" />
                                        <span class="unit">é“é¢˜</span>
                                    </div>
                                </div>
                                
                                <div class="setting-row">
                                    <label>éš¾åº¦é€‰æ‹©ï¼š</label>
                                    <select id="difficultyLevel">
                                        <option value="easier">ğŸŸ¢ ç®€åŒ–ç‰ˆï¼ˆæ¯”åŸé¢˜ç®€å•ï¼‰</option>
                                        <option value="same" selected>ğŸŸ¡ ç›¸åŒéš¾åº¦ï¼ˆä¸åŸé¢˜ç›¸å½“ï¼‰</option>
                                        <option value="harder">ğŸ”´ æé«˜ç‰ˆï¼ˆæ¯”åŸé¢˜å›°éš¾ï¼‰</option>
                                        <option value="mixed">ğŸŒˆ æ··åˆéš¾åº¦ï¼ˆå¾ªåºæ¸è¿›ï¼‰</option>
                                    </select>
                                </div>
                                
                                <div class="setting-row">
                                    <label>é¢˜ç›®ç±»å‹ï¼š</label>
                                    <select id="questionType">
                                        <option value="similar" selected>ğŸ“‹ ç›¸ä¼¼é¢˜ç›®ï¼ˆç»“æ„ç›¸ä¼¼ï¼‰</option>
                                        <option value="extended">ğŸ”„ æ‹“å±•å˜å¼ï¼ˆåŸºç¡€æ‰©å±•ï¼‰</option>
                                        <option value="comprehensive">ğŸ§  ç»¼åˆåº”ç”¨ï¼ˆå¤šçŸ¥è¯†ç‚¹ï¼‰</option>
                                    </select>
                                </div>
                                
                                <div class="setting-row">
                                    <label>æ˜¯å¦åŒ…å«ç­”æ¡ˆï¼š</label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="includeAnswers" checked>
                                            <span>åŒ…å«è¯¦ç»†ç­”æ¡ˆ</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="includeAnalysis" checked>
                                            <span>åŒ…å«è§£é¢˜æ€è·¯</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="practice-actions">
                                <button class="practice-btn generate-btn" onclick="generatePractice(${error.id})">
                                    ğŸ¤– AIæ™ºèƒ½ç”Ÿæˆ
                                </button>
                                <button class="practice-btn preview-btn" onclick="showGenerationPreview(${error.id})">
                                    ğŸ‘€ é¢„è§ˆè®¾ç½®
                                </button>
                            </div>
                            
                            <!-- ç”Ÿæˆç»“æœåŒºåŸŸ -->
                            <div id="practiceResult" class="practice-result" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .practice-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .practice-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 600px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .practice-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 20px 16px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .practice-modal-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-practice-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    color: #666;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .close-practice-btn:hover {
                    background: #f0f0f0;
                }
                
                .practice-modal-body {
                    padding: 20px;
                }
                
                .original-question, .practice-settings {
                    margin-bottom: 24px;
                    padding: 16px;
                    background: #f8f9fa;
                    border-radius: 12px;
                }
                
                .section-title {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 12px;
                }
                
                .question-info .info-row {
                    display: flex;
                    margin-bottom: 8px;
                    align-items: flex-start;
                }
                
                .question-info .label {
                    min-width: 80px;
                    font-weight: 500;
                    color: #666;
                }
                
                .question-info .value {
                    flex: 1;
                    color: #333;
                }
                
                .setting-row {
                    display: flex;
                    align-items: center;
                    margin-bottom: 16px;
                }
                
                .setting-row:last-child {
                    margin-bottom: 0;
                }
                
                .setting-row label {
                    min-width: 100px;
                    font-size: 14px;
                    color: #666;
                }
                
                .setting-row select {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                }
                
                .checkbox-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .checkbox-label {
                    display: flex;
                    align-items: center;
                    font-size: 14px;
                    cursor: pointer;
                }
                
                .checkbox-label input[type="checkbox"] {
                    margin-right: 8px;
                }
                
                .practice-actions {
                    text-align: center;
                    margin-bottom: 20px;
                }
                
                .practice-btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .generate-btn {
                    background: linear-gradient(135deg, #007AFF, #0056CC);
                    color: white;
                    margin: 0 4px;
                    position: relative;
                    overflow: hidden;
                }
                
                .generate-btn:hover {
                    background: linear-gradient(135deg, #0056CC, #004499);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                }
                
                .preview-btn {
                    background: linear-gradient(135deg, #17a2b8, #138496);
                    color: white;
                    margin: 0 4px;
                }
                
                .preview-btn:hover {
                    background: linear-gradient(135deg, #138496, #117a8b);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
                }
                
                .practice-result {
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 20px;
                }
                
                .generated-question {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                    border-left: 4px solid #007AFF;
                }
                
                .question-number {
                    font-weight: 600;
                    color: #007AFF;
                    margin-bottom: 8px;
                }
                
                .question-content {
                    margin-bottom: 12px;
                    line-height: 1.5;
                }
                
                .question-answer {
                    background: #e8f5e8;
                    border-radius: 6px;
                    padding: 12px;
                    margin-top: 8px;
                }
                
                .answer-label {
                    font-weight: 500;
                    color: #2e7d32;
                    margin-bottom: 4px;
                }
                
                .export-actions {
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                    margin-top: 20px;
                    padding-top: 20px;
                    border-top: 1px solid #f0f0f0;
                }
                
                .export-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .pdf-btn { background: #e53e3e; color: white; }
                .word-btn { background: #2b6cb0; color: white; }
                .wechat-btn { background: #1aad19; color: white; }
                
                .pdf-btn:hover { background: #c53030; }
                .word-btn:hover { background: #2c5282; }
                .wechat-btn:hover { background: #16a113; }
                
                @media (max-width: 480px) {
                    .practice-modal-content {
                        margin: 10px;
                        max-width: none;
                    }
                    
                    .setting-row {
                        flex-direction: column;
                        align-items: flex-start;
                    }
                    
                    .setting-row label {
                        margin-bottom: 8px;
                    }
                    
                    .setting-row select {
                        width: 100%;
                    }
                    
                    .export-actions {
                        flex-direction: column;
                    }
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(practiceModal);
        }
        
        function closePracticeModal() {
            const modal = document.getElementById('practiceModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function showGenerationPreview(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('æ‰¾ä¸åˆ°è¯¥é”™é¢˜ä¿¡æ¯');
                return;
            }
            
            const questionCount = document.getElementById('questionCount').value;
            const difficultyLevel = document.getElementById('difficultyLevel').value;
            const questionType = document.getElementById('questionType').value;
            const includeAnswers = document.getElementById('includeAnswers').checked;
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            // æ˜¾ç¤ºç”Ÿæˆé¢„è§ˆä¿¡æ¯
            const previewHTML = `
                <div class="generation-preview">
                    <h4>ğŸ” ç”Ÿæˆé¢„è§ˆ</h4>
                    <div class="preview-grid">
                        <div class="preview-item">
                            <span class="preview-label">ğŸ“Š åŸé¢˜ä¿¡æ¯:</span>
                            <span class="preview-value">${error.subject} - ${error.error_type}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">ğŸ“ ç”Ÿæˆæ•°é‡:</span>
                            <span class="preview-value">${questionCount} é“é¢˜</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">âš™ï¸ éš¾åº¦è®¾ç½®:</span>
                            <span class="preview-value">${getDifficultyText(difficultyLevel)}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">ğŸ¯ é¢˜ç›®ç±»å‹:</span>
                            <span class="preview-value">${getQuestionTypeText(questionType)}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">âœ… åŒ…å«ç­”æ¡ˆ:</span>
                            <span class="preview-value">${includeAnswers ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">ğŸ’¡ åŒ…å«åˆ†æ:</span>
                            <span class="preview-value">${includeAnalysis ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>
                    <div class="preview-estimate">
                        <div class="estimate-item">
                            <span class="estimate-icon">â±ï¸</span>
                            <span class="estimate-text">é¢„è®¡ç”Ÿæˆæ—¶é—´: 5-10ç§’</span>
                        </div>
                        <div class="estimate-item">
                            <span class="estimate-icon">ğŸ²</span>
                            <span class="estimate-text">AIæ™ºèƒ½åˆ†æ: åŸºäºé”™é¢˜ç±»å‹å’Œå­¦ä¹ æ•°æ®</span>
                        </div>
                        <div class="estimate-item">
                            <span class="estimate-icon">ğŸ“ˆ</span>
                            <span class="estimate-text">é¢„æœŸæ•ˆæœ: é’ˆå¯¹æ€§ç»ƒä¹ ï¼Œæå‡å‡†ç¡®ç‡</span>
                        </div>
                    </div>
                    <div class="preview-tips">
                        <h5>ğŸ’¡ ç”Ÿæˆæç¤º:</h5>
                        <ul>
                            <li>ç³»ç»Ÿå°†åˆ†ææ‚¨çš„å­¦ä¹ æ°´å¹³å’Œé”™é¢˜ç‰¹å¾</li>
                            <li>ç”Ÿæˆç¬¦åˆæ‚¨èƒ½åŠ›çš„ä¸ªæ€§åŒ–ç»ƒä¹ é¢˜</li>
                            <li>å»ºè®®å…ˆä»ç›¸åŒéš¾åº¦å¼€å§‹ç»ƒä¹ </li>
                            <li>å¯ä»¥å¤šæ¬¡ç”Ÿæˆä¸åŒç±»å‹çš„ç»ƒä¹ é¢˜</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // å°†é¢„è§ˆä¿¡æ¯æ˜¾ç¤ºåœ¨ç»“æœåŒºåŸŸ
            const resultDiv = document.getElementById('practiceResult');
            resultDiv.innerHTML = previewHTML;
            resultDiv.style.display = 'block';
            
            // æ·»åŠ é¢„è§ˆæ ·å¼
            if (!document.getElementById('previewStyles')) {
                const style = document.createElement('style');
                style.id = 'previewStyles';
                style.textContent = `
                    .generation-preview {
                        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                        border-radius: 12px;
                        padding: 20px;
                        margin-top: 20px;
                        border: 1px solid #dee2e6;
                    }
                    
                    .generation-preview h4 {
                        margin: 0 0 16px 0;
                        color: #495057;
                        font-size: 16px;
                    }
                    
                    .preview-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 10px;
                        margin-bottom: 20px;
                    }
                    
                    .preview-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: white;
                        padding: 10px 12px;
                        border-radius: 6px;
                        border: 1px solid #e9ecef;
                    }
                    
                    .preview-label {
                        font-size: 14px;
                        color: #6c757d;
                        font-weight: 500;
                    }
                    
                    .preview-value {
                        font-size: 14px;
                        color: #495057;
                        font-weight: 600;
                    }
                    
                    .preview-estimate {
                        background: #e3f2fd;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 20px;
                        border-left: 4px solid #2196F3;
                    }
                    
                    .estimate-item {
                        display: flex;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    
                    .estimate-item:last-child {
                        margin-bottom: 0;
                    }
                    
                    .estimate-icon {
                        font-size: 16px;
                        margin-right: 8px;
                        width: 20px;
                    }
                    
                    .estimate-text {
                        font-size: 13px;
                        color: #1976D2;
                    }
                    
                    .preview-tips {
                        background: #fff3cd;
                        border-radius: 8px;
                        padding: 15px;
                        border-left: 4px solid #ffc107;
                    }
                    
                    .preview-tips h5 {
                        margin: 0 0 10px 0;
                        color: #856404;
                        font-size: 14px;
                    }
                    
                    .preview-tips ul {
                        margin: 0;
                        padding-left: 20px;
                    }
                    
                    .preview-tips li {
                        font-size: 13px;
                        color: #856404;
                        margin-bottom: 4px;
                        line-height: 1.4;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // å¹³æ»‘æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast('ğŸ“‹ ç”Ÿæˆé¢„è§ˆå·²æ˜¾ç¤ºï¼Œç¡®è®¤æ— è¯¯åç‚¹å‡»"AIæ™ºèƒ½ç”Ÿæˆ"');
        }
        
        function getDifficultyText(difficulty) {
            const texts = {
                'easier': 'ğŸŸ¢ ç®€åŒ–ç‰ˆ',
                'same': 'ğŸŸ¡ ç›¸åŒéš¾åº¦', 
                'harder': 'ğŸ”´ æé«˜ç‰ˆ',
                'mixed': 'ğŸŒˆ æ··åˆéš¾åº¦'
            };
            return texts[difficulty] || 'ğŸŸ¡ ç›¸åŒéš¾åº¦';
        }
        
        function getQuestionTypeText(type) {
            const texts = {
                'similar': 'ğŸ“‹ ç›¸ä¼¼é¢˜ç›®',
                'extended': 'ğŸ”„ æ‹“å±•å˜å¼',
                'comprehensive': 'ğŸ§  ç»¼åˆåº”ç”¨'
            };
            return texts[type] || 'ğŸ“‹ ç›¸ä¼¼é¢˜ç›®';
        }
        
        async function generatePractice(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('æ‰¾ä¸åˆ°è¯¥é”™é¢˜ä¿¡æ¯');
                return;
            }
            
            const questionCount = document.getElementById('questionCount').value;
            const difficultyLevel = document.getElementById('difficultyLevel').value;
            const questionType = document.getElementById('questionType').value;
            const includeAnswers = document.getElementById('includeAnswers').checked;
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            const generateBtn = document.querySelector('.generate-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = 'â³ AIç”Ÿæˆä¸­...';
            generateBtn.disabled = true;
            
            try {
                console.log('å¼€å§‹è°ƒç”¨AIç”Ÿæˆç»ƒä¹ é¢˜API...');
                console.log('é”™é¢˜ä¿¡æ¯:', error);
                
                // è°ƒç”¨çœŸæ­£çš„AIç”Ÿæˆç»ƒä¹ é¢˜API
                const response = await fetch(`${API_BASE}/practice/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        original_question: {
                            id: error.id,
                            subject: error.subject,
                            question_text: error.question_text,
                            user_answer: error.user_answer,
                            correct_answer: error.correct_answer,
                            error_type: error.error_type,
                            knowledge_points: error.knowledge_points || []
                        },
                        question_count: parseInt(questionCount),
                        difficulty_level: difficultyLevel,
                        question_type: questionType,
                        include_answers: includeAnswers,
                        include_analysis: includeAnalysis
                    })
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('AIç”Ÿæˆç»“æœ:', result);
                    
                    if (result.success && result.questions && result.questions.length > 0) {
                        // è½¬æ¢APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸ºå‰ç«¯æœŸæœ›çš„æ ¼å¼
                        const convertedQuestions = result.questions.map(q => ({
                            number: q.number,
                            difficulty: q.difficulty,
                            content: q.question_text,
                            answer: q.correct_answer,
                            analysis: q.analysis
                        }));
                        
                        displayGeneratedQuestions(convertedQuestions);
                        showToast(`âœ… AIæˆåŠŸç”Ÿæˆ${convertedQuestions.length}é“é«˜è´¨é‡ç»ƒä¹ é¢˜ï¼`);
                    } else {
                        throw new Error(result.message || 'AIç”Ÿæˆè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`AIç”Ÿæˆå¤±è´¥: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('AIç”Ÿæˆç»ƒä¹ é¢˜å¤±è´¥:', error);
                showToast(`âŒ AIç”Ÿæˆå¤±è´¥: ${error.message}`);
                
                // é™çº§åˆ°æœ¬åœ°æ¨¡æ‹Ÿç”Ÿæˆ
                console.log('é™çº§åˆ°æœ¬åœ°æ¨¡æ‹Ÿç”Ÿæˆ...');
                try {
                    const mockQuestions = generateMockQuestions(error, questionCount, difficultyLevel, includeAnswers, includeAnalysis);
                    displayGeneratedQuestions(mockQuestions);
                    showToast('âš ï¸ ä½¿ç”¨æœ¬åœ°æ™ºèƒ½ç”Ÿæˆï¼ˆAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼‰');
                } catch (mockError) {
                    console.error('æœ¬åœ°ç”Ÿæˆä¹Ÿå¤±è´¥:', mockError);
                    showToast('âŒ ç»ƒä¹ é¢˜ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }
        
        function generateMockQuestions(originalError, count, difficulty, includeAnswers, includeAnalysis) {
            const questions = [];
            const difficultyLabels = {
                'easier': 'ç®€å•',
                'same': 'ç›¸åŒ',
                'harder': 'å›°éš¾',
                'mixed': 'æ··åˆ'
            };
            
            for (let i = 1; i <= count; i++) {
                let question;
                
                if (originalError.subject === 'æ•°å­¦') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateMathQuestion(originalError, difficulty),
                        answer: generateMathAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else if (originalError.subject === 'è¯­æ–‡') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateChineseQuestion(originalError, difficulty),
                        answer: generateChineseAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else if (originalError.subject === 'è‹±è¯­') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateEnglishQuestion(originalError, difficulty),
                        answer: generateEnglishAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateGeneralQuestion(originalError, difficulty, i),
                        answer: generateGeneralAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                }
                
                questions.push(question);
            }
            
            return questions;
        }
        
        function generateMathQuestion(originalError, difficulty) {
            if (originalError.question_text.includes('Ã—')) {
                const bases = difficulty === 'easier' ? [15, 23, 34, 45] : 
                            difficulty === 'harder' ? [156, 234, 378, 456] : 
                            [125, 156, 234, 267];
                const multipliers = difficulty === 'easier' ? [6, 7, 8, 9] : 
                                  difficulty === 'harder' ? [12, 15, 18, 23] : 
                                  [8, 9, 11, 12];
                const base = bases[Math.floor(Math.random() * bases.length)];
                const mult = multipliers[Math.floor(Math.random() * multipliers.length)];
                return `è®¡ç®—ï¼š${base} Ã— ${mult} = ?`;
            } else if (originalError.question_text.includes('æ–¹ç¨‹')) {
                if (difficulty === 'easier') {
                    return `è§£æ–¹ç¨‹ï¼šx + ${Math.floor(Math.random() * 10) + 5} = ${Math.floor(Math.random() * 20) + 10}`;
                } else if (difficulty === 'harder') {
                    return `è§£æ–¹ç¨‹ï¼š${Math.floor(Math.random() * 3) + 2}x + ${Math.floor(Math.random() * 10) + 3} = ${Math.floor(Math.random() * 30) + 15}`;
                } else {
                    return `è§£æ–¹ç¨‹ï¼š${Math.floor(Math.random() * 2) + 2}x + ${Math.floor(Math.random() * 8) + 4} = ${Math.floor(Math.random() * 20) + 12}`;
                }
            } else {
                return `æ ¹æ®åŸé¢˜ç‰¹ç‚¹ç”Ÿæˆçš„${difficulty === 'easier' ? 'ç®€åŒ–ç‰ˆ' : difficulty === 'harder' ? 'æé«˜ç‰ˆ' : 'åŒç­‰éš¾åº¦'}æ•°å­¦é¢˜ç›®`;
            }
        }
        
        function generateChineseQuestion(originalError, difficulty) {
            if (originalError.question_text.includes('ä½œè€…')) {
                const works = difficulty === 'easier' ? 
                    ['ã€Šæ˜¥æ™“ã€‹', 'ã€Šç™»é¹³é›€æ¥¼ã€‹', 'ã€Šé™å¤œæ€ã€‹'] :
                    difficulty === 'harder' ?
                    ['ã€Šæ»•ç‹é˜åºã€‹', 'ã€Šå²³é˜³æ¥¼è®°ã€‹', 'ã€Šèµ¤å£èµ‹ã€‹'] :
                    ['ã€Šæ˜¥æœ›ã€‹', 'ã€Šæœ›å²³ã€‹', 'ã€ŠèŒ…å±‹ä¸ºç§‹é£æ‰€ç ´æ­Œã€‹'];
                const work = works[Math.floor(Math.random() * works.length)];
                return `è¯·å†™å‡º${work}çš„ä½œè€…`;
            } else if (originalError.question_text.includes('è¯è¯­') || originalError.question_text.includes('é”™åˆ«å­—')) {
                return `ä¸‹åˆ—è¯è¯­ä¸­ï¼Œ${difficulty === 'harder' ? 'ä¹¦å†™å®Œå…¨æ­£ç¡®ä¸”å«ä¹‰æ°å½“' : 'æ²¡æœ‰é”™åˆ«å­—'}çš„ä¸€ç»„æ˜¯ï¼ˆï¼‰`;
            } else {
                return `æ ¹æ®åŸé¢˜ç‰¹ç‚¹ç”Ÿæˆçš„${difficulty === 'easier' ? 'åŸºç¡€ç‰ˆ' : difficulty === 'harder' ? 'æé«˜ç‰ˆ' : 'åŒç­‰éš¾åº¦'}è¯­æ–‡é¢˜ç›®`;
            }
        }
        
        function generateEnglishQuestion(originalError, difficulty) {
            if (originalError.question_text.toLowerCase().includes('choose') || originalError.question_text.includes('go')) {
                const subjects = ['I', 'He', 'She', 'They', 'We'];
                const verbs = difficulty === 'easier' ? ['go', 'come', 'eat', 'play'] :
                             difficulty === 'harder' ? ['have been going', 'will have gone', 'had gone'] :
                             ['goes', 'went', 'will go', 'is going'];
                const subject = subjects[Math.floor(Math.random() * subjects.length)];
                const verb = verbs[Math.floor(Math.random() * verbs.length)];
                return `Choose the correct answer: ${subject} _____ to school every day. (${verb})`;
            } else if (originalError.question_text.toLowerCase().includes('translate')) {
                if (difficulty === 'easier') {
                    return 'Translate: I like music.';
                } else if (difficulty === 'harder') {
                    return 'Translate: Despite the challenging circumstances, she managed to achieve her goals.';
                } else {
                    return 'Translate: I enjoy reading books in my spare time.';
                }
            } else {
                return `æ ¹æ®åŸé¢˜ç‰¹ç‚¹ç”Ÿæˆçš„${difficulty === 'easier' ? 'åŸºç¡€ç‰ˆ' : difficulty === 'harder' ? 'æé«˜ç‰ˆ' : 'åŒç­‰éš¾åº¦'}è‹±è¯­é¢˜ç›®`;
            }
        }
        
        function generateGeneralQuestion(originalError, difficulty, index) {
            return `${originalError.subject}ç»ƒä¹ é¢˜ ${index}ï¼šåŸºäº"${originalError.error_type}"çš„${difficulty === 'easier' ? 'ç®€åŒ–' : difficulty === 'harder' ? 'æé«˜' : 'åŒç­‰éš¾åº¦'}ç»ƒä¹ `;
        }
        
        function generateMathAnswer(index) {
            const answers = ['1000', '1872', '2016', '3588', '4104', '2805', '1380', '1584', '2457', '3402'];
            return answers[index % answers.length];
        }
        
        function generateChineseAnswer(index) {
            const answers = ['æç™½', 'æœç”«', 'ç™½å±…æ˜“', 'C', 'B', 'A', 'ä¸»è¯­', 'è°“è¯­', 'å®šè¯­', 'çŠ¶è¯­'];
            return answers[index % answers.length];
        }
        
        function generateEnglishAnswer(index) {
            const answers = ['go', 'goes', 'went', 'æˆ‘å–œæ¬¢éŸ³ä¹', 'æˆ‘å–œæ¬¢åœ¨ç©ºé—²æ—¶é—´è¯»ä¹¦', 'She goes', 'They play', 'We eat'];
            return answers[index % answers.length];
        }
        
        function generateGeneralAnswer(index) {
            return `ç­”æ¡ˆ ${index}`;
        }
        
        function generateAnalysis(subject, index) {
            const analyses = {
                'æ•°å­¦': [
                    'æœ¬é¢˜è€ƒæŸ¥ä¹˜æ³•è¿ç®—ï¼Œéœ€è¦æŒæ¡å¤šä½æ•°ä¹˜æ³•çš„è®¡ç®—æ–¹æ³•ï¼Œæ³¨æ„è¿›ä½å¤„ç†',
                    'è§£ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹çš„åŸºæœ¬æ­¥éª¤ï¼šç§»é¡¹ã€åˆå¹¶åŒç±»é¡¹ã€ç³»æ•°åŒ–ä¸º1',
                    'åœ†çš„é¢ç§¯å…¬å¼ S = Ï€rÂ²ï¼Œæ³¨æ„Ï€çš„å–å€¼å’Œå°æ•°ç²¾åº¦',
                    'ä¸‰è§’å½¢å†…è§’å’Œå®šç†ï¼šä»»æ„ä¸‰è§’å½¢çš„ä¸‰ä¸ªå†…è§’ä¹‹å’Œä¸º180Â°'
                ],
                'è¯­æ–‡': [
                    'å¤è¯—æ–‡ä½œè€…è¯†è®°æ˜¯è¯­æ–‡åŸºç¡€çŸ¥è¯†ï¼Œéœ€è¦ç§¯ç´¯é‡è¦ä½œå“å’Œå¯¹åº”ä½œè€…',
                    'é”™åˆ«å­—è¾¨æè¦æ³¨æ„å½¢è¿‘å­—ã€éŸ³è¿‘å­—çš„åŒºåˆ«ï¼ŒåŸ¹å…»è‰¯å¥½çš„ä¹¦å†™ä¹ æƒ¯',
                    'æ–‡è¨€æ–‡ç¿»è¯‘è¦æ³¨æ„è¯è¯­çš„å¤ä»Šå¼‚ä¹‰ï¼Œç»“åˆè¯­å¢ƒç†è§£',
                    'å¥å­æˆåˆ†åˆ†æï¼šä¸»è¯­è¡¨ç¤ºåŠ¨ä½œçš„æ‰§è¡Œè€…ï¼Œè°“è¯­è¡¨ç¤ºåŠ¨ä½œæˆ–çŠ¶æ€'
                ],
                'è‹±è¯­': [
                    'ä¸€èˆ¬ç°åœ¨æ—¶ç¬¬ä¸‰äººç§°å•æ•°å½¢å¼ï¼šä¸»è¯­ä¸ºhe/she/itæ—¶ï¼ŒåŠ¨è¯è¦åŠ -sæˆ–-es',
                    'è‹±æ±‰äº’è¯‘è¦æ³¨æ„è¯­åºå·®å¼‚ï¼Œè‹±è¯­å¤šç”¨ä¸»è°“å®¾ç»“æ„',
                    'æ—¶æ€é€‰æ‹©è¦æ ¹æ®æ—¶é—´çŠ¶è¯­å’Œè¯­å¢ƒåˆ¤æ–­ï¼Œæ³¨æ„æ—¶æ€ä¸€è‡´æ€§',
                    'è¯æ±‡ç§¯ç´¯æ˜¯è‹±è¯­å­¦ä¹ çš„åŸºç¡€ï¼Œè¦æ³¨æ„å•è¯çš„è¯æ€§å’Œç”¨æ³•'
                ]
            };
            
            const subjectAnalyses = analyses[subject] || ['è¿™æ˜¯ä¸€é“åŸºç¡€ç»ƒä¹ é¢˜ï¼Œéœ€è¦æŒæ¡ç›¸å…³æ¦‚å¿µå’Œæ–¹æ³•'];
            return subjectAnalyses[(index - 1) % subjectAnalyses.length];
        }
        
        function displayGeneratedQuestions(questions) {
            const resultDiv = document.getElementById('practiceResult');
            const includeAnswers = document.getElementById('includeAnswers').checked;
            
            let html = `
                <div class="result-header">
                    <h4>ğŸ“‹ ç”Ÿæˆçš„ç»ƒä¹ é¢˜ï¼ˆå…±${questions.length}é¢˜ï¼‰</h4>
                </div>
                <div class="questions-container">
            `;
            
            questions.forEach(question => {
                const difficultyBadge = getDifficultyBadge(question.difficulty);
                html += `
                    <div class="generated-question">
                        <div class="question-number">
                            ç¬¬${question.number}é¢˜ ${difficultyBadge}
                        </div>
                        <div class="question-content">
                            ${question.content}
                        </div>
                `;
                
                if (includeAnswers && question.answer) {
                    html += `
                        <div class="question-answer">
                            <div class="answer-label">ğŸ’¡ å‚è€ƒç­”æ¡ˆï¼š</div>
                            <div>${question.answer}</div>
                        </div>
                    `;
                }
                
                if (question.analysis) {
                    html += `
                        <div class="question-answer" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <div class="answer-label" style="color: #856404;">ğŸ“– è§£é¢˜æ€è·¯ï¼š</div>
                            <div style="color: #856404;">${question.analysis}</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `
                </div>
                <div class="export-actions">
                    <button class="export-btn word-btn" onclick="exportToWord(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                        ğŸ“ å¯¼å‡ºWord
                    </button>
                    <button class="export-btn wechat-btn" onclick="shareToWechat(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                        ğŸ’š å¾®ä¿¡åˆ†äº«
                    </button>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast(`âœ… æˆåŠŸç”Ÿæˆ${questions.length}é“ç»ƒä¹ é¢˜ï¼`);
        }
        
        function getDifficultyBadge(difficulty) {
            const badges = {
                'easier': '<span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size: 12px;">ç®€å•</span>',
                'same': '<span style="background: #cce5ff; color: #004085; padding: 2px 8px; border-radius: 12px; font-size: 12px;">ç›¸åŒ</span>',
                'harder': '<span style="background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 12px; font-size: 12px;">å›°éš¾</span>'
            };
            return badges[difficulty] || badges['same'];
        }
        
        
        
        function generatePrintHTML(questions) {
            const timestamp = new Date().toLocaleString();
            
            return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ƒä¹ é¢˜é›†</title>
    <style>
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20mm;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 20px;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 10px;
        }
        
        .meta {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .question {
            margin-bottom: 25px;
            page-break-inside: avoid;
            border-left: 4px solid #007AFF;
            padding-left: 15px;
        }
        
        .question-number {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 8px;
        }
        
        .question-content {
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.8;
        }
        
        .answer {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            border-left: 3px solid #28a745;
        }
        
        .analysis {
            background: #fff8dc;
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            border-left: 3px solid #ffc107;
        }
        
        .label {
            font-weight: bold;
            color: #555;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .difficulty-easier { background: #d4edda; color: #155724; }
        .difficulty-same { background: #cce5ff; color: #004085; }
        .difficulty-harder { background: #f8d7da; color: #721c24; }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        @page {
            size: A4;
            margin: 15mm;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ“š ç»ƒä¹ é¢˜é›†</div>
        <div class="meta">ç”Ÿæˆæ—¶é—´ï¼š${timestamp}</div>
        <div class="meta">é¢˜ç›®æ•°é‡ï¼š${questions.length} é“</div>
    </div>
    
    ${questions.map((question, index) => {
        const difficultyClass = `difficulty-${question.difficulty}`;
        const difficultyText = getDifficultyText(question.difficulty);
        
        return `
    <div class="question">
        <div class="question-number">
            ç¬¬${question.number}é¢˜
            <span class="difficulty-badge ${difficultyClass}">${difficultyText}</span>
        </div>
        <div class="question-content">${question.content}</div>
        ${question.answer ? `
        <div class="answer">
            <span class="label">ğŸ’¡ å‚è€ƒç­”æ¡ˆï¼š</span>${question.answer}
        </div>
        ` : ''}
        ${question.analysis ? `
        <div class="analysis">
            <span class="label">ğŸ“– è§£é¢˜æ€è·¯ï¼š</span>${question.analysis}
        </div>
        ` : ''}
    </div>
        `;
    }).join('')}
    
    <div class="footer">
        <p>ğŸ“± ZYJCæ™ºèƒ½æ‰¹æ”¹ç³»ç»Ÿç”Ÿæˆ</p>
        <p>ç”Ÿæˆæ—¶é—´ï¼š${timestamp}</p>
    </div>
</body>
</html>
            `;
        }
        
        function convertToSafeText(text) {
            if (!text) return '';
            
            // ä¿ç•™åŸºç¡€ä¸­æ–‡å­—ç¬¦ï¼Œæ›¿æ¢ç‰¹æ®Šå­—ç¬¦ä¸ºå®‰å…¨å­—ç¬¦
            return text
                .replace(/[^\u0000-\u007F\u4e00-\u9fff]/g, '') // ä¿ç•™ASCIIå’Œä¸­æ–‡å­—ç¬¦
                .replace(/[""]/g, '"') // æ›¿æ¢ç‰¹æ®Šå¼•å·
                .replace(/['']/g, "'") // æ›¿æ¢ç‰¹æ®Šå•å¼•å·
                .replace(/â€¦/g, '...') // æ›¿æ¢çœç•¥å·
                .replace(/â€”/g, '-') // æ›¿æ¢é•¿ç ´æŠ˜å·
                .replace(/Â·/g, '.') // æ›¿æ¢é—´éš”å·
                .trim();
        }
        
        
        
        function closeDebugModal() {
            const modal = document.getElementById('debugModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        
        
        function exportAsHTML() {
            if (!window.debugQuestions) {
                showToast('æ²¡æœ‰æ‰¾åˆ°è°ƒè¯•é¢˜ç›®æ•°æ®');
                return;
            }
            
            exportToHTML(window.debugQuestions);
            showToast('å·²å¯¼å‡ºä¸ºHTMLæ ¼å¼');
        }
        
        
        
        function exportToHTML(questions) {
            try {
                showToast('æ­£åœ¨ç”ŸæˆHTMLæ–‡ä»¶...');
                
                let htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ƒä¹ é¢˜é›†</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 20px;
        }
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 10px;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .question {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
        }
        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 12px;
        }
        .question-content {
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        .answer {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .analysis {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }
        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .difficulty-easier { background: #d4edda; color: #155724; }
        .difficulty-same { background: #cce5ff; color: #004085; }
        .difficulty-harder { background: #f8d7da; color: #721c24; }
        
        @media print {
            body { margin: 0; padding: 20px; }
            .question { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ“š ç»ƒä¹ é¢˜é›†</div>
        <div class="info">ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</div>
        <div class="info">é¢˜ç›®æ•°é‡ï¼š${questions.length} é“</div>
    </div>
`;
                
                questions.forEach(question => {
                    const difficultyClass = `difficulty-${question.difficulty}`;
                    const difficultyText = getDifficultyText(question.difficulty);
                    
                    htmlContent += `
    <div class="question">
        <div class="question-number">
            ç¬¬${question.number}é¢˜
            <span class="difficulty-badge ${difficultyClass}">${difficultyText}</span>
        </div>
        <div class="question-content">${question.content}</div>
`;
                    
                    if (question.answer) {
                        htmlContent += `
        <div class="answer">
            <span class="label">ğŸ’¡ å‚è€ƒç­”æ¡ˆ</span>
            ${question.answer}
        </div>
`;
                    }
                    
                    if (question.analysis) {
                        htmlContent += `
        <div class="analysis">
            <span class="label">ğŸ“– è§£é¢˜æ€è·¯</span>
            ${question.analysis}
        </div>
`;
                    }
                    
                    htmlContent += `    </div>`;
                });
                
                htmlContent += `
</body>
</html>
`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ç»ƒä¹ é¢˜é›†-${new Date().toLocaleDateString().replace(/\//g, '')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('âœ… HTMLæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼å¯ç”¨æµè§ˆå™¨æ‰“å¼€åæ‰“å°ä¸ºPDF');
                
            } catch (error) {
                console.error('HTMLå¯¼å‡ºå¤±è´¥:', error);
                exportToText(questions, 'HTML');
            }
        }
        
        async function exportToWord(questions) {
            try {
                showToast('æ­£åœ¨ç”ŸæˆWordæ–‡æ¡£...');
                
                // åˆ›å»ºWordæ–‡æ¡£å†…å®¹
                let docContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ç»ƒä¹ é¢˜é›†</title>
    <style>
        body { font-family: 'å¾®è½¯é›…é»‘', Arial; margin: 40px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; }
        .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .date { font-size: 12px; color: #666; }
        .question { margin-bottom: 25px; page-break-inside: avoid; }
        .question-number { font-size: 16px; font-weight: bold; color: #007AFF; margin-bottom: 8px; }
        .question-content { font-size: 14px; margin-bottom: 10px; }
        .answer { background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 8px 0; }
        .analysis { background: #fff8dc; padding: 10px; border-radius: 5px; margin: 8px 0; }
        .label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ç»ƒä¹ é¢˜é›†</div>
        <div class="date">ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</div>
    </div>
`;
                
                questions.forEach(question => {
                    docContent += `
    <div class="question">
        <div class="question-number">ç¬¬${question.number}é¢˜ (${getDifficultyText(question.difficulty)})</div>
        <div class="question-content">${question.content}</div>
`;
                    
                    if (question.answer) {
                        docContent += `
        <div class="answer">
            <span class="label">å‚è€ƒç­”æ¡ˆï¼š</span>${question.answer}
        </div>
`;
                    }
                    
                    if (question.analysis) {
                        docContent += `
        <div class="analysis">
            <span class="label">è§£é¢˜æ€è·¯ï¼š</span>${question.analysis}
        </div>
`;
                    }
                    
                    docContent += `    </div>`;
                });
                
                docContent += `
</body>
</html>
`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([docContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ç»ƒä¹ é¢˜é›†.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('âœ… Wordæ–‡æ¡£ä¸‹è½½æˆåŠŸï¼');
                
            } catch (error) {
                console.error('Wordå¯¼å‡ºå¤±è´¥:', error);
                exportToText(questions, 'Word');
            }
        }
        
        function exportToText(questions, format) {
            let content = `ç»ƒä¹ é¢˜é›†\nç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
            
            questions.forEach(question => {
                content += `ç¬¬${question.number}é¢˜ (${getDifficultyText(question.difficulty)})\n`;
                content += `${question.content}\n`;
                
                if (question.answer) {
                    content += `å‚è€ƒç­”æ¡ˆï¼š${question.answer}\n`;
                }
                
                if (question.analysis) {
                    content += `è§£é¢˜æ€è·¯ï¼š${question.analysis}\n`;
                }
                
                content += '\n---\n\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ç»ƒä¹ é¢˜é›†.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`âœ… ${format}æ ¼å¼å¯¼å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶æˆåŠŸï¼`);
        }
        
        function getDifficultyText(difficulty) {
            const texts = {
                'easier': 'ç®€å•',
                'same': 'ç›¸åŒéš¾åº¦',
                'harder': 'å›°éš¾'
            };
            return texts[difficulty] || 'ç›¸åŒéš¾åº¦';
        }
        
        function shareToWechat(questions) {
            // æ˜¾ç¤ºåˆ†äº«é€‰é¡¹èœå•
            showShareOptionsModal(questions);
        }
        
        function showShareOptionsModal(questions) {
            const shareModal = document.createElement('div');
            shareModal.id = 'shareOptionsModal';
            shareModal.innerHTML = `
                <div class="share-options-overlay" onclick="closeShareOptionsModal()">
                    <div class="share-options-content" onclick="event.stopPropagation()">
                        <div class="share-options-header">
                            <h3>ğŸ“¤ é€‰æ‹©åˆ†äº«æ–¹å¼</h3>
                            <button onclick="closeShareOptionsModal()" class="close-share-btn">Ã—</button>
                        </div>
                        <div class="share-options-body">
                            <div class="share-option" onclick="shareAsText(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">ğŸ“</div>
                                <div class="share-info">
                                    <div class="share-title">æ–‡æœ¬å½¢å¼</div>
                                    <div class="share-desc">å¤åˆ¶é¢˜ç›®æ–‡æœ¬ï¼Œæ–¹ä¾¿ç²˜è´´åˆ°å¾®ä¿¡</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareAsImage(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">ğŸ–¼ï¸</div>
                                <div class="share-info">
                                    <div class="share-title">å›¾ç‰‡å½¢å¼</div>
                                    <div class="share-desc">ç”Ÿæˆç»ƒä¹ é¢˜å›¾ç‰‡ï¼Œç›´æ¥å‘é€åˆ°å¾®ä¿¡</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareAsLink(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">ğŸ”—</div>
                                <div class="share-info">
                                    <div class="share-title">é“¾æ¥å½¢å¼</div>
                                    <div class="share-desc">ç”Ÿæˆåœ¨çº¿ç»ƒä¹ é“¾æ¥ï¼Œå®æ—¶äº’åŠ¨</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareToWechatDirect(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">ğŸ’š</div>
                                <div class="share-info">
                                    <div class="share-title">ç›´æ¥å‘å¾®ä¿¡</div>
                                    <div class="share-desc">åœ¨æ‰‹æœºä¸Šç›´æ¥è·³è½¬åˆ°å¾®ä¿¡åˆ†äº«</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareToSystem(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">ğŸ“±</div>
                                <div class="share-info">
                                    <div class="share-title">ç³»ç»Ÿåˆ†äº«</div>
                                    <div class="share-desc">ä½¿ç”¨è®¾å¤‡è‡ªå¸¦åˆ†äº«åŠŸèƒ½</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .share-options-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .share-options-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .share-options-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .share-options-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .share-options-body {
                    padding: 10px;
                }
                
                .share-option {
                    display: flex;
                    align-items: center;
                    padding: 15px;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: background-color 0.3s ease;
                    margin-bottom: 5px;
                }
                
                .share-option:hover {
                    background: #f8f9fa;
                }
                
                .share-icon {
                    font-size: 24px;
                    margin-right: 15px;
                    width: 40px;
                    text-align: center;
                }
                
                .share-info {
                    flex: 1;
                }
                
                .share-title {
                    font-size: 16px;
                    font-weight: 500;
                    color: #333;
                    margin-bottom: 4px;
                }
                
                .share-desc {
                    font-size: 13px;
                    color: #666;
                    line-height: 1.4;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(shareModal);
        }
        
        function closeShareOptionsModal() {
            const modal = document.getElementById('shareOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function shareAsText(questions) {
            closeShareOptionsModal();
            
            // åˆ›å»ºç®€æ´çš„æ–‡æœ¬åˆ†äº«å†…å®¹
            let shareText = `ğŸ“š ç»ƒä¹ é¢˜é›† (${questions.length}é¢˜)\n`;
            shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            
            questions.forEach((question, index) => {
                shareText += `${question.number}. ${question.content}\n`;
                
                if (question.answer && document.getElementById('includeAnswers').checked) {
                    shareText += `ğŸ’¡ ${question.answer}\n`;
                }
                
                if (question.analysis && document.getElementById('includeAnalysis').checked) {
                    shareText += `ğŸ“– ${question.analysis}\n`;
                }
                
                shareText += '\n';
            });
            
            shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            shareText += `ğŸ“… ${new Date().toLocaleString()}\n`;
            shareText += `ğŸ”— ZYJCæ™ºèƒ½æ‰¹æ”¹ç”Ÿæˆ`;
            
            fallbackShare(shareText);
        }
        
        async function shareAsImage(questions) {
            closeShareOptionsModal();
            
            try {
                showToast('æ­£åœ¨ç”Ÿæˆåˆ†äº«å›¾ç‰‡...');
                
                // åˆ›å»ºcanvasç”Ÿæˆå›¾ç‰‡
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è®¾ç½®canvaså°ºå¯¸
                canvas.width = 600;
                canvas.height = Math.max(800, questions.length * 200 + 200);
                
                // è®¾ç½®èƒŒæ™¯
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // è®¾ç½®å­—ä½“
                ctx.font = '24px Microsoft YaHei';
                ctx.fillStyle = '#007AFF';
                ctx.textAlign = 'center';
                
                // æ ‡é¢˜
                ctx.fillText(`ğŸ“š ç»ƒä¹ é¢˜é›† (${questions.length}é¢˜)`, canvas.width / 2, 50);
                
                // æ—¶é—´
                ctx.font = '14px Microsoft YaHei';
                ctx.fillStyle = '#666';
                ctx.fillText(new Date().toLocaleString(), canvas.width / 2, 80);
                
                let yPosition = 120;
                
                questions.forEach((question, index) => {
                    // é¢˜ç›®
                    ctx.font = '16px Microsoft YaHei';
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'left';
                    
                    const questionText = `${question.number}. ${question.content}`;
                    const lines = wrapText(ctx, questionText, 50, 500);
                    
                    lines.forEach((line, lineIndex) => {
                        ctx.fillText(line, 50, yPosition + lineIndex * 25);
                    });
                    
                    yPosition += lines.length * 25 + 10;
                    
                    // ç­”æ¡ˆ
                    if (question.answer && document.getElementById('includeAnswers').checked) {
                        ctx.font = '14px Microsoft YaHei';
                        ctx.fillStyle = '#2e7d32';
                        ctx.fillText(`ğŸ’¡ ${question.answer}`, 70, yPosition);
                        yPosition += 25;
                    }
                    
                    yPosition += 20; // é¢˜ç›®é—´è·
                });
                
                // è½¬æ¢ä¸ºblobå¹¶ä¸‹è½½
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ç»ƒä¹ é¢˜é›†-${new Date().toLocaleDateString().replace(/\//g, '')}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showToast('âœ… å›¾ç‰‡å·²ä¸‹è½½ï¼Œå¯ç›´æ¥å‘é€åˆ°å¾®ä¿¡ï¼');
                });
                
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                showToast('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·ä½¿ç”¨æ–‡æœ¬åˆ†äº«');
                shareAsText(questions);
            }
        }
        
        function wrapText(ctx, text, x, maxWidth) {
            const words = text.split('');
            const lines = [];
            let currentLine = '';
            
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i];
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        function shareAsLink(questions) {
            closeShareOptionsModal();
            
            try {
                // ç”Ÿæˆä¸€ä¸ªç®€å•çš„åˆ†äº«é“¾æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰
                const questionsData = encodeURIComponent(JSON.stringify(questions));
                const shareUrl = `${window.location.origin}/practice-view.html?data=${questionsData.substring(0, 500)}...`;
                
                const shareText = `ğŸ“š æˆ‘ç”Ÿæˆäº†ä¸€å¥—ç»ƒä¹ é¢˜ï¼Œå¿«æ¥æŒ‘æˆ˜å§ï¼\n\n` +
                                `ğŸ”¢ é¢˜ç›®æ•°é‡ï¼š${questions.length}é“\n` +
                                `ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n` +
                                `ğŸ‘† ç‚¹å‡»é“¾æ¥å¼€å§‹ç»ƒä¹ ï¼š\n${shareUrl}\n\n` +
                                `ğŸ”— ç”±ZYJCæ™ºèƒ½æ‰¹æ”¹ç”Ÿæˆ`;
                
                fallbackShare(shareText);
                
            } catch (error) {
                console.error('ç”Ÿæˆé“¾æ¥å¤±è´¥:', error);
                shareAsText(questions);
            }
        }
        
        function shareToWechatDirect(questions) {
            closeShareOptionsModal();
            
            try {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                if (!isMobileDevice()) {
                    showToast('ç›´æ¥åˆ†äº«å¾®ä¿¡åŠŸèƒ½ä»…æ”¯æŒæ‰‹æœºç«¯ï¼Œè¯·ä½¿ç”¨å…¶ä»–åˆ†äº«æ–¹å¼');
                    shareAsText(questions);
                    return;
                }
                
                // å‡†å¤‡åˆ†äº«å†…å®¹
                const shareText = createWechatShareText(questions);
                
                // å…ˆå°†å†…å®¹å¤åˆ¶åˆ°å‰ªè´´æ¿
                copyToClipboard(shareText).then(() => {
                    showToast('ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    
                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿å¤åˆ¶å®Œæˆ
                    setTimeout(() => {
                        // å°è¯•å¤šç§æ–¹å¼è°ƒç”¨å¾®ä¿¡
                        if (openWechatApp(shareText)) {
                            showToast('ğŸ’š æ­£åœ¨æ‰“å¼€å¾®ä¿¡...');
                        } else {
                            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ“ä½œæŒ‡å¼•
                            showWechatGuide(shareText);
                        }
                    }, 500);
                    
                }).catch(error => {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    showWechatGuide(shareText);
                });
                
            } catch (error) {
                console.error('å¾®ä¿¡åˆ†äº«å¤±è´¥:', error);
                shareAsText(questions);
            }
        }
        
        function createWechatShareText(questions) {
            const includeAnswers = document.getElementById('includeAnswers')?.checked;
            const includeAnalysis = document.getElementById('includeAnalysis')?.checked;
            
            let shareText = `ğŸ“š ç»ƒä¹ é¢˜é›† (${questions.length}é¢˜)\n`;
            shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            
            questions.forEach((question, index) => {
                shareText += `${question.number}. ${question.content}\n`;
                
                if (includeAnswers && question.answer) {
                    shareText += `ğŸ’¡ ${question.answer}\n`;
                }
                
                if (includeAnalysis && question.analysis) {
                    shareText += `ğŸ“– ${question.analysis}\n`;
                }
                
                shareText += '\n';
            });
            
            shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            shareText += `ğŸ“… ${new Date().toLocaleString()}\n`;
            shareText += `ğŸ”— ZYJCæ™ºèƒ½æ‰¹æ”¹ç”Ÿæˆ`;
            
            return shareText;
        }
        
        async function copyToClipboard(text) {
            try {
                // ä¼˜å…ˆä½¿ç”¨ç°ä»£API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return;
                }
                
                // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶textarea
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                textArea.style.opacity = '0';
                textArea.style.pointerEvents = 'none';
                textArea.style.zIndex = '-1';
                
                document.body.appendChild(textArea);
                
                // ç¡®ä¿å…ƒç´ è·å¾—ç„¦ç‚¹
                textArea.focus();
                textArea.select();
                
                // ç§»åŠ¨è®¾å¤‡å…¼å®¹
                if (textArea.setSelectionRange) {
                    textArea.setSelectionRange(0, text.length);
                }
                
                return new Promise((resolve, reject) => {
                    try {
                        const success = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (success) {
                            resolve();
                        } else {
                            reject(new Error('execCommandå¤åˆ¶å¤±è´¥'));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
                
            } catch (error) {
                throw error;
            }
        }
        
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileKeywords = [
                'android', 'webos', 'iphone', 'ipad', 'ipod', 
                'blackberry', 'iemobile', 'opera mini', 'mobile',
                'windows phone', 'kindle', 'silk', 'fennec'
            ];
            
            return mobileKeywords.some(keyword => userAgent.includes(keyword));
        }
        
        function openWechatApp(shareText) {
            try {
                const userAgent = navigator.userAgent.toLowerCase();
                const isInWechat = userAgent.includes('micromessenger');
                
                if (isInWechat) {
                    // å¦‚æœå·²ç»åœ¨å¾®ä¿¡ä¸­ï¼Œç›´æ¥æç¤ºåˆ†äº«
                    showToast('âœ… å†…å®¹å·²å‡†å¤‡å¥½ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«æŒ‰é’®');
                    return true;
                }
                
                // å°è¯•è°ƒç”¨å¾®ä¿¡URL Scheme
                const wechatSchemes = [
                    'weixin://',  // å¾®ä¿¡ä¸»è¦scheme
                    'wechat://',  // å¤‡ç”¨scheme
                ];
                
                let success = false;
                
                // iOSè®¾å¤‡
                if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                    // å°è¯•iOSçš„Universal Linkå’ŒURL Scheme
                    const iosLinks = [
                        'weixin://dl/general',  // å¾®ä¿¡é€šç”¨é“¾æ¥
                        'weixin://dl/chat',     // å¾®ä¿¡èŠå¤©
                        'weixin://',            // åŸºæœ¬scheme
                    ];
                    
                    for (const link of iosLinks) {
                        try {
                            window.location.href = link;
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    // iOSå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨hidden iframe
                    if (!success) {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = 'weixin://';
                        document.body.appendChild(iframe);
                        
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                        }, 1000);
                        
                        success = true;
                    }
                }
                
                // Androidè®¾å¤‡
                else if (userAgent.includes('android')) {
                    // Android Intentæ–¹å¼
                    const androidIntents = [
                        'intent://dl/general/#Intent;scheme=weixin;package=com.tencent.mm;end',
                        'intent:///#Intent;scheme=weixin;package=com.tencent.mm;S.android.intent.extra.TEXT=' + encodeURIComponent(shareText) + ';type=text/plain;end',
                    ];
                    
                    for (const intent of androidIntents) {
                        try {
                            window.location.href = intent;
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    // Androidå¤‡ç”¨æ–¹æ¡ˆ
                    if (!success) {
                        try {
                            window.location.href = 'weixin://';
                            success = true;
                        } catch (e) {
                            // æœ€åå°è¯•é€šè¿‡app storeé“¾æ¥
                            window.location.href = 'market://details?id=com.tencent.mm';
                            success = true;
                        }
                    }
                }
                
                return success;
                
            } catch (error) {
                console.error('æ‰“å¼€å¾®ä¿¡å¤±è´¥:', error);
                return false;
            }
        }
        
        function showWechatGuide(shareText) {
            // åˆ›å»ºå¾®ä¿¡æ“ä½œæŒ‡å¼•æ¨¡æ€æ¡†
            const guideModal = document.createElement('div');
            guideModal.id = 'wechatGuideModal';
            guideModal.innerHTML = `
                <div class="wechat-guide-overlay" onclick="closeWechatGuide()">
                    <div class="wechat-guide-content" onclick="event.stopPropagation()">
                        <div class="wechat-guide-header">
                            <h3>ğŸ’š å¾®ä¿¡åˆ†äº«æŒ‡å¼•</h3>
                            <button onclick="closeWechatGuide()" class="close-guide-btn">Ã—</button>
                        </div>
                        <div class="wechat-guide-body">
                            <div class="guide-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">å†…å®¹å·²å¤åˆ¶</div>
                                    <div class="step-desc">ç»ƒä¹ é¢˜å†…å®¹å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">æ‰“å¼€å¾®ä¿¡</div>
                                    <div class="step-desc">
                                        <button class="open-wechat-btn" onclick="tryOpenWechat()">
                                            ç‚¹å‡»æ‰“å¼€å¾®ä¿¡ ğŸ’š
                                        </button>
                                        <div class="or-text">æˆ–æ‰‹åŠ¨æ‰“å¼€å¾®ä¿¡App</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">é€‰æ‹©åˆ†äº«å¯¹è±¡</div>
                                    <div class="step-desc">é€‰æ‹©å¥½å‹ã€ç¾¤èŠæˆ–æœ‹å‹åœˆ</div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">ç²˜è´´å†…å®¹</div>
                                    <div class="step-desc">é•¿æŒ‰è¾“å…¥æ¡†ï¼Œé€‰æ‹©"ç²˜è´´"å³å¯</div>
                                </div>
                            </div>
                            
                            <div class="preview-section">
                                <div class="preview-title">ğŸ“‹ åˆ†äº«å†…å®¹é¢„è§ˆï¼š</div>
                                <div class="preview-content">${shareText.substring(0, 200)}...</div>
                                <button class="copy-again-btn" onclick="copyAgain('${shareText.replace(/'/g, "\\'")}')">
                                    ğŸ“‹ é‡æ–°å¤åˆ¶
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .wechat-guide-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .wechat-guide-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .wechat-guide-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                    background: #f8f9fa;
                    border-radius: 16px 16px 0 0;
                }
                
                .wechat-guide-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-guide-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                    padding: 4px;
                    border-radius: 50%;
                }
                
                .close-guide-btn:hover {
                    background: #e9ecef;
                }
                
                .wechat-guide-body {
                    padding: 20px;
                }
                
                .guide-step {
                    display: flex;
                    margin-bottom: 20px;
                    align-items: flex-start;
                }
                
                .step-number {
                    width: 32px;
                    height: 32px;
                    background: #1aad19;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 14px;
                    margin-right: 15px;
                    flex-shrink: 0;
                }
                
                .step-content {
                    flex: 1;
                }
                
                .step-title {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 4px;
                }
                
                .step-desc {
                    font-size: 14px;
                    color: #666;
                    line-height: 1.5;
                }
                
                .open-wechat-btn {
                    background: #1aad19;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                    margin-bottom: 8px;
                }
                
                .open-wechat-btn:hover {
                    background: #16a113;
                }
                
                .or-text {
                    font-size: 12px;
                    color: #999;
                }
                
                .preview-section {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 20px;
                }
                
                .preview-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 10px;
                }
                
                .preview-content {
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    padding: 10px;
                    font-size: 12px;
                    color: #666;
                    line-height: 1.4;
                    margin-bottom: 12px;
                    white-space: pre-wrap;
                }
                
                .copy-again-btn {
                    background: #007AFF;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    font-size: 13px;
                    cursor: pointer;
                }
                
                .copy-again-btn:hover {
                    background: #0056CC;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(guideModal);
        }
        
        function closeWechatGuide() {
            const modal = document.getElementById('wechatGuideModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function tryOpenWechat() {
            try {
                // å†æ¬¡å°è¯•æ‰“å¼€å¾®ä¿¡
                if (openWechatApp()) {
                    showToast('ğŸ’š æ­£åœ¨å°è¯•æ‰“å¼€å¾®ä¿¡...');
                    setTimeout(() => {
                        closeWechatGuide();
                    }, 1000);
                } else {
                    showToast('è¯·æ‰‹åŠ¨æ‰“å¼€å¾®ä¿¡App');
                }
            } catch (error) {
                showToast('è¯·æ‰‹åŠ¨æ‰“å¼€å¾®ä¿¡App');
            }
        }
        
        async function copyAgain(text) {
            // è·å–æŒ‰é’®ä»¥æ˜¾ç¤ºçŠ¶æ€
            const copyBtn = event.target;
            const originalText = copyBtn.textContent;
            
            // æ˜¾ç¤ºå¤åˆ¶ä¸­çŠ¶æ€
            copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶ä¸­...';
            copyBtn.disabled = true;
            
            try {
                await copyToClipboard(text);
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
                copyBtn.style.background = '#28a745';
                showToast('ğŸ“‹ å·²å¤åˆ¶');
                
                // 2ç§’åæ¢å¤åŸçŠ¶
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#007AFF';
                    copyBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                copyBtn.textContent = originalText;
                copyBtn.disabled = false;
                showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }
        
        function shareToSystem(questions) {
            closeShareOptionsModal();
            
            const shareText = `ğŸ“š ç»ƒä¹ é¢˜é›†ï¼ˆ${questions.length}é¢˜ï¼‰\n\n` +
                            questions.map(q => `${q.number}. ${q.content}`).join('\n\n') +
                            `\n\nğŸ“… ${new Date().toLocaleString()}\nğŸ”— ZYJCæ™ºèƒ½æ‰¹æ”¹ç”Ÿæˆ`;
            
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒWeb Share API
            if (navigator.share) {
                navigator.share({
                    title: 'ç»ƒä¹ é¢˜é›†',
                    text: shareText
                }).then(() => {
                    showToast('âœ… åˆ†äº«æˆåŠŸï¼');
                }).catch(error => {
                    console.error('ç³»ç»Ÿåˆ†äº«å¤±è´¥:', error);
                    fallbackShare(shareText);
                });
            } else {
                showToast('è®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿåˆ†äº«ï¼Œä½¿ç”¨å¤åˆ¶åˆ†äº«');
                fallbackShare(shareText);
            }
        }
        
        function fallbackShare(text) {
            // åˆ›å»ºåˆ†äº«æ¨¡æ€æ¡†
            const shareModal = document.createElement('div');
            shareModal.id = 'shareModal';
            shareModal.innerHTML = `
                <div class="share-modal-overlay" onclick="closeShareModal()">
                    <div class="share-modal-content" onclick="event.stopPropagation()">
                        <div class="share-modal-header">
                            <h3>ğŸ’š å¾®ä¿¡åˆ†äº«</h3>
                            <button onclick="closeShareModal()" class="close-share-btn">Ã—</button>
                        </div>
                        <div class="share-modal-body">
                            <div class="share-instruction">
                                <p>ğŸ“± è¯·å¤åˆ¶ä¸‹é¢çš„å†…å®¹ï¼Œç„¶åç²˜è´´åˆ°å¾®ä¿¡ä¸­åˆ†äº«ï¼š</p>
                            </div>
                            <textarea id="shareContent" class="share-textarea" readonly>${text}</textarea>
                            <div class="share-actions">
                                <button class="copy-btn" onclick="copyShareContent()">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
                                <button class="qr-btn" onclick="generateQR()">ğŸ“± ç”ŸæˆäºŒç»´ç </button>
                            </div>
                            <div id="qrCode" class="qr-container" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .share-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .share-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .share-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .close-share-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                }
                
                .share-modal-body {
                    padding: 20px;
                }
                
                .share-instruction {
                    margin-bottom: 16px;
                    color: #666;
                }
                
                .share-textarea {
                    width: 100%;
                    height: 200px;
                    padding: 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 12px;
                    resize: vertical;
                    margin-bottom: 16px;
                }
                
                .share-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                }
                
                .copy-btn, .qr-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s ease;
                }
                
                .copy-btn {
                    background: #007AFF;
                    color: white;
                }
                
                .copy-btn:hover {
                    background: #0056CC;
                    transform: translateY(-1px);
                }
                
                .copy-btn:active {
                    transform: translateY(0);
                    background: #004499;
                }
                
                .copy-btn:disabled {
                    opacity: 0.7;
                    cursor: not-allowed;
                    transform: none;
                }
                
                .copy-btn:disabled:hover {
                    transform: none;
                }
                
                .qr-btn {
                    background: #1aad19;
                    color: white;
                }
                
                .qr-container {
                    text-align: center;
                    margin-top: 20px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(shareModal);
        }
        
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        async function copyShareContent() {
            console.log('å¤åˆ¶æŒ‰é’®è¢«ç‚¹å‡»');
            
            // è·å–æŒ‰é’®å…ƒç´ ä»¥æ˜¾ç¤ºçŠ¶æ€
            const copyBtn = event.target;
            const originalText = copyBtn.textContent;
            
            const textarea = document.getElementById('shareContent');
            if (!textarea) {
                console.error('æ‰¾ä¸åˆ°shareContentå…ƒç´ ');
                showToast('âŒ æ‰¾ä¸åˆ°åˆ†äº«å†…å®¹');
                return;
            }
            console.log('æ‰¾åˆ°textareaï¼Œå†…å®¹é•¿åº¦:', textarea.value.length);
            
            // æ˜¾ç¤ºå¤åˆ¶ä¸­çŠ¶æ€
            copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶ä¸­...';
            copyBtn.disabled = true;
            
            try {
                // ä¼˜å…ˆä½¿ç”¨ç°ä»£API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textarea.value);
                    showCopySuccess(copyBtn, originalText);
                    showToast('ğŸ“‹ å·²å¤åˆ¶', 1500);
                    return;
                }
                
                // é™çº§æ–¹æ¡ˆ1ï¼šä½¿ç”¨textareaé€‰æ‹©
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, 99999); // ç§»åŠ¨è®¾å¤‡å…¼å®¹
                
                const success = document.execCommand('copy');
                if (success) {
                    showCopySuccess(copyBtn, originalText);
                    showToast('ğŸ“‹ å·²å¤åˆ¶', 1500);
                } else {
                    throw new Error('execCommandå¤åˆ¶å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                
                // é™çº§æ–¹æ¡ˆ2ï¼šåˆ›å»ºä¸´æ—¶å…ƒç´ 
                try {
                    const tempInput = document.createElement('input');
                    tempInput.style.position = 'fixed';
                    tempInput.style.opacity = '0';
                    tempInput.style.left = '-9999px';
                    tempInput.value = textarea.value;
                    document.body.appendChild(tempInput);
                    
                    tempInput.focus();
                    tempInput.select();
                    tempInput.setSelectionRange(0, 99999);
                    
                    const copySuccess = document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    
                    if (copySuccess) {
                        showCopySuccess(copyBtn, originalText);
                        showToast('ğŸ“‹ å·²å¤åˆ¶');
                    } else {
                        throw new Error('æ‰€æœ‰å¤åˆ¶æ–¹æ³•å‡å¤±è´¥');
                    }
                    
                } catch (finalError) {
                    // æœ€ç»ˆé™çº§ï¼šæ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶æç¤º
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                    showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬');
                    textarea.focus();
                    textarea.select();
                    console.error('æ‰€æœ‰å¤åˆ¶æ–¹æ³•å‡å¤±è´¥:', finalError);
                }
            }
        }
        
        function showCopySuccess(button, originalText) {
            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            button.textContent = 'âœ… å·²å¤åˆ¶';
            button.style.background = '#28a745';
            
            // 2ç§’åæ¢å¤åŸçŠ¶
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#007AFF';
                button.disabled = false;
            }, 2000);
        }
        
        function generateQR() {
            const content = document.getElementById('shareContent').value;
            const qrContainer = document.getElementById('qrCode');
            
            // è¿™é‡Œå¯ä»¥é›†æˆQRç ç”Ÿæˆåº“ï¼Œæš‚æ—¶æ˜¾ç¤ºæç¤º
            qrContainer.innerHTML = `
                <p>ğŸ“± äºŒç»´ç ç”ŸæˆåŠŸèƒ½</p>
                <p style="font-size: 12px; color: #666;">
                    è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«åŠŸèƒ½ï¼Œæˆ–å°†ä¸Šæ–¹å†…å®¹å¤åˆ¶åˆ†äº«
                </p>
            `;
            qrContainer.style.display = 'block';
            
            showToast('äºŒç»´ç å·²ç”Ÿæˆ');
        }

        async function removeError(errorId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™é“é”™é¢˜å—ï¼Ÿç§»é™¤åæ— æ³•æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                console.log(`å¼€å§‹åˆ é™¤é”™é¢˜ID: ${errorId}`);
                
                const response = await fetch(`${API_BASE}/student/error-book/${errorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('åˆ é™¤æˆåŠŸ:', result);
                    
                    // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
                    errorData = errorData.filter(e => e.id !== errorId);
                    
                    // é‡æ–°æ¸²æŸ“é”™é¢˜åˆ—è¡¨
                    filterErrors();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateStatsOverview();
                    
                    // æ›´æ–°ç­›é€‰æ ‡ç­¾è®¡æ•°
                    updateFilterCounts();
                    
                    showToast('âœ… é”™é¢˜å·²æˆåŠŸç§»é™¤');
                } else {
                    const errorText = await response.text();
                    throw new Error(`åˆ é™¤å¤±è´¥: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('ç§»é™¤é”™é¢˜å¤±è´¥:', error);
                showToast('âŒ ç§»é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function submitHomework() {
            window.location.href = '/frontend/homework-submit.html';
        }

        function goBack() {
            // é”™é¢˜æœ¬åº”è¯¥è¿”å›åˆ°å­¦ç”Ÿé¦–é¡µ
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function goToProfile() {
            window.location.href = '/frontend/profile.html';
        }

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, duration);
        }
        
        // ç¡®ä¿åº•éƒ¨å¯¼èˆªæ ·å¼æ­£ç¡®
        function ensureNavigationStyles() {
            console.log('å¼€å§‹è®¾ç½®åº•éƒ¨å¯¼èˆªæ ·å¼...');
            
            const nav = document.querySelector('.global-bottom-nav');
            if (nav) {
                // æ¸…ç†æ‰€æœ‰é‡å¤çš„é¦–é¡µæŒ‰é’®
                const homeButtons = nav.querySelectorAll('[onclick*="student-home"]');
                console.log('æ‰¾åˆ°é¦–é¡µæŒ‰é’®æ•°é‡:', homeButtons.length);
                
                // ç§»é™¤æ‰€æœ‰é¦–é¡µæŒ‰é’®
                homeButtons.forEach(button => button.remove());
                
                // é‡æ–°åˆ›å»ºä¸€ä¸ªé¦–é¡µæŒ‰é’®
                const homeButton = document.createElement('div');
                homeButton.className = 'global-nav-item';
                homeButton.onclick = function() { window.location.href = '/frontend/student-home.html'; };
                homeButton.innerHTML = '<div class="global-nav-icon">ğŸ </div><div class="global-nav-text">é¦–é¡µ</div>';
                nav.insertBefore(homeButton, nav.firstChild);
                console.log('âœ… å·²é‡æ–°åˆ›å»ºå”¯ä¸€çš„é¦–é¡µæŒ‰é’®');
                // è®¾ç½®å¯¼èˆªå®¹å™¨æ ·å¼
                nav.style.cssText = `
                    display: flex !important;
                    position: fixed !important;
                    bottom: 0 !important;
                    left: 50% !important;
                    transform: translateX(-50%) !important;
                    width: 100% !important;
                    max-width: 400px !important;
                    background: rgba(255, 255, 255, 0.95) !important;
                    backdrop-filter: blur(20px) !important;
                    border-top: 1px solid rgba(102, 126, 234, 0.1) !important;
                    padding: 8px 0 !important;
                    z-index: 9999 !important;
                `;
                
                // ä¸ºæ‰€æœ‰å¯¼èˆªæŒ‰é’®åº”ç”¨ç»Ÿä¸€æ ·å¼
                const buttons = nav.querySelectorAll('.global-nav-item');
                buttons.forEach((button, index) => {
                    const isActive = button.classList.contains('active');
                    
                    // ç»Ÿä¸€çš„æŒ‰é’®æ ·å¼
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 8px 4px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        position: relative !important;
                        z-index: 1 !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 
                            'background: rgba(102, 126, 234, 0.1) !important; color: #667eea !important;' : 
                            'background: transparent !important; color: inherit !important;'}
                    `;
                    
                    // è®¾ç½®å›¾æ ‡æ ·å¼
                    const icon = button.querySelector('.global-nav-icon');
                    if (icon) {
                        icon.style.cssText = `
                            font-size: 20px !important;
                            margin-bottom: 2px !important;
                            transition: all 0.3s ease !important;
                            display: block !important;
                            ${isActive ? 'transform: scale(1.05) !important; filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3)) !important;' : ''}
                        `;
                    }
                    
                    // è®¾ç½®æ–‡å­—æ ·å¼
                    const text = button.querySelector('.global-nav-text');
                    if (text) {
                        text.style.cssText = `
                            font-size: 10px !important;
                            line-height: 1 !important;
                            font-weight: 500 !important;
                            transition: all 0.3s ease !important;
                        `;
                    }
                });
                
                console.log('âœ… å¯¼èˆªæ ·å¼è®¾ç½®å®Œæˆï¼ŒæŒ‰é’®æ•°é‡:', buttons.length);
            }
            
            // ç¡®ä¿é¡µé¢åº•éƒ¨æœ‰è¶³å¤Ÿçš„ç©ºé—´
            document.body.style.paddingBottom = '80px';
        }
        
        // ç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡
        let navigationStylesApplied = false;
        
        function applyNavigationStylesOnce() {
            if (!navigationStylesApplied) {
                navigationStylesApplied = true;
                ensureNavigationStyles();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', applyNavigationStylesOnce);
        setTimeout(applyNavigationStylesOnce, 500);
        
        // ç§»é™¤ä»»ä½•æµ‹è¯•æŒ‰é’®
        function removeTestButton() {
            const existingTestButton = document.getElementById('test-home-button');
            if (existingTestButton) {
                existingTestButton.remove();
                console.log('âœ… æµ‹è¯•æŒ‰é’®å·²ç§»é™¤');
            }
        }
        
        // ç§»é™¤æµ‹è¯•æŒ‰é’®
        setTimeout(removeTestButton, 1000);
        
        // è¯¦ç»†è°ƒè¯•ä»£ç ï¼šæ£€æŸ¥åº•éƒ¨å¯¼èˆª
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                console.log('=== åº•éƒ¨å¯¼èˆªè°ƒè¯•ä¿¡æ¯ ===');
                const nav = document.querySelector('.global-bottom-nav');
                if (nav) {
                    console.log('âœ… åº•éƒ¨å¯¼èˆªå®¹å™¨æ‰¾åˆ°äº†');
                    console.log('å¯¼èˆªå®¹å™¨HTML:', nav.outerHTML.substring(0, 200) + '...');
                    
                    const navItems = nav.querySelectorAll('.global-nav-item');
                    console.log('å¯¼èˆªæŒ‰é’®æ•°é‡:', navItems.length);
                    
                    navItems.forEach((button, index) => {
                        const icon = button.querySelector('.global-nav-icon');
                        const text = button.querySelector('.global-nav-text');
                        const iconText = icon ? icon.textContent : 'NO_ICON';
                        const buttonText = text ? text.textContent : 'NO_TEXT';
                        const isActive = button.classList.contains('active');
                        
                        console.log(`æŒ‰é’® ${index + 1}: ${iconText} ${buttonText} ${isActive ? '[ACTIVE]' : ''}`);
                        console.log(`  - å¯è§æ€§: ${button.offsetWidth}x${button.offsetHeight}`);
                        console.log(`  - ä½ç½®: left=${button.offsetLeft}px, top=${button.offsetTop}px`);
                    });
                    
                    // æ£€æŸ¥å¯¼èˆªå®¹å™¨çš„æ ·å¼
                    const navStyles = window.getComputedStyle(nav);
                    console.log('å¯¼èˆªå®¹å™¨æ ·å¼:');
                    console.log(`  - display: ${navStyles.display}`);
                    console.log(`  - position: ${navStyles.position}`);
                    console.log(`  - bottom: ${navStyles.bottom}`);
                    console.log(`  - z-index: ${navStyles.zIndex}`);
                    console.log(`  - visibility: ${navStyles.visibility}`);
                    
                } else {
                    console.log('âŒ åº•éƒ¨å¯¼èˆªå®¹å™¨æœªæ‰¾åˆ°');
                    // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å¯¼èˆªå…ƒç´ 
                    const allNavs = document.querySelectorAll('[class*="nav"]');
                    console.log('æ‰¾åˆ°çš„å¯¼èˆªç›¸å…³å…ƒç´ :', allNavs.length);
                    allNavs.forEach((el, i) => {
                        console.log(`  ${i + 1}: ${el.className} - ${el.tagName}`);
                    });
                }
                console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
            }, 1000);
        });
    </script>
</body>
</html>