<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJC智能批改 - 错题本</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* 页面内容 */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
        }
        
        /* 统计概览 */
        .stats-overview {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .progress-section {
            border-top: 1px solid #f0f0f0;
            padding-top: 16px;
        }
        
        .progress-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 12px;
        }
        
        .subject-progress {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subject-name {
            width: 50px;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }
        
        .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-percent {
            font-size: 12px;
            color: #666;
            min-width: 35px;
        }
        
        /* 筛选标签 */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 0 4px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .filter-tab:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .filter-tab.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }
        
        /* 错题列表 */
        .error-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 80px;
        }
        
        .error-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .error-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .error-item.reviewed {
            border-left: 4px solid #4CAF50;
        }
        
        .error-item.unreviewed {
            border-left: 4px solid #ff6b6b;
        }
        
        .error-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .error-subject {
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .error-date {
            font-size: 12px;
            color: #999;
        }
        
        .error-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-reviewed {
            background: #4CAF50;
        }
        
        .status-unreviewed {
            background: #ff6b6b;
        }
        
        .question-preview {
            margin-bottom: 12px;
        }
        
        .question-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .answer-comparison {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }
        
        .answer-item {
            flex: 1;
        }
        
        .answer-label {
            color: #666;
            margin-bottom: 2px;
        }
        
        .user-answer {
            color: #ff6b6b;
            font-weight: 500;
        }
        
        .correct-answer {
            color: #4CAF50;
            font-weight: 500;
        }
        
        .error-tags {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .error-tag {
            padding: 2px 8px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 11px;
            color: #1976D2;
        }
        
        .review-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-review {
            background: #e3f2fd;
            color: #1976D2;
        }
        
        .btn-review:hover {
            background: #bbdefb;
        }
        
        .btn-practice {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .btn-practice:hover {
            background: #e1bee7;
        }
        
        .btn-remove {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-remove:hover {
            background: #ffcdd2;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #ffffff;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .empty-hint {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .empty-action {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px 20px;
            background: #ffffff;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 14px;
            color: #666;
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: #ffffff;
            border-top: 1px solid #eee;
            display: flex;
            padding: 8px 0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .nav-item.active {
            color: #ff6b6b;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-text {
            font-size: 10px;
        }
        
        /* 移动端适配 */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            
            .answer-comparison {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
    <script src="/frontend/js/global-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">错题本</div>
                </div>
                <button class="filter-btn" onclick="toggleFilter()">筛选</button>
            </div>
        </div>
        
        <!-- 页面内容 -->
        <div class="page-content">
            <!-- 统计概览 -->
            <div class="stats-overview" id="statsOverview">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">正在加载统计数据...</div>
                </div>
            </div>
            
            <!-- 筛选标签 -->
            <div class="filter-tabs" id="filterTabs" style="display: none;">
                <div class="filter-tab active" data-filter="all">全部</div>
                <div class="filter-tab" data-filter="unreviewed">未复习</div>
                <div class="filter-tab" data-filter="reviewed">已复习</div>
                <div class="filter-tab" data-filter="chinese">语文</div>
                <div class="filter-tab" data-filter="math">数学</div>
                <div class="filter-tab" data-filter="english">英语</div>
                <div class="filter-tab" data-filter="physics">物理</div>
                <div class="filter-tab" data-filter="chemistry">化学</div>
            </div>
            
            <!-- 错题列表 -->
            <div id="errorList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">正在加载错题数据...</div>
                </div>
            </div>
        </div>
        
        <!-- 全局底部导航 -->
        <div class="global-bottom-nav">
            <div class="global-nav-item" onclick="window.location.href='/frontend/student-home.html'">
                <div class="global-nav-icon">🏠</div>
                <div class="global-nav-text">首页</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/homework-submit.html'">
                <div class="global-nav-icon">📷</div>
                <div class="global-nav-text">拍照批改</div>
            </div>
            <div class="global-nav-item active" onclick="window.location.href='/frontend/error-book.html'">
                <div class="global-nav-icon">📚</div>
                <div class="global-nav-text">错题本</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/study-plan.html'">
                <div class="global-nav-icon">📋</div>
                <div class="global-nav-text">学习计划</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/profile.html'">
                <div class="global-nav-icon">👤</div>
                <div class="global-nav-text">我的</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let errorData = [];
        let filteredData = [];
        let currentFilter = 'all';

        // 双向学科映射 - 与错题详情页面保持一致
        const subjectMapping = {
            // 英文到中文
            'math': '数学',
            'chinese': '语文', 
            'english': '英语',
            'physics': '物理',
            'chemistry': '化学',
            'biology': '生物',
            // 中文到英文
            '数学': 'math',
            '语文': 'chinese',
            '英语': 'english',
            '物理': 'physics',
            '化学': 'chemistry',
            '生物': 'biology'
        };

        // 获取统一的学科显示名称（中文）
        function getSubjectDisplayName(rawSubject) {
            if (!rawSubject) return '未知科目';
            
            // 如果是中文学科名，直接返回
            if (['数学', '语文', '英语', '物理', '化学', '生物'].includes(rawSubject)) {
                return rawSubject;
            }
            
            // 如果是英文代码，转换为中文
            return subjectMapping[rawSubject] || rawSubject;
        }

        // 检查错题是否匹配指定学科（支持中英文匹配）
        function isSubjectMatch(errorSubject, targetSubject) {
            if (!errorSubject || !targetSubject) return false;
            
            // 直接匹配
            if (errorSubject === targetSubject) return true;
            
            // 转换后匹配
            const errorSubjectCN = getSubjectDisplayName(errorSubject);
            const targetSubjectCN = getSubjectDisplayName(targetSubject);
            
            return errorSubjectCN === targetSubjectCN;
        }
        
        // 切换筛选标签显示/隐藏
        function toggleFilter() {
            const filterTabs = document.getElementById('filterTabs');
            if (filterTabs.style.display === 'none' || filterTabs.style.display === '') {
                filterTabs.style.display = 'flex';
            } else {
                filterTabs.style.display = 'none';
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });

        // 页面可见性监听 - 当用户从其他页面返回时重新加载数据
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('页面重新可见，重新加载数据');
                loadErrorBookData();
            }
        });

        // 页面聚焦监听 - 当窗口重新获得焦点时重新加载数据
        window.addEventListener('focus', function() {
            console.log('窗口重新聚焦，重新加载数据');
            loadErrorBookData();
        });

        function initPage() {
            // 检查登录状态
            token = localStorage.getItem('token');
            if (!token) {
                showToast('请先登录');
                setTimeout(() => {
                    window.location.href = '/frontend/login.html';
                }, 2000);
                return;
            }
            
            // 绑定筛选标签事件
            bindFilterTabs();
            
            // 加载数据
            loadErrorBookData();
        }

        function bindFilterTabs() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除其他选中状态
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    
                    // 添加选中状态
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    
                    // 筛选数据
                    filterErrors();
                });
            });
            
            // 更新标签数量
            updateFilterTabCounts();
        }
        
        function updateFilterTabCounts() {
            if (!errorData || errorData.length === 0) return;
            
            const counts = {
                all: errorData.length,
                reviewed: errorData.filter(e => e.is_reviewed).length,
                unreviewed: errorData.filter(e => !e.is_reviewed).length,
                chinese: errorData.filter(e => isSubjectMatch(e.subject, '语文')).length,
                math: errorData.filter(e => isSubjectMatch(e.subject, '数学')).length,
                english: errorData.filter(e => isSubjectMatch(e.subject, '英语')).length,
                physics: errorData.filter(e => isSubjectMatch(e.subject, '物理')).length,
                chemistry: errorData.filter(e => isSubjectMatch(e.subject, '化学')).length
            };
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                const filter = tab.dataset.filter;
                const count = counts[filter] || 0;
                const originalText = tab.textContent.split('(')[0].trim(); // 移除已有的数字
                
                if (count > 0 && filter !== 'all') {
                    tab.textContent = `${originalText} (${count})`;
                } else {
                    tab.textContent = originalText;
                }
                
                // 隐藏没有数据的标签
                if (count === 0 && filter !== 'all') {
                    tab.style.display = 'none';
                } else {
                    tab.style.display = 'inline-block';
                }
            });
        }
        
        function clearFilter() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-filter="all"]').classList.add('active');
            currentFilter = 'all';
            filterErrors();
        }

        async function loadErrorBookData() {
            try {
                // 加载错题统计 - 必须从API获取，包含正确的复习状态
                const statsResponse = await fetch(`${API_BASE}/student/error-book`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    errorData = data.recent_errors || [];
                    
                    console.log('从API加载的错题数据:', errorData);
                    
                    filteredData = [...errorData];
                    // 直接使用API返回的数据，包含准确的is_reviewed状态
                    updateStatsOverview({ 
                        recent_errors: errorData,
                        total_errors: errorData.length,
                        subject_stats: data.subject_stats || []
                    });
                    
                    // 更新筛选标签数量
                    updateFilterTabCounts();
                    
                    updateErrorList();
                } else {
                    throw new Error(`API请求失败: ${statsResponse.status}`);
                }
            } catch (error) {
                console.error('加载错题数据失败:', error);
                showErrorMessage('数据加载失败', `无法从服务器获取错题数据: ${error.message}`);
            }
        }

        function showErrorMessage(title, message) {
            const errorList = document.getElementById('errorList');
            const statsOverview = document.getElementById('statsOverview');
            
            // 显示错误状态
            statsOverview.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">⚠️</div>
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                    <button class="retry-btn" onclick="loadErrorBookData()">重新加载</button>
                </div>
            `;
            
            errorList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🔌</div>
                    <div class="empty-text">无法连接到服务器</div>
                    <div class="empty-hint">请检查网络连接并重试</div>
                    <button class="empty-action" onclick="loadErrorBookData()">重试</button>
                </div>
            `;
            
            // 添加错误状态样式
            const style = document.createElement('style');
            style.textContent = `
                .error-state {
                    text-align: center;
                    padding: 40px 20px;
                    color: #d32f2f;
                }
                .error-icon {
                    font-size: 48px;
                    margin-bottom: 16px;
                }
                .error-title {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 8px;
                }
                .error-message {
                    font-size: 14px;
                    margin-bottom: 20px;
                    line-height: 1.4;
                }
                .retry-btn {
                    background: #ff6b6b;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                }
            `;
            document.head.appendChild(style);
        }

        function calculateRealStats() {
            if (!errorData || errorData.length === 0) {
                return {
                    totalErrors: 0,
                    unreviewed: 0,
                    reviewed: 0,
                    subjectStats: []
                };
            }
            
            // 基于真实错题数据计算统计信息
            const totalErrors = errorData.length;
            const unreviewed = errorData.filter(error => !error.is_reviewed).length;
            const reviewed = errorData.filter(error => error.is_reviewed).length;
            
            // 按科目分组统计
            const subjectMap = {};
            errorData.forEach(error => {
                if (!error.subject) return;
                
                if (!subjectMap[error.subject]) {
                    subjectMap[error.subject] = {
                        subject: error.subject,
                        total: 0,
                        reviewed: 0,
                        unreviewed: 0
                    };
                }
                
                subjectMap[error.subject].total++;
                if (error.is_reviewed) {
                    subjectMap[error.subject].reviewed++;
                } else {
                    subjectMap[error.subject].unreviewed++;
                }
            });
            
            // 转换为数组并按题目数量排序
            const subjectStats = Object.values(subjectMap).sort((a, b) => b.total - a.total);
            
            return {
                totalErrors,
                unreviewed,
                reviewed,
                subjectStats
            };
        }
        
        function updateStatsOverview(data) {
            const statsOverview = document.getElementById('statsOverview');
            
            // 使用真实数据计算统计信息
            const realStats = calculateRealStats();
            
            // 如果有真实错题数据，使用真实统计；否则使用传入的数据
            const totalErrors = realStats.totalErrors;
            const unreviewed = realStats.unreviewed;
            const reviewed = realStats.reviewed;
            const subjectStats = realStats.subjectStats;
            
            if (totalErrors === 0) {
                statsOverview.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">总错题</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">未复习</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">已复习</div>
                        </div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-title">学科错题分布</div>
                        <div class="subject-progress">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                暂无错题数据
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            statsOverview.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${totalErrors}</div>
                        <div class="stat-label">总错题</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${unreviewed}</div>
                        <div class="stat-label">未复习</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${reviewed}</div>
                        <div class="stat-label">已复习</div>
                    </div>
                </div>
                <div class="progress-section">
                    <div class="progress-title">学科错题分布</div>
                    <div class="subject-progress">
                        ${subjectStats.map(stat => {
                            const percentage = (stat.total / totalErrors * 100).toFixed(1);
                            return `
                                <div class="progress-item">
                                    <div class="subject-name">${stat.subject}</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="progress-percent">${stat.total}题 (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function filterErrors() {
            console.log('开始筛选，当前筛选条件:', currentFilter);
            
            if (currentFilter === 'all') {
                filteredData = [...errorData];
            } else if (currentFilter === 'reviewed') {
                filteredData = errorData.filter(error => error.is_reviewed);
            } else if (currentFilter === 'unreviewed') {
                filteredData = errorData.filter(error => !error.is_reviewed);
            } else {
                // 按科目筛选
                const subjectMap = {
                    'chinese': '语文',
                    'math': '数学',
                    'english': '英语',
                    'physics': '物理',
                    'chemistry': '化学'
                };
                const subject = subjectMap[currentFilter];
                if (subject) {
                    filteredData = errorData.filter(error => isSubjectMatch(error.subject, subject));
                }
            }
            
            console.log('筛选结果:', filteredData.length, '条错题');
            
            // 显示筛选结果提示
            showFilterResult();
            
            updateErrorList();
        }

        function showFilterResult() {
            const filterName = getFilterName(currentFilter);
            const count = filteredData.length;
            
            if (currentFilter !== 'all') {
                showToast(`${filterName}：找到${count}条错题`);
            }
        }

        function getFilterName(filter) {
            const filterNames = {
                'all': '全部',
                'reviewed': '已复习',
                'unreviewed': '未复习',
                'chinese': '语文',
                'math': '数学',
                'english': '英语',
                'physics': '物理',
                'chemistry': '化学',
                'error_type': '按错误类型',
                'date_today': '今天',
                'date_week': '本周',
                'date_month': '本月'
            };
            return filterNames[filter] || '自定义筛选';
        }

        function updateErrorList() {
            const errorList = document.getElementById('errorList');
            
            if (filteredData.length === 0) {
                const filterName = getFilterName(currentFilter);
                const isEmpty = errorData.length === 0;
                
                if (isEmpty) {
                    // 完全没有错题数据
                    errorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📚</div>
                            <div class="empty-text">暂无错题</div>
                            <div class="empty-hint">完成作业批改后，错题会自动收录到这里</div>
                            <button class="empty-action" onclick="submitHomework()">去批改作业</button>
                        </div>
                    `;
                } else {
                    // 有错题数据，但筛选后没有结果
                    errorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🔍</div>
                            <div class="empty-text">没有找到【${filterName}】的错题</div>
                            <div class="empty-hint">可以尝试切换其他筛选条件，或查看全部错题</div>
                            <button class="empty-action" onclick="clearFilter()">查看全部错题</button>
                        </div>
                    `;
                }
                return;
            }
            
            const errorItems = filteredData.map(error => `
                <div class="error-item ${error.is_reviewed ? 'reviewed' : 'unreviewed'}" onclick="viewErrorDetail(${error.id})">
                    <div class="error-status ${error.is_reviewed ? 'status-reviewed' : 'status-unreviewed'}"></div>
                    <div class="error-header">
                        <div class="error-subject">${error.subject || '未知学科'}</div>
                        <div class="error-date">${formatDate(error.created_at)}</div>
                    </div>
                    <div class="question-preview">
                        <div class="question-text">${error.question_text || error.question || '题目内容'}</div>
                        <div class="answer-comparison">
                            <div class="answer-item">
                                <div class="answer-label">你的答案</div>
                                <div class="user-answer">${error.user_answer || error.userAnswer || '无答案'}</div>
                            </div>
                            <div class="answer-item">
                                <div class="answer-label">正确答案</div>
                                <div class="correct-answer">${error.correct_answer || error.correctAnswer || '无正确答案'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="error-tags">
                        ${error.error_type ? `<div class="error-tag">${error.error_type || error.errorType}</div>` : ''}
                        ${error.knowledge_points?.map(point => `<div class="error-tag">${point}</div>`).join('') || ''}
                    </div>
                    <div class="review-actions" onclick="event.stopPropagation()">
                        ${!error.is_reviewed ? `
                            <button class="action-btn btn-review" onclick="markAsReviewed(${error.id})">
                                ✓ 标记已复习
                            </button>
                        ` : ''}
                        <button class="action-btn btn-practice" onclick="practiceError(${error.id})">
                            📝 相似练习
                        </button>
                        <button class="action-btn btn-remove" onclick="removeError(${error.id})">
                            🗑️ 移除
                        </button>
                    </div>
                </div>
            `).join('');
            
            errorList.innerHTML = errorItems;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return '今天';
            } else if (days === 1) {
                return '昨天';
            } else if (days < 7) {
                return `${days}天前`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function showFilterOptions() {
            // 显示更实用的筛选菜单
            showFilterModal();
        }
        
        function getAvailableSubjects() {
            if (!errorData || errorData.length === 0) return [];
            
            const subjects = [...new Set(errorData.map(error => error.subject))].filter(Boolean);
            return subjects.sort();
        }
        
        function getAvailableErrorTypes() {
            if (!errorData || errorData.length === 0) return [];
            
            const errorTypes = [...new Set(errorData.map(error => error.error_type))].filter(Boolean);
            return errorTypes.sort();
        }
        
        function generateSubjectOptions() {
            const subjects = getAvailableSubjects();
            let options = '<option value="">不限</option>';
            
            subjects.forEach(subject => {
                const count = errorData.filter(e => isSubjectMatch(e.subject, subject)).length;
                options += `<option value="${subject}">${subject} (${count}题)</option>`;
            });
            
            return options;
        }
        
        function generateErrorTypeOptions() {
            const errorTypes = getAvailableErrorTypes();
            let options = '<option value="">不限</option>';
            
            errorTypes.forEach(errorType => {
                const count = errorData.filter(e => e.error_type === errorType).length;
                options += `<option value="${errorType}">${errorType} (${count}题)</option>`;
            });
            
            return options;
        }
        
        function generateSubjectButtons() {
            const subjects = getAvailableSubjects();
            const subjectIcons = {
                '数学': '🔢',
                '语文': '📖', 
                '英语': '🔤',
                '物理': '⚡',
                '化学': '⚗️',
                '生物': '🧬',
                '历史': '📜',
                '地理': '🌍',
                '政治': '⚖️'
            };
            
            const subjectFilters = {
                '数学': 'math',
                '语文': 'chinese',
                '英语': 'english', 
                '物理': 'physics',
                '化学': 'chemistry',
                '生物': 'biology',
                '历史': 'history',
                '地理': 'geography',
                '政治': 'politics'
            };
            
            let buttons = '';
            subjects.forEach(subject => {
                const count = errorData.filter(e => isSubjectMatch(e.subject, subject)).length;
                const icon = subjectIcons[subject] || '📚';
                const filterKey = subjectFilters[subject] || `subject_${subject}`;
                
                if (count > 0) {
                    buttons += `
                        <button class="filter-quick-btn" onclick="filterBySubject('${subject}')">
                            ${icon} ${subject} (${count})
                        </button>
                    `;
                }
            });
            
            return buttons;
        }
        
        function generateErrorTypeButtons() {
            const errorTypes = getAvailableErrorTypes();
            const errorTypeIcons = {
                '计算错误': '➕',
                '语法错误': '📝',
                '知识错误': '💡',
                '运算错误': '🔣',
                '基础概念': '📐',
                '词汇错误': '📖',
                '翻译错误': '🌐',
                '文学常识': '📚',
                '几何概念': '📐',
                '代数运算': '🔢'
            };
            
            let buttons = '';
            errorTypes.forEach(errorType => {
                const count = errorData.filter(e => e.error_type === errorType).length;
                const icon = errorTypeIcons[errorType] || '❓';
                
                if (count > 0) {
                    buttons += `
                        <button class="filter-quick-btn" onclick="filterByErrorType('${errorType}')">
                            ${icon} ${errorType} (${count})
                        </button>
                    `;
                }
            });
            
            return buttons;
        }
        
        function showFilterModal() {
            const totalCount = errorData.length;
            const currentCount = filteredData.length;
            const filterName = getFilterName(currentFilter);
            
            // 创建筛选弹窗
            const modal = document.createElement('div');
            modal.id = 'filterModal';
            modal.innerHTML = `
                <div class="filter-modal-overlay" onclick="closeFilterModal()">
                    <div class="filter-modal-content" onclick="event.stopPropagation()">
                        <div class="filter-modal-header">
                            <h3>筛选错题</h3>
                            <button onclick="closeFilterModal()" class="close-modal-btn">×</button>
                        </div>
                        
                        <div class="filter-modal-body">
                            <div class="filter-section">
                                <div class="filter-section-title">当前状态</div>
                                <div class="filter-current">
                                    正在显示【${filterName}】- ${currentCount} / ${totalCount} 条错题
                                </div>
                                <div class="filter-stats">
                                    已复习: ${filteredData.filter(e => e.is_reviewed).length} | 
                                    未复习: ${filteredData.filter(e => !e.is_reviewed).length}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">按状态筛选</div>
                                <div class="filter-quick-buttons">
                                    <button class="filter-quick-btn" onclick="quickFilter('unreviewed')">
                                        📚 未复习错题 (${errorData.filter(e => !e.is_reviewed).length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="quickFilter('reviewed')">
                                        ✅ 已复习错题 (${errorData.filter(e => e.is_reviewed).length})
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">按科目筛选</div>
                                <div class="filter-quick-buttons">
                                    ${generateSubjectButtons()}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">按错误类型筛选</div>
                                <div class="filter-quick-buttons">
                                    ${generateErrorTypeButtons()}
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">按时间筛选</div>
                                <div class="filter-quick-buttons">
                                    <button class="filter-quick-btn" onclick="filterByDate('today')">
                                        📅 今天的错题 (${getErrorsByDate('today').length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="filterByDate('week')">
                                        📆 本周错题 (${getErrorsByDate('week').length})
                                    </button>
                                    <button class="filter-quick-btn" onclick="filterByDate('month')">
                                        🗓️ 本月错题 (${getErrorsByDate('month').length})
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">搜索功能</div>
                                <div class="search-box">
                                    <input type="text" id="searchInput" placeholder="搜索题目内容..." />
                                    <button class="search-btn" onclick="searchErrors()">🔍</button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">高级筛选</div>
                                <div class="advanced-filter">
                                    <div class="filter-row">
                                        <label>科目:</label>
                                        <select id="advancedSubject">
                                            ${generateSubjectOptions()}
                                        </select>
                                    </div>
                                    <div class="filter-row">
                                        <label>状态:</label>
                                        <select id="advancedStatus">
                                            <option value="">不限</option>
                                            <option value="reviewed">已复习</option>
                                            <option value="unreviewed">未复习</option>
                                        </select>
                                    </div>
                                    <div class="filter-row">
                                        <label>错误类型:</label>
                                        <select id="advancedErrorType">
                                            ${generateErrorTypeOptions()}
                                        </select>
                                    </div>
                                    <button class="filter-action-btn advanced-apply" onclick="applyAdvancedFilter()">
                                        🔍 应用高级筛选
                                    </button>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-section-title">排序和重置</div>
                                <div class="filter-actions">
                                    <button class="filter-action-btn" onclick="quickFilter('all')">
                                        🔍 显示全部错题
                                    </button>
                                    <button class="filter-action-btn" onclick="sortByDate()">
                                        📅 按时间排序（最新优先）
                                    </button>
                                    <button class="filter-action-btn" onclick="sortBySubject()">
                                        📚 按科目排序
                                    </button>
                                    <button class="filter-action-btn" onclick="sortByDifficulty()">
                                        ⭐ 按难度排序
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .filter-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .filter-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .filter-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 20px 16px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .filter-modal-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-modal-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    color: #666;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .close-modal-btn:hover {
                    background: #f0f0f0;
                }
                
                .filter-modal-body {
                    padding: 20px;
                }
                
                .filter-section {
                    margin-bottom: 24px;
                }
                
                .filter-section:last-child {
                    margin-bottom: 0;
                }
                
                .filter-section-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 12px;
                }
                
                .filter-current {
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 8px;
                    font-size: 14px;
                    color: #666;
                    border-left: 4px solid #ff6b6b;
                }
                
                .filter-stats {
                    margin-top: 8px;
                    padding: 8px 12px;
                    background: #e3f2fd;
                    border-radius: 6px;
                    font-size: 12px;
                    color: #1976D2;
                    text-align: center;
                }
                
                .filter-quick-buttons, .filter-actions {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .filter-quick-btn, .filter-action-btn {
                    width: 100%;
                    padding: 12px 16px;
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    font-size: 14px;
                    color: #333;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-align: left;
                }
                
                .filter-quick-btn:hover, .filter-action-btn:hover {
                    background: #e9ecef;
                    border-color: #dee2e6;
                }
                
                .filter-quick-btn:active, .filter-action-btn:active {
                    background: #dee2e6;
                }
                
                .advanced-filter {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 16px;
                }
                
                .filter-row {
                    display: flex;
                    align-items: center;
                    margin-bottom: 12px;
                }
                
                .filter-row:last-child {
                    margin-bottom: 0;
                }
                
                .filter-row label {
                    min-width: 80px;
                    font-size: 13px;
                    color: #666;
                    margin-right: 12px;
                }
                
                .filter-row select {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 13px;
                    background: white;
                }
                
                .advanced-apply {
                    margin-top: 12px;
                    background: #007AFF !important;
                    color: white !important;
                }
                
                .advanced-apply:hover {
                    background: #0056CC !important;
                }
                
                .quantity-input {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .quantity-input input[type="number"] {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                    width: 80px;
                }
                
                .quantity-input .unit {
                    color: #666;
                    font-size: 14px;
                }
                
                .search-box {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .search-box input {
                    flex: 1;
                    padding: 10px 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                    background: white;
                }
                
                .search-box input:focus {
                    outline: none;
                    border-color: #007AFF;
                    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
                }
                
                .search-btn {
                    padding: 10px 16px;
                    background: #007AFF;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                }
                
                .search-btn:hover {
                    background: #0056CC;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        function closeFilterModal() {
            const modal = document.getElementById('filterModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function filterBySubject(subject) {
            currentFilter = `subject_${subject}`;
            filteredData = errorData.filter(error => isSubjectMatch(error.subject, subject));
            updateErrorList();
            closeFilterModal();
            showToast(`筛选【${subject}】：找到${filteredData.length}条错题`);
        }
        
        function quickFilter(filterType) {
            // 更新筛选标签状态
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
            
            // 应用筛选
            currentFilter = filterType;
            filterErrors();
            
            // 关闭弹窗
            closeFilterModal();
        }
        
        function sortByDate() {
            // 按时间排序（最新的在前）
            filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            updateErrorList();
            closeFilterModal();
            showToast('已按时间排序（最新优先）');
        }
        
        function sortBySubject() {
            // 按科目排序
            const subjectOrder = ['数学', '语文', '英语', '物理', '化学'];
            filteredData.sort((a, b) => {
                const indexA = subjectOrder.indexOf(a.subject);
                const indexB = subjectOrder.indexOf(b.subject);
                return indexA - indexB;
            });
            updateErrorList();
            closeFilterModal();
            showToast('已按科目排序');
        }
        
        function sortByDifficulty() {
            // 按难度排序（这里简单按错误类型分类）
            const difficultyOrder = ['计算错误', '运算错误', '语法错误', '知识错误', '基础概念'];
            filteredData.sort((a, b) => {
                const indexA = difficultyOrder.indexOf(a.error_type);
                const indexB = difficultyOrder.indexOf(b.error_type);
                return indexA - indexB;
            });
            updateErrorList();
            closeFilterModal();
            showToast('已按难度排序');
        }
        
        function filterByErrorType(errorType) {
            currentFilter = 'error_type';
            filteredData = errorData.filter(error => error.error_type === errorType);
            updateErrorList();
            closeFilterModal();
            showToast(`筛选【${errorType}】：找到${filteredData.length}条错题`);
        }
        
        function filterByDate(period) {
            const now = new Date();
            let startDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
            }
            
            currentFilter = `date_${period}`;
            filteredData = errorData.filter(error => new Date(error.created_at) >= startDate);
            updateErrorList();
            closeFilterModal();
            
            const periodNames = {
                'today': '今天',
                'week': '本周', 
                'month': '本月'
            };
            showToast(`筛选【${periodNames[period]}】：找到${filteredData.length}条错题`);
        }
        
        function getErrorsByDate(period) {
            if (!errorData || errorData.length === 0) return [];
            
            const now = new Date();
            let startDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                default:
                    return [];
            }
            
            return errorData.filter(error => new Date(error.created_at) >= startDate);
        }
        
        function applyAdvancedFilter() {
            const subject = document.getElementById('advancedSubject').value;
            const status = document.getElementById('advancedStatus').value;
            const errorType = document.getElementById('advancedErrorType').value;
            
            currentFilter = 'advanced';
            filteredData = [...errorData];
            
            // 应用科目筛选
            if (subject) {
                filteredData = filteredData.filter(error => isSubjectMatch(error.subject, subject));
            }
            
            // 应用状态筛选
            if (status === 'reviewed') {
                filteredData = filteredData.filter(error => error.is_reviewed);
            } else if (status === 'unreviewed') {
                filteredData = filteredData.filter(error => !error.is_reviewed);
            }
            
            // 应用错误类型筛选
            if (errorType) {
                filteredData = filteredData.filter(error => error.error_type === errorType);
            }
            
            updateErrorList();
            closeFilterModal();
            
            // 生成筛选结果描述
            const conditions = [];
            if (subject) conditions.push(`科目:${subject}`);
            if (status === 'reviewed') conditions.push('状态:已复习');
            if (status === 'unreviewed') conditions.push('状态:未复习');
            if (errorType) conditions.push(`类型:${errorType}`);
            
            const conditionText = conditions.length > 0 ? conditions.join('，') : '无条件';
            showToast(`高级筛选【${conditionText}】：找到${filteredData.length}条错题`);
        }
        
        function searchErrors() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                showToast('请输入搜索内容');
                return;
            }
            
            currentFilter = 'search';
            filteredData = errorData.filter(error => 
                error.question_text.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.user_answer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.correct_answer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                error.error_type.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (error.knowledge_points && error.knowledge_points.some(point => 
                    point.toLowerCase().includes(searchTerm.toLowerCase())))
            );
            
            updateErrorList();
            closeFilterModal();
            showToast(`搜索"${searchTerm}"：找到${filteredData.length}条相关错题`);
        }
        
        // 监听搜索框回车键
        document.addEventListener('DOMContentLoaded', function() {
            // 将原有的初始化代码包装
            const originalInitPage = initPage;
            initPage = function() {
                originalInitPage();
                
                // 添加搜索框回车监听
                document.addEventListener('keydown', function(e) {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput && e.target === searchInput && e.key === 'Enter') {
                        searchErrors();
                    }
                });
            };
        });

        function viewErrorDetail(errorId) {
            // 找到对应的错题数据
            const errorDetail = errorData.find(error => error.id == errorId);
            
            if (errorDetail) {
                // 将错题数据存储到localStorage，确保详情页面显示一致的数据
                localStorage.setItem('currentErrorDetail', JSON.stringify(errorDetail));
                console.log('存储错题数据到localStorage:', errorDetail);
            }
            
            // 跳转到错题详情页面
            window.location.href = `/frontend/error-detail.html?id=${errorId}`;
        }

        async function markAsReviewed(errorId) {
            try {
                const response = await fetch(`${API_BASE}/student/error-book/${errorId}/review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    // 更新本地数据状态
                    const error = errorData.find(e => e.id === errorId);
                    if (error) {
                        error.is_reviewed = true;
                    }
                    
                    // 重新渲染列表和统计
                    filterErrors();
                    updateStatsOverview();
                    showToast('已标记为已复习');
                } else {
                    throw new Error('标记失败');
                }
            } catch (error) {
                console.error('标记复习失败:', error);
                showToast('标记失败，请重试');
            }
        }

        // 注意：移除了localStorage相关的复习状态管理
        // 现在完全依靠数据库和API返回的is_reviewed字段

        function practiceError(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('找不到该错题信息');
                return;
            }
            
            showPracticeModal(error);
        }
        
        function showPracticeModal(error) {
            // 创建练习模态框
            const practiceModal = document.createElement('div');
            practiceModal.id = 'practiceModal';
            practiceModal.innerHTML = `
                <div class="practice-modal-overlay" onclick="closePracticeModal()">
                    <div class="practice-modal-content" onclick="event.stopPropagation()">
                        <div class="practice-modal-header">
                            <h3>📝 生成相似练习</h3>
                            <button onclick="closePracticeModal()" class="close-practice-btn">×</button>
                        </div>
                        
                        <div class="practice-modal-body">
                            <!-- 原题展示 -->
                            <div class="original-question">
                                <div class="section-title">📚 原题信息</div>
                                <div class="question-info">
                                    <div class="info-row">
                                        <span class="label">科目：</span>
                                        <span class="value">${getSubjectDisplayName(error.subject)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">题目：</span>
                                        <span class="value">${error.question_text}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">错误类型：</span>
                                        <span class="value">${error.error_type}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">知识点：</span>
                                        <span class="value">${error.knowledge_points ? error.knowledge_points.join('、') : '无'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 生成设置 -->
                            <div class="practice-settings">
                                <div class="section-title">⚙️ 生成设置</div>
                                
                                <div class="setting-row">
                                    <label>题目数量：</label>
                                    <div class="quantity-input">
                                        <input type="number" id="questionCount" min="1" max="50" value="5" />
                                        <span class="unit">道题</span>
                                    </div>
                                </div>
                                
                                <div class="setting-row">
                                    <label>难度选择：</label>
                                    <select id="difficultyLevel">
                                        <option value="easier">🟢 简化版（比原题简单）</option>
                                        <option value="same" selected>🟡 相同难度（与原题相当）</option>
                                        <option value="harder">🔴 提高版（比原题困难）</option>
                                        <option value="mixed">🌈 混合难度（循序渐进）</option>
                                    </select>
                                </div>
                                
                                <div class="setting-row">
                                    <label>题目类型：</label>
                                    <select id="questionType">
                                        <option value="similar" selected>📋 相似题目（结构相似）</option>
                                        <option value="extended">🔄 拓展变式（基础扩展）</option>
                                        <option value="comprehensive">🧠 综合应用（多知识点）</option>
                                    </select>
                                </div>
                                
                                <div class="setting-row">
                                    <label>是否包含答案：</label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="includeAnswers" checked>
                                            <span>包含详细答案</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="includeAnalysis" checked>
                                            <span>包含解题思路</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="practice-actions">
                                <button class="practice-btn generate-btn" onclick="generatePractice(${error.id})">
                                    🤖 AI智能生成
                                </button>
                                <button class="practice-btn preview-btn" onclick="showGenerationPreview(${error.id})">
                                    👀 预览设置
                                </button>
                            </div>
                            
                            <!-- 生成结果区域 -->
                            <div id="practiceResult" class="practice-result" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .practice-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .practice-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 600px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .practice-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 20px 16px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .practice-modal-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-practice-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    color: #666;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .close-practice-btn:hover {
                    background: #f0f0f0;
                }
                
                .practice-modal-body {
                    padding: 20px;
                }
                
                .original-question, .practice-settings {
                    margin-bottom: 24px;
                    padding: 16px;
                    background: #f8f9fa;
                    border-radius: 12px;
                }
                
                .section-title {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 12px;
                }
                
                .question-info .info-row {
                    display: flex;
                    margin-bottom: 8px;
                    align-items: flex-start;
                }
                
                .question-info .label {
                    min-width: 80px;
                    font-weight: 500;
                    color: #666;
                }
                
                .question-info .value {
                    flex: 1;
                    color: #333;
                }
                
                .setting-row {
                    display: flex;
                    align-items: center;
                    margin-bottom: 16px;
                }
                
                .setting-row:last-child {
                    margin-bottom: 0;
                }
                
                .setting-row label {
                    min-width: 100px;
                    font-size: 14px;
                    color: #666;
                }
                
                .setting-row select {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                }
                
                .checkbox-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .checkbox-label {
                    display: flex;
                    align-items: center;
                    font-size: 14px;
                    cursor: pointer;
                }
                
                .checkbox-label input[type="checkbox"] {
                    margin-right: 8px;
                }
                
                .practice-actions {
                    text-align: center;
                    margin-bottom: 20px;
                }
                
                .practice-btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .generate-btn {
                    background: linear-gradient(135deg, #007AFF, #0056CC);
                    color: white;
                    margin: 0 4px;
                    position: relative;
                    overflow: hidden;
                }
                
                .generate-btn:hover {
                    background: linear-gradient(135deg, #0056CC, #004499);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                }
                
                .preview-btn {
                    background: linear-gradient(135deg, #17a2b8, #138496);
                    color: white;
                    margin: 0 4px;
                }
                
                .preview-btn:hover {
                    background: linear-gradient(135deg, #138496, #117a8b);
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
                }
                
                .practice-result {
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 20px;
                }
                
                .generated-question {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                    border-left: 4px solid #007AFF;
                }
                
                .question-number {
                    font-weight: 600;
                    color: #007AFF;
                    margin-bottom: 8px;
                }
                
                .question-content {
                    margin-bottom: 12px;
                    line-height: 1.5;
                }
                
                .question-answer {
                    background: #e8f5e8;
                    border-radius: 6px;
                    padding: 12px;
                    margin-top: 8px;
                }
                
                .answer-label {
                    font-weight: 500;
                    color: #2e7d32;
                    margin-bottom: 4px;
                }
                
                .export-actions {
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                    margin-top: 20px;
                    padding-top: 20px;
                    border-top: 1px solid #f0f0f0;
                }
                
                .export-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .pdf-btn { background: #e53e3e; color: white; }
                .word-btn { background: #2b6cb0; color: white; }
                .wechat-btn { background: #1aad19; color: white; }
                
                .pdf-btn:hover { background: #c53030; }
                .word-btn:hover { background: #2c5282; }
                .wechat-btn:hover { background: #16a113; }
                
                @media (max-width: 480px) {
                    .practice-modal-content {
                        margin: 10px;
                        max-width: none;
                    }
                    
                    .setting-row {
                        flex-direction: column;
                        align-items: flex-start;
                    }
                    
                    .setting-row label {
                        margin-bottom: 8px;
                    }
                    
                    .setting-row select {
                        width: 100%;
                    }
                    
                    .export-actions {
                        flex-direction: column;
                    }
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(practiceModal);
        }
        
        function closePracticeModal() {
            const modal = document.getElementById('practiceModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function showGenerationPreview(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('找不到该错题信息');
                return;
            }
            
            const questionCount = document.getElementById('questionCount').value;
            const difficultyLevel = document.getElementById('difficultyLevel').value;
            const questionType = document.getElementById('questionType').value;
            const includeAnswers = document.getElementById('includeAnswers').checked;
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            // 显示生成预览信息
            const previewHTML = `
                <div class="generation-preview">
                    <h4>🔍 生成预览</h4>
                    <div class="preview-grid">
                        <div class="preview-item">
                            <span class="preview-label">📊 原题信息:</span>
                            <span class="preview-value">${error.subject} - ${error.error_type}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">📝 生成数量:</span>
                            <span class="preview-value">${questionCount} 道题</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">⚙️ 难度设置:</span>
                            <span class="preview-value">${getDifficultyText(difficultyLevel)}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">🎯 题目类型:</span>
                            <span class="preview-value">${getQuestionTypeText(questionType)}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">✅ 包含答案:</span>
                            <span class="preview-value">${includeAnswers ? '是' : '否'}</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">💡 包含分析:</span>
                            <span class="preview-value">${includeAnalysis ? '是' : '否'}</span>
                        </div>
                    </div>
                    <div class="preview-estimate">
                        <div class="estimate-item">
                            <span class="estimate-icon">⏱️</span>
                            <span class="estimate-text">预计生成时间: 5-10秒</span>
                        </div>
                        <div class="estimate-item">
                            <span class="estimate-icon">🎲</span>
                            <span class="estimate-text">AI智能分析: 基于错题类型和学习数据</span>
                        </div>
                        <div class="estimate-item">
                            <span class="estimate-icon">📈</span>
                            <span class="estimate-text">预期效果: 针对性练习，提升准确率</span>
                        </div>
                    </div>
                    <div class="preview-tips">
                        <h5>💡 生成提示:</h5>
                        <ul>
                            <li>系统将分析您的学习水平和错题特征</li>
                            <li>生成符合您能力的个性化练习题</li>
                            <li>建议先从相同难度开始练习</li>
                            <li>可以多次生成不同类型的练习题</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // 将预览信息显示在结果区域
            const resultDiv = document.getElementById('practiceResult');
            resultDiv.innerHTML = previewHTML;
            resultDiv.style.display = 'block';
            
            // 添加预览样式
            if (!document.getElementById('previewStyles')) {
                const style = document.createElement('style');
                style.id = 'previewStyles';
                style.textContent = `
                    .generation-preview {
                        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                        border-radius: 12px;
                        padding: 20px;
                        margin-top: 20px;
                        border: 1px solid #dee2e6;
                    }
                    
                    .generation-preview h4 {
                        margin: 0 0 16px 0;
                        color: #495057;
                        font-size: 16px;
                    }
                    
                    .preview-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 10px;
                        margin-bottom: 20px;
                    }
                    
                    .preview-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: white;
                        padding: 10px 12px;
                        border-radius: 6px;
                        border: 1px solid #e9ecef;
                    }
                    
                    .preview-label {
                        font-size: 14px;
                        color: #6c757d;
                        font-weight: 500;
                    }
                    
                    .preview-value {
                        font-size: 14px;
                        color: #495057;
                        font-weight: 600;
                    }
                    
                    .preview-estimate {
                        background: #e3f2fd;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 20px;
                        border-left: 4px solid #2196F3;
                    }
                    
                    .estimate-item {
                        display: flex;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    
                    .estimate-item:last-child {
                        margin-bottom: 0;
                    }
                    
                    .estimate-icon {
                        font-size: 16px;
                        margin-right: 8px;
                        width: 20px;
                    }
                    
                    .estimate-text {
                        font-size: 13px;
                        color: #1976D2;
                    }
                    
                    .preview-tips {
                        background: #fff3cd;
                        border-radius: 8px;
                        padding: 15px;
                        border-left: 4px solid #ffc107;
                    }
                    
                    .preview-tips h5 {
                        margin: 0 0 10px 0;
                        color: #856404;
                        font-size: 14px;
                    }
                    
                    .preview-tips ul {
                        margin: 0;
                        padding-left: 20px;
                    }
                    
                    .preview-tips li {
                        font-size: 13px;
                        color: #856404;
                        margin-bottom: 4px;
                        line-height: 1.4;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 平滑滚动到预览区域
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast('📋 生成预览已显示，确认无误后点击"AI智能生成"');
        }
        
        function getDifficultyText(difficulty) {
            const texts = {
                'easier': '🟢 简化版',
                'same': '🟡 相同难度', 
                'harder': '🔴 提高版',
                'mixed': '🌈 混合难度'
            };
            return texts[difficulty] || '🟡 相同难度';
        }
        
        function getQuestionTypeText(type) {
            const texts = {
                'similar': '📋 相似题目',
                'extended': '🔄 拓展变式',
                'comprehensive': '🧠 综合应用'
            };
            return texts[type] || '📋 相似题目';
        }
        
        async function generatePractice(errorId) {
            const error = errorData.find(e => e.id === errorId);
            if (!error) {
                showToast('找不到该错题信息');
                return;
            }
            
            const questionCount = document.getElementById('questionCount').value;
            const difficultyLevel = document.getElementById('difficultyLevel').value;
            const questionType = document.getElementById('questionType').value;
            const includeAnswers = document.getElementById('includeAnswers').checked;
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            const generateBtn = document.querySelector('.generate-btn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '⏳ AI生成中...';
            generateBtn.disabled = true;
            
            try {
                console.log('开始调用AI生成练习题API...');
                console.log('错题信息:', error);
                
                // 调用真正的AI生成练习题API
                const response = await fetch(`${API_BASE}/practice/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        original_question: {
                            id: error.id,
                            subject: error.subject,
                            question_text: error.question_text,
                            user_answer: error.user_answer,
                            correct_answer: error.correct_answer,
                            error_type: error.error_type,
                            knowledge_points: error.knowledge_points || []
                        },
                        question_count: parseInt(questionCount),
                        difficulty_level: difficultyLevel,
                        question_type: questionType,
                        include_answers: includeAnswers,
                        include_analysis: includeAnalysis
                    })
                });
                
                console.log('API响应状态:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('AI生成结果:', result);
                    
                    if (result.success && result.questions && result.questions.length > 0) {
                        // 转换API返回的数据格式为前端期望的格式
                        const convertedQuestions = result.questions.map(q => ({
                            number: q.number,
                            difficulty: q.difficulty,
                            content: q.question_text,
                            answer: q.correct_answer,
                            analysis: q.analysis
                        }));
                        
                        displayGeneratedQuestions(convertedQuestions);
                        showToast(`✅ AI成功生成${convertedQuestions.length}道高质量练习题！`);
                    } else {
                        throw new Error(result.message || 'AI生成返回数据格式错误');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API错误响应:', errorText);
                    throw new Error(`AI生成失败: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('AI生成练习题失败:', error);
                showToast(`❌ AI生成失败: ${error.message}`);
                
                // 降级到本地模拟生成
                console.log('降级到本地模拟生成...');
                try {
                    const mockQuestions = generateMockQuestions(error, questionCount, difficultyLevel, includeAnswers, includeAnalysis);
                    displayGeneratedQuestions(mockQuestions);
                    showToast('⚠️ 使用本地智能生成（AI服务暂时不可用）');
                } catch (mockError) {
                    console.error('本地生成也失败:', mockError);
                    showToast('❌ 练习题生成失败，请重试');
                }
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }
        
        function generateMockQuestions(originalError, count, difficulty, includeAnswers, includeAnalysis) {
            const questions = [];
            const difficultyLabels = {
                'easier': '简单',
                'same': '相同',
                'harder': '困难',
                'mixed': '混合'
            };
            
            for (let i = 1; i <= count; i++) {
                let question;
                
                if (originalError.subject === '数学') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateMathQuestion(originalError, difficulty),
                        answer: generateMathAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else if (originalError.subject === '语文') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateChineseQuestion(originalError, difficulty),
                        answer: generateChineseAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else if (originalError.subject === '英语') {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateEnglishQuestion(originalError, difficulty),
                        answer: generateEnglishAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                } else {
                    question = {
                        number: i,
                        difficulty: difficulty === 'mixed' ? (i % 3 === 0 ? 'harder' : i % 2 === 0 ? 'same' : 'easier') : difficulty,
                        content: generateGeneralQuestion(originalError, difficulty, i),
                        answer: generateGeneralAnswer(i),
                        analysis: includeAnalysis ? generateAnalysis(originalError.subject, i) : null
                    };
                }
                
                questions.push(question);
            }
            
            return questions;
        }
        
        function generateMathQuestion(originalError, difficulty) {
            if (originalError.question_text.includes('×')) {
                const bases = difficulty === 'easier' ? [15, 23, 34, 45] : 
                            difficulty === 'harder' ? [156, 234, 378, 456] : 
                            [125, 156, 234, 267];
                const multipliers = difficulty === 'easier' ? [6, 7, 8, 9] : 
                                  difficulty === 'harder' ? [12, 15, 18, 23] : 
                                  [8, 9, 11, 12];
                const base = bases[Math.floor(Math.random() * bases.length)];
                const mult = multipliers[Math.floor(Math.random() * multipliers.length)];
                return `计算：${base} × ${mult} = ?`;
            } else if (originalError.question_text.includes('方程')) {
                if (difficulty === 'easier') {
                    return `解方程：x + ${Math.floor(Math.random() * 10) + 5} = ${Math.floor(Math.random() * 20) + 10}`;
                } else if (difficulty === 'harder') {
                    return `解方程：${Math.floor(Math.random() * 3) + 2}x + ${Math.floor(Math.random() * 10) + 3} = ${Math.floor(Math.random() * 30) + 15}`;
                } else {
                    return `解方程：${Math.floor(Math.random() * 2) + 2}x + ${Math.floor(Math.random() * 8) + 4} = ${Math.floor(Math.random() * 20) + 12}`;
                }
            } else {
                return `根据原题特点生成的${difficulty === 'easier' ? '简化版' : difficulty === 'harder' ? '提高版' : '同等难度'}数学题目`;
            }
        }
        
        function generateChineseQuestion(originalError, difficulty) {
            if (originalError.question_text.includes('作者')) {
                const works = difficulty === 'easier' ? 
                    ['《春晓》', '《登鹳雀楼》', '《静夜思》'] :
                    difficulty === 'harder' ?
                    ['《滕王阁序》', '《岳阳楼记》', '《赤壁赋》'] :
                    ['《春望》', '《望岳》', '《茅屋为秋风所破歌》'];
                const work = works[Math.floor(Math.random() * works.length)];
                return `请写出${work}的作者`;
            } else if (originalError.question_text.includes('词语') || originalError.question_text.includes('错别字')) {
                return `下列词语中，${difficulty === 'harder' ? '书写完全正确且含义恰当' : '没有错别字'}的一组是（）`;
            } else {
                return `根据原题特点生成的${difficulty === 'easier' ? '基础版' : difficulty === 'harder' ? '提高版' : '同等难度'}语文题目`;
            }
        }
        
        function generateEnglishQuestion(originalError, difficulty) {
            if (originalError.question_text.toLowerCase().includes('choose') || originalError.question_text.includes('go')) {
                const subjects = ['I', 'He', 'She', 'They', 'We'];
                const verbs = difficulty === 'easier' ? ['go', 'come', 'eat', 'play'] :
                             difficulty === 'harder' ? ['have been going', 'will have gone', 'had gone'] :
                             ['goes', 'went', 'will go', 'is going'];
                const subject = subjects[Math.floor(Math.random() * subjects.length)];
                const verb = verbs[Math.floor(Math.random() * verbs.length)];
                return `Choose the correct answer: ${subject} _____ to school every day. (${verb})`;
            } else if (originalError.question_text.toLowerCase().includes('translate')) {
                if (difficulty === 'easier') {
                    return 'Translate: I like music.';
                } else if (difficulty === 'harder') {
                    return 'Translate: Despite the challenging circumstances, she managed to achieve her goals.';
                } else {
                    return 'Translate: I enjoy reading books in my spare time.';
                }
            } else {
                return `根据原题特点生成的${difficulty === 'easier' ? '基础版' : difficulty === 'harder' ? '提高版' : '同等难度'}英语题目`;
            }
        }
        
        function generateGeneralQuestion(originalError, difficulty, index) {
            return `${originalError.subject}练习题 ${index}：基于"${originalError.error_type}"的${difficulty === 'easier' ? '简化' : difficulty === 'harder' ? '提高' : '同等难度'}练习`;
        }
        
        function generateMathAnswer(index) {
            const answers = ['1000', '1872', '2016', '3588', '4104', '2805', '1380', '1584', '2457', '3402'];
            return answers[index % answers.length];
        }
        
        function generateChineseAnswer(index) {
            const answers = ['李白', '杜甫', '白居易', 'C', 'B', 'A', '主语', '谓语', '定语', '状语'];
            return answers[index % answers.length];
        }
        
        function generateEnglishAnswer(index) {
            const answers = ['go', 'goes', 'went', '我喜欢音乐', '我喜欢在空闲时间读书', 'She goes', 'They play', 'We eat'];
            return answers[index % answers.length];
        }
        
        function generateGeneralAnswer(index) {
            return `答案 ${index}`;
        }
        
        function generateAnalysis(subject, index) {
            const analyses = {
                '数学': [
                    '本题考查乘法运算，需要掌握多位数乘法的计算方法，注意进位处理',
                    '解一元一次方程的基本步骤：移项、合并同类项、系数化为1',
                    '圆的面积公式 S = πr²，注意π的取值和小数精度',
                    '三角形内角和定理：任意三角形的三个内角之和为180°'
                ],
                '语文': [
                    '古诗文作者识记是语文基础知识，需要积累重要作品和对应作者',
                    '错别字辨析要注意形近字、音近字的区别，培养良好的书写习惯',
                    '文言文翻译要注意词语的古今异义，结合语境理解',
                    '句子成分分析：主语表示动作的执行者，谓语表示动作或状态'
                ],
                '英语': [
                    '一般现在时第三人称单数形式：主语为he/she/it时，动词要加-s或-es',
                    '英汉互译要注意语序差异，英语多用主谓宾结构',
                    '时态选择要根据时间状语和语境判断，注意时态一致性',
                    '词汇积累是英语学习的基础，要注意单词的词性和用法'
                ]
            };
            
            const subjectAnalyses = analyses[subject] || ['这是一道基础练习题，需要掌握相关概念和方法'];
            return subjectAnalyses[(index - 1) % subjectAnalyses.length];
        }
        
        function displayGeneratedQuestions(questions) {
            const resultDiv = document.getElementById('practiceResult');
            const includeAnswers = document.getElementById('includeAnswers').checked;
            
            let html = `
                <div class="result-header">
                    <h4>📋 生成的练习题（共${questions.length}题）</h4>
                </div>
                <div class="questions-container">
            `;
            
            questions.forEach(question => {
                const difficultyBadge = getDifficultyBadge(question.difficulty);
                html += `
                    <div class="generated-question">
                        <div class="question-number">
                            第${question.number}题 ${difficultyBadge}
                        </div>
                        <div class="question-content">
                            ${question.content}
                        </div>
                `;
                
                if (includeAnswers && question.answer) {
                    html += `
                        <div class="question-answer">
                            <div class="answer-label">💡 参考答案：</div>
                            <div>${question.answer}</div>
                        </div>
                    `;
                }
                
                if (question.analysis) {
                    html += `
                        <div class="question-answer" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <div class="answer-label" style="color: #856404;">📖 解题思路：</div>
                            <div style="color: #856404;">${question.analysis}</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `
                </div>
                <div class="export-actions">
                    <button class="export-btn word-btn" onclick="exportToWord(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                        📝 导出Word
                    </button>
                    <button class="export-btn wechat-btn" onclick="shareToWechat(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                        💚 微信分享
                    </button>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // 平滑滚动到结果区域
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast(`✅ 成功生成${questions.length}道练习题！`);
        }
        
        function getDifficultyBadge(difficulty) {
            const badges = {
                'easier': '<span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size: 12px;">简单</span>',
                'same': '<span style="background: #cce5ff; color: #004085; padding: 2px 8px; border-radius: 12px; font-size: 12px;">相同</span>',
                'harder': '<span style="background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 12px; font-size: 12px;">困难</span>'
            };
            return badges[difficulty] || badges['same'];
        }
        
        
        
        function generatePrintHTML(questions) {
            const timestamp = new Date().toLocaleString();
            
            return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>练习题集</title>
    <style>
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        body {
            font-family: 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20mm;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 20px;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 10px;
        }
        
        .meta {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .question {
            margin-bottom: 25px;
            page-break-inside: avoid;
            border-left: 4px solid #007AFF;
            padding-left: 15px;
        }
        
        .question-number {
            font-size: 16px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 8px;
        }
        
        .question-content {
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.8;
        }
        
        .answer {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            border-left: 3px solid #28a745;
        }
        
        .analysis {
            background: #fff8dc;
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            border-left: 3px solid #ffc107;
        }
        
        .label {
            font-weight: bold;
            color: #555;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .difficulty-easier { background: #d4edda; color: #155724; }
        .difficulty-same { background: #cce5ff; color: #004085; }
        .difficulty-harder { background: #f8d7da; color: #721c24; }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        @page {
            size: A4;
            margin: 15mm;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">📚 练习题集</div>
        <div class="meta">生成时间：${timestamp}</div>
        <div class="meta">题目数量：${questions.length} 道</div>
    </div>
    
    ${questions.map((question, index) => {
        const difficultyClass = `difficulty-${question.difficulty}`;
        const difficultyText = getDifficultyText(question.difficulty);
        
        return `
    <div class="question">
        <div class="question-number">
            第${question.number}题
            <span class="difficulty-badge ${difficultyClass}">${difficultyText}</span>
        </div>
        <div class="question-content">${question.content}</div>
        ${question.answer ? `
        <div class="answer">
            <span class="label">💡 参考答案：</span>${question.answer}
        </div>
        ` : ''}
        ${question.analysis ? `
        <div class="analysis">
            <span class="label">📖 解题思路：</span>${question.analysis}
        </div>
        ` : ''}
    </div>
        `;
    }).join('')}
    
    <div class="footer">
        <p>📱 ZYJC智能批改系统生成</p>
        <p>生成时间：${timestamp}</p>
    </div>
</body>
</html>
            `;
        }
        
        function convertToSafeText(text) {
            if (!text) return '';
            
            // 保留基础中文字符，替换特殊字符为安全字符
            return text
                .replace(/[^\u0000-\u007F\u4e00-\u9fff]/g, '') // 保留ASCII和中文字符
                .replace(/[""]/g, '"') // 替换特殊引号
                .replace(/['']/g, "'") // 替换特殊单引号
                .replace(/…/g, '...') // 替换省略号
                .replace(/—/g, '-') // 替换长破折号
                .replace(/·/g, '.') // 替换间隔号
                .trim();
        }
        
        
        
        function closeDebugModal() {
            const modal = document.getElementById('debugModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        
        
        function exportAsHTML() {
            if (!window.debugQuestions) {
                showToast('没有找到调试题目数据');
                return;
            }
            
            exportToHTML(window.debugQuestions);
            showToast('已导出为HTML格式');
        }
        
        
        
        function exportToHTML(questions) {
            try {
                showToast('正在生成HTML文件...');
                
                let htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>练习题集</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 20px;
        }
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 10px;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .question {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
        }
        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 12px;
        }
        .question-content {
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.8;
        }
        .answer {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .analysis {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }
        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .difficulty-easier { background: #d4edda; color: #155724; }
        .difficulty-same { background: #cce5ff; color: #004085; }
        .difficulty-harder { background: #f8d7da; color: #721c24; }
        
        @media print {
            body { margin: 0; padding: 20px; }
            .question { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">📚 练习题集</div>
        <div class="info">生成时间：${new Date().toLocaleString()}</div>
        <div class="info">题目数量：${questions.length} 道</div>
    </div>
`;
                
                questions.forEach(question => {
                    const difficultyClass = `difficulty-${question.difficulty}`;
                    const difficultyText = getDifficultyText(question.difficulty);
                    
                    htmlContent += `
    <div class="question">
        <div class="question-number">
            第${question.number}题
            <span class="difficulty-badge ${difficultyClass}">${difficultyText}</span>
        </div>
        <div class="question-content">${question.content}</div>
`;
                    
                    if (question.answer) {
                        htmlContent += `
        <div class="answer">
            <span class="label">💡 参考答案</span>
            ${question.answer}
        </div>
`;
                    }
                    
                    if (question.analysis) {
                        htmlContent += `
        <div class="analysis">
            <span class="label">📖 解题思路</span>
            ${question.analysis}
        </div>
`;
                    }
                    
                    htmlContent += `    </div>`;
                });
                
                htmlContent += `
</body>
</html>
`;
                
                // 创建下载链接
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `练习题集-${new Date().toLocaleDateString().replace(/\//g, '')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('✅ HTML文件下载成功！可用浏览器打开后打印为PDF');
                
            } catch (error) {
                console.error('HTML导出失败:', error);
                exportToText(questions, 'HTML');
            }
        }
        
        async function exportToWord(questions) {
            try {
                showToast('正在生成Word文档...');
                
                // 创建Word文档内容
                let docContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>练习题集</title>
    <style>
        body { font-family: '微软雅黑', Arial; margin: 40px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; }
        .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .date { font-size: 12px; color: #666; }
        .question { margin-bottom: 25px; page-break-inside: avoid; }
        .question-number { font-size: 16px; font-weight: bold; color: #007AFF; margin-bottom: 8px; }
        .question-content { font-size: 14px; margin-bottom: 10px; }
        .answer { background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 8px 0; }
        .analysis { background: #fff8dc; padding: 10px; border-radius: 5px; margin: 8px 0; }
        .label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">练习题集</div>
        <div class="date">生成时间：${new Date().toLocaleString()}</div>
    </div>
`;
                
                questions.forEach(question => {
                    docContent += `
    <div class="question">
        <div class="question-number">第${question.number}题 (${getDifficultyText(question.difficulty)})</div>
        <div class="question-content">${question.content}</div>
`;
                    
                    if (question.answer) {
                        docContent += `
        <div class="answer">
            <span class="label">参考答案：</span>${question.answer}
        </div>
`;
                    }
                    
                    if (question.analysis) {
                        docContent += `
        <div class="analysis">
            <span class="label">解题思路：</span>${question.analysis}
        </div>
`;
                    }
                    
                    docContent += `    </div>`;
                });
                
                docContent += `
</body>
</html>
`;
                
                // 创建下载链接
                const blob = new Blob([docContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = '练习题集.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('✅ Word文档下载成功！');
                
            } catch (error) {
                console.error('Word导出失败:', error);
                exportToText(questions, 'Word');
            }
        }
        
        function exportToText(questions, format) {
            let content = `练习题集\n生成时间：${new Date().toLocaleString()}\n\n`;
            
            questions.forEach(question => {
                content += `第${question.number}题 (${getDifficultyText(question.difficulty)})\n`;
                content += `${question.content}\n`;
                
                if (question.answer) {
                    content += `参考答案：${question.answer}\n`;
                }
                
                if (question.analysis) {
                    content += `解题思路：${question.analysis}\n`;
                }
                
                content += '\n---\n\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `练习题集.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`✅ ${format}格式导出为文本文件成功！`);
        }
        
        function getDifficultyText(difficulty) {
            const texts = {
                'easier': '简单',
                'same': '相同难度',
                'harder': '困难'
            };
            return texts[difficulty] || '相同难度';
        }
        
        function shareToWechat(questions) {
            // 显示分享选项菜单
            showShareOptionsModal(questions);
        }
        
        function showShareOptionsModal(questions) {
            const shareModal = document.createElement('div');
            shareModal.id = 'shareOptionsModal';
            shareModal.innerHTML = `
                <div class="share-options-overlay" onclick="closeShareOptionsModal()">
                    <div class="share-options-content" onclick="event.stopPropagation()">
                        <div class="share-options-header">
                            <h3>📤 选择分享方式</h3>
                            <button onclick="closeShareOptionsModal()" class="close-share-btn">×</button>
                        </div>
                        <div class="share-options-body">
                            <div class="share-option" onclick="shareAsText(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">📝</div>
                                <div class="share-info">
                                    <div class="share-title">文本形式</div>
                                    <div class="share-desc">复制题目文本，方便粘贴到微信</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareAsImage(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">🖼️</div>
                                <div class="share-info">
                                    <div class="share-title">图片形式</div>
                                    <div class="share-desc">生成练习题图片，直接发送到微信</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareAsLink(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">🔗</div>
                                <div class="share-info">
                                    <div class="share-title">链接形式</div>
                                    <div class="share-desc">生成在线练习链接，实时互动</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareToWechatDirect(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">💚</div>
                                <div class="share-info">
                                    <div class="share-title">直接发微信</div>
                                    <div class="share-desc">在手机上直接跳转到微信分享</div>
                                </div>
                            </div>
                            
                            <div class="share-option" onclick="shareToSystem(${JSON.stringify(questions).replace(/"/g, '&quot;')})">
                                <div class="share-icon">📱</div>
                                <div class="share-info">
                                    <div class="share-title">系统分享</div>
                                    <div class="share-desc">使用设备自带分享功能</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .share-options-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .share-options-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .share-options-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .share-options-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .share-options-body {
                    padding: 10px;
                }
                
                .share-option {
                    display: flex;
                    align-items: center;
                    padding: 15px;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: background-color 0.3s ease;
                    margin-bottom: 5px;
                }
                
                .share-option:hover {
                    background: #f8f9fa;
                }
                
                .share-icon {
                    font-size: 24px;
                    margin-right: 15px;
                    width: 40px;
                    text-align: center;
                }
                
                .share-info {
                    flex: 1;
                }
                
                .share-title {
                    font-size: 16px;
                    font-weight: 500;
                    color: #333;
                    margin-bottom: 4px;
                }
                
                .share-desc {
                    font-size: 13px;
                    color: #666;
                    line-height: 1.4;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(shareModal);
        }
        
        function closeShareOptionsModal() {
            const modal = document.getElementById('shareOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function shareAsText(questions) {
            closeShareOptionsModal();
            
            // 创建简洁的文本分享内容
            let shareText = `📚 练习题集 (${questions.length}题)\n`;
            shareText += `━━━━━━━━━━━━━━━━\n\n`;
            
            questions.forEach((question, index) => {
                shareText += `${question.number}. ${question.content}\n`;
                
                if (question.answer && document.getElementById('includeAnswers').checked) {
                    shareText += `💡 ${question.answer}\n`;
                }
                
                if (question.analysis && document.getElementById('includeAnalysis').checked) {
                    shareText += `📖 ${question.analysis}\n`;
                }
                
                shareText += '\n';
            });
            
            shareText += `━━━━━━━━━━━━━━━━\n`;
            shareText += `📅 ${new Date().toLocaleString()}\n`;
            shareText += `🔗 ZYJC智能批改生成`;
            
            fallbackShare(shareText);
        }
        
        async function shareAsImage(questions) {
            closeShareOptionsModal();
            
            try {
                showToast('正在生成分享图片...');
                
                // 创建canvas生成图片
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // 设置canvas尺寸
                canvas.width = 600;
                canvas.height = Math.max(800, questions.length * 200 + 200);
                
                // 设置背景
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 设置字体
                ctx.font = '24px Microsoft YaHei';
                ctx.fillStyle = '#007AFF';
                ctx.textAlign = 'center';
                
                // 标题
                ctx.fillText(`📚 练习题集 (${questions.length}题)`, canvas.width / 2, 50);
                
                // 时间
                ctx.font = '14px Microsoft YaHei';
                ctx.fillStyle = '#666';
                ctx.fillText(new Date().toLocaleString(), canvas.width / 2, 80);
                
                let yPosition = 120;
                
                questions.forEach((question, index) => {
                    // 题目
                    ctx.font = '16px Microsoft YaHei';
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'left';
                    
                    const questionText = `${question.number}. ${question.content}`;
                    const lines = wrapText(ctx, questionText, 50, 500);
                    
                    lines.forEach((line, lineIndex) => {
                        ctx.fillText(line, 50, yPosition + lineIndex * 25);
                    });
                    
                    yPosition += lines.length * 25 + 10;
                    
                    // 答案
                    if (question.answer && document.getElementById('includeAnswers').checked) {
                        ctx.font = '14px Microsoft YaHei';
                        ctx.fillStyle = '#2e7d32';
                        ctx.fillText(`💡 ${question.answer}`, 70, yPosition);
                        yPosition += 25;
                    }
                    
                    yPosition += 20; // 题目间距
                });
                
                // 转换为blob并下载
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `练习题集-${new Date().toLocaleDateString().replace(/\//g, '')}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showToast('✅ 图片已下载，可直接发送到微信！');
                });
                
            } catch (error) {
                console.error('生成图片失败:', error);
                showToast('图片生成失败，请使用文本分享');
                shareAsText(questions);
            }
        }
        
        function wrapText(ctx, text, x, maxWidth) {
            const words = text.split('');
            const lines = [];
            let currentLine = '';
            
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i];
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        function shareAsLink(questions) {
            closeShareOptionsModal();
            
            try {
                // 生成一个简单的分享链接（模拟）
                const questionsData = encodeURIComponent(JSON.stringify(questions));
                const shareUrl = `${window.location.origin}/practice-view.html?data=${questionsData.substring(0, 500)}...`;
                
                const shareText = `📚 我生成了一套练习题，快来挑战吧！\n\n` +
                                `🔢 题目数量：${questions.length}道\n` +
                                `📅 生成时间：${new Date().toLocaleString()}\n\n` +
                                `👆 点击链接开始练习：\n${shareUrl}\n\n` +
                                `🔗 由ZYJC智能批改生成`;
                
                fallbackShare(shareText);
                
            } catch (error) {
                console.error('生成链接失败:', error);
                shareAsText(questions);
            }
        }
        
        function shareToWechatDirect(questions) {
            closeShareOptionsModal();
            
            try {
                // 检查是否为移动设备
                if (!isMobileDevice()) {
                    showToast('直接分享微信功能仅支持手机端，请使用其他分享方式');
                    shareAsText(questions);
                    return;
                }
                
                // 准备分享内容
                const shareText = createWechatShareText(questions);
                
                // 先将内容复制到剪贴板
                copyToClipboard(shareText).then(() => {
                    showToast('📋 内容已复制到剪贴板');
                    
                    // 延迟一下，确保复制完成
                    setTimeout(() => {
                        // 尝试多种方式调用微信
                        if (openWechatApp(shareText)) {
                            showToast('💚 正在打开微信...');
                        } else {
                            // 降级方案：显示操作指引
                            showWechatGuide(shareText);
                        }
                    }, 500);
                    
                }).catch(error => {
                    console.error('复制失败:', error);
                    showWechatGuide(shareText);
                });
                
            } catch (error) {
                console.error('微信分享失败:', error);
                shareAsText(questions);
            }
        }
        
        function createWechatShareText(questions) {
            const includeAnswers = document.getElementById('includeAnswers')?.checked;
            const includeAnalysis = document.getElementById('includeAnalysis')?.checked;
            
            let shareText = `📚 练习题集 (${questions.length}题)\n`;
            shareText += `━━━━━━━━━━━━━━━━\n\n`;
            
            questions.forEach((question, index) => {
                shareText += `${question.number}. ${question.content}\n`;
                
                if (includeAnswers && question.answer) {
                    shareText += `💡 ${question.answer}\n`;
                }
                
                if (includeAnalysis && question.analysis) {
                    shareText += `📖 ${question.analysis}\n`;
                }
                
                shareText += '\n';
            });
            
            shareText += `━━━━━━━━━━━━━━━━\n`;
            shareText += `📅 ${new Date().toLocaleString()}\n`;
            shareText += `🔗 ZYJC智能批改生成`;
            
            return shareText;
        }
        
        async function copyToClipboard(text) {
            try {
                // 优先使用现代API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return;
                }
                
                // 降级方案：创建临时textarea
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                textArea.style.opacity = '0';
                textArea.style.pointerEvents = 'none';
                textArea.style.zIndex = '-1';
                
                document.body.appendChild(textArea);
                
                // 确保元素获得焦点
                textArea.focus();
                textArea.select();
                
                // 移动设备兼容
                if (textArea.setSelectionRange) {
                    textArea.setSelectionRange(0, text.length);
                }
                
                return new Promise((resolve, reject) => {
                    try {
                        const success = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (success) {
                            resolve();
                        } else {
                            reject(new Error('execCommand复制失败'));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
                
            } catch (error) {
                throw error;
            }
        }
        
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileKeywords = [
                'android', 'webos', 'iphone', 'ipad', 'ipod', 
                'blackberry', 'iemobile', 'opera mini', 'mobile',
                'windows phone', 'kindle', 'silk', 'fennec'
            ];
            
            return mobileKeywords.some(keyword => userAgent.includes(keyword));
        }
        
        function openWechatApp(shareText) {
            try {
                const userAgent = navigator.userAgent.toLowerCase();
                const isInWechat = userAgent.includes('micromessenger');
                
                if (isInWechat) {
                    // 如果已经在微信中，直接提示分享
                    showToast('✅ 内容已准备好，请点击右上角分享按钮');
                    return true;
                }
                
                // 尝试调用微信URL Scheme
                const wechatSchemes = [
                    'weixin://',  // 微信主要scheme
                    'wechat://',  // 备用scheme
                ];
                
                let success = false;
                
                // iOS设备
                if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                    // 尝试iOS的Universal Link和URL Scheme
                    const iosLinks = [
                        'weixin://dl/general',  // 微信通用链接
                        'weixin://dl/chat',     // 微信聊天
                        'weixin://',            // 基本scheme
                    ];
                    
                    for (const link of iosLinks) {
                        try {
                            window.location.href = link;
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    // iOS备用方案 - 使用hidden iframe
                    if (!success) {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = 'weixin://';
                        document.body.appendChild(iframe);
                        
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                        }, 1000);
                        
                        success = true;
                    }
                }
                
                // Android设备
                else if (userAgent.includes('android')) {
                    // Android Intent方式
                    const androidIntents = [
                        'intent://dl/general/#Intent;scheme=weixin;package=com.tencent.mm;end',
                        'intent:///#Intent;scheme=weixin;package=com.tencent.mm;S.android.intent.extra.TEXT=' + encodeURIComponent(shareText) + ';type=text/plain;end',
                    ];
                    
                    for (const intent of androidIntents) {
                        try {
                            window.location.href = intent;
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    // Android备用方案
                    if (!success) {
                        try {
                            window.location.href = 'weixin://';
                            success = true;
                        } catch (e) {
                            // 最后尝试通过app store链接
                            window.location.href = 'market://details?id=com.tencent.mm';
                            success = true;
                        }
                    }
                }
                
                return success;
                
            } catch (error) {
                console.error('打开微信失败:', error);
                return false;
            }
        }
        
        function showWechatGuide(shareText) {
            // 创建微信操作指引模态框
            const guideModal = document.createElement('div');
            guideModal.id = 'wechatGuideModal';
            guideModal.innerHTML = `
                <div class="wechat-guide-overlay" onclick="closeWechatGuide()">
                    <div class="wechat-guide-content" onclick="event.stopPropagation()">
                        <div class="wechat-guide-header">
                            <h3>💚 微信分享指引</h3>
                            <button onclick="closeWechatGuide()" class="close-guide-btn">×</button>
                        </div>
                        <div class="wechat-guide-body">
                            <div class="guide-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">内容已复制</div>
                                    <div class="step-desc">练习题内容已自动复制到剪贴板</div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">打开微信</div>
                                    <div class="step-desc">
                                        <button class="open-wechat-btn" onclick="tryOpenWechat()">
                                            点击打开微信 💚
                                        </button>
                                        <div class="or-text">或手动打开微信App</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">选择分享对象</div>
                                    <div class="step-desc">选择好友、群聊或朋友圈</div>
                                </div>
                            </div>
                            
                            <div class="guide-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">粘贴内容</div>
                                    <div class="step-desc">长按输入框，选择"粘贴"即可</div>
                                </div>
                            </div>
                            
                            <div class="preview-section">
                                <div class="preview-title">📋 分享内容预览：</div>
                                <div class="preview-content">${shareText.substring(0, 200)}...</div>
                                <button class="copy-again-btn" onclick="copyAgain('${shareText.replace(/'/g, "\\'")}')">
                                    📋 重新复制
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .wechat-guide-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .wechat-guide-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 400px;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .wechat-guide-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                    background: #f8f9fa;
                    border-radius: 16px 16px 0 0;
                }
                
                .wechat-guide-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .close-guide-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                    padding: 4px;
                    border-radius: 50%;
                }
                
                .close-guide-btn:hover {
                    background: #e9ecef;
                }
                
                .wechat-guide-body {
                    padding: 20px;
                }
                
                .guide-step {
                    display: flex;
                    margin-bottom: 20px;
                    align-items: flex-start;
                }
                
                .step-number {
                    width: 32px;
                    height: 32px;
                    background: #1aad19;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 14px;
                    margin-right: 15px;
                    flex-shrink: 0;
                }
                
                .step-content {
                    flex: 1;
                }
                
                .step-title {
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 4px;
                }
                
                .step-desc {
                    font-size: 14px;
                    color: #666;
                    line-height: 1.5;
                }
                
                .open-wechat-btn {
                    background: #1aad19;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                    margin-bottom: 8px;
                }
                
                .open-wechat-btn:hover {
                    background: #16a113;
                }
                
                .or-text {
                    font-size: 12px;
                    color: #999;
                }
                
                .preview-section {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 20px;
                }
                
                .preview-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 10px;
                }
                
                .preview-content {
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    padding: 10px;
                    font-size: 12px;
                    color: #666;
                    line-height: 1.4;
                    margin-bottom: 12px;
                    white-space: pre-wrap;
                }
                
                .copy-again-btn {
                    background: #007AFF;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    font-size: 13px;
                    cursor: pointer;
                }
                
                .copy-again-btn:hover {
                    background: #0056CC;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(guideModal);
        }
        
        function closeWechatGuide() {
            const modal = document.getElementById('wechatGuideModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function tryOpenWechat() {
            try {
                // 再次尝试打开微信
                if (openWechatApp()) {
                    showToast('💚 正在尝试打开微信...');
                    setTimeout(() => {
                        closeWechatGuide();
                    }, 1000);
                } else {
                    showToast('请手动打开微信App');
                }
            } catch (error) {
                showToast('请手动打开微信App');
            }
        }
        
        async function copyAgain(text) {
            // 获取按钮以显示状态
            const copyBtn = event.target;
            const originalText = copyBtn.textContent;
            
            // 显示复制中状态
            copyBtn.textContent = '📋 复制中...';
            copyBtn.disabled = true;
            
            try {
                await copyToClipboard(text);
                
                // 显示成功状态
                copyBtn.textContent = '✅ 已复制';
                copyBtn.style.background = '#28a745';
                showToast('📋 已复制');
                
                // 2秒后恢复原状
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#007AFF';
                    copyBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('复制失败:', error);
                copyBtn.textContent = originalText;
                copyBtn.disabled = false;
                showToast('❌ 复制失败，请手动复制');
            }
        }
        
        function shareToSystem(questions) {
            closeShareOptionsModal();
            
            const shareText = `📚 练习题集（${questions.length}题）\n\n` +
                            questions.map(q => `${q.number}. ${q.content}`).join('\n\n') +
                            `\n\n📅 ${new Date().toLocaleString()}\n🔗 ZYJC智能批改生成`;
            
            // 检查是否支持Web Share API
            if (navigator.share) {
                navigator.share({
                    title: '练习题集',
                    text: shareText
                }).then(() => {
                    showToast('✅ 分享成功！');
                }).catch(error => {
                    console.error('系统分享失败:', error);
                    fallbackShare(shareText);
                });
            } else {
                showToast('设备不支持系统分享，使用复制分享');
                fallbackShare(shareText);
            }
        }
        
        function fallbackShare(text) {
            // 创建分享模态框
            const shareModal = document.createElement('div');
            shareModal.id = 'shareModal';
            shareModal.innerHTML = `
                <div class="share-modal-overlay" onclick="closeShareModal()">
                    <div class="share-modal-content" onclick="event.stopPropagation()">
                        <div class="share-modal-header">
                            <h3>💚 微信分享</h3>
                            <button onclick="closeShareModal()" class="close-share-btn">×</button>
                        </div>
                        <div class="share-modal-body">
                            <div class="share-instruction">
                                <p>📱 请复制下面的内容，然后粘贴到微信中分享：</p>
                            </div>
                            <textarea id="shareContent" class="share-textarea" readonly>${text}</textarea>
                            <div class="share-actions">
                                <button class="copy-btn" onclick="copyShareContent()">📋 复制内容</button>
                                <button class="qr-btn" onclick="generateQR()">📱 生成二维码</button>
                            </div>
                            <div id="qrCode" class="qr-container" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .share-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .share-modal-content {
                    background: white;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .share-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .close-share-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                }
                
                .share-modal-body {
                    padding: 20px;
                }
                
                .share-instruction {
                    margin-bottom: 16px;
                    color: #666;
                }
                
                .share-textarea {
                    width: 100%;
                    height: 200px;
                    padding: 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 12px;
                    resize: vertical;
                    margin-bottom: 16px;
                }
                
                .share-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                }
                
                .copy-btn, .qr-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s ease;
                }
                
                .copy-btn {
                    background: #007AFF;
                    color: white;
                }
                
                .copy-btn:hover {
                    background: #0056CC;
                    transform: translateY(-1px);
                }
                
                .copy-btn:active {
                    transform: translateY(0);
                    background: #004499;
                }
                
                .copy-btn:disabled {
                    opacity: 0.7;
                    cursor: not-allowed;
                    transform: none;
                }
                
                .copy-btn:disabled:hover {
                    transform: none;
                }
                
                .qr-btn {
                    background: #1aad19;
                    color: white;
                }
                
                .qr-container {
                    text-align: center;
                    margin-top: 20px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(shareModal);
        }
        
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        async function copyShareContent() {
            console.log('复制按钮被点击');
            
            // 获取按钮元素以显示状态
            const copyBtn = event.target;
            const originalText = copyBtn.textContent;
            
            const textarea = document.getElementById('shareContent');
            if (!textarea) {
                console.error('找不到shareContent元素');
                showToast('❌ 找不到分享内容');
                return;
            }
            console.log('找到textarea，内容长度:', textarea.value.length);
            
            // 显示复制中状态
            copyBtn.textContent = '📋 复制中...';
            copyBtn.disabled = true;
            
            try {
                // 优先使用现代API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textarea.value);
                    showCopySuccess(copyBtn, originalText);
                    showToast('📋 已复制', 1500);
                    return;
                }
                
                // 降级方案1：使用textarea选择
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, 99999); // 移动设备兼容
                
                const success = document.execCommand('copy');
                if (success) {
                    showCopySuccess(copyBtn, originalText);
                    showToast('📋 已复制', 1500);
                } else {
                    throw new Error('execCommand复制失败');
                }
                
            } catch (error) {
                console.error('复制失败:', error);
                
                // 降级方案2：创建临时元素
                try {
                    const tempInput = document.createElement('input');
                    tempInput.style.position = 'fixed';
                    tempInput.style.opacity = '0';
                    tempInput.style.left = '-9999px';
                    tempInput.value = textarea.value;
                    document.body.appendChild(tempInput);
                    
                    tempInput.focus();
                    tempInput.select();
                    tempInput.setSelectionRange(0, 99999);
                    
                    const copySuccess = document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    
                    if (copySuccess) {
                        showCopySuccess(copyBtn, originalText);
                        showToast('📋 已复制');
                    } else {
                        throw new Error('所有复制方法均失败');
                    }
                    
                } catch (finalError) {
                    // 最终降级：显示手动复制提示
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                    showToast('❌ 复制失败，请手动选择文本');
                    textarea.focus();
                    textarea.select();
                    console.error('所有复制方法均失败:', finalError);
                }
            }
        }
        
        function showCopySuccess(button, originalText) {
            // 显示成功状态
            button.textContent = '✅ 已复制';
            button.style.background = '#28a745';
            
            // 2秒后恢复原状
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#007AFF';
                button.disabled = false;
            }, 2000);
        }
        
        function generateQR() {
            const content = document.getElementById('shareContent').value;
            const qrContainer = document.getElementById('qrCode');
            
            // 这里可以集成QR码生成库，暂时显示提示
            qrContainer.innerHTML = `
                <p>📱 二维码生成功能</p>
                <p style="font-size: 12px; color: #666;">
                    请使用微信扫一扫功能，或将上方内容复制分享
                </p>
            `;
            qrContainer.style.display = 'block';
            
            showToast('二维码已生成');
        }

        async function removeError(errorId) {
            if (!confirm('确定要移除这道错题吗？移除后无法恢复。')) {
                return;
            }
            
            try {
                console.log(`开始删除错题ID: ${errorId}`);
                
                const response = await fetch(`${API_BASE}/student/error-book/${errorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('删除成功:', result);
                    
                    // 从本地数据中移除
                    errorData = errorData.filter(e => e.id !== errorId);
                    
                    // 重新渲染错题列表
                    filterErrors();
                    
                    // 更新统计信息
                    updateStatsOverview();
                    
                    // 更新筛选标签计数
                    updateFilterCounts();
                    
                    showToast('✅ 错题已成功移除');
                } else {
                    const errorText = await response.text();
                    throw new Error(`删除失败: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('移除错题失败:', error);
                showToast('❌ 移除失败，请重试', 'error');
            }
        }

        function submitHomework() {
            window.location.href = '/frontend/homework-submit.html';
        }

        function goBack() {
            // 错题本应该返回到学生首页
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function goToProfile() {
            window.location.href = '/frontend/profile.html';
        }

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, duration);
        }
        
        // 确保底部导航样式正确
        function ensureNavigationStyles() {
            console.log('开始设置底部导航样式...');
            
            const nav = document.querySelector('.global-bottom-nav');
            if (nav) {
                // 清理所有重复的首页按钮
                const homeButtons = nav.querySelectorAll('[onclick*="student-home"]');
                console.log('找到首页按钮数量:', homeButtons.length);
                
                // 移除所有首页按钮
                homeButtons.forEach(button => button.remove());
                
                // 重新创建一个首页按钮
                const homeButton = document.createElement('div');
                homeButton.className = 'global-nav-item';
                homeButton.onclick = function() { window.location.href = '/frontend/student-home.html'; };
                homeButton.innerHTML = '<div class="global-nav-icon">🏠</div><div class="global-nav-text">首页</div>';
                nav.insertBefore(homeButton, nav.firstChild);
                console.log('✅ 已重新创建唯一的首页按钮');
                // 设置导航容器样式
                nav.style.cssText = `
                    display: flex !important;
                    position: fixed !important;
                    bottom: 0 !important;
                    left: 50% !important;
                    transform: translateX(-50%) !important;
                    width: 100% !important;
                    max-width: 400px !important;
                    background: rgba(255, 255, 255, 0.95) !important;
                    backdrop-filter: blur(20px) !important;
                    border-top: 1px solid rgba(102, 126, 234, 0.1) !important;
                    padding: 8px 0 !important;
                    z-index: 9999 !important;
                `;
                
                // 为所有导航按钮应用统一样式
                const buttons = nav.querySelectorAll('.global-nav-item');
                buttons.forEach((button, index) => {
                    const isActive = button.classList.contains('active');
                    
                    // 统一的按钮样式
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 8px 4px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        position: relative !important;
                        z-index: 1 !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 
                            'background: rgba(102, 126, 234, 0.1) !important; color: #667eea !important;' : 
                            'background: transparent !important; color: inherit !important;'}
                    `;
                    
                    // 设置图标样式
                    const icon = button.querySelector('.global-nav-icon');
                    if (icon) {
                        icon.style.cssText = `
                            font-size: 20px !important;
                            margin-bottom: 2px !important;
                            transition: all 0.3s ease !important;
                            display: block !important;
                            ${isActive ? 'transform: scale(1.05) !important; filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3)) !important;' : ''}
                        `;
                    }
                    
                    // 设置文字样式
                    const text = button.querySelector('.global-nav-text');
                    if (text) {
                        text.style.cssText = `
                            font-size: 10px !important;
                            line-height: 1 !important;
                            font-weight: 500 !important;
                            transition: all 0.3s ease !important;
                        `;
                    }
                });
                
                console.log('✅ 导航样式设置完成，按钮数量:', buttons.length);
            }
            
            // 确保页面底部有足够的空间
            document.body.style.paddingBottom = '80px';
        }
        
        // 确保只执行一次
        let navigationStylesApplied = false;
        
        function applyNavigationStylesOnce() {
            if (!navigationStylesApplied) {
                navigationStylesApplied = true;
                ensureNavigationStyles();
            }
        }
        
        // 页面加载时执行一次
        document.addEventListener('DOMContentLoaded', applyNavigationStylesOnce);
        setTimeout(applyNavigationStylesOnce, 500);
        
        // 移除任何测试按钮
        function removeTestButton() {
            const existingTestButton = document.getElementById('test-home-button');
            if (existingTestButton) {
                existingTestButton.remove();
                console.log('✅ 测试按钮已移除');
            }
        }
        
        // 移除测试按钮
        setTimeout(removeTestButton, 1000);
        
        // 详细调试代码：检查底部导航
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                console.log('=== 底部导航调试信息 ===');
                const nav = document.querySelector('.global-bottom-nav');
                if (nav) {
                    console.log('✅ 底部导航容器找到了');
                    console.log('导航容器HTML:', nav.outerHTML.substring(0, 200) + '...');
                    
                    const navItems = nav.querySelectorAll('.global-nav-item');
                    console.log('导航按钮数量:', navItems.length);
                    
                    navItems.forEach((button, index) => {
                        const icon = button.querySelector('.global-nav-icon');
                        const text = button.querySelector('.global-nav-text');
                        const iconText = icon ? icon.textContent : 'NO_ICON';
                        const buttonText = text ? text.textContent : 'NO_TEXT';
                        const isActive = button.classList.contains('active');
                        
                        console.log(`按钮 ${index + 1}: ${iconText} ${buttonText} ${isActive ? '[ACTIVE]' : ''}`);
                        console.log(`  - 可见性: ${button.offsetWidth}x${button.offsetHeight}`);
                        console.log(`  - 位置: left=${button.offsetLeft}px, top=${button.offsetTop}px`);
                    });
                    
                    // 检查导航容器的样式
                    const navStyles = window.getComputedStyle(nav);
                    console.log('导航容器样式:');
                    console.log(`  - display: ${navStyles.display}`);
                    console.log(`  - position: ${navStyles.position}`);
                    console.log(`  - bottom: ${navStyles.bottom}`);
                    console.log(`  - z-index: ${navStyles.zIndex}`);
                    console.log(`  - visibility: ${navStyles.visibility}`);
                    
                } else {
                    console.log('❌ 底部导航容器未找到');
                    // 尝试查找所有可能的导航元素
                    const allNavs = document.querySelectorAll('[class*="nav"]');
                    console.log('找到的导航相关元素:', allNavs.length);
                    allNavs.forEach((el, i) => {
                        console.log(`  ${i + 1}: ${el.className} - ${el.tagName}`);
                    });
                }
                console.log('=== 调试信息结束 ===');
            }, 1000);
        });
    </script>
</body>
</html>