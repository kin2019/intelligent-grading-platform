<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试错题详情页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056CC;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h2>🔍 错题详情页面调试工具</h2>
        
        <div class="debug-section">
            <h3>环境检查</h3>
            <div id="envStatus"></div>
            <button class="test-btn" onclick="checkEnvironment()">检查环境</button>
        </div>
        
        <div class="debug-section">
            <h3>直接测试模拟数据</h3>
            <button class="test-btn" onclick="testMockData(1)">测试ID=1 (数学)</button>
            <button class="test-btn" onclick="testMockData(2)">测试ID=2 (语文)</button>
            <button class="test-btn" onclick="testMockData(3)">测试ID=3 (英语)</button>
            <div id="mockResult"></div>
        </div>
        
        <div class="debug-section">
            <h3>测试页面跳转</h3>
            <button class="test-btn" onclick="openErrorDetail(1)">打开错题1</button>
            <button class="test-btn" onclick="openErrorDetail(2)">打开错题2</button>
            <button class="test-btn" onclick="openErrorDetail(3)">打开错题3</button>
        </div>
        
        <div class="debug-section">
            <h3>本地存储管理</h3>
            <button class="test-btn" onclick="checkLocalStorage()">检查本地存储</button>
            <button class="test-btn" onclick="setTestToken()">设置测试Token</button>
            <button class="test-btn" onclick="clearAllData()">清除所有数据</button>
            <div id="storageInfo"></div>
        </div>
        
        <div class="debug-section">
            <h3>调试日志</h3>
            <button class="test-btn" onclick="clearLogs()">清除日志</button>
            <div id="debugLogs" class="log-area">等待调试信息...</div>
        </div>
    </div>

    <script>
        // 重写console.log来捕获日志
        const originalLog = console.log;
        const originalError = console.error;
        const debugLogs = document.getElementById('debugLogs');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            debugLogs.textContent += logMessage;
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG: ' + args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '), 'error');
        };

        function checkEnvironment() {
            const envStatus = document.getElementById('envStatus');
            let status = '';
            
            // 检查基本环境
            status += '<div class="status info">浏览器: ' + navigator.userAgent.split(' ')[0] + '</div>';
            status += '<div class="status info">当前URL: ' + window.location.href + '</div>';
            
            // 检查localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status += '<div class="status success">localStorage: 可用</div>';
            } catch (e) {
                status += '<div class="status error">localStorage: 不可用 - ' + e.message + '</div>';
            }
            
            // 检查fetch API
            if (typeof fetch !== 'undefined') {
                status += '<div class="status success">Fetch API: 可用</div>';
            } else {
                status += '<div class="status error">Fetch API: 不可用</div>';
            }
            
            envStatus.innerHTML = status;
        }

        function testMockData(errorId) {
            console.log('开始测试模拟数据生成，错题ID:', errorId);
            
            try {
                // 模拟错题详情页面的数据生成逻辑
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                const isReviewedLocal = reviewedErrors.includes(errorId.toString());
                
                const errorIdNum = parseInt(errorId) || 1;
                const subjectIndex = errorIdNum % 3;
                const subjects = ['math', 'chinese', 'english'];
                const difficulties = ['easy', 'medium', 'hard'];
                const baseSubject = subjects[subjectIndex];
                const baseDifficulty = difficulties[errorIdNum % 3];
                
                const mockData = {
                    id: errorId,
                    subject: baseSubject,
                    difficulty: baseDifficulty,
                    is_reviewed: isReviewedLocal,
                    created_at: new Date().toISOString(),
                    question_text: '测试题目内容',
                    user_answer: '用户答案',
                    correct_answer: '正确答案',
                    explanation: '详细解析'
                };
                
                console.log('生成的模拟数据:', mockData);
                
                const mockResult = document.getElementById('mockResult');
                mockResult.innerHTML = `
                    <div class="status success">
                        <strong>模拟数据生成成功:</strong><br>
                        ID: ${mockData.id}<br>
                        学科: ${mockData.subject}<br>
                        难度: ${mockData.difficulty}<br>
                        复习状态: ${mockData.is_reviewed ? '已复习' : '未复习'}
                    </div>
                `;
                
            } catch (error) {
                console.error('模拟数据生成失败:', error);
                document.getElementById('mockResult').innerHTML = 
                    '<div class="status error">模拟数据生成失败: ' + error.message + '</div>';
            }
        }

        function openErrorDetail(errorId) {
            const url = `error-detail.html?id=${errorId}`;
            console.log('打开错题详情页面:', url);
            window.open(url, '_blank');
        }

        function checkLocalStorage() {
            const storageInfo = document.getElementById('storageInfo');
            const token = localStorage.getItem('token');
            const reviewedErrors = localStorage.getItem('reviewedErrors');
            
            let info = '<div class="status info"><strong>本地存储状态:</strong></div>';
            info += `<div class="status ${token ? 'success' : 'error'}">Token: ${token || '未设置'}</div>`;
            info += `<div class="status info">已复习错题: ${reviewedErrors || '无'}</div>`;
            
            storageInfo.innerHTML = info;
        }

        function setTestToken() {
            localStorage.setItem('token', 'test_token_for_debug');
            console.log('已设置测试Token');
            checkLocalStorage();
        }

        function clearAllData() {
            localStorage.clear();
            console.log('已清除所有本地数据');
            checkLocalStorage();
        }

        function clearLogs() {
            debugLogs.textContent = '日志已清除...\n';
        }

        // 页面加载时自动检查环境
        document.addEventListener('DOMContentLoaded', function() {
            console.log('调试页面已加载');
            checkEnvironment();
            checkLocalStorage();
        });
    </script>
</body>
</html>