<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - æ‹ç…§æ‰¹æ”¹</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .help-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 80px);
        }
        
        /* ç§‘ç›®é€‰æ‹© */
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
        
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .subject-item {
            padding: 16px 8px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .subject-item:hover {
            background: #e9ecef;
        }
        
        .subject-item.selected {
            border-color: #667eea;
            background: #e3f2fd;
            color: #667eea;
        }
        
        /* æ‹ç…§åŒºåŸŸ */
        .photo-section {
            text-align: center;
        }
        
        .photo-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .photo-upload:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }
        
        .photo-upload.drag-over {
            border-color: #667eea;
            background: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 16px;
        }
        
        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #999;
            line-height: 1.4;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .photo-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-camera {
            background: #667eea;
            color: white;
        }
        
        .btn-camera:hover {
            background: #5a6fd8;
        }
        
        .btn-gallery {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-gallery:hover {
            background: #e0e0e0;
        }
        
        .btn-remove {
            background: #ff3b30;
            color: white;
        }
        
        .btn-remove:hover {
            background: #e60023;
        }
        
        
        /* æäº¤æŒ‰é’® */
        .submit-section {
            padding: 20px 0;
        }
        
        .btn {
            width: 100%;
            height: 48px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æç¤ºä¿¡æ¯ */
        .tip-section {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .tip-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tip-content {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .tip-list {
            list-style: none;
            padding: 0;
        }
        
        .tip-list li {
            position: relative;
            padding-left: 16px;
            margin-bottom: 4px;
        }
        
        .tip-list li:before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #667eea;
        }
        
        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        .file-input {
            display: none;
        }
        
        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        
        
        /* å¤šå›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .image-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .remove-single-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .remove-single-btn:hover {
            background: rgba(255, 59, 48, 1);
        }
        
        .image-index {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .images-info {
            text-align: center;
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .subject-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .photo-upload {
                padding: 30px 16px;
                min-height: 160px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .images-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 8px;
            }
        }
    </style>
    <script src="/frontend/js/global-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">æ‹ç…§æ‰¹æ”¹</div>
                </div>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- ç§‘ç›®é€‰æ‹© -->
            <div class="card">
                <div class="section-title">é€‰æ‹©ç§‘ç›®</div>
                <div class="subject-grid">
                    <div class="subject-item" data-subject="chinese">è¯­æ–‡</div>
                    <div class="subject-item" data-subject="math">æ•°å­¦</div>
                    <div class="subject-item" data-subject="english">è‹±è¯­</div>
                    <div class="subject-item" data-subject="physics">ç‰©ç†</div>
                    <div class="subject-item" data-subject="chemistry">åŒ–å­¦</div>
                    <div class="subject-item" data-subject="biology">ç”Ÿç‰©</div>
                </div>
            </div>
            
            <!-- æ‹ç…§ä¸Šä¼ åŒºåŸŸ -->
            <div class="card">
                <div class="section-title">ä½œä¸šç…§ç‰‡</div>
                
                <div class="photo-upload" id="photoUpload">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</div>
                    <div class="upload-hint">
                        æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå¯é€‰æ‹©å¤šå¼ å›¾ç‰‡<br>
                        å•å¼ å›¾ç‰‡å¤§å°ä¸è¶…è¿‡10MB
                    </div>
                </div>
                
                <div class="photo-actions">
                    <button class="action-btn btn-camera" onclick="event.stopPropagation(); takePhoto()">
                        ğŸ“· æ‹ç…§
                    </button>
                    <button class="action-btn btn-gallery" onclick="event.stopPropagation(); chooseImage()">
                        ğŸ–¼ï¸ ç›¸å†Œ
                    </button>
                </div>
                
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                <input type="file" class="file-input" id="fileInput" accept="image/*" multiple onchange="handleFileSelect(event)">
                <input type="file" class="file-input" id="cameraInput" accept="image/*" capture="camera" onchange="handleFileSelect(event)">
            </div>
            
            
            <!-- æ‹ç…§æç¤º -->
            <div class="card">
                <div class="section-title">
                    ğŸ’¡ æ‹ç…§å°è´´å£«
                </div>
                <div class="tip-content">
                    <ul class="tip-list">
                        <li>ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…é˜´å½±é®æŒ¡</li>
                        <li>ä¿æŒå›¾ç‰‡æ¸…æ™°ï¼Œæ–‡å­—å¯ä»¥æ¸…æ¥šè¾¨è®¤</li>
                        <li>å°½é‡æ‹æ‘„å®Œæ•´çš„é¢˜ç›®å’Œç­”æ¡ˆ</li>
                        <li>é¿å…æ‰‹æŒ‡é®æŒ¡é‡è¦å†…å®¹</li>
                    </ul>
                </div>
            </div>
            
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <button class="btn btn-primary" id="submitBtn" onclick="submitHomework()">
                    <span id="submitText">ğŸš€ å¼€å§‹æ™ºèƒ½æ‰¹æ”¹</span>
                    <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
        <!-- å…¨å±€åº•éƒ¨å¯¼èˆª -->
        <div class="global-bottom-nav">
            <div class="global-nav-item" onclick="window.location.href='/frontend/student-home.html'">
                <div class="global-nav-icon">ğŸ </div>
                <div class="global-nav-text">é¦–é¡µ</div>
            </div>
            <div class="global-nav-item active" onclick="window.location.href='/frontend/homework-submit.html'">
                <div class="global-nav-icon">ğŸ“·</div>
                <div class="global-nav-text">æ‹ç…§æ‰¹æ”¹</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/error-book.html'">
                <div class="global-nav-icon">ğŸ“š</div>
                <div class="global-nav-text">é”™é¢˜æœ¬</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/study-plan.html'">
                <div class="global-nav-icon">ğŸ“‹</div>
                <div class="global-nav-text">å­¦ä¹ è®¡åˆ’</div>
            </div>
            <div class="global-nav-item" onclick="window.location.href='/frontend/profile.html'">
                <div class="global-nav-icon">ğŸ‘¤</div>
                <div class="global-nav-text">æˆ‘çš„</div>
            </div>
        </div>
    </div>
    
    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let selectedSubject = '';
        let selectedImages = [];
        let isSubmitting = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM å†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            initPage();
        });

        function initPage() {
            console.log('=== initPage å¼€å§‹ ===');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€ - ä¸´æ—¶è·³è¿‡ç”¨äºæµ‹è¯•
            token = localStorage.getItem('token') || 'test-token-123';
            // if (!token) {
            //     console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
            //     showToast('è¯·å…ˆç™»å½•');
            //     setTimeout(() => {
            //         window.location.href = '/frontend/login.html';
            //     }, 2000);
            //     return;
            // }
            console.log('ç™»å½•çŠ¶æ€æ­£å¸¸ï¼Œtoken:', token);
            
            // ç»‘å®šç§‘ç›®é€‰æ‹©äº‹ä»¶
            const subjects = document.querySelectorAll('.subject-item');
            console.log('æ‰¾åˆ°ç§‘ç›®æ•°é‡:', subjects.length);
            subjects.forEach(item => {
                item.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.subject-item').forEach(i => i.classList.remove('selected'));
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    selectedSubject = this.dataset.subject;
                    
                    // ä¿å­˜åˆ°localStorageä¾›ä¸‹æ¬¡ä½¿ç”¨
                    localStorage.setItem('lastSelectedSubject', selectedSubject);
                    
                    console.log('é€‰æ‹©ç§‘ç›®:', selectedSubject, 'å¹¶ä¿å­˜åˆ°localStorage');
                });
            });
            
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰é¢„é€‰çš„å­¦ç§‘
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedSubject = urlParams.get('subject');
            console.log('å½“å‰URL:', window.location.href);
            console.log('URLå‚æ•°:', urlParams.toString());
            console.log('æå–çš„å­¦ç§‘å‚æ•°:', preselectedSubject);
            
            if (preselectedSubject) {
                console.log('ä»URLå‚æ•°é¢„é€‰å­¦ç§‘:', preselectedSubject);
                const subjectItem = document.querySelector(`[data-subject="${preselectedSubject}"]`);
                if (subjectItem) {
                    subjectItem.click();
                    console.log('æˆåŠŸé¢„é€‰å­¦ç§‘:', preselectedSubject);
                } else {
                    console.warn('âŒ æ‰¾ä¸åˆ°é¢„é€‰å­¦ç§‘ï¼Œä½¿ç”¨é»˜è®¤è¯­æ–‡');
                    // å¦‚æœæ‰¾ä¸åˆ°é¢„é€‰å­¦ç§‘ï¼Œé»˜è®¤é€‰æ‹©è¯­æ–‡
                    const chineseItem = document.querySelector('[data-subject="chinese"]');
                    if (chineseItem) {
                        chineseItem.click();
                    }
                }
            } else {
                // æ²¡æœ‰URLå‚æ•°æ—¶ï¼Œå°è¯•ä½¿ç”¨localStorageä¸­çš„ä¸Šæ¬¡é€‰æ‹©
                const lastSubject = localStorage.getItem('lastSelectedSubject');
                console.log('localStorageä¸­çš„ä¸Šæ¬¡é€‰æ‹©:', lastSubject);
                
                if (lastSubject) {
                    const lastSubjectItem = document.querySelector(`[data-subject="${lastSubject}"]`);
                    if (lastSubjectItem) {
                        lastSubjectItem.click();
                        console.log('ä½¿ç”¨localStorageä¸­çš„ä¸Šæ¬¡é€‰æ‹©:', lastSubject);
                    } else {
                        console.warn('âŒ æ‰¾ä¸åˆ°localStorageä¸­çš„å­¦ç§‘ï¼Œä½¿ç”¨é»˜è®¤è¯­æ–‡');
                        fallbackToDefaultSubject();
                    }
                } else {
                    console.log('localStorageä¸­æ²¡æœ‰ä¸Šæ¬¡é€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤è¯­æ–‡');
                    fallbackToDefaultSubject();
                }
            }
            
            function fallbackToDefaultSubject() {
                const chineseItem = document.querySelector('[data-subject="chinese"]');
                if (chineseItem) {
                    chineseItem.click();
                    console.log('é»˜è®¤é€‰æ‹©è¯­æ–‡');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°è¯­æ–‡ç§‘ç›®');
                }
            }
            
            // æ£€æŸ¥æ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.getElementById('fileInput');
            console.log('æ–‡ä»¶è¾“å…¥å…ƒç´ :', fileInput ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            if (fileInput) {
                console.log('- accept:', fileInput.accept);
                console.log('- multiple:', fileInput.multiple);
                console.log('- onchange:', fileInput.onchange ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
            }
            
            // ç»‘å®šæ‹–æ‹½ä¸Šä¼ äº‹ä»¶
            setupDragAndDrop();
            
            // æ£€æŸ¥ç›¸æœºæ”¯æŒ
            checkCameraSupport();
            
            console.log('=== initPage å®Œæˆ ===');
        }

        function setupDragAndDrop() {
            console.log('è®¾ç½®æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½');
            const uploadArea = document.getElementById('photoUpload');
            
            if (!uploadArea) {
                console.error('âŒ æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸ');
                return;
            }
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                console.log('æ‹–æ‹½ä¸Šä¼ è¢«è§¦å‘');
                
                const files = e.dataTransfer.files;
                console.log('æ‹–æ‹½æ–‡ä»¶æ•°é‡:', files.length);
                if (files.length > 0) {
                    // å¤„ç†æ‹–æ‹½çš„æ‰€æœ‰æ–‡ä»¶
                    const fakeEvent = { target: { files: files } };
                    handleFileSelect(fakeEvent);
                }
            });
            
            uploadArea.addEventListener('click', function(e) {
                console.log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»', e.target);
                // æ£€æŸ¥ç‚¹å‡»çš„ç›®æ ‡ï¼Œåªåœ¨ç‚¹å‡»ç©ºç™½åŒºåŸŸæˆ–ä¸Šä¼ å›¾æ ‡æ—¶è§¦å‘
                if (e.target === uploadArea || 
                    e.target.classList.contains('upload-icon') || 
                    e.target.classList.contains('upload-text') || 
                    e.target.classList.contains('upload-hint')) {
                    console.log('è§¦å‘æ–‡ä»¶é€‰æ‹©');
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) {
                        fileInput.click();
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                    }
                } else {
                    console.log('ç‚¹å‡»ç›®æ ‡ä¸ç¬¦åˆæ¡ä»¶:', e.target.className);
                }
            });
        }

        async function takePhoto() {
            // é¦–å…ˆæ£€æŸ¥ç¯å¢ƒæ˜¯å¦å®‰å…¨
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                showToast('ç›¸æœºåŠŸèƒ½éœ€è¦HTTPSæˆ–localhostç¯å¢ƒï¼Œä½¿ç”¨æ–‡ä»¶é€‰æ‹©ä»£æ›¿');
                document.getElementById('fileInput').click();
                return;
            }
            
            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒç›¸æœº
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('å½“å‰è®¾å¤‡ä¸æ”¯æŒç›¸æœºï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                document.getElementById('fileInput').click();
                return;
            }
            
            try {
                showToast('æ­£åœ¨åˆå§‹åŒ–ç›¸æœº...');
                
                // ç§»åŠ¨è®¾å¤‡ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç›¸æœº
                if (isMobileDevice()) {
                    try {
                        showToast('æ­£åœ¨ç”³è¯·ç›¸æœºæƒé™...');
                        await requestCameraPermission();
                        showToast('æ­£åœ¨æ‰“å¼€ç³»ç»Ÿç›¸æœº...');
                        
                        // è°ƒç”¨ç³»ç»Ÿç›¸æœº
                        const cameraInput = document.getElementById('cameraInput');
                        cameraInput.click();
                        
                        // è®¾ç½®è¶…æ—¶æ£€æŸ¥ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿç›¸æœºï¼Œæä¾›å¤‡é€‰æ–¹æ¡ˆ
                        let fallbackTimer = setTimeout(() => {
                            if (!cameraInput.files || cameraInput.files.length === 0) {
                                console.log('ç³»ç»Ÿç›¸æœºå¯èƒ½æœªè¢«ä½¿ç”¨ï¼Œæä¾›ç½‘é¡µç›¸æœºé€‰é¡¹');
                                showCameraOptions();
                            }
                        }, 5000);
                        
                        // ç›‘å¬æ–‡ä»¶è¾“å…¥å˜åŒ–ï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶ï¼Œæ¸…é™¤å®šæ—¶å™¨
                        cameraInput.addEventListener('change', function() {
                            clearTimeout(fallbackTimer);
                        }, { once: true });
                        
                        return;
                    } catch (error) {
                        console.log('ç³»ç»Ÿç›¸æœºè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ç½‘é¡µç›¸æœº:', error);
                        showToast('ç³»ç»Ÿç›¸æœºä¸å¯ç”¨ï¼Œå°è¯•ç½‘é¡µç›¸æœº...');
                    }
                }
                
                // æ¡Œé¢æµè§ˆå™¨æˆ–ç§»åŠ¨è®¾å¤‡ç³»ç»Ÿç›¸æœºå¤±è´¥æ—¶ï¼Œä½¿ç”¨ç½‘é¡µç›¸æœº
                await openCameraModal();
                
            } catch (error) {
                console.error('ç›¸æœºåŠŸèƒ½å®Œå…¨å¤±è´¥:', error);
                handleCameraError(error);
            }
        }
        
        function handleCameraError(error) {
            let message = 'ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œ';
            
            if (error.name === 'NotAllowedError') {
                message = 'ç›¸æœºæƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ç›¸æœºè®¿é—®ï¼Œæˆ–';
            } else if (error.name === 'NotFoundError') {
                message = 'æœªæ‰¾åˆ°å¯ç”¨çš„ç›¸æœºè®¾å¤‡ï¼Œ';
            } else if (error.name === 'NotSupportedError') {
                message = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›¸æœºåŠŸèƒ½ï¼Œ';
            } else if (error.name === 'NotReadableError') {
                message = 'ç›¸æœºè¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œ';
            }
            
            showToast(message + 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            
            // é™çº§åˆ°æ–‡ä»¶é€‰æ‹©
            setTimeout(() => {
                document.getElementById('fileInput').click();
            }, 1000);
        }
        
        function showCameraOptions() {
            if (confirm('ç³»ç»Ÿç›¸æœºå¯åŠ¨è¾ƒæ…¢ï¼Œæ˜¯å¦æ”¹ç”¨ç½‘é¡µç›¸æœºï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ä½¿ç”¨ç½‘é¡µç›¸æœº\nç‚¹å‡»"å–æ¶ˆ"ç­‰å¾…ç³»ç»Ÿç›¸æœºæˆ–é€‰æ‹©æ–‡ä»¶')) {
                openCameraModal().catch(() => {
                    showToast('ç½‘é¡µç›¸æœºä¹Ÿæ— æ³•å¯åŠ¨ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    document.getElementById('fileInput').click();
                });
            } else {
                // ç”¨æˆ·é€‰æ‹©ç­‰å¾…ï¼Œæä¾›æ–‡ä»¶é€‰æ‹©çš„é€‰é¡¹
                setTimeout(() => {
                    if (confirm('å¦‚æœç³»ç»Ÿç›¸æœºä»æœªå“åº”ï¼Œæ˜¯å¦æ”¹ä¸ºé€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼Ÿ')) {
                        document.getElementById('fileInput').click();
                    }
                }, 3000);
            }
        }
        
        async function requestCameraPermission() {
            try {
                // ç”³è¯·ç›¸æœºæƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // ç«‹å³åœæ­¢æµï¼Œä»…ç”¨äºæƒé™ç”³è¯·
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    throw new Error('ç”¨æˆ·æ‹’ç»äº†ç›¸æœºæƒé™');
                } else if (error.name === 'NotFoundError') {
                    throw new Error('æœªæ‰¾åˆ°ç›¸æœºè®¾å¤‡');
                } else {
                    throw error;
                }
            }
        }
        
        function isMobileDevice() {
            return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        async function openCameraModal() {
            // åˆ›å»ºç›¸æœºæ¨¡æ€æ¡†
            const cameraModal = document.createElement('div');
            cameraModal.id = 'cameraModal';
            cameraModal.innerHTML = `
                <div class="camera-modal-overlay">
                    <div class="camera-modal-content">
                        <div class="camera-header">
                            <h3>ğŸ“· ç½‘é¡µç›¸æœº</h3>
                            <button onclick="closeCameraModal()" class="close-camera-btn">Ã—</button>
                        </div>
                        <div class="camera-status" id="cameraStatus">
                            <div>æ­£åœ¨å¯åŠ¨ç›¸æœº...</div>
                        </div>
                        <video id="cameraVideo" autoplay playsinline style="display: none;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div class="camera-controls" id="cameraControls" style="display: none;">
                            <button onclick="capturePhoto()" class="capture-photo-btn">ğŸ“· æ‹ç…§</button>
                            <button onclick="finishCapture()" class="finish-btn" style="display: none;">âœ… å®Œæˆæ‹æ‘„</button>
                            <button onclick="switchCamera()" class="switch-camera-btn" id="switchBtn">ğŸ”„ åˆ‡æ¢æ‘„åƒå¤´</button>
                            <button onclick="closeCameraModal()" class="cancel-btn">å–æ¶ˆ</button>
                        </div>
                        <div class="captured-photos" id="capturedPhotos"></div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .camera-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .camera-modal-content {
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 90%;
                    overflow: hidden;
                }
                .camera-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 16px;
                }
                .close-camera-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 4px 8px;
                }
                .camera-status {
                    text-align: center;
                    padding: 40px 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    color: #666;
                }
                #cameraVideo {
                    width: 100%;
                    height: 300px;
                    object-fit: cover;
                    border-radius: 8px;
                    background: #000;
                    margin-bottom: 16px;
                }
                .camera-controls {
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                    flex-wrap: wrap;
                }
                .capture-photo-btn, .cancel-btn, .finish-btn, .switch-camera-btn {
                    padding: 12px 20px;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: background-color 0.3s;
                }
                .capture-photo-btn {
                    background: #667eea;
                    color: white;
                }
                .capture-photo-btn:hover {
                    background: #5a6fd8;
                }
                .switch-camera-btn {
                    background: #ff9500;
                    color: white;
                }
                .switch-camera-btn:hover {
                    background: #e6850e;
                }
                .finish-btn {
                    background: #667eea;
                    color: white;
                }
                .finish-btn:hover {
                    background: #5a6fd8;
                }
                .cancel-btn {
                    background: #f0f0f0;
                    color: #333;
                }
                .cancel-btn:hover {
                    background: #e0e0e0;
                }
                .captured-photos {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    margin-top: 12px;
                    max-height: 120px;
                    overflow-y: auto;
                }
                .captured-photo-thumb {
                    width: 60px;
                    height: 60px;
                    object-fit: cover;
                    border-radius: 6px;
                    border: 2px solid #667eea;
                    cursor: pointer;
                }
                .captured-photo-thumb:hover {
                    border-color: #ff3b30;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(cameraModal);
            
            // åˆå§‹åŒ–å…¨å±€å˜é‡
            window.tempCapturedPhotos = [];
            window.currentCameraStream = null;
            window.currentFacingMode = 'environment';
            
            // å¯åŠ¨ç›¸æœº
            await startCameraStream();
        }
        
        async function startCameraStream() {
            const statusDiv = document.getElementById('cameraStatus');
            const video = document.getElementById('cameraVideo');
            const controlsDiv = document.getElementById('cameraControls');
            
            try {
                statusDiv.innerHTML = 'æ­£åœ¨ç”³è¯·ç›¸æœºæƒé™...';
                
                // å°è¯•è·å–ç›¸æœºæµ
                const constraints = {
                    video: {
                        facingMode: window.currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                statusDiv.innerHTML = 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
                
                // åœæ­¢ä¹‹å‰çš„æµï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.currentCameraStream) {
                    window.currentCameraStream.getTracks().forEach(track => track.stop());
                }
                
                // è®¾ç½®æ–°çš„æµ
                window.currentCameraStream = stream;
                video.srcObject = stream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                video.addEventListener('loadedmetadata', () => {
                    statusDiv.style.display = 'none';
                    video.style.display = 'block';
                    controlsDiv.style.display = 'flex';
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªæ‘„åƒå¤´
                    checkCameraDevices();
                    
                    showToast('ğŸ“· ç›¸æœºå·²å°±ç»ªï¼Œç‚¹å‡»æ‹ç…§æŒ‰é’®å¼€å§‹æ‹æ‘„');
                }, { once: true });
                
                // è®¾ç½®è§†é¢‘æ’­æ”¾å¤±è´¥çš„å¤„ç†
                video.addEventListener('error', (e) => {
                    console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', e);
                    statusDiv.innerHTML = 'âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢';
                    throw new Error('è§†é¢‘æ’­æ”¾å¤±è´¥');
                });
                
            } catch (error) {
                console.error('æ— æ³•è®¿é—®ç›¸æœº:', error);
                handleCameraStartError(error, statusDiv);
            }
        }
        
        function handleCameraStartError(error, statusDiv) {
            let errorMessage = 'âŒ ';
            let suggestion = '';
            
            if (error.name === 'NotAllowedError') {
                errorMessage += 'ç›¸æœºæƒé™è¢«æ‹’ç»';
                suggestion = 'è¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»ğŸ”’å›¾æ ‡ï¼Œå…è®¸ç›¸æœºè®¿é—®æƒé™';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'æœªæ‰¾åˆ°ç›¸æœºè®¾å¤‡';
                suggestion = 'è¯·ç¡®è®¤è®¾å¤‡å·²è¿æ¥æ‘„åƒå¤´';
            } else if (error.name === 'NotReadableError') {
                errorMessage += 'ç›¸æœºè¢«å…¶ä»–ç¨‹åºå ç”¨';
                suggestion = 'è¯·å…³é—­å…¶ä»–ä½¿ç”¨ç›¸æœºçš„åº”ç”¨ç¨‹åº';
            } else if (error.name === 'OverconstrainedError') {
                errorMessage += 'ç›¸æœºä¸æ”¯æŒæ‰€éœ€å‚æ•°';
                suggestion = 'å°è¯•ä½¿ç”¨å…¶ä»–ç›¸æœºè®¾å¤‡';
            } else {
                errorMessage += 'ç›¸æœºå¯åŠ¨å¤±è´¥';
                suggestion = 'è¯·æ£€æŸ¥ç›¸æœºè¿æ¥æˆ–å°è¯•åˆ·æ–°é¡µé¢';
            }
            
            statusDiv.innerHTML = `
                <div>${errorMessage}</div>
                <div style="margin-top: 12px; font-size: 14px; color: #999;">
                    ğŸ’¡ ${suggestion}
                </div>
                <button onclick="startCameraStream()" class="capture-photo-btn" style="margin-top: 16px;">
                    ğŸ”„ é‡è¯•
                </button>
                <button onclick="closeCameraModal(); document.getElementById('fileInput').click();" class="cancel-btn" style="margin-top: 16px; margin-left: 8px;">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶
                </button>
            `;
            
            showToast(errorMessage + 'ï¼Œ' + suggestion);
        }
        
        async function checkCameraDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                const switchBtn = document.getElementById('switchBtn');
                if (videoDevices.length > 1) {
                    switchBtn.style.display = 'inline-block';
                    switchBtn.title = `æ‰¾åˆ°${videoDevices.length}ä¸ªæ‘„åƒå¤´ï¼Œç‚¹å‡»åˆ‡æ¢`;
                } else {
                    switchBtn.style.display = 'none';
                }
            } catch (error) {
                console.log('æ— æ³•æšä¸¾æ‘„åƒå¤´è®¾å¤‡:', error);
            }
        }
        
        async function switchCamera() {
            // åˆ‡æ¢å‰åæ‘„åƒå¤´
            window.currentFacingMode = window.currentFacingMode === 'environment' ? 'user' : 'environment';
            
            const video = document.getElementById('cameraVideo');
            const controlsDiv = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            
            // éšè—è§†é¢‘å’Œæ§åˆ¶é¢æ¿ï¼Œæ˜¾ç¤ºçŠ¶æ€
            video.style.display = 'none';
            controlsDiv.style.display = 'none';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'æ­£åœ¨åˆ‡æ¢æ‘„åƒå¤´...';
            
            // é‡æ–°å¯åŠ¨ç›¸æœºæµ
            await startCameraStream();
        }
        
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            
            if (!video || !canvas) {
                showToast('æ‹ç…§åŠŸèƒ½å¼‚å¸¸ï¼Œè¯·é‡è¯•');
                return;
            }
            
            if (!video.videoWidth || !video.videoHeight) {
                showToast('ç›¸æœºå°šæœªå°±ç»ªï¼Œè¯·ç¨ç­‰');
                return;
            }
            
            try {
                // è®¾ç½®canvaså°ºå¯¸
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ç»˜åˆ¶å½“å‰å¸§åˆ°canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // æ·»åŠ æ‹ç…§æç¤ºæ•ˆæœ
                const captureBtn = document.querySelector('.capture-photo-btn');
                captureBtn.style.background = '#5a6fd8';
                captureBtn.textContent = 'âœ… æ‹æ‘„æˆåŠŸ';
                setTimeout(() => {
                    captureBtn.style.background = '#667eea';
                    captureBtn.textContent = 'ğŸ“· æ‹ç…§';
                }, 1000);
                
                // è½¬æ¢ä¸ºblob
                canvas.toBlob(async (blob) => {
                    if (blob) {
                        // åˆ›å»ºFileå¯¹è±¡
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const file = new File([blob], `camera_${timestamp}.jpg`, { type: 'image/jpeg' });
                        
                        // æ·»åŠ åˆ°ä¸´æ—¶ç…§ç‰‡æ•°ç»„
                        window.tempCapturedPhotos = window.tempCapturedPhotos || [];
                        window.tempCapturedPhotos.push(file);
                        
                        // æ˜¾ç¤ºç¼©ç•¥å›¾
                        showCapturedThumbnail(file, window.tempCapturedPhotos.length - 1);
                        
                        // æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
                        const finishBtn = document.querySelector('.finish-btn');
                        if (finishBtn) {
                            finishBtn.style.display = 'inline-block';
                        }
                        
                        showToast(`ğŸ“· å·²æ‹æ‘„ç¬¬ ${window.tempCapturedPhotos.length} å¼ ç…§ç‰‡`);
                        
                        console.log(`æ‹æ‘„ç…§ç‰‡æˆåŠŸ: ${file.name}, å¤§å°: ${(file.size / 1024).toFixed(1)}KB`);
                    } else {
                        showToast('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }, 'image/jpeg', 0.92);  // æé«˜å›¾ç‰‡è´¨é‡
                
            } catch (error) {
                console.error('æ‹ç…§å¤±è´¥:', error);
                showToast('æ‹ç…§å¤±è´¥: ' + error.message);
            }
        }
        
        function showCapturedThumbnail(file, index) {
            const photosContainer = document.getElementById('capturedPhotos');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'captured-photo-thumb';
                img.title = 'ç‚¹å‡»åˆ é™¤è¿™å¼ ç…§ç‰‡';
                img.onclick = () => removeCapturedPhoto(index);
                
                photosContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
        
        function removeCapturedPhoto(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                window.tempCapturedPhotos.splice(index, 1);
                
                // é‡æ–°æ¸²æŸ“ç¼©ç•¥å›¾
                const photosContainer = document.getElementById('capturedPhotos');
                photosContainer.innerHTML = '';
                
                window.tempCapturedPhotos.forEach((file, i) => {
                    showCapturedThumbnail(file, i);
                });
                
                showToast(`å·²åˆ é™¤ç…§ç‰‡ï¼Œå‰©ä½™${window.tempCapturedPhotos.length}å¼ `);
            }
        }
        
        async function finishCapture() {
            if (!window.tempCapturedPhotos || window.tempCapturedPhotos.length === 0) {
                showToast('è¯·å…ˆæ‹æ‘„è‡³å°‘ä¸€å¼ ç…§ç‰‡');
                return;
            }
            
            // ä¿å­˜ç…§ç‰‡æ•°é‡ï¼ˆåœ¨æ¸…ç©ºæ•°ç»„ä¹‹å‰ï¼‰
            const capturedCount = window.tempCapturedPhotos.length;
            
            // å°†æ‰€æœ‰æ‹æ‘„çš„ç…§ç‰‡æ·»åŠ åˆ°é€‰ä¸­çš„å›¾ç‰‡æ•°ç»„
            const startIndex = selectedImages.length;
            for (const file of window.tempCapturedPhotos) {
                selectedImages.push(file);
            }
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast(`æˆåŠŸæ‹æ‘„${capturedCount}å¼ ç…§ç‰‡ï¼`);
            
            // å…³é—­ç›¸æœº
            closeCameraModal();
            
            // åˆ·æ–°æ˜¾ç¤ºç•Œé¢
            refreshImagePreviews();
        }
        
        function closeCameraModal() {
            // åœæ­¢ç›¸æœºæµ
            if (window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            
            // æ¸…ç†ä¸´æ—¶ç…§ç‰‡æ•°æ®
            window.tempCapturedPhotos = [];
            
            // ç§»é™¤æ¨¡æ€æ¡†
            const modal = document.getElementById('cameraModal');
            if (modal) {
                modal.remove();
            }
        }

        function chooseImage() {
            console.log('chooseImage è¢«è°ƒç”¨');
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                console.log('æ‰¾åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ï¼Œè§¦å‘ç‚¹å‡»');
                fileInput.click();
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                showToast('æ–‡ä»¶é€‰æ‹©åŠŸèƒ½å¼‚å¸¸');
            }
        }
        
        function checkCameraSupport() {
            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒç›¸æœº
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('è®¾å¤‡æ”¯æŒç›¸æœºåŠŸèƒ½');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºHTTPSæˆ–localhost
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                if (!isSecure) {
                    console.warn('è­¦å‘Š: ç›¸æœºåŠŸèƒ½éœ€è¦HTTPSç¯å¢ƒï¼Œå½“å‰ä¸ºHTTPç¯å¢ƒå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ');
                    showToast('æç¤º: ç›¸æœºåŠŸèƒ½éœ€è¦HTTPSæˆ–localhostç¯å¢ƒæ‰èƒ½æ­£å¸¸ä½¿ç”¨', 5000);
                    
                    // åœ¨éHTTPSç¯å¢ƒä¸‹ç¦ç”¨ç›¸æœºåŠŸèƒ½ï¼Œåªä¿ç•™æ–‡ä»¶é€‰æ‹©
                    document.querySelectorAll('.btn-camera').forEach(btn => {
                        if (btn.textContent.includes('ğŸ“·')) {
                            btn.innerHTML = btn.innerHTML.replace('ğŸ“· æ‹ç…§', 'ğŸ“ é€‰æ‹©æ–‡ä»¶');
                            btn.innerHTML = btn.innerHTML.replace('ğŸ“· ç»§ç»­æ‹ç…§', 'ğŸ“ ç»§ç»­é€‰æ‹©');
                            btn.innerHTML = btn.innerHTML.replace('ğŸ“· é‡æ–°æ‹ç…§', 'ğŸ“ é‡æ–°é€‰æ‹©');
                        }
                    });
                } else {
                    // åœ¨å®‰å…¨ç¯å¢ƒä¸‹é¢„æ£€æŸ¥ç›¸æœºæƒé™
                    checkCameraPermissionStatus();
                }
            } else {
                console.log('è®¾å¤‡ä¸æ”¯æŒç›¸æœºåŠŸèƒ½ï¼Œå°†ä½¿ç”¨æ–‡ä»¶é€‰æ‹©');
                // ä¿®æ”¹æ‹ç…§æŒ‰é’®çš„æ–‡å­—æç¤º
                document.querySelectorAll('.btn-camera').forEach(btn => {
                    if (btn.textContent.includes('ğŸ“·')) {
                        btn.innerHTML = btn.innerHTML.replace('ğŸ“· æ‹ç…§', 'ğŸ“ é€‰æ‹©æ–‡ä»¶');
                        btn.innerHTML = btn.innerHTML.replace('ğŸ“· ç»§ç»­æ‹ç…§', 'ğŸ“ ç»§ç»­é€‰æ‹©');
                        btn.innerHTML = btn.innerHTML.replace('ğŸ“· é‡æ–°æ‹ç…§', 'ğŸ“ é‡æ–°é€‰æ‹©');
                    }
                });
                showToast('å½“å‰è®¾å¤‡ä¸æ”¯æŒç›¸æœºï¼Œè¯·ä½¿ç”¨æ–‡ä»¶é€‰æ‹©åŠŸèƒ½');
            }
        }
        
        async function checkCameraPermissionStatus() {
            try {
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({ name: 'camera' });
                    console.log('ç›¸æœºæƒé™çŠ¶æ€:', permission.state);
                    
                    if (permission.state === 'denied') {
                        showToast('ç›¸æœºæƒé™å·²è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ç›¸æœºè®¿é—®', 5000);
                    } else if (permission.state === 'prompt') {
                        console.log('ç›¸æœºæƒé™éœ€è¦ç”¨æˆ·æˆæƒ');
                    } else if (permission.state === 'granted') {
                        console.log('ç›¸æœºæƒé™å·²æˆæƒ');
                    }
                }
            } catch (error) {
                console.log('æ— æ³•æ£€æŸ¥ç›¸æœºæƒé™çŠ¶æ€:', error);
            }
        }

        function handleFileSelect(event) {
            console.log('=== handleFileSelect è¢«è°ƒç”¨ ===', event);
            
            const files = event.target.files;
            console.log('æ–‡ä»¶æ•°é‡:', files ? files.length : 0);
            
            if (files && files.length > 0) {
                const startCount = selectedImages.length;
                console.log('å¼€å§‹å¤„ç†æ–‡ä»¶ï¼Œå½“å‰å·²æœ‰:', startCount);
                
                // æ‰¹é‡æ·»åŠ æ‰€æœ‰æ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`å¤„ç†æ–‡ä»¶ ${i + 1}:`, file.name, file.type, `${(file.size / 1024).toFixed(1)}KB`);
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('image/')) {
                        console.warn(`æ–‡ä»¶ç±»å‹é”™è¯¯: ${file.name}`);
                        showToast(`${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        console.warn(`æ–‡ä»¶å¤ªå¤§: ${file.name}`);
                        showToast(`${file.name} æ–‡ä»¶å¤ªå¤§ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    selectedImages.push(file);
                    console.log(`âœ… æ–‡ä»¶æ·»åŠ æˆåŠŸ: ${file.name}`);
                }
                
                console.log('å¤„ç†å®Œæˆï¼Œæœ‰æ•ˆæ–‡ä»¶æ•°:', selectedImages.length - startCount);
                
                // ç»Ÿä¸€åˆ·æ–°ç•Œé¢
                if (selectedImages.length > startCount) {
                    console.log('å¼€å§‹åˆ·æ–°ç•Œé¢é¢„è§ˆ');
                    refreshImagePreviews();
                    
                    const addedCount = selectedImages.length - startCount;
                    showToast(`å·²æ·»åŠ ${addedCount}å¼ å›¾ç‰‡`);
                    console.log(`âœ… ç•Œé¢åˆ·æ–°å®Œæˆï¼Œå…±æ·»åŠ  ${addedCount} å¼ å›¾ç‰‡`);
                } else {
                    console.warn('âŒ æ²¡æœ‰æœ‰æ•ˆå›¾ç‰‡è¢«æ·»åŠ ');
                    showToast('æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                }
            } else {
                console.warn('âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©º');
            }
        }

        // å•ä¸ªæ–‡ä»¶å¤„ç†å‡½æ•°ï¼ˆä¾›æ‹–æ‹½ç­‰åŠŸèƒ½ä½¿ç”¨ï¼‰
        function handleSingleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            const startCount = selectedImages.length;
            
            // æ·»åŠ åˆ°é€‰ä¸­çš„å›¾ç‰‡æ•°ç»„
            selectedImages.push(file);
            
            // åˆ·æ–°ç•Œé¢
            refreshImagePreviews();
            
            
            showToast('å›¾ç‰‡æ·»åŠ æˆåŠŸ');
        }

        function showImagePreview(imageSrc, index) {
            const uploadArea = document.getElementById('photoUpload');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œé‡æ–°æ„å»ºç•Œé¢
            if (selectedImages.length === 1) {
                uploadArea.innerHTML = `
                    <div class="images-grid" id="imagesGrid"></div>
                    <div class="photo-actions">
                        <button class="action-btn btn-camera" onclick="event.stopPropagation(); takePhoto()">
                            ğŸ“· ç»§ç»­æ‹ç…§
                        </button>
                        <button class="action-btn btn-gallery" onclick="event.stopPropagation(); chooseImage()">
                            ğŸ–¼ï¸ æ·»åŠ å›¾ç‰‡
                        </button>
                        <button class="action-btn btn-remove" onclick="event.stopPropagation(); removeAllImages()">
                            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                        </button>
                    </div>
                    <div class="images-info">
                        <span id="imageCount">å·²é€‰æ‹© ${selectedImages.length} å¼ å›¾ç‰‡</span>
                    </div>
                `;
            }
            
            // æ·»åŠ å›¾ç‰‡åˆ°ç½‘æ ¼ä¸­
            const imagesGrid = document.getElementById('imagesGrid');
            if (imagesGrid) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.innerHTML = `
                    <img src="${imageSrc}" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡ ${index + 1}">
                    <button class="remove-single-btn" onclick="event.stopPropagation(); removeSingleImage(${index})" title="åˆ é™¤è¿™å¼ å›¾ç‰‡">Ã—</button>
                    <div class="image-index">${index + 1}</div>
                `;
                
                imagesGrid.appendChild(imageContainer);
                
                // æ›´æ–°å›¾ç‰‡æ•°é‡æ˜¾ç¤º
                const imageCount = document.getElementById('imageCount');
                if (imageCount) {
                    imageCount.textContent = `å·²é€‰æ‹© ${selectedImages.length} å¼ å›¾ç‰‡`;
                }
            }
        }

        function removeSingleImage(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                selectedImages.splice(index, 1);
                
                if (selectedImages.length === 0) {
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡äº†ï¼Œé‡ç½®ç•Œé¢
                    removeAllImages();
                } else {
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾ç‰‡
                    refreshImagePreviews();
                    showToast(`å›¾ç‰‡å·²åˆ é™¤ï¼Œè¿˜å‰©${selectedImages.length}å¼ `);
                }
            }
        }
        
        function removeAllImages() {
            selectedImages = [];
            const uploadArea = document.getElementById('photoUpload');
            uploadArea.innerHTML = `
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</div>
                <div class="upload-hint">
                    æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå¯é€‰æ‹©å¤šå¼ å›¾ç‰‡<br>
                    å•å¼ å›¾ç‰‡å¤§å°ä¸è¶…è¿‡10MB
                </div>
            `;
            
        }
        
        function refreshImagePreviews() {
            if (selectedImages.length === 0) {
                removeAllImages();
                return;
            }
            
            const uploadArea = document.getElementById('photoUpload');
            uploadArea.innerHTML = `
                <div class="images-grid" id="imagesGrid"></div>
                <div class="photo-actions">
                    <button class="action-btn btn-camera" onclick="event.stopPropagation(); takePhoto()">
                        ğŸ“· ç»§ç»­æ‹ç…§
                    </button>
                    <button class="action-btn btn-gallery" onclick="event.stopPropagation(); chooseImage()">
                        ğŸ–¼ï¸ æ·»åŠ å›¾ç‰‡
                    </button>
                    <button class="action-btn btn-remove" onclick="event.stopPropagation(); removeAllImages()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                    </button>
                </div>
                <div class="images-info">
                    <span id="imageCount">å·²é€‰æ‹© ${selectedImages.length} å¼ å›¾ç‰‡</span>
                </div>
            `;
            
            // é‡æ–°æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡
            const imagesGrid = document.getElementById('imagesGrid');
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    imageContainer.innerHTML = `
                        <img src="${e.target.result}" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡ ${index + 1}">
                        <button class="remove-single-btn" onclick="event.stopPropagation(); removeSingleImage(${index})" title="åˆ é™¤è¿™å¼ å›¾ç‰‡">Ã—</button>
                        <div class="image-index">${index + 1}</div>
                    `;
                    imagesGrid.appendChild(imageContainer);
                };
                reader.readAsDataURL(file);
            });
        }


        async function submitHomework() {
            if (isSubmitting) return;
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!selectedSubject) {
                showToast('è¯·é€‰æ‹©ç§‘ç›®');
                return;
            }
            
            if (!selectedImages || selectedImages.length === 0) {
                showToast('è¯·é€‰æ‹©ä½œä¸šå›¾ç‰‡');
                return;
            }
            
            isSubmitting = true;
            setSubmitButtonLoading(true);
            
            try {
                // å‡†å¤‡æäº¤æ•°æ®
                const formData = new FormData();
                
                // æ·»åŠ æ‰€æœ‰å›¾ç‰‡
                selectedImages.forEach((image, index) => {
                    formData.append('images', image);
                });
                
                formData.append('subject', selectedSubject);
                formData.append('image_count', selectedImages.length);
                
                showToast(`æ­£åœ¨ä¸Šä¼ ${selectedImages.length}å¼ å›¾ç‰‡...`);
                
                // æäº¤ä½œä¸š
                const response = await fetch(`${API_BASE}/homework/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°æ‰¹æ”¹ç»“æœ...');
                    
                    // å»¶è¿Ÿè·³è½¬åˆ°ç»“æœé¡µé¢
                    setTimeout(() => {
                        window.location.href = `/frontend/homework-result.html?id=${result.id}`;
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'æäº¤å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showToast('æäº¤å¤±è´¥ï¼š' + error.message);
            } finally {
                isSubmitting = false;
                setSubmitButtonLoading(false);
            }
        }

        function setSubmitButtonLoading(loading) {
            const btn = document.getElementById('submitBtn');
            const text = document.getElementById('submitText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                btn.disabled = true;
                text.style.display = 'none';
                spinner.style.display = 'inline-block';
            } else {
                btn.disabled = false;
                text.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function goBack() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„å†…å®¹
            if (selectedImages && selectedImages.length > 0) {
                if (confirm('ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿå½“å‰å†…å®¹å°†ä¸ä¼šä¿å­˜ã€‚')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        }

        function showHelp() {
            const helpText = `ğŸ“· æ‹ç…§æ‰¹æ”¹ä½¿ç”¨å¸®åŠ©ï¼š

1. é€‰æ‹©ç§‘ç›®ï¼šè¯·å…ˆé€‰æ‹©è¦æ‰¹æ”¹çš„ç§‘ç›®
2. ä¸Šä¼ ä½œä¸šï¼šå¯ä»¥æ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©
3. å¤šå¼ ä¸Šä¼ ï¼šæ”¯æŒåŒæ—¶ä¸Šä¼ å¤šå¼ ä½œä¸šå›¾ç‰‡
4. å›¾ç‰‡è¦æ±‚ï¼šæ¸…æ™°ã€å®Œæ•´ã€å…‰çº¿å……è¶³
5. æäº¤æ‰¹æ”¹ï¼šç‚¹å‡»"å¼€å§‹æ™ºèƒ½æ‰¹æ”¹"å®Œæˆæäº¤

ğŸ’¡ å°è´´å£«ï¼š
â€¢ ç¡®ä¿ä½œä¸šå†…å®¹å®Œæ•´å¯è§
â€¢ é¿å…æ‰‹æŒ‡é®æŒ¡é‡è¦å†…å®¹
â€¢ å…‰çº¿å……è¶³ï¼Œé¿å…é˜´å½±
â€¢ æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§10MB`;

            alert(helpText);
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter å¿«é€Ÿæäº¤
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                submitHomework();
            }
        });
    </script>
</body>
</html>