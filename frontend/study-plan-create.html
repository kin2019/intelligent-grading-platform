<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - åˆ›å»ºå­¦ä¹ è®¡åˆ’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .save-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 80px);
        }
        
        /* è¡¨å•ç»„ä»¶ */
        .form-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: #fff;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
            background: #fff;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        /* ç§‘ç›®é€‰æ‹© */
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .subject-item {
            padding: 12px 8px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .subject-item:hover {
            background: #e9ecef;
        }
        
        .subject-item.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
            color: #4CAF50;
        }
        
        /* æ—¶é—´é€‰æ‹©å™¨ */
        .time-selector {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .time-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            width: 80px;
        }
        
        .time-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .time-label {
            font-size: 14px;
            color: #666;
        }
        
        /* ä¼˜å…ˆçº§é€‰æ‹© */
        .priority-options {
            display: flex;
            gap: 12px;
        }
        
        .priority-item {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .priority-item:hover {
            background: #e9ecef;
        }
        
        .priority-item.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
            color: #4CAF50;
        }
        
        .priority-high {
            color: #f44336;
        }
        
        .priority-medium {
            color: #ff9800;
        }
        
        .priority-low {
            color: #4CAF50;
        }
        
        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .priority-high .priority-dot {
            background: #f44336;
        }
        
        .priority-medium .priority-dot {
            background: #ff9800;
        }
        
        .priority-low .priority-dot {
            background: #4CAF50;
        }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .tasks-list {
            margin-top: 16px;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .task-subject {
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1976D2;
            border-radius: 3px;
            font-size: 11px;
            flex-shrink: 0;
        }
        
        .task-title {
            flex: 1;
            font-size: 14px;
            color: #333;
        }
        
        .task-time {
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        
        .remove-task-btn {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .remove-task-btn:hover {
            background: #ffebee;
        }
        
        /* æ·»åŠ ä»»åŠ¡æŒ‰é’® */
        .add-task-btn {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .add-task-btn:hover {
            border-color: #4CAF50;
            color: #4CAF50;
            background: #e8f5e8;
        }
        
        /* æ¨¡æ¿é€‰æ‹© */
        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .template-item {
            padding: 16px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .template-item:hover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .template-item.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
            position: relative;
        }
        
        .template-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4CAF50;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .template-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .template-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* æäº¤æŒ‰é’® */
        .submit-section {
            padding: 20px 0;
        }
        
        .submit-btn {
            width: 100%;
            height: 56px;
            background: linear-gradient(90deg, #4CAF50 0%, #388E3C 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(76, 175, 80, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ™ºèƒ½å»ºè®® */
        .ai-suggestions {
            background: linear-gradient(135deg, #e8f5e8 0%, #f3e5f5 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .suggestion-list {
            margin-top: 12px;
        }
        
        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        
        .suggestion-icon {
            font-size: 16px;
            margin-top: 2px;
        }
        
        .suggestion-text {
            flex: 1;
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }
        
        .use-suggestion-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .subjects-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <button class="back-btn" onclick="goBack()">â†</button>
                    <div class="navbar-title">åˆ›å»ºå­¦ä¹ è®¡åˆ’</div>
                </div>
                <button class="save-btn" onclick="saveDraft()">ä¿å­˜è‰ç¨¿</button>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- å¿«é€Ÿåˆ›å»º -->
            <div class="ai-suggestions">
                <div class="section-title">
                    âš¡ å¿«é€Ÿåˆ›å»ºå­¦ä¹ è®¡åˆ’
                </div>
                <div class="suggestion-list" id="aiSuggestions">
                    <div class="suggestion-item">
                        <div class="suggestion-icon">ğŸ“–</div>
                        <div class="suggestion-text">æ•°å­¦ä¸“é¡¹ç»ƒä¹ ï¼ˆ30åˆ†é’Ÿ/å¤©ï¼Œé€‚åˆæå‡è®¡ç®—èƒ½åŠ›ï¼‰</div>
                        <button class="use-suggestion-btn" onclick="useSuggestion(0)">é€‰æ‹©</button>
                    </div>
                    <div class="suggestion-item">
                        <div class="suggestion-icon">ğŸ“</div>
                        <div class="suggestion-text">è¯­æ–‡é˜…è¯»ç†è§£ï¼ˆ25åˆ†é’Ÿ/å¤©ï¼Œæå‡ç†è§£èƒ½åŠ›ï¼‰</div>
                        <button class="use-suggestion-btn" onclick="useSuggestion(1)">é€‰æ‹©</button>
                    </div>
                    <div class="suggestion-item">
                        <div class="suggestion-icon">ğŸŒŸ</div>
                        <div class="suggestion-text">ç»¼åˆå¤ä¹ è®¡åˆ’ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œå…¨é¢æå‡ï¼‰</div>
                        <button class="use-suggestion-btn" onclick="useSuggestion(2)">é€‰æ‹©</button>
                    </div>
                </div>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-section">
                <div class="section-title">
                    ğŸ“ åŸºæœ¬ä¿¡æ¯
                </div>
                <div class="form-group">
                    <label class="form-label">è®¡åˆ’æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="planTitle" placeholder="ä¾‹å¦‚ï¼šæœ¬å‘¨æ•°å­¦å¤ä¹ è®¡åˆ’">
                </div>
                <div class="form-group">
                    <label class="form-label">è®¡åˆ’æè¿°</label>
                    <textarea class="form-textarea" id="planDescription" placeholder="ç®€è¦æè¿°è¿™ä¸ªå­¦ä¹ è®¡åˆ’çš„ç›®æ ‡å’Œå†…å®¹..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">è®¡åˆ’æ—¶é•¿</label>
                    <div class="time-selector">
                        <input type="number" class="time-input" id="planDays" value="7" min="1" max="30">
                        <span class="time-label">å¤©</span>
                        <span class="time-label">Â·</span>
                        <input type="number" class="time-input" id="dailyTime" value="30" min="15" max="120">
                        <span class="time-label">åˆ†é’Ÿ/å¤©</span>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ç§‘é€‰æ‹© -->
            <div class="form-section">
                <div class="section-title">
                    ğŸ“š å­¦ç§‘é€‰æ‹©
                </div>
                <div class="subjects-grid">
                    <div class="subject-item" data-subject="math" onclick="toggleSubject('math')">
                        æ•°å­¦
                    </div>
                    <div class="subject-item" data-subject="chinese" onclick="toggleSubject('chinese')">
                        è¯­æ–‡
                    </div>
                    <div class="subject-item" data-subject="english" onclick="toggleSubject('english')">
                        è‹±è¯­
                    </div>
                    <div class="subject-item" data-subject="physics" onclick="toggleSubject('physics')">
                        ç‰©ç†
                    </div>
                    <div class="subject-item" data-subject="chemistry" onclick="toggleSubject('chemistry')">
                        åŒ–å­¦
                    </div>
                    <div class="subject-item" data-subject="biology" onclick="toggleSubject('biology')">
                        ç”Ÿç‰©
                    </div>
                </div>
            </div>
            
            <!-- å­¦ä¹ ä»»åŠ¡ -->
            <div class="form-section">
                <div class="section-title">
                    âœ… å­¦ä¹ ä»»åŠ¡
                </div>
                <div class="tasks-list" id="tasksList">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="add-task-btn" onclick="addTask()">
                    â• æ·»åŠ ä»»åŠ¡
                </button>
            </div>
            
            <!-- ä¼˜å…ˆçº§è®¾ç½® -->
            <div class="form-section">
                <div class="section-title">
                    ğŸ¯ ä¼˜å…ˆçº§
                </div>
                <div class="priority-options">
                    <div class="priority-item priority-high" data-priority="high" onclick="setPriority('high')">
                        <div class="priority-dot"></div>
                        <span>é«˜</span>
                    </div>
                    <div class="priority-item priority-medium selected" data-priority="medium" onclick="setPriority('medium')">
                        <div class="priority-dot"></div>
                        <span>ä¸­</span>
                    </div>
                    <div class="priority-item priority-low" data-priority="low" onclick="setPriority('low')">
                        <div class="priority-dot"></div>
                        <span>ä½</span>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ä¹ ç›®æ ‡ -->
            <div class="form-section">
                <div class="section-title">
                    ğŸ¯ é€‰æ‹©å­¦ä¹ ç›®æ ‡
                </div>
                <div class="template-grid" id="templateGrid">
                    <!-- å­¦ä¹ ç›®æ ‡å°†æ ¹æ®ç”¨æˆ·å¹´çº§åŠ¨æ€ç”Ÿæˆ -->
                    <div class="template-item" onclick="useTemplate('basic')">
                        <div class="template-title">ğŸ“š åŸºç¡€æå‡</div>
                        <div class="template-desc">å·©å›ºåŸºç¡€çŸ¥è¯†ï¼Œé€‚åˆæˆç»©ä¸ç¨³å®š</div>
                    </div>
                    <div class="template-item" onclick="useTemplate('intensive')">
                        <div class="template-title">ğŸš€ å¿«é€Ÿçªç ´</div>
                        <div class="template-desc">é›†ä¸­è®­ç»ƒï¼Œå¿«é€Ÿæé«˜æˆç»©</div>
                    </div>
                    <div class="template-item" onclick="useTemplate('maintenance')">
                        <div class="template-title">ğŸ”„ ä¿æŒçŠ¶æ€</div>
                        <div class="template-desc">ç»´æŒç°æœ‰æ°´å¹³ï¼Œé˜²æ­¢é€€æ­¥</div>
                    </div>
                    <div class="template-item" onclick="useTemplate('exam')">
                        <div class="template-title">ğŸ“ è€ƒè¯•å‡†å¤‡</div>
                        <div class="template-desc">é’ˆå¯¹è€ƒè¯•çš„ä¸“é¡¹å¤ä¹ </div>
                    </div>
                </div>
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <button class="submit-btn" id="submitBtn" onclick="createPlan()">
                    <span id="submitText">ğŸ’ª å¼€å§‹æˆ‘çš„å­¦ä¹ è®¡åˆ’</span>
                    <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let selectedSubjects = []; // ä¿®æ”¹ï¼šé»˜è®¤ä¸é€‰æ‹©ä»»ä½•å­¦ç§‘ï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©
        let selectedPriority = 'medium';
        let tasks = [];
        let isSubmitting = false;
        let isPlanCreated = false; // æ·»åŠ æ ‡è®°ï¼Œè¡¨ç¤ºè®¡åˆ’æ˜¯å¦å·²åˆ›å»ºæˆåŠŸ
        let userProfile = null; // å­˜å‚¨ç”¨æˆ·èµ„æ–™ï¼ŒåŒ…å«å¹´çº§ä¿¡æ¯

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });

        function initPage() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            token = localStorage.getItem('token');
            if (!token) {
                console.log('æœªæ‰¾åˆ°ç™»å½•tokenï¼Œè®¾ç½®æµ‹è¯•token');
                token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxMDAwMjMsInN1YiI6IjEifQ.R_dHdA1lUTRzyBIGxCPk6UrO7kiucBwSl3R_PHieRn8';
                localStorage.setItem('token', token);
            }
            
            // ä¿®æ”¹ï¼šä¸å†é»˜è®¤é€‰æ‹©ä»»ä½•å­¦ç§‘
            selectedSubjects = [];
            
            // åŠ è½½ç”¨æˆ·ä¿¡æ¯ä»¥è·å–å¹´çº§ï¼Œç”¨äºä¸ªæ€§åŒ–æ¨è
            loadUserProfile();
            
            updateTasksList();
        }

        async function loadUserProfile() {
            try {
                console.log('åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥è·å–å¹´çº§ä¿¡æ¯...');
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    userProfile = await response.json();
                    console.log('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸï¼Œå¹´çº§:', userProfile.grade);
                    
                    // æ ¹æ®ç”¨æˆ·å¹´çº§æ›´æ–°å¿«é€Ÿåˆ›å»ºå»ºè®®
                    updateGradeBasedSuggestions();
                } else {
                    console.error('ç”¨æˆ·èµ„æ–™åŠ è½½å¤±è´¥:', response.status);
                    // ä½¿ç”¨é»˜è®¤å¹´çº§
                    userProfile = { grade: 'äº”å¹´çº§' };
                    updateGradeBasedSuggestions();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
                // ä½¿ç”¨é»˜è®¤å¹´çº§
                userProfile = { grade: 'äº”å¹´çº§' };
                updateGradeBasedSuggestions();
            }
        }

        function updateGradeBasedSuggestions() {
            const gradeBasedSuggestions = getGradeBasedSuggestions(userProfile.grade);
            const suggestionsContainer = document.getElementById('aiSuggestions');
            
            // æ›´æ–°å¿«é€Ÿåˆ›å»ºå»ºè®®å†…å®¹
            suggestionsContainer.innerHTML = gradeBasedSuggestions.map((suggestion, index) => `
                <div class="suggestion-item">
                    <div class="suggestion-icon">${suggestion.icon}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                    <button class="use-suggestion-btn" onclick="useSuggestion(${index})">é€‰æ‹©</button>
                </div>
            `).join('');
            
            // æ›´æ–°å­¦ä¹ ç›®æ ‡æ¨¡æ¿
            updateGradeBasedTemplates();
            
            console.log(`å·²ä¸º${userProfile.grade}ç”¨æˆ·æ›´æ–°å¿«é€Ÿåˆ›å»ºå»ºè®®å’Œå­¦ä¹ ç›®æ ‡`);
        }

        function updateGradeBasedTemplates() {
            const gradeBasedTemplates = getGradeBasedTemplates(userProfile.grade);
            const templateGrid = document.getElementById('templateGrid');
            
            templateGrid.innerHTML = gradeBasedTemplates.map(template => `
                <div class="template-item" onclick="useTemplate('${template.type}')">
                    <div class="template-title">${template.icon} ${template.title}</div>
                    <div class="template-desc">${template.description}</div>
                </div>
            `).join('');
        }

        function getGradeBasedTemplates(grade) {
            // æ ¹æ®å¹´çº§æä¾›ä¸ªæ€§åŒ–çš„å­¦ä¹ ç›®æ ‡æ¨¡æ¿
            const isElementary = ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§'].includes(grade);
            const isJunior = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰'].includes(grade);
            const isSenior = ['é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'].includes(grade);

            if (isElementary) {
                return [
                    { type: 'basic', icon: 'ğŸ¯', title: 'åŸºç¡€å·©å›º', description: 'å¤¯å®åŸºç¡€çŸ¥è¯†ï¼ŒåŸ¹å…»å­¦ä¹ å…´è¶£' },
                    { type: 'skill', icon: 'ğŸ§ ', title: 'èƒ½åŠ›æå‡', description: 'å‘å±•æ€ç»´èƒ½åŠ›ï¼Œæé«˜å­¦ä¹ æ•ˆç‡' },
                    { type: 'habit', icon: 'â°', title: 'ä¹ æƒ¯å…»æˆ', description: 'åŸ¹å…»è‰¯å¥½å­¦ä¹ ä¹ æƒ¯å’Œæ–¹æ³•' },
                    { type: 'exam', icon: 'ğŸ“', title: 'é˜¶æ®µæµ‹è¯„', description: 'å®šæœŸæ£€æµ‹å­¦ä¹ æˆæœ' }
                ];
            } else if (isJunior) {
                return [
                    { type: 'foundation', icon: 'ğŸ“š', title: 'çŸ¥è¯†æ¢³ç†', description: 'ç³»ç»Ÿæ¢³ç†å„ç§‘çŸ¥è¯†ç‚¹' },
                    { type: 'intensive', icon: 'ğŸš€', title: 'ä¸“é¡¹çªç ´', description: 'é’ˆå¯¹è–„å¼±ç¯èŠ‚é‡ç‚¹æ”»å…‹' },
                    { type: 'comprehensive', icon: 'ğŸŒŸ', title: 'ç»¼åˆè®­ç»ƒ', description: 'è·¨å­¦ç§‘ç»¼åˆèƒ½åŠ›åŸ¹å…»' },
                    { type: 'exam', icon: 'ğŸ¯', title: 'ä¸­è€ƒå†²åˆº', description: 'é’ˆå¯¹ä¸­è€ƒçš„ä¸“é¡¹è®­ç»ƒ' }
                ];
            } else if (isSenior) {
                return [
                    { type: 'advanced', icon: 'ğŸ“', title: 'é«˜é˜¶å­¦ä¹ ', description: 'æ·±åº¦ç†è§£ï¼ŒæŒæ¡é«˜é˜¶æ€ç»´' },
                    { type: 'competitive', icon: 'ğŸ†', title: 'ç«èµ›å¤‡æˆ˜', description: 'é’ˆå¯¹å„ç±»ç«èµ›çš„ä¸“ä¸šè®­ç»ƒ' },
                    { type: 'university', icon: 'ğŸŒŸ', title: 'å¤§å­¦è¡”æ¥', description: 'ä¸ºå¤§å­¦å­¦ä¹ åšå¥½å‡†å¤‡' },
                    { type: 'gaokao', icon: 'ğŸš€', title: 'é«˜è€ƒå†²åˆº', description: 'å…¨é¢ç³»ç»Ÿçš„é«˜è€ƒå¤‡è€ƒ' }
                ];
            } else {
                // é»˜è®¤æ¨¡æ¿
                return [
                    { type: 'basic', icon: 'ğŸ“š', title: 'åŸºç¡€æå‡', description: 'å·©å›ºåŸºç¡€çŸ¥è¯†ï¼Œé€‚åˆæˆç»©ä¸ç¨³å®š' },
                    { type: 'intensive', icon: 'ğŸš€', title: 'å¿«é€Ÿçªç ´', description: 'é›†ä¸­è®­ç»ƒï¼Œå¿«é€Ÿæé«˜æˆç»©' },
                    { type: 'maintenance', icon: 'ğŸ”„', title: 'ä¿æŒçŠ¶æ€', description: 'ç»´æŒç°æœ‰æ°´å¹³ï¼Œé˜²æ­¢é€€æ­¥' },
                    { type: 'exam', icon: 'ğŸ“', title: 'è€ƒè¯•å‡†å¤‡', description: 'é’ˆå¯¹è€ƒè¯•çš„ä¸“é¡¹å¤ä¹ ' }
                ];
            }
        }

        function getGradeBasedSuggestions(grade) {
            // æ ¹æ®ä¸åŒå¹´çº§æä¾›ä¸ªæ€§åŒ–çš„å­¦ä¹ è®¡åˆ’å»ºè®®
            const gradeConfig = {
                'ä¸€å¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ”¤', text: 'æ‹¼éŸ³ç»ƒä¹ è®¡åˆ’ï¼ˆ20åˆ†é’Ÿ/å¤©ï¼Œé€‚åˆå·©å›ºæ‹¼éŸ³åŸºç¡€ï¼‰' },
                        { icon: 'ğŸ”¢', text: 'æ•°å­—è®¤çŸ¥è®­ç»ƒï¼ˆ15åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»æ•°æ„Ÿï¼‰' },
                        { icon: 'âœï¸', text: 'ä¹¦å†™ç»ƒä¹ è®¡åˆ’ï¼ˆ25åˆ†é’Ÿ/å¤©ï¼Œè§„èŒƒå­—å½¢ï¼‰' }
                    ]
                },
                'äºŒå¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ“–', text: 'é˜…è¯»ç†è§£å…¥é—¨ï¼ˆ25åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»é˜…è¯»å…´è¶£ï¼‰' },
                        { icon: 'â•', text: 'åŠ å‡æ³•å¼ºåŒ–ï¼ˆ20åˆ†é’Ÿ/å¤©ï¼Œæå‡è¿ç®—é€Ÿåº¦ï¼‰' },
                        { icon: 'ğŸ¨', text: 'çœ‹å›¾å†™è¯è®­ç»ƒï¼ˆ30åˆ†é’Ÿ/å¤©ï¼Œå‘å±•è¡¨è¾¾èƒ½åŠ›ï¼‰' }
                    ]
                },
                'ä¸‰å¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ“š', text: 'è¯­æ–‡é˜…è¯»æ‹“å±•ï¼ˆ30åˆ†é’Ÿ/å¤©ï¼Œæå‡ç†è§£èƒ½åŠ›ï¼‰' },
                        { icon: 'âœ–ï¸', text: 'ä¹˜é™¤æ³•ä¸“é¡¹ï¼ˆ25åˆ†é’Ÿ/å¤©ï¼ŒæŒæ¡ä¹˜æ³•è¡¨ï¼‰' },
                        { icon: 'ğŸŒŸ', text: 'ç»¼åˆåŸºç¡€å·©å›ºï¼ˆ40åˆ†é’Ÿ/å¤©ï¼Œå…¨é¢æå‡ï¼‰' }
                    ]
                },
                'å››å¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ“', text: 'ä½œæ–‡å†™ä½œè®­ç»ƒï¼ˆ35åˆ†é’Ÿ/å¤©ï¼Œæå‡å†™ä½œèƒ½åŠ›ï¼‰' },
                        { icon: 'ğŸ“', text: 'å‡ ä½•å›¾å½¢è®¤è¯†ï¼ˆ30åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»ç©ºé—´æ€ç»´ï¼‰' },
                        { icon: 'ğŸ§ ', text: 'é€»è¾‘æ€ç»´è®­ç»ƒï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œç»¼åˆèƒ½åŠ›æå‡ï¼‰' }
                    ]
                },
                'äº”å¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ“–', text: 'æ•°å­¦åº”ç”¨é¢˜ä¸“é¡¹ï¼ˆ30åˆ†é’Ÿ/å¤©ï¼Œæå‡è§£é¢˜èƒ½åŠ›ï¼‰' },
                        { icon: 'ğŸ“', text: 'è¯­æ–‡é˜…è¯»ç†è§£ï¼ˆ25åˆ†é’Ÿ/å¤©ï¼ŒåŠ å¼ºç†è§£åˆ†æï¼‰' },
                        { icon: 'ğŸŒŸ', text: 'ç»¼åˆå¤ä¹ è®¡åˆ’ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œå…¨é¢æå‡ï¼‰' }
                    ]
                },
                'å…­å¹´çº§': {
                    suggestions: [
                        { icon: 'ğŸ“', text: 'å°å‡åˆæ•°å­¦å†²åˆºï¼ˆ40åˆ†é’Ÿ/å¤©ï¼Œé‡ç‚¹éš¾ç‚¹çªç ´ï¼‰' },
                        { icon: 'ğŸ“š', text: 'è¯­æ–‡ç»¼åˆå¤ä¹ ï¼ˆ35åˆ†é’Ÿ/å¤©ï¼Œç³»ç»Ÿæ¢³ç†çŸ¥è¯†ç‚¹ï¼‰' },
                        { icon: 'ğŸš€', text: 'å‡å­¦å¤‡è€ƒè®¡åˆ’ï¼ˆ50åˆ†é’Ÿ/å¤©ï¼Œå…¨é¢å¤‡æˆ˜å°å‡åˆï¼‰' }
                    ]
                },
                'åˆä¸€': {
                    suggestions: [
                        { icon: 'ğŸ§®', text: 'ä»£æ•°åŸºç¡€è®­ç»ƒï¼ˆ35åˆ†é’Ÿ/å¤©ï¼ŒæŒæ¡æ–¹ç¨‹æ¦‚å¿µï¼‰' },
                        { icon: 'ğŸ›ï¸', text: 'æ–‡è¨€æ–‡å…¥é—¨ï¼ˆ30åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»å¤æ–‡ç†è§£ï¼‰' },
                        { icon: 'ğŸŒ', text: 'åˆä¸­çŸ¥è¯†è¡”æ¥ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œé€‚åº”åˆä¸­å­¦ä¹ ï¼‰' }
                    ]
                },
                'åˆäºŒ': {
                    suggestions: [
                        { icon: 'ğŸ“', text: 'å‡ ä½•è¯æ˜è®­ç»ƒï¼ˆ40åˆ†é’Ÿ/å¤©ï¼Œæå‡é€»è¾‘æ¨ç†ï¼‰' },
                        { icon: 'âš—ï¸', text: 'ç‰©ç†æ¦‚å¿µç†è§£ï¼ˆ35åˆ†é’Ÿ/å¤©ï¼ŒæŒæ¡åŸºæœ¬åŸç†ï¼‰' },
                        { icon: 'ğŸ”¬', text: 'ç†ç§‘æ€ç»´å¼ºåŒ–ï¼ˆ50åˆ†é’Ÿ/å¤©ï¼Œç»¼åˆè®­ç»ƒï¼‰' }
                    ]
                },
                'åˆä¸‰': {
                    suggestions: [
                        { icon: 'ğŸ¯', text: 'ä¸­è€ƒæ•°å­¦å†²åˆºï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œé‡ç‚¹é¢˜å‹çªç ´ï¼‰' },
                        { icon: 'ğŸ“–', text: 'è¯­æ–‡é˜…è¯»å†™ä½œï¼ˆ40åˆ†é’Ÿ/å¤©ï¼Œæå‡è¯­è¨€è¿ç”¨ï¼‰' },
                        { icon: 'ğŸš€', text: 'ä¸­è€ƒå…¨ç§‘å¤‡è€ƒï¼ˆ60åˆ†é’Ÿ/å¤©ï¼Œç³»ç»Ÿå¤ä¹ å†²åˆºï¼‰' }
                    ]
                },
                'é«˜ä¸€': {
                    suggestions: [
                        { icon: 'ğŸ“Š', text: 'å‡½æ•°æ¦‚å¿µå¼ºåŒ–ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼ŒæŒæ¡å‡½æ•°æ€æƒ³ï¼‰' },
                        { icon: 'ğŸ›ï¸', text: 'å¤è¯—æ–‡æ·±åº¦è§£æï¼ˆ40åˆ†é’Ÿ/å¤©ï¼Œæå‡æ–‡å­¦ç´ å…»ï¼‰' },
                        { icon: 'ğŸŒŸ', text: 'é«˜ä¸­å­¦ä¹ é€‚åº”ï¼ˆ50åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»å­¦ä¹ æ–¹æ³•ï¼‰' }
                    ]
                },
                'é«˜äºŒ': {
                    suggestions: [
                        { icon: 'ğŸ“', text: 'ç«‹ä½“å‡ ä½•è®­ç»ƒï¼ˆ50åˆ†é’Ÿ/å¤©ï¼ŒåŸ¹å…»ç©ºé—´æƒ³è±¡ï¼‰' },
                        { icon: 'ğŸ§ª', text: 'åŒ–å­¦å®éªŒç†è§£ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼ŒæŒæ¡å®éªŒåŸç†ï¼‰' },
                        { icon: 'ğŸ“š', text: 'æ–‡ç†åˆ†ç§‘å¼ºåŒ–ï¼ˆ55åˆ†é’Ÿ/å¤©ï¼Œä¸“ä¸šæ–¹å‘å‘å±•ï¼‰' }
                    ]
                },
                'é«˜ä¸‰': {
                    suggestions: [
                        { icon: 'ğŸ“', text: 'é«˜è€ƒæ•°å­¦ä¸“é¡¹ï¼ˆ60åˆ†é’Ÿ/å¤©ï¼Œé¢˜å‹ç³»ç»Ÿè®­ç»ƒï¼‰' },
                        { icon: 'ğŸ“', text: 'ä½œæ–‡ç´ æç§¯ç´¯ï¼ˆ45åˆ†é’Ÿ/å¤©ï¼Œæå‡å†™ä½œæ°´å¹³ï¼‰' },
                        { icon: 'ğŸš€', text: 'é«˜è€ƒå…¨é¢å†²åˆºï¼ˆ75åˆ†é’Ÿ/å¤©ï¼Œç»¼åˆå¤‡è€ƒæå‡ï¼‰' }
                    ]
                }
            };

            return gradeConfig[grade] ? gradeConfig[grade].suggestions : gradeConfig['äº”å¹´çº§'].suggestions;
        }

        function toggleSubject(subject) {
            const item = document.querySelector(`[data-subject="${subject}"]`);
            const index = selectedSubjects.indexOf(subject);
            
            if (index > -1) {
                // å¦‚æœå·²é€‰æ‹©ï¼Œåˆ™å–æ¶ˆé€‰æ‹©ï¼ˆå…è®¸å–æ¶ˆæ‰€æœ‰é€‰æ‹©ï¼‰
                selectedSubjects.splice(index, 1);
                item.classList.remove('selected');
            } else {
                // å¦‚æœæœªé€‰æ‹©ï¼Œåˆ™æ·»åŠ é€‰æ‹©
                selectedSubjects.push(subject);
                item.classList.add('selected');
            }
            
            updateTasksList();
        }

        function setPriority(priority) {
            document.querySelectorAll('.priority-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-priority="${priority}"]`).classList.add('selected');
            selectedPriority = priority;
        }

        function addTask() {
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å­¦ç§‘
            if (selectedSubjects.length === 0) {
                showToast('ğŸ“š è¯·å…ˆé€‰æ‹©å­¦ç§‘å†æ·»åŠ ä»»åŠ¡å“¦');
                return;
            }
            
            // ç®€åŒ–ç‰ˆï¼šç›´æ¥å¼¹çª—è¾“å…¥ä»»åŠ¡
            const taskTitle = prompt('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜ï¼š');
            if (taskTitle && taskTitle.trim()) {
                const estimatedTime = parseInt(prompt('é¢„è®¡ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰ï¼š', '30')) || 30;
                
                // å¦‚æœé€‰æ‹©äº†å¤šä¸ªå­¦ç§‘ï¼Œè®©ç”¨æˆ·é€‰æ‹©
                let selectedSubject;
                if (selectedSubjects.length === 1) {
                    selectedSubject = selectedSubjects[0];
                } else {
                    const subjectOptions = selectedSubjects.map(s => getSubjectName(s)).join('\n');
                    const choice = prompt(`é€‰æ‹©ä»»åŠ¡æ‰€å±å­¦ç§‘ï¼š\n${subjectOptions}\n\nè¯·è¾“å…¥å­¦ç§‘åç§°ï¼š`);
                    const subjectMap = {
                        'æ•°å­¦': 'math', 'è¯­æ–‡': 'chinese', 'è‹±è¯­': 'english',
                        'ç‰©ç†': 'physics', 'åŒ–å­¦': 'chemistry', 'ç”Ÿç‰©': 'biology'
                    };
                    selectedSubject = Object.keys(subjectMap).find(key => key === choice);
                    selectedSubject = subjectMap[selectedSubject] || selectedSubjects[0];
                }
                
                tasks.push({
                    id: Date.now(),
                    title: taskTitle.trim(),
                    subject: selectedSubject,  // ä¿®å¤ï¼šä¿å­˜è‹±æ–‡å­¦ç§‘ä»£ç è€Œä¸æ˜¯ä¸­æ–‡åç§°
                    estimatedTime: estimatedTime
                });
                
                updateTasksList();
            }
        }

        function removeTask(taskId) {
            tasks = tasks.filter(task => task.id !== taskId);
            updateTasksList();
        }

        function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è¿˜æ²¡æœ‰æ·»åŠ ä»»åŠ¡ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>';
                return;
            }
            
            const tasksHtml = tasks.map(task => `
                <div class="task-item">
                    <div class="task-subject">${getSubjectName(task.subject)}</div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-time">${task.estimatedTime}åˆ†é’Ÿ</div>
                    <button class="remove-task-btn" onclick="removeTask(${task.id})">Ã—</button>
                </div>
            `).join('');
            
            tasksList.innerHTML = tasksHtml;
        }



        function useSuggestion(index) {
            // è·å–å½“å‰å¹´çº§çš„å»ºè®®
            const gradeBasedSuggestions = getGradeBasedSuggestions(userProfile.grade);
            const selectedSuggestion = gradeBasedSuggestions[index];
            
            if (!selectedSuggestion) return;
            
            // æ ¹æ®å»ºè®®å†…å®¹æ™ºèƒ½è§£æå­¦ç§‘å’Œæ—¶é—´
            const suggestionText = selectedSuggestion.text;
            
            // æå–æ—¶é—´ä¿¡æ¯ï¼ˆå¦‚ï¼š30åˆ†é’Ÿ/å¤©ï¼‰
            const timeMatch = suggestionText.match(/ï¼ˆ(\d+)åˆ†é’Ÿ/);
            const dailyTime = timeMatch ? parseInt(timeMatch[1]) : 30;
            
            // æ ¹æ®å»ºè®®å†…å®¹é€‰æ‹©åˆé€‚çš„å­¦ç§‘
            let recommendedSubjects = [];
            if (suggestionText.includes('æ•°å­¦') || suggestionText.includes('è®¡ç®—') || suggestionText.includes('å‡ ä½•') || suggestionText.includes('ä»£æ•°') || suggestionText.includes('åº”ç”¨é¢˜')) {
                recommendedSubjects.push('math');
            }
            if (suggestionText.includes('è¯­æ–‡') || suggestionText.includes('é˜…è¯»') || suggestionText.includes('ä½œæ–‡') || suggestionText.includes('å†™ä½œ') || suggestionText.includes('æ‹¼éŸ³') || suggestionText.includes('æ–‡è¨€æ–‡')) {
                recommendedSubjects.push('chinese');
            }
            if (suggestionText.includes('è‹±è¯­') || suggestionText.includes('å•è¯') || suggestionText.includes('è¯­æ³•')) {
                recommendedSubjects.push('english');
            }
            if (suggestionText.includes('ç‰©ç†') || suggestionText.includes('å®éªŒ')) {
                recommendedSubjects.push('physics');
            }
            if (suggestionText.includes('åŒ–å­¦')) {
                recommendedSubjects.push('chemistry');
            }
            if (suggestionText.includes('ç”Ÿç‰©')) {
                recommendedSubjects.push('biology');
            }
            
            // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ç‰¹å®šå­¦ç§‘ï¼Œæ ¹æ®å¹´çº§æ¨èä¸»è¦å­¦ç§‘
            if (recommendedSubjects.length === 0) {
                const grade = userProfile.grade;
                const isElementary = ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§'].includes(grade);
                const isJunior = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰'].includes(grade);
                
                if (isElementary) {
                    recommendedSubjects = ['math', 'chinese'];
                } else if (isJunior) {
                    recommendedSubjects = ['math', 'chinese', 'english'];
                } else {
                    recommendedSubjects = ['math', 'chinese', 'english', 'physics'];
                }
            }
            
            // è®¾ç½®è¡¨å•å†…å®¹
            document.getElementById('planTitle').value = `æˆ‘çš„${userProfile.grade}å­¦ä¹ è®¡åˆ’`;
            document.getElementById('planDescription').value = suggestionText.split('ï¼ˆ')[0]; // å–æ‹¬å·å‰çš„æè¿°éƒ¨åˆ†
            document.getElementById('dailyTime').value = dailyTime.toString();
            
            // æ¸…é™¤ä¹‹å‰çš„å­¦ç§‘é€‰æ‹©
            selectedSubjects = [];
            document.querySelectorAll('.subject-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©æ¨èçš„å­¦ç§‘
            recommendedSubjects.forEach(subject => {
                toggleSubject(subject);
            });
            
            // æ ¹æ®å¹´çº§å’Œå»ºè®®ç±»å‹ç”Ÿæˆç›¸åº”çš„ä»»åŠ¡
            tasks = generateGradeBasedTasks(userProfile.grade, suggestionText, recommendedSubjects, dailyTime);
            updateTasksList();
            
            showToast(`å·²ä¸ºæ‚¨å¿«é€Ÿåˆ›å»º${userProfile.grade}ä¸“ç”¨å­¦ä¹ è®¡åˆ’ï¼`);
        }

        function generateGradeBasedTasks(grade, suggestionText, subjects, totalTime) {
            const tasks = [];
            const timePerSubject = Math.floor(totalTime / subjects.length);
            
            // æ ¹æ®å¹´çº§å®šä¹‰ä¸åŒçš„ä»»åŠ¡ç±»å‹
            const taskTemplates = {
                elementary: {
                    math: [
                        { title: 'æ•°å­—ç»ƒä¹ ', time: 0.4 },
                        { title: 'åŸºç¡€è¿ç®—', time: 0.6 }
                    ],
                    chinese: [
                        { title: 'æ‹¼éŸ³ç»ƒä¹ ', time: 0.3 },
                        { title: 'å­—è¯å­¦ä¹ ', time: 0.4 },
                        { title: 'é˜…è¯»ç»ƒä¹ ', time: 0.3 }
                    ],
                    english: [
                        { title: 'å•è¯å­¦ä¹ ', time: 0.5 },
                        { title: 'åŸºç¡€å¯¹è¯', time: 0.5 }
                    ]
                },
                junior: {
                    math: [
                        { title: 'æ¦‚å¿µç†è§£', time: 0.3 },
                        { title: 'ä¾‹é¢˜ç»ƒä¹ ', time: 0.4 },
                        { title: 'åº”ç”¨è®­ç»ƒ', time: 0.3 }
                    ],
                    chinese: [
                        { title: 'æ–‡è¨€æ–‡å­¦ä¹ ', time: 0.3 },
                        { title: 'é˜…è¯»ç†è§£', time: 0.4 },
                        { title: 'ä½œæ–‡ç»ƒä¹ ', time: 0.3 }
                    ],
                    english: [
                        { title: 'è¯­æ³•å­¦ä¹ ', time: 0.4 },
                        { title: 'é˜…è¯»ç†è§£', time: 0.3 },
                        { title: 'å¬åŠ›è®­ç»ƒ', time: 0.3 }
                    ],
                    physics: [
                        { title: 'æ¦‚å¿µå­¦ä¹ ', time: 0.4 },
                        { title: 'å®éªŒç†è§£', time: 0.6 }
                    ]
                },
                senior: {
                    math: [
                        { title: 'å‡½æ•°ç†è§£', time: 0.3 },
                        { title: 'é¢˜å‹è®­ç»ƒ', time: 0.4 },
                        { title: 'ç»¼åˆåº”ç”¨', time: 0.3 }
                    ],
                    chinese: [
                        { title: 'å¤è¯—æ–‡åˆ†æ', time: 0.3 },
                        { title: 'ç°ä»£æ–‡é˜…è¯»', time: 0.3 },
                        { title: 'ä½œæ–‡å†™ä½œ', time: 0.4 }
                    ],
                    english: [
                        { title: 'é«˜çº§è¯­æ³•', time: 0.3 },
                        { title: 'å®Œå‹å¡«ç©º', time: 0.3 },
                        { title: 'ä½œæ–‡è®­ç»ƒ', time: 0.4 }
                    ],
                    physics: [
                        { title: 'ç‰©ç†å»ºæ¨¡', time: 0.4 },
                        { title: 'å®éªŒåˆ†æ', time: 0.3 },
                        { title: 'ç»¼åˆåº”ç”¨', time: 0.3 }
                    ]
                }
            };
            
            // ç¡®å®šå¹´çº§ç±»å‹
            const isElementary = ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§'].includes(grade);
            const isJunior = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰'].includes(grade);
            const isSenior = ['é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'].includes(grade);
            
            let templateType = 'elementary';
            if (isJunior) templateType = 'junior';
            else if (isSenior) templateType = 'senior';
            
            // ä¸ºæ¯ä¸ªå­¦ç§‘ç”Ÿæˆä»»åŠ¡
            subjects.forEach((subject, index) => {
                const subjectTemplates = taskTemplates[templateType][subject] || taskTemplates[templateType]['math'];
                
                subjectTemplates.forEach((template, taskIndex) => {
                    const taskTime = Math.round(timePerSubject * template.time);
                    if (taskTime > 0) {
                        tasks.push({
                            id: Date.now() + index * 1000 + taskIndex,
                            title: `${getSubjectName(subject)}${template.title}`,
                            subject: subject,
                            estimatedTime: taskTime
                        });
                    }
                });
            });
            
            return tasks;
        }

        // æ–°å¢å‡½æ•°ï¼šä¼˜åŒ–æ¨¡æ¿åº”ç”¨ï¼Œç¡®ä¿ä¸å¹´çº§åŒ¹é…
        function useTemplate(templateType) {
            // å…ˆæ¸…é™¤æ‰€æœ‰æ¨¡æ¿çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // ç»™å½“å‰ç‚¹å‡»çš„æ¨¡æ¿æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.target.closest('.template-item').classList.add('selected');
            
            // å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©å­¦ç§‘ï¼Œæ ¹æ®å¹´çº§æ¨èåˆé€‚çš„å­¦ç§‘
            if (selectedSubjects.length === 0) {
                const grade = userProfile ? userProfile.grade : 'äº”å¹´çº§';
                const isElementary = ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§'].includes(grade);
                const isJunior = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰'].includes(grade);
                
                if (isElementary) {
                    toggleSubject('math');
                    if (templateType === 'intensive' || templateType === 'exam') {
                        toggleSubject('chinese'); // é«˜å¼ºåº¦æˆ–è€ƒè¯•å‡†å¤‡éœ€è¦å¤šå­¦ç§‘
                    }
                } else if (isJunior) {
                    toggleSubject('math');
                    toggleSubject('chinese');
                    if (templateType === 'comprehensive' || templateType === 'exam') {
                        toggleSubject('english'); // ç»¼åˆè®­ç»ƒæˆ–ä¸­è€ƒå†²åˆºéœ€è¦è‹±è¯­
                    }
                } else {
                    // é«˜ä¸­é»˜è®¤é€‰æ‹©æ›´å¤šå­¦ç§‘
                    toggleSubject('math');
                    toggleSubject('chinese');
                    toggleSubject('english');
                    if (templateType === 'advanced' || templateType === 'gaokao') {
                        toggleSubject('physics'); // é«˜é˜¶å­¦ä¹ æˆ–é«˜è€ƒå†²åˆºåŠ å…¥ç†ç§‘
                    }
                }
            }
            
            // æ ¹æ®å¹´çº§å’Œæ¨¡æ¿ç±»å‹ç”Ÿæˆå¯¹åº”çš„è®¡åˆ’ä¿¡æ¯
            const gradeBasedTemplates = getTemplatesByGradeAndType(userProfile?.grade || 'äº”å¹´çº§', templateType);
            
            if (gradeBasedTemplates) {
                document.getElementById('planTitle').value = gradeBasedTemplates.title;
                document.getElementById('planDescription').value = gradeBasedTemplates.description;
                
                // è°ƒæ•´æ—¶é—´è®¾ç½®
                if (gradeBasedTemplates.dailyTime) {
                    document.getElementById('dailyTime').value = gradeBasedTemplates.dailyTime.toString();
                }
                if (gradeBasedTemplates.durationDays) {
                    document.getElementById('planDays').value = gradeBasedTemplates.durationDays.toString();
                }
                
                // æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„å­¦ç§‘å’Œå¹´çº§ç”Ÿæˆä»»åŠ¡
                tasks = [];
                selectedSubjects.forEach(subject => {
                    const subjectTasks = generateTasksForGradeTemplate(subject, gradeBasedTemplates.taskTemplates, templateType);
                    tasks.push(...subjectTasks);
                });
                
                updateTasksList();
                showToast(`å·²åº”ç”¨${gradeBasedTemplates.title}æ¨¡æ¿`);
            }
        }

        // æ–°å¢å‡½æ•°ï¼šæ ¹æ®å¹´çº§å’Œæ¨¡æ¿ç±»å‹è·å–æ¨¡æ¿é…ç½®
        function getTemplatesByGradeAndType(grade, templateType) {
            const isElementary = ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§'].includes(grade);
            const isJunior = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰'].includes(grade);
            const isSenior = ['é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'].includes(grade);
            
            const templates = {
                elementary: {
                    'basic': {
                        title: `æˆ‘çš„${grade}åŸºç¡€å·©å›ºè®¡åˆ’`,
                        description: 'å¤¯å®åŸºç¡€çŸ¥è¯†ï¼ŒåŸ¹å…»å­¦ä¹ å…´è¶£å’Œè‰¯å¥½ä¹ æƒ¯',
                        dailyTime: 25,
                        durationDays: 7,
                        taskTemplates: [
                            { title: 'åŸºç¡€çŸ¥è¯†å¤ä¹ ', time: 15 },
                            { title: 'è¶£å‘³ç»ƒä¹ ', time: 10 }
                        ]
                    },
                    'skill': {
                        title: `æˆ‘çš„${grade}èƒ½åŠ›æå‡è®¡åˆ’`,
                        description: 'å‘å±•æ€ç»´èƒ½åŠ›ï¼Œæé«˜å­¦ä¹ æ•ˆç‡',
                        dailyTime: 30,
                        durationDays: 10,
                        taskTemplates: [
                            { title: 'æ€ç»´è®­ç»ƒ', time: 15 },
                            { title: 'èƒ½åŠ›æ‹“å±•', time: 15 }
                        ]
                    },
                    'habit': {
                        title: `æˆ‘çš„${grade}ä¹ æƒ¯å…»æˆè®¡åˆ’`,
                        description: 'åŸ¹å…»è‰¯å¥½å­¦ä¹ ä¹ æƒ¯å’Œæ–¹æ³•',
                        dailyTime: 20,
                        durationDays: 14,
                        taskTemplates: [
                            { title: 'ä¹ æƒ¯ç»ƒä¹ ', time: 10 },
                            { title: 'æ–¹æ³•è®­ç»ƒ', time: 10 }
                        ]
                    },
                    'exam': {
                        title: `æˆ‘çš„${grade}é˜¶æ®µæµ‹è¯„è®¡åˆ’`,
                        description: 'å®šæœŸæ£€æµ‹å­¦ä¹ æˆæœï¼ŒæŸ¥ç¼ºè¡¥æ¼',
                        dailyTime: 35,
                        durationDays: 5,
                        taskTemplates: [
                            { title: 'çŸ¥è¯†å¤ä¹ ', time: 20 },
                            { title: 'æ¨¡æ‹Ÿç»ƒä¹ ', time: 15 }
                        ]
                    }
                },
                junior: {
                    'foundation': {
                        title: `æˆ‘çš„${grade}çŸ¥è¯†æ¢³ç†è®¡åˆ’`,
                        description: 'ç³»ç»Ÿæ¢³ç†å„ç§‘çŸ¥è¯†ç‚¹ï¼Œå»ºç«‹çŸ¥è¯†ä½“ç³»',
                        dailyTime: 45,
                        durationDays: 10,
                        taskTemplates: [
                            { title: 'çŸ¥è¯†æ¢³ç†', time: 25 },
                            { title: 'ä½“ç³»æ„å»º', time: 20 }
                        ]
                    },
                    'intensive': {
                        title: `æˆ‘çš„${grade}ä¸“é¡¹çªç ´è®¡åˆ’`,
                        description: 'é’ˆå¯¹è–„å¼±ç¯èŠ‚é‡ç‚¹æ”»å…‹',
                        dailyTime: 50,
                        durationDays: 7,
                        taskTemplates: [
                            { title: 'ä¸“é¡¹è®­ç»ƒ', time: 30 },
                            { title: 'å¼ºåŒ–ç»ƒä¹ ', time: 20 }
                        ]
                    },
                    'comprehensive': {
                        title: `æˆ‘çš„${grade}ç»¼åˆè®­ç»ƒè®¡åˆ’`,
                        description: 'è·¨å­¦ç§‘ç»¼åˆèƒ½åŠ›åŸ¹å…»',
                        dailyTime: 60,
                        durationDays: 14,
                        taskTemplates: [
                            { title: 'ç»¼åˆç»ƒä¹ ', time: 35 },
                            { title: 'èƒ½åŠ›è®­ç»ƒ', time: 25 }
                        ]
                    },
                    'exam': {
                        title: `æˆ‘çš„${grade}ä¸­è€ƒå†²åˆºè®¡åˆ’`,
                        description: 'é’ˆå¯¹ä¸­è€ƒçš„ä¸“é¡¹è®­ç»ƒå’Œç»¼åˆæå‡',
                        dailyTime: 70,
                        durationDays: 21,
                        taskTemplates: [
                            { title: 'è€ƒç‚¹å¤ä¹ ', time: 40 },
                            { title: 'çœŸé¢˜è®­ç»ƒ', time: 30 }
                        ]
                    }
                },
                senior: {
                    'advanced': {
                        title: `æˆ‘çš„${grade}é«˜é˜¶å­¦ä¹ è®¡åˆ’`,
                        description: 'æ·±åº¦ç†è§£ï¼ŒæŒæ¡é«˜é˜¶æ€ç»´æ–¹æ³•',
                        dailyTime: 60,
                        durationDays: 14,
                        taskTemplates: [
                            { title: 'æ·±åº¦å­¦ä¹ ', time: 35 },
                            { title: 'æ€ç»´æå‡', time: 25 }
                        ]
                    },
                    'competitive': {
                        title: `æˆ‘çš„${grade}ç«èµ›å¤‡æˆ˜è®¡åˆ’`,
                        description: 'é’ˆå¯¹å„ç±»ç«èµ›çš„ä¸“ä¸šè®­ç»ƒ',
                        dailyTime: 80,
                        durationDays: 21,
                        taskTemplates: [
                            { title: 'ç«èµ›è®­ç»ƒ', time: 50 },
                            { title: 'ä¸“é¢˜çªç ´', time: 30 }
                        ]
                    },
                    'university': {
                        title: `æˆ‘çš„${grade}å¤§å­¦è¡”æ¥è®¡åˆ’`,
                        description: 'ä¸ºå¤§å­¦å­¦ä¹ åšå¥½å……åˆ†å‡†å¤‡',
                        dailyTime: 55,
                        durationDays: 14,
                        taskTemplates: [
                            { title: 'è¡”æ¥å­¦ä¹ ', time: 30 },
                            { title: 'èƒ½åŠ›å‡†å¤‡', time: 25 }
                        ]
                    },
                    'gaokao': {
                        title: `æˆ‘çš„${grade}é«˜è€ƒå†²åˆºè®¡åˆ’`,
                        description: 'å…¨é¢ç³»ç»Ÿçš„é«˜è€ƒå¤‡è€ƒç­–ç•¥',
                        dailyTime: 90,
                        durationDays: 30,
                        taskTemplates: [
                            { title: 'é«˜è€ƒå¤ä¹ ', time: 55 },
                            { title: 'æ¨¡æ‹Ÿè®­ç»ƒ', time: 35 }
                        ]
                    }
                }
            };
            
            let gradeType = 'elementary';
            if (isJunior) gradeType = 'junior';
            else if (isSenior) gradeType = 'senior';
            
            return templates[gradeType][templateType] || templates[gradeType]['basic'];
        }

        // æ–°å¢å‡½æ•°ï¼šä¸ºç‰¹å®šå¹´çº§å’Œæ¨¡æ¿ç”Ÿæˆä»»åŠ¡
        function generateTasksForGradeTemplate(subject, taskTemplates, templateType) {
            const grade = userProfile?.grade || 'äº”å¹´çº§';
            const subjectName = getSubjectName(subject);
            
            return taskTemplates.map((template, index) => ({
                id: Date.now() + Math.random() * 1000 + index,
                title: `${subjectName}${template.title}`,
                subject: subject,
                estimatedTime: template.time
            }));
        }


        async function createPlan() {
            if (isSubmitting) return;
            
            // éªŒè¯å¿…å¡«é¡¹
            const title = document.getElementById('planTitle').value.trim();
            if (!title) {
                showToast('ğŸ“ è¯·ç»™æ‚¨çš„å­¦ä¹ è®¡åˆ’èµ·ä¸ªåå­—å§');
                return;
            }
            
            if (selectedSubjects.length === 0) {
                showToast('ğŸ“š è¯·é€‰æ‹©è¦å­¦ä¹ çš„ç§‘ç›®å“¦');
                return;
            }
            
            if (tasks.length === 0) {
                showToast('âœï¸ è¯·æ·»åŠ ä¸€äº›å­¦ä¹ ä»»åŠ¡å§');
                return;
            }
            
            isSubmitting = true;
            setSubmitButtonLoading(true);
            
            try {
                const planData = {
                    title: title,
                    description: document.getElementById('planDescription').value.trim(),
                    subjects: selectedSubjects,
                    priority: selectedPriority,
                    duration_days: parseInt(document.getElementById('planDays').value) || 7,
                    daily_time: parseInt(document.getElementById('dailyTime').value) || 30,
                    tasks: tasks,
                    estimated_time: tasks.reduce((total, task) => total + task.estimatedTime, 0)
                };
                
                const response = await fetch(`${API_BASE}/student/study-plan-create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    isPlanCreated = true; // æ ‡è®°è®¡åˆ’å·²åˆ›å»ºæˆåŠŸ
                    showToast('ğŸ‰ å­¦ä¹ è®¡åˆ’åˆ›å»ºæˆåŠŸï¼å³å°†è·³è½¬åˆ°å­¦ä¹ é¡µé¢...');
                    
                    // å»¶è¿Ÿè·³è½¬åˆ°å­¦ä¹ è®¡åˆ’é¡µé¢
                    setTimeout(() => {
                        window.location.href = '/frontend/study-plan.html';
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºå­¦ä¹ è®¡åˆ’å¤±è´¥:', error);
                showToast('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            } finally {
                isSubmitting = false;
                setSubmitButtonLoading(false);
            }
        }

        function setSubmitButtonLoading(loading) {
            const btn = document.getElementById('submitBtn');
            const text = document.getElementById('submitText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                btn.disabled = true;
                text.style.display = 'none';
                spinner.style.display = 'inline-block';
            } else {
                btn.disabled = false;
                text.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function saveDraft() {
            const draftData = {
                title: document.getElementById('planTitle').value,
                description: document.getElementById('planDescription').value,
                subjects: selectedSubjects,
                priority: selectedPriority,
                tasks: tasks,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('study_plan_draft', JSON.stringify(draftData));
            showToast('è‰ç¨¿å·²ä¿å­˜');
        }

        function loadDraft() {
            const draft = localStorage.getItem('study_plan_draft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    document.getElementById('planTitle').value = draftData.title || '';
                    document.getElementById('planDescription').value = draftData.description || '';
                    
                    // æ¢å¤å­¦ç§‘é€‰æ‹©
                    selectedSubjects = draftData.subjects || [];
                    document.querySelectorAll('.subject-item').forEach(item => {
                        const subject = item.dataset.subject;
                        if (selectedSubjects.includes(subject)) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                    });
                    
                    // æ¢å¤ä¼˜å…ˆçº§
                    setPriority(draftData.priority || 'medium');
                    
                    // æ¢å¤ä»»åŠ¡
                    tasks = draftData.tasks || [];
                    updateTasksList();
                    
                    showToast('å·²æ¢å¤è‰ç¨¿å†…å®¹');
                } catch (error) {
                    console.error('åŠ è½½è‰ç¨¿å¤±è´¥:', error);
                }
            }
        }

        function getSubjectName(subject) {
            const subjects = {
                'math': 'æ•°å­¦',
                'chinese': 'è¯­æ–‡',
                'english': 'è‹±è¯­',
                'physics': 'ç‰©ç†',
                'chemistry': 'åŒ–å­¦',
                'biology': 'ç”Ÿç‰©'
            };
            return subjects[subject] || subject;
        }

        function goBack() {
            // å¦‚æœè®¡åˆ’å·²åˆ›å»ºæˆåŠŸï¼Œç›´æ¥è¿”å›
            if (isPlanCreated) {
                window.location.href = '/frontend/study-plan.html';
                return;
            }
            
            const title = document.getElementById('planTitle').value.trim();
            const description = document.getElementById('planDescription').value.trim();
            
            // åªæœ‰å½“æœ‰å®é™…å†…å®¹è¾“å…¥æ—¶æ‰æç¤ºç¡®è®¤
            if (title || description || tasks.length > 0) {
                if (confirm('ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) {
                    window.location.href = '/frontend/study-plan.html';
                }
            } else {
                window.location.href = '/frontend/study-plan.html';
            }
        }

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, duration);
        }

        // é¡µé¢ç¦»å¼€å‰æ£€æŸ¥ - åªåœ¨æœªæˆåŠŸåˆ›å»ºè®¡åˆ’ä¸”æœ‰å†…å®¹å˜æ›´æ—¶æç¤º
        window.addEventListener('beforeunload', function(e) {
            // å¦‚æœè®¡åˆ’å·²åˆ›å»ºæˆåŠŸæˆ–æ­£åœ¨æäº¤ï¼Œä¸æ˜¾ç¤ºè­¦å‘Š
            if (isPlanCreated || isSubmitting) {
                return;
            }
            
            const title = document.getElementById('planTitle').value.trim();
            const description = document.getElementById('planDescription').value.trim();
            
            // åªæœ‰å½“æœ‰å®é™…å†…å®¹è¾“å…¥æ—¶æ‰æç¤º
            if (title || description || tasks.length > 0) {
                e.preventDefault();
                e.returnValue = 'ä½ æ‰€åšçš„æ›´æ”¹å¯èƒ½æœªä¿å­˜ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return 'ä½ æ‰€åšçš„æ›´æ”¹å¯èƒ½æœªä¿å­˜ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        });

        // è‡ªåŠ¨ä¿å­˜è‰ç¨¿
        setInterval(function() {
            const title = document.getElementById('planTitle').value.trim();
            if (title) {
                saveDraft();
            }
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
    </script>
</body>
</html>