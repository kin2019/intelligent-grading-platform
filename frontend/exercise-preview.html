<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È¢òÁõÆÈ¢ÑËßà - Êô∫ËÉΩÊïôËÇ≤Âπ≥Âè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-info h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .header-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #718096;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-completed {
            background: #c6f6d5;
            color: #2d7738;
        }

        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }

        .control-panel {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 25px;
        }

        .exercises-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            color: #718096;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .toggle-btn.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }

        .exercise-item {
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .exercise-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .exercise-number {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .exercise-type {
            color: #718096;
            font-size: 0.8rem;
            padding: 4px 8px;
            background: #f7fafc;
            border-radius: 4px;
        }

        .exercise-question {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .exercise-answer {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .exercise-answer.show {
            display: block;
        }

        .answer-label {
            font-size: 0.9rem;
            color: #2d7738;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .answer-content {
            font-size: 1rem;
            color: #2d3748;
        }

        .exercise-analysis {
            background: #f7fafc;
            border-left: 4px solid #4f46e5;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .exercise-analysis.show {
            display: block;
        }

        .analysis-label {
            font-size: 0.9rem;
            color: #4f46e5;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .analysis-content {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.5;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .action-grid {
            display: grid;
            gap: 10px;
        }

        .action-btn {
            justify-content: center;
            padding: 12px;
            font-size: 0.9rem;
        }

        .progress-info {
            background: linear-gradient(135deg, #ebf4ff, #dbeafe);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .progress-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            color: #1e40af;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4f46e5;
        }

        .loading-spinner::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .control-panel {
                justify-content: stretch;
            }

            .control-panel .btn {
                flex: 1;
                justify-content: center;
            }

            .content-area {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .exercises-panel {
                padding: 20px;
            }

            .exercise-item {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°µÈù¢Â§¥ÈÉ® -->
        <div class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1 id="exerciseTitle">Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆ‰ø°ÊÅØ...</h1>
                    <div class="header-meta">
                        <div class="meta-item">
                            <span>üìö</span>
                            <span id="exerciseSubject">-</span>
                        </div>
                        <div class="meta-item">
                            <span>üéì</span>
                            <span id="exerciseGrade">-</span>
                        </div>
                        <div class="meta-item">
                            <span>üìù</span>
                            <span id="exerciseCount">-</span> ÈÅìÈ¢ò
                        </div>
                        <div class="meta-item">
                            <span>‚è±Ô∏è</span>
                            <span id="exerciseTime">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="status-badge" id="exerciseStatus">Âä†ËΩΩ‰∏≠</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <button class="btn btn-secondary" onclick="goBack()">
                        ‚Üê ËøîÂõûÈÖçÁΩÆ
                    </button>
                    <button class="btn btn-primary" onclick="refreshExercises()" id="refreshBtn">
                        üîÑ Âà∑Êñ∞
                    </button>
                </div>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
        <div class="content-area">
            <!-- È¢òÁõÆÂàóË°®Èù¢Êùø -->
            <div class="exercises-panel">
                <div class="panel-header">
                    <h2 class="panel-title">üìã È¢òÁõÆÂàóË°®</h2>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="toggleAnswers()" id="answersToggle">
                            ÊòæÁ§∫Á≠îÊ°à
                        </button>
                        <button class="toggle-btn" onclick="toggleAnalysis()" id="analysisToggle">
                            ÊòæÁ§∫Ëß£Êûê
                        </button>
                    </div>
                </div>

                <div class="loading-spinner" id="loadingSpinner">
                    Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆ...
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div id="exercisesList">
                    <!-- È¢òÁõÆÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>üì≠ ÊöÇÊó†È¢òÁõÆ</h3>
                    <p>È¢òÁõÆËøòÂú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂÄôÂà∑Êñ∞È°µÈù¢</p>
                </div>
            </div>

            <!-- ‰æßËæπÊ†è -->
            <div class="sidebar">
                <!-- È¢òÁõÆÁªüËÆ° -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">üìä È¢òÁõÆÁªüËÆ°</h3>
                    <div class="progress-info">
                        <div class="progress-row">
                            <span>È¢òÁõÆÊÄªÊï∞:</span>
                            <span id="totalCount">0</span>
                        </div>
                        <div class="progress-row">
                            <span>ÁîüÊàêËÄóÊó∂:</span>
                            <span id="generationTime">-</span>
                        </div>
                        <div class="progress-row">
                            <span>ÈöæÂ∫¶Á≠âÁ∫ß:</span>
                            <span id="difficultyLevel">-</span>
                        </div>
                        <div class="progress-row">
                            <span>ÂÆåÊàêÂ∫¶:</span>
                            <span id="completionRate">100%</span>
                        </div>
                    </div>
                </div>

                <!-- Êìç‰ΩúÈù¢Êùø -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">üõ†Ô∏è Êìç‰ΩúÈù¢Êùø</h3>
                    <div class="action-grid">
                        <button class="btn btn-success action-btn" onclick="exportExercises('word')" id="exportWordBtn">
                            üìÑ ÂØºÂá∫Word
                        </button>
                        <button class="btn btn-success action-btn" onclick="exportExercises('pdf')" id="exportPdfBtn">
                            üìë ÂØºÂá∫PDF
                        </button>
                        <button class="btn btn-success action-btn" onclick="exportExercises('text')" id="exportTextBtn">
                            üìù ÂØºÂá∫ÊñáÊú¨
                        </button>
                        <button class="btn btn-primary action-btn" onclick="shareToWechat()" id="shareBtn">
                            üì± ÂæÆ‰ø°ÂàÜ‰∫´
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="viewHistory()">
                            üìö Êü•ÁúãÂéÜÂè≤
                        </button>
                    </div>
                </div>

                <!-- Âø´Êç∑Êìç‰Ωú -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">‚ö° Âø´Êç∑Êìç‰Ωú</h3>
                    <div class="action-grid">
                        <button class="btn btn-secondary action-btn" onclick="generateSimilar()">
                            üîÑ ÁîüÊàêÁ±ª‰ººÈ¢òÁõÆ
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="printExercises()">
                            üñ®Ô∏è ÊâìÂç∞È¢òÁõÆ
                        </button>
                    </div>
                </div>

                <!-- Ë¥®Èáè‰ºòÂåñ -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">üîß Ë¥®Èáè‰ºòÂåñ</h3>
                    <div class="action-grid">
                        <button class="btn btn-primary action-btn" onclick="showQualityReport()" title="Êü•ÁúãÈ¢òÁõÆË¥®ÈáèÂàÜÊûêÊä•Âëä (Ctrl+Q)">
                            üìä Ë¥®ÈáèÊä•Âëä
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="applyQualityOptimizations()" id="optimizeBtn">
                            ‚ú® ÈáçÊñ∞‰ºòÂåñ
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.8rem; color: #666; line-height: 1.4;">
                        <div>‚Ä¢ Ëá™Âä®ÂéªÈáçÊ£ÄÊµã</div>
                        <div>‚Ä¢ ÈöæÂ∫¶Êô∫ËÉΩËØÑ‰º∞</div>
                        <div>‚Ä¢ Êï∞Â≠¶ÂÖ¨ÂºèÊ∏≤Êüì</div>
                        <div>‚Ä¢ Âø´Êç∑ÈîÆ: Ctrl+Q</div>
                    </div>
                </div>

                <!-- ÊÄßËÉΩÁõëÊéß -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">‚ö° ÊÄßËÉΩÁõëÊéß</h3>
                    <div id="performanceMetrics" style="font-size: 0.8rem; line-height: 1.6;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>ÁºìÂ≠òÂëΩ‰∏≠Áéá:</span>
                            <span id="cacheEfficiency" style="font-weight: 600; color: #10b981;">ËÆ°ÁÆó‰∏≠...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>APIËØ∑Ê±ÇÊï∞:</span>
                            <span id="apiRequests" style="font-weight: 600; color: #3b82f6;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>ÂØºÂá∫‰ªªÂä°:</span>
                            <span id="exportTasks" style="font-weight: 600; color: #8b5cf6;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ÊâπÈáèËØ∑Ê±Ç:</span>
                            <span id="batchedRequests" style="font-weight: 600; color: #f59e0b;">0</span>
                        </div>
                    </div>
                    <div class="action-grid" style="margin-top: 12px;">
                        <button class="btn btn-secondary action-btn" onclick="showPerformanceReport()" title="Êü•ÁúãËØ¶ÁªÜÊÄßËÉΩÊä•Âëä (Ctrl+P)">
                            üìà ÊÄßËÉΩÊä•Âëä
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="clearPerformanceCache()" title="Ê∏ÖÁêÜÁºìÂ≠òÊï∞ÊçÆ">
                            üóëÔ∏è Ê∏ÖÁêÜÁºìÂ≠ò
                        </button>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.75rem; color: #999; text-align: center;">
                        <span>Ëá™Âä®Êõ¥Êñ∞ÊØè30Áßí</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂºïÂÖ•Ë¥®Èáè‰ºòÂåñÂ∑•ÂÖ∑ -->
    <script src="/frontend/js/exercise-quality-optimizer.js"></script>
    <!-- ÂºïÂÖ•ÊÄßËÉΩ‰ºòÂåñÂ∑•ÂÖ∑ -->
    <script src="/frontend/js/performance-optimizer.js"></script>

    <script>
        // APIÈÖçÁΩÆ
        const API_BASE = 'http://localhost:8000/api/v1';
        const authToken = localStorage.getItem('authToken') || 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzU3MTQ2Mjg0fQ.1FiO0fqJiioUF1UGzpJF6Qu2qoqNS_Lo0KRvLPMuff8';

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let currentGenerationId = null;
        let currentExercises = [];
        let showAnswers = false;
        let showAnalysis = false;
        let exportConfig = {};
        let qualityOptimizer = null; // Ë¥®Èáè‰ºòÂåñÂÆû‰æã

        // Ëé∑ÂèñURLÂèÇÊï∞
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // APIËØ∑Ê±ÇÂ∑•ÂÖ∑ÂáΩÊï∞
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
        function setLoading(loading) {
            const spinner = document.getElementById('loadingSpinner');
            const list = document.getElementById('exercisesList');
            const empty = document.getElementById('emptyState');

            if (loading) {
                spinner.style.display = 'block';
                list.style.display = 'none';
                empty.style.display = 'none';
            } else {
                spinner.style.display = 'none';
                list.style.display = 'block';
            }
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${seconds.toFixed(1)}Áßí`;
            return `${(seconds / 60).toFixed(1)}ÂàÜÈíü`;
        }

        // Âä†ËΩΩÁîüÊàêËÆ∞ÂΩï‰ø°ÊÅØ
        async function loadGenerationInfo() {
            try {
                const data = await apiRequest(`/exercise/generation/${currentGenerationId}`);
                
                // Êõ¥Êñ∞È°µÈù¢Â§¥ÈÉ®‰ø°ÊÅØ
                document.getElementById('exerciseTitle').textContent = data.title || 'ÁªÉ‰π†È¢ò';
                document.getElementById('exerciseSubject').textContent = data.subject || '-';
                document.getElementById('exerciseGrade').textContent = data.grade || '-';
                document.getElementById('exerciseCount').textContent = data.total_questions || 0;
                document.getElementById('exerciseTime').textContent = new Date(data.created_at).toLocaleString();
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÊ†áËØÜ
                const statusEl = document.getElementById('exerciseStatus');
                statusEl.textContent = data.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ÁîüÊàê‰∏≠';
                statusEl.className = `status-badge ${data.status === 'completed' ? 'status-completed' : 'status-pending'}`;

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                document.getElementById('totalCount').textContent = data.total_questions || 0;
                document.getElementById('generationTime').textContent = formatTime(data.generation_time);
                document.getElementById('difficultyLevel').textContent = data.difficulty_level || '-';

                return data;
            } catch (error) {
                showError('Âä†ËΩΩÈ¢òÁõÆ‰ø°ÊÅØÂ§±Ë¥•: ' + error.message);
                throw error;
            }
        }

        // Âä†ËΩΩÈ¢òÁõÆÂàóË°®
        async function loadExercises() {
            try {
                setLoading(true);
                const exercises = await apiRequest(`/exercise/generation/${currentGenerationId}/exercises`);
                
                currentExercises = exercises;
                renderExercises();
                
                if (exercises.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('exercisesList').style.display = 'none';
                }
            } catch (error) {
                showError('Âä†ËΩΩÈ¢òÁõÆÂàóË°®Â§±Ë¥•: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // Ê∏≤ÊüìÈ¢òÁõÆÂàóË°®
        function renderExercises() {
            const container = document.getElementById('exercisesList');
            
            if (currentExercises.length === 0) {
                container.innerHTML = '';
                return;
            }

            const html = currentExercises.map(exercise => {
                // ËÆ°ÁÆóÈ¢òÁõÆÈöæÂ∫¶‰ø°ÊÅØ
                const difficultyInfo = qualityOptimizer ? qualityOptimizer.evaluateDifficulty(exercise) : null;
                const difficultyBadge = difficultyInfo ? 
                    `<span class="difficulty-badge" style="background: ${difficultyInfo.difficulty_level.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                        ${difficultyInfo.difficulty_level.name} ¬∑ ${difficultyInfo.estimated_time}ÂàÜÈíü
                    </span>` : '';

                return `
                <div class="exercise-item" data-exercise-id="${exercise.id || exercise.number}">
                    <div class="exercise-header">
                        <div class="exercise-number">È¢òÁõÆ ${exercise.number}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="exercise-type">${exercise.question_type || 'ÁªÉ‰π†È¢ò'}</div>
                            ${difficultyBadge}
                        </div>
                    </div>
                    
                    <div class="exercise-question math-content">
                        ${exercise.question_text || 'È¢òÁõÆÂÜÖÂÆπÂä†ËΩΩ‰∏≠...'}
                    </div>

                    <div class="exercise-answer ${showAnswers ? 'show' : ''}">
                        <div class="answer-label">üí° Ê†áÂáÜÁ≠îÊ°à</div>
                        <div class="answer-content math-content">${exercise.correct_answer || 'ÊöÇÊó†Á≠îÊ°à'}</div>
                    </div>

                    <div class="exercise-analysis ${showAnalysis ? 'show' : ''}">
                        <div class="analysis-label">üìñ Ëß£È¢òÂàÜÊûê</div>
                        <div class="analysis-content math-content">${exercise.analysis || 'ÊöÇÊó†ÂàÜÊûê'}</div>
                    </div>

                    ${difficultyInfo ? `
                    <div class="quality-info" style="background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem;">
                        <strong>ÈöæÂ∫¶ÂàÜÊûê:</strong> 
                        ÂÖ¨ÂºèÂ§çÊùÇÂ∫¶ ${(difficultyInfo.difficulty_factors.formula * 100).toFixed(0)}%, 
                        Ê≠•È™§Â§çÊùÇÂ∫¶ ${(difficultyInfo.difficulty_factors.steps * 100).toFixed(0)}%, 
                        Ê¶ÇÂøµÂ§çÊùÇÂ∫¶ ${(difficultyInfo.difficulty_factors.concepts * 100).toFixed(0)}%
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ÂàáÊç¢Á≠îÊ°àÊòæÁ§∫
        function toggleAnswers() {
            showAnswers = !showAnswers;
            const toggle = document.getElementById('answersToggle');
            toggle.textContent = showAnswers ? 'ÈöêËóèÁ≠îÊ°à' : 'ÊòæÁ§∫Á≠îÊ°à';
            toggle.classList.toggle('active', showAnswers);
            
            document.querySelectorAll('.exercise-answer').forEach(el => {
                el.classList.toggle('show', showAnswers);
            });
        }

        // ÂàáÊç¢Ëß£ÊûêÊòæÁ§∫
        function toggleAnalysis() {
            showAnalysis = !showAnalysis;
            const toggle = document.getElementById('analysisToggle');
            toggle.textContent = showAnalysis ? 'ÈöêËóèËß£Êûê' : 'ÊòæÁ§∫Ëß£Êûê';
            toggle.classList.toggle('active', showAnalysis);
            
            document.querySelectorAll('.exercise-analysis').forEach(el => {
                el.classList.toggle('show', showAnalysis);
            });
        }

        // Âà∑Êñ∞È¢òÁõÆ
        async function refreshExercises() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'Âà∑Êñ∞‰∏≠...';

            try {
                await Promise.all([
                    loadGenerationInfo(),
                    loadExercises()
                ]);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Âà∑Êñ∞';
            }
        }

        // ‰ºòÂåñÁöÑÂºÇÊ≠•ÂØºÂá∫ÂäüËÉΩ
        async function exportExercises(format) {
            const btn = document.getElementById(`export${format.charAt(0).toUpperCase() + format.slice(1)}Btn`);
            const originalText = btn.textContent;
            
            try {
                console.log(`üì§ ÂºÄÂßãÂºÇÊ≠•ÂØºÂá∫: ${format}`);
                
                // ÂàõÂª∫ÂØºÂá∫ËøõÂ∫¶ÊòæÁ§∫
                const progressContainer = createExportProgressUI(format);
                document.body.appendChild(progressContainer);
                
                const config = {
                    format: format,
                    include_answers: true,
                    include_analysis: true,
                    ...exportConfig
                };

                // ‰ΩøÁî®ÊÄßËÉΩ‰ºòÂåñÂô®ÁöÑÂºÇÊ≠•ÂØºÂá∫
                const result = await window.performanceOptimizer.exportFile(
                    currentGenerationId, 
                    format, 
                    config,
                    (progress, message) => {
                        updateExportProgressUI(format, progress, message);
                        btn.textContent = `${message} (${progress}%)`;
                    }
                );

                if (result.success) {
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const link = document.createElement('a');
                    link.href = result.downloadUrl;
                    link.download = result.fileName;
                    link.click();
                    
                    const cacheInfo = result.fromCache ? ' (‰ΩøÁî®ÁºìÂ≠òÊñá‰ª∂)' : '';
                    showExportSuccess(`ÂØºÂá∫ÂÆåÊàêÔºÅÊñá‰ª∂: ${result.fileName}${cacheInfo}`);
                    
                    // ËÆ∞ÂΩïÊÄßËÉΩÁªüËÆ°
                    const metrics = window.performanceOptimizer.getPerformanceMetrics();
                    console.log('üìä ÂØºÂá∫ÂêéÊÄßËÉΩÁªüËÆ°:', metrics);
                } else {
                    throw new Error('ÂØºÂá∫Â§±Ë¥•');
                }
            } catch (error) {
                console.error('‚ùå ÂºÇÊ≠•ÂØºÂá∫Â§±Ë¥•:', error);
                showError('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                
                // Âª∂ËøüÁßªÈô§ËøõÂ∫¶ÊòæÁ§∫
                setTimeout(() => {
                    const progressEl = document.getElementById(`export-progress-${format}`);
                    if (progressEl) {
                        progressEl.remove();
                    }
                }, 3000);
            }
        }
        
        // ÂàõÂª∫ÂØºÂá∫ËøõÂ∫¶UI
        function createExportProgressUI(format) {
            const container = document.createElement('div');
            container.id = `export-progress-${format}`;
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                min-width: 300px;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 20px; margin-right: 8px;">üì§</div>
                    <div style="font-weight: 600; color: #333;">ÂØºÂá∫ ${format.toUpperCase()}</div>
                </div>
                <div id="progress-bar-${format}" style="
                    width: 100%;
                    height: 6px;
                    background: #f0f0f0;
                    border-radius: 3px;
                    overflow: hidden;
                    margin-bottom: 8px;
                ">
                    <div id="progress-fill-${format}" style="
                        width: 0%;
                        height: 100%;
                        background: linear-gradient(90deg, #4f46e5, #7c3aed);
                        transition: width 0.3s ease;
                    "></div>
                </div>
                <div id="progress-text-${format}" style="
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                ">ÂáÜÂ§áÂØºÂá∫...</div>
            `;
            
            return container;
        }
        
        // Êõ¥Êñ∞ÂØºÂá∫ËøõÂ∫¶UI
        function updateExportProgressUI(format, progress, message) {
            const progressFill = document.getElementById(`progress-fill-${format}`);
            const progressText = document.getElementById(`progress-text-${format}`);
            
            if (progressFill) {
                progressFill.style.width = `${Math.max(0, progress)}%`;
            }
            
            if (progressText) {
                progressText.textContent = message;
                
                // Ê†πÊçÆËøõÂ∫¶ÊîπÂèòÈ¢úËâ≤
                if (progress === 100) {
                    progressText.style.color = '#10b981';
                    progressText.style.fontWeight = '600';
                } else if (progress < 0) {
                    progressText.style.color = '#ef4444';
                    progressText.style.fontWeight = '600';
                } else {
                    progressText.style.color = '#666';
                }
            }
        }
        
        // ÊòæÁ§∫ÂØºÂá∫ÊàêÂäüÊ∂àÊÅØ
        function showExportSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
                font-size: 14px;
                font-weight: 500;
                z-index: 10001;
                max-width: 400px;
                text-align: center;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // ÂæÆ‰ø°ÂàÜ‰∫´
        async function shareToWechat() {
            const btn = document.getElementById('shareBtn');
            btn.disabled = true;
            btn.textContent = 'ÂáÜÂ§á‰∏≠...';

            try {
                const config = {
                    include_answers: false,
                    include_analysis: false,
                    max_questions: 5
                };

                const result = await apiRequest(`/exercise/generation/${currentGenerationId}/share/wechat`, {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                // ÊòæÁ§∫ÂàÜ‰∫´ÂÜÖÂÆπ
                const shareWindow = window.open('', '_blank', 'width=600,height=400');
                shareWindow.document.write(`
                    <html>
                    <head><title>ÂæÆ‰ø°ÂàÜ‰∫´ÂÜÖÂÆπ</title></head>
                    <body style="font-family: sans-serif; padding: 20px;">
                        <h3>üì± ÂæÆ‰ø°ÂàÜ‰∫´ÂÜÖÂÆπ</h3>
                        <textarea readonly style="width: 100%; height: 300px; font-family: monospace;">${result.content}</textarea>
                        <p><strong>ÂàÜ‰∫´ÈìæÊé•:</strong> ${result.share_link || 'ÊöÇÊó†'}</p>
                        <p><small>ËØ∑Â§çÂà∂‰∏äÈù¢ÁöÑÂÜÖÂÆπÂà∞ÂæÆ‰ø°ÂàÜ‰∫´</small></p>
                    </body>
                    </html>
                `);

            } catch (error) {
                showError('ÂàÜ‰∫´ÂáÜÂ§áÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì± ÂæÆ‰ø°ÂàÜ‰∫´';
            }
        }

        // ÁîüÊàêÁ±ª‰ººÈ¢òÁõÆ
        function generateSimilar() {
            const url = `exercise-config.html?similar=${currentGenerationId}`;
            window.location.href = url;
        }

        // ÊâìÂç∞È¢òÁõÆ
        function printExercises() {
            window.print();
        }

        // Êü•ÁúãÂéÜÂè≤
        function viewHistory() {
            window.location.href = 'exercise-history.html';
        }

        // ËøîÂõûÈÖçÁΩÆÈ°µÈù¢
        function goBack() {
            window.location.href = 'exercise-config.html';
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            // ÂàùÂßãÂåñË¥®Èáè‰ºòÂåñÂô®
            qualityOptimizer = new ExerciseQualityOptimizer();
            
            // Ëé∑ÂèñÁîüÊàêID
            currentGenerationId = getUrlParameter('id') || sessionStorage.getItem('lastGenerationId');
            
            if (!currentGenerationId) {
                showError('Êú™ÊâæÂà∞È¢òÁõÆÁîüÊàêËÆ∞ÂΩïÔºåÂç≥Â∞ÜËøîÂõûÈÖçÁΩÆÈ°µÈù¢...');
                setTimeout(() => {
                    window.location.href = 'exercise-config.html';
                }, 3000);
                return;
            }

            // Âä†ËΩΩÂØºÂá∫ÈÖçÁΩÆ
            try {
                exportConfig = JSON.parse(sessionStorage.getItem('exportConfig') || '{}');
            } catch (e) {
                exportConfig = {};
            }

            // Âä†ËΩΩÈ°µÈù¢Êï∞ÊçÆ
            try {
                await Promise.all([
                    loadGenerationInfo(),
                    loadExercises()
                ]);
                console.log('È¢òÁõÆÈ¢ÑËßàÈ°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
                
                // Â∫îÁî®Ë¥®Èáè‰ºòÂåñ
                await applyQualityOptimizations();
            } catch (error) {
                console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        });

        // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'a':
                        e.preventDefault();
                        toggleAnswers();
                        break;
                    case 's':
                        e.preventDefault();
                        toggleAnalysis();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshExercises();
                        break;
                    case 'q':
                        e.preventDefault();
                        showQualityReport();
                        break;
                    case 'p':
                        e.preventDefault();
                        showPerformanceReport();
                        break;
                }
            }
        });

        /**
         * Ê≠•È™§8.1Ë¥®Èáè‰ºòÂåñÂäüËÉΩÂÆûÁé∞
         */

        // Â∫îÁî®Ë¥®Èáè‰ºòÂåñ
        async function applyQualityOptimizations() {
            if (!qualityOptimizer || currentExercises.length === 0) {
                return;
            }

            console.log('üîß ÂºÄÂßãÂ∫îÁî®È¢òÁõÆË¥®Èáè‰ºòÂåñ...');

            try {
                // 1. È¢òÁõÆÂéªÈáçÂ§ÑÁêÜ
                const deduplicationResult = qualityOptimizer.removeDuplicates(currentExercises);
                
                if (deduplicationResult.removed_count > 0) {
                    console.log(`‚úÖ ÂéªÈáçÂÆåÊàêÔºåÁßªÈô§ ${deduplicationResult.removed_count} ÈÅìÈáçÂ§çÈ¢òÁõÆ`);
                    currentExercises = deduplicationResult.unique_exercises;
                    
                    // ÊòæÁ§∫ÂéªÈáçÈÄöÁü•
                    showOptimizationNotice(`Â∑≤Ëá™Âä®ÂéªÈô§ ${deduplicationResult.removed_count} ÈÅìÈáçÂ§çÈ¢òÁõÆ`, 'success');
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÈ¢òÁõÆÂàóË°®
                    renderExercises();
                    
                    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                    document.getElementById('totalCount').textContent = currentExercises.length;
                }

                // 2. ‰ºòÂåñÊï∞Â≠¶ÂÖ¨ÂºèÊòæÁ§∫
                setTimeout(() => {
                    const exercisesList = document.getElementById('exercisesList');
                    if (exercisesList) {
                        qualityOptimizer.optimizeMathDisplay(exercisesList);
                        console.log('‚úÖ Êï∞Â≠¶ÂÖ¨ÂºèÊòæÁ§∫‰ºòÂåñÂÆåÊàê');
                    }
                }, 500);

                // 3. ÁîüÊàêË¥®ÈáèÊä•Âëä
                const qualityReport = qualityOptimizer.generateQualityReport(currentExercises);
                sessionStorage.setItem('lastQualityReport', JSON.stringify(qualityReport));
                console.log('‚úÖ Ë¥®ÈáèÊä•ÂëäÁîüÊàêÂÆåÊàê:', qualityReport);

                // 4. Êõ¥Êñ∞ÈöæÂ∫¶ÁªüËÆ°
                updateDifficultyStatistics();

                console.log('üéâ ÊâÄÊúâË¥®Èáè‰ºòÂåñÂ∫îÁî®ÂÆåÊàê');

            } catch (error) {
                console.error('‚ùå Ë¥®Èáè‰ºòÂåñÂ∫îÁî®Â§±Ë¥•:', error);
                showOptimizationNotice('Ë¥®Èáè‰ºòÂåñÂ∫îÁî®Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // Êõ¥Êñ∞ÈöæÂ∫¶ÁªüËÆ°‰ø°ÊÅØ
        function updateDifficultyStatistics() {
            if (!qualityOptimizer || currentExercises.length === 0) return;

            const difficulties = currentExercises.map(ex => qualityOptimizer.evaluateDifficulty(ex));
            const avgDifficulty = difficulties.reduce((sum, d) => sum + d.overall_difficulty, 0) / difficulties.length;
            const avgTime = difficulties.reduce((sum, d) => sum + d.estimated_time, 0) / difficulties.length;

            // Êõ¥Êñ∞ÈöæÂ∫¶Á≠âÁ∫ßÊòæÁ§∫
            const difficultyLevel = qualityOptimizer.getDifficultyLevel(avgDifficulty);
            const difficultyEl = document.getElementById('difficultyLevel');
            if (difficultyEl) {
                difficultyEl.innerHTML = `
                    <span style="color: ${difficultyLevel.color}; font-weight: bold;">
                        ${difficultyLevel.name} (${(avgDifficulty * 100).toFixed(0)}%)
                    </span>
                `;
            }

            // Êõ¥Êñ∞È¢Ñ‰º∞Êó∂Èó¥
            const completionRateEl = document.getElementById('completionRate');
            if (completionRateEl) {
                completionRateEl.textContent = `È¢ÑËÆ° ${Math.round(avgTime)} ÂàÜÈíü`;
            }
        }

        // ÊòæÁ§∫Ë¥®ÈáèÊä•Âëä
        function showQualityReport() {
            const report = sessionStorage.getItem('lastQualityReport');
            if (!report) {
                alert('ÊöÇÊó†Ë¥®ÈáèÊä•ÂëäÊï∞ÊçÆÔºåËØ∑ÂÖàÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞ÁîüÊàê');
                return;
            }

            const qualityData = JSON.parse(report);
            
            const reportWindow = window.open('', '_blank', 'width=800,height=600');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>È¢òÁõÆË¥®ÈáèÊä•Âëä</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; }
                        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
                        .metric { display: flex; justify-content: space-between; margin-bottom: 8px; }
                        .metric-label { font-weight: 500; }
                        .metric-value { font-weight: bold; color: #667eea; }
                        .recommendations { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; }
                        .recommendation { margin-bottom: 5px; }
                        .difficulty-chart { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
                        .difficulty-item { text-align: center; padding: 10px; border-radius: 6px; }
                        .easy { background: #d4edda; color: #155724; }
                        .medium { background: #fff3cd; color: #856404; }
                        .hard { background: #f8d7da; color: #721c24; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>üìä È¢òÁõÆË¥®ÈáèÂàÜÊûêÊä•Âëä</h2>
                        <p>ÁîüÊàêÊó∂Èó¥: ${new Date(qualityData.timestamp).toLocaleString()}</p>
                    </div>

                    <div class="section">
                        <h3>üìà Âü∫Êú¨ÁªüËÆ°</h3>
                        <div class="metric">
                            <span class="metric-label">È¢òÁõÆÊÄªÊï∞:</span>
                            <span class="metric-value">${qualityData.total_exercises}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ÂéªÈáçÁßªÈô§:</span>
                            <span class="metric-value">${qualityData.quality_metrics.duplicates.removed_count}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Êï∞Â≠¶ÂÖ¨Âºè:</span>
                            <span class="metric-value">${qualityData.quality_metrics.math_formulas}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìä ÈöæÂ∫¶ÂàÜÂ∏É</h3>
                        <div class="difficulty-chart">
                            <div class="difficulty-item easy">
                                <div>ÁÆÄÂçï</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'easy').length}</div>
                            </div>
                            <div class="difficulty-item medium">
                                <div>‰∏≠Á≠â</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'medium').length}</div>
                            </div>
                            <div class="difficulty-item hard">
                                <div>Âõ∞Èöæ</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'hard').length}</div>
                            </div>
                        </div>
                    </div>

                    <div class="recommendations">
                        <h3>üí° ‰ºòÂåñÂª∫ËÆÆ</h3>
                        ${qualityData.recommendations.map(rec => `<div class="recommendation">‚Ä¢ ${rec}</div>`).join('')}
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üñ®Ô∏è ÊâìÂç∞Êä•Âëä
                        </button>
                    </div>
                </body>
                </html>
            `);
        }

        // ÊòæÁ§∫‰ºòÂåñÈÄöÁü•
        function showOptimizationNotice(message, type = 'info') {
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;

            const colors = {
                success: { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
                error: { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
                info: { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
            };

            const color = colors[type] || colors.info;
            notice.style.background = color.bg;
            notice.style.color = color.color;
            notice.style.border = `1px solid ${color.border}`;
            notice.textContent = message;

            document.body.appendChild(notice);

            setTimeout(() => {
                notice.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notice)) {
                        document.body.removeChild(notice);
                    }
                }, 300);
            }, 4000);
        }

        // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .math-content {
                font-family: "Times New Roman", serif;
            }
            
            .difficulty-badge {
                animation: fadeIn 0.5s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.8); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(animationStyles);

        /**
         * Ê≠•È™§8.2ÊÄßËÉΩ‰ºòÂåñÂäüËÉΩÂÆûÁé∞
         */

        // Êõ¥Êñ∞ÊÄßËÉΩÁõëÊéßÊòæÁ§∫
        function updatePerformanceMetrics() {
            if (!window.performanceOptimizer) return;

            try {
                const metrics = window.performanceOptimizer.getPerformanceMetrics();
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                const cacheEfficiencyEl = document.getElementById('cacheEfficiency');
                const apiRequestsEl = document.getElementById('apiRequests');
                const exportTasksEl = document.getElementById('exportTasks');
                const batchedRequestsEl = document.getElementById('batchedRequests');

                if (cacheEfficiencyEl) {
                    cacheEfficiencyEl.textContent = metrics.cacheEfficiency;
                    // Ê†πÊçÆÊïàÁéáË∞ÉÊï¥È¢úËâ≤
                    const efficiency = parseFloat(metrics.cacheEfficiency);
                    if (efficiency >= 70) {
                        cacheEfficiencyEl.style.color = '#10b981'; // ÁªøËâ≤
                    } else if (efficiency >= 40) {
                        cacheEfficiencyEl.style.color = '#f59e0b'; // Ê©ôËâ≤
                    } else {
                        cacheEfficiencyEl.style.color = '#ef4444'; // Á∫¢Ëâ≤
                    }
                }

                if (apiRequestsEl) {
                    apiRequestsEl.textContent = metrics.apiRequests;
                }

                if (exportTasksEl) {
                    exportTasksEl.textContent = `${metrics.exportTasks} (${metrics.activeExportTasks} Ê¥ªË∑É)`;
                }

                if (batchedRequestsEl) {
                    batchedRequestsEl.textContent = metrics.batchedRequests;
                }

                console.log('üìä ÊÄßËÉΩÊåáÊ†áÂ∑≤Êõ¥Êñ∞:', metrics);
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊÄßËÉΩÊåáÊ†áÂ§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫ËØ¶ÁªÜÊÄßËÉΩÊä•Âëä
        function showPerformanceReport() {
            if (!window.performanceOptimizer) {
                alert('ÊÄßËÉΩ‰ºòÂåñÂô®Êú™Âä†ËΩΩ');
                return;
            }

            const metrics = window.performanceOptimizer.getPerformanceMetrics();
            
            const reportWindow = window.open('', '_blank', 'width=800,height=600');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>ÊÄßËÉΩÁõëÊéßÊä•Âëä</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; background: #f8f9fa; }
                        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .metric { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; border-radius: 4px; }
                        .metric-label { font-weight: 500; }
                        .metric-value { font-weight: bold; }
                        .high-performance { background: #d4edda; color: #155724; }
                        .medium-performance { background: #fff3cd; color: #856404; }
                        .low-performance { background: #f8d7da; color: #721c24; }
                        .recommendations { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; }
                        .chart { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                        .chart-item { text-align: center; padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
                        .chart-value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
                        .chart-label { font-size: 0.9rem; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>‚ö° ÊÄßËÉΩÁõëÊéßÊä•Âëä</h2>
                        <p>ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString()}</p>
                    </div>

                    <div class="chart">
                        <div class="chart-item">
                            <div class="chart-value" style="color: #10b981;">${metrics.cacheEfficiency}</div>
                            <div class="chart-label">ÁºìÂ≠òÂëΩ‰∏≠Áéá</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #3b82f6;">${metrics.apiRequests}</div>
                            <div class="chart-label">APIËØ∑Ê±ÇÊÄªÊï∞</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #8b5cf6;">${metrics.exportTasks}</div>
                            <div class="chart-label">ÂØºÂá∫‰ªªÂä°</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #f59e0b;">${metrics.batchedRequests}</div>
                            <div class="chart-label">ÊâπÈáèËØ∑Ê±Ç</div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìä ËØ¶ÁªÜÊÄßËÉΩÊåáÊ†á</h3>
                        <div class="metric ${parseFloat(metrics.cacheEfficiency) >= 70 ? 'high-performance' : parseFloat(metrics.cacheEfficiency) >= 40 ? 'medium-performance' : 'low-performance'}">
                            <span class="metric-label">ÁºìÂ≠òÊïàÁéá:</span>
                            <span class="metric-value">${metrics.cacheEfficiency}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ÁºìÂ≠òÂëΩ‰∏≠Ê¨°Êï∞:</span>
                            <span class="metric-value">${metrics.cacheHits}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ÁºìÂ≠òÊú™ÂëΩ‰∏≠Ê¨°Êï∞:</span>
                            <span class="metric-value">${metrics.cacheMisses}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ÊÄªÁºìÂ≠òÊìç‰Ωú:</span>
                            <span class="metric-value">${metrics.totalCacheOperations}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Ê¥ªË∑ÉÂØºÂá∫‰ªªÂä°:</span>
                            <span class="metric-value">${metrics.activeExportTasks}</span>
                        </div>
                    </div>

                    <div class="recommendations">
                        <h3>üí° ÊÄßËÉΩ‰ºòÂåñÂª∫ËÆÆ</h3>
                        ${generatePerformanceRecommendations(metrics)}
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üñ®Ô∏è ÊâìÂç∞Êä•Âëä
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            ÂÖ≥Èó≠Á™óÂè£
                        </button>
                    </div>
                </body>
                </html>
            `);
        }

        // ÁîüÊàêÊÄßËÉΩ‰ºòÂåñÂª∫ËÆÆ
        function generatePerformanceRecommendations(metrics) {
            const recommendations = [];
            const cacheEfficiency = parseFloat(metrics.cacheEfficiency);

            if (cacheEfficiency < 30) {
                recommendations.push('‚Ä¢ ÁºìÂ≠òÂëΩ‰∏≠ÁéáËæÉ‰ΩéÔºåÂª∫ËÆÆÊ£ÄÊü•ÁºìÂ≠òÁ≠ñÁï•ÂíåËøáÊúüÊó∂Èó¥ËÆæÁΩÆ');
            } else if (cacheEfficiency >= 80) {
                recommendations.push('‚Ä¢ ÁºìÂ≠òÂëΩ‰∏≠Áéá‰ºòÁßÄÔºåÁ≥ªÁªüÊÄßËÉΩË°®Áé∞ËâØÂ•Ω');
            }

            if (metrics.apiRequests > 50) {
                recommendations.push('‚Ä¢ APIËØ∑Ê±ÇËæÉÂ§öÔºåÂª∫ËÆÆ‰ΩøÁî®ÊâπÈáèËØ∑Ê±Ç‰ºòÂåñ');
            }

            if (metrics.activeExportTasks > 3) {
                recommendations.push('‚Ä¢ Ê¥ªË∑ÉÂØºÂá∫‰ªªÂä°ËøáÂ§öÔºåÂª∫ËÆÆÂÆûÊñΩ‰ªªÂä°ÈòüÂàóÁÆ°ÁêÜ');
            }

            if (metrics.batchedRequests === 0) {
                recommendations.push('‚Ä¢ Êú™‰ΩøÁî®ÊâπÈáèËØ∑Ê±ÇÔºåÂª∫ËÆÆÂêØÁî®ÊâπÈáèAPIË∞ÉÁî®‰ª•ÊèêÂçáÊÄßËÉΩ');
            }

            if (recommendations.length === 0) {
                recommendations.push('‚Ä¢ Á≥ªÁªüÊÄßËÉΩË°®Áé∞ËâØÂ•ΩÔºåÊó†ÈúÄÁâπÊÆä‰ºòÂåñ');
            }

            return recommendations.map(rec => `<div style="margin-bottom: 5px;">${rec}</div>`).join('');
        }

        // Ê∏ÖÁêÜÊÄßËÉΩÁºìÂ≠ò
        function clearPerformanceCache() {
            if (!window.performanceOptimizer) {
                alert('ÊÄßËÉΩ‰ºòÂåñÂô®Êú™Âä†ËΩΩ');
                return;
            }

            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÁºìÂ≠òÊï∞ÊçÆÂêóÔºüËøôÂ∞ÜÂΩ±ÂìçÂä†ËΩΩÈÄüÂ∫¶Ôºå‰ΩÜÂèØ‰ª•ÈáäÊîæÂ≠òÂÇ®Á©∫Èó¥„ÄÇ')) {
                try {
                    window.performanceOptimizer.clearExpiredCache();
                    window.performanceOptimizer.clearMetrics();
                    
                    // Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑÁºìÂ≠ò
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('cache_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    updatePerformanceMetrics();
                    showOptimizationNotice('ÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜÔºå‰∏ãÊ¨°Âä†ËΩΩÂèØËÉΩ‰ºöËæÉÊÖ¢', 'info');
                } catch (error) {
                    console.error('Ê∏ÖÁêÜÁºìÂ≠òÂ§±Ë¥•:', error);
                    showOptimizationNotice('Ê∏ÖÁêÜÁºìÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
                }
            }
        }

        // ÂêØÂä®ÊÄßËÉΩÁõëÊéß
        function startPerformanceMonitoring() {
            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updatePerformanceMetrics();
            
            // ÊØè30ÁßíËá™Âä®Êõ¥Êñ∞
            setInterval(updatePerformanceMetrics, 30000);
            
            console.log('‚ö° ÊÄßËÉΩÁõëÊéßÂ∑≤ÂêØÂä®ÔºåÊØè30ÁßíËá™Âä®Êõ¥Êñ∞');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®ÊÄßËÉΩÁõëÊéß
        window.addEventListener('load', () => {
            setTimeout(startPerformanceMonitoring, 2000); // Âª∂Ëøü2ÁßíÂêØÂä®ÔºåÁ°Æ‰øùÂÖ∂‰ªñÂàùÂßãÂåñÂÆåÊàê
        });

    </script>
</body>
</html>