<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜ç›®é¢„è§ˆ - æ™ºèƒ½æ•™è‚²å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-info h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .header-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #718096;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-completed {
            background: #c6f6d5;
            color: #2d7738;
        }

        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }

        .control-panel {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 25px;
        }

        .exercises-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            color: #718096;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .toggle-btn.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }

        .exercise-item {
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .exercise-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .exercise-number {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .exercise-type {
            color: #718096;
            font-size: 0.8rem;
            padding: 4px 8px;
            background: #f7fafc;
            border-radius: 4px;
        }

        .exercise-question {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .exercise-answer {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .exercise-answer.show {
            display: block;
        }

        .answer-label {
            font-size: 0.9rem;
            color: #2d7738;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .answer-content {
            font-size: 1rem;
            color: #2d3748;
        }

        .exercise-analysis {
            background: #f7fafc;
            border-left: 4px solid #4f46e5;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .exercise-analysis.show {
            display: block;
        }

        .analysis-label {
            font-size: 0.9rem;
            color: #4f46e5;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .analysis-content {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.5;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .action-grid {
            display: grid;
            gap: 10px;
        }

        .action-btn {
            justify-content: center;
            padding: 12px;
            font-size: 0.9rem;
        }

        .progress-info {
            background: linear-gradient(135deg, #ebf4ff, #dbeafe);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .progress-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            color: #1e40af;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4f46e5;
        }

        .loading-spinner::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .control-panel {
                justify-content: stretch;
            }

            .control-panel .btn {
                flex: 1;
                justify-content: center;
            }

            .content-area {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .exercises-panel {
                padding: 20px;
            }

            .exercise-item {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1 id="exerciseTitle">æ­£åœ¨åŠ è½½é¢˜ç›®ä¿¡æ¯...</h1>
                    <div class="header-meta">
                        <div class="meta-item">
                            <span>ğŸ“š</span>
                            <span id="exerciseSubject">-</span>
                        </div>
                        <div class="meta-item">
                            <span>ğŸ“</span>
                            <span id="exerciseGrade">-</span>
                        </div>
                        <div class="meta-item">
                            <span>ğŸ“</span>
                            <span id="exerciseCount">-</span> é“é¢˜
                        </div>
                        <div class="meta-item">
                            <span>â±ï¸</span>
                            <span id="exerciseTime">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="status-badge" id="exerciseStatus">åŠ è½½ä¸­</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <button class="btn btn-secondary" onclick="goBack()">
                        â† è¿”å›é…ç½®
                    </button>
                    <button class="btn btn-primary" onclick="refreshExercises()" id="refreshBtn">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <!-- é¢˜ç›®åˆ—è¡¨é¢æ¿ -->
            <div class="exercises-panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ“‹ é¢˜ç›®åˆ—è¡¨</h2>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="toggleAnswers()" id="answersToggle">
                            æ˜¾ç¤ºç­”æ¡ˆ
                        </button>
                        <button class="toggle-btn" onclick="toggleAnalysis()" id="analysisToggle">
                            æ˜¾ç¤ºè§£æ
                        </button>
                    </div>
                </div>

                <div class="loading-spinner" id="loadingSpinner">
                    æ­£åœ¨åŠ è½½é¢˜ç›®...
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div id="exercisesList">
                    <!-- é¢˜ç›®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>ğŸ“­ æš‚æ— é¢˜ç›®</h3>
                    <p>é¢˜ç›®è¿˜åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™åˆ·æ–°é¡µé¢</p>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <!-- é¢˜ç›®ç»Ÿè®¡ -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">ğŸ“Š é¢˜ç›®ç»Ÿè®¡</h3>
                    <div class="progress-info">
                        <div class="progress-row">
                            <span>é¢˜ç›®æ€»æ•°:</span>
                            <span id="totalCount">0</span>
                        </div>
                        <div class="progress-row">
                            <span>ç”Ÿæˆè€—æ—¶:</span>
                            <span id="generationTime">-</span>
                        </div>
                        <div class="progress-row">
                            <span>éš¾åº¦ç­‰çº§:</span>
                            <span id="difficultyLevel">-</span>
                        </div>
                        <div class="progress-row">
                            <span>å®Œæˆåº¦:</span>
                            <span id="completionRate">100%</span>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œé¢æ¿ -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">ğŸ› ï¸ æ“ä½œé¢æ¿</h3>
                    <div class="action-grid">
                        <button class="btn btn-success action-btn" onclick="exportExercises('word')" id="exportWordBtn">
                            ğŸ“„ å¯¼å‡ºWord
                        </button>
                        <button class="btn btn-success action-btn" onclick="exportExercises('pdf')" id="exportPdfBtn">
                            ğŸ“‘ å¯¼å‡ºPDF
                        </button>
                        <button class="btn btn-success action-btn" onclick="exportExercises('text')" id="exportTextBtn">
                            ğŸ“ å¯¼å‡ºæ–‡æœ¬
                        </button>
                        <button class="btn btn-primary action-btn" onclick="shareToWechat()" id="shareBtn">
                            ğŸ“± å¾®ä¿¡åˆ†äº«
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="viewHistory()">
                            ğŸ“š æŸ¥çœ‹å†å²
                        </button>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">âš¡ å¿«æ·æ“ä½œ</h3>
                    <div class="action-grid">
                        <button class="btn btn-secondary action-btn" onclick="generateSimilar()">
                            ğŸ”„ ç”Ÿæˆç±»ä¼¼é¢˜ç›®
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="printExercises()">
                            ğŸ–¨ï¸ æ‰“å°é¢˜ç›®
                        </button>
                    </div>
                </div>

                <!-- è´¨é‡ä¼˜åŒ– -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">ğŸ”§ è´¨é‡ä¼˜åŒ–</h3>
                    <div class="action-grid">
                        <button class="btn btn-primary action-btn" onclick="showQualityReport()" title="æŸ¥çœ‹é¢˜ç›®è´¨é‡åˆ†ææŠ¥å‘Š (Ctrl+Q)">
                            ğŸ“Š è´¨é‡æŠ¥å‘Š
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="applyQualityOptimizations()" id="optimizeBtn">
                            âœ¨ é‡æ–°ä¼˜åŒ–
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.8rem; color: #666; line-height: 1.4;">
                        <div>â€¢ è‡ªåŠ¨å»é‡æ£€æµ‹</div>
                        <div>â€¢ éš¾åº¦æ™ºèƒ½è¯„ä¼°</div>
                        <div>â€¢ æ•°å­¦å…¬å¼æ¸²æŸ“</div>
                        <div>â€¢ å¿«æ·é”®: Ctrl+Q</div>
                    </div>
                </div>

                <!-- æ€§èƒ½ç›‘æ§ -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title">âš¡ æ€§èƒ½ç›‘æ§</h3>
                    <div id="performanceMetrics" style="font-size: 0.8rem; line-height: 1.6;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>ç¼“å­˜å‘½ä¸­ç‡:</span>
                            <span id="cacheEfficiency" style="font-weight: 600; color: #10b981;">è®¡ç®—ä¸­...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>APIè¯·æ±‚æ•°:</span>
                            <span id="apiRequests" style="font-weight: 600; color: #3b82f6;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>å¯¼å‡ºä»»åŠ¡:</span>
                            <span id="exportTasks" style="font-weight: 600; color: #8b5cf6;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>æ‰¹é‡è¯·æ±‚:</span>
                            <span id="batchedRequests" style="font-weight: 600; color: #f59e0b;">0</span>
                        </div>
                    </div>
                    <div class="action-grid" style="margin-top: 12px;">
                        <button class="btn btn-secondary action-btn" onclick="showPerformanceReport()" title="æŸ¥çœ‹è¯¦ç»†æ€§èƒ½æŠ¥å‘Š (Ctrl+P)">
                            ğŸ“ˆ æ€§èƒ½æŠ¥å‘Š
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="clearPerformanceCache()" title="æ¸…ç†ç¼“å­˜æ•°æ®">
                            ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜
                        </button>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.75rem; color: #999; text-align: center;">
                        <span>è‡ªåŠ¨æ›´æ–°æ¯30ç§’</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è´¨é‡ä¼˜åŒ–å·¥å…· -->
    <script src="/frontend/js/exercise-quality-optimizer.js"></script>
    <!-- å¼•å…¥æ€§èƒ½ä¼˜åŒ–å·¥å…· -->
    <script src="/frontend/js/performance-optimizer.js"></script>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';
        const authToken = localStorage.getItem('authToken') || 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzU3MTQ2Mjg0fQ.1FiO0fqJiioUF1UGzpJF6Qu2qoqNS_Lo0KRvLPMuff8';

        // å…¨å±€çŠ¶æ€
        let currentGenerationId = null;
        let currentExercises = [];
        let showAnswers = false;
        let showAnalysis = false;
        let exportConfig = {};
        let qualityOptimizer = null; // è´¨é‡ä¼˜åŒ–å®ä¾‹

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // APIè¯·æ±‚å·¥å…·å‡½æ•°
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
            const spinner = document.getElementById('loadingSpinner');
            const list = document.getElementById('exercisesList');
            const empty = document.getElementById('emptyState');

            if (loading) {
                spinner.style.display = 'block';
                list.style.display = 'none';
                empty.style.display = 'none';
            } else {
                spinner.style.display = 'none';
                list.style.display = 'block';
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${seconds.toFixed(1)}ç§’`;
            return `${(seconds / 60).toFixed(1)}åˆ†é’Ÿ`;
        }

        // åŠ è½½ç”Ÿæˆè®°å½•ä¿¡æ¯
        async function loadGenerationInfo() {
            try {
                const data = await apiRequest(`/exercise/generation/${currentGenerationId}`);
                
                // æ›´æ–°é¡µé¢å¤´éƒ¨ä¿¡æ¯
                document.getElementById('exerciseTitle').textContent = data.title || 'ç»ƒä¹ é¢˜';
                document.getElementById('exerciseSubject').textContent = data.subject || '-';
                document.getElementById('exerciseGrade').textContent = data.grade || '-';
                document.getElementById('exerciseCount').textContent = data.total_questions || 0;
                document.getElementById('exerciseTime').textContent = new Date(data.created_at).toLocaleString();
                
                // æ›´æ–°çŠ¶æ€æ ‡è¯†
                const statusEl = document.getElementById('exerciseStatus');
                statusEl.textContent = data.status === 'completed' ? 'å·²å®Œæˆ' : 'ç”Ÿæˆä¸­';
                statusEl.className = `status-badge ${data.status === 'completed' ? 'status-completed' : 'status-pending'}`;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('totalCount').textContent = data.total_questions || 0;
                document.getElementById('generationTime').textContent = formatTime(data.generation_time);
                document.getElementById('difficultyLevel').textContent = data.difficulty_level || '-';

                return data;
            } catch (error) {
                showError('åŠ è½½é¢˜ç›®ä¿¡æ¯å¤±è´¥: ' + error.message);
                throw error;
            }
        }

        // åŠ è½½é¢˜ç›®åˆ—è¡¨
        async function loadExercises() {
            try {
                setLoading(true);
                const exercises = await apiRequest(`/exercise/generation/${currentGenerationId}/exercises`);
                
                currentExercises = exercises;
                renderExercises();
                
                if (exercises.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('exercisesList').style.display = 'none';
                }
            } catch (error) {
                showError('åŠ è½½é¢˜ç›®åˆ—è¡¨å¤±è´¥: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
        function renderExercises() {
            const container = document.getElementById('exercisesList');
            
            if (currentExercises.length === 0) {
                container.innerHTML = '';
                return;
            }

            const html = currentExercises.map(exercise => {
                // è®¡ç®—é¢˜ç›®éš¾åº¦ä¿¡æ¯
                const difficultyInfo = qualityOptimizer ? qualityOptimizer.evaluateDifficulty(exercise) : null;
                const difficultyBadge = difficultyInfo ? 
                    `<span class="difficulty-badge" style="background: ${difficultyInfo.difficulty_level.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">
                        ${difficultyInfo.difficulty_level.name} Â· ${difficultyInfo.estimated_time}åˆ†é’Ÿ
                    </span>` : '';

                return `
                <div class="exercise-item" data-exercise-id="${exercise.id || exercise.number}">
                    <div class="exercise-header">
                        <div class="exercise-number">é¢˜ç›® ${exercise.number}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="exercise-type">${exercise.question_type || 'ç»ƒä¹ é¢˜'}</div>
                            ${difficultyBadge}
                        </div>
                    </div>
                    
                    <div class="exercise-question math-content">
                        ${exercise.question_text || 'é¢˜ç›®å†…å®¹åŠ è½½ä¸­...'}
                    </div>

                    <div class="exercise-answer ${showAnswers ? 'show' : ''}">
                        <div class="answer-label">ğŸ’¡ æ ‡å‡†ç­”æ¡ˆ</div>
                        <div class="answer-content math-content">${exercise.correct_answer || 'æš‚æ— ç­”æ¡ˆ'}</div>
                    </div>

                    <div class="exercise-analysis ${showAnalysis ? 'show' : ''}">
                        <div class="analysis-label">ğŸ“– è§£é¢˜åˆ†æ</div>
                        <div class="analysis-content math-content">${exercise.analysis || 'æš‚æ— åˆ†æ'}</div>
                    </div>

                    ${difficultyInfo ? `
                    <div class="quality-info" style="background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem;">
                        <strong>éš¾åº¦åˆ†æ:</strong> 
                        å…¬å¼å¤æ‚åº¦ ${(difficultyInfo.difficulty_factors.formula * 100).toFixed(0)}%, 
                        æ­¥éª¤å¤æ‚åº¦ ${(difficultyInfo.difficulty_factors.steps * 100).toFixed(0)}%, 
                        æ¦‚å¿µå¤æ‚åº¦ ${(difficultyInfo.difficulty_factors.concepts * 100).toFixed(0)}%
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // åˆ‡æ¢ç­”æ¡ˆæ˜¾ç¤º
        function toggleAnswers() {
            showAnswers = !showAnswers;
            const toggle = document.getElementById('answersToggle');
            toggle.textContent = showAnswers ? 'éšè—ç­”æ¡ˆ' : 'æ˜¾ç¤ºç­”æ¡ˆ';
            toggle.classList.toggle('active', showAnswers);
            
            document.querySelectorAll('.exercise-answer').forEach(el => {
                el.classList.toggle('show', showAnswers);
            });
        }

        // åˆ‡æ¢è§£ææ˜¾ç¤º
        function toggleAnalysis() {
            showAnalysis = !showAnalysis;
            const toggle = document.getElementById('analysisToggle');
            toggle.textContent = showAnalysis ? 'éšè—è§£æ' : 'æ˜¾ç¤ºè§£æ';
            toggle.classList.toggle('active', showAnalysis);
            
            document.querySelectorAll('.exercise-analysis').forEach(el => {
                el.classList.toggle('show', showAnalysis);
            });
        }

        // åˆ·æ–°é¢˜ç›®
        async function refreshExercises() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'åˆ·æ–°ä¸­...';

            try {
                await Promise.all([
                    loadGenerationInfo(),
                    loadExercises()
                ]);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ åˆ·æ–°';
            }
        }

        // ä¼˜åŒ–çš„å¼‚æ­¥å¯¼å‡ºåŠŸèƒ½
        async function exportExercises(format) {
            const btn = document.getElementById(`export${format.charAt(0).toUpperCase() + format.slice(1)}Btn`);
            const originalText = btn.textContent;
            
            try {
                console.log(`ğŸ“¤ å¼€å§‹å¼‚æ­¥å¯¼å‡º: ${format}`);
                
                // åˆ›å»ºå¯¼å‡ºè¿›åº¦æ˜¾ç¤º
                const progressContainer = createExportProgressUI(format);
                document.body.appendChild(progressContainer);
                
                const config = {
                    format: format,
                    include_answers: true,
                    include_analysis: true,
                    ...exportConfig
                };

                // ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–å™¨çš„å¼‚æ­¥å¯¼å‡º
                const result = await window.performanceOptimizer.exportFile(
                    currentGenerationId, 
                    format, 
                    config,
                    (progress, message) => {
                        updateExportProgressUI(format, progress, message);
                        btn.textContent = `${message} (${progress}%)`;
                    }
                );

                if (result.success) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = result.downloadUrl;
                    link.download = result.fileName;
                    link.click();
                    
                    const cacheInfo = result.fromCache ? ' (ä½¿ç”¨ç¼“å­˜æ–‡ä»¶)' : '';
                    showExportSuccess(`å¯¼å‡ºå®Œæˆï¼æ–‡ä»¶: ${result.fileName}${cacheInfo}`);
                    
                    // è®°å½•æ€§èƒ½ç»Ÿè®¡
                    const metrics = window.performanceOptimizer.getPerformanceMetrics();
                    console.log('ğŸ“Š å¯¼å‡ºåæ€§èƒ½ç»Ÿè®¡:', metrics);
                } else {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ å¼‚æ­¥å¯¼å‡ºå¤±è´¥:', error);
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                
                // å»¶è¿Ÿç§»é™¤è¿›åº¦æ˜¾ç¤º
                setTimeout(() => {
                    const progressEl = document.getElementById(`export-progress-${format}`);
                    if (progressEl) {
                        progressEl.remove();
                    }
                }, 3000);
            }
        }
        
        // åˆ›å»ºå¯¼å‡ºè¿›åº¦UI
        function createExportProgressUI(format) {
            const container = document.createElement('div');
            container.id = `export-progress-${format}`;
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                min-width: 300px;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 20px; margin-right: 8px;">ğŸ“¤</div>
                    <div style="font-weight: 600; color: #333;">å¯¼å‡º ${format.toUpperCase()}</div>
                </div>
                <div id="progress-bar-${format}" style="
                    width: 100%;
                    height: 6px;
                    background: #f0f0f0;
                    border-radius: 3px;
                    overflow: hidden;
                    margin-bottom: 8px;
                ">
                    <div id="progress-fill-${format}" style="
                        width: 0%;
                        height: 100%;
                        background: linear-gradient(90deg, #4f46e5, #7c3aed);
                        transition: width 0.3s ease;
                    "></div>
                </div>
                <div id="progress-text-${format}" style="
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                ">å‡†å¤‡å¯¼å‡º...</div>
            `;
            
            return container;
        }
        
        // æ›´æ–°å¯¼å‡ºè¿›åº¦UI
        function updateExportProgressUI(format, progress, message) {
            const progressFill = document.getElementById(`progress-fill-${format}`);
            const progressText = document.getElementById(`progress-text-${format}`);
            
            if (progressFill) {
                progressFill.style.width = `${Math.max(0, progress)}%`;
            }
            
            if (progressText) {
                progressText.textContent = message;
                
                // æ ¹æ®è¿›åº¦æ”¹å˜é¢œè‰²
                if (progress === 100) {
                    progressText.style.color = '#10b981';
                    progressText.style.fontWeight = '600';
                } else if (progress < 0) {
                    progressText.style.color = '#ef4444';
                    progressText.style.fontWeight = '600';
                } else {
                    progressText.style.color = '#666';
                }
            }
        }
        
        // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæ¶ˆæ¯
        function showExportSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
                font-size: 14px;
                font-weight: 500;
                z-index: 10001;
                max-width: 400px;
                text-align: center;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // å¾®ä¿¡åˆ†äº«
        async function shareToWechat() {
            const btn = document.getElementById('shareBtn');
            btn.disabled = true;
            btn.textContent = 'å‡†å¤‡ä¸­...';

            try {
                const config = {
                    include_answers: false,
                    include_analysis: false,
                    max_questions: 5
                };

                const result = await apiRequest(`/exercise/generation/${currentGenerationId}/share/wechat`, {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                // æ˜¾ç¤ºåˆ†äº«å†…å®¹
                const shareWindow = window.open('', '_blank', 'width=600,height=400');
                shareWindow.document.write(`
                    <html>
                    <head><title>å¾®ä¿¡åˆ†äº«å†…å®¹</title></head>
                    <body style="font-family: sans-serif; padding: 20px;">
                        <h3>ğŸ“± å¾®ä¿¡åˆ†äº«å†…å®¹</h3>
                        <textarea readonly style="width: 100%; height: 300px; font-family: monospace;">${result.content}</textarea>
                        <p><strong>åˆ†äº«é“¾æ¥:</strong> ${result.share_link || 'æš‚æ— '}</p>
                        <p><small>è¯·å¤åˆ¶ä¸Šé¢çš„å†…å®¹åˆ°å¾®ä¿¡åˆ†äº«</small></p>
                    </body>
                    </html>
                `);

            } catch (error) {
                showError('åˆ†äº«å‡†å¤‡å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“± å¾®ä¿¡åˆ†äº«';
            }
        }

        // ç”Ÿæˆç±»ä¼¼é¢˜ç›®
        function generateSimilar() {
            const url = `exercise-config.html?similar=${currentGenerationId}`;
            window.location.href = url;
        }

        // æ‰“å°é¢˜ç›®
        function printExercises() {
            window.print();
        }

        // æŸ¥çœ‹å†å²
        function viewHistory() {
            window.location.href = 'exercise-history.html';
        }

        // è¿”å›é…ç½®é¡µé¢
        function goBack() {
            window.location.href = 'exercise-config.html';
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–è´¨é‡ä¼˜åŒ–å™¨
            qualityOptimizer = new ExerciseQualityOptimizer();
            
            // è·å–ç”ŸæˆID
            currentGenerationId = getUrlParameter('id') || sessionStorage.getItem('lastGenerationId');
            
            if (!currentGenerationId) {
                showError('æœªæ‰¾åˆ°é¢˜ç›®ç”Ÿæˆè®°å½•ï¼Œå³å°†è¿”å›é…ç½®é¡µé¢...');
                setTimeout(() => {
                    window.location.href = 'exercise-config.html';
                }, 3000);
                return;
            }

            // åŠ è½½å¯¼å‡ºé…ç½®
            try {
                exportConfig = JSON.parse(sessionStorage.getItem('exportConfig') || '{}');
            } catch (e) {
                exportConfig = {};
            }

            // åŠ è½½é¡µé¢æ•°æ®
            try {
                await Promise.all([
                    loadGenerationInfo(),
                    loadExercises()
                ]);
                console.log('é¢˜ç›®é¢„è§ˆé¡µé¢åˆå§‹åŒ–å®Œæˆ');
                
                // åº”ç”¨è´¨é‡ä¼˜åŒ–
                await applyQualityOptimizations();
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'a':
                        e.preventDefault();
                        toggleAnswers();
                        break;
                    case 's':
                        e.preventDefault();
                        toggleAnalysis();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshExercises();
                        break;
                    case 'q':
                        e.preventDefault();
                        showQualityReport();
                        break;
                    case 'p':
                        e.preventDefault();
                        showPerformanceReport();
                        break;
                }
            }
        });

        /**
         * æ­¥éª¤8.1è´¨é‡ä¼˜åŒ–åŠŸèƒ½å®ç°
         */

        // åº”ç”¨è´¨é‡ä¼˜åŒ–
        async function applyQualityOptimizations() {
            if (!qualityOptimizer || currentExercises.length === 0) {
                return;
            }

            console.log('ğŸ”§ å¼€å§‹åº”ç”¨é¢˜ç›®è´¨é‡ä¼˜åŒ–...');

            try {
                // 1. é¢˜ç›®å»é‡å¤„ç†
                const deduplicationResult = qualityOptimizer.removeDuplicates(currentExercises);
                
                if (deduplicationResult.removed_count > 0) {
                    console.log(`âœ… å»é‡å®Œæˆï¼Œç§»é™¤ ${deduplicationResult.removed_count} é“é‡å¤é¢˜ç›®`);
                    currentExercises = deduplicationResult.unique_exercises;
                    
                    // æ˜¾ç¤ºå»é‡é€šçŸ¥
                    showOptimizationNotice(`å·²è‡ªåŠ¨å»é™¤ ${deduplicationResult.removed_count} é“é‡å¤é¢˜ç›®`, 'success');
                    
                    // é‡æ–°æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
                    renderExercises();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    document.getElementById('totalCount').textContent = currentExercises.length;
                }

                // 2. ä¼˜åŒ–æ•°å­¦å…¬å¼æ˜¾ç¤º
                setTimeout(() => {
                    const exercisesList = document.getElementById('exercisesList');
                    if (exercisesList) {
                        qualityOptimizer.optimizeMathDisplay(exercisesList);
                        console.log('âœ… æ•°å­¦å…¬å¼æ˜¾ç¤ºä¼˜åŒ–å®Œæˆ');
                    }
                }, 500);

                // 3. ç”Ÿæˆè´¨é‡æŠ¥å‘Š
                const qualityReport = qualityOptimizer.generateQualityReport(currentExercises);
                sessionStorage.setItem('lastQualityReport', JSON.stringify(qualityReport));
                console.log('âœ… è´¨é‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ:', qualityReport);

                // 4. æ›´æ–°éš¾åº¦ç»Ÿè®¡
                updateDifficultyStatistics();

                console.log('ğŸ‰ æ‰€æœ‰è´¨é‡ä¼˜åŒ–åº”ç”¨å®Œæˆ');

            } catch (error) {
                console.error('âŒ è´¨é‡ä¼˜åŒ–åº”ç”¨å¤±è´¥:', error);
                showOptimizationNotice('è´¨é‡ä¼˜åŒ–åº”ç”¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°éš¾åº¦ç»Ÿè®¡ä¿¡æ¯
        function updateDifficultyStatistics() {
            if (!qualityOptimizer || currentExercises.length === 0) return;

            const difficulties = currentExercises.map(ex => qualityOptimizer.evaluateDifficulty(ex));
            const avgDifficulty = difficulties.reduce((sum, d) => sum + d.overall_difficulty, 0) / difficulties.length;
            const avgTime = difficulties.reduce((sum, d) => sum + d.estimated_time, 0) / difficulties.length;

            // æ›´æ–°éš¾åº¦ç­‰çº§æ˜¾ç¤º
            const difficultyLevel = qualityOptimizer.getDifficultyLevel(avgDifficulty);
            const difficultyEl = document.getElementById('difficultyLevel');
            if (difficultyEl) {
                difficultyEl.innerHTML = `
                    <span style="color: ${difficultyLevel.color}; font-weight: bold;">
                        ${difficultyLevel.name} (${(avgDifficulty * 100).toFixed(0)}%)
                    </span>
                `;
            }

            // æ›´æ–°é¢„ä¼°æ—¶é—´
            const completionRateEl = document.getElementById('completionRate');
            if (completionRateEl) {
                completionRateEl.textContent = `é¢„è®¡ ${Math.round(avgTime)} åˆ†é’Ÿ`;
            }
        }

        // æ˜¾ç¤ºè´¨é‡æŠ¥å‘Š
        function showQualityReport() {
            const report = sessionStorage.getItem('lastQualityReport');
            if (!report) {
                alert('æš‚æ— è´¨é‡æŠ¥å‘Šæ•°æ®ï¼Œè¯·å…ˆåˆ·æ–°é¡µé¢é‡æ–°ç”Ÿæˆ');
                return;
            }

            const qualityData = JSON.parse(report);
            
            const reportWindow = window.open('', '_blank', 'width=800,height=600');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>é¢˜ç›®è´¨é‡æŠ¥å‘Š</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; }
                        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
                        .metric { display: flex; justify-content: space-between; margin-bottom: 8px; }
                        .metric-label { font-weight: 500; }
                        .metric-value { font-weight: bold; color: #667eea; }
                        .recommendations { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; }
                        .recommendation { margin-bottom: 5px; }
                        .difficulty-chart { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
                        .difficulty-item { text-align: center; padding: 10px; border-radius: 6px; }
                        .easy { background: #d4edda; color: #155724; }
                        .medium { background: #fff3cd; color: #856404; }
                        .hard { background: #f8d7da; color: #721c24; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>ğŸ“Š é¢˜ç›®è´¨é‡åˆ†ææŠ¥å‘Š</h2>
                        <p>ç”Ÿæˆæ—¶é—´: ${new Date(qualityData.timestamp).toLocaleString()}</p>
                    </div>

                    <div class="section">
                        <h3>ğŸ“ˆ åŸºæœ¬ç»Ÿè®¡</h3>
                        <div class="metric">
                            <span class="metric-label">é¢˜ç›®æ€»æ•°:</span>
                            <span class="metric-value">${qualityData.total_exercises}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">å»é‡ç§»é™¤:</span>
                            <span class="metric-value">${qualityData.quality_metrics.duplicates.removed_count}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æ•°å­¦å…¬å¼:</span>
                            <span class="metric-value">${qualityData.quality_metrics.math_formulas}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“Š éš¾åº¦åˆ†å¸ƒ</h3>
                        <div class="difficulty-chart">
                            <div class="difficulty-item easy">
                                <div>ç®€å•</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'easy').length}</div>
                            </div>
                            <div class="difficulty-item medium">
                                <div>ä¸­ç­‰</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'medium').length}</div>
                            </div>
                            <div class="difficulty-item hard">
                                <div>å›°éš¾</div>
                                <div>${qualityData.quality_metrics.difficulty_analysis.filter(d => d.difficulty_level.level === 'hard').length}</div>
                            </div>
                        </div>
                    </div>

                    <div class="recommendations">
                        <h3>ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
                        ${qualityData.recommendations.map(rec => `<div class="recommendation">â€¢ ${rec}</div>`).join('')}
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š
                        </button>
                    </div>
                </body>
                </html>
            `);
        }

        // æ˜¾ç¤ºä¼˜åŒ–é€šçŸ¥
        function showOptimizationNotice(message, type = 'info') {
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;

            const colors = {
                success: { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
                error: { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
                info: { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
            };

            const color = colors[type] || colors.info;
            notice.style.background = color.bg;
            notice.style.color = color.color;
            notice.style.border = `1px solid ${color.border}`;
            notice.textContent = message;

            document.body.appendChild(notice);

            setTimeout(() => {
                notice.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notice)) {
                        document.body.removeChild(notice);
                    }
                }, 300);
            }, 4000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .math-content {
                font-family: "Times New Roman", serif;
            }
            
            .difficulty-badge {
                animation: fadeIn 0.5s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.8); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(animationStyles);

        /**
         * æ­¥éª¤8.2æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½å®ç°
         */

        // æ›´æ–°æ€§èƒ½ç›‘æ§æ˜¾ç¤º
        function updatePerformanceMetrics() {
            if (!window.performanceOptimizer) return;

            try {
                const metrics = window.performanceOptimizer.getPerformanceMetrics();
                
                // æ›´æ–°UIæ˜¾ç¤º
                const cacheEfficiencyEl = document.getElementById('cacheEfficiency');
                const apiRequestsEl = document.getElementById('apiRequests');
                const exportTasksEl = document.getElementById('exportTasks');
                const batchedRequestsEl = document.getElementById('batchedRequests');

                if (cacheEfficiencyEl) {
                    cacheEfficiencyEl.textContent = metrics.cacheEfficiency;
                    // æ ¹æ®æ•ˆç‡è°ƒæ•´é¢œè‰²
                    const efficiency = parseFloat(metrics.cacheEfficiency);
                    if (efficiency >= 70) {
                        cacheEfficiencyEl.style.color = '#10b981'; // ç»¿è‰²
                    } else if (efficiency >= 40) {
                        cacheEfficiencyEl.style.color = '#f59e0b'; // æ©™è‰²
                    } else {
                        cacheEfficiencyEl.style.color = '#ef4444'; // çº¢è‰²
                    }
                }

                if (apiRequestsEl) {
                    apiRequestsEl.textContent = metrics.apiRequests;
                }

                if (exportTasksEl) {
                    exportTasksEl.textContent = `${metrics.exportTasks} (${metrics.activeExportTasks} æ´»è·ƒ)`;
                }

                if (batchedRequestsEl) {
                    batchedRequestsEl.textContent = metrics.batchedRequests;
                }

                console.log('ğŸ“Š æ€§èƒ½æŒ‡æ ‡å·²æ›´æ–°:', metrics);
            } catch (error) {
                console.error('æ›´æ–°æ€§èƒ½æŒ‡æ ‡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†æ€§èƒ½æŠ¥å‘Š
        function showPerformanceReport() {
            if (!window.performanceOptimizer) {
                alert('æ€§èƒ½ä¼˜åŒ–å™¨æœªåŠ è½½');
                return;
            }

            const metrics = window.performanceOptimizer.getPerformanceMetrics();
            
            const reportWindow = window.open('', '_blank', 'width=800,height=600');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>æ€§èƒ½ç›‘æ§æŠ¥å‘Š</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; background: #f8f9fa; }
                        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .metric { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px; border-radius: 4px; }
                        .metric-label { font-weight: 500; }
                        .metric-value { font-weight: bold; }
                        .high-performance { background: #d4edda; color: #155724; }
                        .medium-performance { background: #fff3cd; color: #856404; }
                        .low-performance { background: #f8d7da; color: #721c24; }
                        .recommendations { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; }
                        .chart { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                        .chart-item { text-align: center; padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
                        .chart-value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
                        .chart-label { font-size: 0.9rem; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>âš¡ æ€§èƒ½ç›‘æ§æŠ¥å‘Š</h2>
                        <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
                    </div>

                    <div class="chart">
                        <div class="chart-item">
                            <div class="chart-value" style="color: #10b981;">${metrics.cacheEfficiency}</div>
                            <div class="chart-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #3b82f6;">${metrics.apiRequests}</div>
                            <div class="chart-label">APIè¯·æ±‚æ€»æ•°</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #8b5cf6;">${metrics.exportTasks}</div>
                            <div class="chart-label">å¯¼å‡ºä»»åŠ¡</div>
                        </div>
                        <div class="chart-item">
                            <div class="chart-value" style="color: #f59e0b;">${metrics.batchedRequests}</div>
                            <div class="chart-label">æ‰¹é‡è¯·æ±‚</div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“Š è¯¦ç»†æ€§èƒ½æŒ‡æ ‡</h3>
                        <div class="metric ${parseFloat(metrics.cacheEfficiency) >= 70 ? 'high-performance' : parseFloat(metrics.cacheEfficiency) >= 40 ? 'medium-performance' : 'low-performance'}">
                            <span class="metric-label">ç¼“å­˜æ•ˆç‡:</span>
                            <span class="metric-value">${metrics.cacheEfficiency}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ç¼“å­˜å‘½ä¸­æ¬¡æ•°:</span>
                            <span class="metric-value">${metrics.cacheHits}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°:</span>
                            <span class="metric-value">${metrics.cacheMisses}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æ€»ç¼“å­˜æ“ä½œ:</span>
                            <span class="metric-value">${metrics.totalCacheOperations}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æ´»è·ƒå¯¼å‡ºä»»åŠ¡:</span>
                            <span class="metric-value">${metrics.activeExportTasks}</span>
                        </div>
                    </div>

                    <div class="recommendations">
                        <h3>ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
                        ${generatePerformanceRecommendations(metrics)}
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            å…³é—­çª—å£
                        </button>
                    </div>
                </body>
                </html>
            `);
        }

        // ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–å»ºè®®
        function generatePerformanceRecommendations(metrics) {
            const recommendations = [];
            const cacheEfficiency = parseFloat(metrics.cacheEfficiency);

            if (cacheEfficiency < 30) {
                recommendations.push('â€¢ ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ï¼Œå»ºè®®æ£€æŸ¥ç¼“å­˜ç­–ç•¥å’Œè¿‡æœŸæ—¶é—´è®¾ç½®');
            } else if (cacheEfficiency >= 80) {
                recommendations.push('â€¢ ç¼“å­˜å‘½ä¸­ç‡ä¼˜ç§€ï¼Œç³»ç»Ÿæ€§èƒ½è¡¨ç°è‰¯å¥½');
            }

            if (metrics.apiRequests > 50) {
                recommendations.push('â€¢ APIè¯·æ±‚è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨æ‰¹é‡è¯·æ±‚ä¼˜åŒ–');
            }

            if (metrics.activeExportTasks > 3) {
                recommendations.push('â€¢ æ´»è·ƒå¯¼å‡ºä»»åŠ¡è¿‡å¤šï¼Œå»ºè®®å®æ–½ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†');
            }

            if (metrics.batchedRequests === 0) {
                recommendations.push('â€¢ æœªä½¿ç”¨æ‰¹é‡è¯·æ±‚ï¼Œå»ºè®®å¯ç”¨æ‰¹é‡APIè°ƒç”¨ä»¥æå‡æ€§èƒ½');
            }

            if (recommendations.length === 0) {
                recommendations.push('â€¢ ç³»ç»Ÿæ€§èƒ½è¡¨ç°è‰¯å¥½ï¼Œæ— éœ€ç‰¹æ®Šä¼˜åŒ–');
            }

            return recommendations.map(rec => `<div style="margin-bottom: 5px;">${rec}</div>`).join('');
        }

        // æ¸…ç†æ€§èƒ½ç¼“å­˜
        function clearPerformanceCache() {
            if (!window.performanceOptimizer) {
                alert('æ€§èƒ½ä¼˜åŒ–å™¨æœªåŠ è½½');
                return;
            }

            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™å°†å½±å“åŠ è½½é€Ÿåº¦ï¼Œä½†å¯ä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚')) {
                try {
                    window.performanceOptimizer.clearExpiredCache();
                    window.performanceOptimizer.clearMetrics();
                    
                    // æ¸…ç†localStorageä¸­çš„ç¼“å­˜
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('cache_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    updatePerformanceMetrics();
                    showOptimizationNotice('ç¼“å­˜å·²æ¸…ç†ï¼Œä¸‹æ¬¡åŠ è½½å¯èƒ½ä¼šè¾ƒæ…¢', 'info');
                } catch (error) {
                    console.error('æ¸…ç†ç¼“å­˜å¤±è´¥:', error);
                    showOptimizationNotice('æ¸…ç†ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // å¯åŠ¨æ€§èƒ½ç›‘æ§
        function startPerformanceMonitoring() {
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updatePerformanceMetrics();
            
            // æ¯30ç§’è‡ªåŠ¨æ›´æ–°
            setInterval(updatePerformanceMetrics, 30000);
            
            console.log('âš¡ æ€§èƒ½ç›‘æ§å·²å¯åŠ¨ï¼Œæ¯30ç§’è‡ªåŠ¨æ›´æ–°');
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ€§èƒ½ç›‘æ§
        window.addEventListener('load', () => {
            setTimeout(startPerformanceMonitoring, 2000); // å»¶è¿Ÿ2ç§’å¯åŠ¨ï¼Œç¡®ä¿å…¶ä»–åˆå§‹åŒ–å®Œæˆ
        });

    </script>
</body>
</html>