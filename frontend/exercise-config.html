<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å‡ºé¢˜é…ç½® - æ™ºèƒ½æ•™è‚²å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .config-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 12px;
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .form-select, .form-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 500;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #2d7738;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .config-card {
                padding: 25px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ™ºèƒ½å‡ºé¢˜é…ç½®</h1>
            <p>è®¾ç½®æ‚¨çš„é¢˜ç›®ç”Ÿæˆå‚æ•°ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–ç»ƒä¹ é¢˜</p>
        </div>

        <div class="config-card">
            <form id="exerciseConfigForm">
                <!-- åŸºç¡€è®¾ç½® -->
                <div class="form-section">
                    <h3 class="section-title">ğŸ“š åŸºç¡€è®¾ç½®</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="subject">å­¦ç§‘é€‰æ‹©</label>
                            <select id="subject" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©å­¦ç§‘...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="grade">å¹´çº§é€‰æ‹©</label>
                            <select id="grade" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©å¹´çº§...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="title">é¢˜ç›®é›†æ ‡é¢˜</label>
                            <input type="text" id="title" class="form-input" 
                                   placeholder="ä¾‹å¦‚ï¼šåŠ æ³•ç»ƒä¹ é¢˜" maxlength="200">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="description">é¢˜ç›®é›†æè¿°</label>
                            <input type="text" id="description" class="form-input" 
                                   placeholder="ä¾‹å¦‚ï¼šåŸºç¡€åŠ æ³•è¿ç®—ç»ƒä¹ " maxlength="500">
                        </div>
                    </div>
                </div>

                <!-- é¢˜ç›®è®¾ç½® -->
                <div class="form-section">
                    <h3 class="section-title">âš™ï¸ é¢˜ç›®è®¾ç½®</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">é¢˜ç›®æ•°é‡: <span class="range-value" id="questionCountValue">5</span></label>
                            <div class="range-group">
                                <span>1</span>
                                <input type="range" id="questionCount" class="range-input" 
                                       min="1" max="50" value="5">
                                <span>50</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="difficulty">éš¾åº¦ç­‰çº§</label>
                            <select id="difficulty" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©éš¾åº¦...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- é¢˜å‹é€‰æ‹© -->
                <div class="form-section">
                    <h3 class="section-title">ğŸ“ é¢˜å‹é€‰æ‹©</h3>
                    <div class="checkbox-group" id="questionTypes">
                        <!-- åŠ¨æ€åŠ è½½é¢˜å‹é€‰é¡¹ -->
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½® -->
                <div class="form-section">
                    <h3 class="section-title">ğŸ”§ é«˜çº§è®¾ç½®</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeAnswers" checked>
                                <label for="includeAnswers">åŒ…å«æ ‡å‡†ç­”æ¡ˆ</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeAnalysis" checked>
                                <label for="includeAnalysis">åŒ…å«è§£é¢˜åˆ†æ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯¼å‡ºè®¾ç½® -->
                <div class="form-section">
                    <h3 class="section-title">ğŸ“„ å¯¼å‡ºè®¾ç½®</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="exportFormat">å¯¼å‡ºæ ¼å¼</label>
                            <select id="exportFormat" class="form-select">
                                <option value="text">æ–‡æœ¬æ ¼å¼ (.txt)</option>
                                <option value="word">Wordæ–‡æ¡£ (.docx)</option>
                                <option value="pdf">PDFæ–‡æ¡£ (.pdf)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="paperSize">çº¸å¼ å¤§å°</label>
                            <select id="paperSize" class="form-select">
                                <option value="A4">A4</option>
                                <option value="A3">A3</option>
                                <option value="Letter">Letter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ é‡ç½®é…ç½®
                    </button>
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        âœ¨ å¼€å§‹ç”Ÿæˆé¢˜ç›®
                    </button>
                </div>

                <div class="loading" id="loadingMessage">
                    æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </form>
        </div>
    </div>

    <!-- å¼•å…¥æ€§èƒ½ä¼˜åŒ–å·¥å…· -->
    <script src="/frontend/js/performance-optimizer.js"></script>
    <!-- å¼•å…¥é”™è¯¯å¤„ç†å·¥å…· -->
    <script src="/frontend/js/error-handler.js"></script>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';
        const authToken = localStorage.getItem('authToken') || 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzU3MTQ2Mjg0fQ.1FiO0fqJiioUF1UGzpJF6Qu2qoqNS_Lo0KRvLPMuff8';
        
        // è®¾ç½®å…¨å±€APIé…ç½®ç»™æ€§èƒ½ä¼˜åŒ–å™¨ä½¿ç”¨
        window.API_BASE = API_BASE;

        // APIè¯·æ±‚å·¥å…·å‡½æ•° - ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿçš„é‡è¯•æœºåˆ¶
        async function apiRequest(endpoint, options = {}) {
            return window.errorHandler.retryApiRequest(async () => {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            }, {
                maxRetries: 2,
                retryDelay: 1500,
                context: 'exercise-config'
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯ - å¢å¼ºçš„é”™è¯¯å¤„ç†
        function showMessage(message, type = 'success') {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // éšè—æ‰€æœ‰æ¶ˆæ¯
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            if (type === 'error') {
                // ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯
                const errorId = window.errorHandler.showFriendlyError(new Error(message), 'exercise-config');
                console.log(`æ˜¾ç¤ºç”¨æˆ·å‹å¥½é”™è¯¯ï¼ŒID: ${errorId}`);
                
                // åŒæ—¶ä¹Ÿåœ¨é¡µé¢å†…æ˜¾ç¤º
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else {
                successEl.textContent = message;
                successEl.style.display = 'block';
            }

            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    successEl.style.display = 'none';
                }, 3000);
            }
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€ - ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿçš„åŠ è½½æŒ‡ç¤ºå™¨
        function setLoading(loading) {
            const loadingEl = document.getElementById('loadingMessage');
            const submitBtn = document.getElementById('generateBtn');

            if (loading) {
                loadingEl.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç”Ÿæˆä¸­...';
                
                // ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿçš„é«˜çº§åŠ è½½æŒ‡ç¤ºå™¨
                window.errorHandler.createLoadingIndicator('exercise-generation', {
                    message: 'æ­£åœ¨ç”Ÿæˆç»ƒä¹ é¢˜...',
                    position: 'top',
                    backdrop: false,
                    progress: true,
                    cancellable: false
                });
            } else {
                loadingEl.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ¨ å¼€å§‹ç”Ÿæˆé¢˜ç›®';
                
                // éšè—é«˜çº§åŠ è½½æŒ‡ç¤ºå™¨
                window.errorHandler.hideLoadingIndicator('exercise-generation');
            }
        }

        // ä¼˜åŒ–çš„é…ç½®æ•°æ®åŠ è½½ - ä½¿ç”¨æ‰¹é‡è¯·æ±‚å’Œç¼“å­˜ï¼Œå¢å¼ºé”™è¯¯å¤„ç†
        async function loadAllConfigData() {
            try {
                console.log('ğŸš€ å¼€å§‹åŠ è½½é…ç½®æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰...');
                const startTime = Date.now();
                
                // æ˜¾ç¤ºåŠ è½½è¿›åº¦
                window.errorHandler.createLoadingIndicator('config-loading', {
                    message: 'æ­£åœ¨åŠ è½½é…ç½®æ•°æ®...',
                    position: 'center',
                    backdrop: true,
                    progress: true,
                    cancellable: false
                });
                
                // ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–å™¨çš„æ‰¹é‡è¯·æ±‚
                const requests = [
                    { endpoint: '/exercise/config/subjects', key: 'subjects' },
                    { endpoint: '/exercise/config/grades', key: 'grades' },
                    { endpoint: '/exercise/config/difficulty-levels', key: 'difficulty_levels' },
                    { endpoint: '/exercise/config/question-types', key: 'question_types' }
                ];
                
                // æ›´æ–°è¿›åº¦
                window.errorHandler.updateLoadingProgress('config-loading', 25, 'è¿æ¥æœåŠ¡å™¨...');
                
                const results = await window.performanceOptimizer.batchApiRequest(requests);
                
                // æ›´æ–°è¿›åº¦
                window.errorHandler.updateLoadingProgress('config-loading', 75, 'å¤„ç†é…ç½®æ•°æ®...');
                
                // å¤„ç†ç»“æœ
                let loadedCount = 0;
                let cachedCount = 0;
                
                results.forEach((result, index) => {
                    if (result.error) {
                        console.error(`âŒ åŠ è½½${requests[index].key}å¤±è´¥:`, result.error);
                        return;
                    }
                    
                    const { data, fromCache } = result;
                    if (fromCache) cachedCount++;
                    loadedCount++;
                    
                    // æ ¹æ®ç±»å‹å¡«å……UI
                    switch (requests[index].key) {
                        case 'subjects':
                            populateSubjects(data);
                            break;
                        case 'grades':
                            populateGrades(data);
                            break;
                        case 'difficulty_levels':
                            populateDifficultyLevels(data);
                            break;
                        case 'question_types':
                            populateQuestionTypes(data);
                            break;
                    }
                });
                
                // å®Œæˆè¿›åº¦
                window.errorHandler.updateLoadingProgress('config-loading', 100, 'é…ç½®æ•°æ®åŠ è½½å®Œæˆï¼');
                
                const duration = Date.now() - startTime;
                console.log(`âœ… é…ç½®æ•°æ®åŠ è½½å®Œæˆ: ${loadedCount}/4 æˆåŠŸ, ${cachedCount} æ¥è‡ªç¼“å­˜ (${duration}ms)`);
                
                // æ˜¾ç¤ºæ€§èƒ½æç¤º
                if (cachedCount > 0) {
                    showMessage(`é…ç½®åŠ è½½å®Œæˆï¼Œ${cachedCount}é¡¹æ¥è‡ªç¼“å­˜ï¼ŒåŠ è½½é€Ÿåº¦æå‡ ${Math.round((cachedCount/4)*100)}%`, 'success');
                }
                
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                setTimeout(() => {
                    window.errorHandler.hideLoadingIndicator('config-loading');
                }, 1000);
                
            } catch (error) {
                console.error('âŒ æ‰¹é‡åŠ è½½é…ç½®æ•°æ®å¤±è´¥:', error);
                
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                window.errorHandler.hideLoadingIndicator('config-loading');
                
                // ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿæ˜¾ç¤ºç”¨æˆ·å‹å¥½é”™è¯¯
                window.errorHandler.showFriendlyError(error, 'exercise-config');
                showMessage('é…ç½®æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¡«å……å­¦ç§‘é€‰æ‹©
        function populateSubjects(data) {
            const select = document.getElementById('subject');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦ç§‘...</option>'; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            
            if (data.subjects) {
                data.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });
                console.log('ğŸ“š å­¦ç§‘åˆ—è¡¨å·²å¡«å……');
            }
        }
        
        // å¡«å……å¹´çº§é€‰æ‹©
        function populateGrades(data) {
            const select = document.getElementById('grade');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å¹´çº§...</option>'; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            
            if (data.grades) {
                data.grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    select.appendChild(option);
                });
                console.log('ğŸ“ å¹´çº§åˆ—è¡¨å·²å¡«å……');
            }
        }
        
        // å¡«å……éš¾åº¦ç­‰çº§é€‰æ‹©
        function populateDifficultyLevels(data) {
            const select = document.getElementById('difficulty');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©éš¾åº¦...</option>'; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            
            if (data.difficulty_levels) {
                Object.entries(data.difficulty_levels).forEach(([key, config]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${config.name} - ${config.description}`;
                    select.appendChild(option);
                });
                console.log('âš™ï¸ éš¾åº¦ç­‰çº§å·²å¡«å……');
            }
        }
        
        // å¡«å……é¢˜å‹é€‰æ‹©
        function populateQuestionTypes(data) {
            const container = document.getElementById('questionTypes');
            container.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
            
            if (data.question_types) {
                Object.entries(data.question_types).forEach(([key, config]) => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    div.innerHTML = `
                        <input type="checkbox" id="type_${key}" name="questionTypes" value="${key}" ${key === 'similar' ? 'checked' : ''}>
                        <label for="type_${key}">
                            <strong>${config.name}</strong><br>
                            <small style="color: #718096;">${config.description}</small>
                        </label>
                    `;
                    
                    container.appendChild(div);

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        div.classList.toggle('selected', div.querySelector('input').checked);
                    });

                    // åˆå§‹çŠ¶æ€
                    if (key === 'similar') {
                        div.classList.add('selected');
                    }
                });
                console.log('ğŸ“ é¢˜å‹é€‰æ‹©å·²å¡«å……');
            }
        }

        // é¢˜ç›®æ•°é‡æ»‘å—äº‹ä»¶
        document.getElementById('questionCount').addEventListener('input', (e) => {
            document.getElementById('questionCountValue').textContent = e.target.value;
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('exerciseConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true);
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = new FormData(e.target);
                const selectedTypes = Array.from(document.querySelectorAll('input[name="questionTypes"]:checked'))
                    .map(cb => cb.value);

                if (selectedTypes.length === 0) {
                    throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹');
                }

                const config = {
                    subject: document.getElementById('subject').value,
                    grade: document.getElementById('grade').value,
                    title: document.getElementById('title').value || `${document.getElementById('subject').value} ${document.getElementById('grade').value} ç»ƒä¹ é¢˜`,
                    description: document.getElementById('description').value || `AIç”Ÿæˆçš„${document.getElementById('subject').value}ç»ƒä¹ é¢˜`,
                    question_count: parseInt(document.getElementById('questionCount').value),
                    difficulty_level: document.getElementById('difficulty').value,
                    question_types: selectedTypes,
                    include_answers: document.getElementById('includeAnswers').checked,
                    include_analysis: document.getElementById('includeAnalysis').checked
                };

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!config.subject || !config.grade || !config.difficulty_level) {
                    throw new Error('è¯·å¡«å†™å®Œæ•´çš„åŸºç¡€è®¾ç½®ä¿¡æ¯');
                }

                // ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–å™¨ç¼“å­˜é…ç½®
                window.performanceOptimizer.cacheExerciseConfig(config);
                console.log('ğŸ’¾ ç»ƒä¹ é…ç½®å·²ç¼“å­˜');

                // å‘é€ç”Ÿæˆè¯·æ±‚ï¼ˆä½¿ç”¨æ€§èƒ½ä¼˜åŒ–çš„APIè¯·æ±‚å’Œé”™è¯¯å¤„ç†ï¼‰
                window.errorHandler.updateLoadingProgress('exercise-generation', 50, 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®...');
                
                const response = await window.errorHandler.retryExerciseGeneration(config);
                
                // æ›´æ–°è¿›åº¦åˆ°100%
                window.errorHandler.updateLoadingProgress('exercise-generation', 100, 'é¢˜ç›®ç”Ÿæˆå®Œæˆï¼');

                showMessage(`é¢˜ç›®ç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨ï¼ç”ŸæˆID: ${response.generation_id}`, 'success');
                
                // å­˜å‚¨é…ç½®å’Œç”ŸæˆIDï¼Œç”¨äºè·³è½¬åˆ°é¢„è§ˆé¡µé¢
                sessionStorage.setItem('lastGenerationId', response.generation_id);
                sessionStorage.setItem('exportConfig', JSON.stringify({
                    format: document.getElementById('exportFormat').value,
                    paper_size: document.getElementById('paperSize').value,
                    include_answers: config.include_answers,
                    include_analysis: config.include_analysis
                }));

                // æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
                const metrics = window.performanceOptimizer.getPerformanceMetrics();
                console.log('ğŸ“Š å½“å‰æ€§èƒ½ç»Ÿè®¡:', metrics);

                // 3ç§’åè·³è½¬åˆ°é¢„è§ˆé¡µé¢
                setTimeout(() => {
                    window.location.href = `exercise-preview.html?id=${response.generation_id}`;
                }, 3000);

            } catch (error) {
                // ä½¿ç”¨é”™è¯¯å¤„ç†ç³»ç»Ÿæ˜¾ç¤ºç”¨æˆ·å‹å¥½é”™è¯¯
                window.errorHandler.showFriendlyError(error, 'exercise-generation');
                showMessage('ç”Ÿæˆé¢˜ç›®å¤±è´¥: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        });

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('exerciseConfigForm').reset();
            document.getElementById('questionCountValue').textContent = '5';
            
            // é‡ç½®é¢˜å‹é€‰æ‹©
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input');
                checkbox.checked = checkbox.value === 'similar';
                item.classList.toggle('selected', checkbox.checked);
            });

            // éšè—æ¶ˆæ¯
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸš€ é…ç½®é¡µé¢åˆå§‹åŒ–å¼€å§‹ï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼‰...');
                
                // ç­‰å¾…æ€§èƒ½ä¼˜åŒ–å™¨å‡†å¤‡å°±ç»ª
                if (window.performanceOptimizer) {
                    // ä½¿ç”¨ä¼˜åŒ–çš„æ‰¹é‡åŠ è½½
                    await loadAllConfigData();
                    
                    // å°è¯•æ¢å¤ç”¨æˆ·åå¥½
                    restoreUserPreferences();
                    
                    console.log('âœ… é…ç½®é¡µé¢åˆå§‹åŒ–å®Œæˆï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼‰');
                    
                    // æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
                    setTimeout(() => {
                        const metrics = window.performanceOptimizer.getPerformanceMetrics();
                        if (metrics.cacheHits > 0) {
                            showMessage(`æ€§èƒ½æç¤ºï¼šç¼“å­˜å‘½ä¸­ç‡ ${metrics.cacheEfficiency}ï¼ŒåŠ è½½é€Ÿåº¦æå‡æ˜¾è‘—`, 'success');
                        }
                    }, 1000);
                } else {
                    throw new Error('æ€§èƒ½ä¼˜åŒ–å™¨æœªåŠ è½½');
                }
                
            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ¢å¤ç”¨æˆ·åå¥½
        function restoreUserPreferences() {
            try {
                const prefs = window.performanceOptimizer.get('user_exercise_preferences');
                if (prefs) {
                    console.log('ğŸ”„ æ¢å¤ç”¨æˆ·åå¥½è®¾ç½®');
                    
                    // æ¢å¤å­¦ç§‘é€‰æ‹©
                    if (prefs.subject) {
                        const subjectSelect = document.getElementById('subject');
                        if (subjectSelect) {
                            subjectSelect.value = prefs.subject;
                        }
                    }
                    
                    // æ¢å¤å¹´çº§é€‰æ‹©
                    if (prefs.grade) {
                        const gradeSelect = document.getElementById('grade');
                        if (gradeSelect) {
                            gradeSelect.value = prefs.grade;
                        }
                    }
                    
                    // æ¢å¤éš¾åº¦é€‰æ‹©
                    if (prefs.difficulty) {
                        const difficultySelect = document.getElementById('difficulty');
                        if (difficultySelect) {
                            difficultySelect.value = prefs.difficulty;
                        }
                    }
                    
                    // æ¢å¤é¢˜å‹é€‰æ‹©
                    if (prefs.favorite_types && Array.isArray(prefs.favorite_types)) {
                        prefs.favorite_types.forEach(type => {
                            const checkbox = document.getElementById(`type_${type}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                const parent = checkbox.closest('.checkbox-item');
                                if (parent) {
                                    parent.classList.add('selected');
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('æ¢å¤ç”¨æˆ·åå¥½å¤±è´¥:', error);
            }
        }

        // ç›‘å¬å¯¼å‡ºè¿›åº¦äº‹ä»¶
        window.addEventListener('exportProgress', (e) => {
            const { taskId, progress, message } = e.detail;
            console.log(`ğŸ“¤ å¯¼å‡ºè¿›åº¦ [${taskId}]: ${progress}% - ${message}`);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¿›åº¦æ¡UIæ›´æ–°é€»è¾‘
            if (progress === 100) {
                showMessage(`å¯¼å‡ºå®Œæˆ: ${message}`, 'success');
            } else if (progress > 0) {
                showMessage(`å¯¼å‡ºè¿›åº¦: ${progress}% - ${message}`, 'info');
            }
        });
    </script>
</body>
</html>