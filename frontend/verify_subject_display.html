<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç§‘æ˜¾ç¤ºéªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .panel { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; background: #f8fff8; }
        .warning { border-left: 4px solid #ff9800; background: #fff8e1; }
        .error { border-left: 4px solid #f44336; background: #ffebee; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .subject-card {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .chinese-subject { border-color: #4CAF50; background: #e8f5e8; }
        .math-subject { border-color: #2196F3; background: #e3f2fd; }
        .chemistry-subject { border-color: #ff9800; background: #fff3e0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š å­¦ç§‘æ˜¾ç¤ºéªŒè¯å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºéªŒè¯æ–°å»ºå­¦ä¹ è®¡åˆ’åå­¦ç§‘æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®</p>
        
        <div class="panel">
            <h2>ğŸ¯ å¿«é€Ÿæµ‹è¯•</h2>
            <button onclick="createChinesePlan()">åˆ›å»ºè¯­æ–‡å­¦ä¹ è®¡åˆ’</button>
            <button onclick="createMathPlan()">åˆ›å»ºæ•°å­¦å­¦ä¹ è®¡åˆ’</button>
            <button onclick="checkCurrentDisplay()">æ£€æŸ¥å½“å‰æ˜¾ç¤º</button>
            <button onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°éªŒè¯</button>
        </div>
        
        <div class="panel">
            <h2>ğŸ“Š å½“å‰å­¦ç§‘æ˜¾ç¤ºçŠ¶æ€</h2>
            <div id="currentStatus">ç‚¹å‡»"æ£€æŸ¥å½“å‰æ˜¾ç¤º"æŸ¥çœ‹çŠ¶æ€</div>
        </div>
        
        <div class="panel">
            <h2>ğŸ” å®æ—¶æ¯”è¾ƒ</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>APIæ•°æ® (çœŸå®æ•°æ®)</h3>
                    <div id="apiData">-</div>
                </div>
                <div style="flex: 1;">
                    <h3>å‰ç«¯æ˜¾ç¤º (ç”¨æˆ·çœ‹åˆ°çš„)</h3>
                    <div id="frontendDisplay">-</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>ğŸ”— é¡µé¢é“¾æ¥</h2>
            <p><a href="http://localhost:8080/frontend/study-plan.html" target="_blank">ğŸ“‹ å­¦ä¹ è®¡åˆ’é¡µé¢ (æ–°çª—å£)</a></p>
            <p><strong>éªŒè¯æ­¥éª¤:</strong></p>
            <ol>
                <li>åœ¨æ­¤é¡µé¢åˆ›å»ºè¯­æ–‡å­¦ä¹ è®¡åˆ’</li>
                <li>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢</li>
                <li>æ£€æŸ¥å­¦ç§‘è®¡åˆ’åŒºåŸŸæ˜¯å¦æ˜¾ç¤º"è¯­æ–‡"</li>
                <li>å¦‚æœæ˜¾ç¤ºé”™è¯¯ï¼ŒæŒ‰Ctrl+F5å¼ºåˆ¶åˆ·æ–°</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxMDAwMjMsInN1YiI6IjEifQ.R_dHdA1lUTRzyBIGxCPk6UrO7kiucBwSl3R_PHieRn8';
        
        async function createChinesePlan() {
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = '<div style="color: blue;">æ­£åœ¨åˆ›å»ºè¯­æ–‡å­¦ä¹ è®¡åˆ’...</div>';
            
            const planData = {
                title: `è¯­æ–‡è®¡åˆ’ ${new Date().toLocaleTimeString()}`,
                description: "éªŒè¯å­¦ç§‘æ˜¾ç¤ºçš„è¯­æ–‡è®¡åˆ’",
                subjects: ["chinese"],
                priority: "medium", 
                duration_days: 5,
                daily_time: 40,
                tasks: [
                    { title: "è¯­æ–‡é˜…è¯»ç»ƒä¹ ", subject: "chinese", estimatedTime: 20 },
                    { title: "è¯­æ–‡å†™ä½œè®­ç»ƒ", subject: "chinese", estimatedTime: 20 }
                ],
                estimated_time: 40
            };
            
            try {
                const response = await fetch(`${API_BASE}/student/study-plan-create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = `
                        <div class="success">
                            <h3>âœ… è¯­æ–‡å­¦ä¹ è®¡åˆ’åˆ›å»ºæˆåŠŸ</h3>
                            <p><strong>è®¡åˆ’ID:</strong> ${result.plan_id}</p>
                            <p><strong>æ ‡é¢˜:</strong> ${result.title}</p>
                            <p>ç°åœ¨è¯·æ£€æŸ¥å­¦ç§‘æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®</p>
                        </div>
                    `;
                    
                    // è‡ªåŠ¨æ£€æŸ¥æ˜¾ç¤º
                    setTimeout(() => {
                        checkCurrentDisplay();
                    }, 1000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function createMathPlan() {
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = '<div style="color: blue;">æ­£åœ¨åˆ›å»ºæ•°å­¦å­¦ä¹ è®¡åˆ’...</div>';
            
            const planData = {
                title: `æ•°å­¦è®¡åˆ’ ${new Date().toLocaleTimeString()}`,
                description: "éªŒè¯å­¦ç§‘æ˜¾ç¤ºçš„æ•°å­¦è®¡åˆ’",
                subjects: ["math"],
                priority: "medium",
                duration_days: 5,
                daily_time: 45,
                tasks: [
                    { title: "æ•°å­¦è®¡ç®—ç»ƒä¹ ", subject: "math", estimatedTime: 25 },
                    { title: "æ•°å­¦åº”ç”¨é¢˜", subject: "math", estimatedTime: 20 }
                ],
                estimated_time: 45
            };
            
            try {
                const response = await fetch(`${API_BASE}/student/study-plan-create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = `
                        <div class="success">
                            <h3>âœ… æ•°å­¦å­¦ä¹ è®¡åˆ’åˆ›å»ºæˆåŠŸ</h3>
                            <p><strong>è®¡åˆ’ID:</strong> ${result.plan_id}</p>
                            <p><strong>æ ‡é¢˜:</strong> ${result.title}</p>
                            <p>ç°åœ¨è¯·æ£€æŸ¥å­¦ç§‘æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        checkCurrentDisplay();
                    }, 1000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function checkCurrentDisplay() {
            const apiDiv = document.getElementById('apiData');
            const frontendDiv = document.getElementById('frontendDisplay');
            
            apiDiv.innerHTML = '<div style="color: blue;">æ£€æŸ¥ä¸­...</div>';
            frontendDiv.innerHTML = '<div style="color: blue;">æ£€æŸ¥ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/student/study-plan`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                const subjects = data.subjects || [];
                
                // æ˜¾ç¤ºAPIæ•°æ®
                let apiSubjects = subjects.map(s => {
                    const subjectClass = s.subject === 'è¯­æ–‡' ? 'chinese-subject' : 
                                        s.subject === 'æ•°å­¦' ? 'math-subject' : 
                                        s.subject === 'åŒ–å­¦' ? 'chemistry-subject' : '';
                    
                    return `
                    <div class="subject-card ${subjectClass}">
                        <strong>${s.subject}</strong><br>
                        ä»»åŠ¡: ${s.completed}/${s.total}<br>
                        è¿›åº¦: ${(s.progress * 100).toFixed(1)}%
                    </div>
                    `;
                }).join('');
                
                if (subjects.length === 0) {
                    apiSubjects = '<div class="warning">âš ï¸ æ²¡æœ‰å­¦ç§‘æ•°æ®</div>';
                }
                
                apiDiv.innerHTML = `
                    <div>
                        <p><strong>è®¡åˆ’:</strong> ${data.title}</p>
                        <p><strong>å­¦ç§‘æ•°é‡:</strong> ${subjects.length}</p>
                        ${apiSubjects}
                    </div>
                `;
                
                // æ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºæ£€æŸ¥
                const expectedSubject = subjects.length > 0 ? subjects[0].subject : 'æ— ';
                const displayStatus = subjects.length > 0 ? 'success' : 'warning';
                
                frontendDiv.innerHTML = `
                    <div class="${displayStatus}">
                        <p><strong>åº”è¯¥æ˜¾ç¤ºçš„å­¦ç§‘:</strong> ${expectedSubject}</p>
                        <p><strong>æ£€æŸ¥æ–¹æ³•:</strong></p>
                        <ol style="font-size: 14px; margin: 10px 0;">
                            <li>æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢</li>
                            <li>æŸ¥çœ‹"ğŸ“š å­¦ç§‘è®¡åˆ’"åŒºåŸŸ</li>
                            <li>ç¡®è®¤æ˜¾ç¤ºçš„æ˜¯ <strong>${expectedSubject}</strong></li>
                            <li>å¦‚æœä¸å¯¹ï¼ŒæŒ‰Ctrl+F5åˆ·æ–°</li>
                        </ol>
                        
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>å¦‚æœæ˜¾ç¤ºé”™è¯¯çš„åŸå› :</strong><br>
                            â€¢ æµè§ˆå™¨ç¼“å­˜äº†æ—§æ•°æ®<br>
                            â€¢ é¡µé¢JavaScriptæœªæ­£ç¡®æ‰§è¡Œ<br>
                            â€¢ ç½‘ç»œè¯·æ±‚å¤±è´¥æˆ–å»¶è¿Ÿ
                        </div>
                    </div>
                `;
                
            } catch (error) {
                apiDiv.innerHTML = `<div class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                frontendDiv.innerHTML = `<div class="error">âŒ æ— æ³•æ£€æŸ¥å‰ç«¯æ˜¾ç¤º</div>`;
            }
        }
        
        function forceRefresh() {
            // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜æ•°æ®
            localStorage.removeItem('studyPlanCache');
            sessionStorage.clear();
            
            alert('å·²æ¸…é™¤æœ¬åœ°ç¼“å­˜ã€‚\n\nè¯·æ‰‹åŠ¨:\n1. æ‰“å¼€å­¦ä¹ è®¡åˆ’é¡µé¢\n2. æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°\n3. æ£€æŸ¥å­¦ç§‘æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®');
        }
    </script>
</body>
</html>