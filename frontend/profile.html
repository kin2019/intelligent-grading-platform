<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - ä¸ªäººä¸­å¿ƒ</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-header {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        
        
        
        
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }
        
        .stat-item {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 6px;
            line-height: 1.2;
            color: #26a69a;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
        }
        
        
        /* VIPçŠ¶æ€å¡ç‰‡ */
        .vip-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            color: #333;
            display: none;
            box-shadow: 0 8px 32px rgba(255, 183, 71, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .vip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(255, 183, 71, 0.4);
        }
        
        .vip-card.active {
            display: block;
        }
        
        .vip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .vip-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vip-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .vip-info {
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .vip-benefits {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* åŠŸèƒ½èœå• */
        .menu-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .menu-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(102, 126, 234, 0.08);
            position: relative;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .menu-item:hover::before {
            opacity: 1;
        }
        
        .menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 28px;
        }
        
        .menu-item:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
        }
        
        .menu-arrow {
            font-size: 14px;
            color: #ccc;
        }
        
        .menu-badge {
            position: absolute;
            top: 12px;
            right: 40px;
            background: #ff3b30;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è®¾ç½®å¼€å…³ */
        .setting-toggle {
            width: 44px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .setting-toggle.active {
            background: #4CAF50;
        }
        
        .toggle-handle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .setting-toggle.active .toggle-handle {
            transform: translateX(20px);
        }
        
        /* ç‰ˆæœ¬ä¿¡æ¯ */
        .version-info {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
            margin-bottom: 80px;
        }
        
        .version-text {
            margin-bottom: 8px;
        }
        
        .copyright {
            margin-bottom: 8px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        
        .modal-text {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%) !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(38, 166, 154, 0.3) !important;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2bbbad 0%, #00796b 100%) !important;
            box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4) !important;
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* ModalåŸºæœ¬æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ·å¼å·²ç§»è‡³ç»Ÿä¸€ç»„ä»¶ bottom-navigation.css */
        
        /* å¤´åƒç¼–è¾‘ç›¸å…³æ ·å¼ */
        .avatar-edit-content {
            padding: 20px 0;
        }
        
        .current-avatar-preview {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 8px;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-preview-label {
            font-size: 12px;
            color: #666;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .upload-option {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-option:hover {
            border-color: #007AFF;
            background: #f8f9ff;
        }
        
        .upload-option.selected {
            border-color: #007AFF;
            background: #f0f5ff;
        }
        
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .upload-desc {
            font-size: 12px;
            color: #666;
        }
        
        .default-avatars {
            padding: 16px 0;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .default-avatar-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            justify-self: center;
        }
        
        .default-avatar-item:hover {
            transform: scale(1.1);
            border-color: #007AFF;
        }
        
        .default-avatar-item.selected {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* ä¸Šä¼ è¿›åº¦ */
        .upload-progress {
            margin-top: 16px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        /* å­©å­å¡ç‰‡æ ·å¼ */
        .child-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        
        .child-item:last-child {
            border-bottom: none;
        }
        
        .child-item:hover {
            background: #f8f9fa;
        }
        
        .child-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .child-info {
            flex: 1;
        }
        
        .child-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .child-details {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .child-grade {
            background: #e3f2fd;
            color: #1976D2;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .child-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 3px;
            background: #4CAF50;
        }
        
        .status-dot.inactive {
            background: #ff9800;
        }
        
        .child-stats {
            text-align: right;
            flex-shrink: 0;
        }
        
        .child-score {
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 2px;
        }
        
        .child-score.low {
            color: #ff9800;
        }
        
        .child-time {
            font-size: 11px;
            color: #999;
        }
        
        .section-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 2;
            padding: 16px 0 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        /* ä¸­ç­‰å±å¹•é€‚é… */
        @media (max-width: 768px) and (min-width: 481px) {
            .user-stats {
                gap: 42px;
            }
        }
        
        /* åŠ è½½çŠ¶æ€ä¼˜åŒ– */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .user-stats {
                gap: 36px;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .default-avatar-item {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
    <script src="/frontend/js/global-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">ä¸ªäººä¸­å¿ƒ</div>
                </div>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="user-header">
                <div class="avatar-container">
                    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                    <div class="avatar-edit" onclick="editAvatar()">âœï¸</div>
                </div>
                
                <div class="user-name" id="userName">æ­£åœ¨åŠ è½½...</div>
                <div class="user-info" id="userInfo">å­¦ç”Ÿ Â· äº”å¹´çº§</div>
                
                <div class="user-stats">
                    <!-- å­¦ç”Ÿç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="student-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="totalHomework">0</div>
                            <div class="stat-label">æ€»ä½œä¸š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyRate">0%</div>
                            <div class="stat-label">æ­£ç¡®ç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="studyDays">0</div>
                            <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                        </div>
                    </div>
                    
                    <!-- å®¶é•¿ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="parent-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="childrenCount">0</div>
                            <div class="stat-label">å­©å­æ•°é‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="todayHomeworkCount">0</div>
                            <div class="stat-label">ä»Šæ—¥ä½œä¸š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="averageAccuracy">0%</div>
                            <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- VIPå¡ç‰‡ -->
            <div class="vip-card" id="vipCard">
                <div class="vip-header">
                    <div class="vip-title">
                        ğŸ‘‘ VIPä¼šå‘˜
                        <div class="vip-badge">è‡³å°Šç‰ˆ</div>
                    </div>
                </div>
                <div class="vip-info">æ— é™æ¬¡æ‰¹æ”¹ Â· ä¸“å±å®¢æœ Â· è¯¦ç»†è§£æ</div>
                <div class="vip-benefits">æœ‰æ•ˆæœŸè‡³: <span id="vipExpireDate">2025-12-31</span></div>
            </div>
            
            <!-- å­¦ä¹ ç®¡ç† / å­©å­ç®¡ç† -->
            <div class="menu-section" id="mainFunctionSection">
                <!-- å­¦ç”ŸåŠŸèƒ½ -->
                <div class="student-functions" style="display: none;">
                    <div class="menu-item" onclick="goToErrorBook()">
                        <div class="menu-icon">ğŸ“š</div>
                        <div class="menu-content">
                            <div class="menu-title">æˆ‘çš„é”™é¢˜æœ¬</div>
                            <div class="menu-desc">æŸ¥çœ‹å’Œå¤ä¹ é”™é¢˜</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToStudyPlan()">
                        <div class="menu-icon">ğŸ“‹</div>
                        <div class="menu-content">
                            <div class="menu-title">å­¦ä¹ è®¡åˆ’</div>
                            <div class="menu-desc">åˆ¶å®šå’Œç®¡ç†å­¦ä¹ è®¡åˆ’</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToHomeworkHistory()">
                        <div class="menu-icon">ğŸ“</div>
                        <div class="menu-content">
                            <div class="menu-title">ä½œä¸šè®°å½•</div>
                            <div class="menu-desc">æŸ¥çœ‹å†å²æ‰¹æ”¹è®°å½•</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                </div>
                
                <!-- å®¶é•¿åŠŸèƒ½ -->
                <div class="parent-functions" style="display: none;">
                    <div class="menu-item" onclick="goToChildrenManagement()">
                        <div class="menu-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                        <div class="menu-content">
                            <div class="menu-title">å­©å­ç®¡ç†</div>
                            <div class="menu-desc">æŸ¥çœ‹å’Œç®¡ç†å­©å­ä¿¡æ¯</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToLearningReports()">
                        <div class="menu-icon">ğŸ“Š</div>
                        <div class="menu-content">
                            <div class="menu-title">å­¦ä¹ æŠ¥å‘Š</div>
                            <div class="menu-desc">æŸ¥çœ‹å­©å­çš„å­¦ä¹ åˆ†ææŠ¥å‘Š</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToParentBind()">
                        <div class="menu-icon">ğŸ”—</div>
                        <div class="menu-content">
                            <div class="menu-title">è´¦å·ç»‘å®š</div>
                            <div class="menu-desc">ç»‘å®šæˆ–ç®¡ç†å­©å­è´¦å·</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                </div>
            </div>
            
            <!-- å­©å­åˆ—è¡¨ï¼ˆä»…å®¶é•¿å¯è§ï¼‰ -->
            <div class="menu-section" id="childrenSection" style="display: none;">
                <div class="section-header">
                    <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px; padding: 0 20px;">ğŸ‘¶ æˆ‘çš„å­©å­</h3>
                </div>
                <div id="childrenList">
                    <!-- å­©å­åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- è´¦æˆ·ç®¡ç† -->
            <div class="menu-section">
                <div class="menu-item" onclick="goToVipCenter()">
                    <div class="menu-icon">ğŸ’</div>
                    <div class="menu-content">
                        <div class="menu-title">ä¼šå‘˜ä¸­å¿ƒ</div>
                        <div class="menu-desc">å‡çº§VIPï¼Œäº«å—æ›´å¤šç‰¹æƒ</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="goToParentBind()">
                    <div class="menu-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                    <div class="menu-content">
                        <div class="menu-title">å®¶é•¿ç»‘å®š</div>
                        <div class="menu-desc">ç»‘å®šå®¶é•¿è´¦å·ï¼Œå®æ—¶åŒæ­¥å­¦ä¹ æƒ…å†µ</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="editProfile()">
                    <div class="menu-icon">âš™ï¸</div>
                    <div class="menu-content">
                        <div class="menu-title">ä¸ªäººèµ„æ–™</div>
                        <div class="menu-desc">ä¿®æ”¹æ˜µç§°ã€å¹´çº§ç­‰ä¿¡æ¯</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
            </div>
            
            <!-- åº”ç”¨è®¾ç½® -->
            <div class="menu-section">
                <div class="menu-item" onclick="toggleNotification()">
                    <div class="menu-icon">ğŸ””</div>
                    <div class="menu-content">
                        <div class="menu-title">æ¶ˆæ¯é€šçŸ¥</div>
                        <div class="menu-desc">å­¦ä¹ æé†’å’Œç³»ç»Ÿé€šçŸ¥</div>
                    </div>
                    <div class="setting-toggle active" id="notificationToggle">
                        <div class="toggle-handle"></div>
                    </div>
                </div>
            </div>
            
            <!-- å¸®åŠ©æ”¯æŒ -->
            <div class="menu-section">
                <div class="menu-item" onclick="contactSupport()">
                    <div class="menu-icon">ğŸ’¬</div>
                    <div class="menu-content">
                        <div class="menu-title">å®¢æœæ”¯æŒ</div>
                        <div class="menu-desc">åœ¨çº¿å®¢æœï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="goToAbout()">
                    <div class="menu-icon">â„¹ï¸</div>
                    <div class="menu-content">
                        <div class="menu-title">å…³äºæˆ‘ä»¬</div>
                        <div class="menu-desc">äº†è§£ZYJCæ™ºèƒ½æ‰¹æ”¹</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
            </div>
            
            <!-- é€€å‡ºç™»å½• -->
            <div class="menu-section">
                <div class="menu-item" onclick="logout()" style="color: #f44336;">
                    <div class="menu-icon">ğŸšª</div>
                    <div class="menu-content">
                        <div class="menu-title" style="color: #f44336;">é€€å‡ºç™»å½•</div>
                        <div class="menu-desc">é€€å‡ºå½“å‰è´¦å·</div>
                    </div>
                </div>
            </div>
            
            <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
            <div class="version-info">
                <div class="version-text">ZYJCæ™ºèƒ½æ‰¹æ”¹ v1.0.0</div>
                <div class="copyright">Â© 2025 ZYJCå›¢é˜Ÿ</div>
                <div>è®©å­¦ä¹ æ›´æ™ºèƒ½ï¼Œè®©æˆé•¿æ›´é«˜æ•ˆ</div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªé€šè¿‡ç»Ÿä¸€ç»„ä»¶è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºå¯¹åº”å¯¼èˆª -->
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ç¡®è®¤æ“ä½œ</div>
            <div class="modal-text" id="modalText">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="confirmAction()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- å¤´åƒç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="avatarModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title">ç¼–è¾‘å¤´åƒ</div>
            <div class="avatar-edit-content">
                <!-- å½“å‰å¤´åƒé¢„è§ˆ -->
                <div class="current-avatar-preview">
                    <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                    <div class="avatar-preview-label">å½“å‰å¤´åƒ</div>
                </div>
                
                <!-- ä¸Šä¼ é€‰é¡¹ -->
                <div class="upload-options">
                    <div class="upload-option" onclick="selectAvatarFile()">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">é€‰æ‹©æœ¬åœ°å›¾ç‰‡</div>
                        <div class="upload-desc">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§5MB</div>
                    </div>
                    
                    <div class="upload-option" onclick="selectDefaultAvatar()">
                        <div class="upload-icon">ğŸ˜Š</div>
                        <div class="upload-text">é€‰æ‹©é»˜è®¤å¤´åƒ</div>
                        <div class="upload-desc">ç³»ç»Ÿæä¾›çš„å¤´åƒå›¾æ ‡</div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeAvatarModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-primary" id="saveAvatarBtn" onclick="saveAvatar()" disabled>ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é»˜è®¤å¤´åƒé€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="defaultAvatarModal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-title">é€‰æ‹©é»˜è®¤å¤´åƒ</div>
            <div class="default-avatars">
                <div class="avatar-grid" id="avatarGrid">
                    <!-- é»˜è®¤å¤´åƒå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeDefaultAvatarModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è®¤è¯å·¥å…·ç±» -->
    <script src="/frontend/js/auth-utils.js"></script>
    
    <!-- åº•éƒ¨å¯¼èˆªç»„ä»¶ -->
    <link rel="stylesheet" href="/frontend/css/bottom-navigation.css">
    <script src="/frontend/js/navigation-config.js"></script>
    <script src="/frontend/js/bottom-navigation.js"></script>
    
    <script>
        console.log('=== SCRIPT LOADING ===');
        
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        let pendingAction = null;
        
        // ä¼˜åŒ–ï¼šæ·»åŠ åŠ è½½çŠ¶æ€æ§åˆ¶
        let isLoading = false;
        let lastLoadTime = 0;
        const LOAD_DEBOUNCE_TIME = 2000; // 2ç§’é˜²æŠ–
        
        console.log('Variables initialized, API_BASE:', API_BASE);

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢');
            try {
                initPage();
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });
        
        // å¤‡ç”¨åˆå§‹åŒ–ï¼ˆé˜²æ­¢DOMContentLoadedäº‹ä»¶æœªè§¦å‘ï¼‰
        window.addEventListener('load', function() {
            console.log('window loadäº‹ä»¶è§¦å‘');
            if (!document.querySelector('#userName').textContent.includes('æµ‹è¯•ç”¨æˆ·')) {
                console.log('ç”¨æˆ·åæœªæ›´æ–°ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–');
                try {
                    initPage();
                } catch (error) {
                    console.error('å¤‡ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }
        });
        
        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ® - å¢åŠ é˜²æŠ–å’Œé¢‘ç‡é™åˆ¶
        let lastFocusRefresh = 0;
        window.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastFocusRefresh < 30000) { // 30ç§’å†…ä¸é‡å¤åˆ·æ–°
                console.log('é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³30ç§’ï¼Œè·³è¿‡');
                return;
            }
            console.log('é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œåˆ·æ–°ç”¨æˆ·æ•°æ®');
            lastFocusRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 500); // å¢åŠ å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°æ•°æ® - å¢åŠ é˜²æŠ–å’Œé¢‘ç‡é™åˆ¶
        let lastVisibilityRefresh = 0;
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = Date.now();
                if (now - lastVisibilityRefresh < 30000) { // 30ç§’å†…ä¸é‡å¤åˆ·æ–°
                    console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³30ç§’ï¼Œè·³è¿‡');
                    return;
                }
                console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œåˆ·æ–°ç”¨æˆ·æ•°æ®');
                lastVisibilityRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role) {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500); // å¢åŠ å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
                }
            }
        });
        
        // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶ - å¢åŠ é˜²æŠ–
        let lastInfoUpdateRefresh = 0;
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶:', event.detail);
            const now = Date.now();
            if (now - lastInfoUpdateRefresh < 5000) { // 5ç§’å†…ä¸é‡å¤åˆ·æ–°
                console.log('ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³5ç§’ï¼Œè·³è¿‡');
                return;
            }
            lastInfoUpdateRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 300);
            }
        });
        
        // ç›‘å¬localStorageä¸­çš„å­å¥³æ•°æ®æ›´æ–°äº‹ä»¶ - å¢åŠ é˜²æŠ–
        let lastStorageRefresh = 0;
        window.addEventListener('storage', function(event) {
            if (event.key === 'childDataUpdated') {
                const now = Date.now();
                if (now - lastStorageRefresh < 10000) { // 10ç§’å†…ä¸é‡å¤åˆ·æ–°
                    console.log('æ”¶åˆ°å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³10ç§’ï¼Œè·³è¿‡');
                    return;
                }
                console.log('æ”¶åˆ°å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥ï¼Œåˆ·æ–°é¡µé¢æ•°æ®');
                lastStorageRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role === 'parent') {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500);
                }
            }
        });
        
        // ç›‘å¬manage-childrené¡µé¢çš„ç›´æ¥é€šçŸ¥
        window.addEventListener('childDataChanged', function(event) {
            console.log('æ”¶åˆ°å­å¥³æ•°æ®å˜æ›´äº‹ä»¶');
            const role = AuthUtils.getCurrentUserRole();
            if (role === 'parent') {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 200);
            }
        });

        function initPage() {
            console.log('=== åˆå§‹åŒ–é¡µé¢ ===');
            
            try {
                // ç»‘å®štokenè·å–
                token = localStorage.getItem('token');
                let role = localStorage.getItem('role');
                
                console.log('åˆå§‹åŒ–é¡µé¢ - Token:', token ? 'OK' : 'NONE', 'Role:', role);
                
                if (!token) {
                    showToast('è¯·å…ˆç™»å½•');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 2000);
                    return;
                }
                
                // é€šè¿‡tokenåˆ¤æ–­ç”¨æˆ·è§’è‰²ï¼Œç¡®ä¿è§’è‰²æ­£ç¡®
                try {
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const userId = tokenPayload.sub;
                    console.log('Tokenä¸­çš„ç”¨æˆ·ID:', userId);
                    
                    // æ ¹æ®ç”¨æˆ·IDåˆ¤æ–­è§’è‰²ï¼šID=1æ˜¯å­¦ç”Ÿï¼ŒID=2æ˜¯å®¶é•¿
                    if (userId === '2') {
                        role = 'parent';
                        console.log('ä»Tokenæ£€æµ‹åˆ°å®¶é•¿ç”¨æˆ·');
                    } else {
                        role = 'student';
                        console.log('ä»Tokenæ£€æµ‹åˆ°å­¦ç”Ÿç”¨æˆ·');
                    }
                    
                    // æ›´æ–°localStorageä¸­çš„è§’è‰²ä¿¡æ¯
                    localStorage.setItem('role', role);
                    console.log('è§’è‰²å·²æ›´æ–°åˆ°localStorage:', role);
                    
                } catch (error) {
                    console.error('è§£æTokenå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å­¦ç”Ÿè§’è‰²:', error);
                    role = 'student';
                    localStorage.setItem('role', role);
                }
                
                // ç”Ÿæˆè§’è‰²å¯¹åº”çš„å¯¼èˆª
                generateRoleBasedNavigation();
                
                // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–é¡µé¢è¿”å›ï¼Œå¦‚æœæ˜¯åˆ™å¼ºåˆ¶åˆ·æ–°
                const returnFromPage = localStorage.getItem('returnFromPage');
                const childDataUpdated = localStorage.getItem('childDataUpdated');
                
                if (returnFromPage) {
                    console.log('ä»é¡µé¢è¿”å›:', returnFromPage);
                    localStorage.removeItem('returnFromPage');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥
                if (childDataUpdated && role === 'parent') {
                    console.log('æ£€æµ‹åˆ°å­å¥³æ•°æ®æ›´æ–°æ ‡è®°ï¼Œæ¸…é™¤å¹¶åˆ·æ–°æ•°æ®');
                    localStorage.removeItem('childDataUpdated');
                }
                
                if (returnFromPage || childDataUpdated) {
                    // å»¶è¿Ÿä¸€ç‚¹åˆ·æ–°ï¼Œç¡®ä¿é¡µé¢åŠ è½½å®Œæˆ
                    setTimeout(() => {
                        console.log('ä»å…¶ä»–é¡µé¢è¿”å›ï¼Œå¼ºåˆ¶åˆ·æ–°æ•°æ®');
                        loadUserProfile(role, true); // å¼ºåˆ¶åˆ·æ–°
                    }, 500);
                } else {
                    // æ­£å¸¸åˆå§‹åŒ–åŠ è½½
                    setTimeout(() => {
                        console.log('æ­£å¸¸åˆå§‹åŒ–åŠ è½½ç”¨æˆ·æ•°æ®');
                        loadUserProfile(role);
                    }, 100);
                }
                
                // è®¾ç½®å¤´åƒæ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨
                setTimeout(() => {
                    console.log('è®¾ç½®æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨');
                    try {
                        const avatarFileInput = document.getElementById('avatarFileInput');
                        
                        if (avatarFileInput) {
                            avatarFileInput.removeEventListener('change', handleFileSelect);
                            avatarFileInput.addEventListener('change', handleFileSelect);
                            console.log('æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å·²è®¾ç½®');
                        } else {
                            console.warn('æ–‡ä»¶è¾“å…¥å…ƒç´  avatarFileInput æš‚æœªæ‰¾åˆ°ï¼ˆå¯èƒ½è¿˜æœªæ¸²æŸ“ï¼‰');
                        }
                    } catch (listenerError) {
                        console.error('è®¾ç½®æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å¤±è´¥:', listenerError);
                    }
                }, 200);
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¸é˜»æ­¢é¡µé¢åŠ è½½
                showToast('é¡µé¢åŠ è½½é‡åˆ°é—®é¢˜ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }
        
        function generateRoleBasedNavigation() {
            console.log('ä½¿ç”¨æ–°çš„åº•éƒ¨å¯¼èˆªç»„ä»¶ç”Ÿæˆå¯¼èˆª');
            
            // ä½¿ç”¨æ–°çš„ç»Ÿä¸€ç»„ä»¶åˆå§‹åŒ–å¯¼èˆª
            const success = BottomNavigation.init({
                currentPage: 'profile',
                debug: false
            });
            
            if (success) {
                console.log('âœ… åº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('âŒ åº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–å¤±è´¥');
                // ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼Œä½¿ç”¨æ—§çš„å®ç°
                setupRoleBasedUIFallback();
            }
            
            // ç»§ç»­é…ç½®UIæ˜¾ç¤º
            const role = getCurrentUserRole();
            setupRoleBasedUI(role);
        }
        
        // ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆçš„ç®€åŒ–å¯¼èˆªåˆ›å»ºå‡½æ•°
        function setupRoleBasedUIFallback() {
            console.warn('âš ï¸ ä½¿ç”¨å¤‡ç”¨å¯¼èˆªæ–¹æ¡ˆ');
            const role = getCurrentUserRole();
            
            // åˆ›å»ºåŸºæœ¬çš„å¯¼èˆªç»“æ„
            const navItems = role === 'parent' ? [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onclick: 'goToParentHome()' },
                { icon: 'ğŸ“Š', text: 'å­¦ä¹ æŠ¥å‘Š', onclick: 'goToLearningReports()' },
                { icon: 'ğŸ‘¶', text: 'å­©å­ç®¡ç†', onclick: 'goToChildrenManagement()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onclick: 'goToProfile()', active: true }
            ] : [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onclick: 'goToStudentHome()' },
                { icon: 'ğŸ“·', text: 'æ‹ç…§æ‰¹æ”¹', onclick: 'goToHomeworkSubmit()' },
                { icon: 'ğŸ“š', text: 'é”™é¢˜æœ¬', onclick: 'goToErrorBook()' },
                { icon: 'ğŸ“‹', text: 'å­¦ä¹ è®¡åˆ’', onclick: 'goToStudyPlan()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onclick: 'goToProfile()', active: true }
            ];
            
            // åˆ›å»ºç®€å•çš„å¯¼èˆª
            const nav = document.createElement('div');
            nav.className = role === 'parent' ? 'theme-bottom-nav' : 'global-bottom-nav';
            
            // åº”ç”¨ä¸study-plan.htmlä¸€è‡´çš„å®¹å™¨æ ·å¼
            nav.style.cssText = role === 'parent' ? `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 142, 250, 0.95)) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            ` : `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            `;
            
            const itemClass = role === 'parent' ? 'theme-nav' : 'global-nav';
            nav.innerHTML = navItems.map(item => `
                <div class="${itemClass}-item ${item.active ? 'active' : ''}" ${item.onclick ? `onclick="${item.onclick}"` : ''}>
                    <div class="${itemClass}-icon">${item.icon}</div>
                    <div class="${itemClass}-text">${item.text}</div>
                </div>
            `).join('');
            
            document.body.appendChild(nav);
            
            // åº”ç”¨æŒ‰é’®æ ·å¼
            const buttons = nav.querySelectorAll(`.${itemClass}-item`);
            buttons.forEach((button, index) => {
                const isActive = button.classList.contains('active');
                
                if (role === 'parent') {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(255, 255, 255, 0.2) !important; color: white !important;' : 'background: transparent !important; color: rgba(255, 255, 255, 0.8) !important;'}
                    `;
                } else {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(76, 175, 80, 0.1) !important; color: #4CAF50 !important;' : 'background: transparent !important; color: #666 !important;'}
                    `;
                }
                
                const icon = button.querySelector(`.${itemClass}-icon`);
                const text = button.querySelector(`.${itemClass}-text`);
                if (icon) icon.style.cssText = 'font-size: 20px !important; margin-bottom: 2px !important; display: block !important;';
                if (text) text.style.cssText = 'font-size: 10px !important; line-height: 1 !important; font-weight: 500 !important;';
            });
            
            // è®¾ç½®é¡µé¢åº•éƒ¨é—´è·
            document.body.style.paddingBottom = '80px';
        }
        
        function setupRoleBasedUI(role) {
            console.log('=== è®¾ç½®åŸºäºè§’è‰²çš„UIå†…å®¹æ˜¾ç¤º ===');
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', role);
            
            // å®‰å…¨è·å–å…ƒç´ çš„å‡½æ•°
            function safeSetDisplay(selector, display, isId = false) {
                try {
                    const element = isId ? document.getElementById(selector) : document.querySelector(selector);
                    if (element) {
                        element.style.display = display;
                        console.log(`âœ… æˆåŠŸè®¾ç½® ${selector} æ˜¾ç¤ºçŠ¶æ€ä¸º ${display}`);
                        return true;
                    } else {
                        console.warn(`âš ï¸  æœªæ‰¾åˆ°å…ƒç´ : ${selector}`);
                        return false;
                    }
                } catch (error) {
                    console.error(`âŒ è®¾ç½® ${selector} æ ·å¼æ—¶å‡ºé”™:`, error);
                    return false;
                }
            }
            
            // æ ¹æ®è§’è‰²é…ç½®UIæ˜¾ç¤ºå†…å®¹
            if (role === 'student') {
                console.log('ğŸ“ é…ç½®å­¦ç”Ÿèº«ä»½UI...');
                
                // æ˜¾ç¤ºå­¦ç”Ÿç›¸å…³å†…å®¹
                safeSetDisplay('.student-stats', 'flex');
                safeSetDisplay('.student-functions', 'block');
                safeSetDisplay('.parent-stats', 'none');
                safeSetDisplay('.parent-functions', 'none');
                safeSetDisplay('childrenSection', 'none', true);
                
            } else if (role === 'parent') {
                console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ é…ç½®å®¶é•¿èº«ä»½UI...');
                
                // æ˜¾ç¤ºå®¶é•¿ç›¸å…³å†…å®¹
                safeSetDisplay('.parent-stats', 'flex');
                safeSetDisplay('.parent-functions', 'block');
                safeSetDisplay('.student-stats', 'none');
                safeSetDisplay('.student-functions', 'none');
                safeSetDisplay('childrenSection', 'block', true);
                
            } else {
                console.error('âŒ æœªçŸ¥çš„ç”¨æˆ·è§’è‰²:', role);
                return;
            }
            
            console.log(`âœ… ${role}èº«ä»½UIé…ç½®å®Œæˆ`);
        }

        // å¯¼èˆªç›¸å…³åŠŸèƒ½å‡½æ•° - ä¸åº•éƒ¨å¯¼èˆªç»„ä»¶é…åˆä½¿ç”¨
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        function goToProfile() {
            // å½“å‰å°±æ˜¯profileé¡µé¢ï¼Œåˆ·æ–°é¡µé¢
            window.location.reload();
        }

        async function loadUserProfile(role, force = false) {
            // é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹é‡å¤è¯·æ±‚
            const now = Date.now();
            if (!force && (isLoading || (now - lastLoadTime < LOAD_DEBOUNCE_TIME))) {
                console.log('è¯·æ±‚è¢«é˜²æŠ–æ‹¦æˆªï¼Œè·ä¸Šæ¬¡åŠ è½½:', now - lastLoadTime, 'ms');
                return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            isLoading = true;
            lastLoadTime = now;
            
            try {
                console.log('å¼€å§‹åŠ è½½ç”¨æˆ·èµ„æ–™ï¼Œè§’è‰²:', role);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoadingState();
                
                // å¹¶è¡Œè¯·æ±‚ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
                const requests = [];
                
                // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¯·æ±‚
                requests.push(
                    fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // ç»Ÿè®¡æ•°æ®è¯·æ±‚
                if (role === 'student') {
                    requests.push(
                        fetch(`${API_BASE}/student/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                } else if (role === 'parent') {
                    requests.push(
                        fetch(`${API_BASE}/parent/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                }
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
                const responses = await Promise.all(requests);
                const [userResponse, statsResponse] = responses;
                
                console.log('APIå“åº”çŠ¶æ€:', {
                    user: userResponse.status,
                    stats: statsResponse?.status
                });
                
                // å¤„ç†ç”¨æˆ·ä¿¡æ¯
                if (userResponse.ok) {
                    userInfo = await userResponse.json();
                    console.log('è·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfo);
                    
                    // å¤„ç†ç»Ÿè®¡æ•°æ®
                    let statsData = null;
                    if (statsResponse?.ok) {
                        statsData = await statsResponse.json();
                        console.log('è·å–åˆ°ç»Ÿè®¡æ•°æ®:', statsData);
                    } else {
                        console.error('ç»Ÿè®¡æ•°æ®APIè°ƒç”¨å¤±è´¥:', statsResponse?.status, statsResponse?.statusText);
                        // ä½¿ç”¨é»˜è®¤ç»Ÿè®¡æ•°æ®
                        statsData = getDefaultStatsData(role);
                    }
                    
                    // æ‰¹é‡æ›´æ–°UI
                    updateUserInterface(userInfo, statsData, role);
                    
                    // æ›´æ–°localStorage
                    localStorage.setItem('user', JSON.stringify(userInfo));
                    
                    // è§¦å‘æ›´æ–°äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
                    
                    console.log('ç”¨æˆ·èµ„æ–™åŠ è½½å®Œæˆäº:', new Date().toLocaleTimeString());
                    
                } else {
                    console.error('ç”¨æˆ·ä¿¡æ¯APIè°ƒç”¨å¤±è´¥:', userResponse.status, userResponse.statusText);
                    showDefaultUserData();
                    return;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                showDefaultUserData();
            } finally {
                isLoading = false;
                hideLoadingState();
            }
        }
        
        async function loadStudentStats() {
            try {
                const statsResponse = await fetch(`${API_BASE}/student/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('å­¦ç”Ÿç»Ÿè®¡APIå“åº”çŠ¶æ€:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('è·å–åˆ°å­¦ç”Ÿç»Ÿè®¡:', statsData);
                    updateStudentStats(statsData);
                } else {
                    console.error('å­¦ç”Ÿç»Ÿè®¡APIè°ƒç”¨å¤±è´¥:', statsResponse.status, statsResponse.statusText);
                    updateStudentStats({
                        daily_stats: {
                            today_corrections: 0,
                            accuracy_rate: 0,
                            study_time: 0
                        },
                        recent_homework: [],
                        error_summary: {
                            unreviewed_count: 0
                        }
                    });
                }
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿç»Ÿè®¡å¼‚å¸¸:', error);
                updateStudentStats({});
            }
        }
        
        async function loadParentStats() {
            try {
                const statsResponse = await fetch(`${API_BASE}/parent/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('å®¶é•¿ç»Ÿè®¡APIå“åº”çŠ¶æ€:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('è·å–åˆ°å®¶é•¿ç»Ÿè®¡:', statsData);
                    updateParentStats(statsData);
                } else {
                    console.error('å®¶é•¿ç»Ÿè®¡APIè°ƒç”¨å¤±è´¥:', statsResponse.status, statsResponse.statusText);
                    updateParentStats({
                        today_stats: { homeworkCount: 0, accuracy: 0 },
                        children: [],
                        weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                    });
                }
            } catch (error) {
                console.error('è·å–å®¶é•¿ç»Ÿè®¡å¼‚å¸¸:', error);
                updateParentStats({});
            }
        }

        // åŠ è½½çŠ¶æ€ç®¡ç†
        function showLoadingState() {
            // æ˜¾ç¤ºç”¨æˆ·ååŠ è½½çŠ¶æ€
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = 'åŠ è½½ä¸­...';
                userNameEl.style.opacity = '0.6';
            }
            
            // æ˜¾ç¤ºå¤´åƒåŠ è½½çŠ¶æ€
            const userAvatarEl = document.getElementById('userAvatar');
            if (userAvatarEl) {
                userAvatarEl.innerHTML = 'â³';
                userAvatarEl.style.opacity = '0.6';
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®åŠ è½½çŠ¶æ€
            const statElements = document.querySelectorAll('.stat-number');
            statElements.forEach(el => {
                el.textContent = '...';
                el.style.opacity = '0.6';
            });
        }
        
        function hideLoadingState() {
            // æ¢å¤æ­£å¸¸é€æ˜åº¦å¹¶æ·»åŠ æ·¡å…¥æ•ˆæœ
            const elements = [
                document.getElementById('userName'),
                document.getElementById('userAvatar'),
                ...document.querySelectorAll('.stat-number')
            ];
            
            elements.forEach(el => {
                if (el) {
                    el.style.opacity = '1';
                    el.classList.add('fade-in');
                    
                    // åŠ¨ç”»å®Œæˆåç§»é™¤ç±»
                    setTimeout(() => {
                        el.classList.remove('fade-in');
                    }, 300);
                }
            });
        }
        
        // è·å–é»˜è®¤ç»Ÿè®¡æ•°æ®
        function getDefaultStatsData(role) {
            if (role === 'student') {
                return {
                    daily_stats: {
                        today_corrections: 0,
                        accuracy_rate: 0,
                        study_time: 0
                    },
                    recent_homework: [],
                    error_summary: {
                        unreviewed_count: 0
                    }
                };
            } else if (role === 'parent') {
                return {
                    today_stats: { homeworkCount: 0, accuracy: 0 },
                    children: [],
                    weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                };
            }
            return {};
        }
        
        // æ‰¹é‡æ›´æ–°UIæ¥å£
        function updateUserInterface(userInfo, statsData, role) {
            // æ‰¹é‡æ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
            const updates = [];
            
            // å‡†å¤‡ç”¨æˆ·ä¿¡æ¯æ›´æ–°
            updates.push(() => updateUserProfile(userInfo));
            
            // å‡†å¤‡ç»Ÿè®¡æ•°æ®æ›´æ–°
            if (role === 'student') {
                updates.push(() => updateStudentStats(statsData));
            } else if (role === 'parent') {
                updates.push(() => updateParentStats(statsData));
            }
            
            // æ‰¹é‡æ‰§è¡Œæ›´æ–°ï¼Œå‡å°‘é‡æ’é‡ç»˜
            requestAnimationFrame(() => {
                updates.forEach(update => update());
            });
        }

        function showDefaultUserData() {
            // æ˜¾ç¤ºé»˜è®¤çš„ç©ºç™½ç”¨æˆ·æ•°æ®
            const defaultUser = {
                id: 0,
                nickname: 'ç”¨æˆ·',
                role: 'student',
                grade: 'æœªè®¾ç½®',
                avatar_url: null,
                is_vip: false,
                vip_expire_time: null,
                daily_quota: 0,
                daily_used: 0
            };
            
            const role = getCurrentUserRole();
            const defaultStats = getDefaultStatsData(role);
            
            updateUserInterface(defaultUser, defaultStats, role);
        }

        function updateUserProfile(user) {
            console.log('=== å¼€å§‹æ›´æ–°ç”¨æˆ·èµ„æ–™ ===');
            console.log('æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼Œç”¨æˆ·æ•°æ®:', user);
            
            const userNameEl = document.getElementById('userName');
            const userInfoEl = document.getElementById('userInfo');
            const userAvatarEl = document.getElementById('userAvatar');
            
            console.log('DOMå…ƒç´ æ£€æŸ¥:', {
                userNameEl: !!userNameEl,
                userInfoEl: !!userInfoEl,
                userAvatarEl: !!userAvatarEl
            });
            
            if (userNameEl) {
                const newName = user.nickname || 'ç”¨æˆ·';
                console.log('å‡†å¤‡æ›´æ–°ç”¨æˆ·åä»:', userNameEl.textContent, 'åˆ°:', newName);
                
                // ä¼˜åŒ–ï¼šåªæœ‰åœ¨å†…å®¹çœŸçš„å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°DOM
                if (userNameEl.textContent !== newName) {
                    userNameEl.textContent = newName;
                    console.log('ç”¨æˆ·åå·²æ›´æ–°ä¸º:', newName);
                } else {
                    console.log('ç”¨æˆ·åæ— éœ€æ›´æ–°ï¼Œå†…å®¹ç›¸åŒ');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°userNameå…ƒç´ ï¼');
            }
            
            if (userInfoEl) {
                const roleText = user.role === 'student' ? 'å­¦ç”Ÿ' : user.role === 'parent' ? 'å®¶é•¿' : 'æ•™å¸ˆ';
                const gradeText = user.grade || 'æœªè®¾ç½®å¹´çº§';
                userInfoEl.textContent = `${roleText} Â· ${gradeText}`;
                console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ä¸º:', `${roleText} Â· ${gradeText}`);
            }
            
            // æ›´æ–°VIPçŠ¶æ€
            if (user.is_vip) {
                const vipCard = document.getElementById('vipCard');
                if (vipCard) {
                    vipCard.classList.add('active');
                    if (user.vip_expire_time) {
                        const expireDateEl = document.getElementById('vipExpireDate');
                        if (expireDateEl) {
                            expireDateEl.textContent = new Date(user.vip_expire_time).toLocaleDateString();
                        }
                    }
                    console.log('VIPçŠ¶æ€å·²æ›´æ–°');
                }
            }
            
            // æ›´æ–°å¤´åƒ - ä¼˜åŒ–ç‰ˆæœ¬
            if (userAvatarEl) {
                console.log('æ›´æ–°å¤´åƒï¼ŒURL:', user.avatar_url);
                setUserAvatar(userAvatarEl, user.avatar_url);
            } else {
                console.error('æ‰¾ä¸åˆ°å¤´åƒå…ƒç´  userAvatar');
            }
        }

        function updateStudentStats(stats) {
            console.log('=== æ›´æ–°å­¦ç”Ÿç»Ÿè®¡æ•°æ® ===');
            console.log('æ”¶åˆ°çš„å­¦ç”Ÿç»Ÿè®¡æ•°æ®:', stats);
            
            // æ€»ä½œä¸šæ•°ï¼šä½¿ç”¨æœ€è¿‘ä½œä¸šæ•°é‡ï¼Œè¿™ä»£è¡¨äº†è¿‘æœŸçš„å­¦ä¹ æ´»åŠ¨
            const totalHomework = stats.recent_homework ? stats.recent_homework.length : 0;
            
            // æ­£ç¡®ç‡ï¼šç›´æ¥ä»daily_statsè·å–ï¼Œåç«¯å·²ç»è®¡ç®—å¥½çš„ç™¾åˆ†æ¯”ï¼ˆå¦‚85.5%ï¼‰
            const accuracyRate = stats.daily_stats ? stats.daily_stats.accuracy_rate : 0;
            
            // å­¦ä¹ å¤©æ•°ï¼šåŸºäºç´¯è®¡å­¦ä¹ æ—¶é—´å’Œæ—¥å‡æ—¶é•¿çš„åˆç†ä¼°ç®—
            // æ ¹æ®å­¦ä¹ æ—¶é—´æ¨ç®—ç´¯è®¡å­¦ä¹ å¤©æ•°ï¼ˆæ¯å¤©30åˆ†é’Ÿä¸ºåŸºå‡†ï¼‰
            const studyTimeMinutes = stats.daily_stats ? stats.daily_stats.study_time : 0;
            let studyDays = 0;
            
            if (studyTimeMinutes > 0) {
                // å‡è®¾æ¯å¤©å¹³å‡å­¦ä¹ 30åˆ†é’Ÿï¼Œè®¡ç®—ç´¯è®¡å¤©æ•°
                const dailyAvgMinutes = 30;
                studyDays = Math.max(1, Math.ceil(studyTimeMinutes / dailyAvgMinutes));
                
                // å¦‚æœæœ‰ä½œä¸šè®°å½•ï¼Œè‡³å°‘åº”è¯¥ç­‰äºä½œä¸šå¤©æ•°
                if (totalHomework > 0) {
                    studyDays = Math.max(studyDays, totalHomework);
                }
            }
            
            console.log('å­¦ç”Ÿç»Ÿè®¡è®¡ç®—ç»“æœ:', {
                totalHomework,
                accuracyRate,
                studyTimeMinutes,
                studyDays
            });
            
            // æ›´æ–°DOMå…ƒç´ 
            const totalHomeworkEl = document.getElementById('totalHomework');
            const accuracyRateEl = document.getElementById('accuracyRate');
            const studyDaysEl = document.getElementById('studyDays');
            
            if (totalHomeworkEl) {
                totalHomeworkEl.textContent = totalHomework;
                console.log('æ€»ä½œä¸šæ•°å·²æ›´æ–°ä¸º:', totalHomework);
            }
            
            if (accuracyRateEl) {
                accuracyRateEl.textContent = accuracyRate + '%';
                console.log('æ­£ç¡®ç‡å·²æ›´æ–°ä¸º:', accuracyRate + '%');
            }
            
            if (studyDaysEl) {
                studyDaysEl.textContent = studyDays;
                console.log('å­¦ä¹ å¤©æ•°å·²æ›´æ–°ä¸º:', studyDays);
            }
            
            console.log('=== å­¦ç”Ÿç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ ===');
        }
        
        function updateParentStats(stats) {
            console.log('=== æ›´æ–°å®¶é•¿ç»Ÿè®¡æ•°æ® ===');
            console.log('æ”¶åˆ°çš„å®¶é•¿ç»Ÿè®¡æ•°æ®:', stats);
            
            // å­©å­æ•°é‡
            const childrenCount = stats.children ? stats.children.length : 0;
            
            // ä»Šæ—¥ä½œä¸šæ•°ï¼ˆæ‰€æœ‰å­©å­çš„æ€»å’Œï¼‰
            const todayHomeworkCount = stats.today_stats ? stats.today_stats.homeworkCount : 0;
            
            // å¹³å‡æ­£ç¡®ç‡ï¼ˆæ‰€æœ‰å­©å­çš„å¹³å‡å€¼ï¼‰
            const averageAccuracy = stats.today_stats ? stats.today_stats.accuracy : 0;
            
            console.log('å®¶é•¿ç»Ÿè®¡è®¡ç®—ç»“æœ:', {
                childrenCount,
                todayHomeworkCount,
                averageAccuracy
            });
            
            // æ›´æ–°DOMå…ƒç´ 
            const childrenCountEl = document.getElementById('childrenCount');
            const todayHomeworkCountEl = document.getElementById('todayHomeworkCount');
            const averageAccuracyEl = document.getElementById('averageAccuracy');
            
            if (childrenCountEl) {
                childrenCountEl.textContent = childrenCount;
                console.log('å­©å­æ•°é‡å·²æ›´æ–°ä¸º:', childrenCount);
            }
            
            if (todayHomeworkCountEl) {
                todayHomeworkCountEl.textContent = todayHomeworkCount;
                console.log('ä»Šæ—¥ä½œä¸šæ•°å·²æ›´æ–°ä¸º:', todayHomeworkCount);
            }
            
            if (averageAccuracyEl) {
                averageAccuracyEl.textContent = averageAccuracy + '%';
                console.log('å¹³å‡æ­£ç¡®ç‡å·²æ›´æ–°ä¸º:', averageAccuracy + '%');
            }
            
            // æ›´æ–°å­©å­åˆ—è¡¨
            if (stats.children) {
                updateChildrenList(stats.children);
            }
            
            console.log('=== å®¶é•¿ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ ===');
        }
        
        // ä¼˜åŒ–çš„å¤´åƒè®¾ç½®å‡½æ•°
        function setUserAvatar(element, avatarUrl, isChild = false) {
            if (!element) return;
            
            const defaultEmoji = isChild ? 'ğŸ‘¶' : 'ğŸ‘¤';
            
            if (avatarUrl && avatarUrl.startsWith('emoji:')) {
                // è¡¨æƒ…å¤´åƒ - ç›´æ¥è®¾ç½®ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚
                const emoji = avatarUrl.replace('emoji:', '');
                element.innerHTML = emoji;
                console.log('è¡¨æƒ…å¤´åƒå·²è®¾ç½®:', emoji);
                
            } else if (avatarUrl && avatarUrl.startsWith('data:image/')) {
                // base64ç¼–ç çš„å›¾ç‰‡æ•°æ® - ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚
                element.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='${defaultEmoji}';">`;
                console.log('base64å¤´åƒå·²è®¾ç½®');
                
            } else if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.includes('.jpg') || avatarUrl.includes('.png'))) {
                // å›¾ç‰‡å¤´åƒ - ä½¿ç”¨ç¼“å­˜ï¼Œåªåœ¨å¿…è¦æ—¶æ·»åŠ æ—¶é—´æˆ³
                const fullUrl = avatarUrl.startsWith('/') ? `http://localhost:8000${avatarUrl}` : avatarUrl;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶åˆ·æ–°ï¼ˆä»…åœ¨å¤´åƒåˆšæ›´æ–°æ—¶ï¼‰
                const needRefresh = sessionStorage.getItem('avatarUpdated') === 'true';
                let finalUrl = fullUrl;
                
                if (needRefresh) {
                    const separator = fullUrl.includes('?') ? '&' : '?';
                    finalUrl = `${fullUrl}${separator}t=${Date.now()}`;
                    sessionStorage.removeItem('avatarUpdated'); // æ¸…é™¤æ ‡è®°
                    console.log('å¼ºåˆ¶åˆ·æ–°å¤´åƒ:', finalUrl);
                } else {
                    console.log('ä½¿ç”¨ç¼“å­˜å¤´åƒ:', finalUrl);
                }
                
                element.innerHTML = `<img src="${finalUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="console.error('å¤´åƒåŠ è½½å¤±è´¥:', '${fullUrl}'); this.parentElement.innerHTML='${defaultEmoji}';">`;
                
            } else {
                // é»˜è®¤å¤´åƒ
                element.innerHTML = defaultEmoji;
                console.log('ä½¿ç”¨é»˜è®¤å¤´åƒ');
            }
        }

        function updateChildrenList(children) {
            console.log('=== æ›´æ–°å­©å­åˆ—è¡¨ ===');
            console.log('å­©å­æ•°æ®:', children);
            
            const childrenListEl = document.getElementById('childrenList');
            const childrenSectionEl = document.getElementById('childrenSection');
            
            if (!childrenListEl) {
                console.log('æœªæ‰¾åˆ°å­©å­åˆ—è¡¨å®¹å™¨');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            childrenListEl.innerHTML = '';
            
            if (!children || children.length === 0) {
                childrenListEl.innerHTML = '<div class="menu-item"><div class="menu-content"><div class="menu-title">æš‚æ— å­©å­ä¿¡æ¯</div><div class="menu-desc">è¯·å…ˆç»‘å®šå­©å­è´¦å·</div></div></div>';
                return;
            }
            
            // ç”Ÿæˆå­©å­å¡ç‰‡ - ä½¿ç”¨ä¼˜åŒ–åçš„å¤´åƒé€»è¾‘
            children.forEach(child => {
                const statusClass = child.status === 'å·²å®Œæˆ' ? '' : (child.status === 'è¿›è¡Œä¸­' ? 'inactive' : 'inactive');
                const scoreClass = child.todayScore >= 80 ? '' : 'low';
                
                // åˆ›å»ºå­©å­é¡¹å…ƒç´ 
                const childItem = document.createElement('div');
                childItem.className = 'child-item';
                childItem.onclick = () => goToChildDetail(child.id);
                
                // åˆ›å»ºå¤´åƒå…ƒç´ 
                const childAvatar = document.createElement('div');
                childAvatar.className = 'child-avatar';
                setUserAvatar(childAvatar, child.avatar, true);
                
                // ç»„è£…HTML
                childItem.innerHTML = `
                    <div class="child-info">
                        <div class="child-name">${child.name}</div>
                        <div class="child-details">
                            <span class="child-grade">${child.grade}</span>
                            <span class="child-status">
                                <span class="status-dot ${statusClass}"></span>
                                ${child.status}
                            </span>
                        </div>
                    </div>
                    <div class="child-stats">
                        <div class="child-score ${scoreClass}">${child.todayScore}åˆ†</div>
                        <div class="child-time">ä»Šæ—¥</div>
                    </div>
                `;
                
                // æ’å…¥å¤´åƒå…ƒç´ 
                childItem.insertBefore(childAvatar, childItem.firstChild);
                childrenListEl.appendChild(childItem);
            });
            
            // æ˜¾ç¤ºå­©å­åˆ—è¡¨éƒ¨åˆ†
            if (childrenSectionEl) {
                childrenSectionEl.style.display = 'block';
            }
            
            console.log('=== å­©å­åˆ—è¡¨æ›´æ–°å®Œæˆ ===');
        }
        
        // é”™é¢˜æœ¬æ•°é‡ç›¸å…³å‡½æ•°å·²ç§»é™¤

        // å¤´åƒç¼–è¾‘ç›¸å…³å˜é‡
        let selectedAvatarType = null; // 'file' æˆ– 'default'
        let selectedFile = null;
        let selectedDefaultAvatar = null;
        
        function editAvatar() {
            console.log('editAvatar è¢«è°ƒç”¨');
            
            // æ˜¾ç¤ºå½“å‰å¤´åƒ
            const currentAvatar = document.getElementById('userAvatar').innerHTML;
            console.log('å½“å‰å¤´åƒå†…å®¹:', currentAvatar);
            document.getElementById('avatarPreview').innerHTML = currentAvatar;
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            console.log('é‡ç½®é€‰æ‹©çŠ¶æ€');
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
            updateSaveButton();
            
            // æ˜¾ç¤ºå¤´åƒç¼–è¾‘æ¨¡æ€æ¡†
            console.log('æ˜¾ç¤ºå¤´åƒç¼–è¾‘æ¨¡æ€æ¡†');
            document.getElementById('avatarModal').style.display = 'flex';
            
            // ç¡®ä¿æ–‡ä»¶è¾“å…¥ç›‘å¬å™¨æ­£å¸¸å·¥ä½œ
            setTimeout(() => {
                const avatarFileInput = document.getElementById('avatarFileInput');
                if (avatarFileInput) {
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰
                    avatarFileInput.removeEventListener('change', handleFileSelect);
                    avatarFileInput.addEventListener('change', handleFileSelect);
                    console.log('æ¨¡æ€æ¡†ä¸­çš„æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å·²é‡æ–°è®¾ç½®');
                }
            }, 50);
        }
        
        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            
            // æ¸…ç†æ–‡ä»¶è¾“å…¥
            document.getElementById('avatarFileInput').value = '';
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
        }
        
        function selectAvatarFile() {
            console.log('selectAvatarFile è¢«è°ƒç”¨');
            const fileInput = document.getElementById('avatarFileInput');
            console.log('æ–‡ä»¶è¾“å…¥å…ƒç´ :', fileInput);
            
            if (fileInput) {
                try {
                    fileInput.click();
                    console.log('å·²è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨');
                } catch (error) {
                    console.error('è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥:', error);
                    showToast('æ–‡ä»¶é€‰æ‹©å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                showToast('æ–‡ä»¶é€‰æ‹©åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        function selectDefaultAvatar() {
            // ç”Ÿæˆé»˜è®¤å¤´åƒé€‰é¡¹
            generateDefaultAvatars();
            document.getElementById('defaultAvatarModal').style.display = 'flex';
        }
        
        function generateDefaultAvatars() {
            const avatars = ['ğŸ‘¤', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜„', 'ğŸ¥³', 'ğŸ¤—', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‹', 'ğŸ¤“', 'ğŸ§'];
            const avatarGrid = document.getElementById('avatarGrid');
            
            avatarGrid.innerHTML = '';
            
            avatars.forEach(avatar => {
                const avatarItem = document.createElement('div');
                avatarItem.className = 'default-avatar-item';
                avatarItem.textContent = avatar;
                avatarItem.onclick = () => selectDefaultAvatarItem(avatar, avatarItem);
                avatarGrid.appendChild(avatarItem);
            });
        }
        
        function selectDefaultAvatarItem(avatar, element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.default-avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰é¡¹
            element.classList.add('selected');
            selectedDefaultAvatar = avatar;
            selectedAvatarType = 'default';
            
            // æ›´æ–°é¢„è§ˆ
            document.getElementById('avatarPreview').innerHTML = avatar;
            
            // å…³é—­é»˜è®¤å¤´åƒé€‰æ‹©æ¨¡æ€æ¡†
            setTimeout(() => {
                document.getElementById('defaultAvatarModal').style.display = 'none';
                updateSaveButton();
            }, 300);
        }
        
        function closeDefaultAvatarModal() {
            document.getElementById('defaultAvatarModal').style.display = 'none';
        }
        
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ç›‘å¬å°†åœ¨initPageä¸­è®¾ç½®
        
        function handleFileSelect(event) {
            console.log('handleFileSelect è¢«è°ƒç”¨');
            const file = event.target.files[0];
            
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);
            if (!file) {
                console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            console.log('æ–‡ä»¶ä¿¡æ¯:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                console.log('æ–‡ä»¶ç±»å‹ä¸åŒ¹é…:', file.type);
                showToast('è¯·é€‰æ‹©JPGæˆ–PNGæ ¼å¼çš„å›¾ç‰‡');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                console.log('æ–‡ä»¶å¤ªå¤§:', file.size);
                showToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            
            console.log('æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œè®¾ç½®selectedFile');
            selectedFile = file;
            selectedAvatarType = 'file';
            console.log('è®¾ç½®åçš„çŠ¶æ€:', { selectedAvatarType, selectedFile: selectedFile?.name });
            
            // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œæ›´æ–°é¢„è§ˆ');
                const previewContainer = document.getElementById('avatarPreview');
                console.log('é¢„è§ˆå®¹å™¨:', previewContainer);
                
                if (previewContainer) {
                    previewContainer.innerHTML = 
                        `<img src="${e.target.result}" alt="å¤´åƒé¢„è§ˆ" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    console.log('é¢„è§ˆå›¾ç‰‡å·²è®¾ç½®');
                } else {
                    console.error('æ‰¾ä¸åˆ°é¢„è§ˆå®¹å™¨ avatarPreview');
                }
                updateSaveButton();
            };
            reader.onerror = function(e) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', e);
                showToast('å›¾ç‰‡é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©');
            };
            reader.readAsDataURL(file);
        }
        
        function updateSaveButton() {
            console.log('updateSaveButton è¢«è°ƒç”¨');
            const saveBtn = document.getElementById('saveAvatarBtn');
            console.log('ä¿å­˜æŒ‰é’®å…ƒç´ :', saveBtn);
            console.log('å½“å‰selectedAvatarType:', selectedAvatarType);
            
            if (selectedAvatarType) {
                console.log('å¯ç”¨ä¿å­˜æŒ‰é’®');
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                console.log('ç¦ç”¨ä¿å­˜æŒ‰é’®');
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }
        
        async function saveAvatar() {
            console.log('=== saveAvatar å¼€å§‹æ‰§è¡Œ ===');
            
            // ç¡®ä¿è·å–æœ€æ–°çš„token
            token = AuthUtils.getCurrentToken();
            
            console.log('å½“å‰çŠ¶æ€æ£€æŸ¥:', { 
                selectedAvatarType, 
                selectedFile: selectedFile?.name, 
                selectedDefaultAvatar,
                token: token ? `å­˜åœ¨(${token.substring(0, 20)}...)` : 'ç¼ºå¤±'
            });
            
            if (!selectedAvatarType) {
                console.log('âŒ æ²¡æœ‰é€‰æ‹©å¤´åƒç±»å‹');
                showToast('è¯·å…ˆé€‰æ‹©å¤´åƒ');
                return;
            }
            
            if (!token) {
                console.log('âŒ Tokenç¼ºå¤±');
                showToast('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                return;
            }
            
            const saveBtn = document.getElementById('saveAvatarBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;
                
                console.log('âœ… å¼€å§‹ä¿å­˜å¤´åƒï¼Œç±»å‹:', selectedAvatarType);
                
                let response;
                
                if (selectedAvatarType === 'file') {
                    console.log('ğŸ“ å¤„ç†æ–‡ä»¶ä¸Šä¼ ');
                    
                    if (!selectedFile) {
                        throw new Error('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                    }
                    
                    console.log('æ–‡ä»¶ä¿¡æ¯:', {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type
                    });
                    
                    // åˆ›å»ºFormData
                    const formData = new FormData();
                    formData.append('avatar_file', selectedFile);
                    
                    console.log('ğŸš€ å‘é€æ–‡ä»¶ä¸Šä¼ è¯·æ±‚...');
                    response = await fetch(`${API_BASE}/user/upload-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                } else if (selectedAvatarType === 'default') {
                    console.log('ğŸ˜Š å¤„ç†é»˜è®¤å¤´åƒè®¾ç½®');
                    console.log('é€‰ä¸­çš„è¡¨æƒ…:', selectedDefaultAvatar);
                    
                    if (!selectedDefaultAvatar) {
                        throw new Error('æ²¡æœ‰é€‰æ‹©é»˜è®¤å¤´åƒ');
                    }
                    
                    console.log('ğŸš€ å‘é€é»˜è®¤å¤´åƒè®¾ç½®è¯·æ±‚...');
                    response = await fetch(`${API_BASE}/user/set-default-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            avatar_emoji: selectedDefaultAvatar
                        })
                    });
                }
                
                console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… å¤´åƒæ›´æ–°æˆåŠŸ:', result);
                    
                    showToast('å¤´åƒæ›´æ–°æˆåŠŸ');
                    closeAvatarModal();
                    
                    // è®¾ç½®å¤´åƒæ›´æ–°æ ‡è®°ï¼Œä¸‹æ¬¡åŠ è½½æ—¶ä¼šå¼ºåˆ¶åˆ·æ–°ç¼“å­˜
                    sessionStorage.setItem('avatarUpdated', 'true');
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥æ›´æ–°å¤´åƒæ˜¾ç¤º
                    console.log('ğŸ”„ é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™');
                    const role = AuthUtils.getCurrentUserRole();
                    if (role) {
                        setTimeout(() => loadUserProfile(role, true), 500); // å¼ºåˆ¶åˆ·æ–°
                    }
                } else {
                    // å¤„ç†HTTPé”™è¯¯
                    const responseText = await response.text();
                    console.error('âŒ APIå“åº”å¤±è´¥:', {
                        status: response.status,
                        statusText: response.statusText,
                        responseText
                    });
                    
                    let errorMessage = 'å¤´åƒæ›´æ–°å¤±è´¥';
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        console.log('å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // ç‰¹æ®ŠçŠ¶æ€ç å¤„ç†
                    if (response.status === 401) {
                        errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                        setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                    } else if (response.status === 403) {
                        errorMessage = 'æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ';
                    } else if (response.status === 413) {
                        errorMessage = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡';
                    } else if (response.status === 400) {
                        errorMessage = errorMessage || 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼';
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤´åƒå¼‚å¸¸:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                let userMessage = 'å¤´åƒæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
                
                // ç½‘ç»œé”™è¯¯å¤„ç†
                if (error.name === 'NetworkError' || error.message.includes('fetch')) {
                    userMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                } else if (error.message.includes('ç™»å½•') || error.message.includes('401')) {
                    userMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                    setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                } else if (error.message) {
                    userMessage = error.message;
                }
                
                showToast(userMessage);
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                console.log('ğŸ”„ æŒ‰é’®çŠ¶æ€å·²æ¢å¤');
            }
            
            console.log('=== saveAvatar æ‰§è¡Œå®Œæˆ ===');
        }

        function editProfile() {
            showPersonalProfileModal();
        }

        function showPersonalProfileModal() {
            const modalHtml = `
                <div class="modal" id="profileModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px;">
                        <div class="modal-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">æ˜µç§°</label>
                                <input type="text" id="editNickname" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="20">
                            </div> 
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">æ‰‹æœºå·</label>
                                <input type="tel" id="editPhone" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">é‚®ç®±</label>
                                <input type="email" id="editEmail" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeProfileModal()">å–æ¶ˆ</button>
                            <button class="modal-btn btn-primary" onclick="saveProfile()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('profileModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // å¡«å……å½“å‰ç”¨æˆ·æ•°æ®
            if (userInfo) {
                document.getElementById('editNickname').value = userInfo.nickname || '';
                document.getElementById('editPhone').value = userInfo.phone || '';
                document.getElementById('editEmail').value = userInfo.email || '';
            }
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('profileModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProfileModal();
                }
            });
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveProfile() {
            console.log('=== saveProfile() å‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
            
            // æ£€æŸ¥è¡¨å•å…ƒç´ æ˜¯å¦å­˜åœ¨
            const nicknameEl = document.getElementById('editNickname');
            const phoneEl = document.getElementById('editPhone');
            const emailEl = document.getElementById('editEmail');
            
            console.log('è¡¨å•å…ƒç´ æ£€æŸ¥:', {
                nicknameEl: !!nicknameEl,
                phoneEl: !!phoneEl,
                emailEl: !!emailEl
            });
            
            if (!nicknameEl || !phoneEl || !emailEl) {
                console.error('è¡¨å•å…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ¨¡æ€æ¡†æœªæ­£ç¡®åˆ›å»º');
                showToast('è¡¨å•åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
                return;
            }
            
            const nickname = nicknameEl.value.trim();
            const grade = null; // å¹´çº§å­—æ®µå·²ç§»é™¤ï¼Œè®¾ä¸ºnull
            const phone = phoneEl.value.trim();
            const email = emailEl.value.trim();
            
            console.log('æå–çš„è¡¨å•æ•°æ®:', { nickname, grade, phone, email });
            
            if (!nickname) {
                console.log('æ˜µç§°éªŒè¯å¤±è´¥');
                showToast('è¯·è¾“å…¥æ˜µç§°');
                return;
            }
            
            // éªŒè¯æ‰‹æœºå·æ ¼å¼
            if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return;
            }
            
            // éªŒè¯é‚®ç®±æ ¼å¼
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€');
                return;
            }
            
            try {
                console.log('=== å¼€å§‹å‘é€æ›´æ–°è¯·æ±‚ ===');
                console.log('è¯·æ±‚æ•°æ®:', {
                    nickname: nickname || null,
                    phone: phone || null,
                    email: email || null
                });
                console.log('Token:', token ? `å­˜åœ¨(é•¿åº¦${token.length})` : 'missing');
                console.log('API_BASE:', API_BASE);
                console.log('å®Œæ•´è¯·æ±‚URL:', `${API_BASE}/user/profile`);
                
                console.log('å³å°†å‘é€fetchè¯·æ±‚...');
                const response = await fetch(`${API_BASE}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: nickname || null,
                        phone: phone || null,
                        email: email || null
                    })
                });
                
                console.log('âœ… fetchè¯·æ±‚å·²å®Œæˆï¼');
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                console.log('APIå“åº”å¯¹è±¡:', response);
                console.log('å“åº”headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ:', result);
                    
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ - æ›´å®‰å…¨çš„å¤„ç†æ–¹å¼
                    if (userInfo) {
                        if (result.user) {
                            userInfo.nickname = result.user.nickname || userInfo.nickname;
                            userInfo.phone = result.user.phone || userInfo.phone;
                            userInfo.email = result.user.email || userInfo.email;
                        } else {
                            // å¦‚æœå“åº”æ²¡æœ‰userå­—æ®µï¼Œç›´æ¥ä½¿ç”¨è¡¨å•æ•°æ®æ›´æ–°
                            userInfo.nickname = nickname || userInfo.nickname;
                            userInfo.phone = phone || userInfo.phone;
                            userInfo.email = email || userInfo.email;
                        }
                        localStorage.setItem('user', JSON.stringify(userInfo));
                    }
                    
                    showToast('ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ');
                    closeProfileModal();
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥æ›´æ–°æ˜¾ç¤º
                    const role = AuthUtils.getCurrentUserRole();
                    if (role) {
                        setTimeout(() => loadUserProfile(role), 500);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    
                    let errorMessage = 'æ›´æ–°å¤±è´¥';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.detail || error.message || 'æ›´æ–°å¤±è´¥';
                    } catch (e) {
                        errorMessage = errorText || 'æ›´æ–°å¤±è´¥';
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥:', error);
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showToast('æ›´æ–°å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'));
            }
        }

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToHomeworkHistory() {
            window.location.href = '/frontend/homework-list.html';
        }

        function goToVipCenter() {
            window.location.href = '/frontend/vip-center.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function toggleNotification() {
            showNotificationSettingsModal();
        }

        function showNotificationSettingsModal() {
            const modalHtml = `
                <div class="modal" id="notificationModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">æ¶ˆæ¯é€šçŸ¥è®¾ç½®</div>
                        <div style="padding: 20px 0;">
                            <!-- é€šçŸ¥å¼€å…³ -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 4px;">æ¨é€é€šçŸ¥</div>
                                    <div style="font-size: 12px; color: #666;">æ¥æ”¶å­¦ä¹ æé†’å’Œç³»ç»Ÿæ¶ˆæ¯</div>
                                </div>
                                <div class="setting-toggle active" id="pushNotificationToggle" onclick="togglePushNotification()">
                                    <div class="toggle-handle"></div>
                                </div>
                            </div>
                            
                            <!-- æ¶ˆæ¯ç±»å‹è®¾ç½® -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">æ¶ˆæ¯ç±»å‹</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="homeworkNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">ä½œä¸šæ‰¹æ”¹å®Œæˆé€šçŸ¥</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="errorReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">é”™é¢˜å¤ä¹ æé†’</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="studyReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">å­¦ä¹ è®¡åˆ’æé†’</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="systemNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">ç³»ç»Ÿå…¬å‘Šé€šçŸ¥</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- å…æ‰“æ‰°æ—¶é—´ -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">å…æ‰“æ‰°æ—¶é—´</div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="time" id="quietStartTime" value="22:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <span style="font-size: 14px; color: #666;">è‡³</span>
                                    <input type="time" id="quietEndTime" value="07:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 6px;">åœ¨æ­¤æ—¶é—´æ®µå†…ä¸ä¼šæ”¶åˆ°æ¨é€é€šçŸ¥</div>
                            </div>
                            
                            <!-- æ¶ˆæ¯å†å² -->
                            <div style="border-top: 1px solid #eee; padding-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333;">æ¶ˆæ¯å†å²</div>
                                    <button onclick="clearAllMessages()" style="background: none; border: none; color: #007AFF; font-size: 12px; cursor: pointer;">æ¸…ç©ºå…¨éƒ¨</button>
                                </div>
                                <div id="messageHistory" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px;">
                                    <div style="text-align: center; color: #666; font-size: 12px;">åŠ è½½æ¶ˆæ¯å†å²ä¸­...</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeNotificationModal()">å–æ¶ˆ</button>
                            <button class="modal-btn btn-primary" onclick="saveNotificationSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('notificationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // åŠ è½½æ¶ˆæ¯å†å²
            loadMessageHistory();
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotificationModal();
                }
            });
        }

        function togglePushNotification() {
            const toggle = document.getElementById('pushNotificationToggle');
            toggle.classList.toggle('active');
        }

        async function loadMessageHistory() {
            try {
                const response = await fetch(`${API_BASE}/user/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const historyContainer = document.getElementById('messageHistory');
                if (!historyContainer) return;
                
                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length === 0) {
                        historyContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
                        return;
                    }
                    
                    const messagesHtml = messages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? 'å·²è¯»' : 'æœªè¯»'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                } else {
                    // æ˜¾ç¤ºæ¨¡æ‹Ÿæ¶ˆæ¯å†å²
                    const mockMessages = [
                        { title: 'æ•°å­¦ä½œä¸šæ‰¹æ”¹å®Œæˆ', created_at: '2025-01-15 14:30', is_read: true },
                        { title: 'é”™é¢˜å¤ä¹ æé†’', created_at: '2025-01-15 09:00', is_read: false },
                        { title: 'å­¦ä¹ è®¡åˆ’æ›´æ–°', created_at: '2025-01-14 20:00', is_read: true },
                        { title: 'ç³»ç»Ÿå‡çº§é€šçŸ¥', created_at: '2025-01-14 16:00', is_read: true }
                    ];
                    
                    const messagesHtml = mockMessages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? 'å·²è¯»' : 'æœªè¯»'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å†å²å¤±è´¥:', error);
                const historyContainer = document.getElementById('messageHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #f44336; font-size: 12px;">åŠ è½½å¤±è´¥</div>';
                }
            }
        }

        function clearAllMessages() {
            showModal(
                'æ¸…ç©ºæ¶ˆæ¯',
                'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/user/messages`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            showToast('æ¶ˆæ¯è®°å½•å·²æ¸…ç©º');
                            loadMessageHistory();
                        } else {
                            showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } catch (error) {
                        console.error('æ¸…ç©ºæ¶ˆæ¯å¤±è´¥:', error);
                        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            );
        }

        async function saveNotificationSettings() {
            const pushEnabled = document.getElementById('pushNotificationToggle').classList.contains('active');
            const homeworkNotify = document.getElementById('homeworkNotify').checked;
            const errorReminder = document.getElementById('errorReminder').checked;
            const studyReminder = document.getElementById('studyReminder').checked;
            const systemNotify = document.getElementById('systemNotify').checked;
            const quietStartTime = document.getElementById('quietStartTime').value;
            const quietEndTime = document.getElementById('quietEndTime').value;
            
            try {
                const response = await fetch(`${API_BASE}/user/notification-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        push_enabled: pushEnabled,
                        homework_notify: homeworkNotify,
                        error_reminder: errorReminder,
                        study_reminder: studyReminder,
                        system_notify: systemNotify,
                        quiet_start_time: quietStartTime,
                        quiet_end_time: quietEndTime
                    })
                });
                
                if (response.ok) {
                    showToast('é€šçŸ¥è®¾ç½®å·²ä¿å­˜');
                    closeNotificationModal();
                    
                    // æ›´æ–°ä¸»ç•Œé¢çš„é€šçŸ¥å¼€å…³çŠ¶æ€
                    const mainToggle = document.getElementById('notificationToggle');
                    if (pushEnabled) {
                        mainToggle.classList.add('active');
                    } else {
                        mainToggle.classList.remove('active');
                    }
                } else {
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.remove();
            }
        }


        function contactSupport() {
            showCustomerServiceModal();
        }

        function showCustomerServiceModal() {
            const modalHtml = `
                <div class="modal" id="customerServiceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">å®¢æœä¸­å¿ƒ</div>
                        <div style="padding: 20px 0;">
                            <!-- è”ç³»æ–¹å¼é€‰æ‹© -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">é€‰æ‹©è”ç³»æ–¹å¼</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- å¾®ä¿¡å®¢æœ -->
                                    <div onclick="openWeChatService()" style="display: flex; align-items: center; padding: 16px; background: #07c160; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ’¬</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">å¾®ä¿¡å®¢æœ</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">åœ¨çº¿å’¨è¯¢ï¼Œå¿«é€Ÿå“åº”</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                    
                                    <!-- å®¢æœç”µè¯ -->
                                    <div onclick="callCustomerService()" style="display: flex; align-items: center; padding: 16px; background: #007AFF; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ“</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">å®¢æœç”µè¯</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">400-8888-9999 (å·¥ä½œæ—¥ 9:00-18:00)</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                    
                                    <!-- åœ¨çº¿å·¥å• -->
                                    <div onclick="createTicket()" style="display: flex; align-items: center; padding: 16px; background: #ff9500; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ“</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">æäº¤å·¥å•</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">è¯¦ç»†æè¿°é—®é¢˜ï¼Œä¸“äººå¤„ç†</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¸¸è§é—®é¢˜ -->
                            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">å¸¸è§é—®é¢˜</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div onclick="showFAQ('ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜
                                    </div>
                                    <div onclick="showFAQ('è´¦å·å’Œç™»å½•é—®é¢˜')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ è´¦å·å’Œç™»å½•é—®é¢˜
                                    </div>
                                    <div onclick="showFAQ('VIPä¼šå‘˜æœåŠ¡')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ VIPä¼šå‘˜æœåŠ¡
                                    </div>
                                    <div onclick="showFAQ('å®¶é•¿ç»‘å®šä½¿ç”¨')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ å®¶é•¿ç»‘å®šä½¿ç”¨
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-secondary" onclick="closeCustomerServiceModal()" style="width: 100%;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('customerServiceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('customerServiceModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCustomerServiceModal();
                }
            });
        }

        function openWeChatService() {
            const wechatModalHtml = `
                <div class="modal" id="wechatModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px; text-align: center;">
                        <div class="modal-title" style="color: #07c160;">å¾®ä¿¡å®¢æœ</div>
                        <div style="padding: 20px 0;">
                            <!-- å¾®ä¿¡äºŒç»´ç  -->
                            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                <div style="width: 200px; height: 200px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
                                    <div style="text-align: center; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“±</div>
                                        <div style="font-size: 14px;">å¾®ä¿¡äºŒç»´ç </div>
                                        <div style="font-size: 12px; margin-top: 4px;">æ‰«ç æ·»åŠ å®¢æœ</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¾®ä¿¡å· -->
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">å®¢æœå¾®ä¿¡å·</div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #07c160; font-family: monospace;">ZYJC_Service</span>
                                    <button onclick="copyToClipboard('ZYJC_Service')" style="background: #07c160; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">å¤åˆ¶</button>
                                </div>
                            </div>
                            
                            <!-- æœåŠ¡æ—¶é—´ -->
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #856404; text-align: center;">
                                    <strong>æœåŠ¡æ—¶é—´ï¼š</strong>å‘¨ä¸€è‡³å‘¨æ—¥ 9:00-22:00<br>
                                    èŠ‚å‡æ—¥æ­£å¸¸æœåŠ¡ï¼Œå“åº”æ—¶é—´ â‰¤ 30åˆ†é’Ÿ
                                </div>
                            </div>
                            
                            <!-- ä½¿ç”¨æç¤º -->
                            <div style="text-align: left; font-size: 12px; color: #666; line-height: 1.4;">
                                <div style="margin-bottom: 4px;">ğŸ”¸ æ‰«ç æˆ–æœç´¢å¾®ä¿¡å·æ·»åŠ å®¢æœ</div>
                                <div style="margin-bottom: 4px;">ğŸ”¸ è¯·è¯´æ˜æ‚¨çš„é—®é¢˜ç±»å‹å’Œè¯¦ç»†æƒ…å†µ</div>
                                <div>ğŸ”¸ å·¥ä½œæ—¶é—´å†…å°†ä¼˜å…ˆå¤„ç†æ‚¨çš„å’¨è¯¢</div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-primary" onclick="closeWeChatModal()" style="width: 100%;">çŸ¥é“äº†</button>
                        </div>
                    </div>
                </div>
            `;
            
            // å…³é—­å®¢æœæ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºå¾®ä¿¡æ¨¡æ€æ¡†
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', wechatModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('wechatModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWeChatModal();
                }
            });
        }

        function closeWeChatModal() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å¾®ä¿¡å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
            } else {
                // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('å¾®ä¿¡å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
                document.body.removeChild(textArea);
            }
        }

        function callCustomerService() {
            showModal(
                'æ‹¨æ‰“å®¢æœç”µè¯',
                'å³å°†æ‹¨æ‰“å®¢æœçƒ­çº¿ 400-8888-9999\næœåŠ¡æ—¶é—´ï¼šå·¥ä½œæ—¥ 9:00-18:00',
                () => {
                    window.open('tel:400-8888-9999');
                    closeCustomerServiceModal();
                }
            );
        }

        function createTicket() {
            const ticketModalHtml = `
                <div class="modal" id="ticketModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-title">æäº¤å·¥å•</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">é—®é¢˜ç±»å‹ *</label>
                                <select id="ticketType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">è¯·é€‰æ‹©é—®é¢˜ç±»å‹</option>
                                    <option value="homework">ä½œä¸šæ‰¹æ”¹é—®é¢˜</option>
                                    <option value="account">è´¦å·ç™»å½•é—®é¢˜</option>
                                    <option value="payment">æ”¯ä»˜ç›¸å…³é—®é¢˜</option>
                                    <option value="function">åŠŸèƒ½ä½¿ç”¨é—®é¢˜</option>
                                    <option value="suggestion">å»ºè®®åé¦ˆ</option>
                                    <option value="other">å…¶ä»–é—®é¢˜</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">é—®é¢˜æ ‡é¢˜ *</label>
                                <input type="text" id="ticketTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="ç®€è¦æè¿°æ‚¨çš„é—®é¢˜" maxlength="50">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">è¯¦ç»†æè¿° *</label>
                                <textarea id="ticketDescription" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å…·ä½“çš„æ“ä½œæ­¥éª¤ã€é”™è¯¯ä¿¡æ¯ç­‰"></textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">è”ç³»æ–¹å¼</label>
                                <input type="text" id="ticketContact" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="æ‰‹æœºå·æˆ–é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
                            </div>
                            <div style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; font-size: 12px; color: #0c5aa6;">
                                ğŸ’¡ æç¤ºï¼šå·¥å•æäº¤åï¼Œæˆ‘ä»¬ä¼šåœ¨1-2ä¸ªå·¥ä½œæ—¥å†…å›å¤å¤„ç†ç»“æœï¼Œæ‚¨å¯ä»¥åœ¨"æˆ‘çš„å·¥å•"ä¸­æŸ¥çœ‹å¤„ç†è¿›åº¦ã€‚
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeTicketModal()">å–æ¶ˆ</button>
                            <button class="modal-btn btn-primary" onclick="submitTicket()">æäº¤å·¥å•</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', ticketModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('ticketModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTicketModal();
                }
            });
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitTicket() {
            const type = document.getElementById('ticketType').value;
            const title = document.getElementById('ticketTitle').value.trim();
            const description = document.getElementById('ticketDescription').value.trim();
            const contact = document.getElementById('ticketContact').value.trim();
            
            if (!type) {
                showToast('è¯·é€‰æ‹©é—®é¢˜ç±»å‹');
                return;
            }
            
            if (!title) {
                showToast('è¯·è¾“å…¥é—®é¢˜æ ‡é¢˜');
                return;
            }
            
            if (!description) {
                showToast('è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/support/tickets`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        title,
                        description,
                        contact
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('å·¥å•æäº¤æˆåŠŸï¼Œå·¥å•å·ï¼š' + (result.ticket_id || 'T' + Date.now()));
                    closeTicketModal();
                } else {
                    showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æäº¤å·¥å•å¤±è´¥:', error);
                showToast('å·¥å•æäº¤æˆåŠŸï¼Œæˆ‘ä»¬å°†å°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜'); // æ¨¡æ‹ŸæˆåŠŸ
                closeTicketModal();
            }
        }

        function showFAQ(category) {
            const faqData = {
                'ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜': {
                    title: 'ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜',
                    items: [
                        { q: 'å¦‚ä½•æ‹æ‘„ä½œä¸šç…§ç‰‡ï¼Ÿ', a: 'è¯·ç¡®ä¿å…‰çº¿å……è¶³ï¼Œä½œä¸šå®Œæ•´æ¸…æ™°å¯è§ï¼Œé¿å…é˜´å½±å’Œåå…‰ã€‚å»ºè®®å‚ç›´æ‹æ‘„ï¼Œä¿æŒä½œä¸šåœ¨ç”»é¢ä¸­å¤®ã€‚' },
                        { q: 'æ‰¹æ”¹ç»“æœä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ', a: 'è¯·æ£€æŸ¥ç…§ç‰‡æ˜¯å¦æ¸…æ™°ï¼Œå¦‚æœç…§ç‰‡æ¸…æ™°ä½†ç»“æœä»ä¸å‡†ç¡®ï¼Œå¯ä»¥é‡æ–°æ‹æ‘„æˆ–è”ç³»å®¢æœåé¦ˆã€‚' },
                        { q: 'æ”¯æŒå“ªäº›å­¦ç§‘çš„æ‰¹æ”¹ï¼Ÿ', a: 'ç›®å‰æ”¯æŒå°å­¦å’Œåˆä¸­çš„æ•°å­¦ã€è¯­æ–‡ã€è‹±è¯­ç­‰ä¸»è¦å­¦ç§‘ï¼Œæ­£åœ¨ä¸æ–­æ‰©å±•æ›´å¤šå­¦ç§‘æ”¯æŒã€‚' }
                    ]
                },
                'è´¦å·å’Œç™»å½•é—®é¢˜': {
                    title: 'è´¦å·å’Œç™»å½•é—®é¢˜',
                    items: [
                        { q: 'å¿˜è®°ç™»å½•å¯†ç æ€ä¹ˆåŠï¼Ÿ', a: 'åœ¨ç™»å½•é¡µé¢ç‚¹å‡»"å¿˜è®°å¯†ç "ï¼Œè¾“å…¥æ‰‹æœºå·è·å–éªŒè¯ç é‡ç½®å¯†ç ã€‚' },
                        { q: 'å¦‚ä½•æ›´æ¢ç»‘å®šæ‰‹æœºå·ï¼Ÿ', a: 'è¿›å…¥ä¸ªäººè®¾ç½®-è´¦æˆ·å®‰å…¨-æ›´æ¢æ‰‹æœºå·ï¼ŒæŒ‰ç…§æç¤ºå®ŒæˆéªŒè¯å³å¯ã€‚' },
                        { q: 'å¯ä»¥åŒæ—¶ç™»å½•å¤šä¸ªè®¾å¤‡å—ï¼Ÿ', a: 'åŒä¸€è´¦å·å¯ä»¥åœ¨3å°è®¾å¤‡ä¸ŠåŒæ—¶ç™»å½•ï¼Œè¶…å‡ºæ•°é‡ä¼šè‡ªåŠ¨é€€å‡ºæœ€æ—©ç™»å½•çš„è®¾å¤‡ã€‚' }
                    ]
                },
                'VIPä¼šå‘˜æœåŠ¡': {
                    title: 'VIPä¼šå‘˜æœåŠ¡',
                    items: [
                        { q: 'VIPä¼šå‘˜æœ‰ä»€ä¹ˆç‰¹æƒï¼Ÿ', a: 'æ— é™æ¬¡æ‰¹æ”¹ã€ä¼˜å…ˆå®¢æœæ”¯æŒã€è¯¦ç»†å­¦ä¹ æŠ¥å‘Šã€é”™é¢˜æœ¬åŠŸèƒ½ã€å®¶é•¿ç«¯ç›‘æ§ç­‰ã€‚' },
                        { q: 'å¦‚ä½•è´­ä¹°VIPä¼šå‘˜ï¼Ÿ', a: 'è¿›å…¥ä¼šå‘˜ä¸­å¿ƒé€‰æ‹©åˆé€‚çš„å¥—é¤ï¼Œæ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰å¤šç§æ”¯ä»˜æ–¹å¼ã€‚' },
                        { q: 'VIPåˆ°æœŸåæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ', a: 'ä¸ä¼šï¼Œæ‰€æœ‰å­¦ä¹ æ•°æ®å’Œä½œä¸šè®°å½•éƒ½ä¼šæ°¸ä¹…ä¿å­˜ï¼Œåˆ°æœŸåéƒ¨åˆ†é«˜çº§åŠŸèƒ½å—é™ã€‚' }
                    ]
                },
                'å®¶é•¿ç»‘å®šä½¿ç”¨': {
                    title: 'å®¶é•¿ç»‘å®šä½¿ç”¨',
                    items: [
                        { q: 'å¦‚ä½•ç»‘å®šå®¶é•¿è´¦å·ï¼Ÿ', a: 'å­¦ç”Ÿåœ¨ä¸ªäººä¸­å¿ƒ-å®¶é•¿ç»‘å®šä¸­ç”Ÿæˆé‚€è¯·ç ï¼Œå®¶é•¿ä¸‹è½½APPåè¾“å…¥é‚€è¯·ç å³å¯ç»‘å®šã€‚' },
                        { q: 'å®¶é•¿å¯ä»¥çœ‹åˆ°å“ªäº›ä¿¡æ¯ï¼Ÿ', a: 'å®¶é•¿å¯ä»¥æŸ¥çœ‹å­©å­çš„ä½œä¸šè®°å½•ã€å­¦ä¹ æŠ¥å‘Šã€é”™é¢˜ç»Ÿè®¡ã€å­¦ä¹ æ—¶é•¿ç­‰è¯¦ç»†ä¿¡æ¯ã€‚' },
                        { q: 'å¯ä»¥ç»‘å®šå¤šä¸ªå®¶é•¿å—ï¼Ÿ', a: 'ä¸€ä¸ªå­¦ç”Ÿè´¦å·æœ€å¤šå¯ä»¥ç»‘å®š2ä¸ªå®¶é•¿è´¦å·ï¼ˆå¦‚çˆ¶äº²å’Œæ¯äº²ï¼‰ã€‚' }
                    ]
                }
            };
            
            const faq = faqData[category];
            if (!faq) return;
            
            const faqModalHtml = `
                <div class="modal" id="faqModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-title">${faq.title}</div>
                        <div style="padding: 20px 0; max-height: 400px; overflow-y: auto;">
                            ${faq.items.map((item, index) => `
                                <div style="margin-bottom: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 16px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQAnswer(${index})">
                                        <span>Q${index + 1}: ${item.q}</span>
                                        <span id="faqIcon${index}" style="float: right; color: #666;">â–¼</span>
                                    </div>
                                    <div id="faqAnswer${index}" style="font-size: 13px; color: #666; line-height: 1.4; display: none; padding-left: 16px;">
                                        ${item.a}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-primary" onclick="closeFAQModal()" style="width: 100%;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', faqModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('faqModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFAQModal();
                }
            });
        }

        function toggleFAQAnswer(index) {
            const answer = document.getElementById(`faqAnswer${index}`);
            const icon = document.getElementById(`faqIcon${index}`);
            
            if (answer.style.display === 'none') {
                answer.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                answer.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        function closeFAQModal() {
            const modal = document.getElementById('faqModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeCustomerServiceModal() {
            const modal = document.getElementById('customerServiceModal');
            if (modal) {
                modal.remove();
            }
        }

        function goToAbout() {
            showAboutModal();
        }

        function showAboutModal() {
            const modalHtml = `
                <div class="modal" id="aboutModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-title">å…³äºæˆ‘ä»¬</div>
                        <div style="padding: 20px 0; max-height: 500px; overflow-y: auto;">
                            <!-- äº§å“ä»‹ç» -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“š</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">ZYJCæ™ºèƒ½æ‰¹æ”¹</div>
                                <div style="font-size: 14px; color: #666; line-height: 1.4;">è®©å­¦ä¹ æ›´æ™ºèƒ½ï¼Œè®©æˆé•¿æ›´é«˜æ•ˆ</div>
                            </div>
                            
                            <!-- äº§å“ç‰¹è‰² -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸš€ äº§å“ç‰¹è‰²</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">âœ¨</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">AIæ™ºèƒ½è¯†åˆ«</div>
                                            <div style="font-size: 12px; color: #666;">å…ˆè¿›çš„OCRæŠ€æœ¯ï¼Œç²¾å‡†è¯†åˆ«æ‰‹å†™ä½œä¸š</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">âš¡</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">ç§’çº§æ‰¹æ”¹</div>
                                            <div style="font-size: 12px; color: #666;">æ‹ç…§å³æ‰¹æ”¹ï¼Œ3ç§’å®Œæˆå…¨éƒ¨é¢˜ç›®æ£€æŸ¥</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">ğŸ“Š</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">è¯¦ç»†åˆ†æ</div>
                                            <div style="font-size: 12px; color: #666;">æä¾›é”™é¢˜åˆ†æå’Œå­¦ä¹ å»ºè®®</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">å®¶é•¿ç›‘æ§</div>
                                            <div style="font-size: 12px; color: #666;">å®¶é•¿ç«¯å®æ—¶æŸ¥çœ‹å­¦ä¹ æƒ…å†µ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ”¯æŒå­¦ç§‘ -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“– æ”¯æŒå­¦ç§‘</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">æ•°å­¦</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">è¯­æ–‡</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">è‹±è¯­</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">ç‰©ç†</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">åŒ–å­¦</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">ç”Ÿç‰©</div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #999; margin-top: 8px;">æŒç»­æ‰©å±•æ›´å¤šå­¦ç§‘æ”¯æŒ...</div>
                            </div>
                            
                            <!-- æ•°æ®ç»Ÿè®¡ -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“ˆ æœåŠ¡æ•°æ®</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="text-align: center; padding: 16px; background: #fff5f5; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">100ä¸‡+</div>
                                        <div style="font-size: 12px; color: #666;">ç´¯è®¡ç”¨æˆ·</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0f5ff; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #007AFF; margin-bottom: 4px;">1000ä¸‡+</div>
                                        <div style="font-size: 12px; color: #666;">æ‰¹æ”¹é¢˜ç›®</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0fff4; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #28a745; margin-bottom: 4px;">98.5%</div>
                                        <div style="font-size: 12px; color: #666;">è¯†åˆ«å‡†ç¡®ç‡</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #fffbf0; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #ffc107; margin-bottom: 4px;">24/7</div>
                                        <div style="font-size: 12px; color: #666;">åœ¨çº¿æœåŠ¡</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è”ç³»æ–¹å¼ -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“ è”ç³»æˆ‘ä»¬</div>
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">å®¢æœçƒ­çº¿</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">400-8888-9999</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">å®¢æœé‚®ç®±</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">service@zyjc.com</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 14px; color: #333;">å¾®ä¿¡å®¢æœ</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #07c160;">ZYJC_Service</div>
                                    </div>
                                    <div style="font-size: 12px; color: #666; text-align: center; padding-top: 8px; border-top: 1px solid #eee;">
                                        æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨æ—¥ 9:00-22:00
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç‰ˆæƒä¿¡æ¯ -->
                            <div style="text-align: center; padding: 16px; border-top: 1px solid #eee;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">ZYJCæ™ºèƒ½æ‰¹æ”¹ v1.0.0</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Â© 2025 ZYJCå›¢é˜Ÿ ç‰ˆæƒæ‰€æœ‰</div>
                                <div style="font-size: 12px; color: #999; line-height: 1.4;">
                                    æœ¬äº§å“å·²è·å¾—è½¯ä»¶è‘—ä½œæƒä¿æŠ¤<br>
                                    è¿æ³•å¤åˆ¶æˆ–ç›—ç”¨å°†æ‰¿æ‹…æ³•å¾‹è´£ä»»
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 16px;">
                            <button class="modal-btn btn-secondary" onclick="checkForUpdates()" style="flex: 1; margin-right: 8px;">æ£€æŸ¥æ›´æ–°</button>
                            <button class="modal-btn btn-primary" onclick="closeAboutModal()" style="flex: 1;">çŸ¥é“äº†</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('aboutModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('aboutModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAboutModal();
                }
            });
        }

        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (modal) {
                modal.remove();
            }
        }

        function checkForUpdates() {
            showToast('æ­£åœ¨æ£€æŸ¥æ›´æ–°...');
            
            // æ¨¡æ‹Ÿæ£€æŸ¥æ›´æ–°
            setTimeout(() => {
                const hasUpdate = Math.random() > 0.7; // 30% æ¦‚ç‡æœ‰æ›´æ–°
                
                if (hasUpdate) {
                    showModal(
                        'å‘ç°æ–°ç‰ˆæœ¬',
                        'å‘ç°æ–°ç‰ˆæœ¬ v1.1.0ï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š\nâ€¢ æ–°å¢ç§‘å­¦å­¦ç§‘æ”¯æŒ\nâ€¢ ä¼˜åŒ–è¯†åˆ«å‡†ç¡®ç‡\nâ€¢ ä¿®å¤å·²çŸ¥é—®é¢˜\n\næ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ',
                        () => {
                            showToast('å¼€å§‹ä¸‹è½½æ›´æ–°...');
                            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ›´æ–°é€»è¾‘
                            setTimeout(() => {
                                showToast('æ›´æ–°å®Œæˆï¼Œé‡å¯åº”ç”¨åç”Ÿæ•ˆ');
                            }, 2000);
                        }
                    );
                } else {
                    showToast('æ‚¨ä½¿ç”¨çš„å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                }
            }, 1500);
        }

        function logout() {
            showModal(
                'é€€å‡ºç™»å½•',
                'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°ç™»å½•ã€‚',
                () => {
                    // æ¸…é™¤æœ¬åœ°æ•°æ®
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('role');
                    
                    showToast('å·²é€€å‡ºç™»å½•');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 1500);
                }
            );
        }

        function showModal(title, text, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('confirmModal').style.display = 'flex';
            pendingAction = action;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeModal();
        }

        function goBack() {
            window.history.back();
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function showToast(message, duration = 3000) {
            // è®°å½•æ¶ˆæ¯åˆ°æ§åˆ¶å°
            console.log('ğŸ”” æ˜¾ç¤ºToastæ¶ˆæ¯:', message);
            
            const toast = document.createElement('div');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯æ¶ˆæ¯
            const isError = message.includes('å¤±è´¥') || message.includes('é”™è¯¯') || message.includes('å¼‚å¸¸') || message.includes('è¿‡æœŸ');
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? 'rgba(244, 67, 54, 0.9)' : 'rgba(76, 175, 80, 0.9)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 500;
                z-index: 10001;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid ${isError ? '#f44336' : '#4CAF50'};
                max-width: 80%;
                text-align: center;
                word-wrap: break-word;
                animation: fadeInScale 0.3s ease-out;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInScale {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
                @keyframes fadeOutScale {
                    0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            if (!document.getElementById('toast-styles')) {
                style.id = 'toast-styles';
                document.head.appendChild(style);
            }
            
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´
            const showDuration = isError ? Math.max(duration, 5000) : duration;
            
            setTimeout(() => {
                toast.style.animation = 'fadeOutScale 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, showDuration);
        }

        // å®¶é•¿ä¸“ç”¨å¯¼èˆªå‡½æ•°
        function goToChildrenManagement() {
            // è®°å½•è¿”å›æ¥æºï¼Œä»¥ä¾¿è¿”å›æ—¶åˆ·æ–°æ•°æ®
            localStorage.setItem('returnFromPage', 'manage-children');
            window.location.href = '/frontend/manage-children.html';
        }

        function goToChildManagement() {
            // è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ä¸åº•éƒ¨å¯¼èˆªä¿æŒä¸€è‡´
            goToChildrenManagement();
        }

        function goToLearningReports() {
            localStorage.setItem('returnFromPage', 'learning-reports');
            window.location.href = '/frontend/learning-reports.html';
        }

        function goToErrorAnalysis() {
            localStorage.setItem('returnFromPage', 'error-analysis');
            window.location.href = '/frontend/error-analysis.html';
        }

        function goToLearningProgress() {
            localStorage.setItem('returnFromPage', 'learning-progress');
            window.location.href = '/frontend/learning-progress.html';
        }

        function goToChildDetail(childId) {
            // å¦‚æœæœ‰childIdå‚æ•°ï¼Œè·³è½¬åˆ°å…·ä½“å­©å­è¯¦æƒ…é¡µ
            if (childId) {
                localStorage.setItem('returnFromPage', 'child-detail');
                window.location.href = `/frontend/child-detail.html?id=${childId}`;
            } else {
                // æ— å‚æ•°æ—¶è·³è½¬åˆ°å­©å­ç®¡ç†é¡µé¢
                window.location.href = '/frontend/manage-children.html';
            }
        }

        // å®¶é•¿åº•éƒ¨å¯¼èˆªç»Ÿä¸€å‡½æ•° - ä¸å…¶ä»–å®¶é•¿é¡µé¢ä¿æŒä¸€è‡´
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }

        function goToProfile() {
            // å½“å‰å°±æ˜¯profileé¡µé¢ï¼Œåˆ·æ–°é¡µé¢
            window.location.reload();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // é¡µé¢åº•éƒ¨é—´è·ç”±åº•éƒ¨å¯¼èˆªç»„ä»¶çš„CSSç»Ÿä¸€å¤„ç†
        // ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®paddingBottom
    </script>
</body>
</html>