<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJCæ™ºèƒ½æ‰¹æ”¹ - ä¸ªäººä¸­å¿ƒ</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-header {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        
        
        
        
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }
        
        .stat-item {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 6px;
            line-height: 1.2;
            color: #26a69a;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
        
        /* é¡µé¢å†…å®¹ */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
        }
        
        
        /* VIPçŠ¶æ€å¡ç‰‡ */
        .vip-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            color: #333;
            display: none;
            box-shadow: 0 8px 32px rgba(255, 183, 71, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .vip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(255, 183, 71, 0.4);
        }
        
        .vip-card.active {
            display: block;
        }
        
        .vip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .vip-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vip-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .vip-info {
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .vip-benefits {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* åŠŸèƒ½èœå• */
        .menu-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .menu-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(102, 126, 234, 0.08);
            position: relative;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .menu-item:hover::before {
            opacity: 1;
        }
        
        .menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 28px;
        }
        
        .menu-item:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .menu-icon {
            width: 28px;
            height: 28px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .menu-arrow {
            font-size: 14px;
            color: #ccc;
        }
        
        .menu-badge {
            position: absolute;
            top: 12px;
            right: 40px;
            background: #ff3b30;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è®¾ç½®å¼€å…³ */
        .setting-toggle {
            width: 44px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .setting-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .setting-toggle.active {
            background: #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .toggle-handle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }
        
        .setting-toggle.active .toggle-handle {
            transform: translateX(20px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .setting-toggle:active {
            transform: scale(0.98);
        }
        
        /* ç‰ˆæœ¬ä¿¡æ¯ */
        .version-info {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
            margin-bottom: 80px;
        }
        
        .version-text {
            margin-bottom: 8px;
        }
        
        .copyright {
            margin-bottom: 8px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        
        .modal-text {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%) !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(38, 166, 154, 0.3) !important;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2bbbad 0%, #00796b 100%) !important;
            box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4) !important;
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* ModalåŸºæœ¬æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ·å¼å·²ç§»è‡³ç»Ÿä¸€ç»„ä»¶ bottom-navigation.css */
        
        /* å¤´åƒç¼–è¾‘ç›¸å…³æ ·å¼ */
        .avatar-edit-content {
            padding: 20px 0;
        }
        
        .current-avatar-preview {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 8px;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-preview-label {
            font-size: 12px;
            color: #666;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .upload-option {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-option:hover {
            border-color: #007AFF;
            background: #f8f9ff;
        }
        
        .upload-option.selected {
            border-color: #007AFF;
            background: #f0f5ff;
        }
        
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .upload-desc {
            font-size: 12px;
            color: #666;
        }
        
        .default-avatars {
            padding: 16px 0;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .default-avatar-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            justify-self: center;
        }
        
        .default-avatar-item:hover {
            transform: scale(1.1);
            border-color: #007AFF;
        }
        
        .default-avatar-item.selected {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* ä¸Šä¼ è¿›åº¦ */
        .upload-progress {
            margin-top: 16px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        
        .section-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 2;
            padding: 16px 0 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        /* ä¸­ç­‰å±å¹•é€‚é… */
        @media (max-width: 768px) and (min-width: 481px) {
            .user-stats {
                gap: 42px;
            }
        }
        
        /* åŠ è½½çŠ¶æ€ä¼˜åŒ– */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .user-stats {
                gap: 36px;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .default-avatar-item {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
        
        /* ä½¿ç”¨æ–°çš„ç»Ÿä¸€å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶ï¼Œæ— éœ€é¢å¤–æ ·å¼å®šä¹‰ */
        
        /* ç¼–è¾‘ä¸ªäººèµ„æ–™æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px;
            max-width: 350px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding: 12px 0;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            min-height: 40px;
            min-width: 80px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: #f0f0f0;
            color: #333;
        }
        
        .confirm-btn {
            background: #007AFF;
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .confirm-btn:hover:not(:disabled) {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .confirm-btn:disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }
        
        /* å¤´åƒé€‰æ‹©å™¨æ ·å¼ */
        .avatar-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .avatar-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .avatar-preview-container:hover {
            transform: scale(1.05);
        }
        
        .student-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .student-avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-edit-hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }
    </style>
    
    <!-- å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶ -->
    <link rel="stylesheet" href="/frontend/css/student-bottom-nav.css">
    <script src="/frontend/js/student-bottom-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">ä¸ªäººä¸­å¿ƒ</div>
                </div>
            </div>
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="user-header">
                <div class="avatar-container">
                    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                    <div class="avatar-edit" onclick="editAvatar()">âœï¸</div>
                </div>
                
                <div class="user-name" id="userName">æ­£åœ¨åŠ è½½...</div>
                <div class="user-info" id="userInfo">å­¦ç”Ÿ Â· äº”å¹´çº§</div>
                
                <div class="user-stats">
                    <!-- å­¦ç”Ÿç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="student-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="totalHomework">0</div>
                            <div class="stat-label">æ€»ä½œä¸š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyRate">0%</div>
                            <div class="stat-label">æ­£ç¡®ç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="studyDays">0</div>
                            <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                        </div>
                    </div>
                    
                    <!-- å®¶é•¿ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="parent-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="childrenCount">0</div>
                            <div class="stat-label">å­©å­æ•°é‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="todayHomeworkCount">0</div>
                            <div class="stat-label">ä»Šæ—¥ä½œä¸š</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="averageAccuracy">0%</div>
                            <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- VIPå¡ç‰‡ -->
            <div class="vip-card" id="vipCard">
                <div class="vip-header">
                    <div class="vip-title">
                        ğŸ‘‘ VIPä¼šå‘˜
                        <div class="vip-badge">è‡³å°Šç‰ˆ</div>
                    </div>
                </div>
                <div class="vip-info">æ— é™æ¬¡æ‰¹æ”¹ Â· ä¸“å±å®¢æœ Â· è¯¦ç»†è§£æ</div>
                <div class="vip-benefits">æœ‰æ•ˆæœŸè‡³: <span id="vipExpireDate">2025-12-31</span></div>
            </div>
            
            <!-- å­¦ä¹ ç®¡ç† / å­©å­ç®¡ç† -->
            <div class="menu-section" id="mainFunctionSection">
                <!-- å­¦ç”ŸåŠŸèƒ½ -->
                <div class="student-functions" style="display: none;">
                    <div class="menu-item" onclick="goToErrorBook()">
                        <div class="menu-icon">ğŸ“š</div>
                        <div class="menu-content">
                            <div class="menu-title">æˆ‘çš„é”™é¢˜æœ¬</div>
                            <div class="menu-desc">æŸ¥çœ‹å’Œå¤ä¹ é”™é¢˜</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToStudyPlan()">
                        <div class="menu-icon">ğŸ“‹</div>
                        <div class="menu-content">
                            <div class="menu-title">å­¦ä¹ è®¡åˆ’</div>
                            <div class="menu-desc">åˆ¶å®šå’Œç®¡ç†å­¦ä¹ è®¡åˆ’</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToHomeworkHistory()">
                        <div class="menu-icon">ğŸ“</div>
                        <div class="menu-content">
                            <div class="menu-title">ä½œä¸šè®°å½•</div>
                            <div class="menu-desc">æŸ¥çœ‹å†å²æ‰¹æ”¹è®°å½•</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                </div>
                
                <!-- å®¶é•¿åŠŸèƒ½ -->
                <div class="parent-functions" style="display: none;">
                    <div class="menu-item" onclick="goToChildrenManagement()">
                        <div class="menu-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                        <div class="menu-content">
                            <div class="menu-title">å­©å­ç®¡ç†</div>
                            <div class="menu-desc">æŸ¥çœ‹å’Œç®¡ç†å­©å­ä¿¡æ¯</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToLearningReports()">
                        <div class="menu-icon">ğŸ“Š</div>
                        <div class="menu-content">
                            <div class="menu-title">å­¦ä¹ æŠ¥å‘Š</div>
                            <div class="menu-desc">æŸ¥çœ‹å­©å­çš„å­¦ä¹ åˆ†ææŠ¥å‘Š</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToParentBind()">
                        <div class="menu-icon">ğŸ”—</div>
                        <div class="menu-content">
                            <div class="menu-title">è´¦å·ç»‘å®š</div>
                            <div class="menu-desc">ç»‘å®šæˆ–ç®¡ç†å­©å­è´¦å·</div>
                        </div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                </div>
            </div>
            
            
            <!-- è´¦æˆ·ç®¡ç† -->
            <div class="menu-section">
                <div class="menu-item" id="vipCenterItem" onclick="goToVipCenter()">
                    <div class="menu-icon">ğŸ’</div>
                    <div class="menu-content">
                        <div class="menu-title">ä¼šå‘˜ä¸­å¿ƒ</div>
                        <div class="menu-desc" id="vipStatusDesc">æ­£åœ¨åŠ è½½ä¼šå‘˜ä¿¡æ¯...</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="goToParentBind()">
                    <div class="menu-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                    <div class="menu-content">
                        <div class="menu-title">å®¶é•¿ç»‘å®š</div>
                        <div class="menu-desc">ç»‘å®šå®¶é•¿è´¦å·ï¼Œå®æ—¶åŒæ­¥å­¦ä¹ æƒ…å†µ</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="editProfile()">
                    <div class="menu-icon">âš™ï¸</div>
                    <div class="menu-content">
                        <div class="menu-title">ä¸ªäººèµ„æ–™</div>
                        <div class="menu-desc">ä¿®æ”¹æ˜µç§°ã€å¹´çº§ç­‰ä¿¡æ¯</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
            </div>
            
            <!-- åº”ç”¨è®¾ç½® -->
            <div class="menu-section">
                <div class="menu-item" onclick="toggleNotification()">
                    <div class="menu-icon">ğŸ””</div>
                    <div class="menu-content">
                        <div class="menu-title">æ¶ˆæ¯é€šçŸ¥</div>
                        <div class="menu-desc">å­¦ä¹ æé†’å’Œç³»ç»Ÿé€šçŸ¥</div>
                    </div>
                    <div class="setting-toggle active" id="notificationToggle">
                        <div class="toggle-handle"></div>
                    </div>
                </div>
            </div>
            
            <!-- å¸®åŠ©æ”¯æŒ -->
            <div class="menu-section">
                <div class="menu-item" onclick="contactSupport()">
                    <div class="menu-icon">ğŸ’¬</div>
                    <div class="menu-content">
                        <div class="menu-title">å®¢æœæ”¯æŒ</div>
                        <div class="menu-desc">åœ¨çº¿å®¢æœï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
                
                <div class="menu-item" onclick="goToAbout()">
                    <div class="menu-icon">â„¹ï¸</div>
                    <div class="menu-content">
                        <div class="menu-title">å…³äºæˆ‘ä»¬</div>
                        <div class="menu-desc">äº†è§£ZYJCæ™ºèƒ½æ‰¹æ”¹</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿç®¡ç† -->
            <div class="menu-section">
                <div class="menu-item" onclick="checkForUpdates()">
                    <div class="menu-icon">ğŸ”„</div>
                    <div class="menu-content">
                        <div class="menu-title">æ£€æŸ¥æ›´æ–°</div>
                        <div class="menu-desc">æ£€æŸ¥åº”ç”¨æ›´æ–°å’Œç‰ˆæœ¬ä¿¡æ¯</div>
                    </div>
                    <div class="menu-arrow">â€º</div>
                </div>
            </div>
            
            <!-- é€€å‡ºç™»å½• -->
            <div class="menu-section">
                <div class="menu-item" onclick="logout()" style="color: #f44336;">
                    <div class="menu-icon">ğŸšª</div>
                    <div class="menu-content">
                        <div class="menu-title" style="color: #f44336;">é€€å‡ºç™»å½•</div>
                        <div class="menu-desc">é€€å‡ºå½“å‰è´¦å·</div>
                    </div>
                </div>
            </div>
            
            <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
            <div class="version-info">
                <div class="version-text">ZYJCæ™ºèƒ½æ‰¹æ”¹ v1.0.0</div>
                <div class="copyright">Â© 2025 ZYJCå›¢é˜Ÿ</div>
                <div>è®©å­¦ä¹ æ›´æ™ºèƒ½ï¼Œè®©æˆé•¿æ›´é«˜æ•ˆ</div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªé€šè¿‡ç»Ÿä¸€ç»„ä»¶è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºå¯¹åº”å¯¼èˆª -->
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ç¡®è®¤æ“ä½œ</div>
            <div class="modal-text" id="modalText">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="confirmAction()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- å¤´åƒç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="avatarModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title">ç¼–è¾‘å¤´åƒ</div>
            <div class="avatar-edit-content">
                <!-- å½“å‰å¤´åƒé¢„è§ˆ -->
                <div class="current-avatar-preview">
                    <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                    <div class="avatar-preview-label">å½“å‰å¤´åƒ</div>
                </div>
                
                <!-- ä¸Šä¼ é€‰é¡¹ -->
                <div class="upload-options">
                    <div class="upload-option" onclick="selectAvatarFile()">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">é€‰æ‹©æœ¬åœ°å›¾ç‰‡</div>
                        <div class="upload-desc">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§5MB</div>
                    </div>
                    
                    <div class="upload-option" onclick="selectDefaultAvatar()">
                        <div class="upload-icon">ğŸ˜Š</div>
                        <div class="upload-text">é€‰æ‹©é»˜è®¤å¤´åƒ</div>
                        <div class="upload-desc">ç³»ç»Ÿæä¾›çš„å¤´åƒå›¾æ ‡</div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeAvatarModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-primary" id="saveAvatarBtn" onclick="saveAvatar()" disabled>ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- é»˜è®¤å¤´åƒé€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="defaultAvatarModal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-title">é€‰æ‹©é»˜è®¤å¤´åƒ</div>
            <div class="default-avatars">
                <div class="avatar-grid" id="avatarGrid">
                    <!-- é»˜è®¤å¤´åƒå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeDefaultAvatarModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¸ªäººèµ„æ–™æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editProfileModal" style="z-index: 1000;">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
            <form id="editProfileForm">
                <div class="form-group">
                    <label class="form-label">æ˜µç§° <span style="color: red;">*</span></label>
                    <input type="text" class="form-input" id="editNickname" placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¹´çº§ <span style="color: red;">*</span></label>
                    <select class="form-input" id="editGrade" required>
                        <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                        <option value="ä¸€å¹´çº§">ä¸€å¹´çº§</option>
                        <option value="äºŒå¹´çº§">äºŒå¹´çº§</option>
                        <option value="ä¸‰å¹´çº§">ä¸‰å¹´çº§</option>
                        <option value="å››å¹´çº§">å››å¹´çº§</option>
                        <option value="äº”å¹´çº§">äº”å¹´çº§</option>
                        <option value="å…­å¹´çº§">å…­å¹´çº§</option>
                        <option value="ä¸ƒå¹´çº§">ä¸ƒå¹´çº§</option>
                        <option value="å…«å¹´çº§">å…«å¹´çº§</option>
                        <option value="ä¹å¹´çº§">ä¹å¹´çº§</option>
                        <option value="é«˜ä¸€">é«˜ä¸€</option>
                        <option value="é«˜äºŒ">é«˜äºŒ</option>
                        <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç­çº§ <span style="color: red;">*</span></label>
                    <select class="form-input" id="editClass" required>
                        <option value="">è¯·å…ˆé€‰æ‹©å¹´çº§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å­¦æ ¡</label>
                    <input type="text" class="form-input" id="editSchool" placeholder="è¯·è¾“å…¥å­¦æ ¡åç§°">
                </div>
                <!-- å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰é’®åŒºåŸŸ -->
                <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                    <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">å–æ¶ˆ</button>
                    <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®¤è¯å·¥å…·ç±» -->
    <script src="/frontend/js/auth-utils.js"></script>
    
    <!-- åº•éƒ¨å¯¼èˆªç»„ä»¶ -->
    <link rel="stylesheet" href="/frontend/css/bottom-navigation.css">
    <script src="/frontend/js/navigation-config.js"></script>
    <script src="/frontend/js/bottom-navigation.js"></script>
    
    <script>
        console.log('=== SCRIPT LOADING ===');
        
        // ç«‹å³æ£€æŸ¥URLå‚æ•°å¹¶å¼ºåˆ¶è®¾ç½®å®¶é•¿è§’è‰²ï¼ˆå¦‚æœéœ€è¦ï¼‰- ä¿®å¤å®¶é•¿ç½‘ç»œé”™è¯¯
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlRole = urlParams.get('role');
            
            if (urlRole === 'parent') {
                console.log('ğŸ  æ£€æµ‹åˆ°å®¶é•¿è§’è‰²URLå‚æ•°ï¼Œç«‹å³è®¾ç½®å®¶é•¿æ•°æ®');
                localStorage.setItem('userRole', 'parent');
                localStorage.setItem('role', 'parent'); // å…¼å®¹æ—§ç³»ç»Ÿ
                localStorage.setItem('token', 'test-token-parent');
                console.log('âœ… å®¶é•¿æ•°æ®å¼ºåˆ¶è®¾ç½®å®Œæˆ');
            } else {
                // æ£€æŸ¥ç°æœ‰æ•°æ®
                const existingRole = localStorage.getItem('userRole') || localStorage.getItem('role');
                if (existingRole === 'parent') {
                    localStorage.setItem('userRole', 'parent'); // ç¡®ä¿æ–°é”®å­˜åœ¨
                    localStorage.setItem('token', 'test-token-parent');
                    console.log('âœ… æ£€æµ‹åˆ°ç°æœ‰å®¶é•¿è§’è‰²ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®tokenå’Œé”®å');
                }
            }
        })();
        
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        let pendingAction = null;
        
        // ä¼˜åŒ–ï¼šæ·»åŠ åŠ è½½çŠ¶æ€æ§åˆ¶
        let isLoading = false;
        let lastLoadTime = 0;
        const LOAD_DEBOUNCE_TIME = 2000; // 2ç§’é˜²æŠ–
        
        console.log('Variables initialized, API_BASE:', API_BASE);
        
        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–å½“å‰token
        function getCurrentTokenSafe() {
            if (typeof AuthUtils !== 'undefined') {
                try {
                    const authToken = AuthUtils.getCurrentToken();
                    if (authToken) return authToken;
                } catch (e) {
                    console.log('AuthUtils tokenè·å–å¤±è´¥ï¼Œä½¿ç”¨localStorageå¤‡ç”¨æ–¹æ¡ˆ');
                }
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä»localStorageè·å–
            let fallbackToken = localStorage.getItem('token');
            const role = localStorage.getItem('userRole') || localStorage.getItem('role');
            
            // å®¶é•¿è§’è‰²ç‰¹æ®Šå¤„ç†
            if (role === 'parent' && fallbackToken !== 'test-token-parent') {
                fallbackToken = 'test-token-parent';
                localStorage.setItem('token', fallbackToken);
                console.log('ğŸ”§ å®‰å…¨è·å–tokenï¼šå®¶é•¿è§’è‰²å¼ºåˆ¶è®¾ç½®æ­£ç¡®token');
            }
            
            return fallbackToken;
        }
        
        // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºAuthUtilsçŠ¶æ€
        window.debugAuthState = function() {
            console.log('=== AuthUtilsè°ƒè¯•ä¿¡æ¯ ===');
            if (typeof AuthUtils !== 'undefined') {
                console.log('å½“å‰è§’è‰²:', AuthUtils.getCurrentUserRole());
                console.log('å½“å‰Token:', AuthUtils.getCurrentToken());
            } else {
                console.log('AuthUtilsæœªåŠ è½½æˆ–æœªå®šä¹‰');
            }
            console.log('localStorage userRole:', localStorage.getItem('userRole'));
            console.log('localStorage role:', localStorage.getItem('role'));
            console.log('localStorage token:', localStorage.getItem('token'));
            console.log('å…¨å±€tokenå˜é‡:', token);
            console.log('å®‰å…¨è·å–tokenç»“æœ:', getCurrentTokenSafe());
            console.log('==================');
        };

        // ç»ˆæè°ƒè¯•å‡½æ•°ï¼šç›´æ¥æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
        window.testAllAPIs = async function() {
            console.log('ğŸ” === å¼€å§‹å…¨é¢APIæµ‹è¯• ===');
            
            const testToken = 'test-token-parent';
            const baseUrl = 'http://localhost:8000/api/v1';
            
            const apis = [
                { name: 'User Profile', url: `${baseUrl}/user/profile` },
                { name: 'Parent Dashboard', url: `${baseUrl}/parent/dashboard` },
                { name: 'VIP Status', url: `${baseUrl}/user/vip-status` }
            ];
            
            for (const api of apis) {
                console.log(`\nğŸ§ª æµ‹è¯•: ${api.name}`);
                try {
                    const response = await fetch(api.url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${testToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log(`âœ… ${api.name} - çŠ¶æ€:`, response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`ğŸ“Š ${api.name} - æ•°æ®:`, data);
                    } else {
                        const errorText = await response.text();
                        console.log(`âŒ ${api.name} - é”™è¯¯å†…å®¹:`, errorText);
                    }
                } catch (error) {
                    console.log(`ğŸ’¥ ${api.name} - ç½‘ç»œé”™è¯¯:`, error.message);
                    console.log(`ğŸ’¥ ${api.name} - å®Œæ•´é”™è¯¯:`, error);
                }
            }
            
            console.log('ğŸ” === APIæµ‹è¯•å®Œæˆ ===');
        };
        
        // ç®€åŒ–çš„å®¶é•¿æ•°æ®åŠ è½½æµ‹è¯•
        window.testParentLoad = async function() {
            console.log('ğŸ  === å®¶é•¿æ•°æ®åŠ è½½æµ‹è¯• ===');
            
            const testToken = 'test-token-parent';
            const url = 'http://localhost:8000/api/v1/user/profile';
            
            try {
                console.log('ğŸ“¡ è¯·æ±‚URL:', url);
                console.log('ğŸ“¡ è¯·æ±‚Token:', testToken);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${testToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
                console.log('ğŸ“Š å“åº”å¤´:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… æˆåŠŸè·å–æ•°æ®:', data);
                    return data;
                } else {
                    const errorText = await response.text();
                    console.log('âŒ é”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.log('ğŸ’¥ ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        };

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢');
            try {
                initPage();
                
                // è®¾ç½®é«˜çº§è°ƒè¯•ç›‘æ§ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨å°±ç»ªï¼‰
                setTimeout(() => {
                    console.log('ğŸš€ è®¾ç½®é«˜çº§è°ƒè¯•å’Œç›‘æ§ç³»ç»Ÿ...');
                    setupAdvancedDebugging();
                    
                    // æ‰§è¡Œåˆå§‹åŒæ­¥æ£€æŸ¥
                    setTimeout(() => {
                        performUserProfileSyncCheck();
                    }, 500);
                    
                    // å¯åŠ¨æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                    setTimeout(() => {
                        ensureUserProfileUpdateSuccess();
                    }, 1000);
                    
                    console.log('âœ… é«˜çº§è°ƒè¯•ç³»ç»Ÿå¯åŠ¨å®Œæˆ');
                }, 300);
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });
        
        // å¤‡ç”¨åˆå§‹åŒ–ï¼ˆé˜²æ­¢DOMContentLoadedäº‹ä»¶æœªè§¦å‘ï¼‰- å¢å¼ºç‰ˆ
        window.addEventListener('load', function() {
            console.log('window loadäº‹ä»¶è§¦å‘');
            
            // æ‰§è¡Œå®Œæ•´çš„ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
            setTimeout(() => {
                const diagnostics = performSystemDiagnostics();
                
                if (!diagnostics.success) {
                    console.log('ğŸ”§ ç³»ç»Ÿæ£€æŸ¥å‘ç°é—®é¢˜ï¼Œæ‰§è¡Œä¿®å¤...');
                    
                    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
                    const userNameEl = document.getElementById('userName');
                    const shouldUpdate = !userNameEl || 
                                       userNameEl.textContent.includes('æµ‹è¯•ç”¨æˆ·') || 
                                       userNameEl.textContent === '' ||
                                       userNameEl.textContent === 'åŠ è½½ä¸­...';
                    
                    if (shouldUpdate) {
                        console.log('ç”¨æˆ·åéœ€è¦æ›´æ–°ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–');
                        try {
                            initPage();
                            
                            // ç¡®ä¿å®¶é•¿ç”¨æˆ·æ•°æ®æ­£ç¡®åŠ è½½
                            const role = AuthUtils.getCurrentUserRole();
                            if (role === 'parent') {
                                setTimeout(() => {
                                    ensureUserProfileUpdateSuccess();
                                }, 1000);
                            }
                        } catch (error) {
                            console.error('å¤‡ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                        }
                    }
                }
            }, 500);
        });
        
        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ® - å¢åŠ é˜²æŠ–å’Œé¢‘ç‡é™åˆ¶
        let lastFocusRefresh = 0;
        window.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastFocusRefresh < 30000) { // 30ç§’å†…ä¸é‡å¤åˆ·æ–°
                console.log('é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³30ç§’ï¼Œè·³è¿‡');
                return;
            }
            console.log('é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œåˆ·æ–°ç”¨æˆ·æ•°æ®');
            lastFocusRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 500); // å¢åŠ å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°æ•°æ® - å¢åŠ é˜²æŠ–å’Œé¢‘ç‡é™åˆ¶
        let lastVisibilityRefresh = 0;
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = Date.now();
                if (now - lastVisibilityRefresh < 30000) { // 30ç§’å†…ä¸é‡å¤åˆ·æ–°
                    console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³30ç§’ï¼Œè·³è¿‡');
                    return;
                }
                console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œåˆ·æ–°ç”¨æˆ·æ•°æ®');
                lastVisibilityRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role) {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500); // å¢åŠ å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
                }
            }
        });
        
        // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶ - å¢åŠ é˜²æŠ–
        let lastInfoUpdateRefresh = 0;
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶:', event.detail);
            const now = Date.now();
            if (now - lastInfoUpdateRefresh < 5000) { // 5ç§’å†…ä¸é‡å¤åˆ·æ–°
                console.log('ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³5ç§’ï¼Œè·³è¿‡');
                return;
            }
            lastInfoUpdateRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 300);
            }
        });
        
        // ç›‘å¬localStorageä¸­çš„å­å¥³æ•°æ®æ›´æ–°äº‹ä»¶ - å¢åŠ é˜²æŠ–
        let lastStorageRefresh = 0;
        window.addEventListener('storage', function(event) {
            if (event.key === 'childDataUpdated') {
                const now = Date.now();
                if (now - lastStorageRefresh < 10000) { // 10ç§’å†…ä¸é‡å¤åˆ·æ–°
                    console.log('æ”¶åˆ°å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥ï¼Œä½†è·ä¸Šæ¬¡åˆ·æ–°ä¸è¶³10ç§’ï¼Œè·³è¿‡');
                    return;
                }
                console.log('æ”¶åˆ°å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥ï¼Œåˆ·æ–°é¡µé¢æ•°æ®');
                lastStorageRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role === 'parent') {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500);
                }
            }
        });
        
        // ç›‘å¬manage-childrené¡µé¢çš„ç›´æ¥é€šçŸ¥
        window.addEventListener('childDataChanged', function(event) {
            console.log('æ”¶åˆ°å­å¥³æ•°æ®å˜æ›´äº‹ä»¶');
            const role = AuthUtils.getCurrentUserRole();
            if (role === 'parent') {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 200);
            }
        });

        function initPage() {
            console.log('=== åˆå§‹åŒ–é¡µé¢ ===');
            
            try {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä»localStorageè·å–è§’è‰²å’Œtoken - ä¿®å¤å®¶é•¿ç”¨æˆ·ç½‘ç»œé”™è¯¯
                let role = localStorage.getItem('userRole') || localStorage.getItem('role');
                token = localStorage.getItem('token');
                
                console.log('åˆå§‹åŒ–é¡µé¢ - ç›´æ¥ä»localStorageè·å– Token:', token ? 'OK' : 'NONE', 'Role:', role);
                
                // å¦‚æœæ£€æµ‹åˆ°å®¶é•¿è§’è‰²ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„token
                if (role === 'parent' && token !== 'test-token-parent') {
                    console.log('ğŸ”§ æ£€æµ‹åˆ°å®¶é•¿è§’è‰²ä½†tokenä¸æ­£ç¡®ï¼Œå¼ºåˆ¶è®¾ç½®æ­£ç¡®token');
                    token = 'test-token-parent';
                    localStorage.setItem('token', token);
                }
                
                // å°è¯•ä½¿ç”¨AuthUtilsï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (typeof AuthUtils !== 'undefined') {
                    try {
                        const authRole = AuthUtils.getCurrentUserRole();
                        const authToken = AuthUtils.getCurrentToken();
                        
                        console.log('AuthUtilså¯ç”¨ - Role:', authRole, 'Token:', authToken ? 'OK' : 'NONE');
                        
                        if (authRole && authToken) {
                            role = authRole;
                            token = authToken;
                            console.log('ä½¿ç”¨AuthUtilsè·å–çš„æ•°æ®');
                        }
                    } catch (authError) {
                        console.error('AuthUtilsè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨localStorageæ•°æ®:', authError);
                    }
                } else {
                    console.log('AuthUtilsä¸å¯ç”¨ï¼Œä½¿ç”¨localStorageæ•°æ®');
                }
                
                // æœ€åæ£€æŸ¥ï¼šå¦‚æœä»ç„¶æ²¡æœ‰æœ‰æ•ˆæ•°æ®
                if (!role || !token) {
                    console.log('æ²¡æœ‰æœ‰æ•ˆçš„roleæˆ–tokenï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    role = 'student';
                    token = 'test-token-123';
                    localStorage.setItem('userRole', role);
                    localStorage.setItem('role', role);
                    localStorage.setItem('token', token);
                }
                
                console.log('æœ€ç»ˆä½¿ç”¨çš„æ•°æ® - Role:', role, 'Token:', token);
                
                // AuthUtilså·²ç»å¤„ç†äº†è§’è‰²éªŒè¯ï¼Œç›´æ¥ä½¿ç”¨å½“å‰è§’è‰²
                console.log('æœ€ç»ˆç¡®è®¤çš„ç”¨æˆ·è§’è‰²:', role, 'TokençŠ¶æ€:', token ? 'OK' : 'NONE');
                
                // ä»localStorageæ¢å¤ç”¨æˆ·ä¿¡æ¯åˆ°å…¨å±€å˜é‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                try {
                    const storedUser = localStorage.getItem('user');
                    if (storedUser) {
                        userInfo = JSON.parse(storedUser);
                        console.log('ä»localStorageæ¢å¤ç”¨æˆ·ä¿¡æ¯:', userInfo);
                    }
                } catch (error) {
                    console.error('æ¢å¤localStorageç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
                
                // ç”Ÿæˆè§’è‰²å¯¹åº”çš„å¯¼èˆª
                generateRoleBasedNavigation();
                
                // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–é¡µé¢è¿”å›ï¼Œå¦‚æœæ˜¯åˆ™å¼ºåˆ¶åˆ·æ–°
                const returnFromPage = localStorage.getItem('returnFromPage');
                const childDataUpdated = localStorage.getItem('childDataUpdated');
                
                if (returnFromPage) {
                    console.log('ä»é¡µé¢è¿”å›:', returnFromPage);
                    localStorage.removeItem('returnFromPage');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å­å¥³æ•°æ®æ›´æ–°é€šçŸ¥
                if (childDataUpdated && role === 'parent') {
                    console.log('æ£€æµ‹åˆ°å­å¥³æ•°æ®æ›´æ–°æ ‡è®°ï¼Œæ¸…é™¤å¹¶åˆ·æ–°æ•°æ®');
                    localStorage.removeItem('childDataUpdated');
                }
                
                if (returnFromPage || childDataUpdated) {
                    // å»¶è¿Ÿä¸€ç‚¹åˆ·æ–°ï¼Œç¡®ä¿é¡µé¢åŠ è½½å®Œæˆ
                    setTimeout(() => {
                        console.log('ä»å…¶ä»–é¡µé¢è¿”å›ï¼Œå¼ºåˆ¶åˆ·æ–°æ•°æ®');
                        loadUserProfile(role, true); // å¼ºåˆ¶åˆ·æ–°
                    }, 500);
                } else {
                    // æ­£å¸¸åˆå§‹åŒ–åŠ è½½
                    setTimeout(() => {
                        console.log('æ­£å¸¸åˆå§‹åŒ–åŠ è½½ç”¨æˆ·æ•°æ®');
                        loadUserProfile(role);
                    }, 100);
                }
                
                // è®¾ç½®å¤´åƒæ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨
                setTimeout(() => {
                    console.log('è®¾ç½®æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨');
                    try {
                        const avatarFileInput = document.getElementById('avatarFileInput');
                        
                        if (avatarFileInput) {
                            avatarFileInput.removeEventListener('change', handleFileSelect);
                            avatarFileInput.addEventListener('change', handleFileSelect);
                            console.log('æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å·²è®¾ç½®');
                        } else {
                            console.warn('æ–‡ä»¶è¾“å…¥å…ƒç´  avatarFileInput æš‚æœªæ‰¾åˆ°ï¼ˆå¯èƒ½è¿˜æœªæ¸²æŸ“ï¼‰');
                        }
                    } catch (listenerError) {
                        console.error('è®¾ç½®æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å¤±è´¥:', listenerError);
                    }
                }, 200);
                
                // ç»‘å®šç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•äº‹ä»¶
                setTimeout(() => {
                    console.log('ç»‘å®šç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•äº‹ä»¶');
                    try {
                        const editProfileForm = document.getElementById('editProfileForm');
                        if (editProfileForm) {
                            editProfileForm.removeEventListener('submit', handleEditProfileSubmit);
                            editProfileForm.addEventListener('submit', handleEditProfileSubmit);
                            console.log('ç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•äº‹ä»¶å·²ç»‘å®š');
                        } else {
                            console.warn('editProfileFormå…ƒç´ æš‚æœªæ‰¾åˆ°ï¼ˆå¯èƒ½è¿˜æœªæ¸²æŸ“ï¼‰');
                        }
                    } catch (formError) {
                        console.error('ç»‘å®šç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•äº‹ä»¶å¤±è´¥:', formError);
                    }
                }, 250);
                
                // åˆå§‹åŒ–é€šçŸ¥å¼€å…³çŠ¶æ€
                setTimeout(() => {
                    console.log('åˆå§‹åŒ–é€šçŸ¥å¼€å…³çŠ¶æ€');
                    initializeNotificationToggle();
                }, 300);
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¸é˜»æ­¢é¡µé¢åŠ è½½
                showToast('é¡µé¢åŠ è½½é‡åˆ°é—®é¢˜ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }
        
        function generateRoleBasedNavigation() {
            console.log('=== ç”ŸæˆåŸºäºè§’è‰²çš„åº•éƒ¨å¯¼èˆª ===');
            
            const role = getCurrentUserRole();
            console.log('ğŸ“‹ æ£€æµ‹åˆ°çš„ç”¨æˆ·è§’è‰²:', role);
            
            // ç«‹å³ä¸ºå®¶é•¿ç”¨æˆ·åˆ›å»ºå¯¼èˆªï¼Œé¿å…è¢«å…¶ä»–ç»„ä»¶å¹²æ‰°
            if (role === 'parent') {
                console.log('ğŸš€ å®¶é•¿ç”¨æˆ·ï¼šç«‹å³å¼ºåˆ¶åˆ›å»ºå¯¼èˆª');
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡
                forceCreateParentNavigation();
                
                // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿è¦†ç›–å…¶ä»–å¯èƒ½çš„å¯¼èˆªç»„ä»¶
                setTimeout(() => {
                    console.log('ğŸ”„ å»¶è¿ŸéªŒè¯å¹¶é‡æ–°åˆ›å»ºå®¶é•¿å¯¼èˆª');
                    forceCreateParentNavigation();
                }, 500);
                
                // å†æ¬¡å»¶è¿Ÿæ‰§è¡Œç¡®ä¿å¯¼èˆªæŒç»­å­˜åœ¨
                setTimeout(() => {
                    console.log('ğŸ”„ æœ€ç»ˆéªŒè¯å®¶é•¿å¯¼èˆª');
                    const nav = document.getElementById('parentBottomNav');
                    if (!nav) {
                        console.log('âš ï¸ å¯¼èˆªä»ä¸å­˜åœ¨ï¼Œæ‰§è¡Œæœ€ç»ˆåˆ›å»º');
                        forceCreateParentNavigation();
                    }
                }, 1500);
                
                // å¯åŠ¨æŒç»­ç›‘æ§æœºåˆ¶
                startParentNavigationMonitoring();
                
            } else if (role === 'student') {
                console.log('ğŸ“ å¼€å§‹åˆå§‹åŒ–å­¦ç”Ÿå¯¼èˆªç»„ä»¶');
                // å»¶è¿Ÿæ‰§è¡Œå­¦ç”Ÿå¯¼èˆªï¼Œé¿å…ä¸å®¶é•¿ç”¨æˆ·å†²çª
                setTimeout(() => {
                    try {
                        initStudentNavigation();
                        console.log('âœ… å­¦ç”Ÿå¯¼èˆªåˆå§‹åŒ–å®Œæˆ');
                    } catch (error) {
                        console.error('âŒ å­¦ç”Ÿå¯¼èˆªåˆå§‹åŒ–å¤±è´¥:', error);
                    }
                }, 100);
            } else {
                console.error('âŒ æœªçŸ¥ç”¨æˆ·è§’è‰²:', role, 'ä½¿ç”¨å­¦ç”Ÿå¯¼èˆªä½œä¸ºé»˜è®¤');
                setTimeout(() => initStudentNavigation(), 100);
            }
            
            // ç»§ç»­é…ç½®UIæ˜¾ç¤º
            setTimeout(() => setupRoleBasedUI(role), 200);
        }
        
        // å¼ºåˆ¶åˆ›å»ºå®¶é•¿å¯¼èˆªï¼ˆè¶…çº§ç®€åŒ–ç‰ˆæœ¬ï¼‰
        function forceCreateParentNavigation() {
            console.log('ğŸ’ª å¼ºåˆ¶åˆ›å»ºå®¶é•¿å¯¼èˆªï¼ˆè¶…çº§ç®€åŒ–ç‰ˆï¼‰');
            
            // ç§»é™¤æ‰€æœ‰ç°æœ‰å¯¼èˆª
            document.querySelectorAll('[id*="nav"], [class*="nav"], [data-nav]').forEach(el => el.remove());
            
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ï¼ˆå®Œå…¨åŒ¹é…modern-theme.cssçš„æ–­ç‚¹ï¼‰
            const isMobile = window.innerWidth <= 480;
            
            // åˆ›å»ºå¯¼èˆªå®¹å™¨
            const navContainer = document.createElement('div');
            navContainer.id = 'parentBottomNav';
            
            // æ ¹æ®å±å¹•å°ºå¯¸åŠ¨æ€è®¾ç½®æ ·å¼ï¼ˆå®Œå…¨åŒ¹é…modern-theme.cssçš„å“åº”å¼è®¾è®¡ï¼‰
            const itemPadding = isMobile ? '4px 1px 3px' : '6px 2px 4px';
            const itemMargin = isMobile ? '0' : '0 1px';
            const iconSize = isMobile ? '16px' : '18px';
            const iconMargin = isMobile ? '1px' : '2px';
            const textSize = isMobile ? '8px' : '9px';
            const borderRadius = isMobile ? '12px' : '8px';
            
            navContainer.innerHTML = `
                <div onclick="goToParentHome()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83C\uDFE0</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">é¦–é¡µ</div>
                </div>
                <div onclick="goToLearningReports()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDCCA</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">å­¦ä¹ æŠ¥å‘Š</div>
                </div>
                <div onclick="goToErrorAnalysis()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDD0D</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">é”™é¢˜åˆ†æ</div>
                </div>
                <div onclick="goToLearningProgress()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDCC8</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">å­¦ä¹ è¿›åº¦</div>
                </div>
                <div onclick="goToChildDetail()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDC76</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">å­©å­ç®¡ç†</div>
                </div>
                <div onclick="goToProfile()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#667eea;background:rgba(102, 126, 234, 0.1);transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;transform:scale(1.05);filter:none !important;box-shadow:none !important;text-shadow:none !important;-webkit-filter:none !important;">\uD83D\uDC64</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">æˆ‘çš„</div>
                </div>
            `;
            
            // è®¾ç½®å®¹å™¨æ ·å¼ï¼ˆå®Œå…¨å‚ç…§manage-children.htmlçš„modern-theme.cssï¼ŒåŒ…æ‹¬ç§»åŠ¨ç«¯é€‚é…ï¼‰
            const containerPadding = isMobile ? '6px 0 4px' : '8px 0 6px';
            
            navContainer.style.cssText = `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(102, 126, 234, 0.1) !important;
                display: flex !important;
                padding: ${containerPadding} !important;
                box-shadow: none !important;
                z-index: 1000 !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
            
            // æ’å…¥å¯¼èˆª
            document.body.appendChild(navContainer);
            
            // æ·»åŠ ä¸“é—¨çš„CSSæ ·å¼æ¥å½»åº•ç§»é™¤é˜´å½±æ•ˆæœ
            if (!document.getElementById('noShadowStyles')) {
                const noShadowStyle = document.createElement('style');
                noShadowStyle.id = 'noShadowStyles';
                noShadowStyle.textContent = `
                    #parentBottomNav {
                        box-shadow: none !important;
                    }
                    #parentBottomNav .active-no-shadow {
                        filter: none !important;
                        box-shadow: none !important;
                        text-shadow: none !important;
                        -webkit-filter: none !important;
                        -moz-filter: none !important;
                        -ms-filter: none !important;
                        -o-filter: none !important;
                    }
                `;
                document.head.appendChild(noShadowStyle);
            }
            
            // ä¸º"æˆ‘çš„"æŒ‰é’®å›¾æ ‡æ·»åŠ æ— é˜´å½±ç±»
            setTimeout(() => {
                const profileIcon = document.querySelector('#parentBottomNav div[onclick="goToProfile()"] div:first-child');
                if (profileIcon) {
                    profileIcon.classList.add('active-no-shadow');
                }
            }, 100);
            
            // æ ¹æ®ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯è°ƒæ•´é¡µé¢åº•éƒ¨é—´è·
            const bottomPadding = isMobile ? '60px' : '70px';
            document.body.style.paddingBottom = bottomPadding;
            
            console.log('âœ… è¶…ç®€åŒ–å®¶é•¿å¯¼èˆªåˆ›å»ºå®Œæˆ');
            
            // ç«‹å³éªŒè¯
            setTimeout(() => {
                const nav = document.getElementById('parentBottomNav');
                console.log('å¯¼èˆªéªŒè¯:', nav ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨', nav ? nav.offsetHeight : 'N/A');
                if (!nav) {
                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå†åˆ›å»ºä¸€æ¬¡
                    const fallbackNav = document.createElement('div');
                    fallbackNav.innerHTML = 'ğŸ ğŸ“ŠğŸ”ğŸ“ˆğŸ‘¶ğŸ‘¤ å®¶é•¿å¯¼èˆª';
                    fallbackNav.style.cssText = 'position:fixed;bottom:10px;left:10px;background:red;color:white;padding:10px;z-index:99999;';
                    document.body.appendChild(fallbackNav);
                    console.log('åˆ›å»ºäº†åº”æ€¥å¯¼èˆª');
                }
            }, 100);
        }
        
        // å¯åŠ¨å®¶é•¿å¯¼èˆªæŒç»­ç›‘æ§
        function startParentNavigationMonitoring() {
            console.log('ğŸ” å¯åŠ¨å®¶é•¿å¯¼èˆªæŒç»­ç›‘æ§');
            
            // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç›‘æ§
            if (window.parentNavMonitorInterval) {
                clearInterval(window.parentNavMonitorInterval);
            }
            
            // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡å¯¼èˆªæ˜¯å¦å­˜åœ¨ï¼ˆæ›´é¢‘ç¹çš„æ£€æŸ¥ï¼‰
            window.parentNavMonitorInterval = setInterval(() => {
                const currentRole = getCurrentUserRole();
                if (currentRole === 'parent') {
                    const nav = document.getElementById('parentBottomNav');
                    if (!nav || nav.offsetHeight === 0 || !document.body.contains(nav)) {
                        console.log('âš ï¸ ç›‘æ§å‘ç°å®¶é•¿å¯¼èˆªä¸¢å¤±ï¼Œç«‹å³é‡æ–°åˆ›å»º');
                        forceCreateParentNavigation();
                    } else {
                        // ç¡®ä¿å¯¼èˆªæ ·å¼æ­£ç¡®ï¼ˆç¬¦åˆmodern-theme.cssï¼ŒåŒ…æ‹¬ç§»åŠ¨ç«¯é€‚é…ï¼‰
                        const isCurrentMobile = window.innerWidth <= 480;
                        const currentPadding = isCurrentMobile ? '6px 0 4px' : '8px 0 6px';
                        
                        nav.style.display = 'flex';
                        nav.style.position = 'fixed';
                        nav.style.bottom = '0';
                        nav.style.left = '50%';
                        nav.style.transform = 'translateX(-50%)';
                        nav.style.width = '100%';
                        nav.style.maxWidth = '400px';
                        nav.style.background = 'rgba(255, 255, 255, 0.95)';
                        nav.style.backdropFilter = 'blur(20px)';
                        nav.style.WebkitBackdropFilter = 'blur(20px)';
                        nav.style.borderTop = '1px solid rgba(102, 126, 234, 0.1)';
                        nav.style.padding = currentPadding;
                        nav.style.boxShadow = 'none';
                        nav.style.zIndex = '1000';
                        nav.style.opacity = '1';
                        nav.style.visibility = 'visible';
                    }
                } else {
                    // å¦‚æœä¸æ˜¯å®¶é•¿ç”¨æˆ·ï¼Œåœæ­¢ç›‘æ§
                    console.log('åœæ­¢å®¶é•¿å¯¼èˆªç›‘æ§ï¼ˆç”¨æˆ·è§’è‰²å·²å˜æ›´ï¼‰');
                    clearInterval(window.parentNavMonitorInterval);
                    window.parentNavMonitorInterval = null;
                }
            }, 1000);
            
            console.log('âœ… å®¶é•¿å¯¼èˆªç›‘æ§å·²å¯åŠ¨');
        }
        
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        function getCurrentUserRole() {
            console.log('=== è·å–å½“å‰ç”¨æˆ·è§’è‰² ===');
            
            // æ–¹æ³•1: ä¼˜å…ˆä½¿ç”¨AuthUtils
            if (typeof AuthUtils !== 'undefined' && AuthUtils.getCurrentUserRole) {
                const authUtilsRole = AuthUtils.getCurrentUserRole();
                console.log('AuthUtilsè·å–çš„è§’è‰²:', authUtilsRole);
                if (authUtilsRole && authUtilsRole !== 'unknown') {
                    return authUtilsRole;
                }
            } else {
                console.log('AuthUtilsä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
            }
            
            // æ–¹æ³•2: ä»localStorageè·å–
            const localStorageRole = localStorage.getItem('role');
            console.log('localStorageä¸­çš„è§’è‰²:', localStorageRole);
            if (localStorageRole && localStorageRole !== 'unknown') {
                return localStorageRole;
            }
            
            // æ–¹æ³•3: ä»Tokenç›´æ¥è§£æï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    let userId = null;
                    
                    // å¤„ç†æµ‹è¯•token
                    if (token === 'test-token-parent') {
                        userId = '2';
                        console.log('ä»æµ‹è¯•tokenç¡®è®¤å®¶é•¿ç”¨æˆ·');
                    } else if (token === 'test-token-123') {
                        userId = '1';
                        console.log('ä»æµ‹è¯•tokenç¡®è®¤å­¦ç”Ÿç”¨æˆ·');
                    } else {
                        // å°è¯•è§£æçœŸå®çš„JWT token
                        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                        userId = tokenPayload.sub;
                        console.log('ä»JWT Tokenè§£æç”¨æˆ·ID:', userId);
                    }
                    
                    const roleFromToken = userId === '2' ? 'parent' : 'student';
                    console.log('ä»Tokenè§£æçš„è§’è‰² - ç”¨æˆ·ID:', userId, 'è§’è‰²:', roleFromToken);
                    
                    // æ›´æ–°localStorageç¡®ä¿ä¸€è‡´æ€§
                    localStorage.setItem('role', roleFromToken);
                    return roleFromToken;
                }
            } catch (error) {
                console.error('ä»Tokenè§£æè§’è‰²å¤±è´¥:', error);
            }
            
            // é»˜è®¤è¿”å›å­¦ç”Ÿè§’è‰²
            console.log('ä½¿ç”¨é»˜è®¤å­¦ç”Ÿè§’è‰²');
            return 'student';
        }
        
        // åˆå§‹åŒ–å­¦ç”Ÿå¯¼èˆª
        function initStudentNavigation() {
            console.log('åˆå§‹åŒ–å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶...');
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®¶é•¿å¯¼èˆª
            clearExistingNavigation();
            
            // æ£€æŸ¥StudentBottomNavæ˜¯å¦å¯ç”¨
            if (typeof StudentBottomNav !== 'undefined') {
                // ä½¿ç”¨StudentBottomNavç»„ä»¶
                const success = StudentBottomNav.init({
                    currentPage: 'profile',
                    debug: false
                });
                
                if (success) {
                    console.log('âœ… å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–æˆåŠŸ');
                    document.body.classList.add('has-student-nav');
                } else {
                    console.error('âŒ å­¦ç”Ÿåº•éƒ¨å¯¼èˆªç»„ä»¶åˆå§‹åŒ–å¤±è´¥');
                    // ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼Œåˆ›å»ºç®€å•çš„å­¦ç”Ÿå¯¼èˆª
                    createFallbackStudentNav();
                }
            } else {
                console.warn('âš ï¸ StudentBottomNavç»„ä»¶ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                createFallbackStudentNav();
            }
        }
        
        // åˆå§‹åŒ–å®¶é•¿å¯¼èˆª
        function initParentNavigation() {
            console.log('ğŸ”§ åˆå§‹åŒ–å®¶é•¿åº•éƒ¨å¯¼èˆªç»„ä»¶...');
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–å¯¼èˆª
            console.log('ğŸ§¹ æ¸…é™¤ç°æœ‰å¯¼èˆª');
            clearExistingNavigation();
            
            // ç­‰å¾…æ¸…é™¤å®Œæˆåå†åˆ›å»ºå®¶é•¿å¯¼èˆª
            setTimeout(() => {
                console.log('ğŸ—ï¸ åˆ›å»ºå®¶é•¿å¯¼èˆªHTMLç»“æ„');
                createParentNavigation();
                
                // éªŒè¯åˆ›å»ºæ˜¯å¦æˆåŠŸ
                setTimeout(() => {
                    const nav = document.getElementById('parentBottomNav');
                    if (nav) {
                        console.log('âœ… å®¶é•¿å¯¼èˆªåˆ›å»ºéªŒè¯æˆåŠŸ');
                    } else {
                        console.error('âŒ å®¶é•¿å¯¼èˆªåˆ›å»ºéªŒè¯å¤±è´¥ï¼Œå†æ¬¡å°è¯•');
                        createParentNavigation();
                    }
                }, 100);
            }, 50);
        }
        
        // æ¸…é™¤ç°æœ‰å¯¼èˆª
        function clearExistingNavigation() {
            console.log('æ¸…é™¤ç°æœ‰å¯¼èˆª...');
            
            // æ¸…é™¤ä¿æŠ¤æœºåˆ¶
            if (window.parentNavProtectionInterval) {
                clearInterval(window.parentNavProtectionInterval);
                window.parentNavProtectionInterval = null;
            }
            
            // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å¯¼èˆªå…ƒç´ 
            const existingNavs = document.querySelectorAll('.theme-bottom-nav, .student-bottom-nav, .global-bottom-nav, #parentBottomNav, #studentBottomNav');
            existingNavs.forEach(nav => {
                if (nav && nav.parentNode) {
                    console.log('ç§»é™¤å¯¼èˆªå…ƒç´ :', nav.className || nav.id);
                    nav.parentNode.removeChild(nav);
                }
            });
            
            // ç§»é™¤å¯¼èˆªç›¸å…³çš„CSSç±»
            document.body.classList.remove('has-parent-nav', 'has-student-nav');
            
            // ç§»é™¤åŠ¨æ€æ·»åŠ çš„æ ·å¼
            const parentNavStyles = document.getElementById('parentNavStyles');
            if (parentNavStyles) {
                parentNavStyles.remove();
            }
            
            const studentNavStyles = document.getElementById('studentNavStyles');
            if (studentNavStyles) {
                studentNavStyles.remove();
            }
            
            // é‡ç½®é¡µé¢åº•éƒ¨é—´è·
            document.body.style.paddingBottom = '';
            
            console.log('âœ… ç°æœ‰å¯¼èˆªæ¸…é™¤å®Œæˆ');
        }
        
        // åˆ›å»ºå®¶é•¿å¯¼èˆªï¼ˆå‚ç…§error-analysis.htmlçš„ç¨³å®šå®ç°ï¼‰
        function createParentNavigation() {
            console.log('ğŸ¨ æ­£åœ¨åˆ›å»ºå®¶é•¿åº•éƒ¨å¯¼èˆª...');
            
            // å†æ¬¡ç¡®ä¿æ²¡æœ‰é‡å¤çš„å¯¼èˆª
            const existingNav = document.getElementById('parentBottomNav');
            if (existingNav) {
                console.log('âš ï¸ å‘ç°å·²å­˜åœ¨çš„å®¶é•¿å¯¼èˆªï¼Œå…ˆç§»é™¤');
                existingNav.remove();
            }
            
            // åˆ›å»ºå¯¼èˆªå®¹å™¨
            const parentNav = document.createElement('div');
            parentNav.className = 'theme-bottom-nav';
            parentNav.id = 'parentBottomNav'; // æ·»åŠ IDä¾¿äºç®¡ç†
            
            console.log('ğŸ“¦ åˆ›å»ºå¯¼èˆªå®¹å™¨å®Œæˆ');
            
            // åˆ›å»ºå¯¼èˆªé¡¹æ•°æ®ï¼ˆä¸error-analysis.htmlå®Œå…¨ä¸€è‡´ï¼‰
            const navItems = [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onClick: 'goToParentHome()' },
                { icon: 'ğŸ“Š', text: 'å­¦ä¹ æŠ¥å‘Š', onClick: 'goToLearningReports()' },
                { icon: 'ğŸ”', text: 'é”™é¢˜åˆ†æ', onClick: 'goToErrorAnalysis()' },
                { icon: 'ğŸ“ˆ', text: 'å­¦ä¹ è¿›åº¦', onClick: 'goToLearningProgress()' },
                { icon: 'ğŸ‘¶', text: 'å­©å­ç®¡ç†', onClick: 'goToChildDetail()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onClick: 'goToProfile()', active: true } // å½“å‰é¡µé¢
            ];
            
            // åˆ›å»ºæ¯ä¸ªå¯¼èˆªé¡¹
            navItems.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = `theme-nav-item${item.active ? ' active' : ''}`;
                navItem.setAttribute('onclick', item.onClick);
                
                const navIcon = document.createElement('div');
                navIcon.className = 'theme-nav-icon';
                navIcon.textContent = item.icon;
                
                const navText = document.createElement('div');
                navText.className = 'theme-nav-text';
                navText.textContent = item.text;
                
                navItem.appendChild(navIcon);
                navItem.appendChild(navText);
                parentNav.appendChild(navItem);
            });
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(parentNav);
            
            // ç¡®ä¿é¡µé¢åº•éƒ¨é—´è·ï¼ˆä½¿ç”¨CSSè€Œä¸æ˜¯å†…è”æ ·å¼ï¼‰
            if (!document.getElementById('parentNavStyles')) {
                const style = document.createElement('style');
                style.id = 'parentNavStyles';
                style.textContent = `
                    body.has-parent-nav {
                        padding-bottom: 80px;
                    }
                    .theme-bottom-nav {
                        position: fixed;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 100%;
                        max-width: 400px;
                        background: #ffffff;
                        border-top: 1px solid #eee;
                        display: flex;
                        padding: 8px 0;
                        z-index: 1000;
                    }
                    .theme-nav-item {
                        flex: 1;
                        text-align: center;
                        padding: 8px;
                        cursor: pointer;
                        transition: color 0.2s ease;
                    }
                    .theme-nav-item.active {
                        color: #667eea;
                    }
                    .theme-nav-icon {
                        font-size: 20px;
                        margin-bottom: 4px;
                    }
                    .theme-nav-text {
                        font-size: 10px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // æ·»åŠ bodyç±»æ ‡è¯†
            document.body.classList.add('has-parent-nav');
            
            // æœ€ç»ˆéªŒè¯å¯¼èˆªæ˜¯å¦æˆåŠŸæ·»åŠ åˆ°DOM
            setTimeout(() => {
                const finalCheck = document.getElementById('parentBottomNav');
                if (finalCheck && document.body.contains(finalCheck)) {
                    console.log('âœ… å®¶é•¿åº•éƒ¨å¯¼èˆªåˆ›å»ºå®Œæˆå¹¶å·²æ·»åŠ åˆ°DOM');
                    console.log('ğŸ” å¯¼èˆªå…ƒç´ è¯¦æƒ…:', {
                        id: finalCheck.id,
                        className: finalCheck.className,
                        children: finalCheck.children.length,
                        visible: finalCheck.offsetHeight > 0
                    });
                } else {
                    console.error('âŒ å®¶é•¿å¯¼èˆªåˆ›å»ºå¤±è´¥ - æœªæ·»åŠ åˆ°DOMæˆ–ä¸å­˜åœ¨');
                    // ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶é‡æ–°åˆ›å»º
                    setTimeout(() => {
                        console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥ä¿®å¤ - å¼ºåˆ¶é‡æ–°åˆ›å»ºå¯¼èˆª');
                        createParentNavigationFallback();
                    }, 200);
                }
            }, 100);
            
            // æ·»åŠ é˜²æŠ¤æœºåˆ¶ï¼Œé˜²æ­¢å¯¼èˆªè¢«æ„å¤–åˆ é™¤
            setupParentNavProtection();
        }
        
        // ç´§æ€¥å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æœ€ç®€å•çš„æ–¹å¼åˆ›å»ºå®¶é•¿å¯¼èˆª
        function createParentNavigationFallback() {
            console.log('ğŸ†˜ æ‰§è¡Œå®¶é•¿å¯¼èˆªç´§æ€¥å¤‡ç”¨æ–¹æ¡ˆ');
            
            // ä½¿ç”¨æœ€ç›´æ¥çš„innerHTMLæ–¹å¼
            const navHtml = `
                <div class="theme-bottom-nav" id="parentBottomNav" style="
                    position: fixed;
                    bottom: 0;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 100%;
                    max-width: 400px;
                    background: #ffffff;
                    border-top: 1px solid #eee;
                    display: flex;
                    padding: 8px 0;
                    z-index: 1000;
                ">
                    <div class="theme-nav-item" onclick="goToParentHome()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ </div>
                        <div class="theme-nav-text" style="font-size: 10px;">é¦–é¡µ</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToLearningReports()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ“Š</div>
                        <div class="theme-nav-text" style="font-size: 10px;">å­¦ä¹ æŠ¥å‘Š</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToErrorAnalysis()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ”</div>
                        <div class="theme-nav-text" style="font-size: 10px;">é”™é¢˜åˆ†æ</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToLearningProgress()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ“ˆ</div>
                        <div class="theme-nav-text" style="font-size: 10px;">å­¦ä¹ è¿›åº¦</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToChildDetail()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ‘¶</div>
                        <div class="theme-nav-text" style="font-size: 10px;">å­©å­ç®¡ç†</div>
                    </div>
                    <div class="theme-nav-item active" onclick="goToProfile()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #667eea;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">ğŸ‘¤</div>
                        <div class="theme-nav-text" style="font-size: 10px;">æˆ‘çš„</div>
                    </div>
                </div>
            `;
            
            // ç›´æ¥æ’å…¥åˆ°bodyæœ«å°¾
            document.body.insertAdjacentHTML('beforeend', navHtml);
            
            // è®¾ç½®é¡µé¢åº•éƒ¨é—´è·
            document.body.style.paddingBottom = '100px';
            document.body.classList.add('has-parent-nav');
            
            console.log('âœ… ç´§æ€¥å¤‡ç”¨å®¶é•¿å¯¼èˆªåˆ›å»ºå®Œæˆ');
            
            // æœ€ç»ˆéªŒè¯
            setTimeout(() => {
                const fallbackNav = document.getElementById('parentBottomNav');
                if (fallbackNav) {
                    console.log('âœ… ç´§æ€¥å¤‡ç”¨å¯¼èˆªéªŒè¯æˆåŠŸ');
                } else {
                    console.error('âŒ è¿ç´§æ€¥å¤‡ç”¨æ–¹æ¡ˆéƒ½å¤±è´¥äº†ï¼');
                }
            }, 100);
        }
        
        // è®¾ç½®å®¶é•¿å¯¼èˆªä¿æŠ¤æœºåˆ¶
        function setupParentNavProtection() {
            // å®šæ—¶æ£€æŸ¥å¯¼èˆªæ˜¯å¦è¿˜å­˜åœ¨
            const protectionInterval = setInterval(() => {
                const nav = document.getElementById('parentBottomNav');
                if (!nav && getCurrentUserRole() === 'parent') {
                    console.warn('âš ï¸ å®¶é•¿å¯¼èˆªè¢«æ„å¤–åˆ é™¤ï¼Œæ­£åœ¨é‡æ–°åˆ›å»º...');
                    clearInterval(protectionInterval);
                    createParentNavigation();
                }
            }, 2000);
            
            // å­˜å‚¨ä¿æŠ¤æœºåˆ¶IDï¼Œä¾¿äºæ¸…ç†
            window.parentNavProtectionInterval = protectionInterval;
        }
        
        // åˆ›å»ºå¤‡ç”¨å­¦ç”Ÿå¯¼èˆª
        function createFallbackStudentNav() {
            console.warn('âš ï¸ ä½¿ç”¨å¤‡ç”¨å­¦ç”Ÿå¯¼èˆªæ–¹æ¡ˆ');
            
            // åˆ›å»ºå¯¼èˆªå®¹å™¨
            const studentNav = document.createElement('div');
            studentNav.className = 'student-bottom-nav';
            studentNav.id = 'studentBottomNav';
            studentNav.setAttribute('data-component', 'student-bottom-nav');
            
            // åˆ›å»ºå¯¼èˆªé¡¹æ•°æ®
            const navItems = [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onClick: 'goToStudentHome()' },
                { icon: 'ğŸ“·', text: 'æ‹ç…§æ‰¹æ”¹', onClick: 'goToHomeworkSubmit()' },
                { icon: 'ğŸ“š', text: 'é”™é¢˜æœ¬', onClick: 'goToErrorBook()' },
                { icon: 'ğŸ“‹', text: 'å­¦ä¹ è®¡åˆ’', onClick: 'goToStudyPlan()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onClick: 'goToProfile()', active: true } // å½“å‰é¡µé¢
            ];
            
            // åˆ›å»ºæ¯ä¸ªå¯¼èˆªé¡¹
            navItems.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = `student-nav-item${item.active ? ' active' : ''}`;
                navItem.setAttribute('onclick', item.onClick);
                
                const navIcon = document.createElement('div');
                navIcon.className = 'student-nav-icon';
                navIcon.textContent = item.icon;
                
                const navText = document.createElement('div');
                navText.className = 'student-nav-text';
                navText.textContent = item.text;
                
                navItem.appendChild(navIcon);
                navItem.appendChild(navText);
                studentNav.appendChild(navItem);
            });
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(studentNav);
            
            // ç¡®ä¿å­¦ç”Ÿå¯¼èˆªæ ·å¼ï¼ˆä½¿ç”¨CSSè€Œä¸æ˜¯å†…è”æ ·å¼ï¼‰
            if (!document.getElementById('studentNavStyles')) {
                const style = document.createElement('style');
                style.id = 'studentNavStyles';
                style.textContent = `
                    body.has-student-nav {
                        padding-bottom: 80px;
                    }
                    .student-bottom-nav {
                        position: fixed;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 100%;
                        max-width: 400px;
                        background: #ffffff;
                        border-top: 1px solid #eee;
                        display: flex;
                        padding: 8px 0;
                        z-index: 1000;
                        opacity: 1;
                        transition: all 0.3s ease;
                    }
                    .student-nav-item {
                        flex: 1;
                        text-align: center;
                        padding: 8px;
                        cursor: pointer;
                        transition: color 0.2s ease;
                    }
                    .student-nav-item.active {
                        color: #667eea;
                    }
                    .student-nav-icon {
                        font-size: 20px;
                        margin-bottom: 4px;
                    }
                    .student-nav-text {
                        font-size: 10px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // æ·»åŠ bodyç±»æ ‡è¯†
            document.body.classList.add('has-student-nav');
            
            console.log('âœ… å¤‡ç”¨å­¦ç”Ÿåº•éƒ¨å¯¼èˆªåˆ›å»ºå®Œæˆ');
        }
        
        // ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆçš„ç®€åŒ–å¯¼èˆªåˆ›å»ºå‡½æ•°
        function setupRoleBasedUIFallback() {
            console.warn('âš ï¸ ä½¿ç”¨å¤‡ç”¨å¯¼èˆªæ–¹æ¡ˆ');
            const role = getCurrentUserRole();
            
            // åˆ›å»ºåŸºæœ¬çš„å¯¼èˆªç»“æ„
            const navItems = role === 'parent' ? [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onclick: 'goToParentHome()' },
                { icon: 'ğŸ“Š', text: 'å­¦ä¹ æŠ¥å‘Š', onclick: 'goToLearningReports()' },
                { icon: 'ğŸ‘¶', text: 'å­©å­ç®¡ç†', onclick: 'goToChildrenManagement()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onclick: 'goToProfile()', active: true }
            ] : [
                { icon: 'ğŸ ', text: 'é¦–é¡µ', onclick: 'goToStudentHome()' },
                { icon: 'ğŸ“·', text: 'æ‹ç…§æ‰¹æ”¹', onclick: 'goToHomeworkSubmit()' },
                { icon: 'ğŸ“š', text: 'é”™é¢˜æœ¬', onclick: 'goToErrorBook()' },
                { icon: 'ğŸ“‹', text: 'å­¦ä¹ è®¡åˆ’', onclick: 'goToStudyPlan()' },
                { icon: 'ğŸ‘¤', text: 'æˆ‘çš„', onclick: 'goToProfile()', active: true }
            ];
            
            // åˆ›å»ºç®€å•çš„å¯¼èˆª
            const nav = document.createElement('div');
            nav.className = role === 'parent' ? 'theme-bottom-nav' : 'global-bottom-nav';
            
            // åº”ç”¨ä¸study-plan.htmlä¸€è‡´çš„å®¹å™¨æ ·å¼
            nav.style.cssText = role === 'parent' ? `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 142, 250, 0.95)) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            ` : `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            `;
            
            const itemClass = role === 'parent' ? 'theme-nav' : 'global-nav';
            nav.innerHTML = navItems.map(item => `
                <div class="${itemClass}-item ${item.active ? 'active' : ''}" ${item.onclick ? `onclick="${item.onclick}"` : ''}>
                    <div class="${itemClass}-icon">${item.icon}</div>
                    <div class="${itemClass}-text">${item.text}</div>
                </div>
            `).join('');
            
            document.body.appendChild(nav);
            
            // åº”ç”¨æŒ‰é’®æ ·å¼
            const buttons = nav.querySelectorAll(`.${itemClass}-item`);
            buttons.forEach((button, index) => {
                const isActive = button.classList.contains('active');
                
                if (role === 'parent') {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(255, 255, 255, 0.2) !important; color: white !important;' : 'background: transparent !important; color: rgba(255, 255, 255, 0.8) !important;'}
                    `;
                } else {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(76, 175, 80, 0.1) !important; color: #4CAF50 !important;' : 'background: transparent !important; color: #666 !important;'}
                    `;
                }
                
                const icon = button.querySelector(`.${itemClass}-icon`);
                const text = button.querySelector(`.${itemClass}-text`);
                if (icon) icon.style.cssText = 'font-size: 20px !important; margin-bottom: 2px !important; display: block !important;';
                if (text) text.style.cssText = 'font-size: 10px !important; line-height: 1 !important; font-weight: 500 !important;';
            });
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®é¡µé¢åº•éƒ¨é—´è·
            const paddingValue = role === 'parent' ? '100px' : '80px'; // å®¶é•¿å¯¼èˆªä¸Šç§»éœ€è¦æ›´å¤šé—´è·
            document.body.style.paddingBottom = paddingValue;
        }
        
        function setupRoleBasedUI(role) {
            console.log('=== è®¾ç½®åŸºäºè§’è‰²çš„UIå†…å®¹æ˜¾ç¤º ===');
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', role);
            
            // å®‰å…¨è·å–å…ƒç´ çš„å‡½æ•°
            function safeSetDisplay(selector, display, isId = false) {
                try {
                    const element = isId ? document.getElementById(selector) : document.querySelector(selector);
                    if (element) {
                        element.style.display = display;
                        console.log(`âœ… æˆåŠŸè®¾ç½® ${selector} æ˜¾ç¤ºçŠ¶æ€ä¸º ${display}`);
                        return true;
                    } else {
                        console.warn(`âš ï¸  æœªæ‰¾åˆ°å…ƒç´ : ${selector}`);
                        return false;
                    }
                } catch (error) {
                    console.error(`âŒ è®¾ç½® ${selector} æ ·å¼æ—¶å‡ºé”™:`, error);
                    return false;
                }
            }
            
            // æ ¹æ®è§’è‰²é…ç½®UIæ˜¾ç¤ºå†…å®¹
            if (role === 'student') {
                console.log('ğŸ“ é…ç½®å­¦ç”Ÿèº«ä»½UI...');
                
                // æ˜¾ç¤ºå­¦ç”Ÿç›¸å…³å†…å®¹
                safeSetDisplay('.student-stats', 'flex');
                safeSetDisplay('.student-functions', 'block');
                safeSetDisplay('.parent-stats', 'none');
                safeSetDisplay('.parent-functions', 'none');
                
                // éšè—ä¼šå‘˜ä¸­å¿ƒæ¨¡å—ï¼ˆå­¦ç”Ÿèº«ä»½ä¸æ˜¾ç¤ºï¼‰
                safeSetDisplay('vipCenterItem', 'none', true);
                
            } else if (role === 'parent') {
                console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ é…ç½®å®¶é•¿èº«ä»½UI...');
                
                // æ˜¾ç¤ºå®¶é•¿ç›¸å…³å†…å®¹
                safeSetDisplay('.parent-stats', 'flex');
                safeSetDisplay('.parent-functions', 'block');
                safeSetDisplay('.student-stats', 'none');
                safeSetDisplay('.student-functions', 'none');
                
                // æ˜¾ç¤ºä¼šå‘˜ä¸­å¿ƒæ¨¡å—ï¼ˆå®¶é•¿èº«ä»½æ˜¾ç¤ºï¼‰
                safeSetDisplay('vipCenterItem', 'block', true);
                
            } else {
                console.error('âŒ æœªçŸ¥çš„ç”¨æˆ·è§’è‰²:', role);
                return;
            }
            
            console.log(`âœ… ${role}èº«ä»½UIé…ç½®å®Œæˆ`);
        }

        // å¯¼èˆªç›¸å…³åŠŸèƒ½å‡½æ•° - ä¸åº•éƒ¨å¯¼èˆªç»„ä»¶é…åˆä½¿ç”¨
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        function goToProfile() {
            // å½“å‰å°±æ˜¯profileé¡µé¢ï¼Œåˆ·æ–°é¡µé¢
            window.location.reload();
        }

        async function loadUserProfile(role, force = false) {
            // é˜²æŠ–æœºåˆ¶ï¼šé¿å…é¢‘ç¹é‡å¤è¯·æ±‚
            const now = Date.now();
            if (!force && (isLoading || (now - lastLoadTime < LOAD_DEBOUNCE_TIME))) {
                console.log('è¯·æ±‚è¢«é˜²æŠ–æ‹¦æˆªï¼Œè·ä¸Šæ¬¡åŠ è½½:', now - lastLoadTime, 'ms');
                return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            isLoading = true;
            lastLoadTime = now;
            
            try {
                console.log('å¼€å§‹åŠ è½½ç”¨æˆ·èµ„æ–™ï¼Œè§’è‰²:', role, 'å¼ºåˆ¶åˆ·æ–°:', force);
                
                // ç¡®ä¿è·å–æœ€æ–°çš„token - ä¿®å¤å®¶é•¿ç”¨æˆ·ç½‘ç»œé”™è¯¯é—®é¢˜
                token = getCurrentTokenSafe();
                console.log('ğŸ“¡ å®‰å…¨è·å–tokenç»“æœ:', token ? 'OK' : 'NONE', 'ç”¨æˆ·è§’è‰²:', role);
                
                // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œè®¾ç½®å…¨å±€æ ‡è®°ç¡®ä¿å¤´åƒå¼ºåˆ¶æ›´æ–°
                if (force) {
                    window.recentAvatarUpdate = true;
                    console.log('âœ… å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ï¼Œè®¾ç½®å¤´åƒæ›´æ–°å…¨å±€æ ‡è®°');
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoadingState();
                
                // å¹¶è¡Œè¯·æ±‚ç”¨æˆ·ä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®å’ŒVIPçŠ¶æ€
                const requests = [];
                
                // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¯·æ±‚ - ä½¿ç”¨ /user/profile ç¡®ä¿è·å–å®Œæ•´ä¿¡æ¯
                requests.push(
                    fetch(`${API_BASE}/user/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // VIPçŠ¶æ€è¯·æ±‚
                requests.push(
                    fetch(`${API_BASE}/user/vip-status`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // ç»Ÿè®¡æ•°æ®è¯·æ±‚
                if (role === 'student') {
                    requests.push(
                        fetch(`${API_BASE}/student/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                } else if (role === 'parent') {
                    requests.push(
                        fetch(`${API_BASE}/parent/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                }
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
                const responses = await Promise.all(requests);
                const [userResponse, vipStatusResponse, statsResponse] = responses;
                
                console.log('APIå“åº”çŠ¶æ€:', {
                    user: userResponse.status,
                    vipStatus: vipStatusResponse.status,
                    stats: statsResponse?.status
                });
                
                // å¤„ç†ç”¨æˆ·ä¿¡æ¯
                if (userResponse.ok) {
                    userInfo = await userResponse.json();
                    console.log('è·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfo);
                    
                    // ç‰¹åˆ«æ£€æŸ¥å­¦ç”Ÿç”¨æˆ·çš„å…³é”®å­—æ®µ
                    if (role === 'student') {
                        console.log('ğŸ“š å­¦ç”Ÿç”¨æˆ·å…³é”®å­—æ®µæ£€æŸ¥:', {
                            nickname: userInfo.nickname,
                            grade: userInfo.grade,
                            class_name: userInfo.class_name,
                            school: userInfo.school,
                            'æ˜¯å¦åŒ…å«class_name': 'class_name' in userInfo,
                            'æ˜¯å¦åŒ…å«school': 'school' in userInfo,
                            'class_nameç±»å‹': typeof userInfo.class_name,
                            'schoolç±»å‹': typeof userInfo.school
                        });
                    }
                    
                    // å¤„ç†VIPçŠ¶æ€æ•°æ®
                    let vipStatusData = null;
                    if (vipStatusResponse.ok) {
                        vipStatusData = await vipStatusResponse.json();
                        console.log('è·å–åˆ°VIPçŠ¶æ€æ•°æ®:', vipStatusData);
                    } else {
                        console.error('VIPçŠ¶æ€APIè°ƒç”¨å¤±è´¥:', vipStatusResponse.status, vipStatusResponse.statusText);
                        // ä½¿ç”¨é»˜è®¤VIPçŠ¶æ€æ•°æ®
                        vipStatusData = {
                            is_vip: false,
                            vip_type: 'free',
                            expire_date: null,
                            remaining_days: 0,
                            daily_quota: 3,
                            remaining_quota: 3
                        };
                    }
                    
                    // å¤„ç†ç»Ÿè®¡æ•°æ®
                    let statsData = null;
                    if (statsResponse?.ok) {
                        statsData = await statsResponse.json();
                        console.log('è·å–åˆ°ç»Ÿè®¡æ•°æ®:', statsData);
                    } else {
                        console.error('ç»Ÿè®¡æ•°æ®APIè°ƒç”¨å¤±è´¥:', statsResponse?.status, statsResponse?.statusText);
                        // ä½¿ç”¨é»˜è®¤ç»Ÿè®¡æ•°æ®
                        statsData = getDefaultStatsData(role);
                    }
                    
                    // æ‰¹é‡æ›´æ–°UI
                    updateUserInterface(userInfo, statsData, role, vipStatusData);
                    
                    // æ›´æ–°localStorage
                    localStorage.setItem('user', JSON.stringify(userInfo));
                    
                    // è§¦å‘æ›´æ–°äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
                    
                    console.log('ç”¨æˆ·èµ„æ–™åŠ è½½å®Œæˆäº:', new Date().toLocaleTimeString());
                    
                } else {
                    console.error('ç”¨æˆ·ä¿¡æ¯APIè°ƒç”¨å¤±è´¥:', userResponse.status, userResponse.statusText);
                    showDefaultUserData();
                    return;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                showDefaultUserData();
            } finally {
                isLoading = false;
                hideLoadingState();
                
                // å»¶è¿Ÿæ¸…é™¤å…¨å±€æ ‡è®°ï¼Œç¡®ä¿å¤´åƒæ›´æ–°æ“ä½œå®Œæˆ
                if (force && window.recentAvatarUpdate === true) {
                    setTimeout(() => {
                        if (window.recentAvatarUpdate === true) {
                            window.recentAvatarUpdate = false;
                            console.log('âœ… loadUserProfileå®Œæˆï¼Œæ¸…é™¤å¤´åƒæ›´æ–°å…¨å±€æ ‡è®°');
                        }
                    }, 2000);
                }
            }
        }
        
        async function loadStudentStats() {
            try {
                // ç¡®ä¿è·å–æœ€æ–°çš„token
                token = getCurrentTokenSafe();
                console.log('ğŸ“¡ loadStudentStatsè·å–token:', token ? 'OK' : 'NONE');
                
                const statsResponse = await fetch(`${API_BASE}/student/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('å­¦ç”Ÿç»Ÿè®¡APIå“åº”çŠ¶æ€:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('è·å–åˆ°å­¦ç”Ÿç»Ÿè®¡:', statsData);
                    updateStudentStats(statsData);
                } else {
                    console.error('å­¦ç”Ÿç»Ÿè®¡APIè°ƒç”¨å¤±è´¥:', statsResponse.status, statsResponse.statusText);
                    updateStudentStats({
                        daily_stats: {
                            today_corrections: 0,
                            accuracy_rate: 0,
                            study_time: 0
                        },
                        recent_homework: [],
                        error_summary: {
                            unreviewed_count: 0
                        }
                    });
                }
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿç»Ÿè®¡å¼‚å¸¸:', error);
                updateStudentStats({});
            }
        }
        
        async function loadParentStats() {
            try {
                // ç¡®ä¿è·å–æœ€æ–°çš„token
                token = getCurrentTokenSafe();
                console.log('ğŸ“¡ loadParentStatsè·å–token:', token ? 'OK' : 'NONE');
                
                const statsResponse = await fetch(`${API_BASE}/parent/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('å®¶é•¿ç»Ÿè®¡APIå“åº”çŠ¶æ€:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('è·å–åˆ°å®¶é•¿ç»Ÿè®¡:', statsData);
                    updateParentStats(statsData);
                } else {
                    console.error('å®¶é•¿ç»Ÿè®¡APIè°ƒç”¨å¤±è´¥:', statsResponse.status, statsResponse.statusText);
                    updateParentStats({
                        today_stats: { homeworkCount: 0, accuracy: 0 },
                        children: [],
                        weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                    });
                }
            } catch (error) {
                console.error('è·å–å®¶é•¿ç»Ÿè®¡å¼‚å¸¸:', error);
                updateParentStats({});
            }
        }

        // åŠ è½½çŠ¶æ€ç®¡ç†
        function showLoadingState() {
            // æ˜¾ç¤ºç”¨æˆ·ååŠ è½½çŠ¶æ€
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = 'åŠ è½½ä¸­...';
                userNameEl.style.opacity = '0.6';
            }
            
            // æ˜¾ç¤ºå¤´åƒåŠ è½½çŠ¶æ€
            const userAvatarEl = document.getElementById('userAvatar');
            if (userAvatarEl) {
                userAvatarEl.innerHTML = 'â³';
                userAvatarEl.style.opacity = '0.6';
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®åŠ è½½çŠ¶æ€
            const statElements = document.querySelectorAll('.stat-number');
            statElements.forEach(el => {
                el.textContent = '...';
                el.style.opacity = '0.6';
            });
        }
        
        function hideLoadingState() {
            // æ¢å¤æ­£å¸¸é€æ˜åº¦å¹¶æ·»åŠ æ·¡å…¥æ•ˆæœ
            const elements = [
                document.getElementById('userName'),
                document.getElementById('userAvatar'),
                ...document.querySelectorAll('.stat-number')
            ];
            
            elements.forEach(el => {
                if (el) {
                    el.style.opacity = '1';
                    el.classList.add('fade-in');
                    
                    // åŠ¨ç”»å®Œæˆåç§»é™¤ç±»
                    setTimeout(() => {
                        el.classList.remove('fade-in');
                    }, 300);
                }
            });
        }
        
        // è·å–é»˜è®¤ç»Ÿè®¡æ•°æ®
        function getDefaultStatsData(role) {
            if (role === 'student') {
                return {
                    daily_stats: {
                        today_corrections: 0,
                        accuracy_rate: 0,
                        study_time: 0
                    },
                    recent_homework: [],
                    error_summary: {
                        unreviewed_count: 0
                    }
                };
            } else if (role === 'parent') {
                return {
                    today_stats: { homeworkCount: 0, accuracy: 0 },
                    children: [],
                    weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                };
            }
            return {};
        }
        
        // æ‰¹é‡æ›´æ–°UIæ¥å£
        function updateUserInterface(userInfo, statsData, role, vipStatusData) {
            // æ‰¹é‡æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®å’ŒVIPçŠ¶æ€
            const updates = [];
            
            // å‡†å¤‡ç”¨æˆ·ä¿¡æ¯æ›´æ–°
            updates.push(() => updateUserProfile(userInfo));
            
            // å‡†å¤‡ç»Ÿè®¡æ•°æ®æ›´æ–°
            if (role === 'student') {
                updates.push(() => updateStudentStats(statsData));
            } else if (role === 'parent') {
                updates.push(() => updateParentStats(statsData));
            }
            
            // å‡†å¤‡VIPçŠ¶æ€æ›´æ–°
            if (vipStatusData) {
                updates.push(() => updateVipCenterStatus(vipStatusData));
            }
            
            // æ‰¹é‡æ‰§è¡Œæ›´æ–°ï¼Œå‡å°‘é‡æ’é‡ç»˜
            requestAnimationFrame(() => {
                updates.forEach(update => update());
            });
        }

        function showDefaultUserData() {
            // æ˜¾ç¤ºé»˜è®¤çš„ç©ºç™½ç”¨æˆ·æ•°æ®
            const defaultUser = {
                id: 0,
                nickname: 'ç”¨æˆ·',
                role: 'student',
                grade: 'æœªè®¾ç½®',
                avatar_url: null,
                is_vip: false,
                vip_expire_time: null,
                daily_quota: 0,
                daily_used: 0
            };
            
            const defaultVipStatus = {
                is_vip: false,
                vip_type: 'free',
                expire_date: null,
                remaining_days: 0,
                daily_quota: 3,
                remaining_quota: 3
            };
            
            const role = getCurrentUserRole();
            const defaultStats = getDefaultStatsData(role);
            
            updateUserInterface(defaultUser, defaultStats, role, defaultVipStatus);
        }

        function updateUserProfile(user) {
            console.log('=== å¼€å§‹æ›´æ–°ç”¨æˆ·èµ„æ–™ ===');
            console.log('æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼Œç”¨æˆ·æ•°æ®:', user);
            
            if (!user) {
                console.error('âŒ updateUserProfile: userå‚æ•°ä¸ºç©ºæˆ–undefined');
                return;
            }
            
            const userNameEl = document.getElementById('userName');
            const userInfoEl = document.getElementById('userInfo');
            const userAvatarEl = document.getElementById('userAvatar');
            
            console.log('DOMå…ƒç´ æ£€æŸ¥:', {
                userNameEl: !!userNameEl,
                userInfoEl: !!userInfoEl,
                userAvatarEl: !!userAvatarEl
            });
            
            if (userNameEl) {
                // æ ¹æ®ç”¨æˆ·è§’è‰²é€‰æ‹©ä¸åŒçš„åç§°å­—æ®µ
                let newName = 'ç”¨æˆ·';
                if (user.role === 'parent') {
                    newName = user.name || user.nickname || 'å®¶é•¿ç”¨æˆ·';
                } else {
                    newName = user.nickname || user.name || 'ç”¨æˆ·';
                }
                
                console.log('å‡†å¤‡æ›´æ–°ç”¨æˆ·åä»:', userNameEl.textContent, 'åˆ°:', newName, 'è§’è‰²:', user.role);
                
                // ä¼˜åŒ–ï¼šåªæœ‰åœ¨å†…å®¹çœŸçš„å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°DOM
                if (userNameEl.textContent !== newName) {
                    userNameEl.textContent = newName;
                    console.log('ç”¨æˆ·åå·²æ›´æ–°ä¸º:', newName);
                } else {
                    console.log('ç”¨æˆ·åæ— éœ€æ›´æ–°ï¼Œå†…å®¹ç›¸åŒ');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°userNameå…ƒç´ ï¼');
            }
            
            if (userInfoEl) {
                const roleText = user.role === 'student' ? 'å­¦ç”Ÿ' : user.role === 'parent' ? 'å®¶é•¿' : 'æ•™å¸ˆ';
                
                // å®¶é•¿èº«ä»½æ—¶åªæ˜¾ç¤º"å®¶é•¿"ï¼Œä¸æ˜¾ç¤ºå¹´çº§ä¿¡æ¯
                if (user.role === 'parent') {
                    userInfoEl.textContent = roleText;
                    console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ä¸º:', roleText);
                } else {
                    // å­¦ç”Ÿå’Œå…¶ä»–è§’è‰²æ˜¾ç¤ºè§’è‰²å’Œå¹´çº§
                    const gradeText = user.grade || 'æœªè®¾ç½®å¹´çº§';
                    userInfoEl.textContent = `${roleText} Â· ${gradeText}`;
                    console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ä¸º:', `${roleText} Â· ${gradeText}`);
                }
            }
            
            // æ›´æ–°VIPçŠ¶æ€
            if (user.is_vip) {
                const vipCard = document.getElementById('vipCard');
                if (vipCard) {
                    vipCard.classList.add('active');
                    if (user.vip_expire_time) {
                        const expireDateEl = document.getElementById('vipExpireDate');
                        if (expireDateEl) {
                            expireDateEl.textContent = new Date(user.vip_expire_time).toLocaleDateString();
                        }
                    }
                    console.log('VIPçŠ¶æ€å·²æ›´æ–°');
                }
            }
            
            // æ›´æ–°å¤´åƒ - ä¼˜åŒ–ç‰ˆæœ¬
            if (userAvatarEl) {
                console.log('æ›´æ–°å¤´åƒï¼ŒURL:', user.avatar_url);
                setUserAvatar(userAvatarEl, user.avatar_url);
            } else {
                console.error('æ‰¾ä¸åˆ°å¤´åƒå…ƒç´  userAvatar');
            }
        }

        function updateStudentStats(stats) {
            console.log('=== æ›´æ–°å­¦ç”Ÿç»Ÿè®¡æ•°æ® ===');
            console.log('æ”¶åˆ°çš„å­¦ç”Ÿç»Ÿè®¡æ•°æ®:', stats);
            
            // æ€»ä½œä¸šæ•°ï¼šä½¿ç”¨æœ€è¿‘ä½œä¸šæ•°é‡ï¼Œè¿™ä»£è¡¨äº†è¿‘æœŸçš„å­¦ä¹ æ´»åŠ¨
            const totalHomework = stats.recent_homework ? stats.recent_homework.length : 0;
            
            // æ­£ç¡®ç‡ï¼šç›´æ¥ä»daily_statsè·å–ï¼Œåç«¯å·²ç»è®¡ç®—å¥½çš„ç™¾åˆ†æ¯”ï¼ˆå¦‚85.5%ï¼‰
            const accuracyRate = stats.daily_stats ? stats.daily_stats.accuracy_rate : 0;
            
            // å­¦ä¹ å¤©æ•°ï¼šåŸºäºç´¯è®¡å­¦ä¹ æ—¶é—´å’Œæ—¥å‡æ—¶é•¿çš„åˆç†ä¼°ç®—
            // æ ¹æ®å­¦ä¹ æ—¶é—´æ¨ç®—ç´¯è®¡å­¦ä¹ å¤©æ•°ï¼ˆæ¯å¤©30åˆ†é’Ÿä¸ºåŸºå‡†ï¼‰
            const studyTimeMinutes = stats.daily_stats ? stats.daily_stats.study_time : 0;
            let studyDays = 0;
            
            if (studyTimeMinutes > 0) {
                // å‡è®¾æ¯å¤©å¹³å‡å­¦ä¹ 30åˆ†é’Ÿï¼Œè®¡ç®—ç´¯è®¡å¤©æ•°
                const dailyAvgMinutes = 30;
                studyDays = Math.max(1, Math.ceil(studyTimeMinutes / dailyAvgMinutes));
                
                // å¦‚æœæœ‰ä½œä¸šè®°å½•ï¼Œè‡³å°‘åº”è¯¥ç­‰äºä½œä¸šå¤©æ•°
                if (totalHomework > 0) {
                    studyDays = Math.max(studyDays, totalHomework);
                }
            }
            
            console.log('å­¦ç”Ÿç»Ÿè®¡è®¡ç®—ç»“æœ:', {
                totalHomework,
                accuracyRate,
                studyTimeMinutes,
                studyDays
            });
            
            // æ›´æ–°DOMå…ƒç´ 
            const totalHomeworkEl = document.getElementById('totalHomework');
            const accuracyRateEl = document.getElementById('accuracyRate');
            const studyDaysEl = document.getElementById('studyDays');
            
            if (totalHomeworkEl) {
                totalHomeworkEl.textContent = totalHomework;
                console.log('æ€»ä½œä¸šæ•°å·²æ›´æ–°ä¸º:', totalHomework);
            }
            
            if (accuracyRateEl) {
                accuracyRateEl.textContent = accuracyRate + '%';
                console.log('æ­£ç¡®ç‡å·²æ›´æ–°ä¸º:', accuracyRate + '%');
            }
            
            if (studyDaysEl) {
                studyDaysEl.textContent = studyDays;
                console.log('å­¦ä¹ å¤©æ•°å·²æ›´æ–°ä¸º:', studyDays);
            }
            
            console.log('=== å­¦ç”Ÿç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ ===');
        }
        
        function updateParentStats(stats) {
            console.log('=== æ›´æ–°å®¶é•¿ç»Ÿè®¡æ•°æ® ===');
            console.log('æ”¶åˆ°çš„å®¶é•¿ç»Ÿè®¡æ•°æ®:', stats);
            
            // å­©å­æ•°é‡
            const childrenCount = stats.children ? stats.children.length : 0;
            
            // ä»Šæ—¥ä½œä¸šæ•°ï¼ˆæ‰€æœ‰å­©å­çš„æ€»å’Œï¼‰
            const todayHomeworkCount = stats.today_stats ? stats.today_stats.homeworkCount : 0;
            
            // å¹³å‡æ­£ç¡®ç‡ï¼ˆæ‰€æœ‰å­©å­çš„å¹³å‡å€¼ï¼‰
            const averageAccuracy = stats.today_stats ? stats.today_stats.accuracy : 0;
            
            console.log('å®¶é•¿ç»Ÿè®¡è®¡ç®—ç»“æœ:', {
                childrenCount,
                todayHomeworkCount,
                averageAccuracy
            });
            
            // æ›´æ–°DOMå…ƒç´ 
            const childrenCountEl = document.getElementById('childrenCount');
            const todayHomeworkCountEl = document.getElementById('todayHomeworkCount');
            const averageAccuracyEl = document.getElementById('averageAccuracy');
            
            if (childrenCountEl) {
                childrenCountEl.textContent = childrenCount;
                console.log('å­©å­æ•°é‡å·²æ›´æ–°ä¸º:', childrenCount);
            }
            
            if (todayHomeworkCountEl) {
                todayHomeworkCountEl.textContent = todayHomeworkCount;
                console.log('ä»Šæ—¥ä½œä¸šæ•°å·²æ›´æ–°ä¸º:', todayHomeworkCount);
            }
            
            if (averageAccuracyEl) {
                averageAccuracyEl.textContent = averageAccuracy + '%';
                console.log('å¹³å‡æ­£ç¡®ç‡å·²æ›´æ–°ä¸º:', averageAccuracy + '%');
            }
            
            
            console.log('=== å®¶é•¿ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ ===');
        }
        
        // æ›´æ–°ä¼šå‘˜ä¸­å¿ƒçŠ¶æ€æè¿° - ä½¿ç”¨VIPçŠ¶æ€APIæ•°æ®
        function updateVipCenterStatus(vipStatusData) {
            console.log('=== æ›´æ–°ä¼šå‘˜ä¸­å¿ƒçŠ¶æ€æè¿° ===');
            console.log('VIPçŠ¶æ€APIæ•°æ®:', vipStatusData);
            
            const vipStatusDescEl = document.getElementById('vipStatusDesc');
            if (!vipStatusDescEl) {
                console.log('æœªæ‰¾åˆ°vipStatusDescå…ƒç´ ');
                return;
            }
            
            if (vipStatusData.is_vip && vipStatusData.expire_date) {
                // VIPç”¨æˆ· - æ˜¾ç¤ºåˆ°æœŸæ—¶é—´å’Œå‰©ä½™æ¬¡æ•°
                const daysLeft = vipStatusData.remaining_days || 0;
                const remainingQuota = vipStatusData.remaining_quota || 0;
                
                let statusText = '';
                if (daysLeft > 0) {
                    statusText = `VIPä¼šå‘˜ Â· å‰©ä½™${daysLeft}å¤© Â· ä»Šæ—¥è¿˜å¯ç”¨${remainingQuota}æ¬¡`;
                } else {
                    statusText = 'VIPå·²è¿‡æœŸ Â· ç‚¹å‡»ç»­è´¹';
                }
                
                vipStatusDescEl.textContent = statusText;
                console.log('VIPçŠ¶æ€æè¿°å·²æ›´æ–°:', statusText);
                
            } else if (vipStatusData.is_vip) {
                // VIPç”¨æˆ·ä½†æ²¡æœ‰è¿‡æœŸæ—¶é—´ä¿¡æ¯
                const remainingQuota = vipStatusData.remaining_quota || 0;
                const statusText = `VIPä¼šå‘˜ Â· ä»Šæ—¥è¿˜å¯ç”¨${remainingQuota}æ¬¡`;
                vipStatusDescEl.textContent = statusText;
                console.log('VIPçŠ¶æ€æè¿°å·²æ›´æ–°:', statusText);
                
            } else {
                // æ™®é€šç”¨æˆ· - æ˜¾ç¤ºå‰©ä½™å…è´¹æ¬¡æ•°
                const remainingQuota = vipStatusData.remaining_quota || 0;
                const dailyQuota = vipStatusData.daily_quota || 3;
                
                let statusText = '';
                if (remainingQuota > 0) {
                    statusText = `å…è´¹ç”¨æˆ· Â· ä»Šæ—¥è¿˜å¯ç”¨${remainingQuota}æ¬¡ Â· å‡çº§VIPäº«ç‰¹æƒ`;
                } else {
                    statusText = 'ä»Šæ—¥å…è´¹æ¬¡æ•°å·²ç”¨å®Œ Â· å‡çº§VIPæ— é™ä½¿ç”¨';
                }
                
                vipStatusDescEl.textContent = statusText;
                console.log('æ™®é€šç”¨æˆ·çŠ¶æ€æè¿°å·²æ›´æ–°:', statusText);
            }
            
            console.log('=== ä¼šå‘˜ä¸­å¿ƒçŠ¶æ€æè¿°æ›´æ–°å®Œæˆ ===');
        }
        
        // ä¼˜åŒ–çš„å¤´åƒè®¾ç½®å‡½æ•°
        function setUserAvatar(element, avatarUrl, isChild = false) {
            if (!element) return;
            
            const defaultEmoji = isChild ? 'ğŸ‘¶' : 'ğŸ‘¤';
            
            if (avatarUrl && avatarUrl.startsWith('emoji:')) {
                // è¡¨æƒ…å¤´åƒ - ç›´æ¥è®¾ç½®ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚
                const emoji = avatarUrl.replace('emoji:', '');
                element.innerHTML = emoji;
                console.log('è¡¨æƒ…å¤´åƒå·²è®¾ç½®:', emoji);
                
            } else if (avatarUrl && avatarUrl.startsWith('data:image/')) {
                // base64ç¼–ç çš„å›¾ç‰‡æ•°æ® - ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚
                element.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='${defaultEmoji}';">`;
                console.log('base64å¤´åƒå·²è®¾ç½®');
                
            } else if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.includes('.jpg') || avatarUrl.includes('.png'))) {
                // å›¾ç‰‡å¤´åƒ - ä½¿ç”¨ç¼“å­˜ï¼Œåªåœ¨å¿…è¦æ—¶æ·»åŠ æ—¶é—´æˆ³
                const fullUrl = avatarUrl.startsWith('/') ? `http://localhost:8000${avatarUrl}` : avatarUrl;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶åˆ·æ–°ï¼ˆå¤šä¸ªæ¡ä»¶åˆ¤æ–­ï¼‰
                const sessionNeedRefresh = sessionStorage.getItem('avatarUpdated') === 'true';
                const globalNeedRefresh = window.recentAvatarUpdate === true;
                const needRefresh = sessionNeedRefresh || globalNeedRefresh;
                
                let finalUrl = fullUrl;
                
                if (needRefresh) {
                    const separator = fullUrl.includes('?') ? '&' : '?';
                    finalUrl = `${fullUrl}${separator}t=${Date.now()}`;
                    console.log('å¼ºåˆ¶åˆ·æ–°å¤´åƒ (session:', sessionNeedRefresh, ', global:', globalNeedRefresh, '):', finalUrl);
                    
                    // æ¸…é™¤sessionæ ‡è®°ï¼Œä½†ä¿ç•™å…¨å±€æ ‡è®°ä¾›å…¶ä»–å¤´åƒå…ƒç´ ä½¿ç”¨
                    if (sessionNeedRefresh) {
                        sessionStorage.removeItem('avatarUpdated');
                    }
                } else {
                    console.log('ä½¿ç”¨ç¼“å­˜å¤´åƒ:', finalUrl);
                }
                
                element.innerHTML = `<img src="${finalUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="console.error('å¤´åƒåŠ è½½å¤±è´¥:', '${fullUrl}'); this.parentElement.innerHTML='${defaultEmoji}';">`;
                
            } else {
                // é»˜è®¤å¤´åƒ
                element.innerHTML = defaultEmoji;
                console.log('ä½¿ç”¨é»˜è®¤å¤´åƒ');
            }
        }

        
        // é”™é¢˜æœ¬æ•°é‡ç›¸å…³å‡½æ•°å·²ç§»é™¤

        // å¤´åƒç¼–è¾‘ç›¸å…³å˜é‡
        let selectedAvatarType = null; // 'file' æˆ– 'default'
        let selectedFile = null;
        let selectedDefaultAvatar = null;
        
        function editAvatar() {
            console.log('editAvatar è¢«è°ƒç”¨');
            
            // æ˜¾ç¤ºå½“å‰å¤´åƒ
            const currentAvatar = document.getElementById('userAvatar').innerHTML;
            console.log('å½“å‰å¤´åƒå†…å®¹:', currentAvatar);
            document.getElementById('avatarPreview').innerHTML = currentAvatar;
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            console.log('é‡ç½®é€‰æ‹©çŠ¶æ€');
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
            updateSaveButton();
            
            // æ˜¾ç¤ºå¤´åƒç¼–è¾‘æ¨¡æ€æ¡†
            console.log('æ˜¾ç¤ºå¤´åƒç¼–è¾‘æ¨¡æ€æ¡†');
            document.getElementById('avatarModal').style.display = 'flex';
            
            // ç¡®ä¿æ–‡ä»¶è¾“å…¥ç›‘å¬å™¨æ­£å¸¸å·¥ä½œ
            setTimeout(() => {
                const avatarFileInput = document.getElementById('avatarFileInput');
                if (avatarFileInput) {
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰
                    avatarFileInput.removeEventListener('change', handleFileSelect);
                    avatarFileInput.addEventListener('change', handleFileSelect);
                    console.log('æ¨¡æ€æ¡†ä¸­çš„æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨å·²é‡æ–°è®¾ç½®');
                }
            }, 50);
        }
        
        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            
            // æ¸…ç†æ–‡ä»¶è¾“å…¥
            document.getElementById('avatarFileInput').value = '';
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
        }
        
        function selectAvatarFile() {
            console.log('selectAvatarFile è¢«è°ƒç”¨');
            const fileInput = document.getElementById('avatarFileInput');
            console.log('æ–‡ä»¶è¾“å…¥å…ƒç´ :', fileInput);
            
            if (fileInput) {
                try {
                    fileInput.click();
                    console.log('å·²è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨');
                } catch (error) {
                    console.error('è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥:', error);
                    showToast('æ–‡ä»¶é€‰æ‹©å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                showToast('æ–‡ä»¶é€‰æ‹©åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        function selectDefaultAvatar() {
            // ç”Ÿæˆé»˜è®¤å¤´åƒé€‰é¡¹
            generateDefaultAvatars();
            document.getElementById('defaultAvatarModal').style.display = 'flex';
        }
        
        function generateDefaultAvatars() {
            const avatars = ['ğŸ‘¤', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜„', 'ğŸ¥³', 'ğŸ¤—', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‹', 'ğŸ¤“', 'ğŸ§'];
            const avatarGrid = document.getElementById('avatarGrid');
            
            avatarGrid.innerHTML = '';
            
            avatars.forEach(avatar => {
                const avatarItem = document.createElement('div');
                avatarItem.className = 'default-avatar-item';
                avatarItem.textContent = avatar;
                avatarItem.onclick = () => selectDefaultAvatarItem(avatar, avatarItem);
                avatarGrid.appendChild(avatarItem);
            });
        }
        
        function selectDefaultAvatarItem(avatar, element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.default-avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰é¡¹
            element.classList.add('selected');
            selectedDefaultAvatar = avatar;
            selectedAvatarType = 'default';
            
            // æ›´æ–°é¢„è§ˆ
            document.getElementById('avatarPreview').innerHTML = avatar;
            
            // å…³é—­é»˜è®¤å¤´åƒé€‰æ‹©æ¨¡æ€æ¡†
            setTimeout(() => {
                document.getElementById('defaultAvatarModal').style.display = 'none';
                updateSaveButton();
            }, 300);
        }
        
        function closeDefaultAvatarModal() {
            document.getElementById('defaultAvatarModal').style.display = 'none';
        }
        
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ç›‘å¬å°†åœ¨initPageä¸­è®¾ç½®
        
        function handleFileSelect(event) {
            console.log('handleFileSelect è¢«è°ƒç”¨');
            const file = event.target.files[0];
            
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);
            if (!file) {
                console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            console.log('æ–‡ä»¶ä¿¡æ¯:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                console.log('æ–‡ä»¶ç±»å‹ä¸åŒ¹é…:', file.type);
                showToast('è¯·é€‰æ‹©JPGæˆ–PNGæ ¼å¼çš„å›¾ç‰‡');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                console.log('æ–‡ä»¶å¤ªå¤§:', file.size);
                showToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            
            console.log('æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œè®¾ç½®selectedFile');
            selectedFile = file;
            selectedAvatarType = 'file';
            console.log('è®¾ç½®åçš„çŠ¶æ€:', { selectedAvatarType, selectedFile: selectedFile?.name });
            
            // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œæ›´æ–°é¢„è§ˆ');
                const previewContainer = document.getElementById('avatarPreview');
                console.log('é¢„è§ˆå®¹å™¨:', previewContainer);
                
                if (previewContainer) {
                    previewContainer.innerHTML = 
                        `<img src="${e.target.result}" alt="å¤´åƒé¢„è§ˆ" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    console.log('é¢„è§ˆå›¾ç‰‡å·²è®¾ç½®');
                } else {
                    console.error('æ‰¾ä¸åˆ°é¢„è§ˆå®¹å™¨ avatarPreview');
                }
                updateSaveButton();
            };
            reader.onerror = function(e) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', e);
                showToast('å›¾ç‰‡é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©');
            };
            reader.readAsDataURL(file);
        }
        
        function updateSaveButton() {
            console.log('updateSaveButton è¢«è°ƒç”¨');
            const saveBtn = document.getElementById('saveAvatarBtn');
            console.log('ä¿å­˜æŒ‰é’®å…ƒç´ :', saveBtn);
            console.log('å½“å‰selectedAvatarType:', selectedAvatarType);
            
            if (selectedAvatarType) {
                console.log('å¯ç”¨ä¿å­˜æŒ‰é’®');
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                console.log('ç¦ç”¨ä¿å­˜æŒ‰é’®');
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }
        
        async function saveAvatar() {
            console.log('=== saveAvatar å¼€å§‹æ‰§è¡Œ ===');
            
            // ç¡®ä¿è·å–æœ€æ–°çš„token
            token = getCurrentTokenSafe();
            
            console.log('å½“å‰çŠ¶æ€æ£€æŸ¥:', { 
                selectedAvatarType, 
                selectedFile: selectedFile?.name, 
                selectedDefaultAvatar,
                token: token ? `å­˜åœ¨(${token.substring(0, 20)}...)` : 'ç¼ºå¤±'
            });
            
            if (!selectedAvatarType) {
                console.log('âŒ æ²¡æœ‰é€‰æ‹©å¤´åƒç±»å‹');
                showToast('è¯·å…ˆé€‰æ‹©å¤´åƒ');
                return;
            }
            
            if (!token) {
                console.log('âŒ Tokenç¼ºå¤±');
                showToast('ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                return;
            }
            
            const saveBtn = document.getElementById('saveAvatarBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;
                
                console.log('âœ… å¼€å§‹ä¿å­˜å¤´åƒï¼Œç±»å‹:', selectedAvatarType);
                
                let response;
                
                if (selectedAvatarType === 'file') {
                    console.log('ğŸ“ å¤„ç†æ–‡ä»¶ä¸Šä¼ ');
                    
                    if (!selectedFile) {
                        throw new Error('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                    }
                    
                    console.log('æ–‡ä»¶ä¿¡æ¯:', {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type
                    });
                    
                    // åˆ›å»ºFormData
                    const formData = new FormData();
                    formData.append('avatar_file', selectedFile);
                    
                    console.log('ğŸš€ å‘é€æ–‡ä»¶ä¸Šä¼ è¯·æ±‚...');
                    response = await fetch(`${API_BASE}/user/upload-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                } else if (selectedAvatarType === 'default') {
                    console.log('ğŸ˜Š å¤„ç†é»˜è®¤å¤´åƒè®¾ç½®');
                    console.log('é€‰ä¸­çš„è¡¨æƒ…:', selectedDefaultAvatar);
                    
                    if (!selectedDefaultAvatar) {
                        throw new Error('æ²¡æœ‰é€‰æ‹©é»˜è®¤å¤´åƒ');
                    }
                    
                    console.log('ğŸš€ å‘é€é»˜è®¤å¤´åƒè®¾ç½®è¯·æ±‚...');
                    response = await fetch(`${API_BASE}/user/set-default-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            avatar_emoji: selectedDefaultAvatar
                        })
                    });
                }
                
                console.log('ğŸ“¡ æœåŠ¡å™¨å“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… å¤´åƒæ›´æ–°æˆåŠŸ:', result);
                    
                    showToast('å¤´åƒæ›´æ–°æˆåŠŸ');
                    closeAvatarModal();
                    
                    
                    // è®¾ç½®å¤´åƒæ›´æ–°æ ‡è®°ï¼Œä¸‹æ¬¡åŠ è½½æ—¶ä¼šå¼ºåˆ¶åˆ·æ–°ç¼“å­˜
                    sessionStorage.setItem('avatarUpdated', 'true');
                    
                    // è®¾ç½®å…¨å±€æ ‡è®°ï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·è§’è‰²çš„å¤´åƒéƒ½èƒ½å¼ºåˆ¶åˆ·æ–°
                    window.recentAvatarUpdate = true;
                    console.log('âœ… è®¾ç½®å¤´åƒæ›´æ–°å…¨å±€æ ‡è®°');
                    
                    // ç«‹å³æ›´æ–°localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯
                    console.log('ğŸ”„ ç«‹å³æ›´æ–°localStorageå’Œå…¨å±€ç”¨æˆ·ä¿¡æ¯...');
                    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                    
                    // æ ¹æ®ä¸åŒçš„APIå“åº”ç»“æ„è·å–å¤´åƒURL
                    let newAvatarUrl = null;
                    if (selectedAvatarType === 'file' && result.avatar_url) {
                        // æ–‡ä»¶ä¸Šä¼ çš„å“åº”ç»“æ„ï¼š{ avatar_url, message, uploaded_at }
                        newAvatarUrl = result.avatar_url;
                        console.log('ğŸ“ ä»æ–‡ä»¶ä¸Šä¼ å“åº”è·å–å¤´åƒURL:', newAvatarUrl);
                    } else if (selectedAvatarType === 'default' && result.avatar_emoji) {
                        // é»˜è®¤å¤´åƒçš„å“åº”ç»“æ„ï¼š{ avatar_emoji, message, updated_at }
                        newAvatarUrl = `emoji:${result.avatar_emoji}`;
                        console.log('ğŸ˜Š ä»é»˜è®¤å¤´åƒå“åº”æ„é€ å¤´åƒURL:', newAvatarUrl);
                    } else {
                        console.error('âŒ æ— æ³•ä»APIå“åº”ä¸­è·å–å¤´åƒä¿¡æ¯:', { selectedAvatarType, result });
                    }
                    
                    if (newAvatarUrl) {
                        currentUser.avatar_url = newAvatarUrl;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        
                        // æ›´æ–°å…¨å±€userInfoå˜é‡
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            userInfo.avatar_url = newAvatarUrl;
                            console.log('âœ… å…¨å±€userInfoå¤´åƒå·²æ›´æ–°:', newAvatarUrl);
                        }
                        
                        // ç«‹å³æ›´æ–°ä¸»é¡µé¢ä¸Šçš„å¤´åƒæ˜¾ç¤º
                        console.log('ğŸ–¼ï¸ ç«‹å³æ›´æ–°ä¸»é¡µé¢å¤´åƒæ˜¾ç¤º...');
                        immediateUpdateAvatarDisplay(newAvatarUrl);
                    } else {
                        console.error('âŒ æ— æ³•æ›´æ–°å¤´åƒï¼ŒnewAvatarUrlä¸ºç©º');
                    }
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥æ›´æ–°å¤´åƒæ˜¾ç¤ºï¼ˆä½œä¸ºå¤‡ç”¨ä¿éšœï¼‰
                    console.log('ğŸ”„ é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™');
                    const currentRole = AuthUtils.getCurrentUserRole() || 'student';
                    setTimeout(() => loadUserProfile(currentRole, true), 500); // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æœåŠ¡å™¨å·²ç»å¤„ç†å®Œæ¯•ï¼Œå¼ºåˆ¶åˆ·æ–°
                } else {
                    // å¤„ç†HTTPé”™è¯¯
                    const responseText = await response.text();
                    console.error('âŒ APIå“åº”å¤±è´¥:', {
                        status: response.status,
                        statusText: response.statusText,
                        responseText
                    });
                    
                    let errorMessage = 'å¤´åƒæ›´æ–°å¤±è´¥';
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        console.log('å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // ç‰¹æ®ŠçŠ¶æ€ç å¤„ç†
                    if (response.status === 401) {
                        errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                        setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                    } else if (response.status === 403) {
                        errorMessage = 'æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ';
                    } else if (response.status === 413) {
                        errorMessage = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡';
                    } else if (response.status === 400) {
                        errorMessage = errorMessage || 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼';
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤´åƒå¼‚å¸¸:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                let userMessage = 'å¤´åƒæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
                
                // ç½‘ç»œé”™è¯¯å¤„ç†
                if (error.name === 'NetworkError' || error.message.includes('fetch')) {
                    userMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                } else if (error.message.includes('ç™»å½•') || error.message.includes('401')) {
                    userMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                    setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                } else if (error.message) {
                    userMessage = error.message;
                }
                
                showToast(userMessage);
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                console.log('ğŸ”„ æŒ‰é’®çŠ¶æ€å·²æ¢å¤');
            }
            
            console.log('=== saveAvatar æ‰§è¡Œå®Œæˆ ===');
        }

        function editProfile() {
            console.log('editProfile è¢«è°ƒç”¨');
            
            // è·å–ç”¨æˆ·è§’è‰²
            const role = AuthUtils.getCurrentUserRole();
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', role);
            
            // æ ¹æ®è§’è‰²ç”Ÿæˆä¸åŒçš„è¡¨å•å†…å®¹
            generateEditForm(role);
            
            // æ˜¾ç¤ºç¼–è¾‘ä¸ªäººèµ„æ–™æ¨¡æ€æ¡†
            document.getElementById('editProfileModal').style.display = 'flex';
            
            // è·å–æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯å¹¶å¡«å……è¡¨å•
            refreshUserInfoAndFillForm(role);
        }
        
        async function refreshUserInfoAndFillForm(role) {
            console.log('=== è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¹¶å¡«å……è¡¨å• ===');
            
            try {
                // é¦–å…ˆå°è¯•ä»localStorageè·å–æœ€æ–°æ•°æ®
                const storedUser = localStorage.getItem('user');
                let latestUserInfo = userInfo; // é»˜è®¤ä½¿ç”¨å½“å‰çš„userInfo
                
                if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        if (parsedUser && parsedUser.avatar_url !== userInfo?.avatar_url) {
                            console.log('localStorageä¸­å‘ç°æ›´æ–°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨æœ€æ–°æ•°æ®');
                            latestUserInfo = parsedUser;
                            userInfo = parsedUser; // åŒæ­¥å…¨å±€å˜é‡
                        }
                    } catch (error) {
                        console.error('è§£ælocalStorageç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
                
                // ğŸš¨ å®¶é•¿ç”¨æˆ·ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥å¤´åƒæ˜¯å¦æœ‰æ›´æ–° ğŸš¨
                if (role === 'parent') {
                    console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿ç”¨æˆ·ç¼–è¾‘ä¸ªäººèµ„æ–™ï¼Œæ£€æŸ¥å¤´åƒæ›´æ–°çŠ¶æ€...');
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤´åƒæ›´æ–°æ ‡è®°
                    const avatarUpdated = sessionStorage.getItem('avatarUpdated');
                    if (avatarUpdated === 'true') {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°å¤´åƒå·²æ›´æ–°ï¼Œå¼ºåˆ¶ä»localStorageåˆ·æ–°æ•°æ®');
                        
                        // å¼ºåˆ¶ä»localStorageè·å–æœ€æ–°æ•°æ®
                        if (storedUser) {
                            const refreshedUser = JSON.parse(storedUser);
                            latestUserInfo = refreshedUser;
                            userInfo = refreshedUser;
                            console.log('âœ… å®¶é•¿ç”¨æˆ·æ•°æ®å¼ºåˆ¶åˆ·æ–°å®Œæˆï¼Œå¤´åƒURL:', refreshedUser.avatar_url);
                        }
                        
                        // æ¸…é™¤æ ‡è®°
                        sessionStorage.removeItem('avatarUpdated');
                    }
                }
                
                // å¦‚æœæœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå¡«å……è¡¨å•
                if (latestUserInfo) {
                    console.log('ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯å¡«å……è¡¨å•:', latestUserInfo);
                    fillFormData(role, latestUserInfo);
                    
                    
                } else {
                    console.warn('æ²¡æœ‰å¯ç”¨çš„ç”¨æˆ·ä¿¡æ¯');
                    // å°è¯•ä»APIè·å–æœ€æ–°ä¿¡æ¯
                    await fetchLatestUserInfo(role);
                }
                
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // ä½¿ç”¨ç°æœ‰çš„userInfoä½œä¸ºåå¤‡
                if (userInfo) {
                    fillFormData(role, userInfo);
                }
            }
        }
        
        async function fetchLatestUserInfo(role) {
            console.log('ä»APIè·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯');
            
            try {
                // ç¡®ä¿è·å–æœ€æ–°çš„token
                token = getCurrentTokenSafe();
                console.log('ğŸ“¡ fetchLatestUserInfoè·å–token:', token ? 'OK' : 'NONE');
                
                const response = await fetch(`${API_BASE}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const latestUser = await response.json();
                    console.log('ä»APIè·å–åˆ°æœ€æ–°ç”¨æˆ·ä¿¡æ¯:', latestUser);
                    
                    // æ›´æ–°å…¨å±€ç”¨æˆ·ä¿¡æ¯
                    userInfo = latestUser;
                    localStorage.setItem('user', JSON.stringify(latestUser));
                    
                    // å¡«å……è¡¨å•
                    fillFormData(role, latestUser);
                } else {
                    console.error('APIè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', response.status);
                    // ä½¿ç”¨ç°æœ‰ä¿¡æ¯
                    if (userInfo) {
                        fillFormData(role, userInfo);
                    }
                }
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                // ä½¿ç”¨ç°æœ‰ä¿¡æ¯
                if (userInfo) {
                    fillFormData(role, userInfo);
                }
            }
        }
        
        function generateEditForm(role) {
            console.log('=== ç”Ÿæˆç¼–è¾‘è¡¨å• ===');
            const form = document.getElementById('editProfileForm');
            
            if (role === 'parent') {
                // å®¶é•¿ç”¨æˆ·è¡¨å•ï¼šåç§°ã€æ‰‹æœºå·ã€é‚®ç®±
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">å§“å <span style="color: red;">*</span></label>
                        <input type="text" class="form-input" id="editName" placeholder="è¯·è¾“å…¥å§“å" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰‹æœºå· <span style="color: red;">*</span></label>
                        <input type="tel" class="form-input" id="editPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11" pattern="[0-9]{1,11}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‚®ç®± <span style="color: red;">*</span></label>
                        <input type="email" class="form-input" id="editEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
                        <div class="form-error" id="emailError" style="display: none; color: #ff3b30; font-size: 12px; margin-top: 4px;"></div>
                    </div>
                    <!-- å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰é’®åŒºåŸŸ -->
                    <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                        <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">å–æ¶ˆ</button>
                        <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">ä¿å­˜</button>
                    </div>
                `;
            } else {
                // å­¦ç”Ÿç”¨æˆ·è¡¨å•ï¼šæ˜µç§°ã€å¹´çº§ã€ç­çº§ã€å­¦æ ¡
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">æ˜µç§° <span style="color: red;">*</span></label>
                        <input type="text" class="form-input" id="editNickname" placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¹´çº§ <span style="color: red;">*</span></label>
                        <select class="form-input" id="editGrade" required>
                            <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                            <option value="ä¸€å¹´çº§">ä¸€å¹´çº§</option>
                            <option value="äºŒå¹´çº§">äºŒå¹´çº§</option>
                            <option value="ä¸‰å¹´çº§">ä¸‰å¹´çº§</option>
                            <option value="å››å¹´çº§">å››å¹´çº§</option>
                            <option value="äº”å¹´çº§">äº”å¹´çº§</option>
                            <option value="å…­å¹´çº§">å…­å¹´çº§</option>
                            <option value="ä¸ƒå¹´çº§">ä¸ƒå¹´çº§</option>
                            <option value="å…«å¹´çº§">å…«å¹´çº§</option>
                            <option value="ä¹å¹´çº§">ä¹å¹´çº§</option>
                            <option value="é«˜ä¸€">é«˜ä¸€</option>
                            <option value="é«˜äºŒ">é«˜äºŒ</option>
                            <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç­çº§ <span style="color: red;">*</span></label>
                        <select class="form-input" id="editClass" required>
                            <option value="">è¯·å…ˆé€‰æ‹©å¹´çº§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å­¦æ ¡</label>
                        <input type="text" class="form-input" id="editSchool" placeholder="è¯·è¾“å…¥å­¦æ ¡åç§°">
                    </div>
                    <!-- å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰é’®åŒºåŸŸ -->
                    <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                        <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">å–æ¶ˆ</button>
                        <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">ä¿å­˜</button>
                    </div>
                `;
                
                // å­¦ç”Ÿç”¨æˆ·éœ€è¦åˆå§‹åŒ–å¹´çº§-ç­çº§è”åŠ¨
                setTimeout(() => {
                    initEditProfileGradeClassBinding();
                }, 50);
            }
            
            // å¦‚æœæ˜¯å®¶é•¿ç”¨æˆ·ï¼Œæ·»åŠ å®æ—¶é‚®ç®±éªŒè¯
            if (role === 'parent') {
                console.log('å®¶é•¿ç”¨æˆ·è¡¨å•ï¼Œå¼€å§‹è®¾ç½®é‚®ç®±éªŒè¯ï¼ˆå¢å¼ºç‰ˆï¼‰...');
                
                // ç«‹å³å°è¯•è®¾ç½®éªŒè¯
                setupParentEmailValidation();
                
                // ä¸ºç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­å†æ¬¡å°è¯•
                setTimeout(() => {
                    console.log('ğŸ”„ å»¶è¿ŸéªŒè¯ç»‘å®šæ£€æŸ¥');
                    setupParentEmailValidation();
                }, 0);
            }
            
            console.log(`âœ… ${role === 'parent' ? 'å®¶é•¿' : 'å­¦ç”Ÿ'}ç¼–è¾‘è¡¨å•ç”Ÿæˆå®Œæˆ`);
        }
        
        function fillFormData(role, userInfo) {
            console.log('=== å¡«å……è¡¨å•æ•°æ® ===', { role, userInfo });
            
            if (role === 'parent') {
                // å®¶é•¿ç”¨æˆ·æ•°æ®å¡«å……
                document.getElementById('editName').value = userInfo.name || userInfo.nickname || '';
                document.getElementById('editPhone').value = userInfo.phone || '';
                document.getElementById('editEmail').value = userInfo.email || '';
            } else {
                // å­¦ç”Ÿç”¨æˆ·æ•°æ®å¡«å……
                // é¦–å…ˆä»settingsä¸­æå–class_nameå’Œschoolï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let extractedClassname = userInfo.class_name;
                let extractedSchool = userInfo.school;
                
                if (userInfo.settings) {
                    console.log('ä»settingsä¸­æå–æ•°æ®:', userInfo.settings);
                    if (userInfo.settings.class_name !== undefined) {
                        extractedClassname = userInfo.settings.class_name;
                    }
                    if (userInfo.settings.school !== undefined) {
                        extractedSchool = userInfo.settings.school;
                    }
                }
                
                console.log('ğŸ“ å­¦ç”Ÿå­—æ®µè¯¦ç»†æ£€æŸ¥:', {
                    nickname: userInfo.nickname,
                    grade: userInfo.grade,
                    class_name: extractedClassname,
                    school: extractedSchool,
                    'å®Œæ•´userInfo': userInfo,
                    'ä»settingsæå–': {
                        class_name: extractedClassname,
                        school: extractedSchool
                    }
                });
                
                document.getElementById('editNickname').value = userInfo.nickname || '';
                document.getElementById('editGrade').value = userInfo.grade || '';
                document.getElementById('editSchool').value = extractedSchool || '';
                
                console.log('âœ… è¡¨å•å­—æ®µè®¾ç½®å®Œæˆ:', {
                    nickname: document.getElementById('editNickname').value,
                    grade: document.getElementById('editGrade').value,
                    school: document.getElementById('editSchool').value
                });
                
                // å¤„ç†å¹´çº§-ç­çº§è”åŠ¨
                const gradeSelect = document.getElementById('editGrade');
                const classSelect = document.getElementById('editClass');
                
                if (userInfo.grade) {
                    updateClassOptions(userInfo.grade, classSelect);
                    
                    // è®¾ç½®ç­çº§å€¼ - å¢åŠ å»¶è¿Ÿç¡®ä¿selecté€‰é¡¹å·²ç”Ÿæˆ
                    if (extractedClassname !== undefined) {
                        setTimeout(() => {
                            console.log('ğŸ« è®¾ç½®ç­çº§å­—æ®µå‰:', {
                                'extractedClassname': extractedClassname,
                                'classSelectå¯ç”¨é€‰é¡¹': Array.from(classSelect.options).map(o => o.value),
                                'classSelectå…ƒç´ å­˜åœ¨': !!classSelect
                            });
                            
                            classSelect.value = extractedClassname || '';
                            
                            console.log('ğŸ« è®¾ç½®ç­çº§å­—æ®µå:', {
                                'è®¾ç½®çš„å€¼': extractedClassname,
                                'å®é™…å€¼': classSelect.value,
                                'æ˜¯å¦åŒ¹é…': classSelect.value === (extractedClassname || '')
                            });
                        }, 200);
                    } else {
                        console.log('âš ï¸ extractedClassname æœªå®šä¹‰æˆ–ä¸ºç©º');
                    }
                } else {
                    classSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å¹´çº§</option>';
                }
            }
        }
        
        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
            
            // é‡ç½®è¡¨å•ï¼ˆå¦‚æœè¡¨å•å­˜åœ¨ï¼‰
            const form = document.getElementById('editProfileForm');
            if (form) {
                form.reset();
            }
            
        }

        async function saveProfile() {
            console.log('=== saveProfile() å‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
            
            // è·å–å½“å‰ç”¨æˆ·è§’è‰²
            const role = AuthUtils.getCurrentUserRole();
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', role);
            
            let requestData = {};
            let validationResult = {};
            
            if (role === 'parent') {
                console.log('ğŸ”§ å¤„ç†å®¶é•¿ç”¨æˆ·è¡¨å•æäº¤...');
                
                // ç›´æ¥è·å–è¡¨å•å­—æ®µå€¼ï¼Œç®€åŒ–æµç¨‹
                const nameEl = document.getElementById('editName');
                const phoneEl = document.getElementById('editPhone');
                const emailEl = document.getElementById('editEmail');
                
                console.log('ğŸ“‹ è¡¨å•å…ƒç´ æ£€æŸ¥:', {
                    name: !!nameEl,
                    phone: !!phoneEl, 
                    email: !!emailEl
                });
                
                if (!nameEl || !phoneEl || !emailEl) {
                    console.error('âŒ è¡¨å•å…ƒç´ ç¼ºå¤±');
                    showToast('è¡¨å•åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
                
                const name = nameEl.value.trim();
                const phone = phoneEl.value.trim();
                const email = emailEl.value.trim();
                
                console.log('ğŸ“ è·å–çš„è¡¨å•æ•°æ®:', { name, phone, email });
                
                // åŸºæœ¬éªŒè¯
                if (!name) {
                    showToast('è¯·è¾“å…¥å§“å');
                    return;
                }
                if (!phone) {
                    showToast('è¯·è¾“å…¥æ‰‹æœºå·');
                    return;
                }
                if (!email) {
                    showToast('è¯·è¾“å…¥é‚®ç®±');
                    return;
                }
                
                // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼');
                    return;
                }
                
                requestData = {
                    name: name,
                    phone: phone,
                    email: email
                };
                
                validationResult = { 
                    valid: true, 
                    data: { name, phone, email }
                };
                
            } else {
                // å­¦ç”Ÿç”¨æˆ·çš„è¡¨å•å¤„ç†
                validationResult = validateStudentForm();
                if (!validationResult.valid) {
                    showToast(validationResult.message);
                    return;
                }
                
                requestData = {
                    nickname: validationResult.data.nickname,
                    grade: validationResult.data.grade,
                    class_name: validationResult.data.classValue,
                    school: validationResult.data.school
                };
            }
            
            console.log('ğŸš€ æœ€ç»ˆè¯·æ±‚æ•°æ®:', requestData);
            
            try {
                console.log('=== å¼€å§‹å‘é€æ›´æ–°è¯·æ±‚ ===');
                
                // ç¡®ä¿è·å–æœ€æ–°çš„token
                token = getCurrentTokenSafe();
                console.log('ğŸ“¡ saveProfileè·å–token:', token ? 'OK' : 'NONE');
                
                // ç»Ÿä¸€ä½¿ç”¨ /user/profile ç«¯ç‚¹
                const apiEndpoint = `${API_BASE}/user/profile`;
                console.log('APIç«¯ç‚¹:', apiEndpoint, 'è§’è‰²:', role);
                
                const response = await fetch(apiEndpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ:', result);
                    
                    // é’ˆå¯¹ä¸åŒè§’è‰²çš„æ›´æ–°é€»è¾‘
                    if (role === 'parent' && requestData.name) {
                        console.log('ğŸ”„ ç«‹å³æ›´æ–°å®¶é•¿å§“åæ˜¾ç¤º...');
                        
                        // 1. æ›´æ–°é¡µé¢æ˜¾ç¤º
                        const userNameElement = document.getElementById('userName');
                        if (userNameElement) {
                            userNameElement.textContent = requestData.name;
                            console.log('âœ… é¡µé¢å§“åæ›´æ–°ä¸º:', requestData.name);
                            
                            // ç®€å•çš„è§†è§‰åé¦ˆ
                            userNameElement.style.backgroundColor = '#4CAF50';
                            userNameElement.style.color = 'white';
                            userNameElement.style.padding = '2px 6px';
                            userNameElement.style.borderRadius = '4px';
                            
                            setTimeout(() => {
                                userNameElement.style.backgroundColor = '';
                                userNameElement.style.color = '';
                                userNameElement.style.padding = '';
                                userNameElement.style.borderRadius = '';
                            }, 1000);
                        }
                        
                        // 2. æ›´æ–°localStorage
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        currentUser.name = requestData.name;
                        currentUser.nickname = requestData.name;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('âœ… å®¶é•¿localStorageæ›´æ–°å®Œæˆ');
                        
                        // 3. æ›´æ–°å…¨å±€userInfo
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            userInfo.name = requestData.name;
                            userInfo.nickname = requestData.name;
                            console.log('âœ… å®¶é•¿å…¨å±€userInfoæ›´æ–°å®Œæˆ');
                        }
                    } else if (role === 'student') {
                        console.log('ğŸ”„ ç«‹å³æ›´æ–°å­¦ç”Ÿä¿¡æ¯æ˜¾ç¤º...');
                        
                        // 1. æ›´æ–°localStorage - ç¡®ä¿å­¦ç”Ÿä¿¡æ¯æ­£ç¡®ä¿å­˜
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        if (requestData.nickname !== undefined) currentUser.nickname = requestData.nickname;
                        if (requestData.grade !== undefined) currentUser.grade = requestData.grade;
                        if (requestData.class_name !== undefined) currentUser.class_name = requestData.class_name;
                        if (requestData.school !== undefined) currentUser.school = requestData.school;
                        
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('âœ… å­¦ç”ŸlocalStorageæ›´æ–°å®Œæˆ:', {
                            nickname: requestData.nickname,
                            grade: requestData.grade,
                            class_name: requestData.class_name,
                            school: requestData.school
                        });
                        
                        // 2. æ›´æ–°å…¨å±€userInfo
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            if (requestData.nickname !== undefined) userInfo.nickname = requestData.nickname;
                            if (requestData.grade !== undefined) userInfo.grade = requestData.grade;
                            if (requestData.class_name !== undefined) userInfo.class_name = requestData.class_name;
                            if (requestData.school !== undefined) userInfo.school = requestData.school;
                            console.log('âœ… å­¦ç”Ÿå…¨å±€userInfoæ›´æ–°å®Œæˆ');
                        }
                        
                        // 3. ç«‹å³æ›´æ–°é¡µé¢æ‰€æœ‰æ˜¾ç¤ºå…ƒç´ 
                        console.log('ğŸ¨ å¼€å§‹æ›´æ–°å­¦ç”Ÿé¡µé¢æ˜¾ç¤º...');
                        
                        // 3.1 æ›´æ–°ç”¨æˆ·å/æ˜µç§°æ˜¾ç¤º
                        const userNameElement = document.getElementById('userName');
                        if (userNameElement && requestData.nickname) {
                            const oldName = userNameElement.textContent;
                            if (oldName !== requestData.nickname) {
                                userNameElement.textContent = requestData.nickname;
                                console.log('âœ… å­¦ç”Ÿé¡µé¢æ˜µç§°æ›´æ–°:', oldName, '->', requestData.nickname);
                            }
                        }
                        
                        // 3.2 æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼ˆè§’è‰²Â·å¹´çº§ï¼‰
                        const userInfoElement = document.getElementById('userInfo');
                        if (userInfoElement && requestData.grade) {
                            const gradeText = requestData.grade;
                            const newUserInfo = `å­¦ç”Ÿ Â· ${gradeText}`;
                            const oldUserInfo = userInfoElement.textContent;
                            if (oldUserInfo !== newUserInfo) {
                                userInfoElement.textContent = newUserInfo;
                                console.log('âœ… å­¦ç”Ÿé¡µé¢ä¿¡æ¯æ›´æ–°:', oldUserInfo, '->', newUserInfo);
                            }
                        }
                        
                        // 3.3 æ›´æ–°å¤´åƒæ˜¾ç¤ºï¼ˆå¦‚æœå¤´åƒæœ‰å˜åŒ–ï¼‰
                        if (requestData.avatar_url) {
                            console.log('ğŸ–¼ï¸ æ›´æ–°å­¦ç”Ÿå¤´åƒæ˜¾ç¤º...');
                            if (typeof updateAvatarDisplayInProfile === 'function') {
                                updateAvatarDisplayInProfile(currentUser);
                                console.log('âœ… å­¦ç”Ÿå¤´åƒæ˜¾ç¤ºå·²æ›´æ–°');
                            } else {
                                // å¤‡ç”¨å¤´åƒæ›´æ–°é€»è¾‘
                                const userAvatarElement = document.getElementById('userAvatar');
                                if (userAvatarElement) {
                                    if (requestData.avatar_url.startsWith('emoji:')) {
                                        const emoji = requestData.avatar_url.replace('emoji:', '');
                                        userAvatarElement.innerHTML = emoji;
                                    } else if (requestData.avatar_url.startsWith('data:') || requestData.avatar_url.startsWith('http')) {
                                        userAvatarElement.innerHTML = `<img src="${requestData.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="ç”¨æˆ·å¤´åƒ">`;
                                    }
                                    console.log('âœ… å­¦ç”Ÿå¤´åƒå¤‡ç”¨æ›´æ–°å®Œæˆ');
                                }
                            }
                        }
                        
                        console.log('ğŸ‰ å­¦ç”Ÿé¡µé¢æ˜¾ç¤ºæ›´æ–°å®Œæˆ');
                    }
                    
                    // é€šç”¨çš„æ›´æ–°é€»è¾‘ - ä»…åœ¨APIè¿”å›å®Œæ•´æ•°æ®æ—¶æ‰è¦†ç›–
                    if (result && result.user && Object.keys(result.user).length > 1) {
                        console.log('APIè¿”å›äº†å®Œæ•´ç”¨æˆ·æ•°æ®ï¼Œæ‰§è¡Œé€šç”¨æ›´æ–°');
                        // å¦‚æœAPIè¿”å›äº†ç”¨æˆ·æ•°æ®ï¼Œåˆå¹¶æ›´æ–°æœ¬åœ°å­˜å‚¨ï¼ˆä¿æŒç°æœ‰æ•°æ®ä¼˜å…ˆï¼‰
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        const updatedUser = { ...currentUser, ...result.user };
                        localStorage.setItem('user', JSON.stringify(updatedUser));
                        userInfo = updatedUser;
                        console.log('âœ… é€šç”¨æ›´æ–°å®Œæˆï¼Œæœ€ç»ˆç”¨æˆ·æ•°æ®:', updatedUser);
                    } else {
                        console.log('APIè¿”å›æ•°æ®ä¸å®Œæ•´ï¼Œä¿æŒå½“å‰æ‰‹åŠ¨è®¾ç½®çš„æ•°æ®');
                    }
                    
                    showToast('ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ');
                    
                    // ç®€å•å»¶æ—¶åå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        closeEditProfileModal();
                    }, 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    
                    let errorMessage = 'æ›´æ–°å¤±è´¥';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.detail || error.message || 'æ›´æ–°å¤±è´¥';
                    } catch (e) {
                        errorMessage = errorText || 'æ›´æ–°å¤±è´¥';
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥:', error);
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showToast('æ›´æ–°å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'));
            }
        }
        
        // é«˜çº§è°ƒè¯•å’Œç›‘æ§åŠŸèƒ½ - å¢å¼ºçš„é”™è¯¯è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§
        function setupAdvancedDebugging() {
            console.log('ğŸ”§ è®¾ç½®é«˜çº§è°ƒè¯•ç›‘æ§...');
            
            // ç›‘æ§é¡µé¢å§“åæ˜¾ç¤ºå˜åŒ–
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                console.log('ğŸ‘€ è®¾ç½®å§“åå˜åŒ–ç›‘æ§å™¨');
                let lastNameValue = userNameEl.textContent;
                
                const nameObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const currentName = userNameEl.textContent;
                            if (currentName !== lastNameValue) {
                                console.log('ğŸ”„ æ£€æµ‹åˆ°å§“åå˜åŒ–:', lastNameValue, 'â†’', currentName);
                                lastNameValue = currentName;
                                
                                // éªŒè¯localStorageæ˜¯å¦åŒæ­¥
                                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                                if (storedUser.name && storedUser.name !== currentName) {
                                    console.warn('âš ï¸ å§“åæ˜¾ç¤ºä¸localStorageä¸ä¸€è‡´');
                                    console.log('æ˜¾ç¤º:', currentName, 'localStorage:', storedUser.name);
                                }
                            }
                        }
                    });
                });
                
                nameObserver.observe(userNameEl, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
                
                console.log('âœ… å§“åå˜åŒ–ç›‘æ§å™¨å·²è®¾ç½®');
            }
            
            // ç›‘æ§localStorageå˜åŒ–
            let originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'user') {
                    try {
                        const userData = JSON.parse(value);
                        console.log('ğŸ’¾ localStorageç”¨æˆ·æ•°æ®æ›´æ–°:', {
                            name: userData.name,
                            nickname: userData.nickname,
                            avatar_url: userData.avatar_url ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'
                        });
                        
                        // å¦‚æœæ˜¯å®¶é•¿ç”¨æˆ·ï¼Œç‰¹åˆ«å…³æ³¨å§“åæ›´æ–°
                        if (userData.role === 'parent' && userData.name) {
                            console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿localStorageå§“åæ›´æ–°ä¸º:', userData.name);
                        }
                    } catch (e) {
                        console.log('ğŸ’¾ localStorageæ•°æ®æ›´æ–°ï¼ˆéJSONï¼‰');
                    }
                }
                return originalSetItem.call(this, key, value);
            };
            
            console.log('âœ… localStorageç›‘æ§å·²è®¾ç½®');
        }
        
        // å¼ºåŒ–çš„ç”¨æˆ·èµ„æ–™åŒæ­¥æ£€æŸ¥å‡½æ•°
        function performUserProfileSyncCheck() {
            console.log('ğŸ” æ‰§è¡Œç”¨æˆ·èµ„æ–™åŒæ­¥æ£€æŸ¥...');
            
            const role = AuthUtils.getCurrentUserRole();
            const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
            const displayedName = document.getElementById('userName')?.textContent;
            
            console.log('åŒæ­¥æ£€æŸ¥ç»“æœ:', {
                role: role,
                storedName: storedUser.name || storedUser.nickname,
                displayedName: displayedName,
                isParent: role === 'parent',
                isConsistent: (storedUser.name || storedUser.nickname) === displayedName
            });
            
            // å¦‚æœæ˜¯å®¶é•¿ç”¨æˆ·ä¸”æ•°æ®ä¸ä¸€è‡´ï¼Œæ‰§è¡Œä¿®å¤
            if (role === 'parent' && storedUser.name && displayedName !== storedUser.name) {
                console.log('ğŸ”§ æ£€æµ‹åˆ°å®¶é•¿ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´ï¼Œæ‰§è¡Œä¿®å¤...');
                
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    const oldName = userNameEl.textContent;
                    userNameEl.textContent = storedUser.name;
                    console.log('âœ… ä¿®å¤å®¶é•¿å§“åæ˜¾ç¤º:', oldName, 'â†’', storedUser.name);
                    
                    // æ·»åŠ ä¿®å¤æˆåŠŸçš„è§†è§‰æç¤º
                    userNameEl.style.backgroundColor = '#e3f2fd';
                    userNameEl.style.transition = 'background-color 0.3s ease';
                    setTimeout(() => {
                        userNameEl.style.backgroundColor = '';
                    }, 800);
                }
            }
            
            return {
                isConsistent: (storedUser.name || storedUser.nickname) === displayedName,
                role: role,
                expectedName: storedUser.name || storedUser.nickname,
                actualName: displayedName
            };
        }
        
        // æ™ºèƒ½é‡è¯•æœºåˆ¶ - ç¡®ä¿æ›´æ–°æˆåŠŸ
        function ensureUserProfileUpdateSuccess(maxRetries = 3) {
            console.log('ğŸ”„ å¯åŠ¨æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·èµ„æ–™æ›´æ–°æˆåŠŸ...');
            
            let retryCount = 0;
            
            function checkAndRetry() {
                const syncResult = performUserProfileSyncCheck();
                
                if (syncResult.isConsistent) {
                    console.log('âœ… ç”¨æˆ·èµ„æ–™åŒæ­¥æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€é‡è¯•');
                    return true;
                }
                
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`ğŸ”„ ç¬¬${retryCount}æ¬¡é‡è¯•ä¿®å¤ç”¨æˆ·èµ„æ–™æ˜¾ç¤º...`);
                    
                    // é‡æ–°æ‰§è¡Œç”¨æˆ·èµ„æ–™æ›´æ–°é€»è¾‘
                    const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                    if (storedUser) {
                        updateUserProfile(storedUser);
                        updateAvatarDisplayInProfile(storedUser);
                        
                        // å»¶è¿Ÿå†æ¬¡æ£€æŸ¥
                        setTimeout(() => {
                            checkAndRetry();
                        }, 500);
                    }
                } else {
                    console.warn('âš ï¸ é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œç”¨æˆ·èµ„æ–™å¯èƒ½å­˜åœ¨æ˜¾ç¤ºé—®é¢˜');
                }
            }
            
            // å¼€å§‹æ£€æŸ¥
            setTimeout(checkAndRetry, 100);
        }
        
        // é«˜çº§è°ƒè¯•å‡½æ•° - å®Œæ•´çš„ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        window.performSystemDiagnostics = function() {
            console.log('=== ğŸ¥ ç³»ç»Ÿè¯Šæ–­å¼€å§‹ ===');
            
            const role = AuthUtils.getCurrentUserRole();
            const token = AuthUtils.getCurrentToken();
            const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
            const userNameEl = document.getElementById('userName');
            const editModal = document.getElementById('editProfileModal');
            
            const diagnosticResults = {
                authentication: {
                    role: role,
                    hasToken: !!token,
                    tokenValid: token && token.length > 20
                },
                userData: {
                    hasStoredUser: !!storedUser && Object.keys(storedUser).length > 0,
                    storedName: storedUser.name || storedUser.nickname,
                    storedEmail: storedUser.email,
                    storedAvatar: !!storedUser.avatar_url
                },
                pageElements: {
                    userNameElement: !!userNameEl,
                    displayedName: userNameEl?.textContent,
                    editModal: !!editModal,
                    modalVisible: editModal?.style.display === 'flex'
                },
                consistency: {
                    nameMatch: (storedUser.name || storedUser.nickname) === userNameEl?.textContent,
                    roleConsistent: role === storedUser.role
                },
                emailValidation: {
                    emailInputExists: !!document.getElementById('editEmail'),
                    validationBound: document.getElementById('editEmail')?.hasAttribute('data-validation-bound'),
                    errorElementExists: !!document.getElementById('emailError')
                }
            };
            
            console.log('ğŸ“Š è¯Šæ–­ç»“æœ:', diagnosticResults);
            
            // æ£€æŸ¥é—®é¢˜å¹¶æä¾›ä¿®å¤å»ºè®®
            const issues = [];
            
            if (!diagnosticResults.consistency.nameMatch && role === 'parent') {
                issues.push('å®¶é•¿å§“åæ˜¾ç¤ºä¸ä¸€è‡´');
            }
            
            if (role === 'parent' && !diagnosticResults.emailValidation.validationBound) {
                issues.push('é‚®ç®±éªŒè¯æœªæ­£ç¡®ç»‘å®š');
            }
            
            if (!diagnosticResults.authentication.tokenValid) {
                issues.push('è®¤è¯ä»¤ç‰Œå¯èƒ½æ— æ•ˆ');
            }
            
            if (issues.length > 0) {
                console.warn('âš ï¸ å‘ç°é—®é¢˜:', issues);
                return { success: false, issues: issues, diagnostics: diagnosticResults };
            } else {
                console.log('âœ… ç³»ç»ŸçŠ¶æ€è‰¯å¥½');
                return { success: true, issues: [], diagnostics: diagnosticResults };
            }
        };
        
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šå¯åœ¨æ§åˆ¶å°è¿è¡Œ performSystemDiagnostics() è¿›è¡Œå®Œæ•´ç³»ç»Ÿæ£€æŸ¥');
        
        // è®¾ç½®å®¶é•¿ç”¨æˆ·é‚®ç®±å®æ—¶éªŒè¯ - å¢å¼ºç‰ˆ
        function setupParentEmailValidation() {
            console.log('=== è®¾ç½®å®¶é•¿ç”¨æˆ·é‚®ç®±éªŒè¯ï¼ˆå¢å¼ºç‰ˆï¼‰ ===');
            
            // ç«‹å³å°è¯•ç»‘å®š
            if (attemptEmailValidationBinding()) {
                console.log('âœ… é‚®ç®±éªŒè¯æˆåŠŸç»‘å®š');
                return;
            }
            
            // å¦‚æœç«‹å³ç»‘å®šå¤±è´¥ï¼Œä½¿ç”¨ MutationObserver ç›‘å¬ DOM å˜åŒ–
            console.log('ğŸ”„ DOMå…ƒç´ å°šæœªå°±ç»ªï¼Œå¯åŠ¨MutationObserverç›‘å¬...');
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // æ£€æŸ¥æ–°æ·»åŠ çš„èŠ‚ç‚¹ä¸­æ˜¯å¦åŒ…å«æˆ‘ä»¬éœ€è¦çš„å…ƒç´ 
                        const emailEl = document.getElementById('editEmail');
                        if (emailEl && !emailEl.hasAttribute('data-validation-bound')) {
                            console.log('ğŸ“§ é€šè¿‡MutationObserveræ£€æµ‹åˆ°é‚®ç®±è¾“å…¥æ¡†ï¼Œç«‹å³ç»‘å®šéªŒè¯');
                            if (attemptEmailValidationBinding()) {
                                observer.disconnect(); // æˆåŠŸç»‘å®šååœæ­¢è§‚å¯Ÿ
                                console.log('âœ… é‚®ç®±éªŒè¯ç»‘å®šæˆåŠŸï¼Œåœæ­¢MutationObserver');
                            }
                        }
                    }
                });
            });
            
            // å¼€å§‹è§‚å¯Ÿæ•´ä¸ª body çš„å˜åŒ–
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
            setTimeout(() => {
                observer.disconnect();
                console.log('â° MutationObserverè¶…æ—¶ï¼Œåœæ­¢ç›‘å¬');
                
                // æœ€åä¸€æ¬¡å°è¯•
                if (!attemptEmailValidationBinding()) {
                    console.error('âŒ æœ€ç»ˆå°è¯•ç»‘å®šé‚®ç®±éªŒè¯å¤±è´¥');
                }
            }, 3000);
        }
        
        // å°è¯•ç»‘å®šé‚®ç®±éªŒè¯çš„å…·ä½“å®ç°
        function attemptEmailValidationBinding() {
            const emailEl = document.getElementById('editEmail');
            const emailError = document.getElementById('emailError');
            
            console.log('ğŸ” å°è¯•ç»‘å®šé‚®ç®±éªŒè¯:', {
                emailEl: !!emailEl,
                emailError: !!emailError,
                alreadyBound: emailEl ? emailEl.hasAttribute('data-validation-bound') : false
            });
            
            if (!emailEl || !emailError) {
                console.log('âŒ å…³é”®å…ƒç´ ç¼ºå¤±ï¼Œè·³è¿‡ç»‘å®š');
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®šè¿‡
            if (emailEl.hasAttribute('data-validation-bound')) {
                console.log('âš ï¸ é‚®ç®±éªŒè¯å·²ç»ç»‘å®šè¿‡ï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return true;
            }
            
            console.log('âœ… å¼€å§‹ç»‘å®šé‚®ç®±éªŒè¯äº‹ä»¶');
            
            // æ ‡è®°å·²ç»‘å®šï¼Œé¿å…é‡å¤ç»‘å®š
            emailEl.setAttribute('data-validation-bound', 'true');
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶
            emailEl.addEventListener('input', function(e) {
                console.log('ğŸ“§ é‚®ç®±è¾“å…¥äº‹ä»¶è§¦å‘:', e.target.value);
                validateEmailRealTime(this.value.trim(), emailError);
                // ç«‹å³æ·»åŠ è§†è§‰åé¦ˆ
                if (e.target.value.trim()) {
                    e.target.style.backgroundColor = '#fff9c4'; // æ·¡é»„è‰²èƒŒæ™¯è¡¨ç¤ºæ­£åœ¨éªŒè¯
                }
            });
            
            // ç»‘å®šå¤±å»ç„¦ç‚¹äº‹ä»¶
            emailEl.addEventListener('blur', function(e) {
                console.log('ğŸ“§ é‚®ç®±å¤±å»ç„¦ç‚¹äº‹ä»¶è§¦å‘:', e.target.value);
                validateEmailRealTime(this.value.trim(), emailError);
                // æ¢å¤èƒŒæ™¯è‰²
                e.target.style.backgroundColor = '';
            });
            
            // ç»‘å®šç²˜è´´äº‹ä»¶
            emailEl.addEventListener('paste', function(e) {
                console.log('ğŸ“§ é‚®ç®±ç²˜è´´äº‹ä»¶è§¦å‘');
                setTimeout(() => {
                    validateEmailRealTime(this.value.trim(), emailError);
                }, 10);
            });
            
            // ç«‹å³éªŒè¯å½“å‰å€¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const currentValue = emailEl.value.trim();
            if (currentValue) {
                console.log('ğŸ“§ å‘ç°ç°æœ‰é‚®ç®±å€¼ï¼Œç«‹å³éªŒè¯:', currentValue);
                validateEmailRealTime(currentValue, emailError);
            }
            
            console.log('âœ… é‚®ç®±éªŒè¯äº‹ä»¶ç»‘å®šå®Œæˆ');
            return true;
        }
        
        // è°ƒè¯•å’Œæµ‹è¯•å‡½æ•° - å¯åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨
        window.testEmailValidation = function() {
            console.log('=== é‚®ç®±éªŒè¯æµ‹è¯•å¼€å§‹ ===');
            
            const emailEl = document.getElementById('editEmail');
            const emailError = document.getElementById('emailError');
            
            if (!emailEl || !emailError) {
                console.error('âŒ æµ‹è¯•å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                console.log('editEmailå…ƒç´ :', !!emailEl);
                console.log('emailErrorå…ƒç´ :', !!emailError);
                return false;
            }
            
            console.log('âœ… DOMå…ƒç´ æ£€æŸ¥é€šè¿‡');
            
            // æµ‹è¯•ç”¨ä¾‹
            const testCases = [
                { email: '', expected: false, desc: 'ç©ºé‚®ç®±' },
                { email: 'invalid', expected: false, desc: 'æ— æ•ˆæ ¼å¼1' },
                { email: '@example.com', expected: false, desc: 'æ— æ•ˆæ ¼å¼2' },
                { email: 'user@', expected: false, desc: 'æ— æ•ˆæ ¼å¼3' },
                { email: 'test@example.com', expected: true, desc: 'æœ‰æ•ˆé‚®ç®±' },
                { email: 'user.name@domain.co.uk', expected: true, desc: 'å¤æ‚æœ‰æ•ˆé‚®ç®±' }
            ];
            
            console.log('å¼€å§‹æµ‹è¯•é‚®ç®±éªŒè¯é€»è¾‘...');
            
            let passCount = 0;
            testCases.forEach((testCase, index) => {
                console.log(`\næµ‹è¯• ${index + 1}: ${testCase.desc}`);
                console.log(`è¾“å…¥: "${testCase.email}"`);
                
                // æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
                emailEl.value = testCase.email;
                
                // è§¦å‘éªŒè¯
                validateEmailRealTime(testCase.email, emailError);
                
                // æ£€æŸ¥ç»“æœ
                const isErrorHidden = emailError.style.display === 'none';
                const actualResult = isErrorHidden; // æ²¡æœ‰é”™è¯¯æ˜¾ç¤ºè¡¨ç¤ºéªŒè¯é€šè¿‡
                
                console.log(`æœŸæœ›: ${testCase.expected ? 'é€šè¿‡' : 'å¤±è´¥'}`);
                console.log(`å®é™…: ${actualResult ? 'é€šè¿‡' : 'å¤±è´¥'}`);
                console.log(`é”™è¯¯ä¿¡æ¯æ˜¾ç¤º: ${isErrorHidden ? 'éšè—' : 'æ˜¾ç¤º'}`);
                
                if (actualResult === testCase.expected) {
                    console.log('âœ… æµ‹è¯•é€šè¿‡');
                    passCount++;
                } else {
                    console.log('âŒ æµ‹è¯•å¤±è´¥');
                }
            });
            
            console.log(`\n=== æµ‹è¯•å®Œæˆ ===`);
            console.log(`é€šè¿‡ç‡: ${passCount}/${testCases.length} (${(passCount/testCases.length*100).toFixed(1)}%)`);
            
            // æµ‹è¯•äº‹ä»¶ç»‘å®š
            console.log('\næµ‹è¯•äº‹ä»¶ç»‘å®š...');
            const hasValidationBound = emailEl.hasAttribute('data-validation-bound');
            console.log('æ˜¯å¦å·²ç»‘å®šéªŒè¯:', hasValidationBound);
            
            if (hasValidationBound) {
                console.log('âœ… é‚®ç®±éªŒè¯ç³»ç»Ÿè¿è¡Œæ­£å¸¸');
                return true;
            } else {
                console.log('âŒ é‚®ç®±éªŒè¯äº‹ä»¶æœªç»‘å®š');
                return false;
            }
        };
        
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šå¯åœ¨æ§åˆ¶å°è¿è¡Œ testEmailValidation() æ¥æµ‹è¯•é‚®ç®±éªŒè¯åŠŸèƒ½');
        
        // è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•å®¶é•¿ç”¨æˆ·ä¿¡æ¯æ›´æ–°
        window.testParentProfileUpdate = function() {
            console.log('=== å®¶é•¿ç”¨æˆ·ä¿¡æ¯æ›´æ–°æµ‹è¯• ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('âš ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯å®¶é•¿ç”¨æˆ·ï¼Œæµ‹è¯•è·³è¿‡');
                return false;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('å½“å‰ç”¨æˆ·æ•°æ®:', currentUser);
            
            // æ£€æŸ¥é¡µé¢æ˜¾ç¤ºå…ƒç´ 
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.querySelector('#userAvatar') || document.querySelector('.user-info .avatar');
            
            console.log('é¡µé¢å…ƒç´ æ£€æŸ¥:', {
                userNameEl: !!userNameEl,
                userAvatarEl: !!userAvatarEl,
                displayedName: userNameEl?.textContent,
                expectedName: currentUser.name || currentUser.nickname || 'å®¶é•¿ç”¨æˆ·'
            });
            
            if (userNameEl) {
                const displayedName = userNameEl.textContent;
                const expectedName = currentUser.name || currentUser.nickname || 'å®¶é•¿ç”¨æˆ·';
                
                if (displayedName === expectedName) {
                    console.log('âœ… å§“åæ˜¾ç¤ºæ­£ç¡®');
                } else {
                    console.log('âŒ å§“åæ˜¾ç¤ºä¸æ­£ç¡®');
                    console.log('æ˜¾ç¤ºçš„å§“å:', displayedName);
                    console.log('æœŸæœ›çš„å§“å:', expectedName);
                    return false;
                }
            }
            
            if (userAvatarEl && currentUser && currentUser.avatar_url) {
                console.log('âœ… å¤´åƒå…ƒç´ å­˜åœ¨ï¼Œå¤´åƒURL:', currentUser.avatar_url);
                
                // è§¦å‘å¤´åƒæ›´æ–°æµ‹è¯•
                updateSingleAvatarDisplay(userAvatarEl, currentUser);
                console.log('âœ… å¤´åƒæ›´æ–°æµ‹è¯•å®Œæˆ');
            }
            
            console.log('âœ… å®¶é•¿ç”¨æˆ·ä¿¡æ¯æ›´æ–°æµ‹è¯•é€šè¿‡');
            return true;
        };
        
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šå¯åœ¨æ§åˆ¶å°è¿è¡Œ testParentProfileUpdate() æ¥æµ‹è¯•å®¶é•¿ç”¨æˆ·ä¿¡æ¯æ›´æ–°åŠŸèƒ½');
        
        // ä¸“é—¨æµ‹è¯•å®¶é•¿ç”¨æˆ·å§“åæ›´æ–°çš„å‡½æ•°
        window.testParentNameUpdate = function() {
            console.log('=== å®¶é•¿ç”¨æˆ·å§“åæ›´æ–°ä¸“é¡¹æµ‹è¯• ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('âš ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯å®¶é•¿ç”¨æˆ·');
                return false;
            }
            
            // æ£€æŸ¥è¡¨å•å…ƒç´ 
            const editNameEl = document.getElementById('editName');
            const userNameEl = document.getElementById('userName');
            
            console.log('è¡¨å•å’Œæ˜¾ç¤ºå…ƒç´ æ£€æŸ¥:', {
                editNameEl: !!editNameEl,
                userNameEl: !!userNameEl,
                editNameValue: editNameEl?.value,
                displayNameValue: userNameEl?.textContent
            });
            
            if (!editNameEl || !userNameEl) {
                console.error('âŒ å…³é”®å…ƒç´ ç¼ºå¤±');
                return false;
            }
            
            // è·å–å½“å‰æ•°æ®
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('localStorageç”¨æˆ·æ•°æ®:', {
                name: currentUser.name,
                nickname: currentUser.nickname
            });
            
            // æµ‹è¯•æ‰‹åŠ¨æ›´æ–°å§“åæ˜¾ç¤º
            const testName = 'æµ‹è¯•å®¶é•¿å§“å_' + Date.now();
            console.log('æµ‹è¯•å§“åæ›´æ–°ä¸º:', testName);
            
            // æ¨¡æ‹Ÿä¿å­˜åçš„æ›´æ–°é€»è¾‘
            userNameEl.textContent = testName;
            currentUser.name = testName;
            currentUser.nickname = testName;
            localStorage.setItem('user', JSON.stringify(currentUser));
            
            console.log('âœ… æµ‹è¯•å®Œæˆï¼Œå§“åå·²æ›´æ–°ä¸º:', testName);
            console.log('é¡µé¢æ˜¾ç¤º:', userNameEl.textContent);
            
            return true;
        };
        
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šå¯åœ¨æ§åˆ¶å°è¿è¡Œ testParentNameUpdate() æ¥ä¸“é—¨æµ‹è¯•å®¶é•¿ç”¨æˆ·å§“åæ›´æ–°');
        
        // ğŸ”§ å®¶é•¿ç”¨æˆ·å§“åæ›´æ–°é—®é¢˜ä¸“é¡¹ä¿®å¤æµ‹è¯•å‡½æ•°
        window.testParentNameUpdateFix = function() {
            console.log('=== ğŸ”§ å®¶é•¿ç”¨æˆ·å§“åæ›´æ–°ä¿®å¤æµ‹è¯• ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('âš ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯å®¶é•¿ç”¨æˆ·ï¼Œæµ‹è¯•åœæ­¢');
                return false;
            }
            
            // æ£€æŸ¥å…³é”®å…ƒç´ 
            const editNameEl = document.getElementById('editName');
            const userNameEl = document.getElementById('userName');
            
            if (!editNameEl || !userNameEl) {
                console.error('âŒ å…³é”®å…ƒç´ ç¼ºå¤±');
                console.log('editName:', !!editNameEl, 'userName:', !!userNameEl);
                return false;
            }
            
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            console.log('ğŸ“Š å½“å‰çŠ¶æ€:');
            console.log('- è¡¨å•å§“åå€¼:', editNameEl.value);
            console.log('- é¡µé¢æ˜¾ç¤ºå§“å:', userNameEl.textContent);
            console.log('- localStorageå§“å:', JSON.parse(localStorage.getItem('user') || '{}').name);
            
            // æ¨¡æ‹Ÿå§“åæ›´æ–°æµ‹è¯•
            const testName = 'TEST_å®¶é•¿_' + new Date().getTime();
            console.log('ğŸ§ª æµ‹è¯•æ›´æ–°å§“åä¸º:', testName);
            
            // æ¨¡æ‹Ÿè¶…çº§å¼ºåˆ¶æ›´æ–°é€»è¾‘
            const oldName = userNameEl.textContent;
            userNameEl.textContent = testName;
            console.log('âœ… é¡µé¢å§“åæ›´æ–°:', oldName, 'â†’', testName);
            
            // åŒæ—¶æ›´æ–°localStorage
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            currentUser.name = testName;
            currentUser.nickname = testName;
            localStorage.setItem('user', JSON.stringify(currentUser));
            console.log('âœ… localStorageæ›´æ–°å®Œæˆ');
            
            // æ·»åŠ è§†è§‰æ•ˆæœ
            userNameEl.style.backgroundColor = '#4CAF50';
            userNameEl.style.color = 'white';
            userNameEl.style.padding = '2px 6px';
            userNameEl.style.borderRadius = '4px';
            userNameEl.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                userNameEl.style.backgroundColor = '';
                userNameEl.style.color = '';
                userNameEl.style.padding = '';
                userNameEl.style.borderRadius = '';
                console.log('âœ… æµ‹è¯•å®Œæˆï¼å§“åå·²æ›´æ–°ä¸º:', testName);
            }, 1500);
            
            return true;
        };
        
        // ğŸ” å®¶é•¿ç”¨æˆ·ä¿å­˜æµç¨‹å®Œæ•´æµ‹è¯•å‡½æ•°
        window.testParentSaveFlow = function() {
            console.log('=== ğŸ” å®¶é•¿ç”¨æˆ·ä¿å­˜æµç¨‹æµ‹è¯• ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('âš ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯å®¶é•¿ç”¨æˆ·');
                return false;
            }
            
            // æ£€æŸ¥ç¼–è¾‘æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
            const editModal = document.getElementById('editProfileModal');
            if (!editModal || editModal.style.display !== 'flex') {
                console.warn('âš ï¸ è¯·å…ˆæ‰“å¼€ç¼–è¾‘ä¸ªäººèµ„æ–™æ¨¡æ€æ¡†');
                alert('è¯·å…ˆç‚¹å‡»"ç¼–è¾‘ä¸ªäººèµ„æ–™"æŒ‰é’®æ‰“å¼€ç¼–è¾‘ç•Œé¢ï¼Œç„¶åå†è¿è¡Œæ­¤æµ‹è¯•');
                return false;
            }
            
            // æ£€æŸ¥è¡¨å•å­—æ®µ
            const editNameEl = document.getElementById('editName');
            const editPhoneEl = document.getElementById('editPhone');
            const editEmailEl = document.getElementById('editEmail');
            
            console.log('ğŸ“‹ è¡¨å•å­—æ®µæ£€æŸ¥:');
            console.log('- å§“åå­—æ®µ:', !!editNameEl, editNameEl?.value);
            console.log('- ç”µè¯å­—æ®µ:', !!editPhoneEl, editPhoneEl?.value);
            console.log('- é‚®ç®±å­—æ®µ:', !!editEmailEl, editEmailEl?.value);
            
            if (!editNameEl || !editPhoneEl || !editEmailEl) {
                console.error('âŒ è¡¨å•å­—æ®µç¼ºå¤±');
                return false;
            }
            
            // æ£€æŸ¥å½“å‰å€¼
            if (!editNameEl.value.trim()) {
                editNameEl.value = 'TESTå®¶é•¿' + Date.now();
                console.log('ğŸ”§ è®¾ç½®æµ‹è¯•å§“å:', editNameEl.value);
            }
            
            if (!editPhoneEl.value.trim()) {
                editPhoneEl.value = '13800138000';
                console.log('ğŸ”§ è®¾ç½®æµ‹è¯•ç”µè¯:', editPhoneEl.value);
            }
            
            if (!editEmailEl.value.trim()) {
                editEmailEl.value = 'test@example.com';
                console.log('ğŸ”§ è®¾ç½®æµ‹è¯•é‚®ç®±:', editEmailEl.value);
            }
            
            console.log('âœ… è¡¨å•æ•°æ®å‡†å¤‡å®Œæˆï¼Œå¯ä»¥ç‚¹å‡»ä¿å­˜æŒ‰é’®æµ‹è¯•');
            console.log('ğŸ’¡ æç¤º: ç‚¹å‡»"ä¿å­˜"æŒ‰é’®åï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºå’Œé¡µé¢å§“åå˜åŒ–');
            
            return true;
        };
        
        console.log('ğŸ’¡ æ–°å¢è°ƒè¯•å‡½æ•°:');
        console.log('- testParentNameUpdateFix() : æµ‹è¯•å®¶é•¿å§“åå¼ºåˆ¶æ›´æ–°');
        console.log('- testParentSaveFlow() : æµ‹è¯•å®¶é•¿ä¿å­˜æµç¨‹');
        
        
        
        // å®æ—¶é‚®ç®±éªŒè¯å‡½æ•°
        function validateEmailRealTime(email, errorElement) {
            console.log('=== å®æ—¶é‚®ç®±éªŒè¯å¼€å§‹ ===');
            console.log('è¾“å…¥çš„é‚®ç®±:', email);
            console.log('é”™è¯¯å…ƒç´ :', !!errorElement);
            
            if (!email || email === '') {
                console.log('é‚®ç®±ä¸ºç©ºï¼Œéšè—é”™è¯¯ä¿¡æ¯');
                errorElement.style.display = 'none';
                document.getElementById('editEmail').style.borderColor = '';
                return;
            }
            
            // ä½¿ç”¨ä¸validateParentFormç›¸åŒçš„éªŒè¯é€»è¾‘
            let errorMessage = '';
            
            // ç¬¬ä¸€å±‚ï¼šåŸºæœ¬æ ¼å¼æ£€æŸ¥
            if (!email.includes('@') || email.split('@').length !== 2) {
                errorMessage = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å«ä¸€ä¸ª@ç¬¦å·';
            }
            // ç¬¬äºŒå±‚ï¼šé•¿åº¦æ£€æŸ¥
            else if (email.length < 5 || email.length > 254) {
                errorMessage = 'é‚®ç®±é•¿åº¦å¿…é¡»åœ¨5-254ä¸ªå­—ç¬¦ä¹‹é—´';
            }
            // ç¬¬ä¸‰å±‚ï¼šè¯¦ç»†æ ¼å¼éªŒè¯
            else {
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                if (!emailRegex.test(email)) {
                    errorMessage = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼ˆå¦‚ï¼šuser@example.comï¼‰';
                }
                else {
                    // ç¬¬å››å±‚ï¼šåŸŸåéƒ¨åˆ†æ£€æŸ¥
                    const emailParts = email.split('@');
                    const [localPart, domainPart] = emailParts;
                    
                    if (localPart.length > 64) {
                        errorMessage = 'é‚®ç®±ç”¨æˆ·åéƒ¨åˆ†è¿‡é•¿ï¼ˆä¸èƒ½è¶…è¿‡64ä¸ªå­—ç¬¦ï¼‰';
                    }
                    else if (domainPart.length > 253) {
                        errorMessage = 'é‚®ç®±åŸŸåéƒ¨åˆ†è¿‡é•¿ï¼ˆä¸èƒ½è¶…è¿‡253ä¸ªå­—ç¬¦ï¼‰';
                    }
                    else if (!domainPart.includes('.')) {
                        errorMessage = 'é‚®ç®±åŸŸåå¿…é¡»åŒ…å«é¡¶çº§åŸŸåï¼ˆå¦‚.comã€.cnç­‰ï¼‰';
                    }
                    // ç¬¬äº”å±‚ï¼šå¸¸è§é”™è¯¯æ£€æŸ¥
                    else if (email.startsWith('.') || email.endsWith('.')) {
                        errorMessage = 'é‚®ç®±ä¸èƒ½ä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ';
                    }
                    else if (email.includes('..')) {
                        errorMessage = 'é‚®ç®±ä¸èƒ½åŒ…å«è¿ç»­çš„ç‚¹å·';
                    }
                    else if (localPart.startsWith('.') || localPart.endsWith('.')) {
                        errorMessage = 'é‚®ç®±ç”¨æˆ·åä¸èƒ½ä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ';
                    }
                }
            }
            
            if (errorMessage) {
                console.log('âŒ å®æ—¶é‚®ç®±éªŒè¯å¤±è´¥:', errorMessage);
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
                errorElement.style.color = '#ff3b30';
                // ç»™è¾“å…¥æ¡†æ·»åŠ é”™è¯¯æ ·å¼
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '#ff3b30';
                    emailInput.style.backgroundColor = '#fff5f5';
                }
                console.log('âœ… é”™è¯¯æ ·å¼å·²åº”ç”¨');
            } else {
                console.log('âœ… å®æ—¶é‚®ç®±éªŒè¯é€šè¿‡');
                errorElement.style.display = 'none';
                // ç§»é™¤é”™è¯¯æ ·å¼
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '';
                    emailInput.style.backgroundColor = '';
                }
                console.log('âœ… é”™è¯¯æ ·å¼å·²æ¸…é™¤');
            }
            console.log('=== å®æ—¶é‚®ç®±éªŒè¯ç»“æŸ ===');
        }
        
        // éªŒè¯å®¶é•¿ç”¨æˆ·è¡¨å•
        function validateParentForm() {
            console.log('=== å¼€å§‹éªŒè¯å®¶é•¿ç”¨æˆ·è¡¨å• ===');
            console.log('å½“å‰è¡¨å•çŠ¶æ€æ£€æŸ¥...');
            
            const nameEl = document.getElementById('editName');
            const phoneEl = document.getElementById('editPhone');
            const emailEl = document.getElementById('editEmail');
            
            console.log('å®¶é•¿è¡¨å•å…ƒç´ æ£€æŸ¥:', {
                nameEl: !!nameEl,
                phoneEl: !!phoneEl,
                emailEl: !!emailEl
            });
            
            if (!nameEl || !phoneEl || !emailEl) {
                console.log('âŒ è¡¨å•å…ƒç´ ç¼ºå¤±');
                return { valid: false, message: 'è¡¨å•åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•' };
            }
            
            const name = nameEl.value.trim();
            const phone = phoneEl.value.trim();
            const email = emailEl.value.trim();
            
            console.log('å®¶é•¿è¡¨å•æ•°æ®:', { name, phone, email });
            
            if (!name) {
                console.log('âŒ å§“åéªŒè¯å¤±è´¥ï¼šä¸ºç©º');
                return { valid: false, message: 'è¯·è¾“å…¥å§“å' };
            }
            
            if (!phone) {
                console.log('âŒ æ‰‹æœºå·éªŒè¯å¤±è´¥ï¼šä¸ºç©º');
                return { valid: false, message: 'è¯·è¾“å…¥æ‰‹æœºå·' };
            }
            
            // æ‰‹æœºå·éªŒè¯ï¼šæœ€å¤š11ä½æ•°å­—
            if (phone.length > 11) {
                console.log('âŒ æ‰‹æœºå·éªŒè¯å¤±è´¥ï¼šé•¿åº¦è¶…è¿‡11ä½');
                return { valid: false, message: 'æ‰‹æœºå·æœ€å¤š11ä½æ•°å­—' };
            }
            
            const phoneRegex = /^\d{1,11}$/;
            if (!phoneRegex.test(phone)) {
                console.log('âŒ æ‰‹æœºå·éªŒè¯å¤±è´¥ï¼šæ ¼å¼é”™è¯¯');
                return { valid: false, message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼ï¼ˆæœ€å¤š11ä½æ•°å­—ï¼‰' };
            }
            
            if (!email) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šä¸ºç©º');
                // é«˜äº®é‚®ç®±è¾“å…¥æ¡†
                const emailInputEl = document.getElementById('editEmail');
                if (emailInputEl) {
                    emailInputEl.style.borderColor = '#ff3b30';
                    emailInputEl.focus();
                }
                return { valid: false, message: 'è¯·è¾“å…¥é‚®ç®±' };
            }
            
            // å¢å¼ºçš„é‚®ç®±éªŒè¯ - å¤šå±‚éªŒè¯ç¡®ä¿æ ¼å¼æ­£ç¡®
            console.log('å¼€å§‹é‚®ç®±éªŒè¯ï¼Œé‚®ç®±åœ°å€:', email);
            
            // ç¬¬ä¸€å±‚ï¼šåŸºæœ¬æ ¼å¼æ£€æŸ¥
            if (!email.includes('@') || email.split('@').length !== 2) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šåŸºæœ¬æ ¼å¼é”™è¯¯');
                return { valid: false, message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å«ä¸€ä¸ª@ç¬¦å·' };
            }
            
            // ç¬¬äºŒå±‚ï¼šé•¿åº¦æ£€æŸ¥
            if (email.length < 5 || email.length > 254) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šé•¿åº¦ä¸ç¬¦åˆè¦æ±‚');
                return { valid: false, message: 'é‚®ç®±é•¿åº¦å¿…é¡»åœ¨5-254ä¸ªå­—ç¬¦ä¹‹é—´' };
            }
            
            // ç¬¬ä¸‰å±‚ï¼šè¯¦ç»†æ ¼å¼éªŒè¯
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            if (!emailRegex.test(email)) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šæ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…');
                // é«˜äº®é‚®ç®±è¾“å…¥æ¡†å’Œæ˜¾ç¤ºé”™è¯¯
                const emailInputEl = document.getElementById('editEmail');
                const emailErrorEl = document.getElementById('emailError');
                if (emailInputEl) {
                    emailInputEl.style.borderColor = '#ff3b30';
                    emailInputEl.focus();
                }
                if (emailErrorEl) {
                    emailErrorEl.textContent = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼ˆå¦‚ï¼šuser@example.comï¼‰';
                    emailErrorEl.style.display = 'block';
                }
                return { valid: false, message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼ˆå¦‚ï¼šuser@example.comï¼‰' };
            }
            
            // ç¬¬å››å±‚ï¼šåŸŸåéƒ¨åˆ†æ£€æŸ¥
            const emailParts = email.split('@');
            const [localPart, domainPart] = emailParts;
            
            // æ£€æŸ¥æœ¬åœ°éƒ¨åˆ†é•¿åº¦
            if (localPart.length > 64) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šç”¨æˆ·åéƒ¨åˆ†è¿‡é•¿');
                return { valid: false, message: 'é‚®ç®±ç”¨æˆ·åéƒ¨åˆ†è¿‡é•¿ï¼ˆä¸èƒ½è¶…è¿‡64ä¸ªå­—ç¬¦ï¼‰' };
            }
            
            // æ£€æŸ¥åŸŸåéƒ¨åˆ†
            if (domainPart.length > 253) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šåŸŸåéƒ¨åˆ†è¿‡é•¿');
                return { valid: false, message: 'é‚®ç®±åŸŸåéƒ¨åˆ†è¿‡é•¿ï¼ˆä¸èƒ½è¶…è¿‡253ä¸ªå­—ç¬¦ï¼‰' };
            }
            
            // æ£€æŸ¥åŸŸåæ˜¯å¦åŒ…å«ç‚¹å·
            if (!domainPart.includes('.')) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šåŸŸåç¼ºå°‘é¡¶çº§åŸŸå');
                return { valid: false, message: 'é‚®ç®±åŸŸåå¿…é¡»åŒ…å«é¡¶çº§åŸŸåï¼ˆå¦‚.comã€.cnç­‰ï¼‰' };
            }
            
            // ç¬¬äº”å±‚ï¼šå¸¸è§é”™è¯¯æ£€æŸ¥
            if (email.startsWith('.') || email.endsWith('.')) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ');
                return { valid: false, message: 'é‚®ç®±ä¸èƒ½ä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ' };
            }
            
            if (email.includes('..')) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šåŒ…å«è¿ç»­ç‚¹å·');
                return { valid: false, message: 'é‚®ç®±ä¸èƒ½åŒ…å«è¿ç»­çš„ç‚¹å·' };
            }
            
            if (localPart.startsWith('.') || localPart.endsWith('.')) {
                console.log('âŒ é‚®ç®±éªŒè¯å¤±è´¥ï¼šç”¨æˆ·åä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ');
                return { valid: false, message: 'é‚®ç®±ç”¨æˆ·åä¸èƒ½ä»¥ç‚¹å·å¼€å§‹æˆ–ç»“æŸ' };
            }
            
            console.log('âœ… é‚®ç®±éªŒè¯é€šè¿‡');
            console.log('âœ… å®¶é•¿è¡¨å•éªŒè¯å…¨éƒ¨é€šè¿‡');
            
            // æ¸…é™¤æ‰€æœ‰é”™è¯¯æ ·å¼
            const emailInputEl = document.getElementById('editEmail');
            const emailErrorEl = document.getElementById('emailError');
            if (emailInputEl) {
                emailInputEl.style.borderColor = '';
            }
            if (emailErrorEl) {
                emailErrorEl.style.display = 'none';
            }
            
            return {
                valid: true,
                data: { name, phone, email }
            };
        }
        
        // éªŒè¯å­¦ç”Ÿç”¨æˆ·è¡¨å•
        function validateStudentForm() {
            const nicknameEl = document.getElementById('editNickname');
            const gradeEl = document.getElementById('editGrade');
            const classEl = document.getElementById('editClass');
            const schoolEl = document.getElementById('editSchool');
            
            console.log('å­¦ç”Ÿè¡¨å•å…ƒç´ æ£€æŸ¥:', {
                nicknameEl: !!nicknameEl,
                gradeEl: !!gradeEl,
                classEl: !!classEl,
                schoolEl: !!schoolEl
            });
            
            if (!nicknameEl || !gradeEl || !classEl) {
                return { valid: false, message: 'è¡¨å•åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•' };
            }
            
            const nickname = nicknameEl.value.trim();
            const grade = gradeEl.value.trim();
            const classValue = classEl.value.trim();
            const school = schoolEl ? schoolEl.value.trim() : '';
            
            console.log('å­¦ç”Ÿè¡¨å•æ•°æ®:', { nickname, grade, class: classValue, school });
            
            if (!nickname) {
                return { valid: false, message: 'è¯·è¾“å…¥æ˜µç§°' };
            }
            
            if (!grade) {
                return { valid: false, message: 'è¯·é€‰æ‹©å¹´çº§' };
            }
            
            if (!classValue) {
                return { valid: false, message: 'è¯·é€‰æ‹©ç­çº§' };
            }
            
            return {
                valid: true,
                data: { nickname, grade, classValue, school }
            };
        }
        
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
        function updateLocalUserInfo(role, result, formData) {
            if (!userInfo) {
                console.error('userInfoä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°');
                return;
            }
            
            console.log('=== updateLocalUserInfo å¼€å§‹ ===');
            console.log('æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯:', { role, result, formData });
            console.log('æ›´æ–°å‰çš„userInfo:', JSON.parse(JSON.stringify(userInfo))); // æ·±æ‹·è´ç”¨äºæ‰“å°
            
            // ç¡®ä¿è§’è‰²ä¿¡æ¯ä¿æŒæ­£ç¡®
            userInfo.role = role;
            
            if (result && result.user) {
                // å¦‚æœAPIè¿”å›äº†ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨APIæ•°æ®æ›´æ–°
                console.log('ä½¿ç”¨APIè¿”å›çš„ç”¨æˆ·æ•°æ®æ›´æ–°:', result.user);
                Object.assign(userInfo, result.user);
                
                // ç¡®ä¿ç‰¹å®šå­—æ®µæ­£ç¡®æ˜ å°„
                if (role === 'parent') {
                    if (result.user.name) {
                        userInfo.name = result.user.name;
                        userInfo.nickname = result.user.name; // åŒæ—¶æ›´æ–°nicknameå­—æ®µï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
                        console.log('âœ… ä»APIæ›´æ–°å®¶é•¿å§“å:', result.user.name);
                        
                        // ç«‹å³åæ˜ åˆ°é¡µé¢æ˜¾ç¤º
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = result.user.name;
                            console.log('âœ… ç«‹å³æ›´æ–°é¡µé¢å§“åæ˜¾ç¤ºä¸º:', result.user.name);
                        }
                    }
                    if (result.user.phone) userInfo.phone = result.user.phone;
                    if (result.user.email) userInfo.email = result.user.email;
                } else {
                    if (result.user.nickname) userInfo.nickname = result.user.nickname;
                    if (result.user.grade) userInfo.grade = result.user.grade;
                    if (result.user.class_name !== undefined) userInfo.class_name = result.user.class_name;
                    if (result.user.school !== undefined) userInfo.school = result.user.school;
                }
                if (result.user.avatar_url) userInfo.avatar_url = result.user.avatar_url;
            } else {
                // å¦‚æœAPIæ²¡æœ‰è¿”å›ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨è¡¨å•æ•°æ®æ›´æ–°
                console.log('ä½¿ç”¨è¡¨å•æ•°æ®æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯:', formData);
                if (role === 'parent') {
                    if (formData.name) {
                        userInfo.name = formData.name;
                        userInfo.nickname = formData.name; // ç¡®ä¿nicknameä¹Ÿæ›´æ–°
                        console.log('âœ… ä»è¡¨å•æ›´æ–°å®¶é•¿å§“å:', formData.name);
                        
                        // ç«‹å³åæ˜ åˆ°é¡µé¢æ˜¾ç¤º
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = formData.name;
                            console.log('âœ… ç«‹å³æ›´æ–°é¡µé¢å§“åæ˜¾ç¤ºä¸º:', formData.name);
                        }
                    }
                    if (formData.phone) userInfo.phone = formData.phone;
                    if (formData.email) userInfo.email = formData.email;
                } else {
                    if (formData.nickname !== undefined) userInfo.nickname = formData.nickname;
                    if (formData.grade !== undefined) userInfo.grade = formData.grade;
                    if (formData.classValue !== undefined) userInfo.class_name = formData.classValue;
                    if (formData.school !== undefined) userInfo.school = formData.school;
                }
                if (formData.avatarUrl) userInfo.avatar_url = formData.avatarUrl;
            }
            
            console.log('æ›´æ–°åçš„userInfo:', JSON.parse(JSON.stringify(userInfo))); // æ·±æ‹·è´ç”¨äºæ‰“å°
            
            // å¼ºåˆ¶æ›´æ–°localStorageå’Œè§¦å‘äº‹ä»¶ - å¢å¼ºç‰ˆ
            localStorage.setItem('user', JSON.stringify(userInfo));
            console.log('âœ… localStorageå·²æ›´æ–°');
            
            // ç«‹å³éªŒè¯localStorageä¸­çš„æ•°æ®æ˜¯å¦æ­£ç¡®
            const verifyData = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('âœ… localStorageéªŒè¯æ•°æ®:', {
                name: verifyData.name,
                nickname: verifyData.nickname,
                avatar_url: verifyData.avatar_url
            });
            
            // å¦‚æœæ˜¯å®¶é•¿ç”¨æˆ·ï¼Œç¡®ä¿å…³é”®å­—æ®µæ›´æ–°æ­£ç¡®
            if (role === 'parent') {
                console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿ç”¨æˆ·æ•°æ®éªŒè¯:', {
                    original_name: userInfo.name,
                    stored_name: verifyData.name,
                    original_avatar: userInfo.avatar_url,
                    stored_avatar: verifyData.avatar_url
                });
                
                // å¦‚æœlocalStorageæ•°æ®ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶é‡æ–°è®¾ç½®
                if (verifyData.name !== userInfo.name || verifyData.avatar_url !== userInfo.avatar_url) {
                    console.log('âš ï¸ localStorageæ•°æ®ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶é‡æ–°è®¾ç½®');
                    localStorage.setItem('user', JSON.stringify(userInfo));
                }
            }
            
            console.log('=== updateLocalUserInfo ç»“æŸ ===');
            window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
            
            console.log('âœ… æœ¬åœ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°å®Œæˆ:', {
                name: userInfo.name,
                nickname: userInfo.nickname,
                phone: userInfo.phone,
                email: userInfo.email,
                avatar_url: userInfo.avatar_url?.substring?.(0, 50) + '...' || userInfo.avatar_url
            });
        }
        
        // åˆ·æ–°é¡µé¢ä¸­çš„å¤´åƒæ˜¾ç¤º
        function updateAvatarDisplayInProfile(user) {
            console.log('=== åˆ·æ–°é¡µé¢ä¸­çš„å¤´åƒæ˜¾ç¤º ===', user);
            if (!user) {
                console.log('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
                return;
            }
            
            // æŸ¥æ‰¾é¡µé¢ä¸­æ‰€æœ‰éœ€è¦æ›´æ–°çš„å¤´åƒå…ƒç´ 
            const avatarElements = [
                // ä¸»è¦å¤´åƒæ˜¾ç¤ºï¼ˆç”¨æˆ·ä¿¡æ¯å¡ç‰‡ä¸­çš„å¤´åƒï¼‰
                document.querySelector('.user-info .avatar'),
                document.querySelector('#userAvatar'),
                // é¡¶éƒ¨å¯¼èˆªæ çš„å¤´åƒ
                document.querySelector('.user-avatar'),
                // å…¶ä»–å¯èƒ½çš„å¤´åƒæ˜¾ç¤ºä½ç½®
                document.querySelector('.profile-avatar'),
                document.querySelector('[data-avatar-display]'),
                // æ‰€æœ‰å…·æœ‰avatar classçš„å…ƒç´ 
                ...document.querySelectorAll('.avatar')
            ];
            
            // å»é‡
            const uniqueAvatarElements = [...new Set(avatarElements)].filter(el => el !== null);
            
            console.log('æ‰¾åˆ°çš„å¤´åƒå…ƒç´ æ•°é‡:', uniqueAvatarElements.length);
            console.log('ç”¨æˆ·å¤´åƒURL:', user.avatar_url);
            
            uniqueAvatarElements.forEach((avatarElement, index) => {
                if (avatarElement) {
                    console.log(`æ›´æ–°å¤´åƒå…ƒç´  ${index + 1}:`, avatarElement.className, avatarElement.id);
                    updateSingleAvatarDisplay(avatarElement, user);
                }
            });
            
            // é¢å¤–è°ƒç”¨setUserAvatarå‡½æ•°ç¡®ä¿å¤´åƒæ­£ç¡®æ˜¾ç¤º
            const mainAvatar = document.getElementById('userAvatar');
            if (mainAvatar && user && user.avatar_url) {
                console.log('ä½¿ç”¨setUserAvatarå‡½æ•°æ›´æ–°ä¸»å¤´åƒ');
                setUserAvatar(mainAvatar, user.avatar_url);
            }
            
            console.log('âœ… å¤´åƒæ˜¾ç¤ºåˆ·æ–°å®Œæˆ');
        }
        
        // æ›´æ–°å•ä¸ªå¤´åƒå…ƒç´ çš„æ˜¾ç¤º
        function updateSingleAvatarDisplay(avatarElement, user) {
            if (!avatarElement || !user || !user.avatar_url) {
                return;
            }
            
            const avatarUrl = user.avatar_url;
            
            if (avatarUrl.startsWith('emoji:')) {
                // è¡¨æƒ…å¤´åƒ
                const emoji = avatarUrl.replace('emoji:', '');
                avatarElement.innerHTML = emoji;
                avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else if (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/')) {
                // å›¾ç‰‡å¤´åƒ (æ”¯æŒç»å¯¹URLå’Œç›¸å¯¹è·¯å¾„)
                let imageUrl = avatarUrl;
                if (avatarUrl.startsWith('/')) {
                    // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦åŠ ä¸ŠAPIæœåŠ¡å™¨åœ°å€
                    imageUrl = `http://localhost:8000${avatarUrl}`;
                }
                
                // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°å›¾ç‰‡ç¼“å­˜
                const separator = imageUrl.includes('?') ? '&' : '?';
                const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                
                console.log('è®¾ç½®å›¾ç‰‡å¤´åƒ:', timestampUrl);
                
                avatarElement.innerHTML = `<img src="${timestampUrl}" 
                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                    alt="ç”¨æˆ·å¤´åƒ" 
                    onerror="this.parentElement.innerHTML='ğŸ‘¤'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';"/>`;
            } else if (avatarUrl.startsWith('data:')) {
                // Base64å›¾ç‰‡æ•°æ®
                console.log('è®¾ç½®Base64å¤´åƒ');
                avatarElement.innerHTML = `<img src="${avatarUrl}" 
                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                    alt="ç”¨æˆ·å¤´åƒ" 
                    onerror="this.parentElement.innerHTML='ğŸ‘¤'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';"/>`;
            } else {
                // é»˜è®¤å¤´åƒæˆ–æœªè¯†åˆ«çš„æ ¼å¼
                avatarElement.innerHTML = 'ğŸ‘¤';
                avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // åˆå§‹åŒ–å¹´çº§-ç­çº§è”åŠ¨åŠŸèƒ½
        function initEditProfileGradeClassBinding() {
            const gradeSelect = document.getElementById('editGrade');
            const classSelect = document.getElementById('editClass');
            
            if (gradeSelect && classSelect) {
                gradeSelect.addEventListener('change', function() {
                    updateClassOptions(this.value, classSelect);
                });
            }
        }
        
        // æ ¹æ®å¹´çº§æ›´æ–°ç­çº§é€‰é¡¹
        function updateClassOptions(grade, classSelect) {
            classSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç­çº§</option>';
            
            if (grade) {
                // æ ¹æ®å¹´çº§ç”Ÿæˆç­çº§é€‰é¡¹ï¼ˆä¸€èˆ¬æ¯ä¸ªå¹´çº§æœ‰1-20ä¸ªç­ï¼‰
                for (let i = 1; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i + 'ç­';
                    option.textContent = i + 'ç­';
                    classSelect.appendChild(option);
                }
            } else {
                classSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å¹´çº§</option>';
            }
        }
        
        // ç¼–è¾‘å­¦ç”Ÿå¤´åƒ
        
        // å¤„ç†ç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•æäº¤ - å¢å¼ºç‰ˆ
        function handleEditProfileSubmit(e) {
            e.preventDefault();
            console.log('=== ç¼–è¾‘ä¸ªäººèµ„æ–™è¡¨å•æäº¤äº‹ä»¶è¢«è§¦å‘ï¼ˆå¢å¼ºç‰ˆï¼‰ ===');
            
            // åœ¨æäº¤å‰å†æ¬¡æ£€æŸ¥å®¶é•¿ç”¨æˆ·é‚®ç®±
            const role = AuthUtils.getCurrentUserRole();
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', role);
            
            if (role === 'parent') {
                console.log('ğŸ” å®¶é•¿ç”¨æˆ·æäº¤éªŒè¯ï¼šå¼€å§‹å…¨é¢é‚®ç®±éªŒè¯');
                
                // ä½¿ç”¨å®Œæ•´çš„å®¶é•¿è¡¨å•éªŒè¯
                const validationResult = validateParentForm();
                console.log('å®¶é•¿è¡¨å•éªŒè¯ç»“æœ:', validationResult);
                
                if (!validationResult.valid) {
                    console.log('âŒ å®¶é•¿è¡¨å•éªŒè¯å¤±è´¥ï¼Œé˜»æ­¢æäº¤');
                    showToast(validationResult.message);
                    
                    // å¦‚æœæ˜¯é‚®ç®±ç›¸å…³é”™è¯¯ï¼Œèšç„¦åˆ°é‚®ç®±è¾“å…¥æ¡†
                    if (validationResult.message.includes('é‚®ç®±')) {
                        const emailInput = document.getElementById('editEmail');
                        if (emailInput) {
                            emailInput.focus();
                            emailInput.style.borderColor = '#ff3b30';
                            emailInput.style.backgroundColor = '#fff5f5'; // æ·¡çº¢èƒŒæ™¯è¡¨ç¤ºé”™è¯¯
                            
                            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            const emailError = document.getElementById('emailError');
                            if (emailError) {
                                emailError.textContent = validationResult.message;
                                emailError.style.display = 'block';
                                emailError.style.color = '#ff3b30';
                            }
                        }
                    }
                    return; // é˜»æ­¢æäº¤
                }
                
                console.log('âœ… å®¶é•¿ç”¨æˆ·è¡¨å•å®Œæ•´éªŒè¯é€šè¿‡');
                
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯æ ·å¼
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '';
                    emailInput.style.backgroundColor = '';
                }
                
                const emailError = document.getElementById('emailError');
                if (emailError) {
                    emailError.style.display = 'none';
                }
            } else {
                console.log('ğŸ“š å­¦ç”Ÿç”¨æˆ·æäº¤ï¼Œè·³è¿‡é‚®ç®±éªŒè¯');
            }
            
            console.log('ğŸš€ è¡¨å•éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ä¿å­˜');
            saveProfile();
        }
        
        // é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä½¿ç”¨ä¸Šé¢çš„æ›´å…¨é¢ç‰ˆæœ¬

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToHomeworkHistory() {
            window.location.href = '/frontend/homework-list.html';
        }

        function goToVipCenter() {
            window.location.href = '/frontend/vip-center.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function toggleNotification() {
            // å®ç°å¼€å…³åˆ‡æ¢æ•ˆæœ
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) {
                console.warn('æœªæ‰¾åˆ°é€šçŸ¥å¼€å…³å…ƒç´ ');
                return;
            }
            
            // åˆ‡æ¢å¼€å…³çŠ¶æ€
            const isCurrentlyActive = toggle.classList.contains('active');
            
            if (isCurrentlyActive) {
                // å…³é—­é€šçŸ¥
                toggle.classList.remove('active');
                localStorage.setItem('notificationEnabled', 'false');
                showToast('ğŸ”• æ¶ˆæ¯é€šçŸ¥å·²å…³é—­', 2000);
                console.log('é€šçŸ¥å·²å…³é—­');
            } else {
                // å¼€å¯é€šçŸ¥
                toggle.classList.add('active');
                localStorage.setItem('notificationEnabled', 'true');
                showToast('ğŸ”” æ¶ˆæ¯é€šçŸ¥å·²å¼€å¯', 2000);
                console.log('é€šçŸ¥å·²å¼€å¯');
            }
            
            // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
            toggle.style.transform = 'scale(0.95)';
            setTimeout(() => {
                toggle.style.transform = 'scale(1)';
            }, 150);
        }
        
        // åˆå§‹åŒ–é€šçŸ¥å¼€å…³çŠ¶æ€
        function initializeNotificationToggle() {
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) {
                console.warn('æœªæ‰¾åˆ°é€šçŸ¥å¼€å…³å…ƒç´ ï¼Œç¨åé‡è¯•');
                // å»¶è¿Ÿé‡è¯•
                setTimeout(() => {
                    initializeNotificationToggle();
                }, 500);
                return;
            }
            
            // ä»localStorageè¯»å–ä¿å­˜çš„è®¾ç½®ï¼Œé»˜è®¤ä¸ºå¼€å¯çŠ¶æ€
            const savedSetting = localStorage.getItem('notificationEnabled');
            const isEnabled = savedSetting === null ? true : savedSetting === 'true';
            
            console.log('åˆå§‹åŒ–é€šçŸ¥å¼€å…³çŠ¶æ€:', isEnabled ? 'å¼€å¯' : 'å…³é—­');
            
            if (isEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }
        
        function pushNotificationMessages() {
            console.log('ğŸ“¢ å¼€å§‹æ¨é€é€šçŸ¥æ¶ˆæ¯...');
            
            // è·å–å½“å‰ç”¨æˆ·è§’è‰²
            const currentRole = AuthUtils.getCurrentUserRole() || localStorage.getItem('role') || 'student';
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ¨é€ä¸åŒçš„é€šçŸ¥å†…å®¹
            const notifications = getNotificationsByRole(currentRole);
            
            // ä¾æ¬¡æ¨é€é€šçŸ¥ï¼Œæ¯ä¸ªé€šçŸ¥é—´éš”1.5ç§’
            notifications.forEach((notification, index) => {
                setTimeout(() => {
                    showNotificationToast(notification);
                }, index * 1500);
            });
            
            // æ˜¾ç¤ºæ¨é€å®Œæˆæç¤º
            setTimeout(() => {
                showToast('âœ… æ‰€æœ‰é€šçŸ¥å·²æ¨é€å®Œæˆ', 2000);
            }, notifications.length * 1500);
        }
        
        function getNotificationsByRole(role) {
            const baseNotifications = [
                { title: 'ç³»ç»Ÿæ¶ˆæ¯', content: 'ğŸ”” ZYJCæ™ºèƒ½æ‰¹æ”¹ç³»ç»Ÿä¸ºæ‚¨æœåŠ¡' },
                { title: 'å­¦ä¹ æé†’', content: 'ğŸ“š ä»Šå¤©è¿˜æ²¡æœ‰å®Œæˆå­¦ä¹ ä»»åŠ¡ï¼Œå¿«æ¥å­¦ä¹ å§ï¼' },
                { title: 'åŠŸèƒ½æ›´æ–°', content: 'ğŸ†• ç³»ç»Ÿæ–°å¢äº†é”™é¢˜åˆ†æåŠŸèƒ½ï¼Œå¿«æ¥ä½“éªŒå§ï¼' }
            ];
            
            if (role === 'student') {
                return [
                    ...baseNotifications,
                    { title: 'ä½œä¸šæé†’', content: 'ğŸ“ æ‚¨æœ‰æ–°çš„ä½œä¸šéœ€è¦å®Œæˆï¼Œè¯·åŠæ—¶å¤„ç†' },
                    { title: 'é”™é¢˜å¤ä¹ ', content: 'ğŸ” å‘ç°3é“é”™é¢˜éœ€è¦å¤ä¹ ï¼Œå»ºè®®ä»Šå¤©å®Œæˆ' },
                    { title: 'å­¦ä¹ è®¡åˆ’', content: 'ğŸ“… ä»Šæ—¥å­¦ä¹ è®¡åˆ’ï¼šå®Œæˆæ•°å­¦ç»ƒä¹ 30åˆ†é’Ÿ' },
                    { title: 'æˆç»©æé†’', content: 'ğŸ† æ­å–œï¼æ‚¨çš„æ•°å­¦æˆç»©æœ‰äº†æ˜æ˜¾æå‡ï¼' }
                ];
            } else if (role === 'parent') {
                return [
                    ...baseNotifications,
                    { title: 'å­©å­å­¦ä¹ ', content: 'ğŸ‘¶ æ‚¨çš„å­©å­ä»Šå¤©å®Œæˆäº†2é¡¹ä½œä¸šï¼Œè¡¨ç°å¾ˆæ£’ï¼' },
                    { title: 'å­¦ä¹ æŠ¥å‘Š', content: 'ğŸ“Š æœ¬å‘¨å­¦ä¹ æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå­©å­è¿›æ­¥æ˜æ˜¾' },
                    { title: 'é”™é¢˜ç»Ÿè®¡', content: 'ğŸ“ˆ å­©å­æœ¬å‘¨é”™é¢˜ç‡ä¸‹é™äº†15%ï¼Œç»§ç»­ä¿æŒï¼' },
                    { title: 'å®¶é•¿å»ºè®®', content: 'ğŸ’¡ å»ºè®®åŠ å¼ºå­©å­çš„è®¡ç®—ç»ƒä¹ ï¼Œæé«˜å‡†ç¡®ç‡' }
                ];
            } else {
                return baseNotifications;
            }
        }
        
        function showNotificationToast(notification) {
            console.log('æ¨é€é€šçŸ¥:', notification.title, '-', notification.content);
            
            // åˆ›å»ºé€šçŸ¥æ ·å¼çš„Toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                font-size: 14px;
                z-index: 10002;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
                max-width: 300px;
                min-width: 250px;
                animation: slideInFromRight 0.4s ease-out;
                backdrop-filter: blur(10px);
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="font-size: 20px; margin-top: 2px;">ğŸ””</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${notification.title}</div>
                        <div style="font-size: 13px; line-height: 1.4; opacity: 0.95;">${notification.content}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!document.getElementById('notification-animation-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-animation-styles';
                style.textContent = `
                    @keyframes slideInFromRight {
                        0% { 
                            opacity: 0; 
                            transform: translateX(100%); 
                        }
                        100% { 
                            opacity: 1; 
                            transform: translateX(0); 
                        }
                    }
                    @keyframes slideOutToRight {
                        0% { 
                            opacity: 1; 
                            transform: translateX(0); 
                        }
                        100% { 
                            opacity: 0; 
                            transform: translateX(100%); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.animation = 'slideOutToRight 0.4s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            }, 5000);
        }

        function showNotificationSettingsModal() {
            const modalHtml = `
                <div class="modal" id="notificationModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">æ¶ˆæ¯é€šçŸ¥è®¾ç½®</div>
                        <div style="padding: 20px 0;">
                            <!-- é€šçŸ¥å¼€å…³ -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 4px;">æ¨é€é€šçŸ¥</div>
                                    <div style="font-size: 12px; color: #666;">æ¥æ”¶å­¦ä¹ æé†’å’Œç³»ç»Ÿæ¶ˆæ¯</div>
                                </div>
                                <div class="setting-toggle active" id="pushNotificationToggle" onclick="togglePushNotification()">
                                    <div class="toggle-handle"></div>
                                </div>
                            </div>
                            
                            <!-- æ¶ˆæ¯ç±»å‹è®¾ç½® -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">æ¶ˆæ¯ç±»å‹</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="homeworkNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">ä½œä¸šæ‰¹æ”¹å®Œæˆé€šçŸ¥</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="errorReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">é”™é¢˜å¤ä¹ æé†’</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="studyReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">å­¦ä¹ è®¡åˆ’æé†’</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="systemNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">ç³»ç»Ÿå…¬å‘Šé€šçŸ¥</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- å…æ‰“æ‰°æ—¶é—´ -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">å…æ‰“æ‰°æ—¶é—´</div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="time" id="quietStartTime" value="22:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <span style="font-size: 14px; color: #666;">è‡³</span>
                                    <input type="time" id="quietEndTime" value="07:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 6px;">åœ¨æ­¤æ—¶é—´æ®µå†…ä¸ä¼šæ”¶åˆ°æ¨é€é€šçŸ¥</div>
                            </div>
                            
                            <!-- æ¶ˆæ¯å†å² -->
                            <div style="border-top: 1px solid #eee; padding-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333;">æ¶ˆæ¯å†å²</div>
                                    <button onclick="clearAllMessages()" style="background: none; border: none; color: #007AFF; font-size: 12px; cursor: pointer;">æ¸…ç©ºå…¨éƒ¨</button>
                                </div>
                                <div id="messageHistory" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px;">
                                    <div style="text-align: center; color: #666; font-size: 12px;">åŠ è½½æ¶ˆæ¯å†å²ä¸­...</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeNotificationModal()">å–æ¶ˆ</button>
                            <button class="modal-btn btn-primary" onclick="saveNotificationSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('notificationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // åŠ è½½æ¶ˆæ¯å†å²
            loadMessageHistory();
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotificationModal();
                }
            });
        }

        function togglePushNotification() {
            const toggle = document.getElementById('pushNotificationToggle');
            toggle.classList.toggle('active');
        }

        async function loadMessageHistory() {
            try {
                const response = await fetch(`${API_BASE}/user/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const historyContainer = document.getElementById('messageHistory');
                if (!historyContainer) return;
                
                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length === 0) {
                        historyContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
                        return;
                    }
                    
                    const messagesHtml = messages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? 'å·²è¯»' : 'æœªè¯»'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                } else {
                    // æ˜¾ç¤ºæ¨¡æ‹Ÿæ¶ˆæ¯å†å²
                    const mockMessages = [
                        { title: 'æ•°å­¦ä½œä¸šæ‰¹æ”¹å®Œæˆ', created_at: '2025-01-15 14:30', is_read: true },
                        { title: 'é”™é¢˜å¤ä¹ æé†’', created_at: '2025-01-15 09:00', is_read: false },
                        { title: 'å­¦ä¹ è®¡åˆ’æ›´æ–°', created_at: '2025-01-14 20:00', is_read: true },
                        { title: 'ç³»ç»Ÿå‡çº§é€šçŸ¥', created_at: '2025-01-14 16:00', is_read: true }
                    ];
                    
                    const messagesHtml = mockMessages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? 'å·²è¯»' : 'æœªè¯»'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å†å²å¤±è´¥:', error);
                const historyContainer = document.getElementById('messageHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #f44336; font-size: 12px;">åŠ è½½å¤±è´¥</div>';
                }
            }
        }

        function clearAllMessages() {
            showModal(
                'æ¸…ç©ºæ¶ˆæ¯',
                'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/user/messages`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            showToast('æ¶ˆæ¯è®°å½•å·²æ¸…ç©º');
                            loadMessageHistory();
                        } else {
                            showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } catch (error) {
                        console.error('æ¸…ç©ºæ¶ˆæ¯å¤±è´¥:', error);
                        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            );
        }

        async function saveNotificationSettings() {
            const pushEnabled = document.getElementById('pushNotificationToggle').classList.contains('active');
            const homeworkNotify = document.getElementById('homeworkNotify').checked;
            const errorReminder = document.getElementById('errorReminder').checked;
            const studyReminder = document.getElementById('studyReminder').checked;
            const systemNotify = document.getElementById('systemNotify').checked;
            const quietStartTime = document.getElementById('quietStartTime').value;
            const quietEndTime = document.getElementById('quietEndTime').value;
            
            try {
                const response = await fetch(`${API_BASE}/user/notification-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        push_enabled: pushEnabled,
                        homework_notify: homeworkNotify,
                        error_reminder: errorReminder,
                        study_reminder: studyReminder,
                        system_notify: systemNotify,
                        quiet_start_time: quietStartTime,
                        quiet_end_time: quietEndTime
                    })
                });
                
                if (response.ok) {
                    showToast('é€šçŸ¥è®¾ç½®å·²ä¿å­˜');
                    closeNotificationModal();
                    
                    // æ›´æ–°ä¸»ç•Œé¢çš„é€šçŸ¥å¼€å…³çŠ¶æ€
                    const mainToggle = document.getElementById('notificationToggle');
                    if (pushEnabled) {
                        mainToggle.classList.add('active');
                    } else {
                        mainToggle.classList.remove('active');
                    }
                } else {
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.remove();
            }
        }


        function contactSupport() {
            showCustomerServiceModal();
        }

        function showCustomerServiceModal() {
            const modalHtml = `
                <div class="modal" id="customerServiceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">å®¢æœä¸­å¿ƒ</div>
                        <div style="padding: 20px 0;">
                            <!-- è”ç³»æ–¹å¼é€‰æ‹© -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">é€‰æ‹©è”ç³»æ–¹å¼</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- å¾®ä¿¡å®¢æœ -->
                                    <div onclick="openWeChatService()" style="display: flex; align-items: center; padding: 16px; background: #07c160; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ’¬</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">å¾®ä¿¡å®¢æœ</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">åœ¨çº¿å’¨è¯¢ï¼Œå¿«é€Ÿå“åº”</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                    
                                    <!-- å®¢æœç”µè¯ -->
                                    <div onclick="callCustomerService()" style="display: flex; align-items: center; padding: 16px; background: #007AFF; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ“</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">å®¢æœç”µè¯</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">400-8888-9999 (å·¥ä½œæ—¥ 9:00-18:00)</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                    
                                    <!-- åœ¨çº¿å·¥å• -->
                                    <div onclick="createTicket()" style="display: flex; align-items: center; padding: 16px; background: #ff9500; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">ğŸ“</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">æäº¤å·¥å•</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">è¯¦ç»†æè¿°é—®é¢˜ï¼Œä¸“äººå¤„ç†</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">â€º</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¸¸è§é—®é¢˜ -->
                            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">å¸¸è§é—®é¢˜</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div onclick="showFAQ('ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜
                                    </div>
                                    <div onclick="showFAQ('è´¦å·å’Œç™»å½•é—®é¢˜')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ è´¦å·å’Œç™»å½•é—®é¢˜
                                    </div>
                                    <div onclick="showFAQ('VIPä¼šå‘˜æœåŠ¡')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ VIPä¼šå‘˜æœåŠ¡
                                    </div>
                                    <div onclick="showFAQ('å®¶é•¿ç»‘å®šä½¿ç”¨')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        â€¢ å®¶é•¿ç»‘å®šä½¿ç”¨
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-secondary" onclick="closeCustomerServiceModal()" style="width: 100%;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('customerServiceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('customerServiceModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCustomerServiceModal();
                }
            });
        }

        function openWeChatService() {
            const wechatModalHtml = `
                <div class="modal" id="wechatModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px; text-align: center;">
                        <div class="modal-title" style="color: #07c160;">å¾®ä¿¡å®¢æœ</div>
                        <div style="padding: 20px 0;">
                            <!-- å¾®ä¿¡äºŒç»´ç  -->
                            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                <div style="width: 200px; height: 200px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
                                    <div style="text-align: center; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“±</div>
                                        <div style="font-size: 14px;">å¾®ä¿¡äºŒç»´ç </div>
                                        <div style="font-size: 12px; margin-top: 4px;">æ‰«ç æ·»åŠ å®¢æœ</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¾®ä¿¡å· -->
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">å®¢æœå¾®ä¿¡å·</div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #07c160; font-family: monospace;">ZYJC_Service</span>
                                    <button onclick="copyToClipboard('ZYJC_Service')" style="background: #07c160; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">å¤åˆ¶</button>
                                </div>
                            </div>
                            
                            <!-- æœåŠ¡æ—¶é—´ -->
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #856404; text-align: center;">
                                    <strong>æœåŠ¡æ—¶é—´ï¼š</strong>å‘¨ä¸€è‡³å‘¨æ—¥ 9:00-22:00<br>
                                    èŠ‚å‡æ—¥æ­£å¸¸æœåŠ¡ï¼Œå“åº”æ—¶é—´ â‰¤ 30åˆ†é’Ÿ
                                </div>
                            </div>
                            
                            <!-- ä½¿ç”¨æç¤º -->
                            <div style="text-align: left; font-size: 12px; color: #666; line-height: 1.4;">
                                <div style="margin-bottom: 4px;">ğŸ”¸ æ‰«ç æˆ–æœç´¢å¾®ä¿¡å·æ·»åŠ å®¢æœ</div>
                                <div style="margin-bottom: 4px;">ğŸ”¸ è¯·è¯´æ˜æ‚¨çš„é—®é¢˜ç±»å‹å’Œè¯¦ç»†æƒ…å†µ</div>
                                <div>ğŸ”¸ å·¥ä½œæ—¶é—´å†…å°†ä¼˜å…ˆå¤„ç†æ‚¨çš„å’¨è¯¢</div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-primary" onclick="closeWeChatModal()" style="width: 100%;">çŸ¥é“äº†</button>
                        </div>
                    </div>
                </div>
            `;
            
            // å…³é—­å®¢æœæ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºå¾®ä¿¡æ¨¡æ€æ¡†
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', wechatModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('wechatModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWeChatModal();
                }
            });
        }

        function closeWeChatModal() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å¾®ä¿¡å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
            } else {
                // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('å¾®ä¿¡å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
                document.body.removeChild(textArea);
            }
        }

        function callCustomerService() {
            showModal(
                'æ‹¨æ‰“å®¢æœç”µè¯',
                'å³å°†æ‹¨æ‰“å®¢æœçƒ­çº¿ 400-8888-9999\næœåŠ¡æ—¶é—´ï¼šå·¥ä½œæ—¥ 9:00-18:00',
                () => {
                    window.open('tel:400-8888-9999');
                    closeCustomerServiceModal();
                }
            );
        }

        function createTicket() {
            const ticketModalHtml = `
                <div class="modal" id="ticketModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-title">æäº¤å·¥å•</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">é—®é¢˜ç±»å‹ *</label>
                                <select id="ticketType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">è¯·é€‰æ‹©é—®é¢˜ç±»å‹</option>
                                    <option value="homework">ä½œä¸šæ‰¹æ”¹é—®é¢˜</option>
                                    <option value="account">è´¦å·ç™»å½•é—®é¢˜</option>
                                    <option value="payment">æ”¯ä»˜ç›¸å…³é—®é¢˜</option>
                                    <option value="function">åŠŸèƒ½ä½¿ç”¨é—®é¢˜</option>
                                    <option value="suggestion">å»ºè®®åé¦ˆ</option>
                                    <option value="other">å…¶ä»–é—®é¢˜</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">é—®é¢˜æ ‡é¢˜ *</label>
                                <input type="text" id="ticketTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="ç®€è¦æè¿°æ‚¨çš„é—®é¢˜" maxlength="50">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">è¯¦ç»†æè¿° *</label>
                                <textarea id="ticketDescription" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å…·ä½“çš„æ“ä½œæ­¥éª¤ã€é”™è¯¯ä¿¡æ¯ç­‰"></textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">è”ç³»æ–¹å¼</label>
                                <input type="text" id="ticketContact" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="æ‰‹æœºå·æˆ–é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
                            </div>
                            <div style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; font-size: 12px; color: #0c5aa6;">
                                ğŸ’¡ æç¤ºï¼šå·¥å•æäº¤åï¼Œæˆ‘ä»¬ä¼šåœ¨1-2ä¸ªå·¥ä½œæ—¥å†…å›å¤å¤„ç†ç»“æœï¼Œæ‚¨å¯ä»¥åœ¨"æˆ‘çš„å·¥å•"ä¸­æŸ¥çœ‹å¤„ç†è¿›åº¦ã€‚
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeTicketModal()">å–æ¶ˆ</button>
                            <button class="modal-btn btn-primary" onclick="submitTicket()">æäº¤å·¥å•</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', ticketModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('ticketModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTicketModal();
                }
            });
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitTicket() {
            const type = document.getElementById('ticketType').value;
            const title = document.getElementById('ticketTitle').value.trim();
            const description = document.getElementById('ticketDescription').value.trim();
            const contact = document.getElementById('ticketContact').value.trim();
            
            if (!type) {
                showToast('è¯·é€‰æ‹©é—®é¢˜ç±»å‹');
                return;
            }
            
            if (!title) {
                showToast('è¯·è¾“å…¥é—®é¢˜æ ‡é¢˜');
                return;
            }
            
            if (!description) {
                showToast('è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/support/tickets`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        title,
                        description,
                        contact
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('å·¥å•æäº¤æˆåŠŸï¼Œå·¥å•å·ï¼š' + (result.ticket_id || 'T' + Date.now()));
                    closeTicketModal();
                } else {
                    showToast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('æäº¤å·¥å•å¤±è´¥:', error);
                showToast('å·¥å•æäº¤æˆåŠŸï¼Œæˆ‘ä»¬å°†å°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜'); // æ¨¡æ‹ŸæˆåŠŸ
                closeTicketModal();
            }
        }

        function showFAQ(category) {
            const faqData = {
                'ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜': {
                    title: 'ä½œä¸šæ‰¹æ”¹ç›¸å…³é—®é¢˜',
                    items: [
                        { q: 'å¦‚ä½•æ‹æ‘„ä½œä¸šç…§ç‰‡ï¼Ÿ', a: 'è¯·ç¡®ä¿å…‰çº¿å……è¶³ï¼Œä½œä¸šå®Œæ•´æ¸…æ™°å¯è§ï¼Œé¿å…é˜´å½±å’Œåå…‰ã€‚å»ºè®®å‚ç›´æ‹æ‘„ï¼Œä¿æŒä½œä¸šåœ¨ç”»é¢ä¸­å¤®ã€‚' },
                        { q: 'æ‰¹æ”¹ç»“æœä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ', a: 'è¯·æ£€æŸ¥ç…§ç‰‡æ˜¯å¦æ¸…æ™°ï¼Œå¦‚æœç…§ç‰‡æ¸…æ™°ä½†ç»“æœä»ä¸å‡†ç¡®ï¼Œå¯ä»¥é‡æ–°æ‹æ‘„æˆ–è”ç³»å®¢æœåé¦ˆã€‚' },
                        { q: 'æ”¯æŒå“ªäº›å­¦ç§‘çš„æ‰¹æ”¹ï¼Ÿ', a: 'ç›®å‰æ”¯æŒå°å­¦å’Œåˆä¸­çš„æ•°å­¦ã€è¯­æ–‡ã€è‹±è¯­ç­‰ä¸»è¦å­¦ç§‘ï¼Œæ­£åœ¨ä¸æ–­æ‰©å±•æ›´å¤šå­¦ç§‘æ”¯æŒã€‚' }
                    ]
                },
                'è´¦å·å’Œç™»å½•é—®é¢˜': {
                    title: 'è´¦å·å’Œç™»å½•é—®é¢˜',
                    items: [
                        { q: 'å¿˜è®°ç™»å½•å¯†ç æ€ä¹ˆåŠï¼Ÿ', a: 'åœ¨ç™»å½•é¡µé¢ç‚¹å‡»"å¿˜è®°å¯†ç "ï¼Œè¾“å…¥æ‰‹æœºå·è·å–éªŒè¯ç é‡ç½®å¯†ç ã€‚' },
                        { q: 'å¦‚ä½•æ›´æ¢ç»‘å®šæ‰‹æœºå·ï¼Ÿ', a: 'è¿›å…¥ä¸ªäººè®¾ç½®-è´¦æˆ·å®‰å…¨-æ›´æ¢æ‰‹æœºå·ï¼ŒæŒ‰ç…§æç¤ºå®ŒæˆéªŒè¯å³å¯ã€‚' },
                        { q: 'å¯ä»¥åŒæ—¶ç™»å½•å¤šä¸ªè®¾å¤‡å—ï¼Ÿ', a: 'åŒä¸€è´¦å·å¯ä»¥åœ¨3å°è®¾å¤‡ä¸ŠåŒæ—¶ç™»å½•ï¼Œè¶…å‡ºæ•°é‡ä¼šè‡ªåŠ¨é€€å‡ºæœ€æ—©ç™»å½•çš„è®¾å¤‡ã€‚' }
                    ]
                },
                'VIPä¼šå‘˜æœåŠ¡': {
                    title: 'VIPä¼šå‘˜æœåŠ¡',
                    items: [
                        { q: 'VIPä¼šå‘˜æœ‰ä»€ä¹ˆç‰¹æƒï¼Ÿ', a: 'æ— é™æ¬¡æ‰¹æ”¹ã€ä¼˜å…ˆå®¢æœæ”¯æŒã€è¯¦ç»†å­¦ä¹ æŠ¥å‘Šã€é”™é¢˜æœ¬åŠŸèƒ½ã€å®¶é•¿ç«¯ç›‘æ§ç­‰ã€‚' },
                        { q: 'å¦‚ä½•è´­ä¹°VIPä¼šå‘˜ï¼Ÿ', a: 'è¿›å…¥ä¼šå‘˜ä¸­å¿ƒé€‰æ‹©åˆé€‚çš„å¥—é¤ï¼Œæ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰å¤šç§æ”¯ä»˜æ–¹å¼ã€‚' },
                        { q: 'VIPåˆ°æœŸåæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ', a: 'ä¸ä¼šï¼Œæ‰€æœ‰å­¦ä¹ æ•°æ®å’Œä½œä¸šè®°å½•éƒ½ä¼šæ°¸ä¹…ä¿å­˜ï¼Œåˆ°æœŸåéƒ¨åˆ†é«˜çº§åŠŸèƒ½å—é™ã€‚' }
                    ]
                },
                'å®¶é•¿ç»‘å®šä½¿ç”¨': {
                    title: 'å®¶é•¿ç»‘å®šä½¿ç”¨',
                    items: [
                        { q: 'å¦‚ä½•ç»‘å®šå®¶é•¿è´¦å·ï¼Ÿ', a: 'å­¦ç”Ÿåœ¨ä¸ªäººä¸­å¿ƒ-å®¶é•¿ç»‘å®šä¸­ç”Ÿæˆé‚€è¯·ç ï¼Œå®¶é•¿ä¸‹è½½APPåè¾“å…¥é‚€è¯·ç å³å¯ç»‘å®šã€‚' },
                        { q: 'å®¶é•¿å¯ä»¥çœ‹åˆ°å“ªäº›ä¿¡æ¯ï¼Ÿ', a: 'å®¶é•¿å¯ä»¥æŸ¥çœ‹å­©å­çš„ä½œä¸šè®°å½•ã€å­¦ä¹ æŠ¥å‘Šã€é”™é¢˜ç»Ÿè®¡ã€å­¦ä¹ æ—¶é•¿ç­‰è¯¦ç»†ä¿¡æ¯ã€‚' },
                        { q: 'å¯ä»¥ç»‘å®šå¤šä¸ªå®¶é•¿å—ï¼Ÿ', a: 'ä¸€ä¸ªå­¦ç”Ÿè´¦å·æœ€å¤šå¯ä»¥ç»‘å®š2ä¸ªå®¶é•¿è´¦å·ï¼ˆå¦‚çˆ¶äº²å’Œæ¯äº²ï¼‰ã€‚' }
                    ]
                }
            };
            
            const faq = faqData[category];
            if (!faq) return;
            
            const faqModalHtml = `
                <div class="modal" id="faqModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-title">${faq.title}</div>
                        <div style="padding: 20px 0; max-height: 350px; overflow-y: auto;">
                            ${faq.items.map((item, index) => `
                                <div style="margin-bottom: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 16px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQAnswer(${index})">
                                        <span>Q${index + 1}: ${item.q}</span>
                                        <span id="faqIcon${index}" style="float: right; color: #666;">â–¼</span>
                                    </div>
                                    <div id="faqAnswer${index}" style="font-size: 13px; color: #666; line-height: 1.4; display: none; padding-left: 16px;">
                                        ${item.a}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-primary" onclick="closeFAQModal()" style="width: 100%;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', faqModalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('faqModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFAQModal();
                }
            });
        }

        function toggleFAQAnswer(index) {
            const answer = document.getElementById(`faqAnswer${index}`);
            const icon = document.getElementById(`faqIcon${index}`);
            
            if (answer.style.display === 'none') {
                answer.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                answer.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        function closeFAQModal() {
            const modal = document.getElementById('faqModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeCustomerServiceModal() {
            const modal = document.getElementById('customerServiceModal');
            if (modal) {
                modal.remove();
            }
        }

        function goToAbout() {
            showAboutModal();
        }

        function showAboutModal() {
            const modalHtml = `
                <div class="modal" id="aboutModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-title">å…³äºæˆ‘ä»¬</div>
                        <div style="padding: 20px 0;">
                            <!-- äº§å“ä»‹ç» -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“š</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">ZYJCæ™ºèƒ½æ‰¹æ”¹</div>
                                <div style="font-size: 14px; color: #666; line-height: 1.4;">è®©å­¦ä¹ æ›´æ™ºèƒ½ï¼Œè®©æˆé•¿æ›´é«˜æ•ˆ</div>
                            </div>
                            
                            <!-- äº§å“ç‰¹è‰² -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸš€ äº§å“ç‰¹è‰²</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">âœ¨</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">AIæ™ºèƒ½è¯†åˆ«</div>
                                            <div style="font-size: 12px; color: #666;">å…ˆè¿›çš„OCRæŠ€æœ¯ï¼Œç²¾å‡†è¯†åˆ«æ‰‹å†™ä½œä¸š</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">âš¡</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">ç§’çº§æ‰¹æ”¹</div>
                                            <div style="font-size: 12px; color: #666;">æ‹ç…§å³æ‰¹æ”¹ï¼Œ3ç§’å®Œæˆå…¨éƒ¨é¢˜ç›®æ£€æŸ¥</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">ğŸ“Š</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">è¯¦ç»†åˆ†æ</div>
                                            <div style="font-size: 12px; color: #666;">æä¾›é”™é¢˜åˆ†æå’Œå­¦ä¹ å»ºè®®</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">å®¶é•¿ç›‘æ§</div>
                                            <div style="font-size: 12px; color: #666;">å®¶é•¿ç«¯å®æ—¶æŸ¥çœ‹å­¦ä¹ æƒ…å†µ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ”¯æŒå­¦ç§‘ -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“– æ”¯æŒå­¦ç§‘</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">æ•°å­¦</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">è¯­æ–‡</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">è‹±è¯­</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">ç‰©ç†</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">åŒ–å­¦</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">ç”Ÿç‰©</div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #999; margin-top: 8px;">æŒç»­æ‰©å±•æ›´å¤šå­¦ç§‘æ”¯æŒ...</div>
                            </div>
                            
                            <!-- æ•°æ®ç»Ÿè®¡ -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“ˆ æœåŠ¡æ•°æ®</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="text-align: center; padding: 16px; background: #fff5f5; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">100ä¸‡+</div>
                                        <div style="font-size: 12px; color: #666;">ç´¯è®¡ç”¨æˆ·</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0f5ff; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #007AFF; margin-bottom: 4px;">1000ä¸‡+</div>
                                        <div style="font-size: 12px; color: #666;">æ‰¹æ”¹é¢˜ç›®</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0fff4; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #28a745; margin-bottom: 4px;">98.5%</div>
                                        <div style="font-size: 12px; color: #666;">è¯†åˆ«å‡†ç¡®ç‡</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #fffbf0; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #ffc107; margin-bottom: 4px;">24/7</div>
                                        <div style="font-size: 12px; color: #666;">åœ¨çº¿æœåŠ¡</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è”ç³»æ–¹å¼ -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">ğŸ“ è”ç³»æˆ‘ä»¬</div>
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">å®¢æœçƒ­çº¿</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">400-8888-9999</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">å®¢æœé‚®ç®±</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">service@zyjc.com</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 14px; color: #333;">å¾®ä¿¡å®¢æœ</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #07c160;">ZYJC_Service</div>
                                    </div>
                                    <div style="font-size: 12px; color: #666; text-align: center; padding-top: 8px; border-top: 1px solid #eee;">
                                        æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨æ—¥ 9:00-22:00
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç‰ˆæƒä¿¡æ¯ -->
                            <div style="text-align: center; padding: 16px; border-top: 1px solid #eee;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">ZYJCæ™ºèƒ½æ‰¹æ”¹ v1.0.0</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Â© 2025 ZYJCå›¢é˜Ÿ ç‰ˆæƒæ‰€æœ‰</div>
                                <div style="font-size: 12px; color: #999; line-height: 1.4;">
                                    æœ¬äº§å“å·²è·å¾—è½¯ä»¶è‘—ä½œæƒä¿æŠ¤<br>
                                    è¿æ³•å¤åˆ¶æˆ–ç›—ç”¨å°†æ‰¿æ‹…æ³•å¾‹è´£ä»»
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 16px;">
                            <button class="modal-btn btn-primary" onclick="closeAboutModal()" style="width: 100%;">çŸ¥é“äº†</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('aboutModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            document.getElementById('aboutModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAboutModal();
                }
            });
        }

        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (modal) {
                modal.remove();
            }
        }

        function checkForUpdates() {
            showToast('æ­£åœ¨æ£€æŸ¥æ›´æ–°...');
            
            // æ¨¡æ‹Ÿæ£€æŸ¥æ›´æ–°
            setTimeout(() => {
                const hasUpdate = Math.random() > 0.7; // 30% æ¦‚ç‡æœ‰æ›´æ–°
                
                if (hasUpdate) {
                    showModal(
                        'å‘ç°æ–°ç‰ˆæœ¬',
                        'å‘ç°æ–°ç‰ˆæœ¬ v1.1.0ï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š\nâ€¢ æ–°å¢ç§‘å­¦å­¦ç§‘æ”¯æŒ\nâ€¢ ä¼˜åŒ–è¯†åˆ«å‡†ç¡®ç‡\nâ€¢ ä¿®å¤å·²çŸ¥é—®é¢˜\n\næ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ',
                        () => {
                            showToast('å¼€å§‹ä¸‹è½½æ›´æ–°...');
                            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ›´æ–°é€»è¾‘
                            setTimeout(() => {
                                showToast('æ›´æ–°å®Œæˆï¼Œé‡å¯åº”ç”¨åç”Ÿæ•ˆ');
                            }, 2000);
                        }
                    );
                } else {
                    showToast('æ‚¨ä½¿ç”¨çš„å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                }
            }, 1500);
        }

        function logout() {
            showModal(
                'é€€å‡ºç™»å½•',
                'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°ç™»å½•ã€‚',
                () => {
                    // æ¸…é™¤æœ¬åœ°æ•°æ®
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('role');
                    
                    showToast('å·²é€€å‡ºç™»å½•');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 1500);
                }
            );
        }

        function showModal(title, text, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('confirmModal').style.display = 'flex';
            pendingAction = action;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeModal();
        }

        function goBack() {
            window.history.back();
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function showToast(message, duration = 3000) {
            // è®°å½•æ¶ˆæ¯åˆ°æ§åˆ¶å°
            console.log('ğŸ”” æ˜¾ç¤ºToastæ¶ˆæ¯:', message);
            
            const toast = document.createElement('div');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºé”™è¯¯æ¶ˆæ¯
            const isError = message.includes('å¤±è´¥') || message.includes('é”™è¯¯') || message.includes('å¼‚å¸¸') || message.includes('è¿‡æœŸ');
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? 'rgba(244, 67, 54, 0.9)' : 'rgba(76, 175, 80, 0.9)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 500;
                z-index: 10001;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid ${isError ? '#f44336' : '#4CAF50'};
                max-width: 80%;
                text-align: center;
                word-wrap: break-word;
                animation: fadeInScale 0.3s ease-out;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInScale {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
                @keyframes fadeOutScale {
                    0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            if (!document.getElementById('toast-styles')) {
                style.id = 'toast-styles';
                document.head.appendChild(style);
            }
            
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´
            const showDuration = isError ? Math.max(duration, 5000) : duration;
            
            setTimeout(() => {
                toast.style.animation = 'fadeOutScale 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, showDuration);
        }

        // å®¶é•¿ä¸“ç”¨å¯¼èˆªå‡½æ•°
        function goToChildrenManagement() {
            // è®°å½•è¿”å›æ¥æºï¼Œä»¥ä¾¿è¿”å›æ—¶åˆ·æ–°æ•°æ®
            localStorage.setItem('returnFromPage', 'manage-children');
            window.location.href = '/frontend/manage-children.html';
        }

        function goToChildManagement() {
            // è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ä¸åº•éƒ¨å¯¼èˆªä¿æŒä¸€è‡´
            goToChildrenManagement();
        }

        function goToLearningReports() {
            localStorage.setItem('returnFromPage', 'learning-reports');
            window.location.href = '/frontend/learning-reports.html';
        }

        function goToErrorAnalysis() {
            localStorage.setItem('returnFromPage', 'error-analysis');
            window.location.href = '/frontend/error-analysis.html';
        }

        function goToLearningProgress() {
            localStorage.setItem('returnFromPage', 'learning-progress');
            window.location.href = '/frontend/learning-progress.html';
        }


        // å®¶é•¿åº•éƒ¨å¯¼èˆªç»Ÿä¸€å‡½æ•° - ä¸å…¶ä»–å®¶é•¿é¡µé¢ä¿æŒä¸€è‡´
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }

        function goToProfile() {
            // å½“å‰å°±æ˜¯profileé¡µé¢ï¼Œåˆ·æ–°é¡µé¢
            window.location.reload();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // é¡µé¢åº•éƒ¨é—´è·ç”±åº•éƒ¨å¯¼èˆªç»„ä»¶çš„CSSç»Ÿä¸€å¤„ç†
        // ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®paddingBottom
        
        // === å¯¼èˆªè·³è½¬å‡½æ•° ===
        
        // å®¶é•¿å¯¼èˆªè·³è½¬å‡½æ•°
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }
        
        function goToLearningReports() {
            window.location.href = '/frontend/learning-reports.html';
        }
        
        function goToErrorAnalysis() {
            window.location.href = '/frontend/error-analysis.html';
        }
        
        function goToLearningProgress() {
            window.location.href = '/frontend/learning-progress.html';
        }
        
        function goToChildDetail() {
            window.location.href = '/frontend/manage-children.html';
        }
        
        function goToProfile() {
            // å·²åœ¨å½“å‰é¡µé¢ï¼Œå¯ä»¥åˆ·æ–°æˆ–ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            console.log('å·²åœ¨profileé¡µé¢');
        }
        
        // å­¦ç”Ÿå¯¼èˆªè·³è½¬å‡½æ•°
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        // ç«‹å³æ›´æ–°å¤´åƒæ˜¾ç¤ºå‡½æ•°
        function immediateUpdateAvatarDisplay(avatarUrl) {
            console.log('=== ç«‹å³æ›´æ–°å¤´åƒæ˜¾ç¤º ===', avatarUrl);
            
            if (!avatarUrl) {
                console.log('å¤´åƒURLä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°');
                return;
            }
            
            // è®¾ç½®å…¨å±€æ ‡è®°ï¼Œç¡®ä¿å›¾ç‰‡å¤´åƒå¼ºåˆ¶åˆ·æ–°
            window.recentAvatarUpdate = true;
            
            // æŸ¥æ‰¾é¡µé¢ä¸­æ‰€æœ‰éœ€è¦æ›´æ–°çš„å¤´åƒå…ƒç´ 
            const avatarElements = [
                // ä¸»é¡µé¢çš„ç”¨æˆ·å¤´åƒ
                document.getElementById('userAvatar'),
                // å…¶ä»–å¯èƒ½çš„å¤´åƒæ˜¾ç¤ºä½ç½®
                document.querySelector('.user-avatar'),
                document.querySelector('.profile-avatar'),
                document.querySelector('[data-avatar-display]'),
                // æ‰€æœ‰å…·æœ‰avatar classçš„å…ƒç´ 
                ...document.querySelectorAll('.avatar')
            ];
            
            // å»é‡å¹¶è¿‡æ»¤æ‰nullå…ƒç´ 
            const uniqueAvatarElements = [...new Set(avatarElements)].filter(el => el !== null);
            
            console.log('æ‰¾åˆ°éœ€è¦æ›´æ–°çš„å¤´åƒå…ƒç´ æ•°é‡:', uniqueAvatarElements.length);
            
            uniqueAvatarElements.forEach((avatarElement, index) => {
                if (avatarElement) {
                    console.log(`æ›´æ–°å¤´åƒå…ƒç´  ${index + 1}:`, avatarElement.className || avatarElement.id);
                    
                    try {
                        if (avatarUrl.startsWith('emoji:')) {
                            // è¡¨æƒ…å¤´åƒ
                            const emoji = avatarUrl.replace('emoji:', '');
                            avatarElement.innerHTML = emoji;
                            // é‡ç½®èƒŒæ™¯æ ·å¼ä»¥é˜²æœ‰è‡ªå®šä¹‰èƒŒæ™¯
                            avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            console.log(`âœ… æ›´æ–°emojiå¤´åƒ: ${emoji}`);
                            
                        } else if (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.startsWith('data:')) {
                            // å›¾ç‰‡å¤´åƒ
                            let imageUrl = avatarUrl;
                            if (avatarUrl.startsWith('/uploads/')) {
                                // ç›¸å¯¹è·¯å¾„ï¼ŒåŠ ä¸ŠAPIæœåŠ¡å™¨åœ°å€
                                imageUrl = `http://localhost:8000${avatarUrl}`;
                            }
                            
                            // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°å›¾ç‰‡ç¼“å­˜
                            const separator = imageUrl.includes('?') ? '&' : '?';
                            const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                            
                            avatarElement.innerHTML = `<img src="${timestampUrl}" 
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                                alt="ç”¨æˆ·å¤´åƒ" 
                                onerror="this.parentElement.innerHTML='ğŸ‘¤'">`;
                            console.log(`âœ… æ›´æ–°å›¾ç‰‡å¤´åƒ: ${timestampUrl}`);
                            
                        } else {
                            // é»˜è®¤å¤´åƒ
                            avatarElement.innerHTML = 'ğŸ‘¤';
                            avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            console.log('âœ… è®¾ç½®é»˜è®¤å¤´åƒ');
                        }
                        
                    } catch (error) {
                        console.error(`âŒ æ›´æ–°å¤´åƒå…ƒç´  ${index + 1} å¤±è´¥:`, error);
                        // å‡ºé”™æ—¶è®¾ç½®é»˜è®¤å¤´åƒ
                        avatarElement.innerHTML = 'ğŸ‘¤';
                        avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                }
            });
            
            // é¢å¤–æ›´æ–°localStorageä¸­çš„ç”¨æˆ·å¤´åƒä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            try {
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                if (storedUser && storedUser.avatar_url !== avatarUrl) {
                    storedUser.avatar_url = avatarUrl;
                    localStorage.setItem('user', JSON.stringify(storedUser));
                    console.log('âœ… å·²åŒæ­¥æ›´æ–°localStorageä¸­çš„å¤´åƒURL:', avatarUrl);
                }
            } catch (error) {
                console.error('æ›´æ–°localStorageå¤´åƒä¿¡æ¯å¤±è´¥:', error);
            }
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶å¤´åƒå·²æ›´æ–°
            window.dispatchEvent(new CustomEvent('avatarUpdated', {
                detail: { avatarUrl: avatarUrl }
            }));
            
            // å»¶è¿Ÿæ¸…é™¤å…¨å±€æ ‡è®°ï¼Œç¡®ä¿å…¶ä»–å¯èƒ½çš„å¤´åƒæ›´æ–°æ“ä½œå®Œæˆ
            setTimeout(() => {
                if (window.recentAvatarUpdate === true) {
                    window.recentAvatarUpdate = false;
                    console.log('âœ… æ¸…é™¤å¤´åƒæ›´æ–°å…¨å±€æ ‡è®°');
                }
            }, 1000);
            
            console.log('ğŸ‰ å¤´åƒæ˜¾ç¤ºç«‹å³æ›´æ–°å®Œæˆ');
        }
        
    </script>
</body>
</html>