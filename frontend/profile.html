<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJC智能批改 - 个人中心</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* 用户信息卡片 */
        .user-header {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        
        
        
        
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }
        
        .stat-item {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 6px;
            line-height: 1.2;
            color: #26a69a;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
        
        /* 页面内容 */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
        }
        
        
        /* VIP状态卡片 */
        .vip-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            color: #333;
            display: none;
            box-shadow: 0 8px 32px rgba(255, 183, 71, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .vip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(255, 183, 71, 0.4);
        }
        
        .vip-card.active {
            display: block;
        }
        
        .vip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .vip-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vip-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .vip-info {
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .vip-benefits {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* 功能菜单 */
        .menu-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .menu-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(102, 126, 234, 0.08);
            position: relative;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .menu-item:hover::before {
            opacity: 1;
        }
        
        .menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 28px;
        }
        
        .menu-item:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
        }
        
        .menu-arrow {
            font-size: 14px;
            color: #ccc;
        }
        
        .menu-badge {
            position: absolute;
            top: 12px;
            right: 40px;
            background: #ff3b30;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 设置开关 */
        .setting-toggle {
            width: 44px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .setting-toggle.active {
            background: #4CAF50;
        }
        
        .toggle-handle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .setting-toggle.active .toggle-handle {
            transform: translateX(20px);
        }
        
        /* 版本信息 */
        .version-info {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
            margin-bottom: 80px;
        }
        
        .version-text {
            margin-bottom: 8px;
        }
        
        .copyright {
            margin-bottom: 8px;
        }
        
        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        
        .modal-text {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%) !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(38, 166, 154, 0.3) !important;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2bbbad 0%, #00796b 100%) !important;
            box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4) !important;
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* Modal基本样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
        }
        
        /* 底部导航样式已移至统一组件 bottom-navigation.css */
        
        /* 头像编辑相关样式 */
        .avatar-edit-content {
            padding: 20px 0;
        }
        
        .current-avatar-preview {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 8px;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-preview-label {
            font-size: 12px;
            color: #666;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .upload-option {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-option:hover {
            border-color: #007AFF;
            background: #f8f9ff;
        }
        
        .upload-option.selected {
            border-color: #007AFF;
            background: #f0f5ff;
        }
        
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .upload-desc {
            font-size: 12px;
            color: #666;
        }
        
        .default-avatars {
            padding: 16px 0;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .default-avatar-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            justify-self: center;
        }
        
        .default-avatar-item:hover {
            transform: scale(1.1);
            border-color: #007AFF;
        }
        
        .default-avatar-item.selected {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* 上传进度 */
        .upload-progress {
            margin-top: 16px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        /* 孩子卡片样式 */
        .child-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        
        .child-item:last-child {
            border-bottom: none;
        }
        
        .child-item:hover {
            background: #f8f9fa;
        }
        
        .child-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .child-info {
            flex: 1;
        }
        
        .child-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .child-details {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .child-grade {
            background: #e3f2fd;
            color: #1976D2;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .child-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 3px;
            background: #4CAF50;
        }
        
        .status-dot.inactive {
            background: #ff9800;
        }
        
        .child-stats {
            text-align: right;
            flex-shrink: 0;
        }
        
        .child-score {
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 2px;
        }
        
        .child-score.low {
            color: #ff9800;
        }
        
        .child-time {
            font-size: 11px;
            color: #999;
        }
        
        .section-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 2;
            padding: 16px 0 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 中等屏幕适配 */
        @media (max-width: 768px) and (min-width: 481px) {
            .user-stats {
                gap: 42px;
            }
        }
        
        /* 加载状态优化 */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .user-stats {
                gap: 36px;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .default-avatar-item {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
    <script src="/frontend/js/global-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">个人中心</div>
                </div>
            </div>
        </div>
        
        <!-- 页面内容 -->
        <div class="page-content">
            <!-- 用户信息卡片 -->
            <div class="user-header">
                <div class="avatar-container">
                    <div class="user-avatar" id="userAvatar">👤</div>
                    <div class="avatar-edit" onclick="editAvatar()">✏️</div>
                </div>
                
                <div class="user-name" id="userName">正在加载...</div>
                <div class="user-info" id="userInfo">学生 · 五年级</div>
                
                <div class="user-stats">
                    <!-- 学生统计信息 -->
                    <div class="student-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="totalHomework">0</div>
                            <div class="stat-label">总作业</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyRate">0%</div>
                            <div class="stat-label">正确率</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="studyDays">0</div>
                            <div class="stat-label">学习天数</div>
                        </div>
                    </div>
                    
                    <!-- 家长统计信息 -->
                    <div class="parent-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="childrenCount">0</div>
                            <div class="stat-label">孩子数量</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="todayHomeworkCount">0</div>
                            <div class="stat-label">今日作业</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="averageAccuracy">0%</div>
                            <div class="stat-label">平均正确率</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- VIP卡片 -->
            <div class="vip-card" id="vipCard">
                <div class="vip-header">
                    <div class="vip-title">
                        👑 VIP会员
                        <div class="vip-badge">至尊版</div>
                    </div>
                </div>
                <div class="vip-info">无限次批改 · 专属客服 · 详细解析</div>
                <div class="vip-benefits">有效期至: <span id="vipExpireDate">2025-12-31</span></div>
            </div>
            
            <!-- 学习管理 / 孩子管理 -->
            <div class="menu-section" id="mainFunctionSection">
                <!-- 学生功能 -->
                <div class="student-functions" style="display: none;">
                    <div class="menu-item" onclick="goToErrorBook()">
                        <div class="menu-icon">📚</div>
                        <div class="menu-content">
                            <div class="menu-title">我的错题本</div>
                            <div class="menu-desc">查看和复习错题</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToStudyPlan()">
                        <div class="menu-icon">📋</div>
                        <div class="menu-content">
                            <div class="menu-title">学习计划</div>
                            <div class="menu-desc">制定和管理学习计划</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToHomeworkHistory()">
                        <div class="menu-icon">📝</div>
                        <div class="menu-content">
                            <div class="menu-title">作业记录</div>
                            <div class="menu-desc">查看历史批改记录</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                </div>
                
                <!-- 家长功能 -->
                <div class="parent-functions" style="display: none;">
                    <div class="menu-item" onclick="goToChildrenManagement()">
                        <div class="menu-icon">👨‍👩‍👧‍👦</div>
                        <div class="menu-content">
                            <div class="menu-title">孩子管理</div>
                            <div class="menu-desc">查看和管理孩子信息</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToLearningReports()">
                        <div class="menu-icon">📊</div>
                        <div class="menu-content">
                            <div class="menu-title">学习报告</div>
                            <div class="menu-desc">查看孩子的学习分析报告</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToParentBind()">
                        <div class="menu-icon">🔗</div>
                        <div class="menu-content">
                            <div class="menu-title">账号绑定</div>
                            <div class="menu-desc">绑定或管理孩子账号</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                </div>
            </div>
            
            <!-- 孩子列表（仅家长可见） -->
            <div class="menu-section" id="childrenSection" style="display: none;">
                <div class="section-header">
                    <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px; padding: 0 20px;">👶 我的孩子</h3>
                </div>
                <div id="childrenList">
                    <!-- 孩子列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 账户管理 -->
            <div class="menu-section">
                <div class="menu-item" onclick="goToVipCenter()">
                    <div class="menu-icon">💎</div>
                    <div class="menu-content">
                        <div class="menu-title">会员中心</div>
                        <div class="menu-desc">升级VIP，享受更多特权</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="goToParentBind()">
                    <div class="menu-icon">👨‍👩‍👧‍👦</div>
                    <div class="menu-content">
                        <div class="menu-title">家长绑定</div>
                        <div class="menu-desc">绑定家长账号，实时同步学习情况</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="editProfile()">
                    <div class="menu-icon">⚙️</div>
                    <div class="menu-content">
                        <div class="menu-title">个人资料</div>
                        <div class="menu-desc">修改昵称、年级等信息</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
            </div>
            
            <!-- 应用设置 -->
            <div class="menu-section">
                <div class="menu-item" onclick="toggleNotification()">
                    <div class="menu-icon">🔔</div>
                    <div class="menu-content">
                        <div class="menu-title">消息通知</div>
                        <div class="menu-desc">学习提醒和系统通知</div>
                    </div>
                    <div class="setting-toggle active" id="notificationToggle">
                        <div class="toggle-handle"></div>
                    </div>
                </div>
            </div>
            
            <!-- 帮助支持 -->
            <div class="menu-section">
                <div class="menu-item" onclick="contactSupport()">
                    <div class="menu-icon">💬</div>
                    <div class="menu-content">
                        <div class="menu-title">客服支持</div>
                        <div class="menu-desc">在线客服，随时为您服务</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="goToAbout()">
                    <div class="menu-icon">ℹ️</div>
                    <div class="menu-content">
                        <div class="menu-title">关于我们</div>
                        <div class="menu-desc">了解ZYJC智能批改</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
            </div>
            
            <!-- 退出登录 -->
            <div class="menu-section">
                <div class="menu-item" onclick="logout()" style="color: #f44336;">
                    <div class="menu-icon">🚪</div>
                    <div class="menu-content">
                        <div class="menu-title" style="color: #f44336;">退出登录</div>
                        <div class="menu-desc">退出当前账号</div>
                    </div>
                </div>
            </div>
            
            <!-- 版本信息 -->
            <div class="version-info">
                <div class="version-text">ZYJC智能批改 v1.0.0</div>
                <div class="copyright">© 2025 ZYJC团队</div>
                <div>让学习更智能，让成长更高效</div>
            </div>
        </div>
    </div>
    
    <!-- 底部导航通过统一组件自动生成，根据用户角色显示对应导航 -->
    
    <!-- 确认模态框 -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">确认操作</div>
            <div class="modal-text" id="modalText">确定要执行此操作吗？</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="modal-btn btn-primary" onclick="confirmAction()">确认</button>
            </div>
        </div>
    </div>

    <!-- 头像编辑模态框 -->
    <div class="modal" id="avatarModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title">编辑头像</div>
            <div class="avatar-edit-content">
                <!-- 当前头像预览 -->
                <div class="current-avatar-preview">
                    <div class="avatar-preview" id="avatarPreview">👤</div>
                    <div class="avatar-preview-label">当前头像</div>
                </div>
                
                <!-- 上传选项 -->
                <div class="upload-options">
                    <div class="upload-option" onclick="selectAvatarFile()">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">选择本地图片</div>
                        <div class="upload-desc">支持JPG、PNG格式，最大5MB</div>
                    </div>
                    
                    <div class="upload-option" onclick="selectDefaultAvatar()">
                        <div class="upload-icon">😊</div>
                        <div class="upload-text">选择默认头像</div>
                        <div class="upload-desc">系统提供的头像图标</div>
                    </div>
                </div>
                
                <!-- 文件上传 -->
                <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeAvatarModal()">取消</button>
                <button class="modal-btn btn-primary" id="saveAvatarBtn" onclick="saveAvatar()" disabled>保存</button>
            </div>
        </div>
    </div>

    <!-- 默认头像选择模态框 -->
    <div class="modal" id="defaultAvatarModal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-title">选择默认头像</div>
            <div class="default-avatars">
                <div class="avatar-grid" id="avatarGrid">
                    <!-- 默认头像将通过JavaScript生成 -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeDefaultAvatarModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 认证工具类 -->
    <script src="/frontend/js/auth-utils.js"></script>
    
    <!-- 底部导航组件 -->
    <link rel="stylesheet" href="/frontend/css/bottom-navigation.css">
    <script src="/frontend/js/navigation-config.js"></script>
    <script src="/frontend/js/bottom-navigation.js"></script>
    
    <script>
        console.log('=== SCRIPT LOADING ===');
        
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        let pendingAction = null;
        
        // 优化：添加加载状态控制
        let isLoading = false;
        let lastLoadTime = 0;
        const LOAD_DEBOUNCE_TIME = 2000; // 2秒防抖
        
        console.log('Variables initialized, API_BASE:', API_BASE);

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded事件触发，开始初始化页面');
            try {
                initPage();
            } catch (error) {
                console.error('页面初始化失败:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });
        
        // 备用初始化（防止DOMContentLoaded事件未触发）
        window.addEventListener('load', function() {
            console.log('window load事件触发');
            if (!document.querySelector('#userName').textContent.includes('测试用户')) {
                console.log('用户名未更新，尝试重新初始化');
                try {
                    initPage();
                } catch (error) {
                    console.error('备用初始化失败:', error);
                }
            }
        });
        
        // 页面获得焦点时刷新数据 - 增加防抖和频率限制
        let lastFocusRefresh = 0;
        window.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastFocusRefresh < 30000) { // 30秒内不重复刷新
                console.log('页面获得焦点，但距上次刷新不足30秒，跳过');
                return;
            }
            console.log('页面获得焦点，刷新用户数据');
            lastFocusRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 500); // 增加延迟，避免频繁触发
            }
        });
        
        // 页面可见性变化时刷新数据 - 增加防抖和频率限制
        let lastVisibilityRefresh = 0;
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = Date.now();
                if (now - lastVisibilityRefresh < 30000) { // 30秒内不重复刷新
                    console.log('页面变为可见，但距上次刷新不足30秒，跳过');
                    return;
                }
                console.log('页面变为可见，刷新用户数据');
                lastVisibilityRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role) {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500); // 增加延迟，避免频繁触发
                }
            }
        });
        
        // 监听用户信息更新事件 - 增加防抖
        let lastInfoUpdateRefresh = 0;
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('收到用户信息更新事件:', event.detail);
            const now = Date.now();
            if (now - lastInfoUpdateRefresh < 5000) { // 5秒内不重复刷新
                console.log('用户信息更新事件，但距上次刷新不足5秒，跳过');
                return;
            }
            lastInfoUpdateRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 300);
            }
        });
        
        // 监听localStorage中的子女数据更新事件 - 增加防抖
        let lastStorageRefresh = 0;
        window.addEventListener('storage', function(event) {
            if (event.key === 'childDataUpdated') {
                const now = Date.now();
                if (now - lastStorageRefresh < 10000) { // 10秒内不重复刷新
                    console.log('收到子女数据更新通知，但距上次刷新不足10秒，跳过');
                    return;
                }
                console.log('收到子女数据更新通知，刷新页面数据');
                lastStorageRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role === 'parent') {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500);
                }
            }
        });
        
        // 监听manage-children页面的直接通知
        window.addEventListener('childDataChanged', function(event) {
            console.log('收到子女数据变更事件');
            const role = AuthUtils.getCurrentUserRole();
            if (role === 'parent') {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 200);
            }
        });

        function initPage() {
            console.log('=== 初始化页面 ===');
            
            try {
                // 绑定token获取
                token = localStorage.getItem('token');
                let role = localStorage.getItem('role');
                
                console.log('初始化页面 - Token:', token ? 'OK' : 'NONE', 'Role:', role);
                
                if (!token) {
                    showToast('请先登录');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 2000);
                    return;
                }
                
                // 通过token判断用户角色，确保角色正确
                try {
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const userId = tokenPayload.sub;
                    console.log('Token中的用户ID:', userId);
                    
                    // 根据用户ID判断角色：ID=1是学生，ID=2是家长
                    if (userId === '2') {
                        role = 'parent';
                        console.log('从Token检测到家长用户');
                    } else {
                        role = 'student';
                        console.log('从Token检测到学生用户');
                    }
                    
                    // 更新localStorage中的角色信息
                    localStorage.setItem('role', role);
                    console.log('角色已更新到localStorage:', role);
                    
                } catch (error) {
                    console.error('解析Token失败，使用默认学生角色:', error);
                    role = 'student';
                    localStorage.setItem('role', role);
                }
                
                // 生成角色对应的导航
                generateRoleBasedNavigation();
                
                // 检查是否从其他页面返回，如果是则强制刷新
                const returnFromPage = localStorage.getItem('returnFromPage');
                const childDataUpdated = localStorage.getItem('childDataUpdated');
                
                if (returnFromPage) {
                    console.log('从页面返回:', returnFromPage);
                    localStorage.removeItem('returnFromPage');
                }
                
                // 检查是否有子女数据更新通知
                if (childDataUpdated && role === 'parent') {
                    console.log('检测到子女数据更新标记，清除并刷新数据');
                    localStorage.removeItem('childDataUpdated');
                }
                
                if (returnFromPage || childDataUpdated) {
                    // 延迟一点刷新，确保页面加载完成
                    setTimeout(() => {
                        console.log('从其他页面返回，强制刷新数据');
                        loadUserProfile(role, true); // 强制刷新
                    }, 500);
                } else {
                    // 正常初始化加载
                    setTimeout(() => {
                        console.log('正常初始化加载用户数据');
                        loadUserProfile(role);
                    }, 100);
                }
                
                // 设置头像文件选择监听器
                setTimeout(() => {
                    console.log('设置文件选择监听器');
                    try {
                        const avatarFileInput = document.getElementById('avatarFileInput');
                        
                        if (avatarFileInput) {
                            avatarFileInput.removeEventListener('change', handleFileSelect);
                            avatarFileInput.addEventListener('change', handleFileSelect);
                            console.log('文件选择监听器已设置');
                        } else {
                            console.warn('文件输入元素 avatarFileInput 暂未找到（可能还未渲染）');
                        }
                    } catch (listenerError) {
                        console.error('设置文件选择监听器失败:', listenerError);
                    }
                }, 200);
                
            } catch (error) {
                console.error('页面初始化过程中出现错误:', error);
                // 显示用户友好的错误信息，但不阻止页面加载
                showToast('页面加载遇到问题，部分功能可能受限，请刷新重试');
            }
        }
        
        function generateRoleBasedNavigation() {
            console.log('使用新的底部导航组件生成导航');
            
            // 使用新的统一组件初始化导航
            const success = BottomNavigation.init({
                currentPage: 'profile',
                debug: false
            });
            
            if (success) {
                console.log('✅ 底部导航组件初始化成功');
            } else {
                console.error('❌ 底部导航组件初始化失败');
                // 作为备用方案，使用旧的实现
                setupRoleBasedUIFallback();
            }
            
            // 继续配置UI显示
            const role = getCurrentUserRole();
            setupRoleBasedUI(role);
        }
        
        // 作为备用方案的简化导航创建函数
        function setupRoleBasedUIFallback() {
            console.warn('⚠️ 使用备用导航方案');
            const role = getCurrentUserRole();
            
            // 创建基本的导航结构
            const navItems = role === 'parent' ? [
                { icon: '🏠', text: '首页', onclick: 'goToParentHome()' },
                { icon: '📊', text: '学习报告', onclick: 'goToLearningReports()' },
                { icon: '👶', text: '孩子管理', onclick: 'goToChildrenManagement()' },
                { icon: '👤', text: '我的', onclick: 'goToProfile()', active: true }
            ] : [
                { icon: '🏠', text: '首页', onclick: 'goToStudentHome()' },
                { icon: '📷', text: '拍照批改', onclick: 'goToHomeworkSubmit()' },
                { icon: '📚', text: '错题本', onclick: 'goToErrorBook()' },
                { icon: '📋', text: '学习计划', onclick: 'goToStudyPlan()' },
                { icon: '👤', text: '我的', onclick: 'goToProfile()', active: true }
            ];
            
            // 创建简单的导航
            const nav = document.createElement('div');
            nav.className = role === 'parent' ? 'theme-bottom-nav' : 'global-bottom-nav';
            
            // 应用与study-plan.html一致的容器样式
            nav.style.cssText = role === 'parent' ? `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 142, 250, 0.95)) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            ` : `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            `;
            
            const itemClass = role === 'parent' ? 'theme-nav' : 'global-nav';
            nav.innerHTML = navItems.map(item => `
                <div class="${itemClass}-item ${item.active ? 'active' : ''}" ${item.onclick ? `onclick="${item.onclick}"` : ''}>
                    <div class="${itemClass}-icon">${item.icon}</div>
                    <div class="${itemClass}-text">${item.text}</div>
                </div>
            `).join('');
            
            document.body.appendChild(nav);
            
            // 应用按钮样式
            const buttons = nav.querySelectorAll(`.${itemClass}-item`);
            buttons.forEach((button, index) => {
                const isActive = button.classList.contains('active');
                
                if (role === 'parent') {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(255, 255, 255, 0.2) !important; color: white !important;' : 'background: transparent !important; color: rgba(255, 255, 255, 0.8) !important;'}
                    `;
                } else {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(76, 175, 80, 0.1) !important; color: #4CAF50 !important;' : 'background: transparent !important; color: #666 !important;'}
                    `;
                }
                
                const icon = button.querySelector(`.${itemClass}-icon`);
                const text = button.querySelector(`.${itemClass}-text`);
                if (icon) icon.style.cssText = 'font-size: 20px !important; margin-bottom: 2px !important; display: block !important;';
                if (text) text.style.cssText = 'font-size: 10px !important; line-height: 1 !important; font-weight: 500 !important;';
            });
            
            // 设置页面底部间距
            document.body.style.paddingBottom = '80px';
        }
        
        function setupRoleBasedUI(role) {
            console.log('=== 设置基于角色的UI内容显示 ===');
            console.log('当前用户角色:', role);
            
            // 安全获取元素的函数
            function safeSetDisplay(selector, display, isId = false) {
                try {
                    const element = isId ? document.getElementById(selector) : document.querySelector(selector);
                    if (element) {
                        element.style.display = display;
                        console.log(`✅ 成功设置 ${selector} 显示状态为 ${display}`);
                        return true;
                    } else {
                        console.warn(`⚠️  未找到元素: ${selector}`);
                        return false;
                    }
                } catch (error) {
                    console.error(`❌ 设置 ${selector} 样式时出错:`, error);
                    return false;
                }
            }
            
            // 根据角色配置UI显示内容
            if (role === 'student') {
                console.log('🎓 配置学生身份UI...');
                
                // 显示学生相关内容
                safeSetDisplay('.student-stats', 'flex');
                safeSetDisplay('.student-functions', 'block');
                safeSetDisplay('.parent-stats', 'none');
                safeSetDisplay('.parent-functions', 'none');
                safeSetDisplay('childrenSection', 'none', true);
                
            } else if (role === 'parent') {
                console.log('👨‍👩‍👧‍👦 配置家长身份UI...');
                
                // 显示家长相关内容
                safeSetDisplay('.parent-stats', 'flex');
                safeSetDisplay('.parent-functions', 'block');
                safeSetDisplay('.student-stats', 'none');
                safeSetDisplay('.student-functions', 'none');
                safeSetDisplay('childrenSection', 'block', true);
                
            } else {
                console.error('❌ 未知的用户角色:', role);
                return;
            }
            
            console.log(`✅ ${role}身份UI配置完成`);
        }

        // 导航相关功能函数 - 与底部导航组件配合使用
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        function goToProfile() {
            // 当前就是profile页面，刷新页面
            window.location.reload();
        }

        async function loadUserProfile(role, force = false) {
            // 防抖机制：避免频繁重复请求
            const now = Date.now();
            if (!force && (isLoading || (now - lastLoadTime < LOAD_DEBOUNCE_TIME))) {
                console.log('请求被防抖拦截，距上次加载:', now - lastLoadTime, 'ms');
                return;
            }
            
            // 设置加载状态
            isLoading = true;
            lastLoadTime = now;
            
            try {
                console.log('开始加载用户资料，角色:', role);
                
                // 显示加载状态
                showLoadingState();
                
                // 并行请求用户信息和统计数据
                const requests = [];
                
                // 用户基本信息请求
                requests.push(
                    fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // 统计数据请求
                if (role === 'student') {
                    requests.push(
                        fetch(`${API_BASE}/student/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                } else if (role === 'parent') {
                    requests.push(
                        fetch(`${API_BASE}/parent/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                }
                
                // 并行执行所有请求
                const responses = await Promise.all(requests);
                const [userResponse, statsResponse] = responses;
                
                console.log('API响应状态:', {
                    user: userResponse.status,
                    stats: statsResponse?.status
                });
                
                // 处理用户信息
                if (userResponse.ok) {
                    userInfo = await userResponse.json();
                    console.log('获取到用户信息:', userInfo);
                    
                    // 处理统计数据
                    let statsData = null;
                    if (statsResponse?.ok) {
                        statsData = await statsResponse.json();
                        console.log('获取到统计数据:', statsData);
                    } else {
                        console.error('统计数据API调用失败:', statsResponse?.status, statsResponse?.statusText);
                        // 使用默认统计数据
                        statsData = getDefaultStatsData(role);
                    }
                    
                    // 批量更新UI
                    updateUserInterface(userInfo, statsData, role);
                    
                    // 更新localStorage
                    localStorage.setItem('user', JSON.stringify(userInfo));
                    
                    // 触发更新事件
                    window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
                    
                    console.log('用户资料加载完成于:', new Date().toLocaleTimeString());
                    
                } else {
                    console.error('用户信息API调用失败:', userResponse.status, userResponse.statusText);
                    showDefaultUserData();
                    return;
                }
                
            } catch (error) {
                console.error('加载用户资料失败:', error);
                showToast('加载用户资料失败，请检查网络连接');
                showDefaultUserData();
            } finally {
                isLoading = false;
                hideLoadingState();
            }
        }
        
        async function loadStudentStats() {
            try {
                const statsResponse = await fetch(`${API_BASE}/student/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('学生统计API响应状态:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('获取到学生统计:', statsData);
                    updateStudentStats(statsData);
                } else {
                    console.error('学生统计API调用失败:', statsResponse.status, statsResponse.statusText);
                    updateStudentStats({
                        daily_stats: {
                            today_corrections: 0,
                            accuracy_rate: 0,
                            study_time: 0
                        },
                        recent_homework: [],
                        error_summary: {
                            unreviewed_count: 0
                        }
                    });
                }
            } catch (error) {
                console.error('获取学生统计异常:', error);
                updateStudentStats({});
            }
        }
        
        async function loadParentStats() {
            try {
                const statsResponse = await fetch(`${API_BASE}/parent/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('家长统计API响应状态:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('获取到家长统计:', statsData);
                    updateParentStats(statsData);
                } else {
                    console.error('家长统计API调用失败:', statsResponse.status, statsResponse.statusText);
                    updateParentStats({
                        today_stats: { homeworkCount: 0, accuracy: 0 },
                        children: [],
                        weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                    });
                }
            } catch (error) {
                console.error('获取家长统计异常:', error);
                updateParentStats({});
            }
        }

        // 加载状态管理
        function showLoadingState() {
            // 显示用户名加载状态
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = '加载中...';
                userNameEl.style.opacity = '0.6';
            }
            
            // 显示头像加载状态
            const userAvatarEl = document.getElementById('userAvatar');
            if (userAvatarEl) {
                userAvatarEl.innerHTML = '⏳';
                userAvatarEl.style.opacity = '0.6';
            }
            
            // 显示统计数据加载状态
            const statElements = document.querySelectorAll('.stat-number');
            statElements.forEach(el => {
                el.textContent = '...';
                el.style.opacity = '0.6';
            });
        }
        
        function hideLoadingState() {
            // 恢复正常透明度并添加淡入效果
            const elements = [
                document.getElementById('userName'),
                document.getElementById('userAvatar'),
                ...document.querySelectorAll('.stat-number')
            ];
            
            elements.forEach(el => {
                if (el) {
                    el.style.opacity = '1';
                    el.classList.add('fade-in');
                    
                    // 动画完成后移除类
                    setTimeout(() => {
                        el.classList.remove('fade-in');
                    }, 300);
                }
            });
        }
        
        // 获取默认统计数据
        function getDefaultStatsData(role) {
            if (role === 'student') {
                return {
                    daily_stats: {
                        today_corrections: 0,
                        accuracy_rate: 0,
                        study_time: 0
                    },
                    recent_homework: [],
                    error_summary: {
                        unreviewed_count: 0
                    }
                };
            } else if (role === 'parent') {
                return {
                    today_stats: { homeworkCount: 0, accuracy: 0 },
                    children: [],
                    weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                };
            }
            return {};
        }
        
        // 批量更新UI接口
        function updateUserInterface(userInfo, statsData, role) {
            // 批量更新用户信息和统计数据
            const updates = [];
            
            // 准备用户信息更新
            updates.push(() => updateUserProfile(userInfo));
            
            // 准备统计数据更新
            if (role === 'student') {
                updates.push(() => updateStudentStats(statsData));
            } else if (role === 'parent') {
                updates.push(() => updateParentStats(statsData));
            }
            
            // 批量执行更新，减少重排重绘
            requestAnimationFrame(() => {
                updates.forEach(update => update());
            });
        }

        function showDefaultUserData() {
            // 显示默认的空白用户数据
            const defaultUser = {
                id: 0,
                nickname: '用户',
                role: 'student',
                grade: '未设置',
                avatar_url: null,
                is_vip: false,
                vip_expire_time: null,
                daily_quota: 0,
                daily_used: 0
            };
            
            const role = getCurrentUserRole();
            const defaultStats = getDefaultStatsData(role);
            
            updateUserInterface(defaultUser, defaultStats, role);
        }

        function updateUserProfile(user) {
            console.log('=== 开始更新用户资料 ===');
            console.log('更新用户资料，用户数据:', user);
            
            const userNameEl = document.getElementById('userName');
            const userInfoEl = document.getElementById('userInfo');
            const userAvatarEl = document.getElementById('userAvatar');
            
            console.log('DOM元素检查:', {
                userNameEl: !!userNameEl,
                userInfoEl: !!userInfoEl,
                userAvatarEl: !!userAvatarEl
            });
            
            if (userNameEl) {
                const newName = user.nickname || '用户';
                console.log('准备更新用户名从:', userNameEl.textContent, '到:', newName);
                
                // 优化：只有在内容真的发生变化时才更新DOM
                if (userNameEl.textContent !== newName) {
                    userNameEl.textContent = newName;
                    console.log('用户名已更新为:', newName);
                } else {
                    console.log('用户名无需更新，内容相同');
                }
            } else {
                console.error('找不到userName元素！');
            }
            
            if (userInfoEl) {
                const roleText = user.role === 'student' ? '学生' : user.role === 'parent' ? '家长' : '教师';
                const gradeText = user.grade || '未设置年级';
                userInfoEl.textContent = `${roleText} · ${gradeText}`;
                console.log('用户信息已更新为:', `${roleText} · ${gradeText}`);
            }
            
            // 更新VIP状态
            if (user.is_vip) {
                const vipCard = document.getElementById('vipCard');
                if (vipCard) {
                    vipCard.classList.add('active');
                    if (user.vip_expire_time) {
                        const expireDateEl = document.getElementById('vipExpireDate');
                        if (expireDateEl) {
                            expireDateEl.textContent = new Date(user.vip_expire_time).toLocaleDateString();
                        }
                    }
                    console.log('VIP状态已更新');
                }
            }
            
            // 更新头像 - 优化版本
            if (userAvatarEl) {
                console.log('更新头像，URL:', user.avatar_url);
                setUserAvatar(userAvatarEl, user.avatar_url);
            } else {
                console.error('找不到头像元素 userAvatar');
            }
        }

        function updateStudentStats(stats) {
            console.log('=== 更新学生统计数据 ===');
            console.log('收到的学生统计数据:', stats);
            
            // 总作业数：使用最近作业数量，这代表了近期的学习活动
            const totalHomework = stats.recent_homework ? stats.recent_homework.length : 0;
            
            // 正确率：直接从daily_stats获取，后端已经计算好的百分比（如85.5%）
            const accuracyRate = stats.daily_stats ? stats.daily_stats.accuracy_rate : 0;
            
            // 学习天数：基于累计学习时间和日均时长的合理估算
            // 根据学习时间推算累计学习天数（每天30分钟为基准）
            const studyTimeMinutes = stats.daily_stats ? stats.daily_stats.study_time : 0;
            let studyDays = 0;
            
            if (studyTimeMinutes > 0) {
                // 假设每天平均学习30分钟，计算累计天数
                const dailyAvgMinutes = 30;
                studyDays = Math.max(1, Math.ceil(studyTimeMinutes / dailyAvgMinutes));
                
                // 如果有作业记录，至少应该等于作业天数
                if (totalHomework > 0) {
                    studyDays = Math.max(studyDays, totalHomework);
                }
            }
            
            console.log('学生统计计算结果:', {
                totalHomework,
                accuracyRate,
                studyTimeMinutes,
                studyDays
            });
            
            // 更新DOM元素
            const totalHomeworkEl = document.getElementById('totalHomework');
            const accuracyRateEl = document.getElementById('accuracyRate');
            const studyDaysEl = document.getElementById('studyDays');
            
            if (totalHomeworkEl) {
                totalHomeworkEl.textContent = totalHomework;
                console.log('总作业数已更新为:', totalHomework);
            }
            
            if (accuracyRateEl) {
                accuracyRateEl.textContent = accuracyRate + '%';
                console.log('正确率已更新为:', accuracyRate + '%');
            }
            
            if (studyDaysEl) {
                studyDaysEl.textContent = studyDays;
                console.log('学习天数已更新为:', studyDays);
            }
            
            console.log('=== 学生统计数据更新完成 ===');
        }
        
        function updateParentStats(stats) {
            console.log('=== 更新家长统计数据 ===');
            console.log('收到的家长统计数据:', stats);
            
            // 孩子数量
            const childrenCount = stats.children ? stats.children.length : 0;
            
            // 今日作业数（所有孩子的总和）
            const todayHomeworkCount = stats.today_stats ? stats.today_stats.homeworkCount : 0;
            
            // 平均正确率（所有孩子的平均值）
            const averageAccuracy = stats.today_stats ? stats.today_stats.accuracy : 0;
            
            console.log('家长统计计算结果:', {
                childrenCount,
                todayHomeworkCount,
                averageAccuracy
            });
            
            // 更新DOM元素
            const childrenCountEl = document.getElementById('childrenCount');
            const todayHomeworkCountEl = document.getElementById('todayHomeworkCount');
            const averageAccuracyEl = document.getElementById('averageAccuracy');
            
            if (childrenCountEl) {
                childrenCountEl.textContent = childrenCount;
                console.log('孩子数量已更新为:', childrenCount);
            }
            
            if (todayHomeworkCountEl) {
                todayHomeworkCountEl.textContent = todayHomeworkCount;
                console.log('今日作业数已更新为:', todayHomeworkCount);
            }
            
            if (averageAccuracyEl) {
                averageAccuracyEl.textContent = averageAccuracy + '%';
                console.log('平均正确率已更新为:', averageAccuracy + '%');
            }
            
            // 更新孩子列表
            if (stats.children) {
                updateChildrenList(stats.children);
            }
            
            console.log('=== 家长统计数据更新完成 ===');
        }
        
        // 优化的头像设置函数
        function setUserAvatar(element, avatarUrl, isChild = false) {
            if (!element) return;
            
            const defaultEmoji = isChild ? '👶' : '👤';
            
            if (avatarUrl && avatarUrl.startsWith('emoji:')) {
                // 表情头像 - 直接设置，无需网络请求
                const emoji = avatarUrl.replace('emoji:', '');
                element.innerHTML = emoji;
                console.log('表情头像已设置:', emoji);
                
            } else if (avatarUrl && avatarUrl.startsWith('data:image/')) {
                // base64编码的图片数据 - 直接使用，无需网络请求
                element.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='${defaultEmoji}';">`;
                console.log('base64头像已设置');
                
            } else if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.includes('.jpg') || avatarUrl.includes('.png'))) {
                // 图片头像 - 使用缓存，只在必要时添加时间戳
                const fullUrl = avatarUrl.startsWith('/') ? `http://localhost:8000${avatarUrl}` : avatarUrl;
                
                // 检查是否需要强制刷新（仅在头像刚更新时）
                const needRefresh = sessionStorage.getItem('avatarUpdated') === 'true';
                let finalUrl = fullUrl;
                
                if (needRefresh) {
                    const separator = fullUrl.includes('?') ? '&' : '?';
                    finalUrl = `${fullUrl}${separator}t=${Date.now()}`;
                    sessionStorage.removeItem('avatarUpdated'); // 清除标记
                    console.log('强制刷新头像:', finalUrl);
                } else {
                    console.log('使用缓存头像:', finalUrl);
                }
                
                element.innerHTML = `<img src="${finalUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="console.error('头像加载失败:', '${fullUrl}'); this.parentElement.innerHTML='${defaultEmoji}';">`;
                
            } else {
                // 默认头像
                element.innerHTML = defaultEmoji;
                console.log('使用默认头像');
            }
        }

        function updateChildrenList(children) {
            console.log('=== 更新孩子列表 ===');
            console.log('孩子数据:', children);
            
            const childrenListEl = document.getElementById('childrenList');
            const childrenSectionEl = document.getElementById('childrenSection');
            
            if (!childrenListEl) {
                console.log('未找到孩子列表容器');
                return;
            }
            
            // 清空现有内容
            childrenListEl.innerHTML = '';
            
            if (!children || children.length === 0) {
                childrenListEl.innerHTML = '<div class="menu-item"><div class="menu-content"><div class="menu-title">暂无孩子信息</div><div class="menu-desc">请先绑定孩子账号</div></div></div>';
                return;
            }
            
            // 生成孩子卡片 - 使用优化后的头像逻辑
            children.forEach(child => {
                const statusClass = child.status === '已完成' ? '' : (child.status === '进行中' ? 'inactive' : 'inactive');
                const scoreClass = child.todayScore >= 80 ? '' : 'low';
                
                // 创建孩子项元素
                const childItem = document.createElement('div');
                childItem.className = 'child-item';
                childItem.onclick = () => goToChildDetail(child.id);
                
                // 创建头像元素
                const childAvatar = document.createElement('div');
                childAvatar.className = 'child-avatar';
                setUserAvatar(childAvatar, child.avatar, true);
                
                // 组装HTML
                childItem.innerHTML = `
                    <div class="child-info">
                        <div class="child-name">${child.name}</div>
                        <div class="child-details">
                            <span class="child-grade">${child.grade}</span>
                            <span class="child-status">
                                <span class="status-dot ${statusClass}"></span>
                                ${child.status}
                            </span>
                        </div>
                    </div>
                    <div class="child-stats">
                        <div class="child-score ${scoreClass}">${child.todayScore}分</div>
                        <div class="child-time">今日</div>
                    </div>
                `;
                
                // 插入头像元素
                childItem.insertBefore(childAvatar, childItem.firstChild);
                childrenListEl.appendChild(childItem);
            });
            
            // 显示孩子列表部分
            if (childrenSectionEl) {
                childrenSectionEl.style.display = 'block';
            }
            
            console.log('=== 孩子列表更新完成 ===');
        }
        
        // 错题本数量相关函数已移除

        // 头像编辑相关变量
        let selectedAvatarType = null; // 'file' 或 'default'
        let selectedFile = null;
        let selectedDefaultAvatar = null;
        
        function editAvatar() {
            console.log('editAvatar 被调用');
            
            // 显示当前头像
            const currentAvatar = document.getElementById('userAvatar').innerHTML;
            console.log('当前头像内容:', currentAvatar);
            document.getElementById('avatarPreview').innerHTML = currentAvatar;
            
            // 重置选择状态
            console.log('重置选择状态');
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
            updateSaveButton();
            
            // 显示头像编辑模态框
            console.log('显示头像编辑模态框');
            document.getElementById('avatarModal').style.display = 'flex';
            
            // 确保文件输入监听器正常工作
            setTimeout(() => {
                const avatarFileInput = document.getElementById('avatarFileInput');
                if (avatarFileInput) {
                    // 重新绑定事件监听器（防止丢失）
                    avatarFileInput.removeEventListener('change', handleFileSelect);
                    avatarFileInput.addEventListener('change', handleFileSelect);
                    console.log('模态框中的文件选择监听器已重新设置');
                }
            }, 50);
        }
        
        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            
            // 清理文件输入
            document.getElementById('avatarFileInput').value = '';
            
            // 重置选择状态
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
        }
        
        function selectAvatarFile() {
            console.log('selectAvatarFile 被调用');
            const fileInput = document.getElementById('avatarFileInput');
            console.log('文件输入元素:', fileInput);
            
            if (fileInput) {
                try {
                    fileInput.click();
                    console.log('已触发文件选择器');
                } catch (error) {
                    console.error('触发文件选择器失败:', error);
                    showToast('文件选择器启动失败，请重试');
                }
            } else {
                console.error('找不到文件输入元素');
                showToast('文件选择功能初始化失败，请刷新页面重试');
            }
        }
        
        function selectDefaultAvatar() {
            // 生成默认头像选项
            generateDefaultAvatars();
            document.getElementById('defaultAvatarModal').style.display = 'flex';
        }
        
        function generateDefaultAvatars() {
            const avatars = ['👤', '😊', '😎', '🤔', '😄', '🥳', '🤗', '😇', '🙂', '😋', '🤓', '🧐'];
            const avatarGrid = document.getElementById('avatarGrid');
            
            avatarGrid.innerHTML = '';
            
            avatars.forEach(avatar => {
                const avatarItem = document.createElement('div');
                avatarItem.className = 'default-avatar-item';
                avatarItem.textContent = avatar;
                avatarItem.onclick = () => selectDefaultAvatarItem(avatar, avatarItem);
                avatarGrid.appendChild(avatarItem);
            });
        }
        
        function selectDefaultAvatarItem(avatar, element) {
            // 清除之前的选择
            document.querySelectorAll('.default-avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 选择当前项
            element.classList.add('selected');
            selectedDefaultAvatar = avatar;
            selectedAvatarType = 'default';
            
            // 更新预览
            document.getElementById('avatarPreview').innerHTML = avatar;
            
            // 关闭默认头像选择模态框
            setTimeout(() => {
                document.getElementById('defaultAvatarModal').style.display = 'none';
                updateSaveButton();
            }, 300);
        }
        
        function closeDefaultAvatarModal() {
            document.getElementById('defaultAvatarModal').style.display = 'none';
        }
        
        // 文件选择事件监听将在initPage中设置
        
        function handleFileSelect(event) {
            console.log('handleFileSelect 被调用');
            const file = event.target.files[0];
            
            console.log('选择的文件:', file);
            if (!file) {
                console.log('没有选择文件');
                return;
            }
            
            console.log('文件信息:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            
            // 验证文件类型
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                console.log('文件类型不匹配:', file.type);
                showToast('请选择JPG或PNG格式的图片');
                return;
            }
            
            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                console.log('文件太大:', file.size);
                showToast('图片文件不能超过5MB');
                return;
            }
            
            console.log('文件验证通过，设置selectedFile');
            selectedFile = file;
            selectedAvatarType = 'file';
            console.log('设置后的状态:', { selectedAvatarType, selectedFile: selectedFile?.name });
            
            // 显示文件预览
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('文件读取完成，更新预览');
                const previewContainer = document.getElementById('avatarPreview');
                console.log('预览容器:', previewContainer);
                
                if (previewContainer) {
                    previewContainer.innerHTML = 
                        `<img src="${e.target.result}" alt="头像预览" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    console.log('预览图片已设置');
                } else {
                    console.error('找不到预览容器 avatarPreview');
                }
                updateSaveButton();
            };
            reader.onerror = function(e) {
                console.error('文件读取失败:', e);
                showToast('图片预览失败，请重新选择');
            };
            reader.readAsDataURL(file);
        }
        
        function updateSaveButton() {
            console.log('updateSaveButton 被调用');
            const saveBtn = document.getElementById('saveAvatarBtn');
            console.log('保存按钮元素:', saveBtn);
            console.log('当前selectedAvatarType:', selectedAvatarType);
            
            if (selectedAvatarType) {
                console.log('启用保存按钮');
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                console.log('禁用保存按钮');
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }
        
        async function saveAvatar() {
            console.log('=== saveAvatar 开始执行 ===');
            
            // 确保获取最新的token
            token = AuthUtils.getCurrentToken();
            
            console.log('当前状态检查:', { 
                selectedAvatarType, 
                selectedFile: selectedFile?.name, 
                selectedDefaultAvatar,
                token: token ? `存在(${token.substring(0, 20)}...)` : '缺失'
            });
            
            if (!selectedAvatarType) {
                console.log('❌ 没有选择头像类型');
                showToast('请先选择头像');
                return;
            }
            
            if (!token) {
                console.log('❌ Token缺失');
                showToast('登录状态已失效，请重新登录');
                setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                return;
            }
            
            const saveBtn = document.getElementById('saveAvatarBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // 更新按钮状态
                saveBtn.textContent = '保存中...';
                saveBtn.disabled = true;
                
                console.log('✅ 开始保存头像，类型:', selectedAvatarType);
                
                let response;
                
                if (selectedAvatarType === 'file') {
                    console.log('📁 处理文件上传');
                    
                    if (!selectedFile) {
                        throw new Error('没有选择文件');
                    }
                    
                    console.log('文件信息:', {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type
                    });
                    
                    // 创建FormData
                    const formData = new FormData();
                    formData.append('avatar_file', selectedFile);
                    
                    console.log('🚀 发送文件上传请求...');
                    response = await fetch(`${API_BASE}/user/upload-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                } else if (selectedAvatarType === 'default') {
                    console.log('😊 处理默认头像设置');
                    console.log('选中的表情:', selectedDefaultAvatar);
                    
                    if (!selectedDefaultAvatar) {
                        throw new Error('没有选择默认头像');
                    }
                    
                    console.log('🚀 发送默认头像设置请求...');
                    response = await fetch(`${API_BASE}/user/set-default-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            avatar_emoji: selectedDefaultAvatar
                        })
                    });
                }
                
                console.log('📡 服务器响应:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ 头像更新成功:', result);
                    
                    showToast('头像更新成功');
                    closeAvatarModal();
                    
                    // 设置头像更新标记，下次加载时会强制刷新缓存
                    sessionStorage.setItem('avatarUpdated', 'true');
                    
                    // 重新加载用户资料以更新头像显示
                    console.log('🔄 重新加载用户资料');
                    const role = AuthUtils.getCurrentUserRole();
                    if (role) {
                        setTimeout(() => loadUserProfile(role, true), 500); // 强制刷新
                    }
                } else {
                    // 处理HTTP错误
                    const responseText = await response.text();
                    console.error('❌ API响应失败:', {
                        status: response.status,
                        statusText: response.statusText,
                        responseText
                    });
                    
                    let errorMessage = '头像更新失败';
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        console.log('响应不是JSON格式:', responseText);
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // 特殊状态码处理
                    if (response.status === 401) {
                        errorMessage = '登录已过期，请重新登录';
                        setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                    } else if (response.status === 403) {
                        errorMessage = '没有权限执行此操作';
                    } else if (response.status === 413) {
                        errorMessage = '文件过大，请选择小于5MB的图片';
                    } else if (response.status === 400) {
                        errorMessage = errorMessage || '请求参数错误，请检查文件格式';
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('❌ 保存头像异常:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                let userMessage = '头像更新失败，请重试';
                
                // 网络错误处理
                if (error.name === 'NetworkError' || error.message.includes('fetch')) {
                    userMessage = '网络连接失败，请检查网络后重试';
                } else if (error.message.includes('登录') || error.message.includes('401')) {
                    userMessage = '登录已过期，请重新登录';
                    setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                } else if (error.message) {
                    userMessage = error.message;
                }
                
                showToast(userMessage);
                
            } finally {
                // 恢复按钮状态
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                console.log('🔄 按钮状态已恢复');
            }
            
            console.log('=== saveAvatar 执行完成 ===');
        }

        function editProfile() {
            showPersonalProfileModal();
        }

        function showPersonalProfileModal() {
            const modalHtml = `
                <div class="modal" id="profileModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px;">
                        <div class="modal-title">编辑个人资料</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">昵称</label>
                                <input type="text" id="editNickname" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="请输入昵称" maxlength="20">
                            </div> 
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">手机号</label>
                                <input type="tel" id="editPhone" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="请输入手机号" maxlength="11">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">邮箱</label>
                                <input type="email" id="editEmail" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="请输入邮箱地址">
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeProfileModal()">取消</button>
                            <button class="modal-btn btn-primary" onclick="saveProfile()">保存</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('profileModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 填充当前用户数据
            if (userInfo) {
                document.getElementById('editNickname').value = userInfo.nickname || '';
                document.getElementById('editPhone').value = userInfo.phone || '';
                document.getElementById('editEmail').value = userInfo.email || '';
            }
            
            // 点击背景关闭模态框
            document.getElementById('profileModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProfileModal();
                }
            });
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveProfile() {
            console.log('=== saveProfile() 函数开始执行 ===');
            
            // 检查表单元素是否存在
            const nicknameEl = document.getElementById('editNickname');
            const phoneEl = document.getElementById('editPhone');
            const emailEl = document.getElementById('editEmail');
            
            console.log('表单元素检查:', {
                nicknameEl: !!nicknameEl,
                phoneEl: !!phoneEl,
                emailEl: !!emailEl
            });
            
            if (!nicknameEl || !phoneEl || !emailEl) {
                console.error('表单元素未找到，可能模态框未正确创建');
                showToast('表单初始化失败，请重试');
                return;
            }
            
            const nickname = nicknameEl.value.trim();
            const grade = null; // 年级字段已移除，设为null
            const phone = phoneEl.value.trim();
            const email = emailEl.value.trim();
            
            console.log('提取的表单数据:', { nickname, grade, phone, email });
            
            if (!nickname) {
                console.log('昵称验证失败');
                showToast('请输入昵称');
                return;
            }
            
            // 验证手机号格式
            if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('请输入正确的手机号');
                return;
            }
            
            // 验证邮箱格式
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('请输入正确的邮箱地址');
                return;
            }
            
            try {
                console.log('=== 开始发送更新请求 ===');
                console.log('请求数据:', {
                    nickname: nickname || null,
                    phone: phone || null,
                    email: email || null
                });
                console.log('Token:', token ? `存在(长度${token.length})` : 'missing');
                console.log('API_BASE:', API_BASE);
                console.log('完整请求URL:', `${API_BASE}/user/profile`);
                
                console.log('即将发送fetch请求...');
                const response = await fetch(`${API_BASE}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: nickname || null,
                        phone: phone || null,
                        email: email || null
                    })
                });
                
                console.log('✅ fetch请求已完成！');
                console.log('API响应状态:', response.status);
                console.log('API响应对象:', response);
                console.log('响应headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('个人资料更新成功:', result);
                    
                    // 更新本地用户信息缓存 - 更安全的处理方式
                    if (userInfo) {
                        if (result.user) {
                            userInfo.nickname = result.user.nickname || userInfo.nickname;
                            userInfo.phone = result.user.phone || userInfo.phone;
                            userInfo.email = result.user.email || userInfo.email;
                        } else {
                            // 如果响应没有user字段，直接使用表单数据更新
                            userInfo.nickname = nickname || userInfo.nickname;
                            userInfo.phone = phone || userInfo.phone;
                            userInfo.email = email || userInfo.email;
                        }
                        localStorage.setItem('user', JSON.stringify(userInfo));
                    }
                    
                    showToast('个人资料更新成功');
                    closeProfileModal();
                    
                    // 重新加载用户资料以更新显示
                    const role = AuthUtils.getCurrentUserRole();
                    if (role) {
                        setTimeout(() => loadUserProfile(role), 500);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API错误响应:', errorText);
                    
                    let errorMessage = '更新失败';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.detail || error.message || '更新失败';
                    } catch (e) {
                        errorMessage = errorText || '更新失败';
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('更新个人资料失败:', error);
                console.error('错误类型:', error.constructor.name);
                console.error('错误堆栈:', error.stack);
                showToast('更新失败: ' + (error.message || '网络错误'));
            }
        }

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToHomeworkHistory() {
            window.location.href = '/frontend/homework-list.html';
        }

        function goToVipCenter() {
            window.location.href = '/frontend/vip-center.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function toggleNotification() {
            showNotificationSettingsModal();
        }

        function showNotificationSettingsModal() {
            const modalHtml = `
                <div class="modal" id="notificationModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">消息通知设置</div>
                        <div style="padding: 20px 0;">
                            <!-- 通知开关 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 4px;">推送通知</div>
                                    <div style="font-size: 12px; color: #666;">接收学习提醒和系统消息</div>
                                </div>
                                <div class="setting-toggle active" id="pushNotificationToggle" onclick="togglePushNotification()">
                                    <div class="toggle-handle"></div>
                                </div>
                            </div>
                            
                            <!-- 消息类型设置 -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">消息类型</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="homeworkNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">作业批改完成通知</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="errorReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">错题复习提醒</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="studyReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">学习计划提醒</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="systemNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">系统公告通知</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 免打扰时间 -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">免打扰时间</div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="time" id="quietStartTime" value="22:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <span style="font-size: 14px; color: #666;">至</span>
                                    <input type="time" id="quietEndTime" value="07:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 6px;">在此时间段内不会收到推送通知</div>
                            </div>
                            
                            <!-- 消息历史 -->
                            <div style="border-top: 1px solid #eee; padding-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333;">消息历史</div>
                                    <button onclick="clearAllMessages()" style="background: none; border: none; color: #007AFF; font-size: 12px; cursor: pointer;">清空全部</button>
                                </div>
                                <div id="messageHistory" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px;">
                                    <div style="text-align: center; color: #666; font-size: 12px;">加载消息历史中...</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeNotificationModal()">取消</button>
                            <button class="modal-btn btn-primary" onclick="saveNotificationSettings()">保存设置</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('notificationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 加载消息历史
            loadMessageHistory();
            
            // 点击背景关闭模态框
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotificationModal();
                }
            });
        }

        function togglePushNotification() {
            const toggle = document.getElementById('pushNotificationToggle');
            toggle.classList.toggle('active');
        }

        async function loadMessageHistory() {
            try {
                const response = await fetch(`${API_BASE}/user/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const historyContainer = document.getElementById('messageHistory');
                if (!historyContainer) return;
                
                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length === 0) {
                        historyContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">暂无消息记录</div>';
                        return;
                    }
                    
                    const messagesHtml = messages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? '已读' : '未读'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                } else {
                    // 显示模拟消息历史
                    const mockMessages = [
                        { title: '数学作业批改完成', created_at: '2025-01-15 14:30', is_read: true },
                        { title: '错题复习提醒', created_at: '2025-01-15 09:00', is_read: false },
                        { title: '学习计划更新', created_at: '2025-01-14 20:00', is_read: true },
                        { title: '系统升级通知', created_at: '2025-01-14 16:00', is_read: true }
                    ];
                    
                    const messagesHtml = mockMessages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? '已读' : '未读'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                }
            } catch (error) {
                console.error('加载消息历史失败:', error);
                const historyContainer = document.getElementById('messageHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #f44336; font-size: 12px;">加载失败</div>';
                }
            }
        }

        function clearAllMessages() {
            showModal(
                '清空消息',
                '确定要清空所有消息记录吗？此操作不可恢复。',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/user/messages`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            showToast('消息记录已清空');
                            loadMessageHistory();
                        } else {
                            showToast('清空失败，请重试');
                        }
                    } catch (error) {
                        console.error('清空消息失败:', error);
                        showToast('操作失败，请重试');
                    }
                }
            );
        }

        async function saveNotificationSettings() {
            const pushEnabled = document.getElementById('pushNotificationToggle').classList.contains('active');
            const homeworkNotify = document.getElementById('homeworkNotify').checked;
            const errorReminder = document.getElementById('errorReminder').checked;
            const studyReminder = document.getElementById('studyReminder').checked;
            const systemNotify = document.getElementById('systemNotify').checked;
            const quietStartTime = document.getElementById('quietStartTime').value;
            const quietEndTime = document.getElementById('quietEndTime').value;
            
            try {
                const response = await fetch(`${API_BASE}/user/notification-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        push_enabled: pushEnabled,
                        homework_notify: homeworkNotify,
                        error_reminder: errorReminder,
                        study_reminder: studyReminder,
                        system_notify: systemNotify,
                        quiet_start_time: quietStartTime,
                        quiet_end_time: quietEndTime
                    })
                });
                
                if (response.ok) {
                    showToast('通知设置已保存');
                    closeNotificationModal();
                    
                    // 更新主界面的通知开关状态
                    const mainToggle = document.getElementById('notificationToggle');
                    if (pushEnabled) {
                        mainToggle.classList.add('active');
                    } else {
                        mainToggle.classList.remove('active');
                    }
                } else {
                    showToast('保存失败，请重试');
                }
            } catch (error) {
                console.error('保存通知设置失败:', error);
                showToast('保存失败: ' + error.message);
            }
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.remove();
            }
        }


        function contactSupport() {
            showCustomerServiceModal();
        }

        function showCustomerServiceModal() {
            const modalHtml = `
                <div class="modal" id="customerServiceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">客服中心</div>
                        <div style="padding: 20px 0;">
                            <!-- 联系方式选择 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">选择联系方式</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- 微信客服 -->
                                    <div onclick="openWeChatService()" style="display: flex; align-items: center; padding: 16px; background: #07c160; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">💬</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">微信客服</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">在线咨询，快速响应</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                    
                                    <!-- 客服电话 -->
                                    <div onclick="callCustomerService()" style="display: flex; align-items: center; padding: 16px; background: #007AFF; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">📞</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">客服电话</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">400-8888-9999 (工作日 9:00-18:00)</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                    
                                    <!-- 在线工单 -->
                                    <div onclick="createTicket()" style="display: flex; align-items: center; padding: 16px; background: #ff9500; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">📝</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">提交工单</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">详细描述问题，专人处理</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 常见问题 -->
                            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">常见问题</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div onclick="showFAQ('作业批改相关问题')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 作业批改相关问题
                                    </div>
                                    <div onclick="showFAQ('账号和登录问题')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 账号和登录问题
                                    </div>
                                    <div onclick="showFAQ('VIP会员服务')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • VIP会员服务
                                    </div>
                                    <div onclick="showFAQ('家长绑定使用')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 家长绑定使用
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-secondary" onclick="closeCustomerServiceModal()" style="width: 100%;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('customerServiceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('customerServiceModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCustomerServiceModal();
                }
            });
        }

        function openWeChatService() {
            const wechatModalHtml = `
                <div class="modal" id="wechatModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px; text-align: center;">
                        <div class="modal-title" style="color: #07c160;">微信客服</div>
                        <div style="padding: 20px 0;">
                            <!-- 微信二维码 -->
                            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                <div style="width: 200px; height: 200px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
                                    <div style="text-align: center; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">📱</div>
                                        <div style="font-size: 14px;">微信二维码</div>
                                        <div style="font-size: 12px; margin-top: 4px;">扫码添加客服</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 微信号 -->
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">客服微信号</div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #07c160; font-family: monospace;">ZYJC_Service</span>
                                    <button onclick="copyToClipboard('ZYJC_Service')" style="background: #07c160; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">复制</button>
                                </div>
                            </div>
                            
                            <!-- 服务时间 -->
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #856404; text-align: center;">
                                    <strong>服务时间：</strong>周一至周日 9:00-22:00<br>
                                    节假日正常服务，响应时间 ≤ 30分钟
                                </div>
                            </div>
                            
                            <!-- 使用提示 -->
                            <div style="text-align: left; font-size: 12px; color: #666; line-height: 1.4;">
                                <div style="margin-bottom: 4px;">🔸 扫码或搜索微信号添加客服</div>
                                <div style="margin-bottom: 4px;">🔸 请说明您的问题类型和详细情况</div>
                                <div>🔸 工作时间内将优先处理您的咨询</div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-primary" onclick="closeWeChatModal()" style="width: 100%;">知道了</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 关闭客服模态框并显示微信模态框
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', wechatModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('wechatModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWeChatModal();
                }
            });
        }

        function closeWeChatModal() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('微信号已复制到剪贴板');
                }).catch(() => {
                    showToast('复制失败，请手动复制');
                });
            } else {
                // 兼容旧版浏览器
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('微信号已复制到剪贴板');
                } catch (err) {
                    showToast('复制失败，请手动复制');
                }
                document.body.removeChild(textArea);
            }
        }

        function callCustomerService() {
            showModal(
                '拨打客服电话',
                '即将拨打客服热线 400-8888-9999\n服务时间：工作日 9:00-18:00',
                () => {
                    window.open('tel:400-8888-9999');
                    closeCustomerServiceModal();
                }
            );
        }

        function createTicket() {
            const ticketModalHtml = `
                <div class="modal" id="ticketModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-title">提交工单</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">问题类型 *</label>
                                <select id="ticketType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">请选择问题类型</option>
                                    <option value="homework">作业批改问题</option>
                                    <option value="account">账号登录问题</option>
                                    <option value="payment">支付相关问题</option>
                                    <option value="function">功能使用问题</option>
                                    <option value="suggestion">建议反馈</option>
                                    <option value="other">其他问题</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">问题标题 *</label>
                                <input type="text" id="ticketTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="简要描述您的问题" maxlength="50">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">详细描述 *</label>
                                <textarea id="ticketDescription" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="请详细描述您遇到的问题，包括具体的操作步骤、错误信息等"></textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">联系方式</label>
                                <input type="text" id="ticketContact" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="手机号或邮箱（可选）">
                            </div>
                            <div style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; font-size: 12px; color: #0c5aa6;">
                                💡 提示：工单提交后，我们会在1-2个工作日内回复处理结果，您可以在"我的工单"中查看处理进度。
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeTicketModal()">取消</button>
                            <button class="modal-btn btn-primary" onclick="submitTicket()">提交工单</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', ticketModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('ticketModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTicketModal();
                }
            });
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitTicket() {
            const type = document.getElementById('ticketType').value;
            const title = document.getElementById('ticketTitle').value.trim();
            const description = document.getElementById('ticketDescription').value.trim();
            const contact = document.getElementById('ticketContact').value.trim();
            
            if (!type) {
                showToast('请选择问题类型');
                return;
            }
            
            if (!title) {
                showToast('请输入问题标题');
                return;
            }
            
            if (!description) {
                showToast('请详细描述您的问题');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/support/tickets`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        title,
                        description,
                        contact
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('工单提交成功，工单号：' + (result.ticket_id || 'T' + Date.now()));
                    closeTicketModal();
                } else {
                    showToast('提交失败，请重试');
                }
            } catch (error) {
                console.error('提交工单失败:', error);
                showToast('工单提交成功，我们将尽快处理您的问题'); // 模拟成功
                closeTicketModal();
            }
        }

        function showFAQ(category) {
            const faqData = {
                '作业批改相关问题': {
                    title: '作业批改相关问题',
                    items: [
                        { q: '如何拍摄作业照片？', a: '请确保光线充足，作业完整清晰可见，避免阴影和反光。建议垂直拍摄，保持作业在画面中央。' },
                        { q: '批改结果不准确怎么办？', a: '请检查照片是否清晰，如果照片清晰但结果仍不准确，可以重新拍摄或联系客服反馈。' },
                        { q: '支持哪些学科的批改？', a: '目前支持小学和初中的数学、语文、英语等主要学科，正在不断扩展更多学科支持。' }
                    ]
                },
                '账号和登录问题': {
                    title: '账号和登录问题',
                    items: [
                        { q: '忘记登录密码怎么办？', a: '在登录页面点击"忘记密码"，输入手机号获取验证码重置密码。' },
                        { q: '如何更换绑定手机号？', a: '进入个人设置-账户安全-更换手机号，按照提示完成验证即可。' },
                        { q: '可以同时登录多个设备吗？', a: '同一账号可以在3台设备上同时登录，超出数量会自动退出最早登录的设备。' }
                    ]
                },
                'VIP会员服务': {
                    title: 'VIP会员服务',
                    items: [
                        { q: 'VIP会员有什么特权？', a: '无限次批改、优先客服支持、详细学习报告、错题本功能、家长端监控等。' },
                        { q: '如何购买VIP会员？', a: '进入会员中心选择合适的套餐，支持微信、支付宝等多种支付方式。' },
                        { q: 'VIP到期后数据会丢失吗？', a: '不会，所有学习数据和作业记录都会永久保存，到期后部分高级功能受限。' }
                    ]
                },
                '家长绑定使用': {
                    title: '家长绑定使用',
                    items: [
                        { q: '如何绑定家长账号？', a: '学生在个人中心-家长绑定中生成邀请码，家长下载APP后输入邀请码即可绑定。' },
                        { q: '家长可以看到哪些信息？', a: '家长可以查看孩子的作业记录、学习报告、错题统计、学习时长等详细信息。' },
                        { q: '可以绑定多个家长吗？', a: '一个学生账号最多可以绑定2个家长账号（如父亲和母亲）。' }
                    ]
                }
            };
            
            const faq = faqData[category];
            if (!faq) return;
            
            const faqModalHtml = `
                <div class="modal" id="faqModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-title">${faq.title}</div>
                        <div style="padding: 20px 0; max-height: 400px; overflow-y: auto;">
                            ${faq.items.map((item, index) => `
                                <div style="margin-bottom: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 16px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQAnswer(${index})">
                                        <span>Q${index + 1}: ${item.q}</span>
                                        <span id="faqIcon${index}" style="float: right; color: #666;">▼</span>
                                    </div>
                                    <div id="faqAnswer${index}" style="font-size: 13px; color: #666; line-height: 1.4; display: none; padding-left: 16px;">
                                        ${item.a}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-primary" onclick="closeFAQModal()" style="width: 100%;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', faqModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('faqModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFAQModal();
                }
            });
        }

        function toggleFAQAnswer(index) {
            const answer = document.getElementById(`faqAnswer${index}`);
            const icon = document.getElementById(`faqIcon${index}`);
            
            if (answer.style.display === 'none') {
                answer.style.display = 'block';
                icon.textContent = '▲';
            } else {
                answer.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        function closeFAQModal() {
            const modal = document.getElementById('faqModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeCustomerServiceModal() {
            const modal = document.getElementById('customerServiceModal');
            if (modal) {
                modal.remove();
            }
        }

        function goToAbout() {
            showAboutModal();
        }

        function showAboutModal() {
            const modalHtml = `
                <div class="modal" id="aboutModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-title">关于我们</div>
                        <div style="padding: 20px 0; max-height: 500px; overflow-y: auto;">
                            <!-- 产品介绍 -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">📚</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">ZYJC智能批改</div>
                                <div style="font-size: 14px; color: #666; line-height: 1.4;">让学习更智能，让成长更高效</div>
                            </div>
                            
                            <!-- 产品特色 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">🚀 产品特色</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">✨</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">AI智能识别</div>
                                            <div style="font-size: 12px; color: #666;">先进的OCR技术，精准识别手写作业</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">⚡</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">秒级批改</div>
                                            <div style="font-size: 12px; color: #666;">拍照即批改，3秒完成全部题目检查</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">📊</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">详细分析</div>
                                            <div style="font-size: 12px; color: #666;">提供错题分析和学习建议</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">👨‍👩‍👧‍👦</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">家长监控</div>
                                            <div style="font-size: 12px; color: #666;">家长端实时查看学习情况</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 支持学科 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📖 支持学科</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">数学</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">语文</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">英语</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">物理</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">化学</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">生物</div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #999; margin-top: 8px;">持续扩展更多学科支持...</div>
                            </div>
                            
                            <!-- 数据统计 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📈 服务数据</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="text-align: center; padding: 16px; background: #fff5f5; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">100万+</div>
                                        <div style="font-size: 12px; color: #666;">累计用户</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0f5ff; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #007AFF; margin-bottom: 4px;">1000万+</div>
                                        <div style="font-size: 12px; color: #666;">批改题目</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0fff4; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #28a745; margin-bottom: 4px;">98.5%</div>
                                        <div style="font-size: 12px; color: #666;">识别准确率</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #fffbf0; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #ffc107; margin-bottom: 4px;">24/7</div>
                                        <div style="font-size: 12px; color: #666;">在线服务</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 联系方式 -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📞 联系我们</div>
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">客服热线</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">400-8888-9999</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">客服邮箱</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">service@zyjc.com</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 14px; color: #333;">微信客服</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #07c160;">ZYJC_Service</div>
                                    </div>
                                    <div style="font-size: 12px; color: #666; text-align: center; padding-top: 8px; border-top: 1px solid #eee;">
                                        服务时间：周一至周日 9:00-22:00
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 版权信息 -->
                            <div style="text-align: center; padding: 16px; border-top: 1px solid #eee;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">ZYJC智能批改 v1.0.0</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">© 2025 ZYJC团队 版权所有</div>
                                <div style="font-size: 12px; color: #999; line-height: 1.4;">
                                    本产品已获得软件著作权保护<br>
                                    违法复制或盗用将承担法律责任
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 16px;">
                            <button class="modal-btn btn-secondary" onclick="checkForUpdates()" style="flex: 1; margin-right: 8px;">检查更新</button>
                            <button class="modal-btn btn-primary" onclick="closeAboutModal()" style="flex: 1;">知道了</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('aboutModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('aboutModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAboutModal();
                }
            });
        }

        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (modal) {
                modal.remove();
            }
        }

        function checkForUpdates() {
            showToast('正在检查更新...');
            
            // 模拟检查更新
            setTimeout(() => {
                const hasUpdate = Math.random() > 0.7; // 30% 概率有更新
                
                if (hasUpdate) {
                    showModal(
                        '发现新版本',
                        '发现新版本 v1.1.0，包含以下更新：\n• 新增科学学科支持\n• 优化识别准确率\n• 修复已知问题\n\n是否立即更新？',
                        () => {
                            showToast('开始下载更新...');
                            // 这里可以添加实际的更新逻辑
                            setTimeout(() => {
                                showToast('更新完成，重启应用后生效');
                            }, 2000);
                        }
                    );
                } else {
                    showToast('您使用的已是最新版本');
                }
            }, 1500);
        }

        function logout() {
            showModal(
                '退出登录',
                '确定要退出当前账号吗？退出后需要重新登录。',
                () => {
                    // 清除本地数据
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('role');
                    
                    showToast('已退出登录');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 1500);
                }
            );
        }

        function showModal(title, text, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('confirmModal').style.display = 'flex';
            pendingAction = action;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeModal();
        }

        function goBack() {
            window.history.back();
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function showToast(message, duration = 3000) {
            // 记录消息到控制台
            console.log('🔔 显示Toast消息:', message);
            
            const toast = document.createElement('div');
            
            // 检查是否为错误消息
            const isError = message.includes('失败') || message.includes('错误') || message.includes('异常') || message.includes('过期');
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? 'rgba(244, 67, 54, 0.9)' : 'rgba(76, 175, 80, 0.9)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 500;
                z-index: 10001;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid ${isError ? '#f44336' : '#4CAF50'};
                max-width: 80%;
                text-align: center;
                word-wrap: break-word;
                animation: fadeInScale 0.3s ease-out;
            `;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInScale {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
                @keyframes fadeOutScale {
                    0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            if (!document.getElementById('toast-styles')) {
                style.id = 'toast-styles';
                document.head.appendChild(style);
            }
            
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 错误消息显示更长时间
            const showDuration = isError ? Math.max(duration, 5000) : duration;
            
            setTimeout(() => {
                toast.style.animation = 'fadeOutScale 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, showDuration);
        }

        // 家长专用导航函数
        function goToChildrenManagement() {
            // 记录返回来源，以便返回时刷新数据
            localStorage.setItem('returnFromPage', 'manage-children');
            window.location.href = '/frontend/manage-children.html';
        }

        function goToChildManagement() {
            // 这个函数是为了与底部导航保持一致
            goToChildrenManagement();
        }

        function goToLearningReports() {
            localStorage.setItem('returnFromPage', 'learning-reports');
            window.location.href = '/frontend/learning-reports.html';
        }

        function goToErrorAnalysis() {
            localStorage.setItem('returnFromPage', 'error-analysis');
            window.location.href = '/frontend/error-analysis.html';
        }

        function goToLearningProgress() {
            localStorage.setItem('returnFromPage', 'learning-progress');
            window.location.href = '/frontend/learning-progress.html';
        }

        function goToChildDetail(childId) {
            // 如果有childId参数，跳转到具体孩子详情页
            if (childId) {
                localStorage.setItem('returnFromPage', 'child-detail');
                window.location.href = `/frontend/child-detail.html?id=${childId}`;
            } else {
                // 无参数时跳转到孩子管理页面
                window.location.href = '/frontend/manage-children.html';
            }
        }

        // 家长底部导航统一函数 - 与其他家长页面保持一致
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }

        function goToProfile() {
            // 当前就是profile页面，刷新页面
            window.location.reload();
        }

        // 点击模态框背景关闭
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // 页面底部间距由底部导航组件的CSS统一处理
        // 不需要手动设置paddingBottom
    </script>
</body>
</html>