<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYJC智能批改 - 个人中心</title>
    <link rel="stylesheet" href="/frontend/css/modern-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            padding: 10px 20px 20px;
            color: white;
            position: relative;
        }
        
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* 用户信息卡片 */
        .user-header {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        
        
        
        
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .user-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
        }
        
        .stat-item {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 6px;
            line-height: 1.2;
            color: #26a69a;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
        }
        
        /* 页面内容 */
        .page-content {
            padding: 20px;
            margin-top: -10px;
            border-radius: 20px 20px 0 0;
            background: #f5f5f5;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
        }
        
        
        /* VIP状态卡片 */
        .vip-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            color: #333;
            display: none;
            box-shadow: 0 8px 32px rgba(255, 183, 71, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .vip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(255, 183, 71, 0.4);
        }
        
        .vip-card.active {
            display: block;
        }
        
        .vip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .vip-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vip-badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .vip-info {
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .vip-benefits {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* 功能菜单 */
        .menu-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .menu-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(102, 126, 234, 0.08);
            position: relative;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .menu-item:hover::before {
            opacity: 1;
        }
        
        .menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
            padding-left: 28px;
        }
        
        .menu-item:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .menu-icon {
            width: 28px;
            height: 28px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .menu-arrow {
            font-size: 14px;
            color: #ccc;
        }
        
        .menu-badge {
            position: absolute;
            top: 12px;
            right: 40px;
            background: #ff3b30;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 设置开关 */
        .setting-toggle {
            width: 44px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .setting-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .setting-toggle.active {
            background: #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .toggle-handle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }
        
        .setting-toggle.active .toggle-handle {
            transform: translateX(20px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .setting-toggle:active {
            transform: scale(0.98);
        }
        
        /* 版本信息 */
        .version-info {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
            margin-bottom: 80px;
        }
        
        .version-text {
            margin-bottom: 8px;
        }
        
        .copyright {
            margin-bottom: 8px;
        }
        
        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }
        
        .modal-text {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%) !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(38, 166, 154, 0.3) !important;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2bbbad 0%, #00796b 100%) !important;
            box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4) !important;
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        /* Modal基本样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
        }
        
        /* 底部导航样式已移至统一组件 bottom-navigation.css */
        
        /* 头像编辑相关样式 */
        .avatar-edit-content {
            padding: 20px 0;
        }
        
        .current-avatar-preview {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 8px;
            border: 3px solid #f0f0f0;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-preview-label {
            font-size: 12px;
            color: #666;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .upload-option {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-option:hover {
            border-color: #007AFF;
            background: #f8f9ff;
        }
        
        .upload-option.selected {
            border-color: #007AFF;
            background: #f0f5ff;
        }
        
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .upload-desc {
            font-size: 12px;
            color: #666;
        }
        
        .default-avatars {
            padding: 16px 0;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .default-avatar-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            justify-self: center;
        }
        
        .default-avatar-item:hover {
            transform: scale(1.1);
            border-color: #007AFF;
        }
        
        .default-avatar-item.selected {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* 上传进度 */
        .upload-progress {
            margin-top: 16px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        
        .section-header {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 2;
            padding: 16px 0 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 中等屏幕适配 */
        @media (max-width: 768px) and (min-width: 481px) {
            .user-stats {
                gap: 42px;
            }
        }
        
        /* 加载状态优化 */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .page-content {
                padding: 16px;
            }
            
            .user-stats {
                gap: 36px;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .default-avatar-item {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
        
        /* 使用新的统一学生底部导航组件，无需额外样式定义 */
        
        /* 编辑个人资料模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px;
            max-width: 350px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding: 12px 0;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            min-height: 40px;
            min-width: 80px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: #f0f0f0;
            color: #333;
        }
        
        .confirm-btn {
            background: #007AFF;
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .confirm-btn:hover:not(:disabled) {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .confirm-btn:disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }
        
        /* 头像选择器样式 */
        .avatar-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .avatar-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .avatar-preview-container:hover {
            transform: scale(1.05);
        }
        
        .student-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a 0%, #00695c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .student-avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-edit-hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }
    </style>
    
    <!-- 学生底部导航组件 -->
    <link rel="stylesheet" href="/frontend/css/student-bottom-nav.css">
    <script src="/frontend/js/student-bottom-nav.js"></script>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="navbar-title">个人中心</div>
                </div>
            </div>
        </div>
        
        <!-- 页面内容 -->
        <div class="page-content">
            <!-- 用户信息卡片 -->
            <div class="user-header">
                <div class="avatar-container">
                    <div class="user-avatar" id="userAvatar">👤</div>
                    <div class="avatar-edit" onclick="editAvatar()">✏️</div>
                </div>
                
                <div class="user-name" id="userName">正在加载...</div>
                <div class="user-info" id="userInfo">学生 · 五年级</div>
                
                <div class="user-stats">
                    <!-- 学生统计信息 -->
                    <div class="student-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="totalHomework">0</div>
                            <div class="stat-label">总作业</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="accuracyRate">0%</div>
                            <div class="stat-label">正确率</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="studyDays">0</div>
                            <div class="stat-label">学习天数</div>
                        </div>
                    </div>
                    
                    <!-- 家长统计信息 -->
                    <div class="parent-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-number" id="childrenCount">0</div>
                            <div class="stat-label">孩子数量</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="todayHomeworkCount">0</div>
                            <div class="stat-label">今日作业</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="averageAccuracy">0%</div>
                            <div class="stat-label">平均正确率</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- VIP卡片 -->
            <div class="vip-card" id="vipCard">
                <div class="vip-header">
                    <div class="vip-title">
                        👑 VIP会员
                        <div class="vip-badge">至尊版</div>
                    </div>
                </div>
                <div class="vip-info">无限次批改 · 专属客服 · 详细解析</div>
                <div class="vip-benefits">有效期至: <span id="vipExpireDate">2025-12-31</span></div>
            </div>
            
            <!-- 学习管理 / 孩子管理 -->
            <div class="menu-section" id="mainFunctionSection">
                <!-- 学生功能 -->
                <div class="student-functions" style="display: none;">
                    <div class="menu-item" onclick="goToErrorBook()">
                        <div class="menu-icon">📚</div>
                        <div class="menu-content">
                            <div class="menu-title">我的错题本</div>
                            <div class="menu-desc">查看和复习错题</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToStudyPlan()">
                        <div class="menu-icon">📋</div>
                        <div class="menu-content">
                            <div class="menu-title">学习计划</div>
                            <div class="menu-desc">制定和管理学习计划</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToHomeworkHistory()">
                        <div class="menu-icon">📝</div>
                        <div class="menu-content">
                            <div class="menu-title">作业记录</div>
                            <div class="menu-desc">查看历史批改记录</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                </div>
                
                <!-- 家长功能 -->
                <div class="parent-functions" style="display: none;">
                    <div class="menu-item" onclick="goToChildrenManagement()">
                        <div class="menu-icon">👨‍👩‍👧‍👦</div>
                        <div class="menu-content">
                            <div class="menu-title">孩子管理</div>
                            <div class="menu-desc">查看和管理孩子信息</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToLearningReports()">
                        <div class="menu-icon">📊</div>
                        <div class="menu-content">
                            <div class="menu-title">学习报告</div>
                            <div class="menu-desc">查看孩子的学习分析报告</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                    
                    <div class="menu-item" onclick="goToParentBind()">
                        <div class="menu-icon">🔗</div>
                        <div class="menu-content">
                            <div class="menu-title">账号绑定</div>
                            <div class="menu-desc">绑定或管理孩子账号</div>
                        </div>
                        <div class="menu-arrow">›</div>
                    </div>
                </div>
            </div>
            
            
            <!-- 账户管理 -->
            <div class="menu-section">
                <div class="menu-item" id="vipCenterItem" onclick="goToVipCenter()">
                    <div class="menu-icon">💎</div>
                    <div class="menu-content">
                        <div class="menu-title">会员中心</div>
                        <div class="menu-desc" id="vipStatusDesc">正在加载会员信息...</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="goToParentBind()">
                    <div class="menu-icon">👨‍👩‍👧‍👦</div>
                    <div class="menu-content">
                        <div class="menu-title">家长绑定</div>
                        <div class="menu-desc">绑定家长账号，实时同步学习情况</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="editProfile()">
                    <div class="menu-icon">⚙️</div>
                    <div class="menu-content">
                        <div class="menu-title">个人资料</div>
                        <div class="menu-desc">修改昵称、年级等信息</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
            </div>
            
            <!-- 应用设置 -->
            <div class="menu-section">
                <div class="menu-item" onclick="toggleNotification()">
                    <div class="menu-icon">🔔</div>
                    <div class="menu-content">
                        <div class="menu-title">消息通知</div>
                        <div class="menu-desc">学习提醒和系统通知</div>
                    </div>
                    <div class="setting-toggle active" id="notificationToggle">
                        <div class="toggle-handle"></div>
                    </div>
                </div>
            </div>
            
            <!-- 帮助支持 -->
            <div class="menu-section">
                <div class="menu-item" onclick="contactSupport()">
                    <div class="menu-icon">💬</div>
                    <div class="menu-content">
                        <div class="menu-title">客服支持</div>
                        <div class="menu-desc">在线客服，随时为您服务</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
                
                <div class="menu-item" onclick="goToAbout()">
                    <div class="menu-icon">ℹ️</div>
                    <div class="menu-content">
                        <div class="menu-title">关于我们</div>
                        <div class="menu-desc">了解ZYJC智能批改</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
            </div>
            
            <!-- 系统管理 -->
            <div class="menu-section">
                <div class="menu-item" onclick="checkForUpdates()">
                    <div class="menu-icon">🔄</div>
                    <div class="menu-content">
                        <div class="menu-title">检查更新</div>
                        <div class="menu-desc">检查应用更新和版本信息</div>
                    </div>
                    <div class="menu-arrow">›</div>
                </div>
            </div>
            
            <!-- 退出登录 -->
            <div class="menu-section">
                <div class="menu-item" onclick="logout()" style="color: #f44336;">
                    <div class="menu-icon">🚪</div>
                    <div class="menu-content">
                        <div class="menu-title" style="color: #f44336;">退出登录</div>
                        <div class="menu-desc">退出当前账号</div>
                    </div>
                </div>
            </div>
            
            <!-- 版本信息 -->
            <div class="version-info">
                <div class="version-text">ZYJC智能批改 v1.0.0</div>
                <div class="copyright">© 2025 ZYJC团队</div>
                <div>让学习更智能，让成长更高效</div>
            </div>
        </div>
    </div>
    
    <!-- 底部导航通过统一组件自动生成，根据用户角色显示对应导航 -->
    
    <!-- 确认模态框 -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">确认操作</div>
            <div class="modal-text" id="modalText">确定要执行此操作吗？</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="modal-btn btn-primary" onclick="confirmAction()">确认</button>
            </div>
        </div>
    </div>

    <!-- 头像编辑模态框 -->
    <div class="modal" id="avatarModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title">编辑头像</div>
            <div class="avatar-edit-content">
                <!-- 当前头像预览 -->
                <div class="current-avatar-preview">
                    <div class="avatar-preview" id="avatarPreview">👤</div>
                    <div class="avatar-preview-label">当前头像</div>
                </div>
                
                <!-- 上传选项 -->
                <div class="upload-options">
                    <div class="upload-option" onclick="selectAvatarFile()">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">选择本地图片</div>
                        <div class="upload-desc">支持JPG、PNG格式，最大5MB</div>
                    </div>
                    
                    <div class="upload-option" onclick="selectDefaultAvatar()">
                        <div class="upload-icon">😊</div>
                        <div class="upload-text">选择默认头像</div>
                        <div class="upload-desc">系统提供的头像图标</div>
                    </div>
                </div>
                
                <!-- 文件上传 -->
                <input type="file" id="avatarFileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeAvatarModal()">取消</button>
                <button class="modal-btn btn-primary" id="saveAvatarBtn" onclick="saveAvatar()" disabled>保存</button>
            </div>
        </div>
    </div>

    <!-- 默认头像选择模态框 -->
    <div class="modal" id="defaultAvatarModal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-title">选择默认头像</div>
            <div class="default-avatars">
                <div class="avatar-grid" id="avatarGrid">
                    <!-- 默认头像将通过JavaScript生成 -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-secondary" onclick="closeDefaultAvatarModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 编辑个人资料模态框 -->
    <div class="modal-overlay" id="editProfileModal" style="z-index: 1000;">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-title">编辑个人资料</div>
            <form id="editProfileForm">
                <div class="form-group">
                    <label class="form-label">昵称 <span style="color: red;">*</span></label>
                    <input type="text" class="form-input" id="editNickname" placeholder="请输入昵称" required>
                </div>
                <div class="form-group">
                    <label class="form-label">年级 <span style="color: red;">*</span></label>
                    <select class="form-input" id="editGrade" required>
                        <option value="">请选择年级</option>
                        <option value="一年级">一年级</option>
                        <option value="二年级">二年级</option>
                        <option value="三年级">三年级</option>
                        <option value="四年级">四年级</option>
                        <option value="五年级">五年级</option>
                        <option value="六年级">六年级</option>
                        <option value="七年级">七年级</option>
                        <option value="八年级">八年级</option>
                        <option value="九年级">九年级</option>
                        <option value="高一">高一</option>
                        <option value="高二">高二</option>
                        <option value="高三">高三</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">班级 <span style="color: red;">*</span></label>
                    <select class="form-input" id="editClass" required>
                        <option value="">请先选择年级</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">学校</label>
                    <input type="text" class="form-input" id="editSchool" placeholder="请输入学校名称">
                </div>
                <!-- 固定在底部的按钮区域 -->
                <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                    <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">取消</button>
                    <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 认证工具类 -->
    <script src="/frontend/js/auth-utils.js"></script>
    
    <!-- 底部导航组件 -->
    <link rel="stylesheet" href="/frontend/css/bottom-navigation.css">
    <script src="/frontend/js/navigation-config.js"></script>
    <script src="/frontend/js/bottom-navigation.js"></script>
    
    <script>
        console.log('=== SCRIPT LOADING ===');
        
        // 立即检查URL参数并强制设置家长角色（如果需要）- 修复家长网络错误
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlRole = urlParams.get('role');
            
            if (urlRole === 'parent') {
                console.log('🏠 检测到家长角色URL参数，立即设置家长数据');
                localStorage.setItem('userRole', 'parent');
                localStorage.setItem('role', 'parent'); // 兼容旧系统
                localStorage.setItem('token', 'test-token-parent');
                console.log('✅ 家长数据强制设置完成');
            } else {
                // 检查现有数据
                const existingRole = localStorage.getItem('userRole') || localStorage.getItem('role');
                if (existingRole === 'parent') {
                    localStorage.setItem('userRole', 'parent'); // 确保新键存在
                    localStorage.setItem('token', 'test-token-parent');
                    console.log('✅ 检测到现有家长角色，确保使用正确token和键名');
                }
            }
        })();
        
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = '';
        let userInfo = null;
        let pendingAction = null;
        
        // 优化：添加加载状态控制
        let isLoading = false;
        let lastLoadTime = 0;
        const LOAD_DEBOUNCE_TIME = 2000; // 2秒防抖
        
        console.log('Variables initialized, API_BASE:', API_BASE);
        
        // 辅助函数：安全获取当前token
        function getCurrentTokenSafe() {
            if (typeof AuthUtils !== 'undefined') {
                try {
                    const authToken = AuthUtils.getCurrentToken();
                    if (authToken) return authToken;
                } catch (e) {
                    console.log('AuthUtils token获取失败，使用localStorage备用方案');
                }
            }
            
            // 备用方案：直接从localStorage获取
            let fallbackToken = localStorage.getItem('token');
            const role = localStorage.getItem('userRole') || localStorage.getItem('role');
            
            // 家长角色特殊处理
            if (role === 'parent' && fallbackToken !== 'test-token-parent') {
                fallbackToken = 'test-token-parent';
                localStorage.setItem('token', fallbackToken);
                console.log('🔧 安全获取token：家长角色强制设置正确token');
            }
            
            return fallbackToken;
        }
        
        // 调试函数：显示AuthUtils状态
        window.debugAuthState = function() {
            console.log('=== AuthUtils调试信息 ===');
            if (typeof AuthUtils !== 'undefined') {
                console.log('当前角色:', AuthUtils.getCurrentUserRole());
                console.log('当前Token:', AuthUtils.getCurrentToken());
            } else {
                console.log('AuthUtils未加载或未定义');
            }
            console.log('localStorage userRole:', localStorage.getItem('userRole'));
            console.log('localStorage role:', localStorage.getItem('role'));
            console.log('localStorage token:', localStorage.getItem('token'));
            console.log('全局token变量:', token);
            console.log('安全获取token结果:', getCurrentTokenSafe());
            console.log('==================');
        };

        // 终极调试函数：直接测试所有API端点
        window.testAllAPIs = async function() {
            console.log('🔍 === 开始全面API测试 ===');
            
            const testToken = 'test-token-parent';
            const baseUrl = 'http://localhost:8000/api/v1';
            
            const apis = [
                { name: 'User Profile', url: `${baseUrl}/user/profile` },
                { name: 'Parent Dashboard', url: `${baseUrl}/parent/dashboard` },
                { name: 'VIP Status', url: `${baseUrl}/user/vip-status` }
            ];
            
            for (const api of apis) {
                console.log(`\n🧪 测试: ${api.name}`);
                try {
                    const response = await fetch(api.url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${testToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log(`✅ ${api.name} - 状态:`, response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`📊 ${api.name} - 数据:`, data);
                    } else {
                        const errorText = await response.text();
                        console.log(`❌ ${api.name} - 错误内容:`, errorText);
                    }
                } catch (error) {
                    console.log(`💥 ${api.name} - 网络错误:`, error.message);
                    console.log(`💥 ${api.name} - 完整错误:`, error);
                }
            }
            
            console.log('🔍 === API测试完成 ===');
        };
        
        // 简化的家长数据加载测试
        window.testParentLoad = async function() {
            console.log('🏠 === 家长数据加载测试 ===');
            
            const testToken = 'test-token-parent';
            const url = 'http://localhost:8000/api/v1/user/profile';
            
            try {
                console.log('📡 请求URL:', url);
                console.log('📡 请求Token:', testToken);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${testToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('📊 响应状态:', response.status);
                console.log('📊 响应头:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ 成功获取数据:', data);
                    return data;
                } else {
                    const errorText = await response.text();
                    console.log('❌ 错误响应:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.log('💥 网络请求失败:', error);
                throw error;
            }
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded事件触发，开始初始化页面');
            try {
                initPage();
                
                // 设置高级调试监控（延迟执行，确保DOM完全就绪）
                setTimeout(() => {
                    console.log('🚀 设置高级调试和监控系统...');
                    setupAdvancedDebugging();
                    
                    // 执行初始同步检查
                    setTimeout(() => {
                        performUserProfileSyncCheck();
                    }, 500);
                    
                    // 启动智能重试机制，确保数据一致性
                    setTimeout(() => {
                        ensureUserProfileUpdateSuccess();
                    }, 1000);
                    
                    console.log('✅ 高级调试系统启动完成');
                }, 300);
                
            } catch (error) {
                console.error('页面初始化失败:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });
        
        // 备用初始化（防止DOMContentLoaded事件未触发）- 增强版
        window.addEventListener('load', function() {
            console.log('window load事件触发');
            
            // 执行完整的系统状态检查
            setTimeout(() => {
                const diagnostics = performSystemDiagnostics();
                
                if (!diagnostics.success) {
                    console.log('🔧 系统检查发现问题，执行修复...');
                    
                    // 检查用户名是否正确显示
                    const userNameEl = document.getElementById('userName');
                    const shouldUpdate = !userNameEl || 
                                       userNameEl.textContent.includes('测试用户') || 
                                       userNameEl.textContent === '' ||
                                       userNameEl.textContent === '加载中...';
                    
                    if (shouldUpdate) {
                        console.log('用户名需要更新，尝试重新初始化');
                        try {
                            initPage();
                            
                            // 确保家长用户数据正确加载
                            const role = AuthUtils.getCurrentUserRole();
                            if (role === 'parent') {
                                setTimeout(() => {
                                    ensureUserProfileUpdateSuccess();
                                }, 1000);
                            }
                        } catch (error) {
                            console.error('备用初始化失败:', error);
                        }
                    }
                }
            }, 500);
        });
        
        // 页面获得焦点时刷新数据 - 增加防抖和频率限制
        let lastFocusRefresh = 0;
        window.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastFocusRefresh < 30000) { // 30秒内不重复刷新
                console.log('页面获得焦点，但距上次刷新不足30秒，跳过');
                return;
            }
            console.log('页面获得焦点，刷新用户数据');
            lastFocusRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 500); // 增加延迟，避免频繁触发
            }
        });
        
        // 页面可见性变化时刷新数据 - 增加防抖和频率限制
        let lastVisibilityRefresh = 0;
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = Date.now();
                if (now - lastVisibilityRefresh < 30000) { // 30秒内不重复刷新
                    console.log('页面变为可见，但距上次刷新不足30秒，跳过');
                    return;
                }
                console.log('页面变为可见，刷新用户数据');
                lastVisibilityRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role) {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500); // 增加延迟，避免频繁触发
                }
            }
        });
        
        // 监听用户信息更新事件 - 增加防抖
        let lastInfoUpdateRefresh = 0;
        window.addEventListener('userInfoUpdated', function(event) {
            console.log('收到用户信息更新事件:', event.detail);
            const now = Date.now();
            if (now - lastInfoUpdateRefresh < 5000) { // 5秒内不重复刷新
                console.log('用户信息更新事件，但距上次刷新不足5秒，跳过');
                return;
            }
            lastInfoUpdateRefresh = now;
            const role = AuthUtils.getCurrentUserRole();
            if (role) {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 300);
            }
        });
        
        // 监听localStorage中的子女数据更新事件 - 增加防抖
        let lastStorageRefresh = 0;
        window.addEventListener('storage', function(event) {
            if (event.key === 'childDataUpdated') {
                const now = Date.now();
                if (now - lastStorageRefresh < 10000) { // 10秒内不重复刷新
                    console.log('收到子女数据更新通知，但距上次刷新不足10秒，跳过');
                    return;
                }
                console.log('收到子女数据更新通知，刷新页面数据');
                lastStorageRefresh = now;
                const role = AuthUtils.getCurrentUserRole();
                if (role === 'parent') {
                    setTimeout(() => {
                        loadUserProfile(role);
                    }, 500);
                }
            }
        });
        
        // 监听manage-children页面的直接通知
        window.addEventListener('childDataChanged', function(event) {
            console.log('收到子女数据变更事件');
            const role = AuthUtils.getCurrentUserRole();
            if (role === 'parent') {
                setTimeout(() => {
                    loadUserProfile(role);
                }, 200);
            }
        });

        function initPage() {
            console.log('=== 初始化页面 ===');
            
            try {
                // 备用方案：直接从localStorage获取角色和token - 修复家长用户网络错误
                let role = localStorage.getItem('userRole') || localStorage.getItem('role');
                token = localStorage.getItem('token');
                
                console.log('初始化页面 - 直接从localStorage获取 Token:', token ? 'OK' : 'NONE', 'Role:', role);
                
                // 如果检测到家长角色，确保使用正确的token
                if (role === 'parent' && token !== 'test-token-parent') {
                    console.log('🔧 检测到家长角色但token不正确，强制设置正确token');
                    token = 'test-token-parent';
                    localStorage.setItem('token', token);
                }
                
                // 尝试使用AuthUtils（如果可用）
                if (typeof AuthUtils !== 'undefined') {
                    try {
                        const authRole = AuthUtils.getCurrentUserRole();
                        const authToken = AuthUtils.getCurrentToken();
                        
                        console.log('AuthUtils可用 - Role:', authRole, 'Token:', authToken ? 'OK' : 'NONE');
                        
                        if (authRole && authToken) {
                            role = authRole;
                            token = authToken;
                            console.log('使用AuthUtils获取的数据');
                        }
                    } catch (authError) {
                        console.error('AuthUtils调用失败，使用localStorage数据:', authError);
                    }
                } else {
                    console.log('AuthUtils不可用，使用localStorage数据');
                }
                
                // 最后检查：如果仍然没有有效数据
                if (!role || !token) {
                    console.log('没有有效的role或token，使用默认值');
                    role = 'student';
                    token = 'test-token-123';
                    localStorage.setItem('userRole', role);
                    localStorage.setItem('role', role);
                    localStorage.setItem('token', token);
                }
                
                console.log('最终使用的数据 - Role:', role, 'Token:', token);
                
                // AuthUtils已经处理了角色验证，直接使用当前角色
                console.log('最终确认的用户角色:', role, 'Token状态:', token ? 'OK' : 'NONE');
                
                // 从localStorage恢复用户信息到全局变量（如果存在）
                try {
                    const storedUser = localStorage.getItem('user');
                    if (storedUser) {
                        userInfo = JSON.parse(storedUser);
                        console.log('从localStorage恢复用户信息:', userInfo);
                    }
                } catch (error) {
                    console.error('恢复localStorage用户信息失败:', error);
                }
                
                // 生成角色对应的导航
                generateRoleBasedNavigation();
                
                // 检查是否从其他页面返回，如果是则强制刷新
                const returnFromPage = localStorage.getItem('returnFromPage');
                const childDataUpdated = localStorage.getItem('childDataUpdated');
                
                if (returnFromPage) {
                    console.log('从页面返回:', returnFromPage);
                    localStorage.removeItem('returnFromPage');
                }
                
                // 检查是否有子女数据更新通知
                if (childDataUpdated && role === 'parent') {
                    console.log('检测到子女数据更新标记，清除并刷新数据');
                    localStorage.removeItem('childDataUpdated');
                }
                
                if (returnFromPage || childDataUpdated) {
                    // 延迟一点刷新，确保页面加载完成
                    setTimeout(() => {
                        console.log('从其他页面返回，强制刷新数据');
                        loadUserProfile(role, true); // 强制刷新
                    }, 500);
                } else {
                    // 正常初始化加载
                    setTimeout(() => {
                        console.log('正常初始化加载用户数据');
                        loadUserProfile(role);
                    }, 100);
                }
                
                // 设置头像文件选择监听器
                setTimeout(() => {
                    console.log('设置文件选择监听器');
                    try {
                        const avatarFileInput = document.getElementById('avatarFileInput');
                        
                        if (avatarFileInput) {
                            avatarFileInput.removeEventListener('change', handleFileSelect);
                            avatarFileInput.addEventListener('change', handleFileSelect);
                            console.log('文件选择监听器已设置');
                        } else {
                            console.warn('文件输入元素 avatarFileInput 暂未找到（可能还未渲染）');
                        }
                    } catch (listenerError) {
                        console.error('设置文件选择监听器失败:', listenerError);
                    }
                }, 200);
                
                // 绑定编辑个人资料表单事件
                setTimeout(() => {
                    console.log('绑定编辑个人资料表单事件');
                    try {
                        const editProfileForm = document.getElementById('editProfileForm');
                        if (editProfileForm) {
                            editProfileForm.removeEventListener('submit', handleEditProfileSubmit);
                            editProfileForm.addEventListener('submit', handleEditProfileSubmit);
                            console.log('编辑个人资料表单事件已绑定');
                        } else {
                            console.warn('editProfileForm元素暂未找到（可能还未渲染）');
                        }
                    } catch (formError) {
                        console.error('绑定编辑个人资料表单事件失败:', formError);
                    }
                }, 250);
                
                // 初始化通知开关状态
                setTimeout(() => {
                    console.log('初始化通知开关状态');
                    initializeNotificationToggle();
                }, 300);
                
            } catch (error) {
                console.error('页面初始化过程中出现错误:', error);
                // 显示用户友好的错误信息，但不阻止页面加载
                showToast('页面加载遇到问题，部分功能可能受限，请刷新重试');
            }
        }
        
        function generateRoleBasedNavigation() {
            console.log('=== 生成基于角色的底部导航 ===');
            
            const role = getCurrentUserRole();
            console.log('📋 检测到的用户角色:', role);
            
            // 立即为家长用户创建导航，避免被其他组件干扰
            if (role === 'parent') {
                console.log('🚀 家长用户：立即强制创建导航');
                
                // 立即执行一次
                forceCreateParentNavigation();
                
                // 延迟执行确保覆盖其他可能的导航组件
                setTimeout(() => {
                    console.log('🔄 延迟验证并重新创建家长导航');
                    forceCreateParentNavigation();
                }, 500);
                
                // 再次延迟执行确保导航持续存在
                setTimeout(() => {
                    console.log('🔄 最终验证家长导航');
                    const nav = document.getElementById('parentBottomNav');
                    if (!nav) {
                        console.log('⚠️ 导航仍不存在，执行最终创建');
                        forceCreateParentNavigation();
                    }
                }, 1500);
                
                // 启动持续监控机制
                startParentNavigationMonitoring();
                
            } else if (role === 'student') {
                console.log('🎓 开始初始化学生导航组件');
                // 延迟执行学生导航，避免与家长用户冲突
                setTimeout(() => {
                    try {
                        initStudentNavigation();
                        console.log('✅ 学生导航初始化完成');
                    } catch (error) {
                        console.error('❌ 学生导航初始化失败:', error);
                    }
                }, 100);
            } else {
                console.error('❌ 未知用户角色:', role, '使用学生导航作为默认');
                setTimeout(() => initStudentNavigation(), 100);
            }
            
            // 继续配置UI显示
            setTimeout(() => setupRoleBasedUI(role), 200);
        }
        
        // 强制创建家长导航（超级简化版本）
        function forceCreateParentNavigation() {
            console.log('💪 强制创建家长导航（超级简化版）');
            
            // 移除所有现有导航
            document.querySelectorAll('[id*="nav"], [class*="nav"], [data-nav]').forEach(el => el.remove());
            
            // 检测是否为移动端（完全匹配modern-theme.css的断点）
            const isMobile = window.innerWidth <= 480;
            
            // 创建导航容器
            const navContainer = document.createElement('div');
            navContainer.id = 'parentBottomNav';
            
            // 根据屏幕尺寸动态设置样式（完全匹配modern-theme.css的响应式设计）
            const itemPadding = isMobile ? '4px 1px 3px' : '6px 2px 4px';
            const itemMargin = isMobile ? '0' : '0 1px';
            const iconSize = isMobile ? '16px' : '18px';
            const iconMargin = isMobile ? '1px' : '2px';
            const textSize = isMobile ? '8px' : '9px';
            const borderRadius = isMobile ? '12px' : '8px';
            
            navContainer.innerHTML = `
                <div onclick="goToParentHome()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83C\uDFE0</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">首页</div>
                </div>
                <div onclick="goToLearningReports()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDCCA</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">学习报告</div>
                </div>
                <div onclick="goToErrorAnalysis()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDD0D</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">错题分析</div>
                </div>
                <div onclick="goToLearningProgress()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDCC8</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">学习进度</div>
                </div>
                <div onclick="goToChildDetail()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#666;transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;">\uD83D\uDC76</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">孩子管理</div>
                </div>
                <div onclick="goToProfile()" style="flex:1;display:flex;flex-direction:column;align-items:center;padding:${itemPadding};cursor:pointer;border-radius:${borderRadius};margin:${itemMargin};color:#667eea;background:rgba(102, 126, 234, 0.1);transition:all 0.3s ease;">
                    <div style="font-size:${iconSize};margin-bottom:${iconMargin};display:block;transform:scale(1.05);filter:none !important;box-shadow:none !important;text-shadow:none !important;-webkit-filter:none !important;">\uD83D\uDC64</div>
                    <div style="font-size:${textSize};font-weight:500;letter-spacing:0.2px;text-align:center;line-height:1;">我的</div>
                </div>
            `;
            
            // 设置容器样式（完全参照manage-children.html的modern-theme.css，包括移动端适配）
            const containerPadding = isMobile ? '6px 0 4px' : '8px 0 6px';
            
            navContainer.style.cssText = `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(102, 126, 234, 0.1) !important;
                display: flex !important;
                padding: ${containerPadding} !important;
                box-shadow: none !important;
                z-index: 1000 !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
            
            // 插入导航
            document.body.appendChild(navContainer);
            
            // 添加专门的CSS样式来彻底移除阴影效果
            if (!document.getElementById('noShadowStyles')) {
                const noShadowStyle = document.createElement('style');
                noShadowStyle.id = 'noShadowStyles';
                noShadowStyle.textContent = `
                    #parentBottomNav {
                        box-shadow: none !important;
                    }
                    #parentBottomNav .active-no-shadow {
                        filter: none !important;
                        box-shadow: none !important;
                        text-shadow: none !important;
                        -webkit-filter: none !important;
                        -moz-filter: none !important;
                        -ms-filter: none !important;
                        -o-filter: none !important;
                    }
                `;
                document.head.appendChild(noShadowStyle);
            }
            
            // 为"我的"按钮图标添加无阴影类
            setTimeout(() => {
                const profileIcon = document.querySelector('#parentBottomNav div[onclick="goToProfile()"] div:first-child');
                if (profileIcon) {
                    profileIcon.classList.add('active-no-shadow');
                }
            }, 100);
            
            // 根据移动端/桌面端调整页面底部间距
            const bottomPadding = isMobile ? '60px' : '70px';
            document.body.style.paddingBottom = bottomPadding;
            
            console.log('✅ 超简化家长导航创建完成');
            
            // 立即验证
            setTimeout(() => {
                const nav = document.getElementById('parentBottomNav');
                console.log('导航验证:', nav ? '存在' : '不存在', nav ? nav.offsetHeight : 'N/A');
                if (!nav) {
                    // 如果还是没有，再创建一次
                    const fallbackNav = document.createElement('div');
                    fallbackNav.innerHTML = '🏠📊🔍📈👶👤 家长导航';
                    fallbackNav.style.cssText = 'position:fixed;bottom:10px;left:10px;background:red;color:white;padding:10px;z-index:99999;';
                    document.body.appendChild(fallbackNav);
                    console.log('创建了应急导航');
                }
            }, 100);
        }
        
        // 启动家长导航持续监控
        function startParentNavigationMonitoring() {
            console.log('🔍 启动家长导航持续监控');
            
            // 清除之前可能存在的监控
            if (window.parentNavMonitorInterval) {
                clearInterval(window.parentNavMonitorInterval);
            }
            
            // 每1秒检查一次导航是否存在（更频繁的检查）
            window.parentNavMonitorInterval = setInterval(() => {
                const currentRole = getCurrentUserRole();
                if (currentRole === 'parent') {
                    const nav = document.getElementById('parentBottomNav');
                    if (!nav || nav.offsetHeight === 0 || !document.body.contains(nav)) {
                        console.log('⚠️ 监控发现家长导航丢失，立即重新创建');
                        forceCreateParentNavigation();
                    } else {
                        // 确保导航样式正确（符合modern-theme.css，包括移动端适配）
                        const isCurrentMobile = window.innerWidth <= 480;
                        const currentPadding = isCurrentMobile ? '6px 0 4px' : '8px 0 6px';
                        
                        nav.style.display = 'flex';
                        nav.style.position = 'fixed';
                        nav.style.bottom = '0';
                        nav.style.left = '50%';
                        nav.style.transform = 'translateX(-50%)';
                        nav.style.width = '100%';
                        nav.style.maxWidth = '400px';
                        nav.style.background = 'rgba(255, 255, 255, 0.95)';
                        nav.style.backdropFilter = 'blur(20px)';
                        nav.style.WebkitBackdropFilter = 'blur(20px)';
                        nav.style.borderTop = '1px solid rgba(102, 126, 234, 0.1)';
                        nav.style.padding = currentPadding;
                        nav.style.boxShadow = 'none';
                        nav.style.zIndex = '1000';
                        nav.style.opacity = '1';
                        nav.style.visibility = 'visible';
                    }
                } else {
                    // 如果不是家长用户，停止监控
                    console.log('停止家长导航监控（用户角色已变更）');
                    clearInterval(window.parentNavMonitorInterval);
                    window.parentNavMonitorInterval = null;
                }
            }, 1000);
            
            console.log('✅ 家长导航监控已启动');
        }
        
        // 获取当前用户角色
        function getCurrentUserRole() {
            console.log('=== 获取当前用户角色 ===');
            
            // 方法1: 优先使用AuthUtils
            if (typeof AuthUtils !== 'undefined' && AuthUtils.getCurrentUserRole) {
                const authUtilsRole = AuthUtils.getCurrentUserRole();
                console.log('AuthUtils获取的角色:', authUtilsRole);
                if (authUtilsRole && authUtilsRole !== 'unknown') {
                    return authUtilsRole;
                }
            } else {
                console.log('AuthUtils不可用，使用备用方案');
            }
            
            // 方法2: 从localStorage获取
            const localStorageRole = localStorage.getItem('role');
            console.log('localStorage中的角色:', localStorageRole);
            if (localStorageRole && localStorageRole !== 'unknown') {
                return localStorageRole;
            }
            
            // 方法3: 从Token直接解析（最可靠的方法）
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    let userId = null;
                    
                    // 处理测试token
                    if (token === 'test-token-parent') {
                        userId = '2';
                        console.log('从测试token确认家长用户');
                    } else if (token === 'test-token-123') {
                        userId = '1';
                        console.log('从测试token确认学生用户');
                    } else {
                        // 尝试解析真实的JWT token
                        const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                        userId = tokenPayload.sub;
                        console.log('从JWT Token解析用户ID:', userId);
                    }
                    
                    const roleFromToken = userId === '2' ? 'parent' : 'student';
                    console.log('从Token解析的角色 - 用户ID:', userId, '角色:', roleFromToken);
                    
                    // 更新localStorage确保一致性
                    localStorage.setItem('role', roleFromToken);
                    return roleFromToken;
                }
            } catch (error) {
                console.error('从Token解析角色失败:', error);
            }
            
            // 默认返回学生角色
            console.log('使用默认学生角色');
            return 'student';
        }
        
        // 初始化学生导航
        function initStudentNavigation() {
            console.log('初始化学生底部导航组件...');
            
            // 清除可能存在的家长导航
            clearExistingNavigation();
            
            // 检查StudentBottomNav是否可用
            if (typeof StudentBottomNav !== 'undefined') {
                // 使用StudentBottomNav组件
                const success = StudentBottomNav.init({
                    currentPage: 'profile',
                    debug: false
                });
                
                if (success) {
                    console.log('✅ 学生底部导航组件初始化成功');
                    document.body.classList.add('has-student-nav');
                } else {
                    console.error('❌ 学生底部导航组件初始化失败');
                    // 作为备用方案，创建简单的学生导航
                    createFallbackStudentNav();
                }
            } else {
                console.warn('⚠️ StudentBottomNav组件不可用，使用备用方案');
                createFallbackStudentNav();
            }
        }
        
        // 初始化家长导航
        function initParentNavigation() {
            console.log('🔧 初始化家长底部导航组件...');
            
            // 清除可能存在的其他导航
            console.log('🧹 清除现有导航');
            clearExistingNavigation();
            
            // 等待清除完成后再创建家长导航
            setTimeout(() => {
                console.log('🏗️ 创建家长导航HTML结构');
                createParentNavigation();
                
                // 验证创建是否成功
                setTimeout(() => {
                    const nav = document.getElementById('parentBottomNav');
                    if (nav) {
                        console.log('✅ 家长导航创建验证成功');
                    } else {
                        console.error('❌ 家长导航创建验证失败，再次尝试');
                        createParentNavigation();
                    }
                }, 100);
            }, 50);
        }
        
        // 清除现有导航
        function clearExistingNavigation() {
            console.log('清除现有导航...');
            
            // 清除保护机制
            if (window.parentNavProtectionInterval) {
                clearInterval(window.parentNavProtectionInterval);
                window.parentNavProtectionInterval = null;
            }
            
            // 移除所有可能存在的导航元素
            const existingNavs = document.querySelectorAll('.theme-bottom-nav, .student-bottom-nav, .global-bottom-nav, #parentBottomNav, #studentBottomNav');
            existingNavs.forEach(nav => {
                if (nav && nav.parentNode) {
                    console.log('移除导航元素:', nav.className || nav.id);
                    nav.parentNode.removeChild(nav);
                }
            });
            
            // 移除导航相关的CSS类
            document.body.classList.remove('has-parent-nav', 'has-student-nav');
            
            // 移除动态添加的样式
            const parentNavStyles = document.getElementById('parentNavStyles');
            if (parentNavStyles) {
                parentNavStyles.remove();
            }
            
            const studentNavStyles = document.getElementById('studentNavStyles');
            if (studentNavStyles) {
                studentNavStyles.remove();
            }
            
            // 重置页面底部间距
            document.body.style.paddingBottom = '';
            
            console.log('✅ 现有导航清除完成');
        }
        
        // 创建家长导航（参照error-analysis.html的稳定实现）
        function createParentNavigation() {
            console.log('🎨 正在创建家长底部导航...');
            
            // 再次确保没有重复的导航
            const existingNav = document.getElementById('parentBottomNav');
            if (existingNav) {
                console.log('⚠️ 发现已存在的家长导航，先移除');
                existingNav.remove();
            }
            
            // 创建导航容器
            const parentNav = document.createElement('div');
            parentNav.className = 'theme-bottom-nav';
            parentNav.id = 'parentBottomNav'; // 添加ID便于管理
            
            console.log('📦 创建导航容器完成');
            
            // 创建导航项数据（与error-analysis.html完全一致）
            const navItems = [
                { icon: '🏠', text: '首页', onClick: 'goToParentHome()' },
                { icon: '📊', text: '学习报告', onClick: 'goToLearningReports()' },
                { icon: '🔍', text: '错题分析', onClick: 'goToErrorAnalysis()' },
                { icon: '📈', text: '学习进度', onClick: 'goToLearningProgress()' },
                { icon: '👶', text: '孩子管理', onClick: 'goToChildDetail()' },
                { icon: '👤', text: '我的', onClick: 'goToProfile()', active: true } // 当前页面
            ];
            
            // 创建每个导航项
            navItems.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = `theme-nav-item${item.active ? ' active' : ''}`;
                navItem.setAttribute('onclick', item.onClick);
                
                const navIcon = document.createElement('div');
                navIcon.className = 'theme-nav-icon';
                navIcon.textContent = item.icon;
                
                const navText = document.createElement('div');
                navText.className = 'theme-nav-text';
                navText.textContent = item.text;
                
                navItem.appendChild(navIcon);
                navItem.appendChild(navText);
                parentNav.appendChild(navItem);
            });
            
            // 添加到页面
            document.body.appendChild(parentNav);
            
            // 确保页面底部间距（使用CSS而不是内联样式）
            if (!document.getElementById('parentNavStyles')) {
                const style = document.createElement('style');
                style.id = 'parentNavStyles';
                style.textContent = `
                    body.has-parent-nav {
                        padding-bottom: 80px;
                    }
                    .theme-bottom-nav {
                        position: fixed;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 100%;
                        max-width: 400px;
                        background: #ffffff;
                        border-top: 1px solid #eee;
                        display: flex;
                        padding: 8px 0;
                        z-index: 1000;
                    }
                    .theme-nav-item {
                        flex: 1;
                        text-align: center;
                        padding: 8px;
                        cursor: pointer;
                        transition: color 0.2s ease;
                    }
                    .theme-nav-item.active {
                        color: #667eea;
                    }
                    .theme-nav-icon {
                        font-size: 20px;
                        margin-bottom: 4px;
                    }
                    .theme-nav-text {
                        font-size: 10px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 添加body类标识
            document.body.classList.add('has-parent-nav');
            
            // 最终验证导航是否成功添加到DOM
            setTimeout(() => {
                const finalCheck = document.getElementById('parentBottomNav');
                if (finalCheck && document.body.contains(finalCheck)) {
                    console.log('✅ 家长底部导航创建完成并已添加到DOM');
                    console.log('🔍 导航元素详情:', {
                        id: finalCheck.id,
                        className: finalCheck.className,
                        children: finalCheck.children.length,
                        visible: finalCheck.offsetHeight > 0
                    });
                } else {
                    console.error('❌ 家长导航创建失败 - 未添加到DOM或不存在');
                    // 紧急修复：强制重新创建
                    setTimeout(() => {
                        console.log('🚨 执行紧急修复 - 强制重新创建导航');
                        createParentNavigationFallback();
                    }, 200);
                }
            }, 100);
            
            // 添加防护机制，防止导航被意外删除
            setupParentNavProtection();
        }
        
        // 紧急备用方案：使用最简单的方式创建家长导航
        function createParentNavigationFallback() {
            console.log('🆘 执行家长导航紧急备用方案');
            
            // 使用最直接的innerHTML方式
            const navHtml = `
                <div class="theme-bottom-nav" id="parentBottomNav" style="
                    position: fixed;
                    bottom: 0;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 100%;
                    max-width: 400px;
                    background: #ffffff;
                    border-top: 1px solid #eee;
                    display: flex;
                    padding: 8px 0;
                    z-index: 1000;
                ">
                    <div class="theme-nav-item" onclick="goToParentHome()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">🏠</div>
                        <div class="theme-nav-text" style="font-size: 10px;">首页</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToLearningReports()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">📊</div>
                        <div class="theme-nav-text" style="font-size: 10px;">学习报告</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToErrorAnalysis()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">🔍</div>
                        <div class="theme-nav-text" style="font-size: 10px;">错题分析</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToLearningProgress()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">📈</div>
                        <div class="theme-nav-text" style="font-size: 10px;">学习进度</div>
                    </div>
                    <div class="theme-nav-item" onclick="goToChildDetail()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">👶</div>
                        <div class="theme-nav-text" style="font-size: 10px;">孩子管理</div>
                    </div>
                    <div class="theme-nav-item active" onclick="goToProfile()" style="flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #667eea;">
                        <div class="theme-nav-icon" style="font-size: 20px; margin-bottom: 4px;">👤</div>
                        <div class="theme-nav-text" style="font-size: 10px;">我的</div>
                    </div>
                </div>
            `;
            
            // 直接插入到body末尾
            document.body.insertAdjacentHTML('beforeend', navHtml);
            
            // 设置页面底部间距
            document.body.style.paddingBottom = '100px';
            document.body.classList.add('has-parent-nav');
            
            console.log('✅ 紧急备用家长导航创建完成');
            
            // 最终验证
            setTimeout(() => {
                const fallbackNav = document.getElementById('parentBottomNav');
                if (fallbackNav) {
                    console.log('✅ 紧急备用导航验证成功');
                } else {
                    console.error('❌ 连紧急备用方案都失败了！');
                }
            }, 100);
        }
        
        // 设置家长导航保护机制
        function setupParentNavProtection() {
            // 定时检查导航是否还存在
            const protectionInterval = setInterval(() => {
                const nav = document.getElementById('parentBottomNav');
                if (!nav && getCurrentUserRole() === 'parent') {
                    console.warn('⚠️ 家长导航被意外删除，正在重新创建...');
                    clearInterval(protectionInterval);
                    createParentNavigation();
                }
            }, 2000);
            
            // 存储保护机制ID，便于清理
            window.parentNavProtectionInterval = protectionInterval;
        }
        
        // 创建备用学生导航
        function createFallbackStudentNav() {
            console.warn('⚠️ 使用备用学生导航方案');
            
            // 创建导航容器
            const studentNav = document.createElement('div');
            studentNav.className = 'student-bottom-nav';
            studentNav.id = 'studentBottomNav';
            studentNav.setAttribute('data-component', 'student-bottom-nav');
            
            // 创建导航项数据
            const navItems = [
                { icon: '🏠', text: '首页', onClick: 'goToStudentHome()' },
                { icon: '📷', text: '拍照批改', onClick: 'goToHomeworkSubmit()' },
                { icon: '📚', text: '错题本', onClick: 'goToErrorBook()' },
                { icon: '📋', text: '学习计划', onClick: 'goToStudyPlan()' },
                { icon: '👤', text: '我的', onClick: 'goToProfile()', active: true } // 当前页面
            ];
            
            // 创建每个导航项
            navItems.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = `student-nav-item${item.active ? ' active' : ''}`;
                navItem.setAttribute('onclick', item.onClick);
                
                const navIcon = document.createElement('div');
                navIcon.className = 'student-nav-icon';
                navIcon.textContent = item.icon;
                
                const navText = document.createElement('div');
                navText.className = 'student-nav-text';
                navText.textContent = item.text;
                
                navItem.appendChild(navIcon);
                navItem.appendChild(navText);
                studentNav.appendChild(navItem);
            });
            
            // 添加到页面
            document.body.appendChild(studentNav);
            
            // 确保学生导航样式（使用CSS而不是内联样式）
            if (!document.getElementById('studentNavStyles')) {
                const style = document.createElement('style');
                style.id = 'studentNavStyles';
                style.textContent = `
                    body.has-student-nav {
                        padding-bottom: 80px;
                    }
                    .student-bottom-nav {
                        position: fixed;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 100%;
                        max-width: 400px;
                        background: #ffffff;
                        border-top: 1px solid #eee;
                        display: flex;
                        padding: 8px 0;
                        z-index: 1000;
                        opacity: 1;
                        transition: all 0.3s ease;
                    }
                    .student-nav-item {
                        flex: 1;
                        text-align: center;
                        padding: 8px;
                        cursor: pointer;
                        transition: color 0.2s ease;
                    }
                    .student-nav-item.active {
                        color: #667eea;
                    }
                    .student-nav-icon {
                        font-size: 20px;
                        margin-bottom: 4px;
                    }
                    .student-nav-text {
                        font-size: 10px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 添加body类标识
            document.body.classList.add('has-student-nav');
            
            console.log('✅ 备用学生底部导航创建完成');
        }
        
        // 作为备用方案的简化导航创建函数
        function setupRoleBasedUIFallback() {
            console.warn('⚠️ 使用备用导航方案');
            const role = getCurrentUserRole();
            
            // 创建基本的导航结构
            const navItems = role === 'parent' ? [
                { icon: '🏠', text: '首页', onclick: 'goToParentHome()' },
                { icon: '📊', text: '学习报告', onclick: 'goToLearningReports()' },
                { icon: '👶', text: '孩子管理', onclick: 'goToChildrenManagement()' },
                { icon: '👤', text: '我的', onclick: 'goToProfile()', active: true }
            ] : [
                { icon: '🏠', text: '首页', onclick: 'goToStudentHome()' },
                { icon: '📷', text: '拍照批改', onclick: 'goToHomeworkSubmit()' },
                { icon: '📚', text: '错题本', onclick: 'goToErrorBook()' },
                { icon: '📋', text: '学习计划', onclick: 'goToStudyPlan()' },
                { icon: '👤', text: '我的', onclick: 'goToProfile()', active: true }
            ];
            
            // 创建简单的导航
            const nav = document.createElement('div');
            nav.className = role === 'parent' ? 'theme-bottom-nav' : 'global-bottom-nav';
            
            // 应用与study-plan.html一致的容器样式
            nav.style.cssText = role === 'parent' ? `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 142, 250, 0.95)) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            ` : `
                position: fixed !important;
                bottom: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding: 8px 0 6px !important;
                z-index: 9999 !important;
                display: flex !important;
            `;
            
            const itemClass = role === 'parent' ? 'theme-nav' : 'global-nav';
            nav.innerHTML = navItems.map(item => `
                <div class="${itemClass}-item ${item.active ? 'active' : ''}" ${item.onclick ? `onclick="${item.onclick}"` : ''}>
                    <div class="${itemClass}-icon">${item.icon}</div>
                    <div class="${itemClass}-text">${item.text}</div>
                </div>
            `).join('');
            
            document.body.appendChild(nav);
            
            // 应用按钮样式
            const buttons = nav.querySelectorAll(`.${itemClass}-item`);
            buttons.forEach((button, index) => {
                const isActive = button.classList.contains('active');
                
                if (role === 'parent') {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(255, 255, 255, 0.2) !important; color: white !important;' : 'background: transparent !important; color: rgba(255, 255, 255, 0.8) !important;'}
                    `;
                } else {
                    button.style.cssText = `
                        flex: 1 !important;
                        text-align: center !important;
                        padding: 6px 2px 4px !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border-radius: 12px !important;
                        margin: 0 2px !important;
                        ${isActive ? 'background: rgba(76, 175, 80, 0.1) !important; color: #4CAF50 !important;' : 'background: transparent !important; color: #666 !important;'}
                    `;
                }
                
                const icon = button.querySelector(`.${itemClass}-icon`);
                const text = button.querySelector(`.${itemClass}-text`);
                if (icon) icon.style.cssText = 'font-size: 20px !important; margin-bottom: 2px !important; display: block !important;';
                if (text) text.style.cssText = 'font-size: 10px !important; line-height: 1 !important; font-weight: 500 !important;';
            });
            
            // 根据用户角色设置页面底部间距
            const paddingValue = role === 'parent' ? '100px' : '80px'; // 家长导航上移需要更多间距
            document.body.style.paddingBottom = paddingValue;
        }
        
        function setupRoleBasedUI(role) {
            console.log('=== 设置基于角色的UI内容显示 ===');
            console.log('当前用户角色:', role);
            
            // 安全获取元素的函数
            function safeSetDisplay(selector, display, isId = false) {
                try {
                    const element = isId ? document.getElementById(selector) : document.querySelector(selector);
                    if (element) {
                        element.style.display = display;
                        console.log(`✅ 成功设置 ${selector} 显示状态为 ${display}`);
                        return true;
                    } else {
                        console.warn(`⚠️  未找到元素: ${selector}`);
                        return false;
                    }
                } catch (error) {
                    console.error(`❌ 设置 ${selector} 样式时出错:`, error);
                    return false;
                }
            }
            
            // 根据角色配置UI显示内容
            if (role === 'student') {
                console.log('🎓 配置学生身份UI...');
                
                // 显示学生相关内容
                safeSetDisplay('.student-stats', 'flex');
                safeSetDisplay('.student-functions', 'block');
                safeSetDisplay('.parent-stats', 'none');
                safeSetDisplay('.parent-functions', 'none');
                
                // 隐藏会员中心模块（学生身份不显示）
                safeSetDisplay('vipCenterItem', 'none', true);
                
            } else if (role === 'parent') {
                console.log('👨‍👩‍👧‍👦 配置家长身份UI...');
                
                // 显示家长相关内容
                safeSetDisplay('.parent-stats', 'flex');
                safeSetDisplay('.parent-functions', 'block');
                safeSetDisplay('.student-stats', 'none');
                safeSetDisplay('.student-functions', 'none');
                
                // 显示会员中心模块（家长身份显示）
                safeSetDisplay('vipCenterItem', 'block', true);
                
            } else {
                console.error('❌ 未知的用户角色:', role);
                return;
            }
            
            console.log(`✅ ${role}身份UI配置完成`);
        }

        // 导航相关功能函数 - 与底部导航组件配合使用
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        function goToProfile() {
            // 当前就是profile页面，刷新页面
            window.location.reload();
        }

        async function loadUserProfile(role, force = false) {
            // 防抖机制：避免频繁重复请求
            const now = Date.now();
            if (!force && (isLoading || (now - lastLoadTime < LOAD_DEBOUNCE_TIME))) {
                console.log('请求被防抖拦截，距上次加载:', now - lastLoadTime, 'ms');
                return;
            }
            
            // 设置加载状态
            isLoading = true;
            lastLoadTime = now;
            
            try {
                console.log('开始加载用户资料，角色:', role, '强制刷新:', force);
                
                // 确保获取最新的token - 修复家长用户网络错误问题
                token = getCurrentTokenSafe();
                console.log('📡 安全获取token结果:', token ? 'OK' : 'NONE', '用户角色:', role);
                
                // 如果是强制刷新，设置全局标记确保头像强制更新
                if (force) {
                    window.recentAvatarUpdate = true;
                    console.log('✅ 强制刷新模式，设置头像更新全局标记');
                }
                
                // 显示加载状态
                showLoadingState();
                
                // 并行请求用户信息、统计数据和VIP状态
                const requests = [];
                
                // 用户基本信息请求 - 使用 /user/profile 确保获取完整信息
                requests.push(
                    fetch(`${API_BASE}/user/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // VIP状态请求
                requests.push(
                    fetch(`${API_BASE}/user/vip-status`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                );
                
                // 统计数据请求
                if (role === 'student') {
                    requests.push(
                        fetch(`${API_BASE}/student/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                } else if (role === 'parent') {
                    requests.push(
                        fetch(`${API_BASE}/parent/dashboard`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    );
                }
                
                // 并行执行所有请求
                const responses = await Promise.all(requests);
                const [userResponse, vipStatusResponse, statsResponse] = responses;
                
                console.log('API响应状态:', {
                    user: userResponse.status,
                    vipStatus: vipStatusResponse.status,
                    stats: statsResponse?.status
                });
                
                // 处理用户信息
                if (userResponse.ok) {
                    userInfo = await userResponse.json();
                    console.log('获取到用户信息:', userInfo);
                    
                    // 特别检查学生用户的关键字段
                    if (role === 'student') {
                        console.log('📚 学生用户关键字段检查:', {
                            nickname: userInfo.nickname,
                            grade: userInfo.grade,
                            class_name: userInfo.class_name,
                            school: userInfo.school,
                            '是否包含class_name': 'class_name' in userInfo,
                            '是否包含school': 'school' in userInfo,
                            'class_name类型': typeof userInfo.class_name,
                            'school类型': typeof userInfo.school
                        });
                    }
                    
                    // 处理VIP状态数据
                    let vipStatusData = null;
                    if (vipStatusResponse.ok) {
                        vipStatusData = await vipStatusResponse.json();
                        console.log('获取到VIP状态数据:', vipStatusData);
                    } else {
                        console.error('VIP状态API调用失败:', vipStatusResponse.status, vipStatusResponse.statusText);
                        // 使用默认VIP状态数据
                        vipStatusData = {
                            is_vip: false,
                            vip_type: 'free',
                            expire_date: null,
                            remaining_days: 0,
                            daily_quota: 3,
                            remaining_quota: 3
                        };
                    }
                    
                    // 处理统计数据
                    let statsData = null;
                    if (statsResponse?.ok) {
                        statsData = await statsResponse.json();
                        console.log('获取到统计数据:', statsData);
                    } else {
                        console.error('统计数据API调用失败:', statsResponse?.status, statsResponse?.statusText);
                        // 使用默认统计数据
                        statsData = getDefaultStatsData(role);
                    }
                    
                    // 批量更新UI
                    updateUserInterface(userInfo, statsData, role, vipStatusData);
                    
                    // 更新localStorage
                    localStorage.setItem('user', JSON.stringify(userInfo));
                    
                    // 触发更新事件
                    window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
                    
                    console.log('用户资料加载完成于:', new Date().toLocaleTimeString());
                    
                } else {
                    console.error('用户信息API调用失败:', userResponse.status, userResponse.statusText);
                    showDefaultUserData();
                    return;
                }
                
            } catch (error) {
                console.error('加载用户资料失败:', error);
                showToast('加载用户资料失败，请检查网络连接');
                showDefaultUserData();
            } finally {
                isLoading = false;
                hideLoadingState();
                
                // 延迟清除全局标记，确保头像更新操作完成
                if (force && window.recentAvatarUpdate === true) {
                    setTimeout(() => {
                        if (window.recentAvatarUpdate === true) {
                            window.recentAvatarUpdate = false;
                            console.log('✅ loadUserProfile完成，清除头像更新全局标记');
                        }
                    }, 2000);
                }
            }
        }
        
        async function loadStudentStats() {
            try {
                // 确保获取最新的token
                token = getCurrentTokenSafe();
                console.log('📡 loadStudentStats获取token:', token ? 'OK' : 'NONE');
                
                const statsResponse = await fetch(`${API_BASE}/student/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('学生统计API响应状态:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('获取到学生统计:', statsData);
                    updateStudentStats(statsData);
                } else {
                    console.error('学生统计API调用失败:', statsResponse.status, statsResponse.statusText);
                    updateStudentStats({
                        daily_stats: {
                            today_corrections: 0,
                            accuracy_rate: 0,
                            study_time: 0
                        },
                        recent_homework: [],
                        error_summary: {
                            unreviewed_count: 0
                        }
                    });
                }
            } catch (error) {
                console.error('获取学生统计异常:', error);
                updateStudentStats({});
            }
        }
        
        async function loadParentStats() {
            try {
                // 确保获取最新的token
                token = getCurrentTokenSafe();
                console.log('📡 loadParentStats获取token:', token ? 'OK' : 'NONE');
                
                const statsResponse = await fetch(`${API_BASE}/parent/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('家长统计API响应状态:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    console.log('获取到家长统计:', statsData);
                    updateParentStats(statsData);
                } else {
                    console.error('家长统计API调用失败:', statsResponse.status, statsResponse.statusText);
                    updateParentStats({
                        today_stats: { homeworkCount: 0, accuracy: 0 },
                        children: [],
                        weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                    });
                }
            } catch (error) {
                console.error('获取家长统计异常:', error);
                updateParentStats({});
            }
        }

        // 加载状态管理
        function showLoadingState() {
            // 显示用户名加载状态
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = '加载中...';
                userNameEl.style.opacity = '0.6';
            }
            
            // 显示头像加载状态
            const userAvatarEl = document.getElementById('userAvatar');
            if (userAvatarEl) {
                userAvatarEl.innerHTML = '⏳';
                userAvatarEl.style.opacity = '0.6';
            }
            
            // 显示统计数据加载状态
            const statElements = document.querySelectorAll('.stat-number');
            statElements.forEach(el => {
                el.textContent = '...';
                el.style.opacity = '0.6';
            });
        }
        
        function hideLoadingState() {
            // 恢复正常透明度并添加淡入效果
            const elements = [
                document.getElementById('userName'),
                document.getElementById('userAvatar'),
                ...document.querySelectorAll('.stat-number')
            ];
            
            elements.forEach(el => {
                if (el) {
                    el.style.opacity = '1';
                    el.classList.add('fade-in');
                    
                    // 动画完成后移除类
                    setTimeout(() => {
                        el.classList.remove('fade-in');
                    }, 300);
                }
            });
        }
        
        // 获取默认统计数据
        function getDefaultStatsData(role) {
            if (role === 'student') {
                return {
                    daily_stats: {
                        today_corrections: 0,
                        accuracy_rate: 0,
                        study_time: 0
                    },
                    recent_homework: [],
                    error_summary: {
                        unreviewed_count: 0
                    }
                };
            } else if (role === 'parent') {
                return {
                    today_stats: { homeworkCount: 0, accuracy: 0 },
                    children: [],
                    weekly_report: { totalHomework: 0, avgAccuracy: 0, studyDays: 0 }
                };
            }
            return {};
        }
        
        // 批量更新UI接口
        function updateUserInterface(userInfo, statsData, role, vipStatusData) {
            // 批量更新用户信息、统计数据和VIP状态
            const updates = [];
            
            // 准备用户信息更新
            updates.push(() => updateUserProfile(userInfo));
            
            // 准备统计数据更新
            if (role === 'student') {
                updates.push(() => updateStudentStats(statsData));
            } else if (role === 'parent') {
                updates.push(() => updateParentStats(statsData));
            }
            
            // 准备VIP状态更新
            if (vipStatusData) {
                updates.push(() => updateVipCenterStatus(vipStatusData));
            }
            
            // 批量执行更新，减少重排重绘
            requestAnimationFrame(() => {
                updates.forEach(update => update());
            });
        }

        function showDefaultUserData() {
            // 显示默认的空白用户数据
            const defaultUser = {
                id: 0,
                nickname: '用户',
                role: 'student',
                grade: '未设置',
                avatar_url: null,
                is_vip: false,
                vip_expire_time: null,
                daily_quota: 0,
                daily_used: 0
            };
            
            const defaultVipStatus = {
                is_vip: false,
                vip_type: 'free',
                expire_date: null,
                remaining_days: 0,
                daily_quota: 3,
                remaining_quota: 3
            };
            
            const role = getCurrentUserRole();
            const defaultStats = getDefaultStatsData(role);
            
            updateUserInterface(defaultUser, defaultStats, role, defaultVipStatus);
        }

        function updateUserProfile(user) {
            console.log('=== 开始更新用户资料 ===');
            console.log('更新用户资料，用户数据:', user);
            
            if (!user) {
                console.error('❌ updateUserProfile: user参数为空或undefined');
                return;
            }
            
            const userNameEl = document.getElementById('userName');
            const userInfoEl = document.getElementById('userInfo');
            const userAvatarEl = document.getElementById('userAvatar');
            
            console.log('DOM元素检查:', {
                userNameEl: !!userNameEl,
                userInfoEl: !!userInfoEl,
                userAvatarEl: !!userAvatarEl
            });
            
            if (userNameEl) {
                // 根据用户角色选择不同的名称字段
                let newName = '用户';
                if (user.role === 'parent') {
                    newName = user.name || user.nickname || '家长用户';
                } else {
                    newName = user.nickname || user.name || '用户';
                }
                
                console.log('准备更新用户名从:', userNameEl.textContent, '到:', newName, '角色:', user.role);
                
                // 优化：只有在内容真的发生变化时才更新DOM
                if (userNameEl.textContent !== newName) {
                    userNameEl.textContent = newName;
                    console.log('用户名已更新为:', newName);
                } else {
                    console.log('用户名无需更新，内容相同');
                }
            } else {
                console.error('找不到userName元素！');
            }
            
            if (userInfoEl) {
                const roleText = user.role === 'student' ? '学生' : user.role === 'parent' ? '家长' : '教师';
                
                // 家长身份时只显示"家长"，不显示年级信息
                if (user.role === 'parent') {
                    userInfoEl.textContent = roleText;
                    console.log('用户信息已更新为:', roleText);
                } else {
                    // 学生和其他角色显示角色和年级
                    const gradeText = user.grade || '未设置年级';
                    userInfoEl.textContent = `${roleText} · ${gradeText}`;
                    console.log('用户信息已更新为:', `${roleText} · ${gradeText}`);
                }
            }
            
            // 更新VIP状态
            if (user.is_vip) {
                const vipCard = document.getElementById('vipCard');
                if (vipCard) {
                    vipCard.classList.add('active');
                    if (user.vip_expire_time) {
                        const expireDateEl = document.getElementById('vipExpireDate');
                        if (expireDateEl) {
                            expireDateEl.textContent = new Date(user.vip_expire_time).toLocaleDateString();
                        }
                    }
                    console.log('VIP状态已更新');
                }
            }
            
            // 更新头像 - 优化版本
            if (userAvatarEl) {
                console.log('更新头像，URL:', user.avatar_url);
                setUserAvatar(userAvatarEl, user.avatar_url);
            } else {
                console.error('找不到头像元素 userAvatar');
            }
        }

        function updateStudentStats(stats) {
            console.log('=== 更新学生统计数据 ===');
            console.log('收到的学生统计数据:', stats);
            
            // 总作业数：使用最近作业数量，这代表了近期的学习活动
            const totalHomework = stats.recent_homework ? stats.recent_homework.length : 0;
            
            // 正确率：直接从daily_stats获取，后端已经计算好的百分比（如85.5%）
            const accuracyRate = stats.daily_stats ? stats.daily_stats.accuracy_rate : 0;
            
            // 学习天数：基于累计学习时间和日均时长的合理估算
            // 根据学习时间推算累计学习天数（每天30分钟为基准）
            const studyTimeMinutes = stats.daily_stats ? stats.daily_stats.study_time : 0;
            let studyDays = 0;
            
            if (studyTimeMinutes > 0) {
                // 假设每天平均学习30分钟，计算累计天数
                const dailyAvgMinutes = 30;
                studyDays = Math.max(1, Math.ceil(studyTimeMinutes / dailyAvgMinutes));
                
                // 如果有作业记录，至少应该等于作业天数
                if (totalHomework > 0) {
                    studyDays = Math.max(studyDays, totalHomework);
                }
            }
            
            console.log('学生统计计算结果:', {
                totalHomework,
                accuracyRate,
                studyTimeMinutes,
                studyDays
            });
            
            // 更新DOM元素
            const totalHomeworkEl = document.getElementById('totalHomework');
            const accuracyRateEl = document.getElementById('accuracyRate');
            const studyDaysEl = document.getElementById('studyDays');
            
            if (totalHomeworkEl) {
                totalHomeworkEl.textContent = totalHomework;
                console.log('总作业数已更新为:', totalHomework);
            }
            
            if (accuracyRateEl) {
                accuracyRateEl.textContent = accuracyRate + '%';
                console.log('正确率已更新为:', accuracyRate + '%');
            }
            
            if (studyDaysEl) {
                studyDaysEl.textContent = studyDays;
                console.log('学习天数已更新为:', studyDays);
            }
            
            console.log('=== 学生统计数据更新完成 ===');
        }
        
        function updateParentStats(stats) {
            console.log('=== 更新家长统计数据 ===');
            console.log('收到的家长统计数据:', stats);
            
            // 孩子数量
            const childrenCount = stats.children ? stats.children.length : 0;
            
            // 今日作业数（所有孩子的总和）
            const todayHomeworkCount = stats.today_stats ? stats.today_stats.homeworkCount : 0;
            
            // 平均正确率（所有孩子的平均值）
            const averageAccuracy = stats.today_stats ? stats.today_stats.accuracy : 0;
            
            console.log('家长统计计算结果:', {
                childrenCount,
                todayHomeworkCount,
                averageAccuracy
            });
            
            // 更新DOM元素
            const childrenCountEl = document.getElementById('childrenCount');
            const todayHomeworkCountEl = document.getElementById('todayHomeworkCount');
            const averageAccuracyEl = document.getElementById('averageAccuracy');
            
            if (childrenCountEl) {
                childrenCountEl.textContent = childrenCount;
                console.log('孩子数量已更新为:', childrenCount);
            }
            
            if (todayHomeworkCountEl) {
                todayHomeworkCountEl.textContent = todayHomeworkCount;
                console.log('今日作业数已更新为:', todayHomeworkCount);
            }
            
            if (averageAccuracyEl) {
                averageAccuracyEl.textContent = averageAccuracy + '%';
                console.log('平均正确率已更新为:', averageAccuracy + '%');
            }
            
            
            console.log('=== 家长统计数据更新完成 ===');
        }
        
        // 更新会员中心状态描述 - 使用VIP状态API数据
        function updateVipCenterStatus(vipStatusData) {
            console.log('=== 更新会员中心状态描述 ===');
            console.log('VIP状态API数据:', vipStatusData);
            
            const vipStatusDescEl = document.getElementById('vipStatusDesc');
            if (!vipStatusDescEl) {
                console.log('未找到vipStatusDesc元素');
                return;
            }
            
            if (vipStatusData.is_vip && vipStatusData.expire_date) {
                // VIP用户 - 显示到期时间和剩余次数
                const daysLeft = vipStatusData.remaining_days || 0;
                const remainingQuota = vipStatusData.remaining_quota || 0;
                
                let statusText = '';
                if (daysLeft > 0) {
                    statusText = `VIP会员 · 剩余${daysLeft}天 · 今日还可用${remainingQuota}次`;
                } else {
                    statusText = 'VIP已过期 · 点击续费';
                }
                
                vipStatusDescEl.textContent = statusText;
                console.log('VIP状态描述已更新:', statusText);
                
            } else if (vipStatusData.is_vip) {
                // VIP用户但没有过期时间信息
                const remainingQuota = vipStatusData.remaining_quota || 0;
                const statusText = `VIP会员 · 今日还可用${remainingQuota}次`;
                vipStatusDescEl.textContent = statusText;
                console.log('VIP状态描述已更新:', statusText);
                
            } else {
                // 普通用户 - 显示剩余免费次数
                const remainingQuota = vipStatusData.remaining_quota || 0;
                const dailyQuota = vipStatusData.daily_quota || 3;
                
                let statusText = '';
                if (remainingQuota > 0) {
                    statusText = `免费用户 · 今日还可用${remainingQuota}次 · 升级VIP享特权`;
                } else {
                    statusText = '今日免费次数已用完 · 升级VIP无限使用';
                }
                
                vipStatusDescEl.textContent = statusText;
                console.log('普通用户状态描述已更新:', statusText);
            }
            
            console.log('=== 会员中心状态描述更新完成 ===');
        }
        
        // 优化的头像设置函数
        function setUserAvatar(element, avatarUrl, isChild = false) {
            if (!element) return;
            
            const defaultEmoji = isChild ? '👶' : '👤';
            
            if (avatarUrl && avatarUrl.startsWith('emoji:')) {
                // 表情头像 - 直接设置，无需网络请求
                const emoji = avatarUrl.replace('emoji:', '');
                element.innerHTML = emoji;
                console.log('表情头像已设置:', emoji);
                
            } else if (avatarUrl && avatarUrl.startsWith('data:image/')) {
                // base64编码的图片数据 - 直接使用，无需网络请求
                element.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML='${defaultEmoji}';">`;
                console.log('base64头像已设置');
                
            } else if (avatarUrl && (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.includes('.jpg') || avatarUrl.includes('.png'))) {
                // 图片头像 - 使用缓存，只在必要时添加时间戳
                const fullUrl = avatarUrl.startsWith('/') ? `http://localhost:8000${avatarUrl}` : avatarUrl;
                
                // 检查是否需要强制刷新（多个条件判断）
                const sessionNeedRefresh = sessionStorage.getItem('avatarUpdated') === 'true';
                const globalNeedRefresh = window.recentAvatarUpdate === true;
                const needRefresh = sessionNeedRefresh || globalNeedRefresh;
                
                let finalUrl = fullUrl;
                
                if (needRefresh) {
                    const separator = fullUrl.includes('?') ? '&' : '?';
                    finalUrl = `${fullUrl}${separator}t=${Date.now()}`;
                    console.log('强制刷新头像 (session:', sessionNeedRefresh, ', global:', globalNeedRefresh, '):', finalUrl);
                    
                    // 清除session标记，但保留全局标记供其他头像元素使用
                    if (sessionNeedRefresh) {
                        sessionStorage.removeItem('avatarUpdated');
                    }
                } else {
                    console.log('使用缓存头像:', finalUrl);
                }
                
                element.innerHTML = `<img src="${finalUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="console.error('头像加载失败:', '${fullUrl}'); this.parentElement.innerHTML='${defaultEmoji}';">`;
                
            } else {
                // 默认头像
                element.innerHTML = defaultEmoji;
                console.log('使用默认头像');
            }
        }

        
        // 错题本数量相关函数已移除

        // 头像编辑相关变量
        let selectedAvatarType = null; // 'file' 或 'default'
        let selectedFile = null;
        let selectedDefaultAvatar = null;
        
        function editAvatar() {
            console.log('editAvatar 被调用');
            
            // 显示当前头像
            const currentAvatar = document.getElementById('userAvatar').innerHTML;
            console.log('当前头像内容:', currentAvatar);
            document.getElementById('avatarPreview').innerHTML = currentAvatar;
            
            // 重置选择状态
            console.log('重置选择状态');
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
            updateSaveButton();
            
            // 显示头像编辑模态框
            console.log('显示头像编辑模态框');
            document.getElementById('avatarModal').style.display = 'flex';
            
            // 确保文件输入监听器正常工作
            setTimeout(() => {
                const avatarFileInput = document.getElementById('avatarFileInput');
                if (avatarFileInput) {
                    // 重新绑定事件监听器（防止丢失）
                    avatarFileInput.removeEventListener('change', handleFileSelect);
                    avatarFileInput.addEventListener('change', handleFileSelect);
                    console.log('模态框中的文件选择监听器已重新设置');
                }
            }, 50);
        }
        
        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            
            // 清理文件输入
            document.getElementById('avatarFileInput').value = '';
            
            // 重置选择状态
            selectedAvatarType = null;
            selectedFile = null;
            selectedDefaultAvatar = null;
        }
        
        function selectAvatarFile() {
            console.log('selectAvatarFile 被调用');
            const fileInput = document.getElementById('avatarFileInput');
            console.log('文件输入元素:', fileInput);
            
            if (fileInput) {
                try {
                    fileInput.click();
                    console.log('已触发文件选择器');
                } catch (error) {
                    console.error('触发文件选择器失败:', error);
                    showToast('文件选择器启动失败，请重试');
                }
            } else {
                console.error('找不到文件输入元素');
                showToast('文件选择功能初始化失败，请刷新页面重试');
            }
        }
        
        function selectDefaultAvatar() {
            // 生成默认头像选项
            generateDefaultAvatars();
            document.getElementById('defaultAvatarModal').style.display = 'flex';
        }
        
        function generateDefaultAvatars() {
            const avatars = ['👤', '😊', '😎', '🤔', '😄', '🥳', '🤗', '😇', '🙂', '😋', '🤓', '🧐'];
            const avatarGrid = document.getElementById('avatarGrid');
            
            avatarGrid.innerHTML = '';
            
            avatars.forEach(avatar => {
                const avatarItem = document.createElement('div');
                avatarItem.className = 'default-avatar-item';
                avatarItem.textContent = avatar;
                avatarItem.onclick = () => selectDefaultAvatarItem(avatar, avatarItem);
                avatarGrid.appendChild(avatarItem);
            });
        }
        
        function selectDefaultAvatarItem(avatar, element) {
            // 清除之前的选择
            document.querySelectorAll('.default-avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 选择当前项
            element.classList.add('selected');
            selectedDefaultAvatar = avatar;
            selectedAvatarType = 'default';
            
            // 更新预览
            document.getElementById('avatarPreview').innerHTML = avatar;
            
            // 关闭默认头像选择模态框
            setTimeout(() => {
                document.getElementById('defaultAvatarModal').style.display = 'none';
                updateSaveButton();
            }, 300);
        }
        
        function closeDefaultAvatarModal() {
            document.getElementById('defaultAvatarModal').style.display = 'none';
        }
        
        // 文件选择事件监听将在initPage中设置
        
        function handleFileSelect(event) {
            console.log('handleFileSelect 被调用');
            const file = event.target.files[0];
            
            console.log('选择的文件:', file);
            if (!file) {
                console.log('没有选择文件');
                return;
            }
            
            console.log('文件信息:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            
            // 验证文件类型
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                console.log('文件类型不匹配:', file.type);
                showToast('请选择JPG或PNG格式的图片');
                return;
            }
            
            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                console.log('文件太大:', file.size);
                showToast('图片文件不能超过5MB');
                return;
            }
            
            console.log('文件验证通过，设置selectedFile');
            selectedFile = file;
            selectedAvatarType = 'file';
            console.log('设置后的状态:', { selectedAvatarType, selectedFile: selectedFile?.name });
            
            // 显示文件预览
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('文件读取完成，更新预览');
                const previewContainer = document.getElementById('avatarPreview');
                console.log('预览容器:', previewContainer);
                
                if (previewContainer) {
                    previewContainer.innerHTML = 
                        `<img src="${e.target.result}" alt="头像预览" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    console.log('预览图片已设置');
                } else {
                    console.error('找不到预览容器 avatarPreview');
                }
                updateSaveButton();
            };
            reader.onerror = function(e) {
                console.error('文件读取失败:', e);
                showToast('图片预览失败，请重新选择');
            };
            reader.readAsDataURL(file);
        }
        
        function updateSaveButton() {
            console.log('updateSaveButton 被调用');
            const saveBtn = document.getElementById('saveAvatarBtn');
            console.log('保存按钮元素:', saveBtn);
            console.log('当前selectedAvatarType:', selectedAvatarType);
            
            if (selectedAvatarType) {
                console.log('启用保存按钮');
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                console.log('禁用保存按钮');
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }
        
        async function saveAvatar() {
            console.log('=== saveAvatar 开始执行 ===');
            
            // 确保获取最新的token
            token = getCurrentTokenSafe();
            
            console.log('当前状态检查:', { 
                selectedAvatarType, 
                selectedFile: selectedFile?.name, 
                selectedDefaultAvatar,
                token: token ? `存在(${token.substring(0, 20)}...)` : '缺失'
            });
            
            if (!selectedAvatarType) {
                console.log('❌ 没有选择头像类型');
                showToast('请先选择头像');
                return;
            }
            
            if (!token) {
                console.log('❌ Token缺失');
                showToast('登录状态已失效，请重新登录');
                setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                return;
            }
            
            const saveBtn = document.getElementById('saveAvatarBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // 更新按钮状态
                saveBtn.textContent = '保存中...';
                saveBtn.disabled = true;
                
                console.log('✅ 开始保存头像，类型:', selectedAvatarType);
                
                let response;
                
                if (selectedAvatarType === 'file') {
                    console.log('📁 处理文件上传');
                    
                    if (!selectedFile) {
                        throw new Error('没有选择文件');
                    }
                    
                    console.log('文件信息:', {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type
                    });
                    
                    // 创建FormData
                    const formData = new FormData();
                    formData.append('avatar_file', selectedFile);
                    
                    console.log('🚀 发送文件上传请求...');
                    response = await fetch(`${API_BASE}/user/upload-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                } else if (selectedAvatarType === 'default') {
                    console.log('😊 处理默认头像设置');
                    console.log('选中的表情:', selectedDefaultAvatar);
                    
                    if (!selectedDefaultAvatar) {
                        throw new Error('没有选择默认头像');
                    }
                    
                    console.log('🚀 发送默认头像设置请求...');
                    response = await fetch(`${API_BASE}/user/set-default-avatar`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            avatar_emoji: selectedDefaultAvatar
                        })
                    });
                }
                
                console.log('📡 服务器响应:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ 头像更新成功:', result);
                    
                    showToast('头像更新成功');
                    closeAvatarModal();
                    
                    
                    // 设置头像更新标记，下次加载时会强制刷新缓存
                    sessionStorage.setItem('avatarUpdated', 'true');
                    
                    // 设置全局标记，确保所有用户角色的头像都能强制刷新
                    window.recentAvatarUpdate = true;
                    console.log('✅ 设置头像更新全局标记');
                    
                    // 立即更新localStorage中的用户信息
                    console.log('🔄 立即更新localStorage和全局用户信息...');
                    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                    
                    // 根据不同的API响应结构获取头像URL
                    let newAvatarUrl = null;
                    if (selectedAvatarType === 'file' && result.avatar_url) {
                        // 文件上传的响应结构：{ avatar_url, message, uploaded_at }
                        newAvatarUrl = result.avatar_url;
                        console.log('📁 从文件上传响应获取头像URL:', newAvatarUrl);
                    } else if (selectedAvatarType === 'default' && result.avatar_emoji) {
                        // 默认头像的响应结构：{ avatar_emoji, message, updated_at }
                        newAvatarUrl = `emoji:${result.avatar_emoji}`;
                        console.log('😊 从默认头像响应构造头像URL:', newAvatarUrl);
                    } else {
                        console.error('❌ 无法从API响应中获取头像信息:', { selectedAvatarType, result });
                    }
                    
                    if (newAvatarUrl) {
                        currentUser.avatar_url = newAvatarUrl;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        
                        // 更新全局userInfo变量
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            userInfo.avatar_url = newAvatarUrl;
                            console.log('✅ 全局userInfo头像已更新:', newAvatarUrl);
                        }
                        
                        // 立即更新主页面上的头像显示
                        console.log('🖼️ 立即更新主页面头像显示...');
                        immediateUpdateAvatarDisplay(newAvatarUrl);
                    } else {
                        console.error('❌ 无法更新头像，newAvatarUrl为空');
                    }
                    
                    // 重新加载用户资料以更新头像显示（作为备用保障）
                    console.log('🔄 重新加载用户资料');
                    const currentRole = AuthUtils.getCurrentUserRole() || 'student';
                    setTimeout(() => loadUserProfile(currentRole, true), 500); // 延迟一点时间确保服务器已经处理完毕，强制刷新
                } else {
                    // 处理HTTP错误
                    const responseText = await response.text();
                    console.error('❌ API响应失败:', {
                        status: response.status,
                        statusText: response.statusText,
                        responseText
                    });
                    
                    let errorMessage = '头像更新失败';
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        console.log('响应不是JSON格式:', responseText);
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // 特殊状态码处理
                    if (response.status === 401) {
                        errorMessage = '登录已过期，请重新登录';
                        setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                    } else if (response.status === 403) {
                        errorMessage = '没有权限执行此操作';
                    } else if (response.status === 413) {
                        errorMessage = '文件过大，请选择小于5MB的图片';
                    } else if (response.status === 400) {
                        errorMessage = errorMessage || '请求参数错误，请检查文件格式';
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('❌ 保存头像异常:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                let userMessage = '头像更新失败，请重试';
                
                // 网络错误处理
                if (error.name === 'NetworkError' || error.message.includes('fetch')) {
                    userMessage = '网络连接失败，请检查网络后重试';
                } else if (error.message.includes('登录') || error.message.includes('401')) {
                    userMessage = '登录已过期，请重新登录';
                    setTimeout(() => window.location.href = '/frontend/login.html', 2000);
                } else if (error.message) {
                    userMessage = error.message;
                }
                
                showToast(userMessage);
                
            } finally {
                // 恢复按钮状态
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                console.log('🔄 按钮状态已恢复');
            }
            
            console.log('=== saveAvatar 执行完成 ===');
        }

        function editProfile() {
            console.log('editProfile 被调用');
            
            // 获取用户角色
            const role = AuthUtils.getCurrentUserRole();
            console.log('当前用户角色:', role);
            
            // 根据角色生成不同的表单内容
            generateEditForm(role);
            
            // 显示编辑个人资料模态框
            document.getElementById('editProfileModal').style.display = 'flex';
            
            // 获取最新的用户信息并填充表单
            refreshUserInfoAndFillForm(role);
        }
        
        async function refreshUserInfoAndFillForm(role) {
            console.log('=== 获取最新用户信息并填充表单 ===');
            
            try {
                // 首先尝试从localStorage获取最新数据
                const storedUser = localStorage.getItem('user');
                let latestUserInfo = userInfo; // 默认使用当前的userInfo
                
                if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        if (parsedUser && parsedUser.avatar_url !== userInfo?.avatar_url) {
                            console.log('localStorage中发现更新的用户信息，使用最新数据');
                            latestUserInfo = parsedUser;
                            userInfo = parsedUser; // 同步全局变量
                        }
                    } catch (error) {
                        console.error('解析localStorage用户信息失败:', error);
                    }
                }
                
                // 🚨 家长用户特殊处理：检查头像是否有更新 🚨
                if (role === 'parent') {
                    console.log('👨‍👩‍👧‍👦 家长用户编辑个人资料，检查头像更新状态...');
                    
                    // 检查是否有头像更新标记
                    const avatarUpdated = sessionStorage.getItem('avatarUpdated');
                    if (avatarUpdated === 'true') {
                        console.log('🔄 检测到头像已更新，强制从localStorage刷新数据');
                        
                        // 强制从localStorage获取最新数据
                        if (storedUser) {
                            const refreshedUser = JSON.parse(storedUser);
                            latestUserInfo = refreshedUser;
                            userInfo = refreshedUser;
                            console.log('✅ 家长用户数据强制刷新完成，头像URL:', refreshedUser.avatar_url);
                        }
                        
                        // 清除标记
                        sessionStorage.removeItem('avatarUpdated');
                    }
                }
                
                // 如果有用户信息，填充表单
                if (latestUserInfo) {
                    console.log('使用用户信息填充表单:', latestUserInfo);
                    fillFormData(role, latestUserInfo);
                    
                    
                } else {
                    console.warn('没有可用的用户信息');
                    // 尝试从API获取最新信息
                    await fetchLatestUserInfo(role);
                }
                
            } catch (error) {
                console.error('获取用户信息失败:', error);
                // 使用现有的userInfo作为后备
                if (userInfo) {
                    fillFormData(role, userInfo);
                }
            }
        }
        
        async function fetchLatestUserInfo(role) {
            console.log('从API获取最新用户信息');
            
            try {
                // 确保获取最新的token
                token = getCurrentTokenSafe();
                console.log('📡 fetchLatestUserInfo获取token:', token ? 'OK' : 'NONE');
                
                const response = await fetch(`${API_BASE}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const latestUser = await response.json();
                    console.log('从API获取到最新用户信息:', latestUser);
                    
                    // 更新全局用户信息
                    userInfo = latestUser;
                    localStorage.setItem('user', JSON.stringify(latestUser));
                    
                    // 填充表单
                    fillFormData(role, latestUser);
                } else {
                    console.error('API获取用户信息失败:', response.status);
                    // 使用现有信息
                    if (userInfo) {
                        fillFormData(role, userInfo);
                    }
                }
            } catch (error) {
                console.error('API请求失败:', error);
                // 使用现有信息
                if (userInfo) {
                    fillFormData(role, userInfo);
                }
            }
        }
        
        function generateEditForm(role) {
            console.log('=== 生成编辑表单 ===');
            const form = document.getElementById('editProfileForm');
            
            if (role === 'parent') {
                // 家长用户表单：名称、手机号、邮箱
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">姓名 <span style="color: red;">*</span></label>
                        <input type="text" class="form-input" id="editName" placeholder="请输入姓名" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">手机号 <span style="color: red;">*</span></label>
                        <input type="tel" class="form-input" id="editPhone" placeholder="请输入手机号" maxlength="11" pattern="[0-9]{1,11}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">邮箱 <span style="color: red;">*</span></label>
                        <input type="email" class="form-input" id="editEmail" placeholder="请输入邮箱" required>
                        <div class="form-error" id="emailError" style="display: none; color: #ff3b30; font-size: 12px; margin-top: 4px;"></div>
                    </div>
                    <!-- 固定在底部的按钮区域 -->
                    <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                        <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">取消</button>
                        <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">保存</button>
                    </div>
                `;
            } else {
                // 学生用户表单：昵称、年级、班级、学校
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">昵称 <span style="color: red;">*</span></label>
                        <input type="text" class="form-input" id="editNickname" placeholder="请输入昵称" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">年级 <span style="color: red;">*</span></label>
                        <select class="form-input" id="editGrade" required>
                            <option value="">请选择年级</option>
                            <option value="一年级">一年级</option>
                            <option value="二年级">二年级</option>
                            <option value="三年级">三年级</option>
                            <option value="四年级">四年级</option>
                            <option value="五年级">五年级</option>
                            <option value="六年级">六年级</option>
                            <option value="七年级">七年级</option>
                            <option value="八年级">八年级</option>
                            <option value="九年级">九年级</option>
                            <option value="高一">高一</option>
                            <option value="高二">高二</option>
                            <option value="高三">高三</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">班级 <span style="color: red;">*</span></label>
                        <select class="form-input" id="editClass" required>
                            <option value="">请先选择年级</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">学校</label>
                        <input type="text" class="form-input" id="editSchool" placeholder="请输入学校名称">
                    </div>
                    <!-- 固定在底部的按钮区域 -->
                    <div class="modal-actions" style="position: sticky; bottom: 0; background: white; z-index: 1001; margin-top: 24px; padding: 16px 0; border-top: 1px solid #eee;">
                        <button type="button" class="modal-btn cancel-btn" onclick="closeEditProfileModal()">取消</button>
                        <button type="submit" class="modal-btn confirm-btn" style="background: #007AFF; color: white;">保存</button>
                    </div>
                `;
                
                // 学生用户需要初始化年级-班级联动
                setTimeout(() => {
                    initEditProfileGradeClassBinding();
                }, 50);
            }
            
            // 如果是家长用户，添加实时邮箱验证
            if (role === 'parent') {
                console.log('家长用户表单，开始设置邮箱验证（增强版）...');
                
                // 立即尝试设置验证
                setupParentEmailValidation();
                
                // 为确保万无一失，在下一个事件循环中再次尝试
                setTimeout(() => {
                    console.log('🔄 延迟验证绑定检查');
                    setupParentEmailValidation();
                }, 0);
            }
            
            console.log(`✅ ${role === 'parent' ? '家长' : '学生'}编辑表单生成完成`);
        }
        
        function fillFormData(role, userInfo) {
            console.log('=== 填充表单数据 ===', { role, userInfo });
            
            if (role === 'parent') {
                // 家长用户数据填充
                document.getElementById('editName').value = userInfo.name || userInfo.nickname || '';
                document.getElementById('editPhone').value = userInfo.phone || '';
                document.getElementById('editEmail').value = userInfo.email || '';
            } else {
                // 学生用户数据填充
                // 首先从settings中提取class_name和school（如果存在）
                let extractedClassname = userInfo.class_name;
                let extractedSchool = userInfo.school;
                
                if (userInfo.settings) {
                    console.log('从settings中提取数据:', userInfo.settings);
                    if (userInfo.settings.class_name !== undefined) {
                        extractedClassname = userInfo.settings.class_name;
                    }
                    if (userInfo.settings.school !== undefined) {
                        extractedSchool = userInfo.settings.school;
                    }
                }
                
                console.log('🎓 学生字段详细检查:', {
                    nickname: userInfo.nickname,
                    grade: userInfo.grade,
                    class_name: extractedClassname,
                    school: extractedSchool,
                    '完整userInfo': userInfo,
                    '从settings提取': {
                        class_name: extractedClassname,
                        school: extractedSchool
                    }
                });
                
                document.getElementById('editNickname').value = userInfo.nickname || '';
                document.getElementById('editGrade').value = userInfo.grade || '';
                document.getElementById('editSchool').value = extractedSchool || '';
                
                console.log('✅ 表单字段设置完成:', {
                    nickname: document.getElementById('editNickname').value,
                    grade: document.getElementById('editGrade').value,
                    school: document.getElementById('editSchool').value
                });
                
                // 处理年级-班级联动
                const gradeSelect = document.getElementById('editGrade');
                const classSelect = document.getElementById('editClass');
                
                if (userInfo.grade) {
                    updateClassOptions(userInfo.grade, classSelect);
                    
                    // 设置班级值 - 增加延迟确保select选项已生成
                    if (extractedClassname !== undefined) {
                        setTimeout(() => {
                            console.log('🏫 设置班级字段前:', {
                                'extractedClassname': extractedClassname,
                                'classSelect可用选项': Array.from(classSelect.options).map(o => o.value),
                                'classSelect元素存在': !!classSelect
                            });
                            
                            classSelect.value = extractedClassname || '';
                            
                            console.log('🏫 设置班级字段后:', {
                                '设置的值': extractedClassname,
                                '实际值': classSelect.value,
                                '是否匹配': classSelect.value === (extractedClassname || '')
                            });
                        }, 200);
                    } else {
                        console.log('⚠️ extractedClassname 未定义或为空');
                    }
                } else {
                    classSelect.innerHTML = '<option value="">请先选择年级</option>';
                }
            }
        }
        
        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
            
            // 重置表单（如果表单存在）
            const form = document.getElementById('editProfileForm');
            if (form) {
                form.reset();
            }
            
        }

        async function saveProfile() {
            console.log('=== saveProfile() 函数开始执行 ===');
            
            // 获取当前用户角色
            const role = AuthUtils.getCurrentUserRole();
            console.log('当前用户角色:', role);
            
            let requestData = {};
            let validationResult = {};
            
            if (role === 'parent') {
                console.log('🔧 处理家长用户表单提交...');
                
                // 直接获取表单字段值，简化流程
                const nameEl = document.getElementById('editName');
                const phoneEl = document.getElementById('editPhone');
                const emailEl = document.getElementById('editEmail');
                
                console.log('📋 表单元素检查:', {
                    name: !!nameEl,
                    phone: !!phoneEl, 
                    email: !!emailEl
                });
                
                if (!nameEl || !phoneEl || !emailEl) {
                    console.error('❌ 表单元素缺失');
                    showToast('表单初始化失败，请重试');
                    return;
                }
                
                const name = nameEl.value.trim();
                const phone = phoneEl.value.trim();
                const email = emailEl.value.trim();
                
                console.log('📝 获取的表单数据:', { name, phone, email });
                
                // 基本验证
                if (!name) {
                    showToast('请输入姓名');
                    return;
                }
                if (!phone) {
                    showToast('请输入手机号');
                    return;
                }
                if (!email) {
                    showToast('请输入邮箱');
                    return;
                }
                
                // 简单的邮箱格式验证
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('请输入正确的邮箱格式');
                    return;
                }
                
                requestData = {
                    name: name,
                    phone: phone,
                    email: email
                };
                
                validationResult = { 
                    valid: true, 
                    data: { name, phone, email }
                };
                
            } else {
                // 学生用户的表单处理
                validationResult = validateStudentForm();
                if (!validationResult.valid) {
                    showToast(validationResult.message);
                    return;
                }
                
                requestData = {
                    nickname: validationResult.data.nickname,
                    grade: validationResult.data.grade,
                    class_name: validationResult.data.classValue,
                    school: validationResult.data.school
                };
            }
            
            console.log('🚀 最终请求数据:', requestData);
            
            try {
                console.log('=== 开始发送更新请求 ===');
                
                // 确保获取最新的token
                token = getCurrentTokenSafe();
                console.log('📡 saveProfile获取token:', token ? 'OK' : 'NONE');
                
                // 统一使用 /user/profile 端点
                const apiEndpoint = `${API_BASE}/user/profile`;
                console.log('API端点:', apiEndpoint, '角色:', role);
                
                const response = await fetch(apiEndpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('API响应状态:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ 个人资料更新成功:', result);
                    
                    // 针对不同角色的更新逻辑
                    if (role === 'parent' && requestData.name) {
                        console.log('🔄 立即更新家长姓名显示...');
                        
                        // 1. 更新页面显示
                        const userNameElement = document.getElementById('userName');
                        if (userNameElement) {
                            userNameElement.textContent = requestData.name;
                            console.log('✅ 页面姓名更新为:', requestData.name);
                            
                            // 简单的视觉反馈
                            userNameElement.style.backgroundColor = '#4CAF50';
                            userNameElement.style.color = 'white';
                            userNameElement.style.padding = '2px 6px';
                            userNameElement.style.borderRadius = '4px';
                            
                            setTimeout(() => {
                                userNameElement.style.backgroundColor = '';
                                userNameElement.style.color = '';
                                userNameElement.style.padding = '';
                                userNameElement.style.borderRadius = '';
                            }, 1000);
                        }
                        
                        // 2. 更新localStorage
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        currentUser.name = requestData.name;
                        currentUser.nickname = requestData.name;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('✅ 家长localStorage更新完成');
                        
                        // 3. 更新全局userInfo
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            userInfo.name = requestData.name;
                            userInfo.nickname = requestData.name;
                            console.log('✅ 家长全局userInfo更新完成');
                        }
                    } else if (role === 'student') {
                        console.log('🔄 立即更新学生信息显示...');
                        
                        // 1. 更新localStorage - 确保学生信息正确保存
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        if (requestData.nickname !== undefined) currentUser.nickname = requestData.nickname;
                        if (requestData.grade !== undefined) currentUser.grade = requestData.grade;
                        if (requestData.class_name !== undefined) currentUser.class_name = requestData.class_name;
                        if (requestData.school !== undefined) currentUser.school = requestData.school;
                        
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('✅ 学生localStorage更新完成:', {
                            nickname: requestData.nickname,
                            grade: requestData.grade,
                            class_name: requestData.class_name,
                            school: requestData.school
                        });
                        
                        // 2. 更新全局userInfo
                        if (typeof userInfo === 'object' && userInfo !== null) {
                            if (requestData.nickname !== undefined) userInfo.nickname = requestData.nickname;
                            if (requestData.grade !== undefined) userInfo.grade = requestData.grade;
                            if (requestData.class_name !== undefined) userInfo.class_name = requestData.class_name;
                            if (requestData.school !== undefined) userInfo.school = requestData.school;
                            console.log('✅ 学生全局userInfo更新完成');
                        }
                        
                        // 3. 立即更新页面所有显示元素
                        console.log('🎨 开始更新学生页面显示...');
                        
                        // 3.1 更新用户名/昵称显示
                        const userNameElement = document.getElementById('userName');
                        if (userNameElement && requestData.nickname) {
                            const oldName = userNameElement.textContent;
                            if (oldName !== requestData.nickname) {
                                userNameElement.textContent = requestData.nickname;
                                console.log('✅ 学生页面昵称更新:', oldName, '->', requestData.nickname);
                            }
                        }
                        
                        // 3.2 更新用户信息显示（角色·年级）
                        const userInfoElement = document.getElementById('userInfo');
                        if (userInfoElement && requestData.grade) {
                            const gradeText = requestData.grade;
                            const newUserInfo = `学生 · ${gradeText}`;
                            const oldUserInfo = userInfoElement.textContent;
                            if (oldUserInfo !== newUserInfo) {
                                userInfoElement.textContent = newUserInfo;
                                console.log('✅ 学生页面信息更新:', oldUserInfo, '->', newUserInfo);
                            }
                        }
                        
                        // 3.3 更新头像显示（如果头像有变化）
                        if (requestData.avatar_url) {
                            console.log('🖼️ 更新学生头像显示...');
                            if (typeof updateAvatarDisplayInProfile === 'function') {
                                updateAvatarDisplayInProfile(currentUser);
                                console.log('✅ 学生头像显示已更新');
                            } else {
                                // 备用头像更新逻辑
                                const userAvatarElement = document.getElementById('userAvatar');
                                if (userAvatarElement) {
                                    if (requestData.avatar_url.startsWith('emoji:')) {
                                        const emoji = requestData.avatar_url.replace('emoji:', '');
                                        userAvatarElement.innerHTML = emoji;
                                    } else if (requestData.avatar_url.startsWith('data:') || requestData.avatar_url.startsWith('http')) {
                                        userAvatarElement.innerHTML = `<img src="${requestData.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="用户头像">`;
                                    }
                                    console.log('✅ 学生头像备用更新完成');
                                }
                            }
                        }
                        
                        console.log('🎉 学生页面显示更新完成');
                    }
                    
                    // 通用的更新逻辑 - 仅在API返回完整数据时才覆盖
                    if (result && result.user && Object.keys(result.user).length > 1) {
                        console.log('API返回了完整用户数据，执行通用更新');
                        // 如果API返回了用户数据，合并更新本地存储（保持现有数据优先）
                        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                        const updatedUser = { ...currentUser, ...result.user };
                        localStorage.setItem('user', JSON.stringify(updatedUser));
                        userInfo = updatedUser;
                        console.log('✅ 通用更新完成，最终用户数据:', updatedUser);
                    } else {
                        console.log('API返回数据不完整，保持当前手动设置的数据');
                    }
                    
                    showToast('个人资料更新成功');
                    
                    // 简单延时后关闭模态框
                    setTimeout(() => {
                        closeEditProfileModal();
                    }, 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error('API错误响应:', errorText);
                    
                    let errorMessage = '更新失败';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.detail || error.message || '更新失败';
                    } catch (e) {
                        errorMessage = errorText || '更新失败';
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('更新个人资料失败:', error);
                console.error('错误类型:', error.constructor.name);
                console.error('错误堆栈:', error.stack);
                showToast('更新失败: ' + (error.message || '网络错误'));
            }
        }
        
        // 高级调试和监控功能 - 增强的错误追踪和性能监控
        function setupAdvancedDebugging() {
            console.log('🔧 设置高级调试监控...');
            
            // 监控页面姓名显示变化
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                console.log('👀 设置姓名变化监控器');
                let lastNameValue = userNameEl.textContent;
                
                const nameObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const currentName = userNameEl.textContent;
                            if (currentName !== lastNameValue) {
                                console.log('🔄 检测到姓名变化:', lastNameValue, '→', currentName);
                                lastNameValue = currentName;
                                
                                // 验证localStorage是否同步
                                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                                if (storedUser.name && storedUser.name !== currentName) {
                                    console.warn('⚠️ 姓名显示与localStorage不一致');
                                    console.log('显示:', currentName, 'localStorage:', storedUser.name);
                                }
                            }
                        }
                    });
                });
                
                nameObserver.observe(userNameEl, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
                
                console.log('✅ 姓名变化监控器已设置');
            }
            
            // 监控localStorage变化
            let originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'user') {
                    try {
                        const userData = JSON.parse(value);
                        console.log('💾 localStorage用户数据更新:', {
                            name: userData.name,
                            nickname: userData.nickname,
                            avatar_url: userData.avatar_url ? '已设置' : '未设置'
                        });
                        
                        // 如果是家长用户，特别关注姓名更新
                        if (userData.role === 'parent' && userData.name) {
                            console.log('👨‍👩‍👧‍👦 家长localStorage姓名更新为:', userData.name);
                        }
                    } catch (e) {
                        console.log('💾 localStorage数据更新（非JSON）');
                    }
                }
                return originalSetItem.call(this, key, value);
            };
            
            console.log('✅ localStorage监控已设置');
        }
        
        // 强化的用户资料同步检查函数
        function performUserProfileSyncCheck() {
            console.log('🔍 执行用户资料同步检查...');
            
            const role = AuthUtils.getCurrentUserRole();
            const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
            const displayedName = document.getElementById('userName')?.textContent;
            
            console.log('同步检查结果:', {
                role: role,
                storedName: storedUser.name || storedUser.nickname,
                displayedName: displayedName,
                isParent: role === 'parent',
                isConsistent: (storedUser.name || storedUser.nickname) === displayedName
            });
            
            // 如果是家长用户且数据不一致，执行修复
            if (role === 'parent' && storedUser.name && displayedName !== storedUser.name) {
                console.log('🔧 检测到家长用户数据不一致，执行修复...');
                
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    const oldName = userNameEl.textContent;
                    userNameEl.textContent = storedUser.name;
                    console.log('✅ 修复家长姓名显示:', oldName, '→', storedUser.name);
                    
                    // 添加修复成功的视觉提示
                    userNameEl.style.backgroundColor = '#e3f2fd';
                    userNameEl.style.transition = 'background-color 0.3s ease';
                    setTimeout(() => {
                        userNameEl.style.backgroundColor = '';
                    }, 800);
                }
            }
            
            return {
                isConsistent: (storedUser.name || storedUser.nickname) === displayedName,
                role: role,
                expectedName: storedUser.name || storedUser.nickname,
                actualName: displayedName
            };
        }
        
        // 智能重试机制 - 确保更新成功
        function ensureUserProfileUpdateSuccess(maxRetries = 3) {
            console.log('🔄 启动智能重试机制，确保用户资料更新成功...');
            
            let retryCount = 0;
            
            function checkAndRetry() {
                const syncResult = performUserProfileSyncCheck();
                
                if (syncResult.isConsistent) {
                    console.log('✅ 用户资料同步检查通过，无需重试');
                    return true;
                }
                
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`🔄 第${retryCount}次重试修复用户资料显示...`);
                    
                    // 重新执行用户资料更新逻辑
                    const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                    if (storedUser) {
                        updateUserProfile(storedUser);
                        updateAvatarDisplayInProfile(storedUser);
                        
                        // 延迟再次检查
                        setTimeout(() => {
                            checkAndRetry();
                        }, 500);
                    }
                } else {
                    console.warn('⚠️ 重试次数已达上限，用户资料可能存在显示问题');
                }
            }
            
            // 开始检查
            setTimeout(checkAndRetry, 100);
        }
        
        // 高级调试函数 - 完整的系统状态检查
        window.performSystemDiagnostics = function() {
            console.log('=== 🏥 系统诊断开始 ===');
            
            const role = AuthUtils.getCurrentUserRole();
            const token = AuthUtils.getCurrentToken();
            const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
            const userNameEl = document.getElementById('userName');
            const editModal = document.getElementById('editProfileModal');
            
            const diagnosticResults = {
                authentication: {
                    role: role,
                    hasToken: !!token,
                    tokenValid: token && token.length > 20
                },
                userData: {
                    hasStoredUser: !!storedUser && Object.keys(storedUser).length > 0,
                    storedName: storedUser.name || storedUser.nickname,
                    storedEmail: storedUser.email,
                    storedAvatar: !!storedUser.avatar_url
                },
                pageElements: {
                    userNameElement: !!userNameEl,
                    displayedName: userNameEl?.textContent,
                    editModal: !!editModal,
                    modalVisible: editModal?.style.display === 'flex'
                },
                consistency: {
                    nameMatch: (storedUser.name || storedUser.nickname) === userNameEl?.textContent,
                    roleConsistent: role === storedUser.role
                },
                emailValidation: {
                    emailInputExists: !!document.getElementById('editEmail'),
                    validationBound: document.getElementById('editEmail')?.hasAttribute('data-validation-bound'),
                    errorElementExists: !!document.getElementById('emailError')
                }
            };
            
            console.log('📊 诊断结果:', diagnosticResults);
            
            // 检查问题并提供修复建议
            const issues = [];
            
            if (!diagnosticResults.consistency.nameMatch && role === 'parent') {
                issues.push('家长姓名显示不一致');
            }
            
            if (role === 'parent' && !diagnosticResults.emailValidation.validationBound) {
                issues.push('邮箱验证未正确绑定');
            }
            
            if (!diagnosticResults.authentication.tokenValid) {
                issues.push('认证令牌可能无效');
            }
            
            if (issues.length > 0) {
                console.warn('⚠️ 发现问题:', issues);
                return { success: false, issues: issues, diagnostics: diagnosticResults };
            } else {
                console.log('✅ 系统状态良好');
                return { success: true, issues: [], diagnostics: diagnosticResults };
            }
        };
        
        console.log('💡 调试提示：可在控制台运行 performSystemDiagnostics() 进行完整系统检查');
        
        // 设置家长用户邮箱实时验证 - 增强版
        function setupParentEmailValidation() {
            console.log('=== 设置家长用户邮箱验证（增强版） ===');
            
            // 立即尝试绑定
            if (attemptEmailValidationBinding()) {
                console.log('✅ 邮箱验证成功绑定');
                return;
            }
            
            // 如果立即绑定失败，使用 MutationObserver 监听 DOM 变化
            console.log('🔄 DOM元素尚未就绪，启动MutationObserver监听...');
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // 检查新添加的节点中是否包含我们需要的元素
                        const emailEl = document.getElementById('editEmail');
                        if (emailEl && !emailEl.hasAttribute('data-validation-bound')) {
                            console.log('📧 通过MutationObserver检测到邮箱输入框，立即绑定验证');
                            if (attemptEmailValidationBinding()) {
                                observer.disconnect(); // 成功绑定后停止观察
                                console.log('✅ 邮箱验证绑定成功，停止MutationObserver');
                            }
                        }
                    }
                });
            });
            
            // 开始观察整个 body 的变化
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // 设置超时，避免无限等待
            setTimeout(() => {
                observer.disconnect();
                console.log('⏰ MutationObserver超时，停止监听');
                
                // 最后一次尝试
                if (!attemptEmailValidationBinding()) {
                    console.error('❌ 最终尝试绑定邮箱验证失败');
                }
            }, 3000);
        }
        
        // 尝试绑定邮箱验证的具体实现
        function attemptEmailValidationBinding() {
            const emailEl = document.getElementById('editEmail');
            const emailError = document.getElementById('emailError');
            
            console.log('🔍 尝试绑定邮箱验证:', {
                emailEl: !!emailEl,
                emailError: !!emailError,
                alreadyBound: emailEl ? emailEl.hasAttribute('data-validation-bound') : false
            });
            
            if (!emailEl || !emailError) {
                console.log('❌ 关键元素缺失，跳过绑定');
                return false;
            }
            
            // 检查是否已经绑定过
            if (emailEl.hasAttribute('data-validation-bound')) {
                console.log('⚠️ 邮箱验证已经绑定过，跳过重复绑定');
                return true;
            }
            
            console.log('✅ 开始绑定邮箱验证事件');
            
            // 标记已绑定，避免重复绑定
            emailEl.setAttribute('data-validation-bound', 'true');
            
            // 绑定输入事件
            emailEl.addEventListener('input', function(e) {
                console.log('📧 邮箱输入事件触发:', e.target.value);
                validateEmailRealTime(this.value.trim(), emailError);
                // 立即添加视觉反馈
                if (e.target.value.trim()) {
                    e.target.style.backgroundColor = '#fff9c4'; // 淡黄色背景表示正在验证
                }
            });
            
            // 绑定失去焦点事件
            emailEl.addEventListener('blur', function(e) {
                console.log('📧 邮箱失去焦点事件触发:', e.target.value);
                validateEmailRealTime(this.value.trim(), emailError);
                // 恢复背景色
                e.target.style.backgroundColor = '';
            });
            
            // 绑定粘贴事件
            emailEl.addEventListener('paste', function(e) {
                console.log('📧 邮箱粘贴事件触发');
                setTimeout(() => {
                    validateEmailRealTime(this.value.trim(), emailError);
                }, 10);
            });
            
            // 立即验证当前值（如果有的话）
            const currentValue = emailEl.value.trim();
            if (currentValue) {
                console.log('📧 发现现有邮箱值，立即验证:', currentValue);
                validateEmailRealTime(currentValue, emailError);
            }
            
            console.log('✅ 邮箱验证事件绑定完成');
            return true;
        }
        
        // 调试和测试函数 - 可在浏览器控制台调用
        window.testEmailValidation = function() {
            console.log('=== 邮箱验证测试开始 ===');
            
            const emailEl = document.getElementById('editEmail');
            const emailError = document.getElementById('emailError');
            
            if (!emailEl || !emailError) {
                console.error('❌ 测试失败：找不到必要的DOM元素');
                console.log('editEmail元素:', !!emailEl);
                console.log('emailError元素:', !!emailError);
                return false;
            }
            
            console.log('✅ DOM元素检查通过');
            
            // 测试用例
            const testCases = [
                { email: '', expected: false, desc: '空邮箱' },
                { email: 'invalid', expected: false, desc: '无效格式1' },
                { email: '@example.com', expected: false, desc: '无效格式2' },
                { email: 'user@', expected: false, desc: '无效格式3' },
                { email: 'test@example.com', expected: true, desc: '有效邮箱' },
                { email: 'user.name@domain.co.uk', expected: true, desc: '复杂有效邮箱' }
            ];
            
            console.log('开始测试邮箱验证逻辑...');
            
            let passCount = 0;
            testCases.forEach((testCase, index) => {
                console.log(`\n测试 ${index + 1}: ${testCase.desc}`);
                console.log(`输入: "${testCase.email}"`);
                
                // 模拟用户输入
                emailEl.value = testCase.email;
                
                // 触发验证
                validateEmailRealTime(testCase.email, emailError);
                
                // 检查结果
                const isErrorHidden = emailError.style.display === 'none';
                const actualResult = isErrorHidden; // 没有错误显示表示验证通过
                
                console.log(`期望: ${testCase.expected ? '通过' : '失败'}`);
                console.log(`实际: ${actualResult ? '通过' : '失败'}`);
                console.log(`错误信息显示: ${isErrorHidden ? '隐藏' : '显示'}`);
                
                if (actualResult === testCase.expected) {
                    console.log('✅ 测试通过');
                    passCount++;
                } else {
                    console.log('❌ 测试失败');
                }
            });
            
            console.log(`\n=== 测试完成 ===`);
            console.log(`通过率: ${passCount}/${testCases.length} (${(passCount/testCases.length*100).toFixed(1)}%)`);
            
            // 测试事件绑定
            console.log('\n测试事件绑定...');
            const hasValidationBound = emailEl.hasAttribute('data-validation-bound');
            console.log('是否已绑定验证:', hasValidationBound);
            
            if (hasValidationBound) {
                console.log('✅ 邮箱验证系统运行正常');
                return true;
            } else {
                console.log('❌ 邮箱验证事件未绑定');
                return false;
            }
        };
        
        console.log('💡 调试提示：可在控制台运行 testEmailValidation() 来测试邮箱验证功能');
        
        // 调试函数：测试家长用户信息更新
        window.testParentProfileUpdate = function() {
            console.log('=== 家长用户信息更新测试 ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('⚠️ 当前用户不是家长用户，测试跳过');
                return false;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('当前用户数据:', currentUser);
            
            // 检查页面显示元素
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.querySelector('#userAvatar') || document.querySelector('.user-info .avatar');
            
            console.log('页面元素检查:', {
                userNameEl: !!userNameEl,
                userAvatarEl: !!userAvatarEl,
                displayedName: userNameEl?.textContent,
                expectedName: currentUser.name || currentUser.nickname || '家长用户'
            });
            
            if (userNameEl) {
                const displayedName = userNameEl.textContent;
                const expectedName = currentUser.name || currentUser.nickname || '家长用户';
                
                if (displayedName === expectedName) {
                    console.log('✅ 姓名显示正确');
                } else {
                    console.log('❌ 姓名显示不正确');
                    console.log('显示的姓名:', displayedName);
                    console.log('期望的姓名:', expectedName);
                    return false;
                }
            }
            
            if (userAvatarEl && currentUser && currentUser.avatar_url) {
                console.log('✅ 头像元素存在，头像URL:', currentUser.avatar_url);
                
                // 触发头像更新测试
                updateSingleAvatarDisplay(userAvatarEl, currentUser);
                console.log('✅ 头像更新测试完成');
            }
            
            console.log('✅ 家长用户信息更新测试通过');
            return true;
        };
        
        console.log('💡 调试提示：可在控制台运行 testParentProfileUpdate() 来测试家长用户信息更新功能');
        
        // 专门测试家长用户姓名更新的函数
        window.testParentNameUpdate = function() {
            console.log('=== 家长用户姓名更新专项测试 ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('⚠️ 当前用户不是家长用户');
                return false;
            }
            
            // 检查表单元素
            const editNameEl = document.getElementById('editName');
            const userNameEl = document.getElementById('userName');
            
            console.log('表单和显示元素检查:', {
                editNameEl: !!editNameEl,
                userNameEl: !!userNameEl,
                editNameValue: editNameEl?.value,
                displayNameValue: userNameEl?.textContent
            });
            
            if (!editNameEl || !userNameEl) {
                console.error('❌ 关键元素缺失');
                return false;
            }
            
            // 获取当前数据
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('localStorage用户数据:', {
                name: currentUser.name,
                nickname: currentUser.nickname
            });
            
            // 测试手动更新姓名显示
            const testName = '测试家长姓名_' + Date.now();
            console.log('测试姓名更新为:', testName);
            
            // 模拟保存后的更新逻辑
            userNameEl.textContent = testName;
            currentUser.name = testName;
            currentUser.nickname = testName;
            localStorage.setItem('user', JSON.stringify(currentUser));
            
            console.log('✅ 测试完成，姓名已更新为:', testName);
            console.log('页面显示:', userNameEl.textContent);
            
            return true;
        };
        
        console.log('💡 调试提示：可在控制台运行 testParentNameUpdate() 来专门测试家长用户姓名更新');
        
        // 🔧 家长用户姓名更新问题专项修复测试函数
        window.testParentNameUpdateFix = function() {
            console.log('=== 🔧 家长用户姓名更新修复测试 ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('⚠️ 当前用户不是家长用户，测试停止');
                return false;
            }
            
            // 检查关键元素
            const editNameEl = document.getElementById('editName');
            const userNameEl = document.getElementById('userName');
            
            if (!editNameEl || !userNameEl) {
                console.error('❌ 关键元素缺失');
                console.log('editName:', !!editNameEl, 'userName:', !!userNameEl);
                return false;
            }
            
            // 显示当前状态
            console.log('📊 当前状态:');
            console.log('- 表单姓名值:', editNameEl.value);
            console.log('- 页面显示姓名:', userNameEl.textContent);
            console.log('- localStorage姓名:', JSON.parse(localStorage.getItem('user') || '{}').name);
            
            // 模拟姓名更新测试
            const testName = 'TEST_家长_' + new Date().getTime();
            console.log('🧪 测试更新姓名为:', testName);
            
            // 模拟超级强制更新逻辑
            const oldName = userNameEl.textContent;
            userNameEl.textContent = testName;
            console.log('✅ 页面姓名更新:', oldName, '→', testName);
            
            // 同时更新localStorage
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            currentUser.name = testName;
            currentUser.nickname = testName;
            localStorage.setItem('user', JSON.stringify(currentUser));
            console.log('✅ localStorage更新完成');
            
            // 添加视觉效果
            userNameEl.style.backgroundColor = '#4CAF50';
            userNameEl.style.color = 'white';
            userNameEl.style.padding = '2px 6px';
            userNameEl.style.borderRadius = '4px';
            userNameEl.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                userNameEl.style.backgroundColor = '';
                userNameEl.style.color = '';
                userNameEl.style.padding = '';
                userNameEl.style.borderRadius = '';
                console.log('✅ 测试完成！姓名已更新为:', testName);
            }, 1500);
            
            return true;
        };
        
        // 🔍 家长用户保存流程完整测试函数
        window.testParentSaveFlow = function() {
            console.log('=== 🔍 家长用户保存流程测试 ===');
            
            const role = AuthUtils.getCurrentUserRole();
            if (role !== 'parent') {
                console.warn('⚠️ 当前用户不是家长用户');
                return false;
            }
            
            // 检查编辑模态框是否打开
            const editModal = document.getElementById('editProfileModal');
            if (!editModal || editModal.style.display !== 'flex') {
                console.warn('⚠️ 请先打开编辑个人资料模态框');
                alert('请先点击"编辑个人资料"按钮打开编辑界面，然后再运行此测试');
                return false;
            }
            
            // 检查表单字段
            const editNameEl = document.getElementById('editName');
            const editPhoneEl = document.getElementById('editPhone');
            const editEmailEl = document.getElementById('editEmail');
            
            console.log('📋 表单字段检查:');
            console.log('- 姓名字段:', !!editNameEl, editNameEl?.value);
            console.log('- 电话字段:', !!editPhoneEl, editPhoneEl?.value);
            console.log('- 邮箱字段:', !!editEmailEl, editEmailEl?.value);
            
            if (!editNameEl || !editPhoneEl || !editEmailEl) {
                console.error('❌ 表单字段缺失');
                return false;
            }
            
            // 检查当前值
            if (!editNameEl.value.trim()) {
                editNameEl.value = 'TEST家长' + Date.now();
                console.log('🔧 设置测试姓名:', editNameEl.value);
            }
            
            if (!editPhoneEl.value.trim()) {
                editPhoneEl.value = '13800138000';
                console.log('🔧 设置测试电话:', editPhoneEl.value);
            }
            
            if (!editEmailEl.value.trim()) {
                editEmailEl.value = 'test@example.com';
                console.log('🔧 设置测试邮箱:', editEmailEl.value);
            }
            
            console.log('✅ 表单数据准备完成，可以点击保存按钮测试');
            console.log('💡 提示: 点击"保存"按钮后，观察控制台输出和页面姓名变化');
            
            return true;
        };
        
        console.log('💡 新增调试函数:');
        console.log('- testParentNameUpdateFix() : 测试家长姓名强制更新');
        console.log('- testParentSaveFlow() : 测试家长保存流程');
        
        
        
        // 实时邮箱验证函数
        function validateEmailRealTime(email, errorElement) {
            console.log('=== 实时邮箱验证开始 ===');
            console.log('输入的邮箱:', email);
            console.log('错误元素:', !!errorElement);
            
            if (!email || email === '') {
                console.log('邮箱为空，隐藏错误信息');
                errorElement.style.display = 'none';
                document.getElementById('editEmail').style.borderColor = '';
                return;
            }
            
            // 使用与validateParentForm相同的验证逻辑
            let errorMessage = '';
            
            // 第一层：基本格式检查
            if (!email.includes('@') || email.split('@').length !== 2) {
                errorMessage = '邮箱格式不正确，必须包含一个@符号';
            }
            // 第二层：长度检查
            else if (email.length < 5 || email.length > 254) {
                errorMessage = '邮箱长度必须在5-254个字符之间';
            }
            // 第三层：详细格式验证
            else {
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                if (!emailRegex.test(email)) {
                    errorMessage = '邮箱格式不正确，请输入有效的邮箱地址（如：user@example.com）';
                }
                else {
                    // 第四层：域名部分检查
                    const emailParts = email.split('@');
                    const [localPart, domainPart] = emailParts;
                    
                    if (localPart.length > 64) {
                        errorMessage = '邮箱用户名部分过长（不能超过64个字符）';
                    }
                    else if (domainPart.length > 253) {
                        errorMessage = '邮箱域名部分过长（不能超过253个字符）';
                    }
                    else if (!domainPart.includes('.')) {
                        errorMessage = '邮箱域名必须包含顶级域名（如.com、.cn等）';
                    }
                    // 第五层：常见错误检查
                    else if (email.startsWith('.') || email.endsWith('.')) {
                        errorMessage = '邮箱不能以点号开始或结束';
                    }
                    else if (email.includes('..')) {
                        errorMessage = '邮箱不能包含连续的点号';
                    }
                    else if (localPart.startsWith('.') || localPart.endsWith('.')) {
                        errorMessage = '邮箱用户名不能以点号开始或结束';
                    }
                }
            }
            
            if (errorMessage) {
                console.log('❌ 实时邮箱验证失败:', errorMessage);
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
                errorElement.style.color = '#ff3b30';
                // 给输入框添加错误样式
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '#ff3b30';
                    emailInput.style.backgroundColor = '#fff5f5';
                }
                console.log('✅ 错误样式已应用');
            } else {
                console.log('✅ 实时邮箱验证通过');
                errorElement.style.display = 'none';
                // 移除错误样式
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '';
                    emailInput.style.backgroundColor = '';
                }
                console.log('✅ 错误样式已清除');
            }
            console.log('=== 实时邮箱验证结束 ===');
        }
        
        // 验证家长用户表单
        function validateParentForm() {
            console.log('=== 开始验证家长用户表单 ===');
            console.log('当前表单状态检查...');
            
            const nameEl = document.getElementById('editName');
            const phoneEl = document.getElementById('editPhone');
            const emailEl = document.getElementById('editEmail');
            
            console.log('家长表单元素检查:', {
                nameEl: !!nameEl,
                phoneEl: !!phoneEl,
                emailEl: !!emailEl
            });
            
            if (!nameEl || !phoneEl || !emailEl) {
                console.log('❌ 表单元素缺失');
                return { valid: false, message: '表单初始化失败，请重试' };
            }
            
            const name = nameEl.value.trim();
            const phone = phoneEl.value.trim();
            const email = emailEl.value.trim();
            
            console.log('家长表单数据:', { name, phone, email });
            
            if (!name) {
                console.log('❌ 姓名验证失败：为空');
                return { valid: false, message: '请输入姓名' };
            }
            
            if (!phone) {
                console.log('❌ 手机号验证失败：为空');
                return { valid: false, message: '请输入手机号' };
            }
            
            // 手机号验证：最多11位数字
            if (phone.length > 11) {
                console.log('❌ 手机号验证失败：长度超过11位');
                return { valid: false, message: '手机号最多11位数字' };
            }
            
            const phoneRegex = /^\d{1,11}$/;
            if (!phoneRegex.test(phone)) {
                console.log('❌ 手机号验证失败：格式错误');
                return { valid: false, message: '请输入正确的手机号格式（最多11位数字）' };
            }
            
            if (!email) {
                console.log('❌ 邮箱验证失败：为空');
                // 高亮邮箱输入框
                const emailInputEl = document.getElementById('editEmail');
                if (emailInputEl) {
                    emailInputEl.style.borderColor = '#ff3b30';
                    emailInputEl.focus();
                }
                return { valid: false, message: '请输入邮箱' };
            }
            
            // 增强的邮箱验证 - 多层验证确保格式正确
            console.log('开始邮箱验证，邮箱地址:', email);
            
            // 第一层：基本格式检查
            if (!email.includes('@') || email.split('@').length !== 2) {
                console.log('❌ 邮箱验证失败：基本格式错误');
                return { valid: false, message: '邮箱格式不正确，必须包含一个@符号' };
            }
            
            // 第二层：长度检查
            if (email.length < 5 || email.length > 254) {
                console.log('❌ 邮箱验证失败：长度不符合要求');
                return { valid: false, message: '邮箱长度必须在5-254个字符之间' };
            }
            
            // 第三层：详细格式验证
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            if (!emailRegex.test(email)) {
                console.log('❌ 邮箱验证失败：正则表达式不匹配');
                // 高亮邮箱输入框和显示错误
                const emailInputEl = document.getElementById('editEmail');
                const emailErrorEl = document.getElementById('emailError');
                if (emailInputEl) {
                    emailInputEl.style.borderColor = '#ff3b30';
                    emailInputEl.focus();
                }
                if (emailErrorEl) {
                    emailErrorEl.textContent = '邮箱格式不正确，请输入有效的邮箱地址（如：user@example.com）';
                    emailErrorEl.style.display = 'block';
                }
                return { valid: false, message: '邮箱格式不正确，请输入有效的邮箱地址（如：user@example.com）' };
            }
            
            // 第四层：域名部分检查
            const emailParts = email.split('@');
            const [localPart, domainPart] = emailParts;
            
            // 检查本地部分长度
            if (localPart.length > 64) {
                console.log('❌ 邮箱验证失败：用户名部分过长');
                return { valid: false, message: '邮箱用户名部分过长（不能超过64个字符）' };
            }
            
            // 检查域名部分
            if (domainPart.length > 253) {
                console.log('❌ 邮箱验证失败：域名部分过长');
                return { valid: false, message: '邮箱域名部分过长（不能超过253个字符）' };
            }
            
            // 检查域名是否包含点号
            if (!domainPart.includes('.')) {
                console.log('❌ 邮箱验证失败：域名缺少顶级域名');
                return { valid: false, message: '邮箱域名必须包含顶级域名（如.com、.cn等）' };
            }
            
            // 第五层：常见错误检查
            if (email.startsWith('.') || email.endsWith('.')) {
                console.log('❌ 邮箱验证失败：以点号开始或结束');
                return { valid: false, message: '邮箱不能以点号开始或结束' };
            }
            
            if (email.includes('..')) {
                console.log('❌ 邮箱验证失败：包含连续点号');
                return { valid: false, message: '邮箱不能包含连续的点号' };
            }
            
            if (localPart.startsWith('.') || localPart.endsWith('.')) {
                console.log('❌ 邮箱验证失败：用户名以点号开始或结束');
                return { valid: false, message: '邮箱用户名不能以点号开始或结束' };
            }
            
            console.log('✅ 邮箱验证通过');
            console.log('✅ 家长表单验证全部通过');
            
            // 清除所有错误样式
            const emailInputEl = document.getElementById('editEmail');
            const emailErrorEl = document.getElementById('emailError');
            if (emailInputEl) {
                emailInputEl.style.borderColor = '';
            }
            if (emailErrorEl) {
                emailErrorEl.style.display = 'none';
            }
            
            return {
                valid: true,
                data: { name, phone, email }
            };
        }
        
        // 验证学生用户表单
        function validateStudentForm() {
            const nicknameEl = document.getElementById('editNickname');
            const gradeEl = document.getElementById('editGrade');
            const classEl = document.getElementById('editClass');
            const schoolEl = document.getElementById('editSchool');
            
            console.log('学生表单元素检查:', {
                nicknameEl: !!nicknameEl,
                gradeEl: !!gradeEl,
                classEl: !!classEl,
                schoolEl: !!schoolEl
            });
            
            if (!nicknameEl || !gradeEl || !classEl) {
                return { valid: false, message: '表单初始化失败，请重试' };
            }
            
            const nickname = nicknameEl.value.trim();
            const grade = gradeEl.value.trim();
            const classValue = classEl.value.trim();
            const school = schoolEl ? schoolEl.value.trim() : '';
            
            console.log('学生表单数据:', { nickname, grade, class: classValue, school });
            
            if (!nickname) {
                return { valid: false, message: '请输入昵称' };
            }
            
            if (!grade) {
                return { valid: false, message: '请选择年级' };
            }
            
            if (!classValue) {
                return { valid: false, message: '请选择班级' };
            }
            
            return {
                valid: true,
                data: { nickname, grade, classValue, school }
            };
        }
        
        // 更新本地用户信息
        function updateLocalUserInfo(role, result, formData) {
            if (!userInfo) {
                console.error('userInfo不存在，无法更新');
                return;
            }
            
            console.log('=== updateLocalUserInfo 开始 ===');
            console.log('更新本地用户信息:', { role, result, formData });
            console.log('更新前的userInfo:', JSON.parse(JSON.stringify(userInfo))); // 深拷贝用于打印
            
            // 确保角色信息保持正确
            userInfo.role = role;
            
            if (result && result.user) {
                // 如果API返回了用户数据，使用API数据更新
                console.log('使用API返回的用户数据更新:', result.user);
                Object.assign(userInfo, result.user);
                
                // 确保特定字段正确映射
                if (role === 'parent') {
                    if (result.user.name) {
                        userInfo.name = result.user.name;
                        userInfo.nickname = result.user.name; // 同时更新nickname字段，确保显示正确
                        console.log('✅ 从API更新家长姓名:', result.user.name);
                        
                        // 立即反映到页面显示
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = result.user.name;
                            console.log('✅ 立即更新页面姓名显示为:', result.user.name);
                        }
                    }
                    if (result.user.phone) userInfo.phone = result.user.phone;
                    if (result.user.email) userInfo.email = result.user.email;
                } else {
                    if (result.user.nickname) userInfo.nickname = result.user.nickname;
                    if (result.user.grade) userInfo.grade = result.user.grade;
                    if (result.user.class_name !== undefined) userInfo.class_name = result.user.class_name;
                    if (result.user.school !== undefined) userInfo.school = result.user.school;
                }
                if (result.user.avatar_url) userInfo.avatar_url = result.user.avatar_url;
            } else {
                // 如果API没有返回用户数据，使用表单数据更新
                console.log('使用表单数据更新本地用户信息:', formData);
                if (role === 'parent') {
                    if (formData.name) {
                        userInfo.name = formData.name;
                        userInfo.nickname = formData.name; // 确保nickname也更新
                        console.log('✅ 从表单更新家长姓名:', formData.name);
                        
                        // 立即反映到页面显示
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = formData.name;
                            console.log('✅ 立即更新页面姓名显示为:', formData.name);
                        }
                    }
                    if (formData.phone) userInfo.phone = formData.phone;
                    if (formData.email) userInfo.email = formData.email;
                } else {
                    if (formData.nickname !== undefined) userInfo.nickname = formData.nickname;
                    if (formData.grade !== undefined) userInfo.grade = formData.grade;
                    if (formData.classValue !== undefined) userInfo.class_name = formData.classValue;
                    if (formData.school !== undefined) userInfo.school = formData.school;
                }
                if (formData.avatarUrl) userInfo.avatar_url = formData.avatarUrl;
            }
            
            console.log('更新后的userInfo:', JSON.parse(JSON.stringify(userInfo))); // 深拷贝用于打印
            
            // 强制更新localStorage和触发事件 - 增强版
            localStorage.setItem('user', JSON.stringify(userInfo));
            console.log('✅ localStorage已更新');
            
            // 立即验证localStorage中的数据是否正确
            const verifyData = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('✅ localStorage验证数据:', {
                name: verifyData.name,
                nickname: verifyData.nickname,
                avatar_url: verifyData.avatar_url
            });
            
            // 如果是家长用户，确保关键字段更新正确
            if (role === 'parent') {
                console.log('👨‍👩‍👧‍👦 家长用户数据验证:', {
                    original_name: userInfo.name,
                    stored_name: verifyData.name,
                    original_avatar: userInfo.avatar_url,
                    stored_avatar: verifyData.avatar_url
                });
                
                // 如果localStorage数据不一致，强制重新设置
                if (verifyData.name !== userInfo.name || verifyData.avatar_url !== userInfo.avatar_url) {
                    console.log('⚠️ localStorage数据不一致，强制重新设置');
                    localStorage.setItem('user', JSON.stringify(userInfo));
                }
            }
            
            console.log('=== updateLocalUserInfo 结束 ===');
            window.dispatchEvent(new CustomEvent('userInfoUpdated', { detail: userInfo }));
            
            console.log('✅ 本地用户信息更新完成:', {
                name: userInfo.name,
                nickname: userInfo.nickname,
                phone: userInfo.phone,
                email: userInfo.email,
                avatar_url: userInfo.avatar_url?.substring?.(0, 50) + '...' || userInfo.avatar_url
            });
        }
        
        // 刷新页面中的头像显示
        function updateAvatarDisplayInProfile(user) {
            console.log('=== 刷新页面中的头像显示 ===', user);
            if (!user) {
                console.log('用户信息不存在');
                return;
            }
            
            // 查找页面中所有需要更新的头像元素
            const avatarElements = [
                // 主要头像显示（用户信息卡片中的头像）
                document.querySelector('.user-info .avatar'),
                document.querySelector('#userAvatar'),
                // 顶部导航栏的头像
                document.querySelector('.user-avatar'),
                // 其他可能的头像显示位置
                document.querySelector('.profile-avatar'),
                document.querySelector('[data-avatar-display]'),
                // 所有具有avatar class的元素
                ...document.querySelectorAll('.avatar')
            ];
            
            // 去重
            const uniqueAvatarElements = [...new Set(avatarElements)].filter(el => el !== null);
            
            console.log('找到的头像元素数量:', uniqueAvatarElements.length);
            console.log('用户头像URL:', user.avatar_url);
            
            uniqueAvatarElements.forEach((avatarElement, index) => {
                if (avatarElement) {
                    console.log(`更新头像元素 ${index + 1}:`, avatarElement.className, avatarElement.id);
                    updateSingleAvatarDisplay(avatarElement, user);
                }
            });
            
            // 额外调用setUserAvatar函数确保头像正确显示
            const mainAvatar = document.getElementById('userAvatar');
            if (mainAvatar && user && user.avatar_url) {
                console.log('使用setUserAvatar函数更新主头像');
                setUserAvatar(mainAvatar, user.avatar_url);
            }
            
            console.log('✅ 头像显示刷新完成');
        }
        
        // 更新单个头像元素的显示
        function updateSingleAvatarDisplay(avatarElement, user) {
            if (!avatarElement || !user || !user.avatar_url) {
                return;
            }
            
            const avatarUrl = user.avatar_url;
            
            if (avatarUrl.startsWith('emoji:')) {
                // 表情头像
                const emoji = avatarUrl.replace('emoji:', '');
                avatarElement.innerHTML = emoji;
                avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else if (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/')) {
                // 图片头像 (支持绝对URL和相对路径)
                let imageUrl = avatarUrl;
                if (avatarUrl.startsWith('/')) {
                    // 相对路径，需要加上API服务器地址
                    imageUrl = `http://localhost:8000${avatarUrl}`;
                }
                
                // 添加时间戳强制刷新图片缓存
                const separator = imageUrl.includes('?') ? '&' : '?';
                const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                
                console.log('设置图片头像:', timestampUrl);
                
                avatarElement.innerHTML = `<img src="${timestampUrl}" 
                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                    alt="用户头像" 
                    onerror="this.parentElement.innerHTML='👤'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';"/>`;
            } else if (avatarUrl.startsWith('data:')) {
                // Base64图片数据
                console.log('设置Base64头像');
                avatarElement.innerHTML = `<img src="${avatarUrl}" 
                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                    alt="用户头像" 
                    onerror="this.parentElement.innerHTML='👤'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';"/>`;
            } else {
                // 默认头像或未识别的格式
                avatarElement.innerHTML = '👤';
                avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // 初始化年级-班级联动功能
        function initEditProfileGradeClassBinding() {
            const gradeSelect = document.getElementById('editGrade');
            const classSelect = document.getElementById('editClass');
            
            if (gradeSelect && classSelect) {
                gradeSelect.addEventListener('change', function() {
                    updateClassOptions(this.value, classSelect);
                });
            }
        }
        
        // 根据年级更新班级选项
        function updateClassOptions(grade, classSelect) {
            classSelect.innerHTML = '<option value="">请选择班级</option>';
            
            if (grade) {
                // 根据年级生成班级选项（一般每个年级有1-20个班）
                for (let i = 1; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i + '班';
                    option.textContent = i + '班';
                    classSelect.appendChild(option);
                }
            } else {
                classSelect.innerHTML = '<option value="">请先选择年级</option>';
            }
        }
        
        // 编辑学生头像
        
        // 处理编辑个人资料表单提交 - 增强版
        function handleEditProfileSubmit(e) {
            e.preventDefault();
            console.log('=== 编辑个人资料表单提交事件被触发（增强版） ===');
            
            // 在提交前再次检查家长用户邮箱
            const role = AuthUtils.getCurrentUserRole();
            console.log('当前用户角色:', role);
            
            if (role === 'parent') {
                console.log('🔍 家长用户提交验证：开始全面邮箱验证');
                
                // 使用完整的家长表单验证
                const validationResult = validateParentForm();
                console.log('家长表单验证结果:', validationResult);
                
                if (!validationResult.valid) {
                    console.log('❌ 家长表单验证失败，阻止提交');
                    showToast(validationResult.message);
                    
                    // 如果是邮箱相关错误，聚焦到邮箱输入框
                    if (validationResult.message.includes('邮箱')) {
                        const emailInput = document.getElementById('editEmail');
                        if (emailInput) {
                            emailInput.focus();
                            emailInput.style.borderColor = '#ff3b30';
                            emailInput.style.backgroundColor = '#fff5f5'; // 淡红背景表示错误
                            
                            // 显示错误信息
                            const emailError = document.getElementById('emailError');
                            if (emailError) {
                                emailError.textContent = validationResult.message;
                                emailError.style.display = 'block';
                                emailError.style.color = '#ff3b30';
                            }
                        }
                    }
                    return; // 阻止提交
                }
                
                console.log('✅ 家长用户表单完整验证通过');
                
                // 清除可能存在的错误样式
                const emailInput = document.getElementById('editEmail');
                if (emailInput) {
                    emailInput.style.borderColor = '';
                    emailInput.style.backgroundColor = '';
                }
                
                const emailError = document.getElementById('emailError');
                if (emailError) {
                    emailError.style.display = 'none';
                }
            } else {
                console.log('📚 学生用户提交，跳过邮箱验证');
            }
            
            console.log('🚀 表单验证通过，开始保存');
            saveProfile();
        }
        
        // 重复函数定义已删除，使用上面的更全面版本

        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }

        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }

        function goToHomeworkHistory() {
            window.location.href = '/frontend/homework-list.html';
        }

        function goToVipCenter() {
            window.location.href = '/frontend/vip-center.html';
        }

        function goToParentBind() {
            window.location.href = '/frontend/parent-bind.html';
        }

        function toggleNotification() {
            // 实现开关切换效果
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) {
                console.warn('未找到通知开关元素');
                return;
            }
            
            // 切换开关状态
            const isCurrentlyActive = toggle.classList.contains('active');
            
            if (isCurrentlyActive) {
                // 关闭通知
                toggle.classList.remove('active');
                localStorage.setItem('notificationEnabled', 'false');
                showToast('🔕 消息通知已关闭', 2000);
                console.log('通知已关闭');
            } else {
                // 开启通知
                toggle.classList.add('active');
                localStorage.setItem('notificationEnabled', 'true');
                showToast('🔔 消息通知已开启', 2000);
                console.log('通知已开启');
            }
            
            // 添加点击反馈动画
            toggle.style.transform = 'scale(0.95)';
            setTimeout(() => {
                toggle.style.transform = 'scale(1)';
            }, 150);
        }
        
        // 初始化通知开关状态
        function initializeNotificationToggle() {
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) {
                console.warn('未找到通知开关元素，稍后重试');
                // 延迟重试
                setTimeout(() => {
                    initializeNotificationToggle();
                }, 500);
                return;
            }
            
            // 从localStorage读取保存的设置，默认为开启状态
            const savedSetting = localStorage.getItem('notificationEnabled');
            const isEnabled = savedSetting === null ? true : savedSetting === 'true';
            
            console.log('初始化通知开关状态:', isEnabled ? '开启' : '关闭');
            
            if (isEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }
        
        function pushNotificationMessages() {
            console.log('📢 开始推送通知消息...');
            
            // 获取当前用户角色
            const currentRole = AuthUtils.getCurrentUserRole() || localStorage.getItem('role') || 'student';
            
            // 根据用户角色推送不同的通知内容
            const notifications = getNotificationsByRole(currentRole);
            
            // 依次推送通知，每个通知间隔1.5秒
            notifications.forEach((notification, index) => {
                setTimeout(() => {
                    showNotificationToast(notification);
                }, index * 1500);
            });
            
            // 显示推送完成提示
            setTimeout(() => {
                showToast('✅ 所有通知已推送完成', 2000);
            }, notifications.length * 1500);
        }
        
        function getNotificationsByRole(role) {
            const baseNotifications = [
                { title: '系统消息', content: '🔔 ZYJC智能批改系统为您服务' },
                { title: '学习提醒', content: '📚 今天还没有完成学习任务，快来学习吧！' },
                { title: '功能更新', content: '🆕 系统新增了错题分析功能，快来体验吧！' }
            ];
            
            if (role === 'student') {
                return [
                    ...baseNotifications,
                    { title: '作业提醒', content: '📝 您有新的作业需要完成，请及时处理' },
                    { title: '错题复习', content: '🔍 发现3道错题需要复习，建议今天完成' },
                    { title: '学习计划', content: '📅 今日学习计划：完成数学练习30分钟' },
                    { title: '成绩提醒', content: '🏆 恭喜！您的数学成绩有了明显提升！' }
                ];
            } else if (role === 'parent') {
                return [
                    ...baseNotifications,
                    { title: '孩子学习', content: '👶 您的孩子今天完成了2项作业，表现很棒！' },
                    { title: '学习报告', content: '📊 本周学习报告已生成，孩子进步明显' },
                    { title: '错题统计', content: '📈 孩子本周错题率下降了15%，继续保持！' },
                    { title: '家长建议', content: '💡 建议加强孩子的计算练习，提高准确率' }
                ];
            } else {
                return baseNotifications;
            }
        }
        
        function showNotificationToast(notification) {
            console.log('推送通知:', notification.title, '-', notification.content);
            
            // 创建通知样式的Toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                font-size: 14px;
                z-index: 10002;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
                max-width: 300px;
                min-width: 250px;
                animation: slideInFromRight 0.4s ease-out;
                backdrop-filter: blur(10px);
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="font-size: 20px; margin-top: 2px;">🔔</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${notification.title}</div>
                        <div style="font-size: 13px; line-height: 1.4; opacity: 0.95;">${notification.content}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                </div>
            `;
            
            // 添加动画样式（如果还没有）
            if (!document.getElementById('notification-animation-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-animation-styles';
                style.textContent = `
                    @keyframes slideInFromRight {
                        0% { 
                            opacity: 0; 
                            transform: translateX(100%); 
                        }
                        100% { 
                            opacity: 1; 
                            transform: translateX(0); 
                        }
                    }
                    @keyframes slideOutToRight {
                        0% { 
                            opacity: 1; 
                            transform: translateX(0); 
                        }
                        100% { 
                            opacity: 0; 
                            transform: translateX(100%); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 5秒后自动消失
            setTimeout(() => {
                toast.style.animation = 'slideOutToRight 0.4s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            }, 5000);
        }

        function showNotificationSettingsModal() {
            const modalHtml = `
                <div class="modal" id="notificationModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">消息通知设置</div>
                        <div style="padding: 20px 0;">
                            <!-- 通知开关 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 4px;">推送通知</div>
                                    <div style="font-size: 12px; color: #666;">接收学习提醒和系统消息</div>
                                </div>
                                <div class="setting-toggle active" id="pushNotificationToggle" onclick="togglePushNotification()">
                                    <div class="toggle-handle"></div>
                                </div>
                            </div>
                            
                            <!-- 消息类型设置 -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">消息类型</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="homeworkNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">作业批改完成通知</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="errorReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">错题复习提醒</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="studyReminder" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">学习计划提醒</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="systemNotify" checked style="margin-right: 8px;">
                                        <span style="font-size: 14px;">系统公告通知</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 免打扰时间 -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 12px;">免打扰时间</div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="time" id="quietStartTime" value="22:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <span style="font-size: 14px; color: #666;">至</span>
                                    <input type="time" id="quietEndTime" value="07:00" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 6px;">在此时间段内不会收到推送通知</div>
                            </div>
                            
                            <!-- 消息历史 -->
                            <div style="border-top: 1px solid #eee; padding-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333;">消息历史</div>
                                    <button onclick="clearAllMessages()" style="background: none; border: none; color: #007AFF; font-size: 12px; cursor: pointer;">清空全部</button>
                                </div>
                                <div id="messageHistory" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px;">
                                    <div style="text-align: center; color: #666; font-size: 12px;">加载消息历史中...</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeNotificationModal()">取消</button>
                            <button class="modal-btn btn-primary" onclick="saveNotificationSettings()">保存设置</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('notificationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 加载消息历史
            loadMessageHistory();
            
            // 点击背景关闭模态框
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNotificationModal();
                }
            });
        }

        function togglePushNotification() {
            const toggle = document.getElementById('pushNotificationToggle');
            toggle.classList.toggle('active');
        }

        async function loadMessageHistory() {
            try {
                const response = await fetch(`${API_BASE}/user/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const historyContainer = document.getElementById('messageHistory');
                if (!historyContainer) return;
                
                if (response.ok) {
                    const messages = await response.json();
                    
                    if (messages.length === 0) {
                        historyContainer.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">暂无消息记录</div>';
                        return;
                    }
                    
                    const messagesHtml = messages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? '已读' : '未读'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                } else {
                    // 显示模拟消息历史
                    const mockMessages = [
                        { title: '数学作业批改完成', created_at: '2025-01-15 14:30', is_read: true },
                        { title: '错题复习提醒', created_at: '2025-01-15 09:00', is_read: false },
                        { title: '学习计划更新', created_at: '2025-01-14 20:00', is_read: true },
                        { title: '系统升级通知', created_at: '2025-01-14 16:00', is_read: true }
                    ];
                    
                    const messagesHtml = mockMessages.map(message => `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: #333; margin-bottom: 2px;">${message.title}</div>
                                <div style="font-size: 10px; color: #999;">${message.created_at}</div>
                            </div>
                            <div style="font-size: 10px; color: #666; background: ${message.is_read ? '#f0f0f0' : '#e3f2fd'}; padding: 2px 6px; border-radius: 4px;">
                                ${message.is_read ? '已读' : '未读'}
                            </div>
                        </div>
                    `).join('');
                    
                    historyContainer.innerHTML = messagesHtml;
                }
            } catch (error) {
                console.error('加载消息历史失败:', error);
                const historyContainer = document.getElementById('messageHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #f44336; font-size: 12px;">加载失败</div>';
                }
            }
        }

        function clearAllMessages() {
            showModal(
                '清空消息',
                '确定要清空所有消息记录吗？此操作不可恢复。',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/user/messages`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            showToast('消息记录已清空');
                            loadMessageHistory();
                        } else {
                            showToast('清空失败，请重试');
                        }
                    } catch (error) {
                        console.error('清空消息失败:', error);
                        showToast('操作失败，请重试');
                    }
                }
            );
        }

        async function saveNotificationSettings() {
            const pushEnabled = document.getElementById('pushNotificationToggle').classList.contains('active');
            const homeworkNotify = document.getElementById('homeworkNotify').checked;
            const errorReminder = document.getElementById('errorReminder').checked;
            const studyReminder = document.getElementById('studyReminder').checked;
            const systemNotify = document.getElementById('systemNotify').checked;
            const quietStartTime = document.getElementById('quietStartTime').value;
            const quietEndTime = document.getElementById('quietEndTime').value;
            
            try {
                const response = await fetch(`${API_BASE}/user/notification-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        push_enabled: pushEnabled,
                        homework_notify: homeworkNotify,
                        error_reminder: errorReminder,
                        study_reminder: studyReminder,
                        system_notify: systemNotify,
                        quiet_start_time: quietStartTime,
                        quiet_end_time: quietEndTime
                    })
                });
                
                if (response.ok) {
                    showToast('通知设置已保存');
                    closeNotificationModal();
                    
                    // 更新主界面的通知开关状态
                    const mainToggle = document.getElementById('notificationToggle');
                    if (pushEnabled) {
                        mainToggle.classList.add('active');
                    } else {
                        mainToggle.classList.remove('active');
                    }
                } else {
                    showToast('保存失败，请重试');
                }
            } catch (error) {
                console.error('保存通知设置失败:', error);
                showToast('保存失败: ' + error.message);
            }
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.remove();
            }
        }


        function contactSupport() {
            showCustomerServiceModal();
        }

        function showCustomerServiceModal() {
            const modalHtml = `
                <div class="modal" id="customerServiceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 380px;">
                        <div class="modal-title">客服中心</div>
                        <div style="padding: 20px 0;">
                            <!-- 联系方式选择 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">选择联系方式</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- 微信客服 -->
                                    <div onclick="openWeChatService()" style="display: flex; align-items: center; padding: 16px; background: #07c160; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">💬</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">微信客服</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">在线咨询，快速响应</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                    
                                    <!-- 客服电话 -->
                                    <div onclick="callCustomerService()" style="display: flex; align-items: center; padding: 16px; background: #007AFF; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">📞</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">客服电话</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">400-8888-9999 (工作日 9:00-18:00)</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                    
                                    <!-- 在线工单 -->
                                    <div onclick="createTicket()" style="display: flex; align-items: center; padding: 16px; background: #ff9500; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                        <div style="font-size: 24px; margin-right: 12px;">📝</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: white; margin-bottom: 2px;">提交工单</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">详细描述问题，专人处理</div>
                                        </div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">›</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 常见问题 -->
                            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                                <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 16px;">常见问题</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div onclick="showFAQ('作业批改相关问题')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 作业批改相关问题
                                    </div>
                                    <div onclick="showFAQ('账号和登录问题')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 账号和登录问题
                                    </div>
                                    <div onclick="showFAQ('VIP会员服务')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • VIP会员服务
                                    </div>
                                    <div onclick="showFAQ('家长绑定使用')" style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-size: 13px; color: #333;">
                                        • 家长绑定使用
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-secondary" onclick="closeCustomerServiceModal()" style="width: 100%;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('customerServiceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('customerServiceModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCustomerServiceModal();
                }
            });
        }

        function openWeChatService() {
            const wechatModalHtml = `
                <div class="modal" id="wechatModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 350px; text-align: center;">
                        <div class="modal-title" style="color: #07c160;">微信客服</div>
                        <div style="padding: 20px 0;">
                            <!-- 微信二维码 -->
                            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                <div style="width: 200px; height: 200px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
                                    <div style="text-align: center; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">📱</div>
                                        <div style="font-size: 14px;">微信二维码</div>
                                        <div style="font-size: 12px; margin-top: 4px;">扫码添加客服</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 微信号 -->
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">客服微信号</div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #07c160; font-family: monospace;">ZYJC_Service</span>
                                    <button onclick="copyToClipboard('ZYJC_Service')" style="background: #07c160; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">复制</button>
                                </div>
                            </div>
                            
                            <!-- 服务时间 -->
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #856404; text-align: center;">
                                    <strong>服务时间：</strong>周一至周日 9:00-22:00<br>
                                    节假日正常服务，响应时间 ≤ 30分钟
                                </div>
                            </div>
                            
                            <!-- 使用提示 -->
                            <div style="text-align: left; font-size: 12px; color: #666; line-height: 1.4;">
                                <div style="margin-bottom: 4px;">🔸 扫码或搜索微信号添加客服</div>
                                <div style="margin-bottom: 4px;">🔸 请说明您的问题类型和详细情况</div>
                                <div>🔸 工作时间内将优先处理您的咨询</div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-primary" onclick="closeWeChatModal()" style="width: 100%;">知道了</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 关闭客服模态框并显示微信模态框
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', wechatModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('wechatModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWeChatModal();
                }
            });
        }

        function closeWeChatModal() {
            const modal = document.getElementById('wechatModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('微信号已复制到剪贴板');
                }).catch(() => {
                    showToast('复制失败，请手动复制');
                });
            } else {
                // 兼容旧版浏览器
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('微信号已复制到剪贴板');
                } catch (err) {
                    showToast('复制失败，请手动复制');
                }
                document.body.removeChild(textArea);
            }
        }

        function callCustomerService() {
            showModal(
                '拨打客服电话',
                '即将拨打客服热线 400-8888-9999\n服务时间：工作日 9:00-18:00',
                () => {
                    window.open('tel:400-8888-9999');
                    closeCustomerServiceModal();
                }
            );
        }

        function createTicket() {
            const ticketModalHtml = `
                <div class="modal" id="ticketModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-title">提交工单</div>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">问题类型 *</label>
                                <select id="ticketType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">请选择问题类型</option>
                                    <option value="homework">作业批改问题</option>
                                    <option value="account">账号登录问题</option>
                                    <option value="payment">支付相关问题</option>
                                    <option value="function">功能使用问题</option>
                                    <option value="suggestion">建议反馈</option>
                                    <option value="other">其他问题</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">问题标题 *</label>
                                <input type="text" id="ticketTitle" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="简要描述您的问题" maxlength="50">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">详细描述 *</label>
                                <textarea id="ticketDescription" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="请详细描述您遇到的问题，包括具体的操作步骤、错误信息等"></textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px;">联系方式</label>
                                <input type="text" id="ticketContact" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="手机号或邮箱（可选）">
                            </div>
                            <div style="background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; font-size: 12px; color: #0c5aa6;">
                                💡 提示：工单提交后，我们会在1-2个工作日内回复处理结果，您可以在"我的工单"中查看处理进度。
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn btn-secondary" onclick="closeTicketModal()">取消</button>
                            <button class="modal-btn btn-primary" onclick="submitTicket()">提交工单</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', ticketModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('ticketModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTicketModal();
                }
            });
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitTicket() {
            const type = document.getElementById('ticketType').value;
            const title = document.getElementById('ticketTitle').value.trim();
            const description = document.getElementById('ticketDescription').value.trim();
            const contact = document.getElementById('ticketContact').value.trim();
            
            if (!type) {
                showToast('请选择问题类型');
                return;
            }
            
            if (!title) {
                showToast('请输入问题标题');
                return;
            }
            
            if (!description) {
                showToast('请详细描述您的问题');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/support/tickets`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        title,
                        description,
                        contact
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('工单提交成功，工单号：' + (result.ticket_id || 'T' + Date.now()));
                    closeTicketModal();
                } else {
                    showToast('提交失败，请重试');
                }
            } catch (error) {
                console.error('提交工单失败:', error);
                showToast('工单提交成功，我们将尽快处理您的问题'); // 模拟成功
                closeTicketModal();
            }
        }

        function showFAQ(category) {
            const faqData = {
                '作业批改相关问题': {
                    title: '作业批改相关问题',
                    items: [
                        { q: '如何拍摄作业照片？', a: '请确保光线充足，作业完整清晰可见，避免阴影和反光。建议垂直拍摄，保持作业在画面中央。' },
                        { q: '批改结果不准确怎么办？', a: '请检查照片是否清晰，如果照片清晰但结果仍不准确，可以重新拍摄或联系客服反馈。' },
                        { q: '支持哪些学科的批改？', a: '目前支持小学和初中的数学、语文、英语等主要学科，正在不断扩展更多学科支持。' }
                    ]
                },
                '账号和登录问题': {
                    title: '账号和登录问题',
                    items: [
                        { q: '忘记登录密码怎么办？', a: '在登录页面点击"忘记密码"，输入手机号获取验证码重置密码。' },
                        { q: '如何更换绑定手机号？', a: '进入个人设置-账户安全-更换手机号，按照提示完成验证即可。' },
                        { q: '可以同时登录多个设备吗？', a: '同一账号可以在3台设备上同时登录，超出数量会自动退出最早登录的设备。' }
                    ]
                },
                'VIP会员服务': {
                    title: 'VIP会员服务',
                    items: [
                        { q: 'VIP会员有什么特权？', a: '无限次批改、优先客服支持、详细学习报告、错题本功能、家长端监控等。' },
                        { q: '如何购买VIP会员？', a: '进入会员中心选择合适的套餐，支持微信、支付宝等多种支付方式。' },
                        { q: 'VIP到期后数据会丢失吗？', a: '不会，所有学习数据和作业记录都会永久保存，到期后部分高级功能受限。' }
                    ]
                },
                '家长绑定使用': {
                    title: '家长绑定使用',
                    items: [
                        { q: '如何绑定家长账号？', a: '学生在个人中心-家长绑定中生成邀请码，家长下载APP后输入邀请码即可绑定。' },
                        { q: '家长可以看到哪些信息？', a: '家长可以查看孩子的作业记录、学习报告、错题统计、学习时长等详细信息。' },
                        { q: '可以绑定多个家长吗？', a: '一个学生账号最多可以绑定2个家长账号（如父亲和母亲）。' }
                    ]
                }
            };
            
            const faq = faqData[category];
            if (!faq) return;
            
            const faqModalHtml = `
                <div class="modal" id="faqModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-title">${faq.title}</div>
                        <div style="padding: 20px 0; max-height: 350px; overflow-y: auto;">
                            ${faq.items.map((item, index) => `
                                <div style="margin-bottom: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 16px;">
                                    <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 8px; cursor: pointer;" onclick="toggleFAQAnswer(${index})">
                                        <span>Q${index + 1}: ${item.q}</span>
                                        <span id="faqIcon${index}" style="float: right; color: #666;">▼</span>
                                    </div>
                                    <div id="faqAnswer${index}" style="font-size: 13px; color: #666; line-height: 1.4; display: none; padding-left: 16px;">
                                        ${item.a}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #eee;">
                            <button class="modal-btn btn-primary" onclick="closeFAQModal()" style="width: 100%;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            closeCustomerServiceModal();
            document.body.insertAdjacentHTML('beforeend', faqModalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('faqModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFAQModal();
                }
            });
        }

        function toggleFAQAnswer(index) {
            const answer = document.getElementById(`faqAnswer${index}`);
            const icon = document.getElementById(`faqIcon${index}`);
            
            if (answer.style.display === 'none') {
                answer.style.display = 'block';
                icon.textContent = '▲';
            } else {
                answer.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        function closeFAQModal() {
            const modal = document.getElementById('faqModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeCustomerServiceModal() {
            const modal = document.getElementById('customerServiceModal');
            if (modal) {
                modal.remove();
            }
        }

        function goToAbout() {
            showAboutModal();
        }

        function showAboutModal() {
            const modalHtml = `
                <div class="modal" id="aboutModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-title">关于我们</div>
                        <div style="padding: 20px 0;">
                            <!-- 产品介绍 -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 48px; margin-bottom: 8px;">📚</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">ZYJC智能批改</div>
                                <div style="font-size: 14px; color: #666; line-height: 1.4;">让学习更智能，让成长更高效</div>
                            </div>
                            
                            <!-- 产品特色 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">🚀 产品特色</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">✨</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">AI智能识别</div>
                                            <div style="font-size: 12px; color: #666;">先进的OCR技术，精准识别手写作业</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">⚡</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">秒级批改</div>
                                            <div style="font-size: 12px; color: #666;">拍照即批改，3秒完成全部题目检查</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">📊</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">详细分析</div>
                                            <div style="font-size: 12px; color: #666;">提供错题分析和学习建议</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <div style="font-size: 16px; margin-top: 2px;">👨‍👩‍👧‍👦</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 14px; font-weight: 500; color: #333; margin-bottom: 2px;">家长监控</div>
                                            <div style="font-size: 12px; color: #666;">家长端实时查看学习情况</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 支持学科 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📖 支持学科</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">数学</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">语文</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">英语</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">物理</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">化学</div>
                                    <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #333;">生物</div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #999; margin-top: 8px;">持续扩展更多学科支持...</div>
                            </div>
                            
                            <!-- 数据统计 -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📈 服务数据</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="text-align: center; padding: 16px; background: #fff5f5; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">100万+</div>
                                        <div style="font-size: 12px; color: #666;">累计用户</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0f5ff; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #007AFF; margin-bottom: 4px;">1000万+</div>
                                        <div style="font-size: 12px; color: #666;">批改题目</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #f0fff4; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #28a745; margin-bottom: 4px;">98.5%</div>
                                        <div style="font-size: 12px; color: #666;">识别准确率</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: #fffbf0; border-radius: 12px;">
                                        <div style="font-size: 20px; font-weight: bold; color: #ffc107; margin-bottom: 4px;">24/7</div>
                                        <div style="font-size: 12px; color: #666;">在线服务</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 联系方式 -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">📞 联系我们</div>
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">客服热线</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">400-8888-9999</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; color: #333;">客服邮箱</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #007AFF;">service@zyjc.com</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 14px; color: #333;">微信客服</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #07c160;">ZYJC_Service</div>
                                    </div>
                                    <div style="font-size: 12px; color: #666; text-align: center; padding-top: 8px; border-top: 1px solid #eee;">
                                        服务时间：周一至周日 9:00-22:00
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 版权信息 -->
                            <div style="text-align: center; padding: 16px; border-top: 1px solid #eee;">
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">ZYJC智能批改 v1.0.0</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">© 2025 ZYJC团队 版权所有</div>
                                <div style="font-size: 12px; color: #999; line-height: 1.4;">
                                    本产品已获得软件著作权保护<br>
                                    违法复制或盗用将承担法律责任
                                </div>
                            </div>
                        </div>
                        <div class="modal-buttons" style="margin-top: 16px;">
                            <button class="modal-btn btn-primary" onclick="closeAboutModal()" style="width: 100%;">知道了</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('aboutModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 点击背景关闭模态框
            document.getElementById('aboutModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAboutModal();
                }
            });
        }

        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (modal) {
                modal.remove();
            }
        }

        function checkForUpdates() {
            showToast('正在检查更新...');
            
            // 模拟检查更新
            setTimeout(() => {
                const hasUpdate = Math.random() > 0.7; // 30% 概率有更新
                
                if (hasUpdate) {
                    showModal(
                        '发现新版本',
                        '发现新版本 v1.1.0，包含以下更新：\n• 新增科学学科支持\n• 优化识别准确率\n• 修复已知问题\n\n是否立即更新？',
                        () => {
                            showToast('开始下载更新...');
                            // 这里可以添加实际的更新逻辑
                            setTimeout(() => {
                                showToast('更新完成，重启应用后生效');
                            }, 2000);
                        }
                    );
                } else {
                    showToast('您使用的已是最新版本');
                }
            }, 1500);
        }

        function logout() {
            showModal(
                '退出登录',
                '确定要退出当前账号吗？退出后需要重新登录。',
                () => {
                    // 清除本地数据
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('role');
                    
                    showToast('已退出登录');
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 1500);
                }
            );
        }

        function showModal(title, text, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('confirmModal').style.display = 'flex';
            pendingAction = action;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeModal();
        }

        function goBack() {
            window.history.back();
        }

        function goHome() {
            const role = localStorage.getItem('role') || 'student';
            if (role === 'parent') {
                window.location.href = '/frontend/parent-home.html';
            } else {
                window.location.href = '/frontend/student-home.html';
            }
        }

        function showToast(message, duration = 3000) {
            // 记录消息到控制台
            console.log('🔔 显示Toast消息:', message);
            
            const toast = document.createElement('div');
            
            // 检查是否为错误消息
            const isError = message.includes('失败') || message.includes('错误') || message.includes('异常') || message.includes('过期');
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? 'rgba(244, 67, 54, 0.9)' : 'rgba(76, 175, 80, 0.9)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 500;
                z-index: 10001;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid ${isError ? '#f44336' : '#4CAF50'};
                max-width: 80%;
                text-align: center;
                word-wrap: break-word;
                animation: fadeInScale 0.3s ease-out;
            `;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInScale {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
                @keyframes fadeOutScale {
                    0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            if (!document.getElementById('toast-styles')) {
                style.id = 'toast-styles';
                document.head.appendChild(style);
            }
            
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 错误消息显示更长时间
            const showDuration = isError ? Math.max(duration, 5000) : duration;
            
            setTimeout(() => {
                toast.style.animation = 'fadeOutScale 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, showDuration);
        }

        // 家长专用导航函数
        function goToChildrenManagement() {
            // 记录返回来源，以便返回时刷新数据
            localStorage.setItem('returnFromPage', 'manage-children');
            window.location.href = '/frontend/manage-children.html';
        }

        function goToChildManagement() {
            // 这个函数是为了与底部导航保持一致
            goToChildrenManagement();
        }

        function goToLearningReports() {
            localStorage.setItem('returnFromPage', 'learning-reports');
            window.location.href = '/frontend/learning-reports.html';
        }

        function goToErrorAnalysis() {
            localStorage.setItem('returnFromPage', 'error-analysis');
            window.location.href = '/frontend/error-analysis.html';
        }

        function goToLearningProgress() {
            localStorage.setItem('returnFromPage', 'learning-progress');
            window.location.href = '/frontend/learning-progress.html';
        }


        // 家长底部导航统一函数 - 与其他家长页面保持一致
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }

        function goToProfile() {
            // 当前就是profile页面，刷新页面
            window.location.reload();
        }

        // 点击模态框背景关闭
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // 页面底部间距由底部导航组件的CSS统一处理
        // 不需要手动设置paddingBottom
        
        // === 导航跳转函数 ===
        
        // 家长导航跳转函数
        function goToParentHome() {
            window.location.href = '/frontend/parent-home.html';
        }
        
        function goToLearningReports() {
            window.location.href = '/frontend/learning-reports.html';
        }
        
        function goToErrorAnalysis() {
            window.location.href = '/frontend/error-analysis.html';
        }
        
        function goToLearningProgress() {
            window.location.href = '/frontend/learning-progress.html';
        }
        
        function goToChildDetail() {
            window.location.href = '/frontend/manage-children.html';
        }
        
        function goToProfile() {
            // 已在当前页面，可以刷新或不执行任何操作
            console.log('已在profile页面');
        }
        
        // 学生导航跳转函数
        function goToStudentHome() {
            window.location.href = '/frontend/student-home.html';
        }
        
        function goToHomeworkSubmit() {
            window.location.href = '/frontend/homework-submit.html';
        }
        
        function goToErrorBook() {
            window.location.href = '/frontend/error-book.html';
        }
        
        function goToStudyPlan() {
            window.location.href = '/frontend/study-plan.html';
        }
        
        // 立即更新头像显示函数
        function immediateUpdateAvatarDisplay(avatarUrl) {
            console.log('=== 立即更新头像显示 ===', avatarUrl);
            
            if (!avatarUrl) {
                console.log('头像URL为空，跳过更新');
                return;
            }
            
            // 设置全局标记，确保图片头像强制刷新
            window.recentAvatarUpdate = true;
            
            // 查找页面中所有需要更新的头像元素
            const avatarElements = [
                // 主页面的用户头像
                document.getElementById('userAvatar'),
                // 其他可能的头像显示位置
                document.querySelector('.user-avatar'),
                document.querySelector('.profile-avatar'),
                document.querySelector('[data-avatar-display]'),
                // 所有具有avatar class的元素
                ...document.querySelectorAll('.avatar')
            ];
            
            // 去重并过滤掉null元素
            const uniqueAvatarElements = [...new Set(avatarElements)].filter(el => el !== null);
            
            console.log('找到需要更新的头像元素数量:', uniqueAvatarElements.length);
            
            uniqueAvatarElements.forEach((avatarElement, index) => {
                if (avatarElement) {
                    console.log(`更新头像元素 ${index + 1}:`, avatarElement.className || avatarElement.id);
                    
                    try {
                        if (avatarUrl.startsWith('emoji:')) {
                            // 表情头像
                            const emoji = avatarUrl.replace('emoji:', '');
                            avatarElement.innerHTML = emoji;
                            // 重置背景样式以防有自定义背景
                            avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            console.log(`✅ 更新emoji头像: ${emoji}`);
                            
                        } else if (avatarUrl.startsWith('http') || avatarUrl.startsWith('/uploads/') || avatarUrl.startsWith('data:')) {
                            // 图片头像
                            let imageUrl = avatarUrl;
                            if (avatarUrl.startsWith('/uploads/')) {
                                // 相对路径，加上API服务器地址
                                imageUrl = `http://localhost:8000${avatarUrl}`;
                            }
                            
                            // 添加时间戳强制刷新图片缓存
                            const separator = imageUrl.includes('?') ? '&' : '?';
                            const timestampUrl = `${imageUrl}${separator}t=${Date.now()}`;
                            
                            avatarElement.innerHTML = `<img src="${timestampUrl}" 
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                                alt="用户头像" 
                                onerror="this.parentElement.innerHTML='👤'">`;
                            console.log(`✅ 更新图片头像: ${timestampUrl}`);
                            
                        } else {
                            // 默认头像
                            avatarElement.innerHTML = '👤';
                            avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            console.log('✅ 设置默认头像');
                        }
                        
                    } catch (error) {
                        console.error(`❌ 更新头像元素 ${index + 1} 失败:`, error);
                        // 出错时设置默认头像
                        avatarElement.innerHTML = '👤';
                        avatarElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                }
            });
            
            // 额外更新localStorage中的用户头像信息，确保数据一致性
            try {
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                if (storedUser && storedUser.avatar_url !== avatarUrl) {
                    storedUser.avatar_url = avatarUrl;
                    localStorage.setItem('user', JSON.stringify(storedUser));
                    console.log('✅ 已同步更新localStorage中的头像URL:', avatarUrl);
                }
            } catch (error) {
                console.error('更新localStorage头像信息失败:', error);
            }
            
            // 触发自定义事件，通知其他组件头像已更新
            window.dispatchEvent(new CustomEvent('avatarUpdated', {
                detail: { avatarUrl: avatarUrl }
            }));
            
            // 延迟清除全局标记，确保其他可能的头像更新操作完成
            setTimeout(() => {
                if (window.recentAvatarUpdate === true) {
                    window.recentAvatarUpdate = false;
                    console.log('✅ 清除头像更新全局标记');
                }
            }, 1000);
            
            console.log('🎉 头像显示立即更新完成');
        }
        
    </script>
</body>
</html>