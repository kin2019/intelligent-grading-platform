<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æ™ºèƒ½å‡ºé¢˜ - æ™ºèƒ½æ•™è‚²å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .config-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 12px;
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .form-select, .form-input, .form-textarea {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .batch-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .preview-item:last-child {
            margin-bottom: 0;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .schedule-table th,
        .schedule-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .schedule-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 62, 62, 0.3);
        }

        .loading, .success-message, .error-message {
            display: none;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .loading {
            color: #667eea;
            font-weight: 500;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        .success-message {
            background: #c6f6d5;
            color: #2d7738;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-summary {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .config-card {
                padding: 25px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            .config-tabs {
                flex-direction: column;
            }

            .tab-button {
                margin-bottom: 8px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ‰¹é‡æ™ºèƒ½å‡ºé¢˜</h1>
            <p>ä¸€æ¬¡æ€§ç”Ÿæˆå¤šå¥—ç»ƒä¹ ï¼Œæ”¯æŒå®šæ—¶å’Œè®¡åˆ’ç”Ÿæˆ</p>
        </div>

        <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
        <div class="config-tabs">
            <button class="tab-button active" onclick="switchTab('batch')">ğŸ“¦ æ‰¹é‡ç”Ÿæˆ</button>
            <button class="tab-button" onclick="switchTab('schedule')">â° å®šæ—¶è®¡åˆ’</button>
            <button class="tab-button" onclick="switchTab('management')">ğŸ“Š æ‰¹é‡ç®¡ç†</button>
        </div>

        <!-- æ‰¹é‡ç”Ÿæˆé…ç½® -->
        <div id="batchTab" class="tab-content active">
            <div class="config-card">
                <form id="batchConfigForm">
                    <!-- åŸºç¡€è®¾ç½® -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“š æ‰¹é‡é…ç½®</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="batchCount">ç”Ÿæˆå¥—æ•°</label>
                                <div class="range-group">
                                    <span>1</span>
                                    <input type="range" id="batchCount" class="range-input" 
                                           min="1" max="20" value="5">
                                    <span>20</span>
                                </div>
                                <div class="range-value" id="batchCountValue">5å¥—</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="batchSubject">å­¦ç§‘é€‰æ‹©</label>
                                <select id="batchSubject" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©å­¦ç§‘...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchGrade">å¹´çº§é€‰æ‹©</label>
                                <select id="batchGrade" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©å¹´çº§...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchDifficulty">éš¾åº¦ç­‰çº§</label>
                                <select id="batchDifficulty" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©éš¾åº¦...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- é¢˜ç›®è®¾ç½® -->
                    <div class="form-section">
                        <h3 class="section-title">âš™ï¸ é¢˜ç›®é…ç½®</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">æ¯å¥—é¢˜ç›®æ•°é‡: <span class="range-value" id="questionsPerSetValue">10</span></label>
                                <div class="range-group">
                                    <span>5</span>
                                    <input type="range" id="questionsPerSet" class="range-input" 
                                           min="5" max="50" value="10">
                                    <span>50</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchVariation">é¢˜ç›®å˜åŒ–ç¨‹åº¦</label>
                                <select id="batchVariation" class="form-select">
                                    <option value="low">è¾ƒå°‘å˜åŒ– - ç›¸ä¼¼é¢˜å‹å’Œéš¾åº¦</option>
                                    <option value="medium" selected>é€‚ä¸­å˜åŒ– - å¹³è¡¡ç›¸ä¼¼æ€§å’Œå¤šæ ·æ€§</option>
                                    <option value="high">è¾ƒå¤šå˜åŒ– - ä¸åŒé¢˜å‹å’Œéš¾åº¦æ··åˆ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchTitle">æ‰¹æ¬¡åç§°</label>
                                <input type="text" id="batchTitle" class="form-input" 
                                       placeholder="ä¾‹å¦‚ï¼šæ•°å­¦åŸºç¡€ç»ƒä¹  - ç¬¬ä¸€æ‰¹" maxlength="100">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchDescription">æ‰¹æ¬¡æè¿°</label>
                                <textarea id="batchDescription" class="form-textarea" 
                                          placeholder="ä¾‹å¦‚ï¼šé’ˆå¯¹åŠ å‡æ³•è¿ç®—çš„åŸºç¡€ç»ƒä¹ ï¼Œé€‚åˆæ¯æ—¥è®­ç»ƒä½¿ç”¨" maxlength="500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- é¢˜å‹é€‰æ‹© -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“ é¢˜å‹é…ç½®</h3>
                        <div class="checkbox-group" id="batchQuestionTypes">
                            <!-- åŠ¨æ€åŠ è½½é¢˜å‹é€‰é¡¹ -->
                        </div>
                    </div>

                    <!-- æ‰¹é‡é¢„è§ˆ -->
                    <div class="batch-preview" id="batchPreview" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #2d3748;">ğŸ“‹ ç”Ÿæˆé¢„è§ˆ</h4>
                        <div id="previewContent"></div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="previewBatch()">
                            ğŸ‘ï¸ é¢„è§ˆé…ç½®
                        </button>
                        <button type="submit" class="btn btn-primary" id="generateBatchBtn">
                            âœ¨ å¼€å§‹æ‰¹é‡ç”Ÿæˆ
                        </button>
                    </div>

                    <div class="loading" id="batchLoading">æ­£åœ¨æ‰¹é‡ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...</div>
                    <div class="error-message" id="batchError"></div>
                    <div class="success-message" id="batchSuccess"></div>
                </form>
            </div>
        </div>

        <!-- å®šæ—¶è®¡åˆ’é…ç½® -->
        <div id="scheduleTab" class="tab-content">
            <div class="config-card">
                <form id="scheduleConfigForm">
                    <!-- è®¡åˆ’è®¾ç½® -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“… ç”Ÿæˆè®¡åˆ’</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="planType">è®¡åˆ’ç±»å‹</label>
                                <select id="planType" class="form-select" required>
                                    <option value="daily">æ¯æ—¥ç»ƒä¹  - æ¯å¤©è‡ªåŠ¨ç”Ÿæˆ</option>
                                    <option value="weekly">æ¯å‘¨ç»ƒä¹  - æ¯å‘¨ç”Ÿæˆä¸€å¥—</option>
                                    <option value="monthly">æ¯æœˆç»ƒä¹  - æ¯æœˆç”Ÿæˆç»ƒä¹ è®¡åˆ’</option>
                                    <option value="custom">è‡ªå®šä¹‰è®¡åˆ’ - æŒ‡å®šæ—¶é—´å’Œé¢‘ç‡</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planStartDate">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="planStartDate" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planEndDate">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="planEndDate" class="form-input">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planTime">ç”Ÿæˆæ—¶é—´</label>
                                <input type="time" id="planTime" class="form-input" value="08:00">
                            </div>
                        </div>
                    </div>

                    <!-- è®¡åˆ’å†…å®¹é…ç½® -->
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“‹ å†…å®¹é…ç½®</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="planSubject">å­¦ç§‘</label>
                                <select id="planSubject" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©å­¦ç§‘...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planGrade">å¹´çº§</label>
                                <select id="planGrade" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©å¹´çº§...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planQuestionCount">æ¯æ¬¡é¢˜ç›®æ•°é‡</label>
                                <input type="number" id="planQuestionCount" class="form-input" 
                                       min="5" max="50" value="15">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planDifficulty">éš¾åº¦çº§åˆ«</label>
                                <select id="planDifficulty" class="form-select" required>
                                    <option value="">è¯·é€‰æ‹©éš¾åº¦...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- è®¡åˆ’æ‘˜è¦ -->
                    <div class="batch-summary" id="planSummary" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #2d3748; text-align: center;">ğŸ“Š è®¡åˆ’æ‘˜è¦</h4>
                        <div class="summary-grid" id="planSummaryGrid"></div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="previewPlan()">
                            ğŸ“Š é¢„è§ˆè®¡åˆ’
                        </button>
                        <button type="submit" class="btn btn-primary" id="createPlanBtn">
                            ğŸš€ åˆ›å»ºè®¡åˆ’
                        </button>
                    </div>

                    <div class="loading" id="planLoading">æ­£åœ¨åˆ›å»ºè®¡åˆ’...</div>
                    <div class="error-message" id="planError"></div>
                    <div class="success-message" id="planSuccess"></div>
                </form>
            </div>
        </div>

        <!-- æ‰¹é‡ç®¡ç† -->
        <div id="managementTab" class="tab-content">
            <div class="config-card">
                <div class="form-section">
                    <h3 class="section-title">ğŸ“Š æ‰¹é‡ä»»åŠ¡ç®¡ç†</h3>
                    <div style="margin-bottom: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="refreshManagement()" style="margin-right: 10px;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button class="btn btn-danger" onclick="clearCompletedTasks()">
                            ğŸ—‘ï¸ æ¸…ç†å·²å®Œæˆ
                        </button>
                    </div>
                    
                    <div id="managementContent">
                        <div class="loading" id="managementLoading" style="display: block;">
                            æ­£åœ¨åŠ è½½ç®¡ç†æ•°æ®...
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">ğŸ“… å®šæ—¶è®¡åˆ’ç®¡ç†</h3>
                    <div style="margin-bottom: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="refreshSchedules()">
                            ğŸ”„ åˆ·æ–°è®¡åˆ’
                        </button>
                    </div>
                    
                    <div id="schedulesContent">
                        <div class="loading" id="schedulesLoading" style="display: block;">
                            æ­£åœ¨åŠ è½½è®¡åˆ’æ•°æ®...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');

        // å½“å‰æ´»åŠ¨çš„é€‰é¡¹å¡
        let currentTab = 'batch';

        // APIè¯·æ±‚å·¥å…·å‡½æ•°
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            // æ›´æ–°é€‰é¡¹å¡æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            currentTab = tabName;

            // åˆå§‹åŒ–å¯¹åº”é€‰é¡¹å¡çš„æ•°æ®
            if (tabName === 'management') {
                loadManagementData();
            } else if (tabName === 'schedule') {
                loadScheduleData();
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success', tabPrefix = 'batch') {
            const errorEl = document.getElementById(tabPrefix + 'Error');
            const successEl = document.getElementById(tabPrefix + 'Success');
            
            // éšè—æ‰€æœ‰æ¶ˆæ¯
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';

            if (type === 'error') {
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
            } else {
                if (successEl) {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                }
                
                // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
                if (successEl) {
                    setTimeout(() => {
                        successEl.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading, tabPrefix = 'batch', buttonId = null) {
            const loadingEl = document.getElementById(tabPrefix + 'Loading');
            const submitBtn = buttonId ? document.getElementById(buttonId) : null;

            if (loadingEl) {
                loadingEl.style.display = loading ? 'block' : 'none';
            }

            if (submitBtn) {
                submitBtn.disabled = loading;
            }
        }

        // åŠ è½½å­¦ç§‘åˆ—è¡¨
        async function loadSubjects() {
            try {
                const data = await apiRequest('/exercise/config/subjects');
                
                // æ‰¹é‡ç”Ÿæˆçš„å­¦ç§‘é€‰æ‹©
                const batchSelect = document.getElementById('batchSubject');
                // è®¡åˆ’ç”Ÿæˆçš„å­¦ç§‘é€‰æ‹©  
                const planSelect = document.getElementById('planSubject');
                
                data.subjects.forEach(subject => {
                    const batchOption = document.createElement('option');
                    batchOption.value = subject;
                    batchOption.textContent = subject;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = subject;
                    planOption.textContent = subject;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('åŠ è½½å­¦ç§‘åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½å­¦ç§‘åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½å¹´çº§åˆ—è¡¨
        async function loadGrades() {
            try {
                const data = await apiRequest('/exercise/config/grades');
                
                const batchSelect = document.getElementById('batchGrade');
                const planSelect = document.getElementById('planGrade');
                
                data.grades.forEach(grade => {
                    const batchOption = document.createElement('option');
                    batchOption.value = grade;
                    batchOption.textContent = grade;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = grade;
                    planOption.textContent = grade;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('åŠ è½½å¹´çº§åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½å¹´çº§åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½éš¾åº¦ç­‰çº§
        async function loadDifficultyLevels() {
            try {
                const data = await apiRequest('/exercise/config/difficulty-levels');
                
                const batchSelect = document.getElementById('batchDifficulty');
                const planSelect = document.getElementById('planDifficulty');
                
                Object.entries(data.difficulty_levels).forEach(([key, config]) => {
                    const batchOption = document.createElement('option');
                    batchOption.value = key;
                    batchOption.textContent = `${config.name} - ${config.description}`;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = key;
                    planOption.textContent = `${config.name} - ${config.description}`;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('åŠ è½½éš¾åº¦ç­‰çº§å¤±è´¥:', error);
                showMessage('åŠ è½½éš¾åº¦ç­‰çº§å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é¢˜å‹é€‰æ‹©
        async function loadQuestionTypes() {
            try {
                const data = await apiRequest('/exercise/config/question-types');
                const container = document.getElementById('batchQuestionTypes');
                
                Object.entries(data.question_types).forEach(([key, config]) => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    div.innerHTML = `
                        <input type="checkbox" id="batch_type_${key}" name="batchQuestionTypes" value="${key}" ${key === 'similar' ? 'checked' : ''}>
                        <label for="batch_type_${key}">
                            <strong>${config.name}</strong><br>
                            <small style="color: #718096;">${config.description}</small>
                        </label>
                    `;
                    
                    container.appendChild(div);

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        div.classList.toggle('selected', div.querySelector('input').checked);
                    });

                    // åˆå§‹çŠ¶æ€
                    if (key === 'similar') {
                        div.classList.add('selected');
                    }
                });
            } catch (error) {
                console.error('åŠ è½½é¢˜å‹é€‰æ‹©å¤±è´¥:', error);
                showMessage('åŠ è½½é¢˜å‹é€‰æ‹©å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ»‘å—äº‹ä»¶å¤„ç†
        document.getElementById('batchCount').addEventListener('input', (e) => {
            document.getElementById('batchCountValue').textContent = e.target.value + 'å¥—';
        });

        document.getElementById('questionsPerSet').addEventListener('input', (e) => {
            document.getElementById('questionsPerSetValue').textContent = e.target.value;
        });

        // é¢„è§ˆæ‰¹é‡é…ç½®
        function previewBatch() {
            const count = parseInt(document.getElementById('batchCount').value);
            const subject = document.getElementById('batchSubject').value;
            const grade = document.getElementById('batchGrade').value;
            const difficulty = document.getElementById('batchDifficulty').value;
            const questionsPerSet = parseInt(document.getElementById('questionsPerSet').value);
            const variation = document.getElementById('batchVariation').value;

            if (!subject || !grade || !difficulty) {
                showMessage('è¯·å¡«å†™å®Œæ•´çš„åŸºç¡€é…ç½®ä¿¡æ¯', 'error');
                return;
            }

            const preview = document.getElementById('batchPreview');
            const content = document.getElementById('previewContent');

            let previewHtml = '';
            const variationText = {
                'low': 'ç›¸ä¼¼é¢˜å‹',
                'medium': 'é€‚ä¸­å˜åŒ–', 
                'high': 'å¤šæ ·å˜åŒ–'
            };

            for (let i = 1; i <= count; i++) {
                previewHtml += `
                    <div class="preview-item">
                        <div>
                            <strong>${subject} ${grade} ç»ƒä¹ é¢˜ - ç¬¬${i}å¥—</strong><br>
                            <small>${questionsPerSet}é“é¢˜ Â· ${variationText[variation]} Â· ${difficulty}éš¾åº¦</small>
                        </div>
                        <div style="color: #007AFF; font-weight: 600;">é¢„è®¡5-10åˆ†é’Ÿ</div>
                    </div>
                `;
            }

            content.innerHTML = previewHtml;
            preview.style.display = 'block';

            // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
            preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ‰¹é‡ç”Ÿæˆè¡¨å•æäº¤
        document.getElementById('batchConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true, 'batch', 'generateBatchBtn');
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const selectedTypes = Array.from(document.querySelectorAll('input[name="batchQuestionTypes"]:checked'))
                    .map(cb => cb.value);

                if (selectedTypes.length === 0) {
                    throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹');
                }

                const config = {
                    batch_count: parseInt(document.getElementById('batchCount').value),
                    subject: document.getElementById('batchSubject').value,
                    grade: document.getElementById('batchGrade').value,
                    questions_per_set: parseInt(document.getElementById('questionsPerSet').value),
                    difficulty_level: document.getElementById('batchDifficulty').value,
                    variation_level: document.getElementById('batchVariation').value,
                    question_types: selectedTypes,
                    title: document.getElementById('batchTitle').value || `${document.getElementById('batchSubject').value}æ‰¹é‡ç»ƒä¹ `,
                    description: document.getElementById('batchDescription').value || 'æ‰¹é‡ç”Ÿæˆçš„ç»ƒä¹ é¢˜',
                    include_answers: true,
                    include_analysis: true
                };

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!config.subject || !config.grade || !config.difficulty_level) {
                    throw new Error('è¯·å¡«å†™å®Œæ•´çš„åŸºç¡€é…ç½®ä¿¡æ¯');
                }

                console.log('æ‰¹é‡ç”Ÿæˆé…ç½®:', config);

                // å‘é€æ‰¹é‡ç”Ÿæˆè¯·æ±‚
                const response = await apiRequest('/exercise/batch-generate', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                showMessage(`æ‰¹é‡ç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨ï¼æ‰¹æ¬¡ID: ${response.batch_id}`, 'success');
                
                // å­˜å‚¨æ‰¹æ¬¡ID
                sessionStorage.setItem('lastBatchId', response.batch_id);

                // 3ç§’åè·³è½¬åˆ°ç®¡ç†é¡µé¢æŸ¥çœ‹è¿›åº¦
                setTimeout(() => {
                    switchTab('management');
                    loadManagementData();
                }, 3000);

            } catch (error) {
                console.error('æ‰¹é‡ç”Ÿæˆå¤±è´¥:', error);
                showMessage('æ‰¹é‡ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                setLoading(false, 'batch', 'generateBatchBtn');
            }
        });

        // é¢„è§ˆè®¡åˆ’
        function previewPlan() {
            const planType = document.getElementById('planType').value;
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = document.getElementById('planEndDate').value ? new Date(document.getElementById('planEndDate').value) : null;
            const questionCount = parseInt(document.getElementById('planQuestionCount').value);

            if (!planType || !startDate) {
                showMessage('è¯·å¡«å†™è®¡åˆ’åŸºç¡€ä¿¡æ¯', 'error', 'plan');
                return;
            }

            // è®¡ç®—é¢„è®¡ç”Ÿæˆæ•°æ®
            let estimatedSets = 0;
            let totalQuestions = 0;
            let duration = '';

            const now = new Date();
            const end = endDate || new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // é»˜è®¤30å¤©

            const daysDiff = Math.ceil((end - startDate) / (1000 * 60 * 60 * 24));

            switch (planType) {
                case 'daily':
                    estimatedSets = daysDiff;
                    duration = `${daysDiff}å¤©`;
                    break;
                case 'weekly':
                    estimatedSets = Math.ceil(daysDiff / 7);
                    duration = `${Math.ceil(daysDiff / 7)}å‘¨`;
                    break;
                case 'monthly':
                    estimatedSets = Math.ceil(daysDiff / 30);
                    duration = `${Math.ceil(daysDiff / 30)}ä¸ªæœˆ`;
                    break;
                default:
                    estimatedSets = daysDiff; // è‡ªå®šä¹‰æŒ‰æ—¥è®¡ç®—
                    duration = `${daysDiff}å¤©ï¼ˆè‡ªå®šä¹‰ï¼‰`;
            }

            totalQuestions = estimatedSets * questionCount;

            // æ˜¾ç¤ºæ‘˜è¦
            const summary = document.getElementById('planSummary');
            const summaryGrid = document.getElementById('planSummaryGrid');

            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-number">${estimatedSets}</div>
                    <div class="summary-label">é¢„è®¡å¥—æ•°</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${totalQuestions}</div>
                    <div class="summary-label">æ€»é¢˜ç›®æ•°</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${duration}</div>
                    <div class="summary-label">æŒç»­æ—¶é—´</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${planType === 'daily' ? 'æ¯æ—¥' : planType === 'weekly' ? 'æ¯å‘¨' : 'æ¯æœˆ'}</div>
                    <div class="summary-label">ç”Ÿæˆé¢‘ç‡</div>
                </div>
            `;

            summary.style.display = 'block';
            summary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // è®¡åˆ’ç”Ÿæˆè¡¨å•æäº¤
        document.getElementById('scheduleConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true, 'plan', 'createPlanBtn');
            
            try {
                const config = {
                    plan_type: document.getElementById('planType').value,
                    subject: document.getElementById('planSubject').value,
                    grade: document.getElementById('planGrade').value,
                    difficulty_level: document.getElementById('planDifficulty').value,
                    question_count: parseInt(document.getElementById('planQuestionCount').value),
                    start_date: document.getElementById('planStartDate').value,
                    end_date: document.getElementById('planEndDate').value,
                    generation_time: document.getElementById('planTime').value,
                    enabled: true
                };

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!config.plan_type || !config.subject || !config.grade || !config.difficulty_level || !config.start_date) {
                    throw new Error('è¯·å¡«å†™å®Œæ•´çš„è®¡åˆ’é…ç½®ä¿¡æ¯');
                }

                console.log('å®šæ—¶è®¡åˆ’é…ç½®:', config);

                // å‘é€è®¡åˆ’åˆ›å»ºè¯·æ±‚
                const response = await apiRequest('/exercise/create-schedule', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                showMessage(`å®šæ—¶è®¡åˆ’åˆ›å»ºæˆåŠŸï¼è®¡åˆ’ID: ${response.schedule_id}`, 'success', 'plan');
                
                // é‡ç½®è¡¨å•
                document.getElementById('scheduleConfigForm').reset();
                document.getElementById('planSummary').style.display = 'none';

                // 3ç§’åè·³è½¬åˆ°ç®¡ç†é¡µé¢
                setTimeout(() => {
                    switchTab('management');
                    loadScheduleData();
                }, 3000);

            } catch (error) {
                console.error('åˆ›å»ºè®¡åˆ’å¤±è´¥:', error);
                showMessage('åˆ›å»ºè®¡åˆ’å¤±è´¥: ' + error.message, 'error', 'plan');
            } finally {
                setLoading(false, 'plan', 'createPlanBtn');
            }
        });

        // åŠ è½½ç®¡ç†æ•°æ®
        async function loadManagementData() {
            const content = document.getElementById('managementContent');
            const loading = document.getElementById('managementLoading');
            
            loading.style.display = 'block';

            try {
                const data = await apiRequest('/exercise/batch-status');
                
                if (data.batches && data.batches.length > 0) {
                    let html = `
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>æ‰¹æ¬¡ID</th>
                                    <th>åç§°</th>
                                    <th>è¿›åº¦</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.batches.forEach(batch => {
                        const statusClass = `status-${batch.status}`;
                        const statusText = {
                            'pending': 'ç­‰å¾…ä¸­',
                            'running': 'ç”Ÿæˆä¸­',
                            'completed': 'å·²å®Œæˆ',
                            'failed': 'å¤±è´¥'
                        }[batch.status] || 'æœªçŸ¥';

                        const progress = batch.completed_count && batch.total_count ? 
                            Math.round((batch.completed_count / batch.total_count) * 100) : 0;

                        html += `
                            <tr>
                                <td><code>${batch.id}</code></td>
                                <td>${batch.title || 'æœªå‘½åæ‰¹æ¬¡'}</td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 8px; margin-right: 8px;">
                                            <div style="width: ${progress}%; background: #667eea; height: 100%; border-radius: 10px;"></div>
                                        </div>
                                        <span style="font-size: 12px;">${progress}%</span>
                                    </div>
                                </td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${new Date(batch.created_at).toLocaleString()}</td>
                                <td>
                                    ${batch.status === 'completed' ? 
                                        `<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="viewBatchResults('${batch.id}')">æŸ¥çœ‹ç»“æœ</button>` :
                                        batch.status === 'running' ?
                                        `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="refreshBatchStatus('${batch.id}')">åˆ·æ–°</button>` :
                                        `<button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="cancelBatch('${batch.id}')">å–æ¶ˆ</button>`
                                    }
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
                            <div>è¿˜æ²¡æœ‰æ‰¹é‡ç”Ÿæˆä»»åŠ¡</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†æ•°æ®å¤±è´¥:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                        <button class="btn btn-secondary" onclick="loadManagementData()" style="margin-top: 16px;">é‡è¯•</button>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // åŠ è½½è®¡åˆ’æ•°æ®
        async function loadScheduleData() {
            const content = document.getElementById('schedulesContent');
            const loading = document.getElementById('schedulesLoading');
            
            loading.style.display = 'block';

            try {
                const data = await apiRequest('/exercise/schedules');
                
                if (data.schedules && data.schedules.length > 0) {
                    let html = `
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>è®¡åˆ’åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>ä¸‹æ¬¡ç”Ÿæˆ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å·²ç”Ÿæˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.schedules.forEach(schedule => {
                        const statusClass = schedule.enabled ? 'status-running' : 'status-pending';
                        const statusText = schedule.enabled ? 'è¿è¡Œä¸­' : 'å·²æš‚åœ';

                        const typeText = {
                            'daily': 'æ¯æ—¥',
                            'weekly': 'æ¯å‘¨',
                            'monthly': 'æ¯æœˆ',
                            'custom': 'è‡ªå®šä¹‰'
                        }[schedule.plan_type] || 'æœªçŸ¥';

                        html += `
                            <tr>
                                <td>${schedule.subject} ${schedule.grade} ç»ƒä¹ </td>
                                <td>${typeText}</td>
                                <td>${schedule.next_generation ? new Date(schedule.next_generation).toLocaleString() : '--'}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${schedule.generated_count || 0} å¥—</td>
                                <td>
                                    <button class="btn ${schedule.enabled ? 'btn-secondary' : 'btn-primary'}" 
                                            style="padding: 4px 8px; font-size: 12px; margin-right: 4px;" 
                                            onclick="toggleSchedule('${schedule.id}', ${!schedule.enabled})">
                                        ${schedule.enabled ? 'æš‚åœ' : 'å¯ç”¨'}
                                    </button>
                                    <button class="btn btn-danger" 
                                            style="padding: 4px 8px; font-size: 12px;" 
                                            onclick="deleteSchedule('${schedule.id}')">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“…</div>
                            <div>è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å®šæ—¶è®¡åˆ’</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½è®¡åˆ’æ•°æ®å¤±è´¥:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                        <button class="btn btn-secondary" onclick="loadScheduleData()" style="margin-top: 16px;">é‡è¯•</button>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // ç®¡ç†é¡µé¢æ“ä½œå‡½æ•°
        function refreshManagement() {
            loadManagementData();
        }

        function refreshSchedules() {
            loadScheduleData();
        }

        async function clearCompletedTasks() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å·²å®Œæˆçš„æ‰¹é‡ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                await apiRequest('/exercise/batch-cleanup', {
                    method: 'DELETE'
                });
                
                alert('å·²å®Œæˆä»»åŠ¡æ¸…ç†å®Œæ¯•');
                loadManagementData();
            } catch (error) {
                console.error('æ¸…ç†ä»»åŠ¡å¤±è´¥:', error);
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        async function viewBatchResults(batchId) {
            try {
                const data = await apiRequest(`/exercise/batch-results/${batchId}`);
                
                if (data.results && data.results.length > 0) {
                    // æ„å»ºç»“æœé¡µé¢URLï¼Œä¼ é€’æ‰¹æ¬¡ç»“æœ
                    sessionStorage.setItem('batchResults', JSON.stringify(data.results));
                    window.location.href = `/frontend/batch-results.html?batch=${batchId}`;
                } else {
                    alert('è¯¥æ‰¹æ¬¡æš‚æ— å¯ç”¨ç»“æœ');
                }
            } catch (error) {
                console.error('è·å–æ‰¹æ¬¡ç»“æœå¤±è´¥:', error);
                alert('è·å–ç»“æœå¤±è´¥: ' + error.message);
            }
        }

        async function refreshBatchStatus(batchId) {
            try {
                const data = await apiRequest(`/exercise/batch-status/${batchId}`);
                alert(`æ‰¹æ¬¡ ${batchId} çŠ¶æ€: ${data.status}\nè¿›åº¦: ${data.progress || 0}%`);
                loadManagementData();
            } catch (error) {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
                alert('åˆ·æ–°å¤±è´¥: ' + error.message);
            }
        }

        async function cancelBatch(batchId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤æ‰¹é‡ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                await apiRequest(`/exercise/batch-cancel/${batchId}`, {
                    method: 'POST'
                });
                
                alert('æ‰¹é‡ä»»åŠ¡å·²å–æ¶ˆ');
                loadManagementData();
            } catch (error) {
                console.error('å–æ¶ˆä»»åŠ¡å¤±è´¥:', error);
                alert('å–æ¶ˆå¤±è´¥: ' + error.message);
            }
        }

        async function toggleSchedule(scheduleId, enabled) {
            try {
                await apiRequest(`/exercise/schedule-toggle/${scheduleId}`, {
                    method: 'POST',
                    body: JSON.stringify({ enabled })
                });
                
                alert(`è®¡åˆ’å·²${enabled ? 'å¯ç”¨' : 'æš‚åœ'}`);
                loadScheduleData();
            } catch (error) {
                console.error('åˆ‡æ¢è®¡åˆ’çŠ¶æ€å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®¡åˆ’å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                return;
            }

            try {
                await apiRequest(`/exercise/schedule/${scheduleId}`, {
                    method: 'DELETE'
                });
                
                alert('è®¡åˆ’å·²åˆ é™¤');
                loadScheduleData();
            } catch (error) {
                console.error('åˆ é™¤è®¡åˆ’å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        function setDefaultDates() {
            const startDateInput = document.getElementById('planStartDate');
            const endDateInput = document.getElementById('planEndDate');
            
            const today = new Date();
            const nextMonth = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            startDateInput.value = today.toISOString().split('T')[0];
            endDateInput.value = nextMonth.toISOString().split('T')[0];
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // è®¾ç½®é»˜è®¤æ—¥æœŸ
                setDefaultDates();
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰é…ç½®æ•°æ®
                await Promise.all([
                    loadSubjects(),
                    loadGrades(),
                    loadDifficultyLevels(),
                    loadQuestionTypes()
                ]);
                
                console.log('æ‰¹é‡å‡ºé¢˜é…ç½®é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>