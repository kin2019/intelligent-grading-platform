<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量智能出题 - 智能教育平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .config-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 12px;
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .form-select, .form-input, .form-textarea {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .batch-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .preview-item:last-child {
            margin-bottom: 0;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .schedule-table th,
        .schedule-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .schedule-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 62, 62, 0.3);
        }

        .loading, .success-message, .error-message {
            display: none;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .loading {
            color: #667eea;
            font-weight: 500;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        .success-message {
            background: #c6f6d5;
            color: #2d7738;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-summary {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .config-card {
                padding: 25px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            .config-tabs {
                flex-direction: column;
            }

            .tab-button {
                margin-bottom: 8px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 批量智能出题</h1>
            <p>一次性生成多套练习，支持定时和计划生成</p>
        </div>

        <!-- 功能选项卡 -->
        <div class="config-tabs">
            <button class="tab-button active" onclick="switchTab('batch')">📦 批量生成</button>
            <button class="tab-button" onclick="switchTab('schedule')">⏰ 定时计划</button>
            <button class="tab-button" onclick="switchTab('management')">📊 批量管理</button>
        </div>

        <!-- 批量生成配置 -->
        <div id="batchTab" class="tab-content active">
            <div class="config-card">
                <form id="batchConfigForm">
                    <!-- 基础设置 -->
                    <div class="form-section">
                        <h3 class="section-title">📚 批量配置</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="batchCount">生成套数</label>
                                <div class="range-group">
                                    <span>1</span>
                                    <input type="range" id="batchCount" class="range-input" 
                                           min="1" max="20" value="5">
                                    <span>20</span>
                                </div>
                                <div class="range-value" id="batchCountValue">5套</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="batchSubject">学科选择</label>
                                <select id="batchSubject" class="form-select" required>
                                    <option value="">请选择学科...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchGrade">年级选择</label>
                                <select id="batchGrade" class="form-select" required>
                                    <option value="">请选择年级...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchDifficulty">难度等级</label>
                                <select id="batchDifficulty" class="form-select" required>
                                    <option value="">请选择难度...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 题目设置 -->
                    <div class="form-section">
                        <h3 class="section-title">⚙️ 题目配置</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">每套题目数量: <span class="range-value" id="questionsPerSetValue">10</span></label>
                                <div class="range-group">
                                    <span>5</span>
                                    <input type="range" id="questionsPerSet" class="range-input" 
                                           min="5" max="50" value="10">
                                    <span>50</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchVariation">题目变化程度</label>
                                <select id="batchVariation" class="form-select">
                                    <option value="low">较少变化 - 相似题型和难度</option>
                                    <option value="medium" selected>适中变化 - 平衡相似性和多样性</option>
                                    <option value="high">较多变化 - 不同题型和难度混合</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchTitle">批次名称</label>
                                <input type="text" id="batchTitle" class="form-input" 
                                       placeholder="例如：数学基础练习 - 第一批" maxlength="100">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="batchDescription">批次描述</label>
                                <textarea id="batchDescription" class="form-textarea" 
                                          placeholder="例如：针对加减法运算的基础练习，适合每日训练使用" maxlength="500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 题型选择 -->
                    <div class="form-section">
                        <h3 class="section-title">📝 题型配置</h3>
                        <div class="checkbox-group" id="batchQuestionTypes">
                            <!-- 动态加载题型选项 -->
                        </div>
                    </div>

                    <!-- 批量预览 -->
                    <div class="batch-preview" id="batchPreview" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #2d3748;">📋 生成预览</h4>
                        <div id="previewContent"></div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="previewBatch()">
                            👁️ 预览配置
                        </button>
                        <button type="submit" class="btn btn-primary" id="generateBatchBtn">
                            ✨ 开始批量生成
                        </button>
                    </div>

                    <div class="loading" id="batchLoading">正在批量生成题目，请稍候...</div>
                    <div class="error-message" id="batchError"></div>
                    <div class="success-message" id="batchSuccess"></div>
                </form>
            </div>
        </div>

        <!-- 定时计划配置 -->
        <div id="scheduleTab" class="tab-content">
            <div class="config-card">
                <form id="scheduleConfigForm">
                    <!-- 计划设置 -->
                    <div class="form-section">
                        <h3 class="section-title">📅 生成计划</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="planType">计划类型</label>
                                <select id="planType" class="form-select" required>
                                    <option value="daily">每日练习 - 每天自动生成</option>
                                    <option value="weekly">每周练习 - 每周生成一套</option>
                                    <option value="monthly">每月练习 - 每月生成练习计划</option>
                                    <option value="custom">自定义计划 - 指定时间和频率</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planStartDate">开始日期</label>
                                <input type="date" id="planStartDate" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planEndDate">结束日期</label>
                                <input type="date" id="planEndDate" class="form-input">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planTime">生成时间</label>
                                <input type="time" id="planTime" class="form-input" value="08:00">
                            </div>
                        </div>
                    </div>

                    <!-- 计划内容配置 -->
                    <div class="form-section">
                        <h3 class="section-title">📋 内容配置</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="planSubject">学科</label>
                                <select id="planSubject" class="form-select" required>
                                    <option value="">请选择学科...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planGrade">年级</label>
                                <select id="planGrade" class="form-select" required>
                                    <option value="">请选择年级...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planQuestionCount">每次题目数量</label>
                                <input type="number" id="planQuestionCount" class="form-input" 
                                       min="5" max="50" value="15">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="planDifficulty">难度级别</label>
                                <select id="planDifficulty" class="form-select" required>
                                    <option value="">请选择难度...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 计划摘要 -->
                    <div class="batch-summary" id="planSummary" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #2d3748; text-align: center;">📊 计划摘要</h4>
                        <div class="summary-grid" id="planSummaryGrid"></div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="previewPlan()">
                            📊 预览计划
                        </button>
                        <button type="submit" class="btn btn-primary" id="createPlanBtn">
                            🚀 创建计划
                        </button>
                    </div>

                    <div class="loading" id="planLoading">正在创建计划...</div>
                    <div class="error-message" id="planError"></div>
                    <div class="success-message" id="planSuccess"></div>
                </form>
            </div>
        </div>

        <!-- 批量管理 -->
        <div id="managementTab" class="tab-content">
            <div class="config-card">
                <div class="form-section">
                    <h3 class="section-title">📊 批量任务管理</h3>
                    <div style="margin-bottom: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="refreshManagement()" style="margin-right: 10px;">
                            🔄 刷新
                        </button>
                        <button class="btn btn-danger" onclick="clearCompletedTasks()">
                            🗑️ 清理已完成
                        </button>
                    </div>
                    
                    <div id="managementContent">
                        <div class="loading" id="managementLoading" style="display: block;">
                            正在加载管理数据...
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">📅 定时计划管理</h3>
                    <div style="margin-bottom: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="refreshSchedules()">
                            🔄 刷新计划
                        </button>
                    </div>
                    
                    <div id="schedulesContent">
                        <div class="loading" id="schedulesLoading" style="display: block;">
                            正在加载计划数据...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API配置
        const API_BASE = 'http://localhost:8000/api/v1';
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');

        // 当前活动的选项卡
        let currentTab = 'batch';

        // API请求工具函数
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }

        // 切换选项卡
        function switchTab(tabName) {
            // 更新选项卡按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            currentTab = tabName;

            // 初始化对应选项卡的数据
            if (tabName === 'management') {
                loadManagementData();
            } else if (tabName === 'schedule') {
                loadScheduleData();
            }
        }

        // 显示消息
        function showMessage(message, type = 'success', tabPrefix = 'batch') {
            const errorEl = document.getElementById(tabPrefix + 'Error');
            const successEl = document.getElementById(tabPrefix + 'Success');
            
            // 隐藏所有消息
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';

            if (type === 'error') {
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
            } else {
                if (successEl) {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                }
                
                // 3秒后自动隐藏成功消息
                if (successEl) {
                    setTimeout(() => {
                        successEl.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // 设置加载状态
        function setLoading(loading, tabPrefix = 'batch', buttonId = null) {
            const loadingEl = document.getElementById(tabPrefix + 'Loading');
            const submitBtn = buttonId ? document.getElementById(buttonId) : null;

            if (loadingEl) {
                loadingEl.style.display = loading ? 'block' : 'none';
            }

            if (submitBtn) {
                submitBtn.disabled = loading;
            }
        }

        // 加载学科列表
        async function loadSubjects() {
            try {
                const data = await apiRequest('/exercise/config/subjects');
                
                // 批量生成的学科选择
                const batchSelect = document.getElementById('batchSubject');
                // 计划生成的学科选择  
                const planSelect = document.getElementById('planSubject');
                
                data.subjects.forEach(subject => {
                    const batchOption = document.createElement('option');
                    batchOption.value = subject;
                    batchOption.textContent = subject;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = subject;
                    planOption.textContent = subject;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('加载学科列表失败:', error);
                showMessage('加载学科列表失败: ' + error.message, 'error');
            }
        }

        // 加载年级列表
        async function loadGrades() {
            try {
                const data = await apiRequest('/exercise/config/grades');
                
                const batchSelect = document.getElementById('batchGrade');
                const planSelect = document.getElementById('planGrade');
                
                data.grades.forEach(grade => {
                    const batchOption = document.createElement('option');
                    batchOption.value = grade;
                    batchOption.textContent = grade;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = grade;
                    planOption.textContent = grade;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('加载年级列表失败:', error);
                showMessage('加载年级列表失败: ' + error.message, 'error');
            }
        }

        // 加载难度等级
        async function loadDifficultyLevels() {
            try {
                const data = await apiRequest('/exercise/config/difficulty-levels');
                
                const batchSelect = document.getElementById('batchDifficulty');
                const planSelect = document.getElementById('planDifficulty');
                
                Object.entries(data.difficulty_levels).forEach(([key, config]) => {
                    const batchOption = document.createElement('option');
                    batchOption.value = key;
                    batchOption.textContent = `${config.name} - ${config.description}`;
                    batchSelect.appendChild(batchOption);
                    
                    const planOption = document.createElement('option');
                    planOption.value = key;
                    planOption.textContent = `${config.name} - ${config.description}`;
                    planSelect.appendChild(planOption);
                });
            } catch (error) {
                console.error('加载难度等级失败:', error);
                showMessage('加载难度等级失败: ' + error.message, 'error');
            }
        }

        // 加载题型选择
        async function loadQuestionTypes() {
            try {
                const data = await apiRequest('/exercise/config/question-types');
                const container = document.getElementById('batchQuestionTypes');
                
                Object.entries(data.question_types).forEach(([key, config]) => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    div.innerHTML = `
                        <input type="checkbox" id="batch_type_${key}" name="batchQuestionTypes" value="${key}" ${key === 'similar' ? 'checked' : ''}>
                        <label for="batch_type_${key}">
                            <strong>${config.name}</strong><br>
                            <small style="color: #718096;">${config.description}</small>
                        </label>
                    `;
                    
                    container.appendChild(div);

                    // 添加点击事件
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        div.classList.toggle('selected', div.querySelector('input').checked);
                    });

                    // 初始状态
                    if (key === 'similar') {
                        div.classList.add('selected');
                    }
                });
            } catch (error) {
                console.error('加载题型选择失败:', error);
                showMessage('加载题型选择失败: ' + error.message, 'error');
            }
        }

        // 滑块事件处理
        document.getElementById('batchCount').addEventListener('input', (e) => {
            document.getElementById('batchCountValue').textContent = e.target.value + '套';
        });

        document.getElementById('questionsPerSet').addEventListener('input', (e) => {
            document.getElementById('questionsPerSetValue').textContent = e.target.value;
        });

        // 预览批量配置
        function previewBatch() {
            const count = parseInt(document.getElementById('batchCount').value);
            const subject = document.getElementById('batchSubject').value;
            const grade = document.getElementById('batchGrade').value;
            const difficulty = document.getElementById('batchDifficulty').value;
            const questionsPerSet = parseInt(document.getElementById('questionsPerSet').value);
            const variation = document.getElementById('batchVariation').value;

            if (!subject || !grade || !difficulty) {
                showMessage('请填写完整的基础配置信息', 'error');
                return;
            }

            const preview = document.getElementById('batchPreview');
            const content = document.getElementById('previewContent');

            let previewHtml = '';
            const variationText = {
                'low': '相似题型',
                'medium': '适中变化', 
                'high': '多样变化'
            };

            for (let i = 1; i <= count; i++) {
                previewHtml += `
                    <div class="preview-item">
                        <div>
                            <strong>${subject} ${grade} 练习题 - 第${i}套</strong><br>
                            <small>${questionsPerSet}道题 · ${variationText[variation]} · ${difficulty}难度</small>
                        </div>
                        <div style="color: #007AFF; font-weight: 600;">预计5-10分钟</div>
                    </div>
                `;
            }

            content.innerHTML = previewHtml;
            preview.style.display = 'block';

            // 滚动到预览区域
            preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 批量生成表单提交
        document.getElementById('batchConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true, 'batch', 'generateBatchBtn');
            
            try {
                // 收集表单数据
                const selectedTypes = Array.from(document.querySelectorAll('input[name="batchQuestionTypes"]:checked'))
                    .map(cb => cb.value);

                if (selectedTypes.length === 0) {
                    throw new Error('请至少选择一种题型');
                }

                const config = {
                    batch_count: parseInt(document.getElementById('batchCount').value),
                    subject: document.getElementById('batchSubject').value,
                    grade: document.getElementById('batchGrade').value,
                    questions_per_set: parseInt(document.getElementById('questionsPerSet').value),
                    difficulty_level: document.getElementById('batchDifficulty').value,
                    variation_level: document.getElementById('batchVariation').value,
                    question_types: selectedTypes,
                    title: document.getElementById('batchTitle').value || `${document.getElementById('batchSubject').value}批量练习`,
                    description: document.getElementById('batchDescription').value || '批量生成的练习题',
                    include_answers: true,
                    include_analysis: true
                };

                // 验证必填字段
                if (!config.subject || !config.grade || !config.difficulty_level) {
                    throw new Error('请填写完整的基础配置信息');
                }

                console.log('批量生成配置:', config);

                // 发送批量生成请求
                const response = await apiRequest('/exercise/batch-generate', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                showMessage(`批量生成任务已启动！批次ID: ${response.batch_id}`, 'success');
                
                // 存储批次ID
                sessionStorage.setItem('lastBatchId', response.batch_id);

                // 3秒后跳转到管理页面查看进度
                setTimeout(() => {
                    switchTab('management');
                    loadManagementData();
                }, 3000);

            } catch (error) {
                console.error('批量生成失败:', error);
                showMessage('批量生成失败: ' + error.message, 'error');
            } finally {
                setLoading(false, 'batch', 'generateBatchBtn');
            }
        });

        // 预览计划
        function previewPlan() {
            const planType = document.getElementById('planType').value;
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = document.getElementById('planEndDate').value ? new Date(document.getElementById('planEndDate').value) : null;
            const questionCount = parseInt(document.getElementById('planQuestionCount').value);

            if (!planType || !startDate) {
                showMessage('请填写计划基础信息', 'error', 'plan');
                return;
            }

            // 计算预计生成数据
            let estimatedSets = 0;
            let totalQuestions = 0;
            let duration = '';

            const now = new Date();
            const end = endDate || new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 默认30天

            const daysDiff = Math.ceil((end - startDate) / (1000 * 60 * 60 * 24));

            switch (planType) {
                case 'daily':
                    estimatedSets = daysDiff;
                    duration = `${daysDiff}天`;
                    break;
                case 'weekly':
                    estimatedSets = Math.ceil(daysDiff / 7);
                    duration = `${Math.ceil(daysDiff / 7)}周`;
                    break;
                case 'monthly':
                    estimatedSets = Math.ceil(daysDiff / 30);
                    duration = `${Math.ceil(daysDiff / 30)}个月`;
                    break;
                default:
                    estimatedSets = daysDiff; // 自定义按日计算
                    duration = `${daysDiff}天（自定义）`;
            }

            totalQuestions = estimatedSets * questionCount;

            // 显示摘要
            const summary = document.getElementById('planSummary');
            const summaryGrid = document.getElementById('planSummaryGrid');

            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-number">${estimatedSets}</div>
                    <div class="summary-label">预计套数</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${totalQuestions}</div>
                    <div class="summary-label">总题目数</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${duration}</div>
                    <div class="summary-label">持续时间</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">${planType === 'daily' ? '每日' : planType === 'weekly' ? '每周' : '每月'}</div>
                    <div class="summary-label">生成频率</div>
                </div>
            `;

            summary.style.display = 'block';
            summary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 计划生成表单提交
        document.getElementById('scheduleConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true, 'plan', 'createPlanBtn');
            
            try {
                const config = {
                    plan_type: document.getElementById('planType').value,
                    subject: document.getElementById('planSubject').value,
                    grade: document.getElementById('planGrade').value,
                    difficulty_level: document.getElementById('planDifficulty').value,
                    question_count: parseInt(document.getElementById('planQuestionCount').value),
                    start_date: document.getElementById('planStartDate').value,
                    end_date: document.getElementById('planEndDate').value,
                    generation_time: document.getElementById('planTime').value,
                    enabled: true
                };

                // 验证必填字段
                if (!config.plan_type || !config.subject || !config.grade || !config.difficulty_level || !config.start_date) {
                    throw new Error('请填写完整的计划配置信息');
                }

                console.log('定时计划配置:', config);

                // 发送计划创建请求
                const response = await apiRequest('/exercise/create-schedule', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                showMessage(`定时计划创建成功！计划ID: ${response.schedule_id}`, 'success', 'plan');
                
                // 重置表单
                document.getElementById('scheduleConfigForm').reset();
                document.getElementById('planSummary').style.display = 'none';

                // 3秒后跳转到管理页面
                setTimeout(() => {
                    switchTab('management');
                    loadScheduleData();
                }, 3000);

            } catch (error) {
                console.error('创建计划失败:', error);
                showMessage('创建计划失败: ' + error.message, 'error', 'plan');
            } finally {
                setLoading(false, 'plan', 'createPlanBtn');
            }
        });

        // 加载管理数据
        async function loadManagementData() {
            const content = document.getElementById('managementContent');
            const loading = document.getElementById('managementLoading');
            
            loading.style.display = 'block';

            try {
                const data = await apiRequest('/exercise/batch-status');
                
                if (data.batches && data.batches.length > 0) {
                    let html = `
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>批次ID</th>
                                    <th>名称</th>
                                    <th>进度</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.batches.forEach(batch => {
                        const statusClass = `status-${batch.status}`;
                        const statusText = {
                            'pending': '等待中',
                            'running': '生成中',
                            'completed': '已完成',
                            'failed': '失败'
                        }[batch.status] || '未知';

                        const progress = batch.completed_count && batch.total_count ? 
                            Math.round((batch.completed_count / batch.total_count) * 100) : 0;

                        html += `
                            <tr>
                                <td><code>${batch.id}</code></td>
                                <td>${batch.title || '未命名批次'}</td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 8px; margin-right: 8px;">
                                            <div style="width: ${progress}%; background: #667eea; height: 100%; border-radius: 10px;"></div>
                                        </div>
                                        <span style="font-size: 12px;">${progress}%</span>
                                    </div>
                                </td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${new Date(batch.created_at).toLocaleString()}</td>
                                <td>
                                    ${batch.status === 'completed' ? 
                                        `<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="viewBatchResults('${batch.id}')">查看结果</button>` :
                                        batch.status === 'running' ?
                                        `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="refreshBatchStatus('${batch.id}')">刷新</button>` :
                                        `<button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="cancelBatch('${batch.id}')">取消</button>`
                                    }
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
                            <div>还没有批量生成任务</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载管理数据失败:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <div>加载失败: ${error.message}</div>
                        <button class="btn btn-secondary" onclick="loadManagementData()" style="margin-top: 16px;">重试</button>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // 加载计划数据
        async function loadScheduleData() {
            const content = document.getElementById('schedulesContent');
            const loading = document.getElementById('schedulesLoading');
            
            loading.style.display = 'block';

            try {
                const data = await apiRequest('/exercise/schedules');
                
                if (data.schedules && data.schedules.length > 0) {
                    let html = `
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>计划名称</th>
                                    <th>类型</th>
                                    <th>下次生成</th>
                                    <th>状态</th>
                                    <th>已生成</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.schedules.forEach(schedule => {
                        const statusClass = schedule.enabled ? 'status-running' : 'status-pending';
                        const statusText = schedule.enabled ? '运行中' : '已暂停';

                        const typeText = {
                            'daily': '每日',
                            'weekly': '每周',
                            'monthly': '每月',
                            'custom': '自定义'
                        }[schedule.plan_type] || '未知';

                        html += `
                            <tr>
                                <td>${schedule.subject} ${schedule.grade} 练习</td>
                                <td>${typeText}</td>
                                <td>${schedule.next_generation ? new Date(schedule.next_generation).toLocaleString() : '--'}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${schedule.generated_count || 0} 套</td>
                                <td>
                                    <button class="btn ${schedule.enabled ? 'btn-secondary' : 'btn-primary'}" 
                                            style="padding: 4px 8px; font-size: 12px; margin-right: 4px;" 
                                            onclick="toggleSchedule('${schedule.id}', ${!schedule.enabled})">
                                        ${schedule.enabled ? '暂停' : '启用'}
                                    </button>
                                    <button class="btn btn-danger" 
                                            style="padding: 4px 8px; font-size: 12px;" 
                                            onclick="deleteSchedule('${schedule.id}')">
                                        删除
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📅</div>
                            <div>还没有创建任何定时计划</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载计划数据失败:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <div>加载失败: ${error.message}</div>
                        <button class="btn btn-secondary" onclick="loadScheduleData()" style="margin-top: 16px;">重试</button>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // 管理页面操作函数
        function refreshManagement() {
            loadManagementData();
        }

        function refreshSchedules() {
            loadScheduleData();
        }

        async function clearCompletedTasks() {
            if (!confirm('确定要清理所有已完成的批量任务吗？')) {
                return;
            }

            try {
                await apiRequest('/exercise/batch-cleanup', {
                    method: 'DELETE'
                });
                
                alert('已完成任务清理完毕');
                loadManagementData();
            } catch (error) {
                console.error('清理任务失败:', error);
                alert('清理失败: ' + error.message);
            }
        }

        async function viewBatchResults(batchId) {
            try {
                const data = await apiRequest(`/exercise/batch-results/${batchId}`);
                
                if (data.results && data.results.length > 0) {
                    // 构建结果页面URL，传递批次结果
                    sessionStorage.setItem('batchResults', JSON.stringify(data.results));
                    window.location.href = `/frontend/batch-results.html?batch=${batchId}`;
                } else {
                    alert('该批次暂无可用结果');
                }
            } catch (error) {
                console.error('获取批次结果失败:', error);
                alert('获取结果失败: ' + error.message);
            }
        }

        async function refreshBatchStatus(batchId) {
            try {
                const data = await apiRequest(`/exercise/batch-status/${batchId}`);
                alert(`批次 ${batchId} 状态: ${data.status}\n进度: ${data.progress || 0}%`);
                loadManagementData();
            } catch (error) {
                console.error('刷新状态失败:', error);
                alert('刷新失败: ' + error.message);
            }
        }

        async function cancelBatch(batchId) {
            if (!confirm('确定要取消此批量任务吗？')) {
                return;
            }

            try {
                await apiRequest(`/exercise/batch-cancel/${batchId}`, {
                    method: 'POST'
                });
                
                alert('批量任务已取消');
                loadManagementData();
            } catch (error) {
                console.error('取消任务失败:', error);
                alert('取消失败: ' + error.message);
            }
        }

        async function toggleSchedule(scheduleId, enabled) {
            try {
                await apiRequest(`/exercise/schedule-toggle/${scheduleId}`, {
                    method: 'POST',
                    body: JSON.stringify({ enabled })
                });
                
                alert(`计划已${enabled ? '启用' : '暂停'}`);
                loadScheduleData();
            } catch (error) {
                console.error('切换计划状态失败:', error);
                alert('操作失败: ' + error.message);
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('确定要删除此计划吗？删除后无法恢复。')) {
                return;
            }

            try {
                await apiRequest(`/exercise/schedule/${scheduleId}`, {
                    method: 'DELETE'
                });
                
                alert('计划已删除');
                loadScheduleData();
            } catch (error) {
                console.error('删除计划失败:', error);
                alert('删除失败: ' + error.message);
            }
        }

        // 设置默认日期
        function setDefaultDates() {
            const startDateInput = document.getElementById('planStartDate');
            const endDateInput = document.getElementById('planEndDate');
            
            const today = new Date();
            const nextMonth = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            startDateInput.value = today.toISOString().split('T')[0];
            endDateInput.value = nextMonth.toISOString().split('T')[0];
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 设置默认日期
                setDefaultDates();
                
                // 并行加载所有配置数据
                await Promise.all([
                    loadSubjects(),
                    loadGrades(),
                    loadDifficultyLevels(),
                    loadQuestionTypes()
                ]);
                
                console.log('批量出题配置页面初始化完成');
            } catch (error) {
                console.error('页面初始化失败:', error);
                showMessage('页面初始化失败: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>