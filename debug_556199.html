<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•ä½œä¸š556199æ•°æ®æµ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .button { 
            padding: 10px 16px; 
            margin: 5px; 
            background: #007AFF; 
            color: white; 
            border: none;
            border-radius: 4px; 
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä½œä¸šID 556199 æ•°æ®æµè°ƒè¯•</h1>
    
    <button onclick="testFallbackData()" class="button">æµ‹è¯•Fallbackæ•°æ®ç”Ÿæˆ</button>
    <button onclick="testCompleteFlow()" class="button">æµ‹è¯•å®Œæ•´æ•°æ®æµ</button>
    
    <div id="results"></div>

    <script>
        const homeworkId = '556199';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `result ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(logDiv);
        }

        function generateFallbackData() {
            // å¤åˆ¶å‰ç«¯çš„é€»è¾‘
            console.log(`ä½œä¸šID ${homeworkId} - æ— æ³•è·å–å‡†ç¡®æ•°æ®ï¼Œæä¾›è¯†åˆ«æç¤º`);
            
            // ç‰¹æ®Šå¤„ç†ï¼šå·²çŸ¥çš„æµ‹è¯•ä½œä¸šID
            const knownTestIds = [898411, 773191, 942516, 942737, 899573];
            if (knownTestIds.includes(parseInt(homeworkId))) {
                log('è¿™æ˜¯å·²çŸ¥æµ‹è¯•IDï¼Œåº”è¯¥ç”Ÿæˆæ¼”ç¤ºæ•°æ®', 'info');
                return generateTestData();
            }
            
            log('è¿™ä¸æ˜¯å·²çŸ¥æµ‹è¯•IDï¼Œåº”è¯¥è¿”å›è¯†åˆ«å¤±è´¥æç¤º', 'warning');
            
            // å¯¹äºå…¶ä»–IDï¼Œè¿”å›è¯†åˆ«å¤±è´¥çš„å‹å¥½æç¤º
            return {
                id: homeworkId,
                subject: 'unknown',
                total_questions: 0,
                correct_count: 0,
                wrong_count: 0,
                accuracy_rate: 0,
                status: 'recognition_failed',
                original_image_url: `/uploads/homework/homework_${homeworkId}_1.jpg`,
                correction_results: [],
                created_at: new Date().toISOString(),
                special_message: {
                    type: 'recognition_failed',
                    title: 'æ— æ³•è¯†åˆ«ä½œä¸šå†…å®¹',
                    content: 'æŠ±æ­‰ï¼Œç³»ç»Ÿæ— æ³•ä»å›¾ç‰‡ä¸­è¯†åˆ«å‡ºæ¸…æ™°çš„ä½œä¸šé¢˜ç›®ã€‚',
                    suggestions: [
                        'è¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°åº¦è¶³å¤Ÿï¼Œæ–‡å­—å¯ä»¥æ¸…æ¥šè¾¨è®¤',
                        'ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…é˜´å½±é®æŒ¡é¢˜ç›®',
                        'é‡æ–°æ‹æ‘„å¹¶ä¸Šä¼ æ›´æ¸…æ™°çš„ä½œä¸šå›¾ç‰‡'
                    ],
                    reason: 'ocr_failed'
                }
            };
        }

        function testFallbackData() {
            log('=== æµ‹è¯•Fallbackæ•°æ®ç”Ÿæˆ ===', 'info');
            
            const data = generateFallbackData();
            
            log(`ç”Ÿæˆçš„æ•°æ®:`, 'info');
            log(`- ID: ${data.id}`, 'info');
            log(`- subject: ${data.subject}`, 'info');
            log(`- total_questions: ${data.total_questions}`, 'info');
            log(`- correct_count: ${data.correct_count}`, 'info');
            log(`- correction_resultsé•¿åº¦: ${data.correction_results.length}`, 'info');
            log(`- special_messageç±»å‹: ${data.special_message?.type}`, 'info');
            log(`- special_messageæ ‡é¢˜: ${data.special_message?.title}`, 'info');
            
            if (data.correction_results.length === 0 && data.special_message?.type === 'recognition_failed') {
                log('âœ… æ•°æ®æ­£ç¡®ï¼šæ²¡æœ‰é¢˜ç›®ï¼Œæœ‰è¯†åˆ«å¤±è´¥æç¤º', 'success');
            } else {
                log('âŒ æ•°æ®é”™è¯¯ï¼šåº”è¯¥æ²¡æœ‰é¢˜ç›®ä½†ä»æœ‰æ•°æ®', 'error');
            }
        }

        async function testCompleteFlow() {
            log('=== æµ‹è¯•å®Œæ•´æ•°æ®æµ ===', 'info');
            
            // æ¨¡æ‹Ÿå‰ç«¯çš„å®Œæ•´é€»è¾‘
            const fallbackData = generateFallbackData();
            let finalData = fallbackData;
            
            log('1. ç”ŸæˆfallbackDataå®Œæˆ', 'info');
            
            // æ¨¡æ‹ŸAPIè°ƒç”¨
            try {
                const response = await fetch(`http://localhost:8000/api/v1/homework/result/${homeworkId}`);
                log(`2. APIå“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                if (response.ok) {
                    const apiData = await response.json();
                    log('3. APIè°ƒç”¨æˆåŠŸï¼Œä½†è¿™ä¸åº”è¯¥å‘ç”Ÿ', 'warning');
                } else {
                    log('3. APIè°ƒç”¨å¤±è´¥ï¼ˆé¢„æœŸï¼‰ï¼Œä½¿ç”¨fallbackæ•°æ®', 'info');
                }
            } catch (error) {
                log(`3. APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'info');
            }
            
            // æ¨¡æ‹Ÿæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
            if (!finalData.correction_results || !Array.isArray(finalData.correction_results)) {
                log('4. âŒ è¿™ä¸åº”è¯¥å‘ç”Ÿï¼šcorrection_resultsä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„', 'error');
                finalData.correction_results = fallbackData.correction_results;
            } else {
                log(`4. âœ… correction_resultsæ­£å¸¸ï¼Œé•¿åº¦: ${finalData.correction_results.length}`, 'success');
            }
            
            log('=== æœ€ç»ˆæ•°æ®æ£€æŸ¥ ===', 'info');
            log(`æœ€ç»ˆé¢˜ç›®æ•°é‡: ${finalData.correction_results.length}`, finalData.correction_results.length === 0 ? 'success' : 'error');
            log(`æ˜¯å¦æœ‰ç‰¹æ®Šæ¶ˆæ¯: ${!!finalData.special_message}`, finalData.special_message ? 'success' : 'error');
            
            if (finalData.correction_results.length === 0 && finalData.special_message) {
                log('ğŸ‰ å®Œæ•´æµç¨‹æ­£ç¡®ï¼šæ— é¢˜ç›®ï¼Œæœ‰å‹å¥½æç¤º', 'success');
            } else {
                log('ğŸ’¥ å®Œæ•´æµç¨‹æœ‰é—®é¢˜ï¼šä»ç„¶ç”Ÿæˆäº†è™šå‡é¢˜ç›®', 'error');
                log(`è¯¦ç»†æ•°æ®: ${JSON.stringify(finalData, null, 2)}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            setTimeout(testFallbackData, 500);
        };
    </script>
</body>
</html>