<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>调试统计数字波动问题</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stats-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; text-align: center; }
        .stats-number { font-size: 24px; font-weight: bold; color: #ff6b6b; margin-bottom: 4px; }
        .stats-label { font-size: 12px; color: #666; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .monitor { position: fixed; top: 10px; right: 10px; width: 300px; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; z-index: 1000; }
    </style>
</head>
<body>
    <h1>🔍 调试统计数字波动问题</h1>
    
    <div class="monitor" id="monitor">
        <h4>📊 统计变化监控</h4>
        <div id="monitorContent">初始化中...</div>
    </div>
    
    <div class="test-section info">
        <h3>🎯 问题描述</h3>
        <p>错题本页面的总错题、未复习、已复习数字每次刷新都会变化</p>
        <p><strong>可能原因：</strong></p>
        <ul>
            <li>模拟数据中使用了随机数生成复习状态</li>
            <li>localStorage状态与API状态计算逻辑不一致</li>
            <li>数据源混乱（API数据 vs 模拟数据）</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>🛠️ 调试操作</h3>
        <button class="btn-primary" onclick="testMultipleLoads()">🔄 多次加载测试</button>
        <button class="btn-success" onclick="compareDataSources()">📊 对比数据源</button>
        <button class="btn-danger" onclick="clearStorage()">🧹 清除localStorage</button>
    </div>

    <div class="test-section">
        <h3>📊 统计数字变化记录</h3>
        <div id="statsHistory"></div>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';
        
        let statsHistory = [];
        let loadCount = 0;

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function updateMonitor() {
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            const monitor = document.getElementById('monitorContent');
            
            const latest = statsHistory.length > 0 ? statsHistory[statsHistory.length - 1] : null;
            
            monitor.innerHTML = `
                <p><strong>加载次数:</strong> ${loadCount}</p>
                <p><strong>localStorage复习:</strong> [${reviewedErrors.join(', ')}] (${reviewedErrors.length}个)</p>
                ${latest ? `
                <p><strong>最新统计:</strong></p>
                <p>总错题: ${latest.total}</p>
                <p>未复习: ${latest.unreviewed}</p>
                <p>已复习: ${latest.reviewed}</p>
                ` : ''}
                <p><strong>变化次数:</strong> ${getVariationCount()}</p>
            `;
        }

        function getVariationCount() {
            if (statsHistory.length < 2) return 0;
            let variations = 0;
            for (let i = 1; i < statsHistory.length; i++) {
                const prev = statsHistory[i-1];
                const curr = statsHistory[i];
                if (prev.total !== curr.total || prev.unreviewed !== curr.unreviewed || prev.reviewed !== curr.reviewed) {
                    variations++;
                }
            }
            return variations;
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            statsHistory = [];
            loadCount = 0;
            addResult('✅ localStorage已清除', 'success');
            updateMonitor();
            updateStatsHistory();
        }

        async function loadErrorBookData() {
            loadCount++;
            addResult(`🔄 第${loadCount}次加载错题本数据...`, 'info');

            try {
                // 模拟错题本页面的数据加载逻辑
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                let errorData = [];
                let statsResult = {};

                if (response.ok) {
                    const data = await response.json();
                    errorData = data.recent_errors || [];
                    
                    // 同步localStorage状态（模拟syncLocalReviewStatus）
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });
                    
                    // 计算统计（模拟calculateRealStats）
                    const totalErrors = errorData.length;
                    const unreviewed = errorData.filter(error => !error.is_reviewed).length;
                    const reviewed = errorData.filter(error => error.is_reviewed).length;
                    
                    statsResult = { total: totalErrors, unreviewed, reviewed, source: 'API' };
                    
                } else {
                    // 使用模拟数据（这里可能是问题所在）
                    addResult('⚠️ API失败，使用模拟数据', 'warning');
                    errorData = generateMockData();
                    
                    // 同步localStorage状态
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });
                    
                    const totalErrors = errorData.length;
                    const unreviewed = errorData.filter(error => !error.is_reviewed).length;
                    const reviewed = errorData.filter(error => error.is_reviewed).length;
                    
                    statsResult = { total: totalErrors, unreviewed, reviewed, source: 'Mock' };
                }

                // 记录统计结果
                statsHistory.push({
                    loadTime: new Date().toLocaleTimeString(),
                    ...statsResult
                });

                addResult(`
                    <h4>📊 第${loadCount}次加载结果</h4>
                    <p><strong>数据源:</strong> ${statsResult.source}</p>
                    <p><strong>总错题:</strong> ${statsResult.total}</p>
                    <p><strong>未复习:</strong> ${statsResult.unreviewed}</p>
                    <p><strong>已复习:</strong> ${statsResult.reviewed}</p>
                `, 'info');

                updateMonitor();
                updateStatsHistory();

            } catch (error) {
                addResult(`❌ 加载失败: ${error.message}`, 'error');
            }
        }

        function generateMockData() {
            // 这个函数模拟错题本页面的showMockData函数
            // 检查是否有随机元素导致数据不稳定
            return [
                {
                    id: 1, subject: '数学', question_text: '计算：125 × 8 = ?',
                    user_answer: '900', correct_answer: '1000', error_type: '计算错误',
                    knowledge_points: ['乘法运算'], is_reviewed: false, // 固定为false
                    created_at: '2025-08-20T10:30:00Z'
                },
                {
                    id: 2, subject: '语文', question_text: '下列词语中，没有错别字的一组是（）',
                    user_answer: 'A', correct_answer: 'B', error_type: '识字错误',
                    knowledge_points: ['错别字辨析'], is_reviewed: true, // 固定为true
                    created_at: '2025-08-19T15:20:00Z'
                },
                {
                    id: 3, subject: '英语', question_text: 'Choose the correct answer: I ____ to school every day.',
                    user_answer: 'goes', correct_answer: 'go', error_type: '语法错误',
                    knowledge_points: ['一般现在时'], is_reviewed: false, // 固定为false
                    created_at: '2025-08-19T09:15:00Z'
                }
                // 添加更多测试数据...
            ];
        }

        function updateStatsHistory() {
            const historyContainer = document.getElementById('statsHistory');
            if (statsHistory.length === 0) {
                historyContainer.innerHTML = '<p>暂无数据</p>';
                return;
            }

            const historyHTML = statsHistory.map((stats, index) => `
                <div class="stats-card">
                    <div class="stats-number">第${index + 1}次</div>
                    <div class="stats-label">${stats.loadTime}</div>
                    <div style="margin-top: 8px;">
                        <div>总: ${stats.total} | 未: ${stats.unreviewed} | 已: ${stats.reviewed}</div>
                        <div style="font-size: 10px; color: #666;">${stats.source}</div>
                    </div>
                </div>
            `).join('');

            historyContainer.innerHTML = `<div class="comparison">${historyHTML}</div>`;

            // 分析是否有变化
            if (statsHistory.length >= 2) {
                const variations = getVariationCount();
                if (variations > 0) {
                    addResult(`⚠️ 检测到统计数字变化 ${variations} 次！`, 'warning');
                } else {
                    addResult(`✅ 统计数字保持稳定`, 'success');
                }
            }
        }

        async function testMultipleLoads() {
            document.getElementById('results').innerHTML = '';
            addResult('🚀 开始多次加载测试（5次）...', 'info');

            for (let i = 0; i < 5; i++) {
                await loadErrorBookData();
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
            }

            addResult(`
                <h4>📈 测试完成总结</h4>
                <p><strong>总加载次数:</strong> ${loadCount}</p>
                <p><strong>统计变化次数:</strong> ${getVariationCount()}</p>
                <p><strong>结论:</strong> ${getVariationCount() > 0 ? '数字存在波动，需要修复' : '数字稳定，无问题'}</p>
            `, getVariationCount() > 0 ? 'warning' : 'success');
        }

        async function compareDataSources() {
            addResult('📊 对比不同数据源的统计结果...', 'info');

            try {
                // 1. 尝试获取API数据
                let apiStats = null;
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const errors = data.recent_errors || [];
                        apiStats = {
                            total: errors.length,
                            unreviewed: errors.filter(e => !e.is_reviewed).length,
                            reviewed: errors.filter(e => e.is_reviewed).length
                        };
                    }
                } catch (e) {
                    addResult('⚠️ API数据获取失败', 'warning');
                }

                // 2. 生成模拟数据统计
                const mockErrors = generateMockData();
                const mockStats = {
                    total: mockErrors.length,
                    unreviewed: mockErrors.filter(e => !e.is_reviewed).length,
                    reviewed: mockErrors.filter(e => e.is_reviewed).length
                };

                // 3. 对比结果
                addResult(`
                    <h4>📊 数据源对比</h4>
                    <div class="comparison">
                        ${apiStats ? `
                        <div class="stats-card">
                            <div class="stats-number">API数据</div>
                            <div>总: ${apiStats.total}</div>
                            <div>未: ${apiStats.unreviewed}</div>
                            <div>已: ${apiStats.reviewed}</div>
                        </div>
                        ` : ''}
                        <div class="stats-card">
                            <div class="stats-number">模拟数据</div>
                            <div>总: ${mockStats.total}</div>
                            <div>未: ${mockStats.unreviewed}</div>
                            <div>已: ${mockStats.reviewed}</div>
                        </div>
                    </div>
                `, 'info');

            } catch (error) {
                addResult(`❌ 对比失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时初始化
        localStorage.setItem('token', TOKEN);
        updateMonitor();

        // 自动进行一次加载测试
        setTimeout(() => {
            loadErrorBookData();
        }, 1000);
    </script>
</body>
</html>