<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è°ƒè¯•ç»Ÿè®¡æ•°å­—æ³¢åŠ¨é—®é¢˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stats-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; text-align: center; }
        .stats-number { font-size: 24px; font-weight: bold; color: #ff6b6b; margin-bottom: 4px; }
        .stats-label { font-size: 12px; color: #666; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .monitor { position: fixed; top: 10px; right: 10px; width: 300px; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; z-index: 1000; }
    </style>
</head>
<body>
    <h1>ğŸ” è°ƒè¯•ç»Ÿè®¡æ•°å­—æ³¢åŠ¨é—®é¢˜</h1>
    
    <div class="monitor" id="monitor">
        <h4>ğŸ“Š ç»Ÿè®¡å˜åŒ–ç›‘æ§</h4>
        <div id="monitorContent">åˆå§‹åŒ–ä¸­...</div>
    </div>
    
    <div class="test-section info">
        <h3>ğŸ¯ é—®é¢˜æè¿°</h3>
        <p>é”™é¢˜æœ¬é¡µé¢çš„æ€»é”™é¢˜ã€æœªå¤ä¹ ã€å·²å¤ä¹ æ•°å­—æ¯æ¬¡åˆ·æ–°éƒ½ä¼šå˜åŒ–</p>
        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
        <ul>
            <li>æ¨¡æ‹Ÿæ•°æ®ä¸­ä½¿ç”¨äº†éšæœºæ•°ç”Ÿæˆå¤ä¹ çŠ¶æ€</li>
            <li>localStorageçŠ¶æ€ä¸APIçŠ¶æ€è®¡ç®—é€»è¾‘ä¸ä¸€è‡´</li>
            <li>æ•°æ®æºæ··ä¹±ï¼ˆAPIæ•°æ® vs æ¨¡æ‹Ÿæ•°æ®ï¼‰</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>ğŸ› ï¸ è°ƒè¯•æ“ä½œ</h3>
        <button class="btn-primary" onclick="testMultipleLoads()">ğŸ”„ å¤šæ¬¡åŠ è½½æµ‹è¯•</button>
        <button class="btn-success" onclick="compareDataSources()">ğŸ“Š å¯¹æ¯”æ•°æ®æº</button>
        <button class="btn-danger" onclick="clearStorage()">ğŸ§¹ æ¸…é™¤localStorage</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š ç»Ÿè®¡æ•°å­—å˜åŒ–è®°å½•</h3>
        <div id="statsHistory"></div>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';
        
        let statsHistory = [];
        let loadCount = 0;

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function updateMonitor() {
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            const monitor = document.getElementById('monitorContent');
            
            const latest = statsHistory.length > 0 ? statsHistory[statsHistory.length - 1] : null;
            
            monitor.innerHTML = `
                <p><strong>åŠ è½½æ¬¡æ•°:</strong> ${loadCount}</p>
                <p><strong>localStorageå¤ä¹ :</strong> [${reviewedErrors.join(', ')}] (${reviewedErrors.length}ä¸ª)</p>
                ${latest ? `
                <p><strong>æœ€æ–°ç»Ÿè®¡:</strong></p>
                <p>æ€»é”™é¢˜: ${latest.total}</p>
                <p>æœªå¤ä¹ : ${latest.unreviewed}</p>
                <p>å·²å¤ä¹ : ${latest.reviewed}</p>
                ` : ''}
                <p><strong>å˜åŒ–æ¬¡æ•°:</strong> ${getVariationCount()}</p>
            `;
        }

        function getVariationCount() {
            if (statsHistory.length < 2) return 0;
            let variations = 0;
            for (let i = 1; i < statsHistory.length; i++) {
                const prev = statsHistory[i-1];
                const curr = statsHistory[i];
                if (prev.total !== curr.total || prev.unreviewed !== curr.unreviewed || prev.reviewed !== curr.reviewed) {
                    variations++;
                }
            }
            return variations;
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            statsHistory = [];
            loadCount = 0;
            addResult('âœ… localStorageå·²æ¸…é™¤', 'success');
            updateMonitor();
            updateStatsHistory();
        }

        async function loadErrorBookData() {
            loadCount++;
            addResult(`ğŸ”„ ç¬¬${loadCount}æ¬¡åŠ è½½é”™é¢˜æœ¬æ•°æ®...`, 'info');

            try {
                // æ¨¡æ‹Ÿé”™é¢˜æœ¬é¡µé¢çš„æ•°æ®åŠ è½½é€»è¾‘
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                
                let errorData = [];
                let statsResult = {};

                if (response.ok) {
                    const data = await response.json();
                    errorData = data.recent_errors || [];
                    
                    // åŒæ­¥localStorageçŠ¶æ€ï¼ˆæ¨¡æ‹ŸsyncLocalReviewStatusï¼‰
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });
                    
                    // è®¡ç®—ç»Ÿè®¡ï¼ˆæ¨¡æ‹ŸcalculateRealStatsï¼‰
                    const totalErrors = errorData.length;
                    const unreviewed = errorData.filter(error => !error.is_reviewed).length;
                    const reviewed = errorData.filter(error => error.is_reviewed).length;
                    
                    statsResult = { total: totalErrors, unreviewed, reviewed, source: 'API' };
                    
                } else {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆè¿™é‡Œå¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨ï¼‰
                    addResult('âš ï¸ APIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'warning');
                    errorData = generateMockData();
                    
                    // åŒæ­¥localStorageçŠ¶æ€
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });
                    
                    const totalErrors = errorData.length;
                    const unreviewed = errorData.filter(error => !error.is_reviewed).length;
                    const reviewed = errorData.filter(error => error.is_reviewed).length;
                    
                    statsResult = { total: totalErrors, unreviewed, reviewed, source: 'Mock' };
                }

                // è®°å½•ç»Ÿè®¡ç»“æœ
                statsHistory.push({
                    loadTime: new Date().toLocaleTimeString(),
                    ...statsResult
                });

                addResult(`
                    <h4>ğŸ“Š ç¬¬${loadCount}æ¬¡åŠ è½½ç»“æœ</h4>
                    <p><strong>æ•°æ®æº:</strong> ${statsResult.source}</p>
                    <p><strong>æ€»é”™é¢˜:</strong> ${statsResult.total}</p>
                    <p><strong>æœªå¤ä¹ :</strong> ${statsResult.unreviewed}</p>
                    <p><strong>å·²å¤ä¹ :</strong> ${statsResult.reviewed}</p>
                `, 'info');

                updateMonitor();
                updateStatsHistory();

            } catch (error) {
                addResult(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function generateMockData() {
            // è¿™ä¸ªå‡½æ•°æ¨¡æ‹Ÿé”™é¢˜æœ¬é¡µé¢çš„showMockDataå‡½æ•°
            // æ£€æŸ¥æ˜¯å¦æœ‰éšæœºå…ƒç´ å¯¼è‡´æ•°æ®ä¸ç¨³å®š
            return [
                {
                    id: 1, subject: 'æ•°å­¦', question_text: 'è®¡ç®—ï¼š125 Ã— 8 = ?',
                    user_answer: '900', correct_answer: '1000', error_type: 'è®¡ç®—é”™è¯¯',
                    knowledge_points: ['ä¹˜æ³•è¿ç®—'], is_reviewed: false, // å›ºå®šä¸ºfalse
                    created_at: '2025-08-20T10:30:00Z'
                },
                {
                    id: 2, subject: 'è¯­æ–‡', question_text: 'ä¸‹åˆ—è¯è¯­ä¸­ï¼Œæ²¡æœ‰é”™åˆ«å­—çš„ä¸€ç»„æ˜¯ï¼ˆï¼‰',
                    user_answer: 'A', correct_answer: 'B', error_type: 'è¯†å­—é”™è¯¯',
                    knowledge_points: ['é”™åˆ«å­—è¾¨æ'], is_reviewed: true, // å›ºå®šä¸ºtrue
                    created_at: '2025-08-19T15:20:00Z'
                },
                {
                    id: 3, subject: 'è‹±è¯­', question_text: 'Choose the correct answer: I ____ to school every day.',
                    user_answer: 'goes', correct_answer: 'go', error_type: 'è¯­æ³•é”™è¯¯',
                    knowledge_points: ['ä¸€èˆ¬ç°åœ¨æ—¶'], is_reviewed: false, // å›ºå®šä¸ºfalse
                    created_at: '2025-08-19T09:15:00Z'
                }
                // æ·»åŠ æ›´å¤šæµ‹è¯•æ•°æ®...
            ];
        }

        function updateStatsHistory() {
            const historyContainer = document.getElementById('statsHistory');
            if (statsHistory.length === 0) {
                historyContainer.innerHTML = '<p>æš‚æ— æ•°æ®</p>';
                return;
            }

            const historyHTML = statsHistory.map((stats, index) => `
                <div class="stats-card">
                    <div class="stats-number">ç¬¬${index + 1}æ¬¡</div>
                    <div class="stats-label">${stats.loadTime}</div>
                    <div style="margin-top: 8px;">
                        <div>æ€»: ${stats.total} | æœª: ${stats.unreviewed} | å·²: ${stats.reviewed}</div>
                        <div style="font-size: 10px; color: #666;">${stats.source}</div>
                    </div>
                </div>
            `).join('');

            historyContainer.innerHTML = `<div class="comparison">${historyHTML}</div>`;

            // åˆ†ææ˜¯å¦æœ‰å˜åŒ–
            if (statsHistory.length >= 2) {
                const variations = getVariationCount();
                if (variations > 0) {
                    addResult(`âš ï¸ æ£€æµ‹åˆ°ç»Ÿè®¡æ•°å­—å˜åŒ– ${variations} æ¬¡ï¼`, 'warning');
                } else {
                    addResult(`âœ… ç»Ÿè®¡æ•°å­—ä¿æŒç¨³å®š`, 'success');
                }
            }
        }

        async function testMultipleLoads() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸš€ å¼€å§‹å¤šæ¬¡åŠ è½½æµ‹è¯•ï¼ˆ5æ¬¡ï¼‰...', 'info');

            for (let i = 0; i < 5; i++) {
                await loadErrorBookData();
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
            }

            addResult(`
                <h4>ğŸ“ˆ æµ‹è¯•å®Œæˆæ€»ç»“</h4>
                <p><strong>æ€»åŠ è½½æ¬¡æ•°:</strong> ${loadCount}</p>
                <p><strong>ç»Ÿè®¡å˜åŒ–æ¬¡æ•°:</strong> ${getVariationCount()}</p>
                <p><strong>ç»“è®º:</strong> ${getVariationCount() > 0 ? 'æ•°å­—å­˜åœ¨æ³¢åŠ¨ï¼Œéœ€è¦ä¿®å¤' : 'æ•°å­—ç¨³å®šï¼Œæ— é—®é¢˜'}</p>
            `, getVariationCount() > 0 ? 'warning' : 'success');
        }

        async function compareDataSources() {
            addResult('ğŸ“Š å¯¹æ¯”ä¸åŒæ•°æ®æºçš„ç»Ÿè®¡ç»“æœ...', 'info');

            try {
                // 1. å°è¯•è·å–APIæ•°æ®
                let apiStats = null;
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const errors = data.recent_errors || [];
                        apiStats = {
                            total: errors.length,
                            unreviewed: errors.filter(e => !e.is_reviewed).length,
                            reviewed: errors.filter(e => e.is_reviewed).length
                        };
                    }
                } catch (e) {
                    addResult('âš ï¸ APIæ•°æ®è·å–å¤±è´¥', 'warning');
                }

                // 2. ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ç»Ÿè®¡
                const mockErrors = generateMockData();
                const mockStats = {
                    total: mockErrors.length,
                    unreviewed: mockErrors.filter(e => !e.is_reviewed).length,
                    reviewed: mockErrors.filter(e => e.is_reviewed).length
                };

                // 3. å¯¹æ¯”ç»“æœ
                addResult(`
                    <h4>ğŸ“Š æ•°æ®æºå¯¹æ¯”</h4>
                    <div class="comparison">
                        ${apiStats ? `
                        <div class="stats-card">
                            <div class="stats-number">APIæ•°æ®</div>
                            <div>æ€»: ${apiStats.total}</div>
                            <div>æœª: ${apiStats.unreviewed}</div>
                            <div>å·²: ${apiStats.reviewed}</div>
                        </div>
                        ` : ''}
                        <div class="stats-card">
                            <div class="stats-number">æ¨¡æ‹Ÿæ•°æ®</div>
                            <div>æ€»: ${mockStats.total}</div>
                            <div>æœª: ${mockStats.unreviewed}</div>
                            <div>å·²: ${mockStats.reviewed}</div>
                        </div>
                    </div>
                `, 'info');

            } catch (error) {
                addResult(`âŒ å¯¹æ¯”å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        localStorage.setItem('token', TOKEN);
        updateMonitor();

        // è‡ªåŠ¨è¿›è¡Œä¸€æ¬¡åŠ è½½æµ‹è¯•
        setTimeout(() => {
            loadErrorBookData();
        }, 1000);
    </script>
</body>
</html>