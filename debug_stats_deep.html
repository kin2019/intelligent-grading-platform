<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>深度调试统计数字波动</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .data-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .data-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .highlight-change { background-color: #fff3cd; border: 1px solid #ffc107; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>🔬 深度调试统计数字波动问题</h1>
    
    <div class="test-section info">
        <h3>🎯 调试策略</h3>
        <p>逐步跟踪整个数据处理流程，找出导致统计数字变化的确切原因</p>
        <ul>
            <li>1. 直接调用API获取原始数据</li>
            <li>2. 模拟syncLocalReviewStatus()的每一步</li>
            <li>3. 模拟calculateRealStats()的计算过程</li>
            <li>4. 对比多次计算的结果差异</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>🛠️ 调试操作</h3>
        <button class="btn-primary" onclick="stepByStepDebug()">🔍 逐步调试</button>
        <button class="btn-success" onclick="compareMultipleRuns()">📊 多次运行对比</button>
        <button class="btn-danger" onclick="clearStorage()">🧹 清除localStorage</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            addResult('✅ localStorage已清除', 'success');
        }

        // 获取模拟数据（完全按照错题本页面的逻辑）
        function getMockData() {
            return [
                {
                    id: 1, subject: '数学', question_text: '计算：125 × 8 = ?',
                    user_answer: '900', correct_answer: '1000', error_type: '计算错误',
                    knowledge_points: ['乘法运算'], is_reviewed: false,
                    created_at: '2025-08-20T10:30:00Z'
                },
                {
                    id: 2, subject: '语文', question_text: '下列词语中，没有错别字的一组是（）',
                    user_answer: 'A', correct_answer: 'B', error_type: '识字错误',
                    knowledge_points: ['错别字辨析'], is_reviewed: true,
                    created_at: '2025-08-19T15:20:00Z'
                },
                {
                    id: 3, subject: '英语', question_text: 'Choose the correct answer: I ____ to school every day.',
                    user_answer: 'goes', correct_answer: 'go', error_type: '语法错误',
                    knowledge_points: ['一般现在时'], is_reviewed: false,
                    created_at: '2025-08-19T09:15:00Z'
                },
                {
                    id: 4, subject: '数学', question_text: '一个圆的半径是5cm，求这个圆的面积。',
                    user_answer: '78.5 cm²', correct_answer: '78.54 cm²', error_type: '计算精度',
                    knowledge_points: ['圆的面积公式'], is_reviewed: true,
                    created_at: '2025-08-18T14:45:00Z'
                },
                {
                    id: 5, subject: '数学', question_text: '解方程：2x + 5 = 13',
                    user_answer: 'x = 3', correct_answer: 'x = 4', error_type: '运算错误',
                    knowledge_points: ['一元一次方程'], is_reviewed: false,
                    created_at: '2025-08-18T11:30:00Z'
                }
            ];
        }

        async function stepByStepDebug() {
            document.getElementById('results').innerHTML = '';
            addResult('🔍 开始逐步调试...', 'info');

            try {
                // 步骤1: 获取原始数据
                addResult('📡 步骤1: 获取原始数据', 'info');
                
                let originalData = [];
                let dataSource = '';
                
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });
                    
                    if (response.ok) {
                        const apiData = await response.json();
                        originalData = apiData.recent_errors || [];
                        dataSource = 'API';
                    } else {
                        throw new Error('API失败');
                    }
                } catch (error) {
                    originalData = getMockData();
                    dataSource = '模拟';
                }

                addResult(`
                    <h4>📊 原始数据 (来源: ${dataSource})</h4>
                    <p><strong>总数:</strong> ${originalData.length}</p>
                    <p><strong>原始复习状态:</strong></p>
                    <ul>
                        ${originalData.map(error => `
                            <li>ID=${error.id} (${error.subject}): ${error.is_reviewed ? '已复习' : '未复习'}</li>
                        `).join('')}
                    </ul>
                `, 'info');

                // 步骤2: 检查localStorage状态
                addResult('💾 步骤2: 检查localStorage状态', 'info');
                
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                
                addResult(`
                    <h4>💾 localStorage状态</h4>
                    <p><strong>已复习错题ID:</strong> [${reviewedErrors.join(', ')}]</p>
                    <p><strong>数量:</strong> ${reviewedErrors.length}</p>
                `, 'info');

                // 步骤3: 模拟syncLocalReviewStatus
                addResult('🔄 步骤3: 同步localStorage状态', 'info');
                
                const syncedData = JSON.parse(JSON.stringify(originalData)); // 深拷贝
                let changedCount = 0;
                const changes = [];
                
                syncedData.forEach(error => {
                    const beforeStatus = error.is_reviewed;
                    if (reviewedErrors.includes(String(error.id))) {
                        if (!beforeStatus) {
                            error.is_reviewed = true;
                            changedCount++;
                            changes.push(`ID=${error.id}: 未复习 → 已复习`);
                        }
                    }
                });

                addResult(`
                    <h4>🔄 同步结果</h4>
                    <p><strong>状态更新数量:</strong> ${changedCount}</p>
                    ${changes.length > 0 ? `
                    <p><strong>具体变化:</strong></p>
                    <ul>
                        ${changes.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                    ` : '<p><strong>无状态变化</strong></p>'}
                `, 'info');

                // 步骤4: 计算最终统计
                addResult('📊 步骤4: 计算最终统计', 'info');
                
                const finalStats = {
                    total: syncedData.length,
                    unreviewed: syncedData.filter(error => !error.is_reviewed).length,
                    reviewed: syncedData.filter(error => error.is_reviewed).length
                };

                addResult(`
                    <h4>📊 最终统计结果</h4>
                    <div class="data-comparison">
                        <div class="data-card">
                            <h5>原始统计</h5>
                            <p>总错题: ${originalData.length}</p>
                            <p>未复习: ${originalData.filter(e => !e.is_reviewed).length}</p>
                            <p>已复习: ${originalData.filter(e => e.is_reviewed).length}</p>
                        </div>
                        <div class="data-card">
                            <h5>同步后统计</h5>
                            <p>总错题: ${finalStats.total}</p>
                            <p>未复习: ${finalStats.unreviewed}</p>
                            <p>已复习: ${finalStats.reviewed}</p>
                        </div>
                    </div>
                `, 'success');

                // 步骤5: 详细数据展示
                addResult(`
                    <h4>🔍 详细数据对比</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <h5>原始数据:</h5>
                        <pre>${JSON.stringify(originalData, null, 2)}</pre>
                        <h5>同步后数据:</h5>
                        <pre>${JSON.stringify(syncedData, null, 2)}</pre>
                    </div>
                `, 'info');

            } catch (error) {
                addResult(`❌ 调试过程出错: ${error.message}`, 'error');
            }
        }

        async function compareMultipleRuns() {
            addResult('📊 开始多次运行对比...', 'info');

            const results = [];
            
            for (let i = 1; i <= 5; i++) {
                addResult(`🔄 第${i}次运行...`, 'info');
                
                try {
                    // 获取数据
                    let errorData = [];
                    try {
                        const response = await fetch(`${API_BASE}/student/error-book`, {
                            headers: { 'Authorization': `Bearer ${TOKEN}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            errorData = data.recent_errors || [];
                        } else {
                            errorData = getMockData();
                        }
                    } catch {
                        errorData = getMockData();
                    }

                    // 同步状态
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });

                    // 计算统计
                    const stats = {
                        total: errorData.length,
                        unreviewed: errorData.filter(error => !error.is_reviewed).length,
                        reviewed: errorData.filter(error => error.is_reviewed).length
                    };

                    results.push({
                        run: i,
                        time: new Date().toLocaleTimeString(),
                        stats,
                        reviewedErrorsState: [...reviewedErrors]
                    });

                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (error) {
                    addResult(`❌ 第${i}次运行失败: ${error.message}`, 'error');
                }
            }

            // 分析结果
            const firstResult = results[0];
            const allSame = results.every(result => 
                result.stats.total === firstResult.stats.total &&
                result.stats.unreviewed === firstResult.stats.unreviewed &&
                result.stats.reviewed === firstResult.stats.reviewed
            );

            addResult(`
                <h4>📈 多次运行对比结果</h4>
                <p><strong>运行次数:</strong> 5次</p>
                <p><strong>结果一致性:</strong> ${allSame ? '✅ 完全一致' : '❌ 存在差异'}</p>
                
                <h5>详细结果:</h5>
                <table border="1" style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <th>运行</th>
                        <th>时间</th>
                        <th>总错题</th>
                        <th>未复习</th>
                        <th>已复习</th>
                        <th>localStorage状态</th>
                    </tr>
                    ${results.map(result => `
                        <tr>
                            <td>第${result.run}次</td>
                            <td>${result.time}</td>
                            <td>${result.stats.total}</td>
                            <td>${result.stats.unreviewed}</td>
                            <td>${result.stats.reviewed}</td>
                            <td>[${result.reviewedErrorsState.join(', ')}]</td>
                        </tr>
                    `).join('')}
                </table>
            `, allSame ? 'success' : 'error');

            if (!allSame) {
                // 找出差异
                const differences = [];
                for (let i = 1; i < results.length; i++) {
                    const current = results[i];
                    const previous = results[i - 1];
                    
                    if (current.stats.total !== previous.stats.total ||
                        current.stats.unreviewed !== previous.stats.unreviewed ||
                        current.stats.reviewed !== previous.stats.reviewed) {
                        
                        differences.push(`第${i}次与第${i+1}次之间存在差异`);
                    }
                }

                addResult(`
                    <h4>❌ 发现的差异</h4>
                    <ul>
                        ${differences.map(diff => `<li>${diff}</li>`).join('')}
                    </ul>
                    <p><strong>可能原因:</strong></p>
                    <ul>
                        <li>数据源本身存在随机性</li>
                        <li>异步操作时序问题</li>
                        <li>localStorage状态在运行间发生变化</li>
                        <li>API返回数据不一致</li>
                    </ul>
                `, 'error');
            }
        }

        // 页面初始化
        localStorage.setItem('token', TOKEN);
        
        addResult(`
            <h4>🎯 调试目标</h4>
            <p>找出为什么错题本页面的统计数字每次刷新都会变化</p>
            <p><strong>当前localStorage状态:</strong> [${JSON.parse(localStorage.getItem('reviewedErrors') || '[]').join(', ')}]</p>
        `, 'info');
    </script>
</body>
</html>