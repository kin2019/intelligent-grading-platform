<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ·±åº¦è°ƒè¯•ç»Ÿè®¡æ•°å­—æ³¢åŠ¨</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .data-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .data-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .highlight-change { background-color: #fff3cd; border: 1px solid #ffc107; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ æ·±åº¦è°ƒè¯•ç»Ÿè®¡æ•°å­—æ³¢åŠ¨é—®é¢˜</h1>
    
    <div class="test-section info">
        <h3>ğŸ¯ è°ƒè¯•ç­–ç•¥</h3>
        <p>é€æ­¥è·Ÿè¸ªæ•´ä¸ªæ•°æ®å¤„ç†æµç¨‹ï¼Œæ‰¾å‡ºå¯¼è‡´ç»Ÿè®¡æ•°å­—å˜åŒ–çš„ç¡®åˆ‡åŸå› </p>
        <ul>
            <li>1. ç›´æ¥è°ƒç”¨APIè·å–åŸå§‹æ•°æ®</li>
            <li>2. æ¨¡æ‹ŸsyncLocalReviewStatus()çš„æ¯ä¸€æ­¥</li>
            <li>3. æ¨¡æ‹ŸcalculateRealStats()çš„è®¡ç®—è¿‡ç¨‹</li>
            <li>4. å¯¹æ¯”å¤šæ¬¡è®¡ç®—çš„ç»“æœå·®å¼‚</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>ğŸ› ï¸ è°ƒè¯•æ“ä½œ</h3>
        <button class="btn-primary" onclick="stepByStepDebug()">ğŸ” é€æ­¥è°ƒè¯•</button>
        <button class="btn-success" onclick="compareMultipleRuns()">ğŸ“Š å¤šæ¬¡è¿è¡Œå¯¹æ¯”</button>
        <button class="btn-danger" onclick="clearStorage()">ğŸ§¹ æ¸…é™¤localStorage</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            addResult('âœ… localStorageå·²æ¸…é™¤', 'success');
        }

        // è·å–æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®Œå…¨æŒ‰ç…§é”™é¢˜æœ¬é¡µé¢çš„é€»è¾‘ï¼‰
        function getMockData() {
            return [
                {
                    id: 1, subject: 'æ•°å­¦', question_text: 'è®¡ç®—ï¼š125 Ã— 8 = ?',
                    user_answer: '900', correct_answer: '1000', error_type: 'è®¡ç®—é”™è¯¯',
                    knowledge_points: ['ä¹˜æ³•è¿ç®—'], is_reviewed: false,
                    created_at: '2025-08-20T10:30:00Z'
                },
                {
                    id: 2, subject: 'è¯­æ–‡', question_text: 'ä¸‹åˆ—è¯è¯­ä¸­ï¼Œæ²¡æœ‰é”™åˆ«å­—çš„ä¸€ç»„æ˜¯ï¼ˆï¼‰',
                    user_answer: 'A', correct_answer: 'B', error_type: 'è¯†å­—é”™è¯¯',
                    knowledge_points: ['é”™åˆ«å­—è¾¨æ'], is_reviewed: true,
                    created_at: '2025-08-19T15:20:00Z'
                },
                {
                    id: 3, subject: 'è‹±è¯­', question_text: 'Choose the correct answer: I ____ to school every day.',
                    user_answer: 'goes', correct_answer: 'go', error_type: 'è¯­æ³•é”™è¯¯',
                    knowledge_points: ['ä¸€èˆ¬ç°åœ¨æ—¶'], is_reviewed: false,
                    created_at: '2025-08-19T09:15:00Z'
                },
                {
                    id: 4, subject: 'æ•°å­¦', question_text: 'ä¸€ä¸ªåœ†çš„åŠå¾„æ˜¯5cmï¼Œæ±‚è¿™ä¸ªåœ†çš„é¢ç§¯ã€‚',
                    user_answer: '78.5 cmÂ²', correct_answer: '78.54 cmÂ²', error_type: 'è®¡ç®—ç²¾åº¦',
                    knowledge_points: ['åœ†çš„é¢ç§¯å…¬å¼'], is_reviewed: true,
                    created_at: '2025-08-18T14:45:00Z'
                },
                {
                    id: 5, subject: 'æ•°å­¦', question_text: 'è§£æ–¹ç¨‹ï¼š2x + 5 = 13',
                    user_answer: 'x = 3', correct_answer: 'x = 4', error_type: 'è¿ç®—é”™è¯¯',
                    knowledge_points: ['ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹'], is_reviewed: false,
                    created_at: '2025-08-18T11:30:00Z'
                }
            ];
        }

        async function stepByStepDebug() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸ” å¼€å§‹é€æ­¥è°ƒè¯•...', 'info');

            try {
                // æ­¥éª¤1: è·å–åŸå§‹æ•°æ®
                addResult('ğŸ“¡ æ­¥éª¤1: è·å–åŸå§‹æ•°æ®', 'info');
                
                let originalData = [];
                let dataSource = '';
                
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });
                    
                    if (response.ok) {
                        const apiData = await response.json();
                        originalData = apiData.recent_errors || [];
                        dataSource = 'API';
                    } else {
                        throw new Error('APIå¤±è´¥');
                    }
                } catch (error) {
                    originalData = getMockData();
                    dataSource = 'æ¨¡æ‹Ÿ';
                }

                addResult(`
                    <h4>ğŸ“Š åŸå§‹æ•°æ® (æ¥æº: ${dataSource})</h4>
                    <p><strong>æ€»æ•°:</strong> ${originalData.length}</p>
                    <p><strong>åŸå§‹å¤ä¹ çŠ¶æ€:</strong></p>
                    <ul>
                        ${originalData.map(error => `
                            <li>ID=${error.id} (${error.subject}): ${error.is_reviewed ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</li>
                        `).join('')}
                    </ul>
                `, 'info');

                // æ­¥éª¤2: æ£€æŸ¥localStorageçŠ¶æ€
                addResult('ğŸ’¾ æ­¥éª¤2: æ£€æŸ¥localStorageçŠ¶æ€', 'info');
                
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                
                addResult(`
                    <h4>ğŸ’¾ localStorageçŠ¶æ€</h4>
                    <p><strong>å·²å¤ä¹ é”™é¢˜ID:</strong> [${reviewedErrors.join(', ')}]</p>
                    <p><strong>æ•°é‡:</strong> ${reviewedErrors.length}</p>
                `, 'info');

                // æ­¥éª¤3: æ¨¡æ‹ŸsyncLocalReviewStatus
                addResult('ğŸ”„ æ­¥éª¤3: åŒæ­¥localStorageçŠ¶æ€', 'info');
                
                const syncedData = JSON.parse(JSON.stringify(originalData)); // æ·±æ‹·è´
                let changedCount = 0;
                const changes = [];
                
                syncedData.forEach(error => {
                    const beforeStatus = error.is_reviewed;
                    if (reviewedErrors.includes(String(error.id))) {
                        if (!beforeStatus) {
                            error.is_reviewed = true;
                            changedCount++;
                            changes.push(`ID=${error.id}: æœªå¤ä¹  â†’ å·²å¤ä¹ `);
                        }
                    }
                });

                addResult(`
                    <h4>ğŸ”„ åŒæ­¥ç»“æœ</h4>
                    <p><strong>çŠ¶æ€æ›´æ–°æ•°é‡:</strong> ${changedCount}</p>
                    ${changes.length > 0 ? `
                    <p><strong>å…·ä½“å˜åŒ–:</strong></p>
                    <ul>
                        ${changes.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                    ` : '<p><strong>æ— çŠ¶æ€å˜åŒ–</strong></p>'}
                `, 'info');

                // æ­¥éª¤4: è®¡ç®—æœ€ç»ˆç»Ÿè®¡
                addResult('ğŸ“Š æ­¥éª¤4: è®¡ç®—æœ€ç»ˆç»Ÿè®¡', 'info');
                
                const finalStats = {
                    total: syncedData.length,
                    unreviewed: syncedData.filter(error => !error.is_reviewed).length,
                    reviewed: syncedData.filter(error => error.is_reviewed).length
                };

                addResult(`
                    <h4>ğŸ“Š æœ€ç»ˆç»Ÿè®¡ç»“æœ</h4>
                    <div class="data-comparison">
                        <div class="data-card">
                            <h5>åŸå§‹ç»Ÿè®¡</h5>
                            <p>æ€»é”™é¢˜: ${originalData.length}</p>
                            <p>æœªå¤ä¹ : ${originalData.filter(e => !e.is_reviewed).length}</p>
                            <p>å·²å¤ä¹ : ${originalData.filter(e => e.is_reviewed).length}</p>
                        </div>
                        <div class="data-card">
                            <h5>åŒæ­¥åç»Ÿè®¡</h5>
                            <p>æ€»é”™é¢˜: ${finalStats.total}</p>
                            <p>æœªå¤ä¹ : ${finalStats.unreviewed}</p>
                            <p>å·²å¤ä¹ : ${finalStats.reviewed}</p>
                        </div>
                    </div>
                `, 'success');

                // æ­¥éª¤5: è¯¦ç»†æ•°æ®å±•ç¤º
                addResult(`
                    <h4>ğŸ” è¯¦ç»†æ•°æ®å¯¹æ¯”</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <h5>åŸå§‹æ•°æ®:</h5>
                        <pre>${JSON.stringify(originalData, null, 2)}</pre>
                        <h5>åŒæ­¥åæ•°æ®:</h5>
                        <pre>${JSON.stringify(syncedData, null, 2)}</pre>
                    </div>
                `, 'info');

            } catch (error) {
                addResult(`âŒ è°ƒè¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        async function compareMultipleRuns() {
            addResult('ğŸ“Š å¼€å§‹å¤šæ¬¡è¿è¡Œå¯¹æ¯”...', 'info');

            const results = [];
            
            for (let i = 1; i <= 5; i++) {
                addResult(`ğŸ”„ ç¬¬${i}æ¬¡è¿è¡Œ...`, 'info');
                
                try {
                    // è·å–æ•°æ®
                    let errorData = [];
                    try {
                        const response = await fetch(`${API_BASE}/student/error-book`, {
                            headers: { 'Authorization': `Bearer ${TOKEN}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            errorData = data.recent_errors || [];
                        } else {
                            errorData = getMockData();
                        }
                    } catch {
                        errorData = getMockData();
                    }

                    // åŒæ­¥çŠ¶æ€
                    const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                    errorData.forEach(error => {
                        if (reviewedErrors.includes(String(error.id))) {
                            error.is_reviewed = true;
                        }
                    });

                    // è®¡ç®—ç»Ÿè®¡
                    const stats = {
                        total: errorData.length,
                        unreviewed: errorData.filter(error => !error.is_reviewed).length,
                        reviewed: errorData.filter(error => error.is_reviewed).length
                    };

                    results.push({
                        run: i,
                        time: new Date().toLocaleTimeString(),
                        stats,
                        reviewedErrorsState: [...reviewedErrors]
                    });

                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (error) {
                    addResult(`âŒ ç¬¬${i}æ¬¡è¿è¡Œå¤±è´¥: ${error.message}`, 'error');
                }
            }

            // åˆ†æç»“æœ
            const firstResult = results[0];
            const allSame = results.every(result => 
                result.stats.total === firstResult.stats.total &&
                result.stats.unreviewed === firstResult.stats.unreviewed &&
                result.stats.reviewed === firstResult.stats.reviewed
            );

            addResult(`
                <h4>ğŸ“ˆ å¤šæ¬¡è¿è¡Œå¯¹æ¯”ç»“æœ</h4>
                <p><strong>è¿è¡Œæ¬¡æ•°:</strong> 5æ¬¡</p>
                <p><strong>ç»“æœä¸€è‡´æ€§:</strong> ${allSame ? 'âœ… å®Œå…¨ä¸€è‡´' : 'âŒ å­˜åœ¨å·®å¼‚'}</p>
                
                <h5>è¯¦ç»†ç»“æœ:</h5>
                <table border="1" style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <th>è¿è¡Œ</th>
                        <th>æ—¶é—´</th>
                        <th>æ€»é”™é¢˜</th>
                        <th>æœªå¤ä¹ </th>
                        <th>å·²å¤ä¹ </th>
                        <th>localStorageçŠ¶æ€</th>
                    </tr>
                    ${results.map(result => `
                        <tr>
                            <td>ç¬¬${result.run}æ¬¡</td>
                            <td>${result.time}</td>
                            <td>${result.stats.total}</td>
                            <td>${result.stats.unreviewed}</td>
                            <td>${result.stats.reviewed}</td>
                            <td>[${result.reviewedErrorsState.join(', ')}]</td>
                        </tr>
                    `).join('')}
                </table>
            `, allSame ? 'success' : 'error');

            if (!allSame) {
                // æ‰¾å‡ºå·®å¼‚
                const differences = [];
                for (let i = 1; i < results.length; i++) {
                    const current = results[i];
                    const previous = results[i - 1];
                    
                    if (current.stats.total !== previous.stats.total ||
                        current.stats.unreviewed !== previous.stats.unreviewed ||
                        current.stats.reviewed !== previous.stats.reviewed) {
                        
                        differences.push(`ç¬¬${i}æ¬¡ä¸ç¬¬${i+1}æ¬¡ä¹‹é—´å­˜åœ¨å·®å¼‚`);
                    }
                }

                addResult(`
                    <h4>âŒ å‘ç°çš„å·®å¼‚</h4>
                    <ul>
                        ${differences.map(diff => `<li>${diff}</li>`).join('')}
                    </ul>
                    <p><strong>å¯èƒ½åŸå› :</strong></p>
                    <ul>
                        <li>æ•°æ®æºæœ¬èº«å­˜åœ¨éšæœºæ€§</li>
                        <li>å¼‚æ­¥æ“ä½œæ—¶åºé—®é¢˜</li>
                        <li>localStorageçŠ¶æ€åœ¨è¿è¡Œé—´å‘ç”Ÿå˜åŒ–</li>
                        <li>APIè¿”å›æ•°æ®ä¸ä¸€è‡´</li>
                    </ul>
                `, 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        localStorage.setItem('token', TOKEN);
        
        addResult(`
            <h4>ğŸ¯ è°ƒè¯•ç›®æ ‡</h4>
            <p>æ‰¾å‡ºä¸ºä»€ä¹ˆé”™é¢˜æœ¬é¡µé¢çš„ç»Ÿè®¡æ•°å­—æ¯æ¬¡åˆ·æ–°éƒ½ä¼šå˜åŒ–</p>
            <p><strong>å½“å‰localStorageçŠ¶æ€:</strong> [${JSON.parse(localStorage.getItem('reviewedErrors') || '[]').join(', ')}]</p>
        `, 'info');
    </script>
</body>
</html>