<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ£€æŸ¥ID=10å¤ä¹ çŠ¶æ€ä¸€è‡´æ€§</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .data-card { padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ” æ£€æŸ¥ID=10å¤ä¹ çŠ¶æ€ä¸€è‡´æ€§</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ æ£€æŸ¥ç›®æ ‡</h3>
        <p>éªŒè¯é”™é¢˜è¯¦æƒ…é¡µé¢(ID=10)å’Œé”™é¢˜æœ¬é¡µé¢ä¸­å¯¹åº”è®°å½•çš„å¤ä¹ çŠ¶æ€æ˜¯å¦ä¸€è‡´</p>
        <p>æ£€æŸ¥é”™é¢˜æœ¬æ˜¾ç¤ºçš„å¤ä¹ çŠ¶æ€æ˜¯å¦å‡†ç¡®</p>
    </div>

    <div class="test-section">
        <h3>ğŸ› ï¸ æµ‹è¯•æ“ä½œ</h3>
        <button class="btn-primary" onclick="checkID10Status()">ğŸ” æ£€æŸ¥ID=10çŠ¶æ€</button>
        <button class="btn-success" onclick="markID10Reviewed()">âœ… æ ‡è®°ID=10ä¸ºå·²å¤ä¹ </button>
        <button class="btn-danger" onclick="clearStorage()">ğŸ§¹ æ¸…é™¤localStorage</button>
    </div>

    <div class="test-section">
        <h3>ğŸ”— ç›¸å…³é¡µé¢</h3>
        <p><a href="http://localhost:8080/frontend/error-book.html" target="_blank">ğŸ“– é”™é¢˜æœ¬é¡µé¢</a></p>
        <p><a href="http://localhost:8080/frontend/error-detail.html?id=10" target="_blank">ğŸ“„ é”™é¢˜è¯¦æƒ…é¡µé¢ (ID=10)</a></p>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            addResult('âœ… localStorageå·²æ¸…é™¤', 'success');
        }

        function markID10Reviewed() {
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            const errorIdStr = '10';
            
            if (!reviewedErrors.includes(errorIdStr)) {
                reviewedErrors.push(errorIdStr);
                localStorage.setItem('reviewedErrors', JSON.stringify(reviewedErrors));
                addResult(`âœ… å·²æ ‡è®°ID=10ä¸ºå·²å¤ä¹ `, 'success');
            } else {
                addResult(`â„¹ï¸ ID=10å·²ç»æ˜¯å·²å¤ä¹ çŠ¶æ€`, 'info');
            }
        }

        async function checkID10Status() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸ”„ å¼€å§‹æ£€æŸ¥ID=10çš„å¤ä¹ çŠ¶æ€ä¸€è‡´æ€§...', 'info');

            try {
                // 1. æ£€æŸ¥localStorageçŠ¶æ€
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                const isLocalReviewed = reviewedErrors.includes('10');
                
                addResult(`ğŸ’¾ localStorageçŠ¶æ€: ID=10 ${isLocalReviewed ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, 'info');

                // 2. è·å–é”™é¢˜æœ¬APIæ•°æ®
                const errorBookResponse = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const errorBookData = await errorBookResponse.json();
                
                // æŸ¥æ‰¾ID=10çš„é”™é¢˜
                const error10InBook = errorBookData.recent_errors.find(error => error.id == 10);
                
                if (!error10InBook) {
                    addResult(`âŒ é”™é¢˜æœ¬APIä¸­æœªæ‰¾åˆ°ID=10çš„é”™é¢˜`, 'error');
                    const availableIds = errorBookData.recent_errors.map(e => e.id).slice(0, 10);
                    addResult(`ğŸ“‹ å¯ç”¨çš„é”™é¢˜ID: [${availableIds.join(', ')}]`, 'info');
                    return;
                }

                // 3. æ¨¡æ‹Ÿé”™é¢˜æœ¬é¡µé¢çš„é€»è¾‘
                const apiStatus = error10InBook.is_reviewed;
                let errorBookFinalStatus = apiStatus;
                
                // åº”ç”¨localStorageè¦†ç›–é€»è¾‘
                if (reviewedErrors.includes(String(error10InBook.id))) {
                    errorBookFinalStatus = true;
                }

                // 4. æ¨¡æ‹Ÿé”™é¢˜è¯¦æƒ…é¡µé¢çš„é€»è¾‘
                let errorDetailFinalStatus = apiStatus;
                if (reviewedErrors.includes(String(error10InBook.id))) {
                    errorDetailFinalStatus = true;
                }

                // 5. æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                addResult(`
                    <h4>ğŸ“Š ID=10çŠ¶æ€å¯¹æ¯”åˆ†æ</h4>
                    <div class="comparison">
                        <div class="data-card">
                            <h5>ğŸ“– é”™é¢˜æœ¬é¡µé¢</h5>
                            <p><strong>APIåŸå§‹çŠ¶æ€:</strong> ${apiStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                            <p><strong>localStorageçŠ¶æ€:</strong> ${isLocalReviewed ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                            <p><strong>æœ€ç»ˆæ˜¾ç¤ºçŠ¶æ€:</strong> <span style="color: blue; font-weight: bold;">${errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</span></p>
                            <p><strong>æŒ‰é’®æ˜¾ç¤º:</strong> ${errorBookFinalStatus ? 'ä¸æ˜¾ç¤º"æ ‡è®°å·²å¤ä¹ "' : 'æ˜¾ç¤º"æ ‡è®°å·²å¤ä¹ "'}</p>
                        </div>
                        <div class="data-card">
                            <h5>ğŸ“„ é”™é¢˜è¯¦æƒ…é¡µé¢</h5>
                            <p><strong>APIåŸå§‹çŠ¶æ€:</strong> ${apiStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                            <p><strong>localStorageçŠ¶æ€:</strong> ${isLocalReviewed ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                            <p><strong>æœ€ç»ˆæ˜¾ç¤ºçŠ¶æ€:</strong> <span style="color: green; font-weight: bold;">${errorDetailFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</span></p>
                            <p><strong>æŒ‰é’®çŠ¶æ€:</strong> ${errorDetailFinalStatus ? 'æ˜¾ç¤º"å·²å¤ä¹ "ï¼ŒæŒ‰é’®ç¦ç”¨' : 'æ˜¾ç¤º"æ ‡è®°å·²å¤ä¹ "'}</p>
                        </div>
                    </div>
                `, 'info');

                // 6. ä¸€è‡´æ€§æ£€æŸ¥
                const isConsistent = errorBookFinalStatus === errorDetailFinalStatus;
                
                if (isConsistent) {
                    addResult(`
                        <h4>âœ… çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡</h4>
                        <p>ä¸¤ä¸ªé¡µé¢éƒ½æ˜¾ç¤ºï¼š<strong>${errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</strong></p>
                        <p>çŠ¶æ€æ˜¾ç¤ºå‡†ç¡®æ— è¯¯</p>
                    `, 'success');
                } else {
                    addResult(`
                        <h4>âŒ çŠ¶æ€ä¸ä¸€è‡´ï¼</h4>
                        <p>é”™é¢˜æœ¬æ˜¾ç¤ºï¼š${errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                        <p>é”™é¢˜è¯¦æƒ…æ˜¾ç¤ºï¼š${errorDetailFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}</p>
                        <p>å­˜åœ¨é€»è¾‘é”™è¯¯ï¼Œéœ€è¦ä¿®å¤</p>
                    `, 'error');
                }

                // 7. æ˜¾ç¤ºè¯¦ç»†æ•°æ®
                addResult(`
                    <h4>ğŸ“‹ è¯¦ç»†æ•°æ®ä¿¡æ¯</h4>
                    <pre>${JSON.stringify({
                        id: error10InBook.id,
                        subject: error10InBook.subject,
                        question_preview: error10InBook.question_text.substring(0, 60) + '...',
                        api_is_reviewed: error10InBook.is_reviewed,
                        localStorage_reviewed: isLocalReviewed,
                        error_book_final: errorBookFinalStatus,
                        error_detail_final: errorDetailFinalStatus,
                        is_consistent: isConsistent
                    }, null, 2)}</pre>
                `, 'info');

                // 8. å‡†ç¡®æ€§éªŒè¯
                addResult(`
                    <h4>ğŸ¯ å‡†ç¡®æ€§éªŒè¯</h4>
                    <p><strong>é”™é¢˜æœ¬æ˜¾ç¤ºå‡†ç¡®æ€§:</strong> ${errorBookFinalStatus === (isLocalReviewed || apiStatus) ? 'âœ… å‡†ç¡®' : 'âŒ ä¸å‡†ç¡®'}</p>
                    <p><strong>é€»è¾‘è¯´æ˜:</strong> æœ€ç»ˆçŠ¶æ€ = localStorageçŠ¶æ€ OR APIçŠ¶æ€</p>
                    <p><strong>é¢„æœŸè¡Œä¸º:</strong> å¦‚æœlocalStorageä¸­æœ‰è®°å½•æˆ–APIæ˜¾ç¤ºå·²å¤ä¹ ï¼Œåˆ™æ˜¾ç¤ºä¸ºå·²å¤ä¹ </p>
                `, errorBookFinalStatus === (isLocalReviewed || apiStatus) ? 'success' : 'error');

                // 9. æµ‹è¯•å»ºè®®
                if (!isConsistent) {
                    addResult(`
                        <h4>ğŸ”§ ä¿®å¤å»ºè®®</h4>
                        <p>1. æ£€æŸ¥é”™é¢˜è¯¦æƒ…é¡µé¢çš„syncLocalReviewStatuså‡½æ•°</p>
                        <p>2. ç¡®ä¿ä¸¤ä¸ªé¡µé¢ä½¿ç”¨ç›¸åŒçš„çŠ¶æ€åˆ¤æ–­é€»è¾‘</p>
                        <p>3. éªŒè¯localStorageäº‹ä»¶ç›‘å¬æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
                    `, 'warning');
                } else {
                    addResult(`
                        <h4>ğŸ‰ æµ‹è¯•ç»“è®º</h4>
                        <p>âœ… ID=10çš„å¤ä¹ çŠ¶æ€åœ¨ä¸¤ä¸ªé¡µé¢ä¸­æ˜¾ç¤ºä¸€è‡´</p>
                        <p>âœ… é”™é¢˜æœ¬çš„å¤ä¹ çŠ¶æ€æ˜¾ç¤ºå‡†ç¡®</p>
                        <p>âœ… çŠ¶æ€åŒæ­¥æœºåˆ¶å·¥ä½œæ­£å¸¸</p>
                    `, 'success');
                }

            } catch (error) {
                addResult(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                console.error('æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®tokenå¹¶è‡ªåŠ¨æ£€æŸ¥
        localStorage.setItem('token', TOKEN);
        setTimeout(() => {
            checkID10Status();
        }, 1000);
    </script>
</body>
</html>