<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è°ƒè¯•ID=6å¤ä¹ çŠ¶æ€</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” è°ƒè¯•ID=6çš„å¤ä¹ çŠ¶æ€é—®é¢˜</h1>
    
    <div>
        <button onclick="checkID6Status()">ğŸ“Š æ£€æŸ¥ID=6çŠ¶æ€</button>
        <button onclick="simulateMarkID6()">âœ… æ¨¡æ‹Ÿæ ‡è®°ID=6å·²å¤ä¹ </button>
        <button onclick="checkLocalStorage()">ğŸ’¾ æ£€æŸ¥localStorage</button>
        <button onclick="clearStorage()">ğŸ§¹ æ¸…é™¤localStorage</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            addResult('âœ… localStorageå·²æ¸…é™¤', 'success');
        }

        function checkLocalStorage() {
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            addResult(`ğŸ’¾ localStorageä¸­å·²å¤ä¹ é”™é¢˜: [${reviewedErrors.join(', ')}]`, 'info');
            addResult(`ğŸ“‹ ID=6æ˜¯å¦åœ¨å·²å¤ä¹ åˆ—è¡¨ä¸­: ${reviewedErrors.includes('6') ? 'æ˜¯' : 'å¦'}`, reviewedErrors.includes('6') ? 'success' : 'warning');
        }

        function simulateMarkID6() {
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            const errorIdStr = '6';
            
            if (!reviewedErrors.includes(errorIdStr)) {
                reviewedErrors.push(errorIdStr);
                localStorage.setItem('reviewedErrors', JSON.stringify(reviewedErrors));
                addResult(`âœ… å·²æ¨¡æ‹Ÿæ ‡è®° ID=6 ä¸ºå·²å¤ä¹ `, 'success');
                addResult(`ğŸ’¾ æ›´æ–°åçš„localStorage: [${reviewedErrors.join(', ')}]`, 'info');
            } else {
                addResult(`â„¹ï¸ ID=6 å·²ç»æ ‡è®°ä¸ºå·²å¤ä¹ `, 'info');
            }
        }

        async function checkID6Status() {
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            addResult('ğŸ”„ æ£€æŸ¥ID=6çš„å¤ä¹ çŠ¶æ€...', 'info');

            try {
                // 1. æ£€æŸ¥localStorage
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                const isLocalReviewed = reviewedErrors.includes('6');
                addResult(`ğŸ’¾ localStorageçŠ¶æ€: ID=6 ${isLocalReviewed ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, isLocalReviewed ? 'success' : 'warning');

                // 2. è·å–é”™é¢˜æœ¬APIæ•°æ®
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                
                // æŸ¥æ‰¾ID=6çš„é”™é¢˜
                const error6 = data.recent_errors.find(error => error.id == 6);
                
                if (error6) {
                    const apiReviewStatus = error6.is_reviewed;
                    addResult(`ğŸ“¡ APIçŠ¶æ€: ID=6 ${apiReviewStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, apiReviewStatus ? 'success' : 'warning');
                    
                    // 3. æ¨¡æ‹Ÿé”™é¢˜æœ¬é¡µé¢é€»è¾‘
                    const errorBookFinalStatus = isLocalReviewed || apiReviewStatus;
                    addResult(`ğŸ“– é”™é¢˜æœ¬é¡µé¢åº”è¯¥æ˜¾ç¤º: ID=6 ${errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, errorBookFinalStatus ? 'success' : 'error');
                    
                    // 4. æ¨¡æ‹Ÿé”™é¢˜è¯¦æƒ…é¡µé¢é€»è¾‘
                    const errorDetailFinalStatus = isLocalReviewed || apiReviewStatus;
                    addResult(`ğŸ“„ é”™é¢˜è¯¦æƒ…é¡µé¢åº”è¯¥æ˜¾ç¤º: ID=6 ${errorDetailFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, errorDetailFinalStatus ? 'success' : 'error');
                    
                    // 5. è¯¦ç»†ä¿¡æ¯
                    addResult(`
                        <h4>ğŸ“‹ è¯¦ç»†çŠ¶æ€ä¿¡æ¯ (ID=6):</h4>
                        <pre>${JSON.stringify({
                            id: error6.id,
                            subject: error6.subject,
                            question_preview: error6.question_text.substring(0, 50) + '...',
                            api_is_reviewed: error6.is_reviewed,
                            local_is_reviewed: isLocalReviewed,
                            final_status: errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '
                        }, null, 2)}</pre>
                    `, 'info');
                    
                    // 6. é—®é¢˜è¯Šæ–­
                    if (isLocalReviewed && !errorBookFinalStatus) {
                        addResult(`âŒ å‘ç°é—®é¢˜ï¼šlocalStorageæ˜¾ç¤ºå·²å¤ä¹ ï¼Œä½†æœ€ç»ˆçŠ¶æ€ä¸ºæœªå¤ä¹ `, 'error');
                    } else if (!isLocalReviewed && errorBookFinalStatus) {
                        addResult(`âš ï¸ æ³¨æ„ï¼šAPIæ˜¾ç¤ºå·²å¤ä¹ ï¼Œä½†localStorageä¸­æ— è®°å½•`, 'warning');
                    } else {
                        addResult(`âœ… çŠ¶æ€ä¸€è‡´ï¼š${errorBookFinalStatus ? 'å·²å¤ä¹ ' : 'æœªå¤ä¹ '}`, 'success');
                    }
                    
                } else {
                    addResult(`âŒ é”™é¢˜æœ¬APIä¸­æœªæ‰¾åˆ°ID=6çš„é”™é¢˜`, 'error');
                    
                    // æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„é”™é¢˜ID
                    const availableIds = data.recent_errors.slice(0, 10).map(e => e.id);
                    addResult(`ğŸ“‹ å¯ç”¨çš„é”™é¢˜ID (å‰10ä¸ª): [${availableIds.join(', ')}]`, 'info');
                }

                // 7. æµ‹è¯•é“¾æ¥
                addResult(`
                    <h4>ğŸ”— æµ‹è¯•é“¾æ¥:</h4>
                    <p><a href="http://localhost:8080/frontend/error-book.html" target="_blank">é”™é¢˜æœ¬é¡µé¢</a></p>
                    <p><a href="http://localhost:8080/frontend/error-detail.html?id=6" target="_blank">é”™é¢˜è¯¦æƒ…é¡µé¢ (ID=6)</a></p>
                `, 'info');

            } catch (error) {
                addResult(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®token
        localStorage.setItem('token', TOKEN);
    </script>
</body>
</html>