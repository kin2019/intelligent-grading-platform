<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>调试复习状态同步</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 调试复习状态同步问题</h1>
    
    <div>
        <button onclick="checkCurrentState()">📊 检查当前状态</button>
        <button onclick="simulateMarkReviewed()">✅ 模拟标记ID=1已复习</button>
        <button onclick="testErrorBookSync()">🔄 测试错题本同步逻辑</button>
        <button onclick="clearStorage()">🧹 清除localStorage</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            container.appendChild(div);
        }

        function clearStorage() {
            localStorage.clear();
            localStorage.setItem('token', TOKEN);
            addResult('✅ localStorage已清除', 'success');
        }

        async function checkCurrentState() {
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            addResult('📊 检查当前状态...', 'info');

            try {
                // 1. 检查localStorage
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                addResult(`💾 localStorage已复习错题: [${reviewedErrors.join(', ')}]`, 'info');

                // 2. 获取API数据
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                const firstError = data.recent_errors[0];
                
                addResult(`📡 API第一条错题 ID=${firstError.id}, 复习状态: ${firstError.is_reviewed ? '已复习' : '未复习'}`, 'info');

                // 3. 模拟错题本页面逻辑
                const errorBookLogic = simulateErrorBookLogic([firstError], reviewedErrors);
                addResult(`📖 错题本页面逻辑结果: ID=${firstError.id} -> ${errorBookLogic[0].is_reviewed ? '已复习' : '未复习'}`, errorBookLogic[0].is_reviewed ? 'success' : 'warning');

                // 4. 模拟错题详情页面逻辑
                const errorDetailLogic = simulateErrorDetailLogic(firstError, reviewedErrors);
                addResult(`📄 错题详情页面逻辑结果: ID=${firstError.id} -> ${errorDetailLogic.is_reviewed ? '已复习' : '未复习'}`, errorDetailLogic.is_reviewed ? 'success' : 'warning');

            } catch (error) {
                addResult(`❌ 检查失败: ${error.message}`, 'error');
            }
        }

        function simulateErrorBookLogic(errorData, reviewedErrors) {
            // 模拟错题本页面的syncLocalReviewStatus逻辑
            const result = JSON.parse(JSON.stringify(errorData)); // 深拷贝
            
            if (reviewedErrors.length > 0) {
                result.forEach(error => {
                    if (reviewedErrors.includes(String(error.id))) {
                        error.is_reviewed = true;
                    }
                });
            }
            
            return result;
        }

        function simulateErrorDetailLogic(errorData, reviewedErrors) {
            // 模拟错题详情页面的syncLocalReviewStatus逻辑
            const result = JSON.parse(JSON.stringify(errorData)); // 深拷贝
            
            if (reviewedErrors.length > 0) {
                if (reviewedErrors.includes(String(result.id))) {
                    result.is_reviewed = true;
                }
            }
            
            return result;
        }

        function simulateMarkReviewed() {
            // 模拟错题详情页面的标记已复习操作
            const errorId = '1';
            const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
            
            if (!reviewedErrors.includes(errorId)) {
                reviewedErrors.push(errorId);
                localStorage.setItem('reviewedErrors', JSON.stringify(reviewedErrors));
                addResult(`✅ 已模拟在错题详情页面标记 ID=${errorId} 为已复习`, 'success');
                addResult(`💾 更新后的localStorage: [${reviewedErrors.join(', ')}]`, 'info');
                
                // 触发storage事件测试
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'reviewedErrors',
                    newValue: JSON.stringify(reviewedErrors),
                    oldValue: JSON.stringify(reviewedErrors.slice(0, -1))
                }));
                
            } else {
                addResult(`ℹ️ ID=${errorId} 已经标记为已复习`, 'info');
            }
        }

        async function testErrorBookSync() {
            addResult('🔄 测试错题本页面同步逻辑...', 'info');
            
            try {
                // 获取API数据
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                const errorData = data.recent_errors.slice(0, 3); // 前3个错题
                
                // 获取localStorage数据
                const reviewedErrors = JSON.parse(localStorage.getItem('reviewedErrors') || '[]');
                
                addResult('🔍 同步前后对比:', 'info');
                
                // 同步前状态
                const beforeSync = errorData.map(e => ({ id: e.id, is_reviewed: e.is_reviewed }));
                addResult(`同步前: ${JSON.stringify(beforeSync)}`, 'warning');
                
                // 执行同步逻辑
                errorData.forEach(error => {
                    if (reviewedErrors.includes(String(error.id))) {
                        error.is_reviewed = true;
                    }
                });
                
                // 同步后状态
                const afterSync = errorData.map(e => ({ id: e.id, is_reviewed: e.is_reviewed }));
                addResult(`同步后: ${JSON.stringify(afterSync)}`, 'success');
                
                // 检查变化
                const hasChanges = JSON.stringify(beforeSync) !== JSON.stringify(afterSync);
                addResult(`状态是否有变化: ${hasChanges ? '是' : '否'}`, hasChanges ? 'success' : 'warning');
                
            } catch (error) {
                addResult(`❌ 测试失败: ${error.message}`, 'error');
            }
        }

        // 监听storage事件
        window.addEventListener('storage', function(e) {
            if (e.key === 'reviewedErrors') {
                addResult(`📢 检测到localStorage变化: ${e.key} = ${e.newValue}`, 'info');
            }
        });

        // 页面加载时设置token
        localStorage.setItem('token', TOKEN);
    </script>
</body>
</html>