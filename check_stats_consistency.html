<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ£€æŸ¥ç»Ÿè®¡ä¸€è‡´æ€§</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” æ£€æŸ¥ç»Ÿè®¡ä¸€è‡´æ€§</h1>
    <button onclick="checkConsistency()">ğŸš€ ç«‹å³æ£€æŸ¥</button>
    <button onclick="continuousCheck()">ğŸ”„ è¿ç»­æ£€æŸ¥(5æ¬¡)</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(html, className = 'info') {
            const div = document.createElement('div');
            div.className = `result ${className}`;
            div.innerHTML = html;
            document.getElementById('results').appendChild(div);
        }

        async function checkConsistency() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸ” å¼€å§‹æ£€æŸ¥APIæ•°æ®å’Œç»Ÿè®¡ä¸€è‡´æ€§...', 'info');

            try {
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const errorData = data.recent_errors || [];

                // è¯¦ç»†åˆ†ææ¯æ¡æ•°æ®çš„å¤ä¹ çŠ¶æ€
                let reviewedCount = 0;
                let unreviewedCount = 0;
                let invalidCount = 0;
                const detailAnalysis = [];

                errorData.forEach((error, index) => {
                    const analysis = {
                        index: index + 1,
                        id: error.id,
                        subject: error.subject,
                        is_reviewed: error.is_reviewed,
                        type: typeof error.is_reviewed,
                        valid: typeof error.is_reviewed === 'boolean'
                    };

                    detailAnalysis.push(analysis);

                    if (typeof error.is_reviewed === 'boolean') {
                        if (error.is_reviewed === true) {
                            reviewedCount++;
                        } else {
                            unreviewedCount++;
                        }
                    } else {
                        invalidCount++;
                    }
                });

                const totalCount = errorData.length;
                const calculatedSum = reviewedCount + unreviewedCount + invalidCount;
                const isConsistent = calculatedSum === totalCount;

                addResult(`
                    <h3>ğŸ“Š ç»Ÿè®¡ç»“æœ</h3>
                    <table>
                        <tr><th>ç»Ÿè®¡é¡¹</th><th>æ•°é‡</th><th>è¯´æ˜</th></tr>
                        <tr><td>æ€»é”™é¢˜æ•°</td><td><strong>${totalCount}</strong></td><td>APIè¿”å›çš„æ•°æ®æ€»æ•°</td></tr>
                        <tr><td>å·²å¤ä¹ </td><td><strong>${reviewedCount}</strong></td><td>is_reviewed = true</td></tr>
                        <tr><td>æœªå¤ä¹ </td><td><strong>${unreviewedCount}</strong></td><td>is_reviewed = false</td></tr>
                        <tr><td>æ— æ•ˆæ•°æ®</td><td><strong>${invalidCount}</strong></td><td>is_reviewedä¸æ˜¯å¸ƒå°”å€¼</td></tr>
                        <tr><td>è®¡ç®—æ€»å’Œ</td><td><strong>${calculatedSum}</strong></td><td>${reviewedCount} + ${unreviewedCount} + ${invalidCount}</td></tr>
                    </table>
                `, isConsistent && invalidCount === 0 ? 'success' : 'error');

                if (isConsistent && invalidCount === 0) {
                    addResult('âœ… ç»Ÿè®¡æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæ²¡æœ‰å‘ç°é—®é¢˜', 'success');
                } else if (!isConsistent) {
                    addResult(`âŒ æ•°æ®ä¸ä¸€è‡´ï¼šæ€»æ•°${totalCount}ï¼Œä½†è®¡ç®—æ€»å’Œä¸º${calculatedSum}`, 'error');
                }

                if (invalidCount > 0) {
                    addResult(`âš ï¸ å‘ç°${invalidCount}æ¡æ— æ•ˆæ•°æ®ï¼Œis_reviewedå­—æ®µä¸æ˜¯å¸ƒå°”å€¼`, 'warning');
                }

                // æ˜¾ç¤ºå‰10æ¡æ•°æ®çš„è¯¦ç»†ä¿¡æ¯
                addResult(`
                    <h3>ğŸ“‹ æ•°æ®è¯¦æƒ… (å‰10æ¡)</h3>
                    <table>
                        <tr><th>åºå·</th><th>ID</th><th>ç§‘ç›®</th><th>å¤ä¹ çŠ¶æ€</th><th>ç±»å‹</th><th>æœ‰æ•ˆæ€§</th></tr>
                        ${detailAnalysis.slice(0, 10).map(item => `
                            <tr style="background: ${item.valid ? (item.is_reviewed ? '#e8f5e8' : '#fff3cd') : '#f8d7da'}">
                                <td>${item.index}</td>
                                <td>${item.id}</td>
                                <td>${item.subject}</td>
                                <td>${item.is_reviewed}</td>
                                <td>${item.type}</td>
                                <td>${item.valid ? 'âœ…' : 'âŒ'}</td>
                            </tr>
                        `).join('')}
                    </table>
                `, 'info');

                // æŒ‰ç§‘ç›®ç»Ÿè®¡
                const subjectStats = {};
                errorData.forEach(error => {
                    if (!subjectStats[error.subject]) {
                        subjectStats[error.subject] = { total: 0, reviewed: 0, unreviewed: 0 };
                    }
                    subjectStats[error.subject].total++;
                    if (error.is_reviewed === true) {
                        subjectStats[error.subject].reviewed++;
                    } else if (error.is_reviewed === false) {
                        subjectStats[error.subject].unreviewed++;
                    }
                });

                addResult(`
                    <h3>ğŸ“š æŒ‰ç§‘ç›®ç»Ÿè®¡</h3>
                    <table>
                        <tr><th>ç§‘ç›®</th><th>æ€»æ•°</th><th>å·²å¤ä¹ </th><th>æœªå¤ä¹ </th><th>ä¸€è‡´æ€§</th></tr>
                        ${Object.entries(subjectStats).map(([subject, stats]) => {
                            const consistent = stats.reviewed + stats.unreviewed === stats.total;
                            return `
                                <tr style="background: ${consistent ? '#d4edda' : '#f8d7da'}">
                                    <td>${subject}</td>
                                    <td>${stats.total}</td>
                                    <td>${stats.reviewed}</td>
                                    <td>${stats.unreviewed}</td>
                                    <td>${consistent ? 'âœ…' : 'âŒ'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                `, 'info');

            } catch (error) {
                addResult(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function continuousCheck() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸ”„ å¼€å§‹è¿ç»­æ£€æŸ¥(5æ¬¡)...', 'info');

            const results = [];
            
            for (let i = 1; i <= 5; i++) {
                addResult(`ğŸ” ç¬¬${i}æ¬¡æ£€æŸ¥...`, 'info');
                
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    const errorData = data.recent_errors || [];

                    const stats = {
                        total: errorData.length,
                        reviewed: errorData.filter(e => e.is_reviewed === true).length,
                        unreviewed: errorData.filter(e => e.is_reviewed === false).length,
                        invalid: errorData.filter(e => typeof e.is_reviewed !== 'boolean').length,
                        timestamp: new Date().toLocaleTimeString()
                    };

                    results.push(stats);

                } catch (error) {
                    results.push({ error: error.message, timestamp: new Date().toLocaleTimeString() });
                }

                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // åˆ†æç»“æœ
            const validResults = results.filter(r => !r.error);
            const firstResult = validResults[0];
            const isConsistent = validResults.every(r => 
                r.total === firstResult.total &&
                r.reviewed === firstResult.reviewed &&
                r.unreviewed === firstResult.unreviewed
            );

            addResult(`
                <h3>ğŸ”„ è¿ç»­æ£€æŸ¥ç»“æœ</h3>
                <p><strong>ä¸€è‡´æ€§ï¼š${isConsistent ? 'âœ… å®Œå…¨ä¸€è‡´' : 'âŒ å­˜åœ¨å·®å¼‚'}</strong></p>
                <table>
                    <tr><th>æ¬¡æ•°</th><th>æ—¶é—´</th><th>æ€»é”™é¢˜</th><th>å·²å¤ä¹ </th><th>æœªå¤ä¹ </th><th>æ— æ•ˆ</th><th>çŠ¶æ€</th></tr>
                    ${results.map((result, index) => `
                        <tr style="background: ${result.error ? '#f8d7da' : '#d4edda'}">
                            <td>ç¬¬${index + 1}æ¬¡</td>
                            <td>${result.timestamp}</td>
                            <td>${result.error ? '-' : result.total}</td>
                            <td>${result.error ? '-' : result.reviewed}</td>
                            <td>${result.error ? '-' : result.unreviewed}</td>
                            <td>${result.error ? '-' : result.invalid}</td>
                            <td>${result.error ? result.error : 'æ­£å¸¸'}</td>
                        </tr>
                    `).join('')}
                </table>
            `, isConsistent ? 'success' : 'error');

            if (isConsistent && validResults.length === 5) {
                addResult(`âœ… è¿ç»­5æ¬¡æ£€æŸ¥ç»“æœå®Œå…¨ä¸€è‡´ï¼Œç»Ÿè®¡æ•°å­—ç¨³å®šæ­£ç¡®ï¼<br>
                    â€¢ æ€»é”™é¢˜ï¼š${firstResult.total}<br>
                    â€¢ å·²å¤ä¹ ï¼š${firstResult.reviewed}<br>
                    â€¢ æœªå¤ä¹ ï¼š${firstResult.unreviewed}<br>
                    â€¢ æ•°æ®è´¨é‡ï¼š${firstResult.invalid === 0 ? 'ä¼˜ç§€' : 'æœ‰é—®é¢˜'}`, 'success');
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
        window.onload = () => {
            localStorage.setItem('token', TOKEN);
            addResult('ğŸ“‹ é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æ£€æŸ¥ç»Ÿè®¡æ•°å­—çš„å‡†ç¡®æ€§', 'info');
        };
    </script>
</body>
</html>