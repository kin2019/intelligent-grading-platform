<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>检查统计一致性</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>🔍 检查统计一致性</h1>
    <button onclick="checkConsistency()">🚀 立即检查</button>
    <button onclick="continuousCheck()">🔄 连续检查(5次)</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTYxNzg4NTUsInN1YiI6IjUifQ.YSMhpQQulzOxNrzD5IQs1h15HIqX5U_OBJ7VMQezq5o';

        function addResult(html, className = 'info') {
            const div = document.createElement('div');
            div.className = `result ${className}`;
            div.innerHTML = html;
            document.getElementById('results').appendChild(div);
        }

        async function checkConsistency() {
            document.getElementById('results').innerHTML = '';
            addResult('🔍 开始检查API数据和统计一致性...', 'info');

            try {
                const response = await fetch(`${API_BASE}/student/error-book`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                const errorData = data.recent_errors || [];

                // 详细分析每条数据的复习状态
                let reviewedCount = 0;
                let unreviewedCount = 0;
                let invalidCount = 0;
                const detailAnalysis = [];

                errorData.forEach((error, index) => {
                    const analysis = {
                        index: index + 1,
                        id: error.id,
                        subject: error.subject,
                        is_reviewed: error.is_reviewed,
                        type: typeof error.is_reviewed,
                        valid: typeof error.is_reviewed === 'boolean'
                    };

                    detailAnalysis.push(analysis);

                    if (typeof error.is_reviewed === 'boolean') {
                        if (error.is_reviewed === true) {
                            reviewedCount++;
                        } else {
                            unreviewedCount++;
                        }
                    } else {
                        invalidCount++;
                    }
                });

                const totalCount = errorData.length;
                const calculatedSum = reviewedCount + unreviewedCount + invalidCount;
                const isConsistent = calculatedSum === totalCount;

                addResult(`
                    <h3>📊 统计结果</h3>
                    <table>
                        <tr><th>统计项</th><th>数量</th><th>说明</th></tr>
                        <tr><td>总错题数</td><td><strong>${totalCount}</strong></td><td>API返回的数据总数</td></tr>
                        <tr><td>已复习</td><td><strong>${reviewedCount}</strong></td><td>is_reviewed = true</td></tr>
                        <tr><td>未复习</td><td><strong>${unreviewedCount}</strong></td><td>is_reviewed = false</td></tr>
                        <tr><td>无效数据</td><td><strong>${invalidCount}</strong></td><td>is_reviewed不是布尔值</td></tr>
                        <tr><td>计算总和</td><td><strong>${calculatedSum}</strong></td><td>${reviewedCount} + ${unreviewedCount} + ${invalidCount}</td></tr>
                    </table>
                `, isConsistent && invalidCount === 0 ? 'success' : 'error');

                if (isConsistent && invalidCount === 0) {
                    addResult('✅ 统计数据完全一致，没有发现问题', 'success');
                } else if (!isConsistent) {
                    addResult(`❌ 数据不一致：总数${totalCount}，但计算总和为${calculatedSum}`, 'error');
                }

                if (invalidCount > 0) {
                    addResult(`⚠️ 发现${invalidCount}条无效数据，is_reviewed字段不是布尔值`, 'warning');
                }

                // 显示前10条数据的详细信息
                addResult(`
                    <h3>📋 数据详情 (前10条)</h3>
                    <table>
                        <tr><th>序号</th><th>ID</th><th>科目</th><th>复习状态</th><th>类型</th><th>有效性</th></tr>
                        ${detailAnalysis.slice(0, 10).map(item => `
                            <tr style="background: ${item.valid ? (item.is_reviewed ? '#e8f5e8' : '#fff3cd') : '#f8d7da'}">
                                <td>${item.index}</td>
                                <td>${item.id}</td>
                                <td>${item.subject}</td>
                                <td>${item.is_reviewed}</td>
                                <td>${item.type}</td>
                                <td>${item.valid ? '✅' : '❌'}</td>
                            </tr>
                        `).join('')}
                    </table>
                `, 'info');

                // 按科目统计
                const subjectStats = {};
                errorData.forEach(error => {
                    if (!subjectStats[error.subject]) {
                        subjectStats[error.subject] = { total: 0, reviewed: 0, unreviewed: 0 };
                    }
                    subjectStats[error.subject].total++;
                    if (error.is_reviewed === true) {
                        subjectStats[error.subject].reviewed++;
                    } else if (error.is_reviewed === false) {
                        subjectStats[error.subject].unreviewed++;
                    }
                });

                addResult(`
                    <h3>📚 按科目统计</h3>
                    <table>
                        <tr><th>科目</th><th>总数</th><th>已复习</th><th>未复习</th><th>一致性</th></tr>
                        ${Object.entries(subjectStats).map(([subject, stats]) => {
                            const consistent = stats.reviewed + stats.unreviewed === stats.total;
                            return `
                                <tr style="background: ${consistent ? '#d4edda' : '#f8d7da'}">
                                    <td>${subject}</td>
                                    <td>${stats.total}</td>
                                    <td>${stats.reviewed}</td>
                                    <td>${stats.unreviewed}</td>
                                    <td>${consistent ? '✅' : '❌'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                `, 'info');

            } catch (error) {
                addResult(`❌ 检查失败: ${error.message}`, 'error');
            }
        }

        async function continuousCheck() {
            document.getElementById('results').innerHTML = '';
            addResult('🔄 开始连续检查(5次)...', 'info');

            const results = [];
            
            for (let i = 1; i <= 5; i++) {
                addResult(`🔍 第${i}次检查...`, 'info');
                
                try {
                    const response = await fetch(`${API_BASE}/student/error-book`, {
                        headers: { 'Authorization': `Bearer ${TOKEN}` }
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const errorData = data.recent_errors || [];

                    const stats = {
                        total: errorData.length,
                        reviewed: errorData.filter(e => e.is_reviewed === true).length,
                        unreviewed: errorData.filter(e => e.is_reviewed === false).length,
                        invalid: errorData.filter(e => typeof e.is_reviewed !== 'boolean').length,
                        timestamp: new Date().toLocaleTimeString()
                    };

                    results.push(stats);

                } catch (error) {
                    results.push({ error: error.message, timestamp: new Date().toLocaleTimeString() });
                }

                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // 分析结果
            const validResults = results.filter(r => !r.error);
            const firstResult = validResults[0];
            const isConsistent = validResults.every(r => 
                r.total === firstResult.total &&
                r.reviewed === firstResult.reviewed &&
                r.unreviewed === firstResult.unreviewed
            );

            addResult(`
                <h3>🔄 连续检查结果</h3>
                <p><strong>一致性：${isConsistent ? '✅ 完全一致' : '❌ 存在差异'}</strong></p>
                <table>
                    <tr><th>次数</th><th>时间</th><th>总错题</th><th>已复习</th><th>未复习</th><th>无效</th><th>状态</th></tr>
                    ${results.map((result, index) => `
                        <tr style="background: ${result.error ? '#f8d7da' : '#d4edda'}">
                            <td>第${index + 1}次</td>
                            <td>${result.timestamp}</td>
                            <td>${result.error ? '-' : result.total}</td>
                            <td>${result.error ? '-' : result.reviewed}</td>
                            <td>${result.error ? '-' : result.unreviewed}</td>
                            <td>${result.error ? '-' : result.invalid}</td>
                            <td>${result.error ? result.error : '正常'}</td>
                        </tr>
                    `).join('')}
                </table>
            `, isConsistent ? 'success' : 'error');

            if (isConsistent && validResults.length === 5) {
                addResult(`✅ 连续5次检查结果完全一致，统计数字稳定正确！<br>
                    • 总错题：${firstResult.total}<br>
                    • 已复习：${firstResult.reviewed}<br>
                    • 未复习：${firstResult.unreviewed}<br>
                    • 数据质量：${firstResult.invalid === 0 ? '优秀' : '有问题'}`, 'success');
            }
        }

        // 页面加载后自动检查一次
        window.onload = () => {
            localStorage.setItem('token', TOKEN);
            addResult('📋 页面已加载，可以开始检查统计数字的准确性', 'info');
        };
    </script>
</body>
</html>