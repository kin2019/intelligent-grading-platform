<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå“åº”è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .debug-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .button { 
            padding: 10px 16px; 
            margin: 5px; 
            background: #007AFF; 
            color: white; 
            border: none;
            border-radius: 4px; 
            cursor: pointer;
        }
        .button:hover { background: #0056CC; }
        input[type="text"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” APIå“åº”è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>ä½œä¸šIDæµ‹è¯•</h3>
        <input type="text" id="homeworkId" value="942516" placeholder="è¾“å…¥ä½œä¸šID">
        <button class="button" onclick="testAPI()">ğŸ§ª æµ‹è¯•APIå“åº”</button>
        <button class="button" onclick="testWithAuth()">ğŸ”‘ å¸¦è®¤è¯æµ‹è¯•</button>
        <button class="button" onclick="testDirectAPI()">ğŸ“¡ ç›´æ¥APIè°ƒç”¨</button>
    </div>

    <div class="debug-section">
        <h3>APIå“åº”ç»“æœ</h3>
        <div id="apiResult" class="result info">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="debug-section">
        <h3>æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</h3>
        <div id="validationResult" class="result info">ç­‰å¾…éªŒè¯...</div>
    </div>

    <div class="debug-section">
        <h3>å¿«é€Ÿæµ‹è¯•é“¾æ¥</h3>
        <button class="button" onclick="testMultipleIDs()">ğŸ”¢ æµ‹è¯•å¤šä¸ªID</button>
        <div id="multipleResults" class="result info" style="display:none;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(message);
            const resultDiv = document.getElementById('apiResult');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        function validateData(data) {
            const validationDiv = document.getElementById('validationResult');
            
            const checks = [
                { field: 'id', value: data.id, required: true },
                { field: 'subject', value: data.subject, required: true },
                { field: 'total_questions', value: data.total_questions, required: true },
                { field: 'correct_count', value: data.correct_count, required: false },
                { field: 'wrong_count', value: data.wrong_count, required: false },
                { field: 'accuracy_rate', value: data.accuracy_rate, required: false },
                { field: 'status', value: data.status, required: false },
                { field: 'correction_results', value: data.correction_results, required: false }
            ];

            let validationResult = '=== æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ ===\n';
            let isComplete = true;
            
            checks.forEach(check => {
                const exists = check.value !== undefined && check.value !== null;
                const status = exists ? 'âœ…' : (check.required ? 'âŒ' : 'âš ï¸');
                validationResult += `${status} ${check.field}: ${check.value}\n`;
                
                if (check.required && !exists) {
                    isComplete = false;
                }
            });

            validationResult += `\n=== å‰ç«¯æ£€æŸ¥æ¡ä»¶ ===\n`;
            validationResult += `apiData: ${!!data} ${!!data ? 'âœ…' : 'âŒ'}\n`;
            validationResult += `apiData.subject: ${!!data.subject} ${!!data.subject ? 'âœ…' : 'âŒ'}\n`;
            validationResult += `apiData.total_questions: ${!!data.total_questions} ${!!data.total_questions ? 'âœ…' : 'âŒ'}\n`;
            validationResult += `\næ£€æŸ¥æ¡ä»¶ç»“æœ: ${data && data.subject && data.total_questions ? 'âœ… é€šè¿‡' : 'âŒ ä¸é€šè¿‡'}\n`;
            validationResult += `æ•´ä½“å®Œæ•´æ€§: ${isComplete ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´'}`;

            validationDiv.className = `result ${isComplete && data && data.subject && data.total_questions ? 'success' : 'error'}`;
            validationDiv.textContent = validationResult;
        }

        async function testAPI() {
            const homeworkId = document.getElementById('homeworkId').value;
            log('æ­£åœ¨æµ‹è¯• API å“åº”...', 'info');
            
            try {
                const response = await fetch(`/api/v1/homework/result/${homeworkId}`);
                
                log(`=== API å“åº”çŠ¶æ€ ===
çŠ¶æ€ç : ${response.status}
çŠ¶æ€æ–‡æœ¬: ${response.statusText}
Content-Type: ${response.headers.get('content-type')}
`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`=== API å“åº”æ•°æ® ===
${JSON.stringify(data, null, 2)}`, 'success');
                    
                    validateData(data);
                } else {
                    const errorText = await response.text();
                    log(`=== API é”™è¯¯å“åº” ===
é”™è¯¯å†…å®¹: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`=== API è°ƒç”¨å¼‚å¸¸ ===
é”™è¯¯ç±»å‹: ${error.name}
é”™è¯¯ä¿¡æ¯: ${error.message}
é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        async function testWithAuth() {
            const homeworkId = document.getElementById('homeworkId').value;
            log('æ­£åœ¨æµ‹è¯•å¸¦è®¤è¯çš„ API å“åº”...', 'info');
            
            try {
                const response = await fetch(`/api/v1/homework/result/${homeworkId}`, {
                    headers: {
                        'Authorization': 'Bearer demo-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`=== å¸¦è®¤è¯çš„ API å“åº” ===
çŠ¶æ€ç : ${response.status}
è®¤è¯å¤´: Bearer demo-token
`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`=== å“åº”æ•°æ® ===
${JSON.stringify(data, null, 2)}`, 'success');
                    validateData(data);
                } else {
                    const errorText = await response.text();
                    log(`=== è®¤è¯APIé”™è¯¯ ===
é”™è¯¯: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`=== è®¤è¯APIå¼‚å¸¸ ===
${error.message}`, 'error');
            }
        }

        async function testDirectAPI() {
            const homeworkId = document.getElementById('homeworkId').value;
            log('æ­£åœ¨æµ‹è¯•ç›´æ¥ API è°ƒç”¨...', 'info');
            
            // æ¨¡æ‹Ÿç›´æ¥åç«¯è°ƒç”¨é€»è¾‘
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            const subjectNames = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©'];
            const index = parseInt(homeworkId) % subjects.length;
            
            log(`=== ç›´æ¥ç®—æ³•è®¡ç®— ===
ä½œä¸šID: ${homeworkId}
è®¡ç®—: ${homeworkId} % ${subjects.length} = ${index}
å­¦ç§‘(è‹±): ${subjects[index]}
å­¦ç§‘(ä¸­): ${subjectNames[index]}

=== æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ ===`, 'info');

            // æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„å“åº”
            const mockData = {
                id: parseInt(homeworkId),
                subject: subjects[index],
                total_questions: 8,
                correct_count: 6,
                wrong_count: 2,
                accuracy_rate: 75.0,
                status: "completed",
                correction_results: [
                    {
                        question_number: 1,
                        question_text: "æµ‹è¯•é¢˜ç›®",
                        user_answer: "A",
                        correct_answer: "A",
                        is_correct: true
                    }
                ]
            };

            log(`æ¨¡æ‹Ÿå®Œæ•´å“åº”:
${JSON.stringify(mockData, null, 2)}`, 'success');
            
            validateData(mockData);
        }

        async function testMultipleIDs() {
            const ids = [942516, 942737, 898411, 773191, 123456];
            const resultsDiv = document.getElementById('multipleResults');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result info';
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•å¤šä¸ªID...';
            
            let results = '=== å¤šä¸ªIDæµ‹è¯•ç»“æœ ===\n';
            
            for (const id of ids) {
                try {
                    const response = await fetch(`/api/v1/homework/result/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        const isComplete = data && data.subject && data.total_questions;
                        results += `ID ${id}: ${isComplete ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´'} (å­¦ç§‘: ${data.subject || 'N/A'})\n`;
                    } else {
                        results += `ID ${id}: âŒ APIé”™è¯¯ (${response.status})\n`;
                    }
                } catch (error) {
                    results += `ID ${id}: âŒ å¼‚å¸¸ (${error.message})\n`;
                }
            }
            
            resultsDiv.textContent = results;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            console.log('=== APIè°ƒè¯•å·¥å…·åˆå§‹åŒ– ===');
            // è‡ªåŠ¨æµ‹è¯•é»˜è®¤ID
            testAPI();
        };
    </script>
</body>
</html>