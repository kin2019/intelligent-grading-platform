<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®æµè°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { color: red; background: #fee; }
        .success { color: green; background: #efe; }
        .warning { color: orange; background: #ffeaa7; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” æ•°æ®æµè°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h3>æµ‹è¯•æœªçŸ¥ä½œä¸šIDçš„æ•°æ®æµ</h3>
        <button onclick="debugDataFlow(964020)">è°ƒè¯• 964020</button>
        <button onclick="debugDataFlow(Date.now())">è°ƒè¯•å½“å‰æ—¶é—´æˆ³</button>
        <button onclick="debugDataFlow(898411)">è°ƒè¯•æ¼”ç¤ºID 898411</button>
    </div>
    
    <div id="debugOutput"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let debugOutput = document.getElementById('debugOutput');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            debugOutput.appendChild(div);
        }
        
        async function debugDataFlow(homeworkId) {
            debugOutput.innerHTML = '';
            log(`ğŸš€ å¼€å§‹è°ƒè¯•ä½œä¸šID: ${homeworkId}`, 'info');
            
            // 1. æµ‹è¯• generateFallbackData
            log('ğŸ“¦ æ­¥éª¤1: è°ƒç”¨ generateFallbackData', 'info');
            const fallbackData = generateFallbackData(homeworkId);
            log(`Fallbackæ•°æ®:\n<pre>${JSON.stringify(fallbackData, null, 2)}</pre>`, fallbackData.total_questions > 0 && !isDemoId(homeworkId) ? 'error' : 'success');
            
            // 2. æµ‹è¯•APIè°ƒç”¨ï¼ˆæ¨¡æ‹Ÿï¼‰
            log('ğŸŒ æ­¥éª¤2: æµ‹è¯•APIè°ƒç”¨', 'info');
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/homework/result/${homeworkId}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const apiData = await response.json();
                    log(`âœ… APIè°ƒç”¨æˆåŠŸï¼ŒçŠ¶æ€: ${response.status}`, 'success');
                    log(`APIåŸå§‹æ•°æ®:\n<pre>${JSON.stringify(apiData, null, 2)}</pre>`, 'info');
                    
                    // 3. æ¨¡æ‹Ÿå‰ç«¯æ•°æ®å¤„ç†é€»è¾‘
                    log('ğŸ”„ æ­¥éª¤3: æ¨¡æ‹Ÿå‰ç«¯æ•°æ®å¤„ç†', 'info');
                    let finalData = simulateDataProcessing(apiData, fallbackData);
                    log(`æœ€ç»ˆå¤„ç†åæ•°æ®:\n<pre>${JSON.stringify(finalData, null, 2)}</pre>`, 
                        (finalData.total_questions > 0 && !isDemoId(homeworkId)) ? 'error' : 'success');
                        
                    // 4. æ¨¡æ‹ŸupdateSummaryé€»è¾‘
                    log('ğŸ“Š æ­¥éª¤4: æ¨¡æ‹ŸupdateSummaryå¤„ç†', 'info');
                    const summaryResult = simulateUpdateSummary(finalData);
                    log(`Summaryæ˜¾ç¤ºç»“æœ: ${summaryResult}`, 
                        summaryResult.includes('6') || summaryResult.includes('8') && !isDemoId(homeworkId) ? 'error' : 'success');
                        
                } else {
                    log(`âŒ APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€: ${response.status}`, 'warning');
                    log('ä½¿ç”¨fallbackæ•°æ®', 'info');
                    
                    // ç›´æ¥æµ‹è¯•fallbackæ•°æ®çš„summaryå¤„ç†
                    const summaryResult = simulateUpdateSummary(fallbackData);
                    log(`Summaryæ˜¾ç¤ºç»“æœ: ${summaryResult}`, 
                        summaryResult.includes('6') || summaryResult.includes('8') && !isDemoId(homeworkId) ? 'error' : 'success');
                }
            } catch (error) {
                log(`ğŸ”¥ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                
                // æµ‹è¯•å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
                const summaryResult = simulateUpdateSummary(fallbackData);
                log(`å¼‚å¸¸æƒ…å†µSummaryæ˜¾ç¤º: ${summaryResult}`, 
                    summaryResult.includes('6') || summaryResult.includes('8') && !isDemoId(homeworkId) ? 'error' : 'success');
            }
        }
        
        function isDemoId(id) {
            return [898411, 773191, 942516, 942737, 899573].includes(parseInt(id));
        }
        
        function simulateDataProcessing(apiData, fallbackData) {
            // æ¨¡æ‹ŸloadHomeworkDataDirectlyä¸­çš„å¤„ç†é€»è¾‘
            let finalData = fallbackData;
            
            if (apiData && (apiData.status === 'recognition_failed' || apiData.special_message)) {
                console.log('APIè¿”å›è¯†åˆ«å¤±è´¥çŠ¶æ€ï¼Œç›´æ¥ä½¿ç”¨');
                finalData = apiData;
            } else if (apiData && (apiData.subject || apiData.id) && apiData.status !== 'recognition_failed') {
                // åªå¯¹æ­£å¸¸çš„æ‰¹æ”¹ç»“æœæ‰æ·»åŠ é»˜è®¤å€¼
                if (!apiData.total_questions) {
                    apiData.total_questions = 8;
                }
                if (!apiData.subject) {
                    apiData.subject = 'chinese';
                }
                if (!apiData.correct_count && apiData.correct_count !== 0) {
                    apiData.correct_count = Math.floor(apiData.total_questions * 0.75);
                }
                if (!apiData.wrong_count && apiData.wrong_count !== 0) {
                    apiData.wrong_count = apiData.total_questions - apiData.correct_count;
                }
                finalData = apiData;
            }
            
            // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
            if (!finalData.correction_results || !Array.isArray(finalData.correction_results)) {
                finalData.correction_results = fallbackData.correction_results;
            }
            
            return finalData;
        }
        
        function simulateUpdateSummary(data) {
            // æ¨¡æ‹ŸupdateSummaryçš„é€»è¾‘
            if (data.special_message || data.status === 'recognition_failed' || 
                (data.total_questions === 0 && data.correct_count === 0 && data.wrong_count === 0)) {
                return 'scoreNumber: ?, totalQuestions: ?, correctCount: -, incorrectCount: -, accuracyRate: -';
            }
            
            const scorePercentage = (data.correct_count / data.total_questions) * 100;
            return `scoreNumber: ${data.correct_count}, totalQuestions: ${data.total_questions}, correctCount: ${data.correct_count}, incorrectCount: ${data.wrong_count}, accuracyRate: ${Math.round(data.accuracy_rate || scorePercentage)}%`;
        }
        
        function generateFallbackData(homeworkId) {
            console.log(`ğŸ”¥ generateFallbackDataè¢«è°ƒç”¨ - ä½œä¸šID ${homeworkId}`);
            
            const EXACT_DEMO_IDS = [898411, 773191, 942516, 942737, 899573];
            
            if (EXACT_DEMO_IDS.includes(parseInt(homeworkId))) {
                console.log(`âœ… ä½œä¸šID ${homeworkId} æ˜¯æ¼”ç¤ºIDï¼Œç”Ÿæˆæµ‹è¯•æ•°æ®`);
                return generateTestData(homeworkId);
            }
            
            console.log(`ğŸš« ä½œä¸šID ${homeworkId} ä¸åœ¨æ¼”ç¤ºåˆ—è¡¨ä¸­ï¼Œè¿”å›è¯†åˆ«å¤±è´¥`);
            
            const recognitionFailedData = {
                id: homeworkId,
                subject: 'unknown',
                total_questions: 0,
                correct_count: 0,
                wrong_count: 0,
                accuracy_rate: 0,
                status: 'recognition_failed',
                original_image_url: null,
                correction_results: [],
                created_at: new Date().toISOString(),
                special_message: {
                    type: 'recognition_failed',
                    title: 'æ— æ³•è¯†åˆ«ä½œä¸šå†…å®¹',
                    content: 'æŠ±æ­‰ï¼Œç³»ç»Ÿæ— æ³•ä»å›¾ç‰‡ä¸­è¯†åˆ«å‡ºæ¸…æ™°çš„ä½œä¸šé¢˜ç›®ã€‚',
                    suggestions: [
                        'è¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°åº¦è¶³å¤Ÿ',
                        'ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…é˜´å½±é®æŒ¡é¢˜ç›®',
                        'é‡æ–°æ‹æ‘„å¹¶ä¸Šä¼ æ›´æ¸…æ™°çš„ä½œä¸šå›¾ç‰‡'
                    ],
                    reason: 'ocr_failed'
                }
            };
            
            return recognitionFailedData;
        }
        
        function generateTestData(homeworkId) {
            let selectedSubject = 'chinese';
            if (homeworkId == '773191') {
                selectedSubject = 'math';
            }
            
            const total = 8;
            const correct = 6;
            
            const corrections = [];
            for (let i = 0; i < total; i++) {
                corrections.push({
                    question_number: i + 1,
                    question_text: selectedSubject === 'chinese' ? `é»˜å†™é¢˜${i+1}` : `${i+10} + ${i+5} = ?`,
                    user_answer: `ç­”æ¡ˆ${i+1}`,
                    correct_answer: `æ­£ç¡®ç­”æ¡ˆ${i+1}`,
                    is_correct: i < correct,
                    explanation: i < correct ? 'å›ç­”æ­£ç¡®' : 'éœ€è¦ä»”ç»†æ£€æŸ¥'
                });
            }
            
            return {
                id: homeworkId,
                subject: selectedSubject,
                total_questions: total,
                correct_count: correct,
                wrong_count: total - correct,
                accuracy_rate: Math.round((correct / total) * 100),
                status: 'completed',
                original_image_url: `/uploads/homework/homework_${homeworkId}_1.jpg`,
                correction_results: corrections,
                created_at: new Date().toISOString()
            };
        }
    </script>
</body>
</html>